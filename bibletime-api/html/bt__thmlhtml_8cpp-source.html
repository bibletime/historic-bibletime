<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>bt_thmlhtml.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>bt_thmlhtml.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                     thmlhtml.cpp  -  ThML to HTML filter</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : 1999-10-27</font>
00005 <font class="comment">    copyright            : 2001 by CrossWire Bible Society</font>
00006 <font class="comment"> ***************************************************************************/</font>
00007 
00008 <font class="comment">/***************************************************************************</font>
00009 <font class="comment"> *                                                                         *</font>
00010 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00011 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00012 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00013 <font class="comment"> *   (at your option) any later version.                                   *</font>
00014 <font class="comment"> *                                                                         *</font>
00015 <font class="comment"> ***************************************************************************/</font>
00016 
00017 <font class="comment">//BibleTime includes</font>
00018 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00019 <font class="preprocessor">#include "bt_thmlhtml.h"</font>
00020 <font class="preprocessor">#include "versekey.h"</font>
00021 
00022 <font class="comment">//Sword includes</font>
00023 <font class="preprocessor">#include &lt;swmodule.h&gt;</font>
00024 
00025 <font class="comment">//Qt includes</font>
00026 <font class="preprocessor">#include &lt;qstring.h&gt;</font>
00027 
00028 BT_ThMLHTML::BT_ThMLHTML() {
00029     setEscapeStringCaseSensitive(<font class="keyword">true</font>);
00030     setPassThruUnknownEscapeString(<font class="keyword">true</font>); <font class="comment">//the HTML widget will render the HTML escape codes   </font>
00031     setEscapeStart(<font class="stringliteral">"&amp;"</font>);
00032     setEscapeEnd(<font class="stringliteral">";"</font>);  
00033   addEscapeStringSubstitute(<font class="stringliteral">"raquo"</font>, QString::fromLatin1(<font class="stringliteral">"»"</font>).utf8());
00034   addEscapeStringSubstitute(<font class="stringliteral">"laquo"</font>, QString::fromLatin1(<font class="stringliteral">"«"</font>).utf8());
00035 <font class="comment">//  addEscapeStringSubstitute("uuml", QString::fromLatin1("ü").utf8());</font>
00036 <font class="comment">//  addEscapeStringSubstitute("ouml", QString::fromLatin1("ö").utf8());</font>
00037 <font class="comment">//  addEscapeStringSubstitute("auml", QString::fromLatin1("ä").utf8());</font>
00038     
00039     setTokenStart(<font class="stringliteral">"&lt;"</font>);
00040     setTokenEnd(<font class="stringliteral">"&gt;"</font>);
00041     setTokenCaseSensitive(<font class="keyword">true</font>);
00042     addTokenSubstitute(<font class="stringliteral">"note"</font>, <font class="stringliteral">" &lt;small&gt;("</font>);
00043     addTokenSubstitute(<font class="stringliteral">"/note"</font>, <font class="stringliteral">")&lt;/small&gt; "</font>);
00044 
00045 <font class="comment">//  addTokenSubstitute("foreign lang=\"el\"", "&lt;font face=\"SIL Galatia\"&gt;");</font>
00046 <font class="comment">//  addTokenSubstitute("foreign lang=\"he\"", "&lt;font face=\"SIL Ezra\"&gt;");</font>
00047 <font class="comment">//  addTokenSubstitute("/foreign",                      "&lt;/font&gt;");</font>
00048 
00049 }
00050 
00051 <font class="keywordtype">bool</font> BT_ThMLHTML::handleToken(<font class="keywordtype">char</font> **buf, <font class="keyword">const</font> <font class="keywordtype">char</font> *token, DualStringMap &amp;userData) {
00052     <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> i;
00053     <font class="keyword">const</font> <font class="keywordtype">int</font> tokenLength = strlen(token);
00054     
00055     <font class="keywordflow">if</font> (!substituteToken(buf, token) &amp;&amp; !substituteEscapeString(buf, token)) {
00056 
00057         <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"sync type=\"lemma\""</font>, 17)) { <font class="comment">//LEMMA</font>
00058             pushString(buf,<font class="stringliteral">" &lt;small&gt;&lt;em&gt;&amp;lt;"</font>);
00059 
00060             <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> j = 17; j &lt; tokenLength; j++) {
00061                 <font class="keywordflow">if</font> (!strncmp(token+j, <font class="stringliteral">"value=\""</font>, 7)) {
00062                     j += 7;
00063                     <font class="keywordflow">for</font> (;token[j] != <font class="charliteral">'\"'</font>; j++)
00064                         *(*buf)++ = token[j];
00065                     <font class="keywordflow">break</font>;
00066                 }
00067             }
00068             pushString(buf, <font class="stringliteral">"&amp;gt;&lt;/em&gt;&lt;/small&gt; "</font>);
00069         }
00070 
00071         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"sync type=\"morph\""</font>, 17)) { <font class="comment">//Morph</font>
00072 
00073             <font class="keywordtype">char</font> num[12];
00074             <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> j = 17; j &lt; tokenLength; j++) {
00075                 <font class="keywordflow">if</font> (!strncmp(token+j, <font class="stringliteral">"value=\""</font>, 7)) {
00076                     j += 7;
00077                     <font class="keywordtype">int</font> idx=0;
00078                     <font class="keywordflow">for</font> (;token[j] != <font class="charliteral">'\"'</font>; j++,idx++)
00079                         num[idx] = token[j];
00080                     num[idx] = 0;
00081                     <font class="keywordflow">break</font>;
00082                 }
00083             }
00084             pushString(buf,<font class="stringliteral">" &lt;font color=\"%s\"&gt;&lt;small&gt;&lt;em&gt;&lt;a href=\"morph://Greek/%s\"&gt;(%s)&lt;/a&gt;&lt;/em&gt;&lt;/small&gt;&lt;/font&gt; "</font>,
00085                 morph_color, num, num);
00086         }
00087         
00088         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"sync type=\"Strongs\" value=\"H\""</font>, 29)) {
00089 
00090             <font class="keywordtype">char</font> num[12];
00091             <font class="keywordflow">for</font> (i = 29; i &lt; tokenLength; i++)
00092                 <font class="keywordflow">if</font>(token[i] != <font class="charliteral">'\"'</font>)
00093                     num[i-29] = token[i];
00094             num[i-29] = 0;
00095 
00096             pushString(buf,<font class="stringliteral">" &lt;font color=\"%s\"&gt;&lt;small&gt;&lt;em&gt;&lt;a href=\"strongs://Hebrew/%s\"&gt;&amp;lt;%s&amp;gt;&lt;/a&gt;&lt;/em&gt;&lt;/small&gt;&lt;/font&gt; "</font>,
00097                 strongs_color, num, num);
00098         }
00099 <font class="comment">//#warning not handled: token[27] == 'A')</font>
00100         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"sync type=\"Strongs\" value=\"G\""</font>,29)) {
00101             <font class="keywordtype">char</font> num[12];
00102             <font class="keywordflow">for</font> (i = 29; i &lt; tokenLength; i++)
00103                 <font class="keywordflow">if</font>(token[i] != <font class="charliteral">'\"'</font>)
00104                     num[i-29] = token[i];
00105             num[i-29] = 0;
00106 
00107             pushString(buf,<font class="stringliteral">" &lt;font color=\"%s\"&gt;&lt;small&gt;&lt;em&gt;&lt;a href=\"strongs://Greek/%s\"&gt;&amp;lt;%s&amp;gt;&lt;/a&gt;&lt;/em&gt;&lt;/small&gt;&lt;/font&gt; "</font>,
00108                 strongs_color, num, num);
00109         }
00110 
00111         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"scripRef p"</font>, 10) || !strncmp(token, <font class="stringliteral">"scripRef v"</font>, 10)) {
00112             userData[<font class="stringliteral">"inscriptRef"</font>] = <font class="stringliteral">"true"</font>;
00113             <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"scripRef v"</font>, 10)) { <font class="comment">//module given</font>
00114 
00115                 <font class="keywordtype">char</font> module_version[500];
00116                 <font class="keywordflow">for</font> (i = 18; i &lt; tokenLength-1; i++) {
00117                     <font class="keywordflow">if</font>(token[i] != <font class="charliteral">'\"'</font>)
00118                         module_version[i-18] = token[i];                        
00119                     <font class="keywordflow">else</font>
00120                         <font class="keywordflow">break</font>;
00121                 }
00122                 module_version[i-18] = 0;
00123                 <font class="comment">//c contains the module</font>
00124                 userData[<font class="stringliteral">"lastRefModule"</font>] = module_version;
00125             }
00126             <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"scripRef p"</font>, 10)) { <font class="comment">//passage without module</font>
00127                 <font class="keywordtype">char</font> verse_str[5000];
00128                 <font class="keywordflow">for</font> (i = 18; i &lt; tokenLength-1; i++) {
00129                     <font class="keywordflow">if</font>(token[i] != <font class="charliteral">'\"'</font>)
00130                         verse_str[i-18] = token[i];
00131                     <font class="keywordflow">else</font>
00132                         <font class="keywordflow">break</font>;
00133                 }
00134                 verse_str[i-18] = 0;
00135                 <font class="keyword">const</font> <font class="keywordtype">char</font>* ref = <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b3">parseThMLRef</a>(verse_str);
00136               pushString(buf, ref);
00137               <font class="keyword">delete</font> [] ref;<font class="comment">//delete now because it's unused</font>
00138             }
00139             <font class="keywordflow">if</font> ( !strncmp(token+i+2, <font class="stringliteral">"passage="</font>, 8) ) { <font class="comment">//passage after module part</font>
00140                 <font class="keywordtype">char</font> verse_str[5000];
00141                 i+=11;          
00142                 <font class="keywordtype">int</font> idx = 0;    
00143                 <font class="keywordflow">for</font> (; i &lt; tokenLength-1; i++,idx++)    {
00144                     <font class="keywordflow">if</font>(token[i] != <font class="charliteral">'\"'</font>)
00145                         verse_str[idx] = token[i];
00146                     <font class="keywordflow">else</font>
00147                         <font class="keywordflow">break</font>;                  
00148                 }
00149                 verse_str[idx] = <font class="charliteral">'\0'</font>;
00150                 <font class="keyword">const</font> <font class="keywordtype">char</font>* ref = <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b3">parseThMLRef</a>(verse_str, userData[<font class="stringliteral">"lastRefModule"</font>].c_str());
00151                 pushString(buf, ref);
00152                 <font class="keyword">delete</font> [] ref;
00153             }
00154         }
00155         <font class="comment">// we're starting a scripRef like "&lt;scripRef&gt;John 3:16&lt;/scripRef&gt;"</font>
00156         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(token, <font class="stringliteral">"scripRef"</font>)) {
00157             userData[<font class="stringliteral">"inscriptRef"</font>] = <font class="stringliteral">"false"</font>;
00158             <font class="comment">// let's stop text from going to output</font>
00159             userData[<font class="stringliteral">"suspendTextPassThru"</font>] = <font class="stringliteral">"true"</font>;
00160         }
00161         <font class="comment">// we've ended a scripRef</font>
00162         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(token, <font class="stringliteral">"/scripRef"</font>)) {
00163             <font class="keywordflow">if</font> (userData[<font class="stringliteral">"inscriptRef"</font>] == <font class="stringliteral">"true"</font>) { <font class="comment">// like  "&lt;scripRef passage="John 3:16"&gt;John 3:16&lt;/scripRef&gt;"</font>
00164                 userData[<font class="stringliteral">"inscriptRef"</font>] = <font class="stringliteral">"false"</font>;
00165                 pushString(buf, thmlRefEnd());
00166             }           
00167             <font class="keywordflow">else</font> { <font class="comment">// like "&lt;scripRef&gt;John 3:16&lt;/scripRef&gt;"</font>
00168                 <font class="keyword">const</font> <font class="keywordtype">char</font>* ref = <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b2">parseSimpleRef</a>(userData[<font class="stringliteral">"lastTextNode"</font>].c_str());
00169               pushString(buf, ref);
00170               <font class="keyword">delete</font> [] ref;<font class="comment">//delete now because it's unused</font>
00171                 userData[<font class="stringliteral">"suspendTextPassThru"</font>] = <font class="stringliteral">"false"</font>;
00172             }
00173         }           
00174         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"div class=\"sechead\""</font>, 19)) {
00175             userData[<font class="stringliteral">"SecHead"</font>] = <font class="stringliteral">"true"</font>;
00176             pushString(buf, <font class="stringliteral">"&lt;H2&gt;&lt;FONT color=\"%s\"&gt;"</font>, text_color);
00177         }
00178         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"div class=\"title\""</font>, 19)) {
00179       userData[<font class="stringliteral">"Title"</font>] = <font class="stringliteral">"true"</font>;
00180             pushString(buf, <font class="stringliteral">"&lt;H1&gt;&lt;FONT color=\"%s\"&gt;"</font>, text_color);
00181         }
00182         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"/div"</font>, 4)) {
00183             <font class="keywordflow">if</font> (userData[<font class="stringliteral">"SecHead"</font>] == <font class="stringliteral">"true"</font>) {
00184                 pushString(buf, <font class="stringliteral">"&lt;/FONT&gt;&lt;/H2&gt;"</font>);
00185                 userData[<font class="stringliteral">"SecHead"</font>] = <font class="stringliteral">"false"</font>;
00186             }
00187             <font class="keywordflow">else</font> <font class="keywordflow">if</font>(userData[<font class="stringliteral">"Title"</font>] == <font class="stringliteral">"true"</font>) {
00188                 pushString(buf, <font class="stringliteral">"&lt;/FONT&gt;&lt;/H1&gt;"</font>);
00189                 userData[<font class="stringliteral">"Title"</font>] = <font class="stringliteral">"false"</font>;
00190             }
00191         }
00192         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"img "</font>, 4)) {
00193             <font class="keyword">const</font> <font class="keywordtype">char</font> *src = strstr(token, <font class="stringliteral">"src"</font>);
00194             <font class="keywordflow">if</font> (!src)       <font class="comment">// assert we have a src attribute</font>
00195                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00196 
00197             *(*buf)++ = <font class="charliteral">'&lt;'</font>;
00198             <font class="keywordflow">for</font> (<font class="keyword">const</font> <font class="keywordtype">char</font> *c = token; *c; c++) {
00199                 <font class="keywordflow">if</font> (c == src) {
00200                     <font class="keywordflow">for</font> (;((*c) &amp;&amp; (*c != <font class="charliteral">'"'</font>)); c++)
00201                         *(*buf)++ = *c;
00202 
00203                     <font class="keywordflow">if</font> (!*c) { c--; <font class="keywordflow">continue</font>; }
00204 
00205                     *(*buf)++ = <font class="charliteral">'"'</font>;
00206                     <font class="keywordflow">if</font> (*(c+1) == <font class="charliteral">'/'</font>) {
00207                         pushString(buf, <font class="stringliteral">"file:"</font>);
00208                         pushString(buf, module-&gt;getConfigEntry(<font class="stringliteral">"AbsoluteDataPath"</font>));
00209                         <font class="keywordflow">if</font> (*(*buf-1) == <font class="charliteral">'/'</font>)
00210                             c++;        <font class="comment">// skip '/'</font>
00211                     }
00212                     <font class="keywordflow">continue</font>;
00213                 }
00214                 *(*buf)++ = *c;
00215             }
00216             *(*buf)++ = <font class="charliteral">'&gt;'</font>;
00217         }       
00218         <font class="keywordflow">else</font> { <font class="comment">// let token pass thru</font>
00219             *(*buf)++ = <font class="charliteral">'&lt;'</font>;
00220             <font class="keywordflow">for</font> (i = 0; i &lt; tokenLength; i++)
00221                 *(*buf)++ = token[i];
00222                 *(*buf)++ = <font class="charliteral">'&gt;'</font>;
00223         }
00224     }
00225     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00226 }
</pre></div><hr><address><small>Generated on Sun Mar 10 22:12:45 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
