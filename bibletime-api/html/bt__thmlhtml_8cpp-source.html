<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>bt_thmlhtml.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>bt_thmlhtml.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                     thmlhtml.cpp  -  ThML to HTML filter</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : 1999-10-27</font>
00005 <font class="comment">    copyright            : 2001 by CrossWire Bible Society</font>
00006 <font class="comment"> ***************************************************************************/</font>
00007 
00008 <font class="comment">/***************************************************************************</font>
00009 <font class="comment"> *                                                                         *</font>
00010 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00011 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00012 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00013 <font class="comment"> *   (at your option) any later version.                                   *</font>
00014 <font class="comment"> *                                                                         *</font>
00015 <font class="comment"> ***************************************************************************/</font>
00016 
00017 <font class="comment">//BibleTime includes</font>
00018 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00019 <font class="preprocessor">#include "bt_thmlhtml.h"</font>
00020 <font class="preprocessor">#include "versekey.h"</font>
00021 
00022 <font class="comment">//Sword includes</font>
00023 <font class="preprocessor">#include &lt;swmodule.h&gt;</font>
00024 
00025 <font class="comment">//Qt includes</font>
00026 <font class="preprocessor">#include &lt;qstring.h&gt;</font>
00027 
00028 BT_ThMLHTML::BT_ThMLHTML() {
00029     setEscapeStringCaseSensitive(<font class="keyword">true</font>);
00030     setPassThruUnknownEscapeString(<font class="keyword">true</font>); <font class="comment">//the HTML widget will render the HTML escape codes   </font>
00031     setEscapeStart(<font class="stringliteral">"&amp;"</font>);
00032     setEscapeEnd(<font class="stringliteral">";"</font>);  
00033   addEscapeStringSubstitute(<font class="stringliteral">"raquo"</font>, QString::fromLatin1(<font class="stringliteral">"»"</font>).utf8());
00034   addEscapeStringSubstitute(<font class="stringliteral">"laquo"</font>, QString::fromLatin1(<font class="stringliteral">"«"</font>).utf8());
00035 <font class="comment">//  addEscapeStringSubstitute("uuml", QString::fromLatin1("ü").utf8());</font>
00036 <font class="comment">//  addEscapeStringSubstitute("ouml", QString::fromLatin1("ö").utf8());</font>
00037 <font class="comment">//  addEscapeStringSubstitute("auml", QString::fromLatin1("ä").utf8());</font>
00038     
00039     setTokenStart(<font class="stringliteral">"&lt;"</font>);
00040     setTokenEnd(<font class="stringliteral">"&gt;"</font>);
00041     setTokenCaseSensitive(<font class="keyword">true</font>);
00042     addTokenSubstitute(<font class="stringliteral">"note"</font>, <font class="stringliteral">" &lt;span class=\"footnote\"&gt;("</font>);
00043     addTokenSubstitute(<font class="stringliteral">"/note"</font>, <font class="stringliteral">")&lt;/span&gt; "</font>);
00044 
00045     addTokenSubstitute(<font class="stringliteral">"foreign lang=\"el\""</font>, <font class="stringliteral">"&lt;span lang=\"el\"&gt;"</font>);
00046     addTokenSubstitute(<font class="stringliteral">"foreign lang=\"he\""</font>, <font class="stringliteral">"&lt;span lang=\"he\" dir=\"rtl\"&gt;"</font>);
00047     addTokenSubstitute(<font class="stringliteral">"/foreign"</font>,                      <font class="stringliteral">"&lt;/span&gt;"</font>);
00048 }
00049 
00050 <font class="keywordtype">bool</font> BT_ThMLHTML::handleToken(<font class="keywordtype">char</font> **buf, <font class="keyword">const</font> <font class="keywordtype">char</font> *token, DualStringMap &amp;userData) {
00051     <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> i = 0;
00052     <font class="keyword">const</font> <font class="keywordtype">int</font> tokenLength = strlen(token);
00053     
00054     <font class="keywordflow">if</font> (!substituteToken(buf, token) &amp;&amp; !substituteEscapeString(buf, token)) {
00055 
00056         <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"sync type=\"lemma\""</font>, 17)) { <font class="comment">//LEMMA</font>
00057             pushString(buf,<font class="stringliteral">" &lt;span class=\"lemma\"&gt;&amp;lt;"</font>);
00058 
00059             <font class="keywordflow">for</font> (<font class="keywordtype">int</font> j = 17; j &lt; tokenLength; j++) {
00060                 <font class="keywordflow">if</font> (!strncmp(token+j, <font class="stringliteral">"value=\""</font>, 7)) {
00061                     j += 7;
00062                     <font class="keywordflow">for</font> (;token[j] != <font class="charliteral">'\"'</font>; j++)
00063                         *(*buf)++ = token[j];
00064                     <font class="keywordflow">break</font>;
00065                 }
00066             }
00067             pushString(buf, <font class="stringliteral">"&amp;gt;&lt;/span&gt; "</font>);
00068         }
00069 
00070         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"sync type=\"morph\""</font>, 17)) { <font class="comment">//Morph</font>
00071             <font class="keywordtype">char</font> num[12];
00072             <font class="keywordflow">for</font> (<font class="keywordtype">int</font> j = 17; j &lt; tokenLength; j++) {
00073                 <font class="keywordflow">if</font> (!strncmp(token+j, <font class="stringliteral">"value=\""</font>, 7)) {
00074                     j += 7;
00075                     <font class="keywordtype">int</font> idx=0;
00076                     <font class="keywordflow">for</font> (;token[j] != <font class="charliteral">'\"'</font>; j++,idx++)
00077                         num[idx] = token[j];
00078                     num[idx] = 0;
00079                     <font class="keywordflow">break</font>;
00080                 }
00081             }
00082             pushString(buf,<font class="stringliteral">" &lt;a href=\"morph://Greek/%s\"&gt;&lt;span class=\"morphcode\"&gt;(%s)&lt;/span&gt;&lt;/a&gt; "</font>,
00083                 num, num);
00084         }
00085         
00086         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"sync type=\"Strongs\" value=\"H\""</font>, 29)) {
00087             <font class="keywordtype">char</font> num[12];
00088             <font class="keywordflow">for</font> (i = 29; i &lt; tokenLength; i++)
00089                 <font class="keywordflow">if</font>(token[i] != <font class="charliteral">'\"'</font>)
00090                     num[i-29] = token[i];
00091             num[i-29] = 0;
00092 
00093             pushString(buf,<font class="stringliteral">" &lt;a href=\"strongs://Hebrew/%s\"&gt;&lt;span class=\"strongnumber\"&gt;&amp;lt;%s&amp;gt;&lt;/span&gt;&lt;/a&gt; "</font>,
00094                 num, num);
00095         }
00096         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"sync type=\"Strongs\" value=\"G\""</font>,29)) {
00097             <font class="keywordtype">char</font> num[12];
00098             <font class="keywordflow">for</font> (i = 29; i &lt; tokenLength; i++)
00099                 <font class="keywordflow">if</font>(token[i] != <font class="charliteral">'\"'</font>)
00100                     num[i-29] = token[i];
00101             num[i-29] = 0;
00102 
00103             pushString(buf,<font class="stringliteral">" &lt;a href=\"strongs://Greek/%s\"&gt;&lt;span class=\"strongnumber\"&gt;&amp;lt;%s&amp;gt;&lt;/span&gt;&lt;/a&gt; "</font>,
00104                 num, num);
00105         }
00106 
00107         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"scripRef p"</font>, 10) || !strncmp(token, <font class="stringliteral">"scripRef v"</font>, 10)) {
00108             userData[<font class="stringliteral">"inscriptRef"</font>] = <font class="stringliteral">"true"</font>;
00109             <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"scripRef v"</font>, 10)) { <font class="comment">//module given</font>
00110 
00111                 <font class="keywordtype">char</font> module_version[500];
00112                 <font class="keywordflow">for</font> (i = 18; i &lt; tokenLength-1; i++) {
00113                     <font class="keywordflow">if</font>(token[i] != <font class="charliteral">'\"'</font>)
00114                         module_version[i-18] = token[i];                        
00115                     <font class="keywordflow">else</font>
00116                         <font class="keywordflow">break</font>;
00117                 }
00118                 module_version[i-18] = 0;
00119                 <font class="comment">//c contains the module</font>
00120                 userData[<font class="stringliteral">"lastRefModule"</font>] = module_version;
00121             }
00122             <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"scripRef p"</font>, 10)) { <font class="comment">//passage without module</font>
00123                 <font class="keywordtype">char</font> verse_str[5000];
00124                 <font class="keywordflow">for</font> (i = 18; i &lt; tokenLength-1; i++) {
00125                     <font class="keywordflow">if</font>(token[i] != <font class="charliteral">'\"'</font>)
00126                         verse_str[i-18] = token[i];
00127                     <font class="keywordflow">else</font>
00128                         <font class="keywordflow">break</font>;
00129                 }
00130                 verse_str[i-18] = 0;
00131                 <font class="keyword">const</font> <font class="keywordtype">char</font>* ref = <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b3">parseThMLRef</a>(verse_str);
00132               pushString(buf, ref);
00133               <font class="keyword">delete</font> [] ref;<font class="comment">//delete now because it's unused</font>
00134             }
00135             <font class="keywordflow">if</font> ( !strncmp(token+i+2, <font class="stringliteral">"passage="</font>, 8) ) { <font class="comment">//passage after module part</font>
00136                 <font class="keywordtype">char</font> verse_str[5000];
00137                 i+=11;          
00138                 <font class="keywordtype">int</font> idx = 0;    
00139                 <font class="keywordflow">for</font> (; i &lt; tokenLength-1; i++,idx++)    {
00140                     <font class="keywordflow">if</font>(token[i] != <font class="charliteral">'\"'</font>)
00141                         verse_str[idx] = token[i];
00142                     <font class="keywordflow">else</font>
00143                         <font class="keywordflow">break</font>;                  
00144                 }
00145                 verse_str[idx] = <font class="charliteral">'\0'</font>;
00146                 <font class="keyword">const</font> <font class="keywordtype">char</font>* ref = <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b3">parseThMLRef</a>(verse_str, userData[<font class="stringliteral">"lastRefModule"</font>].c_str());
00147                 pushString(buf, ref);
00148                 <font class="keyword">delete</font> [] ref;
00149             }
00150         }
00151         <font class="comment">// we're starting a scripRef like "&lt;scripRef&gt;John 3:16&lt;/scripRef&gt;"</font>
00152         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(token, <font class="stringliteral">"scripRef"</font>)) {
00153             userData[<font class="stringliteral">"inscriptRef"</font>] = <font class="stringliteral">"false"</font>;
00154             <font class="comment">// let's stop text from going to output</font>
00155             userData[<font class="stringliteral">"suspendTextPassThru"</font>] = <font class="stringliteral">"true"</font>;
00156         }
00157         <font class="comment">// we've ended a scripRef</font>
00158         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(token, <font class="stringliteral">"/scripRef"</font>)) {
00159             <font class="keywordflow">if</font> (userData[<font class="stringliteral">"inscriptRef"</font>] == <font class="stringliteral">"true"</font>) { <font class="comment">// like  "&lt;scripRef passage="John 3:16"&gt;John 3:16&lt;/scripRef&gt;"</font>
00160                 userData[<font class="stringliteral">"inscriptRef"</font>] = <font class="stringliteral">"false"</font>;
00161                 pushString(buf, thmlRefEnd());
00162             }           
00163             <font class="keywordflow">else</font> { <font class="comment">// like "&lt;scripRef&gt;John 3:16&lt;/scripRef&gt;"</font>
00164                 <font class="keyword">const</font> <font class="keywordtype">char</font>* ref = <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b2">parseSimpleRef</a>(userData[<font class="stringliteral">"lastTextNode"</font>].c_str());
00165               pushString(buf, ref);
00166               <font class="keyword">delete</font> [] ref;<font class="comment">//delete now because it's unused</font>
00167                 userData[<font class="stringliteral">"suspendTextPassThru"</font>] = <font class="stringliteral">"false"</font>;
00168             }
00169         }           
00170         
00171 <font class="comment">//headings should be processed by the ThMLHeadings filter       </font>
00172         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"div class=\"sechead\""</font>, 19)) {
00173             userData[<font class="stringliteral">"SecHead"</font>] = <font class="stringliteral">"true"</font>;
00174             pushString(buf, <font class="stringliteral">"&lt;div class=\"sectiontitle\"&gt;"</font><font class="comment">/*, text_color*/</font>);
00175         }
00176         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"div class=\"title\""</font>, 19)) {
00177       userData[<font class="stringliteral">"Title"</font>] = <font class="stringliteral">"true"</font>;
00178             pushString(buf, <font class="stringliteral">"&lt;div class=\"booktitle\"&gt;"</font>);
00179         }
00180 <font class="comment">//      else if (!strncmp(token, "/div", 4)) {</font>
00181 <font class="comment">//          if (userData["SecHead"] == "true") {</font>
00182 <font class="comment">//              pushString(buf, "&lt;/FONT&gt;&lt;/H2&gt;");</font>
00183 <font class="comment">//              userData["SecHead"] = "false";</font>
00184 <font class="comment">//          }</font>
00185 <font class="comment">//          else if(userData["Title"] == "true") {</font>
00186 <font class="comment">//              pushString(buf, "&lt;/FONT&gt;&lt;/H1&gt;");</font>
00187 <font class="comment">//              userData["Title"] = "false";</font>
00188 <font class="comment">//          }</font>
00189 <font class="comment">//      }</font>
00190         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(token, <font class="stringliteral">"img "</font>, 4)) {
00191             <font class="keyword">const</font> <font class="keywordtype">char</font> *src = strstr(token, <font class="stringliteral">"src"</font>);
00192             <font class="keywordflow">if</font> (!src)       <font class="comment">// assert we have a src attribute</font>
00193                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00194 
00195             *(*buf)++ = <font class="charliteral">'&lt;'</font>;
00196             <font class="keywordflow">for</font> (<font class="keyword">const</font> <font class="keywordtype">char</font> *c = token; *c; c++) {
00197                 <font class="keywordflow">if</font> (c == src) {
00198                     <font class="keywordflow">for</font> (;((*c) &amp;&amp; (*c != <font class="charliteral">'"'</font>)); c++)
00199                         *(*buf)++ = *c;
00200 
00201                     <font class="keywordflow">if</font> (!*c) { c--; <font class="keywordflow">continue</font>; }
00202 
00203                     *(*buf)++ = <font class="charliteral">'"'</font>;
00204                     <font class="keywordflow">if</font> (*(c+1) == <font class="charliteral">'/'</font>) {
00205                         pushString(buf, <font class="stringliteral">"file:"</font>);
00206                         pushString(buf, module-&gt;getConfigEntry(<font class="stringliteral">"AbsoluteDataPath"</font>));
00207                         <font class="keywordflow">if</font> (*(*buf-1) == <font class="charliteral">'/'</font>)
00208                             c++;        <font class="comment">// skip '/'</font>
00209                     }
00210                     <font class="keywordflow">continue</font>;
00211                 }
00212                 *(*buf)++ = *c;
00213             }
00214             *(*buf)++ = <font class="charliteral">'&gt;'</font>;
00215         }       
00216         <font class="keywordflow">else</font> { <font class="comment">// let token pass thru</font>
00217             *(*buf)++ = <font class="charliteral">'&lt;'</font>;
00218             <font class="keywordflow">for</font> (i = 0; i &lt; tokenLength; i++)
00219                 *(*buf)++ = token[i];
00220                 *(*buf)++ = <font class="charliteral">'&gt;'</font>;
00221         }
00222     }
00223     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00224 }
</pre></div><hr><address align="right"><small>Generated on Tue Jul 16 13:53:08 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
