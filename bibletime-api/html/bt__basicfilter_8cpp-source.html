<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>bt_basicfilter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>bt_basicfilter.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                          bt_basicfilter.cpp  -  description</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : Thu Nov 1 2001</font>
00005 <font class="comment">    copyright            : (C) 2001 by The BibleTime team</font>
00006 <font class="comment">    email                : info@bibletime.de</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> *                                                                         *</font>
00011 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00012 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00013 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00014 <font class="comment"> *   (at your option) any later version.                                   *</font>
00015 <font class="comment"> *                                                                         *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 <font class="comment">//BIbleTime includes</font>
00018 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00019 <font class="preprocessor">#include "bt_basicfilter.h"</font>
00020 <font class="preprocessor">#include "creferencemanager.h"</font>
00021 <font class="preprocessor">#include "cswordversekey.h"</font>
00022 
00023 <font class="preprocessor">#include "frontend/cbtconfig.h"</font>
00024 <font class="preprocessor">#include "frontend/cpointers.h"</font>
00025 
00026 <font class="comment">//Qt includes</font>
00027 <font class="preprocessor">#include &lt;qregexp.h&gt;</font>
00028 <font class="preprocessor">#include &lt;qstringlist.h&gt;</font>
00029 
00030 <font class="keywordtype">char</font> BT_BASICFILTER::ProcessText (<font class="keywordtype">char</font> *text, <font class="keywordtype">int</font> maxlen, <font class="keyword">const</font> SWKey *key, <font class="keyword">const</font> SWModule *module){
00031     m_module = module;
00032     m_key = key;
00033     updateSettings();
00034     SWBasicFilter::ProcessText(text, maxlen, key, module);
00035     
00036     <font class="keywordflow">return</font> 0;
00037 }
00038 
<a name="l00039"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b0">00039</a> <font class="keywordtype">void</font> <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b0">BT_BASICFILTER::updateSettings</a>(){
00040     strcpy(standard_bible,  <a class="code" href="class_c_reference_manager.html#d5">CReferenceManager::preferredModule</a>(CReferenceManager::Bible).utf8());
00041     <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b6">updateTokens</a>();
00042 }
00043 
00044 
<a name="l00046"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b2">00046</a> <font class="keyword">const</font> <font class="keywordtype">char</font>* <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b2">BT_BASICFILTER::parseSimpleRef</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* ref) {
00047     VerseKey parseKey;  
00048     SWModule* m = const_cast&lt;SWModule*&gt;(m_module);
00049     <font class="keyword">const</font> <font class="keywordtype">char</font>* lang = m ? m-&gt;Lang() : <font class="stringliteral">"en"</font>;
00050     parseKey.setLocale(lang);
00051 
00052     parseKey = (m_key ? (<font class="keyword">const</font> <font class="keywordtype">char</font>*)*m_key : <font class="stringliteral">"Genesis 1:1"</font>);
00053     ListKey list;
00054   <font class="keywordtype">char</font>* to = <font class="keyword">new</font> <font class="keywordtype">char</font>[5000];
00055     <font class="keywordtype">char</font>* ret = to;
00056     
00057     QStringList refList = QStringList::split(QRegExp(<font class="stringliteral">"[,.;]"</font>, <font class="keyword">false</font>), QString::fromLocal8Bit(ref));
00058     <font class="keywordtype">int</font> pos = 0;
00059     <font class="keywordflow">for</font> ( QStringList::Iterator it = refList.begin(); it != refList.end(); ++it, pos++ ) {
00060         list = parseKey.ParseVerseList((*it).local8Bit(), parseKey, <font class="keyword">true</font>);
00061         
00062         <font class="keyword">const</font> <font class="keywordtype">int</font> count = list.Count();
00063         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; count; i++) {
00064             SWKey* key = list.GetElement(i);
00065             VerseKey* vk = dynamic_cast&lt;VerseKey*&gt;(key);
00066         
00067         pushString(&amp;to,<font class="stringliteral">"&lt;span id=\"reference\"&gt;&lt;a href=\"sword://Bible/%s/"</font>, standard_bible);
00068             
00069             <font class="keywordflow">if</font> (vk) {
00070                 vk-&gt;setLocale(lang);
00071 <font class="comment">//Workaround!</font>
00072                 vk-&gt;LowerBound().setLocale(lang);
00073                 vk-&gt;UpperBound().setLocale(lang);               
00074             }
00075             <font class="keywordflow">if</font> (vk &amp;&amp; (<font class="keyword">const</font> <font class="keywordtype">char</font>*)vk-&gt;UpperBound() != (<font class="keyword">const</font> <font class="keywordtype">char</font>*)vk-&gt;LowerBound()) {                 
00076                 pushString(&amp;to, <font class="stringliteral">"%s-%s\"&gt;%s&lt;/a&gt;"</font>,
00077                     (<font class="keyword">const</font> <font class="keywordtype">char</font>*)QString::fromLocal8Bit(vk-&gt;LowerBound()).utf8(),
00078                     (<font class="keyword">const</font> <font class="keywordtype">char</font>*)QString::fromLocal8Bit(vk-&gt;UpperBound()).utf8(),
00079                     (<font class="keyword">const</font> <font class="keywordtype">char</font>*)(*it).utf8()
00080                 );          
00081             }
00082             <font class="keywordflow">else</font> {
00083                 pushString(&amp;to, <font class="stringliteral">"%s\"&gt;%s&lt;/a&gt;"</font>,
00084                     (<font class="keyword">const</font> <font class="keywordtype">char</font>*)QString::fromLocal8Bit((<font class="keyword">const</font> <font class="keywordtype">char</font>*)*key).utf8(),
00085                     (<font class="keyword">const</font> <font class="keywordtype">char</font>*)(*it).utf8()
00086                 );
00087             }
00088             (pos+1 &lt; (int)refList.count()) ? pushString(&amp;to, <font class="stringliteral">"&lt;/span&gt;, "</font>) : pushString(&amp;to, <font class="stringliteral">"&lt;/span&gt;"</font>);
00089         }
00090     }   
00091     *to++ = <font class="charliteral">'\0'</font>;
00092     <font class="keywordflow">return</font> ret;  <font class="comment">//don't forget to delete it!</font>
00093 }
00094 
<a name="l00095"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b3">00095</a> <font class="keyword">const</font> <font class="keywordtype">char</font>* <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b3">BT_BASICFILTER::parseThMLRef</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* ref, <font class="keyword">const</font> <font class="keywordtype">char</font>* mod) {
00096   <font class="keywordtype">char</font>* to = <font class="keyword">new</font> <font class="keywordtype">char</font>[5000];
00097     <font class="keywordtype">char</font>* ret = to;
00098     <font class="keyword">const</font> <font class="keywordtype">char</font>* module = (mod ? mod : standard_bible);  
00099 
00100     CReferenceManager::Type type = CReferenceManager::Unknown;
00101     <font class="keywordflow">if</font> (<a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* m = <a class="code" href="class_c_pointers.html#d1">CPointers::backend</a>()-&gt;<a class="code" href="class_c_sword_backend.html#a11">findModuleByName</a>(module))
00102         type = <a class="code" href="class_c_reference_manager.html#d6">CReferenceManager::typeFromModule</a>(m-&gt;<a class="code" href="class_c_sword_module_info.html#a15">type</a>());
00103 
00104 <font class="comment">//  VerseKey parseKey = (m_key ? (const char*)*m_key : "Genesis 1:1");  </font>
00105 <font class="comment">//  ListKey list = parseKey.ParseVerseList(ref, parseKey, false);       </font>
00106 <font class="comment">//  const int count = list.Count();</font>
00107 
00108 <font class="comment">//  for(int i = 0; i &lt; count; i++) {</font>
00109 <font class="comment">//      SWKey* key = list.GetElement(i);</font>
00110 <font class="comment">//      VerseKey* vk =  dynamic_cast&lt;VerseKey*&gt;(key);</font>
00111 <font class="comment">//      </font>
00112         pushString(&amp;to,<font class="stringliteral">"&lt;span id=\"reference\"&gt;&lt;a href=\"%s\"&gt;"</font>,
00113             (<font class="keyword">const</font> <font class="keywordtype">char</font>*)<a class="code" href="class_c_reference_manager.html#d1">CReferenceManager::encodeHyperlink</a>(QString::fromLatin1(module),QString::fromLocal8Bit(ref).utf8(), type).utf8()
00114         );
00115 <font class="comment">//      if (vk &amp;&amp; vk-&gt;UpperBound() != vk-&gt;LowerBound()) {</font>
00116 <font class="comment">//          pushString(&amp;to, "%s-%s\"&gt;",</font>
00117 <font class="comment">//              (const char*)QString::fromLocal8Bit(vk-&gt;LowerBound()).utf8(),</font>
00118 <font class="comment">//              (const char*)QString::fromLocal8Bit(vk-&gt;UpperBound()).utf8()</font>
00119 <font class="comment">//          );</font>
00120 <font class="comment">//      }</font>
00121 <font class="comment">//      else {</font>
00122 <font class="comment">//          pushString(&amp;to, "%s\"&gt;",</font>
00123 <font class="comment">//              (const char*)</font>
00124 <font class="comment">//          );</font>
00125 <font class="comment">//      }</font>
00126 <font class="comment">//      (i+1 &lt; refList.count()) ? pushString(&amp;to, "&lt;/font&gt;, ") : pushString(&amp;to, "&lt;/font&gt;");    </font>
00127 <font class="comment">//  }</font>
00128     *to++ = <font class="charliteral">'\0'</font>;
00129     <font class="keywordflow">return</font> ret;
00130 }
00131 
00132 <font class="keyword">const</font> <font class="keywordtype">char</font>* BT_BASICFILTER::thmlRefEnd() {
00133     <font class="keywordflow">return</font> <font class="stringliteral">"&lt;/a&gt;&lt;/span&gt;"</font>;
00134 }
00135 
<a name="l00137"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b1">00137</a> <font class="keywordtype">char</font> <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b1">BT_BASICFILTER::ProcessRWPRefs</a>(<font class="keywordtype">char</font>* text, <font class="keywordtype">int</font> maxlen){
00138     <font class="keywordtype">char</font> *to, *from, verse_str[500];
00139     <font class="keywordtype">int</font> len;
00140 
00141     len = strlen(text) + 1; <font class="comment">// shift string to right of buffer</font>
00142     <font class="keywordflow">if</font> (len &lt; maxlen) {
00143         memmove(&amp;text[maxlen - len], text, len);
00144         from = &amp;text[maxlen - len];
00145     }
00146     <font class="keywordflow">else</font>
00147         from = text;    
00148 
00149     <font class="keywordflow">for</font> (to = text; *from; from++) {
00150         <font class="keywordflow">if</font> (*from == <font class="charliteral">'#'</font>) {
00151             <font class="keywordtype">int</font> i=0;
00152             <font class="keywordtype">bool</font> is_verse = <font class="keyword">true</font>;
00153             
00154             <font class="keywordflow">for</font> ( i=0; i &lt; 500 || from[i]==<font class="charliteral">'|'</font>; i++){
00155                 <font class="keywordflow">if</font> ( from[i] == <font class="charliteral">'|'</font> )
00156                     <font class="keywordflow">break</font>;  <font class="comment">//We found a valid verse ref</font>
00157                 <font class="keywordflow">if</font> ( !isalnum(from[i])  &amp;&amp; !isspace(from[i]) &amp;&amp; from[i]!=<font class="charliteral">':'</font>
00158                             &amp;&amp; from[i]!=<font class="charliteral">';'</font> &amp;&amp; from[i]!=<font class="charliteral">','</font> &amp;&amp; from[i]!=<font class="charliteral">'-'</font> &amp;&amp; from[i]!=<font class="charliteral">'#'</font>){
00159                     is_verse = <font class="keyword">false</font>;
00160                     <font class="keywordflow">break</font>; <font class="comment">// can't be a verseref</font>
00161                 }
00162             }
00163             <font class="keywordflow">if</font> ( i==500 || !is_verse ){
00164                 *to++ = *from;
00165                 <font class="keywordflow">continue</font>;
00166             }               
00167             ++from;
00168             
00169             i = 0;
00170             verse_str[0] = <font class="charliteral">'\0'</font>;
00171             <font class="keywordflow">while</font> (*from != <font class="charliteral">'|'</font> &amp;&amp; i&lt;500) { <font class="comment">/* get the bible reference */</font>
00172                 verse_str[i++] = *from;
00173                 verse_str[i + 1] = <font class="charliteral">'\0'</font>;
00174                 from++;
00175             }           
00176             
00177 <font class="comment">//          cerr &lt;&lt; verse_str &lt;&lt; endl;</font>
00178             <font class="keyword">const</font> <font class="keywordtype">char</font>* ref = <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b2">parseSimpleRef</a>(verse_str);            
00179           pushString(&amp;to,<font class="stringliteral">"%s "</font>, ref);
00180           <font class="keyword">delete</font> [] ref;<font class="comment">//delete now because it's unused</font>
00181         
00182             <font class="keywordflow">continue</font>;
00183         }
00184         *to++ = *from;
00185     }
00186     *to++ = 0;
00187     *to = 0;
00188     <font class="keywordflow">return</font> 0;
00189 }
00190 
<a name="l00192"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b5">00192</a> <font class="keywordtype">void</font> <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b5">BT_BASICFILTER::replaceTokenSubstitute</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* findString, <font class="keyword">const</font> <font class="keywordtype">char</font>* replaceString){
00193     tokenSubMap.erase( tokenSubMap.find(findString) ); <font class="comment">//erase entry</font>
00194     addTokenSubstitute(findString, replaceString);
00195 }
00196 
<a name="l00198"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b6">00198</a> <font class="keywordtype">void</font> <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b6">BT_BASICFILTER::updateTokens</a>(){
00199 }
</pre></div><hr><address align="right"><small>Generated on Tue Jul 16 13:53:08 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
