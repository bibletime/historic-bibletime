<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>bt_basicfilter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>bt_basicfilter.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                          bt_basicfilter.cpp  -  description</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : Thu Nov 1 2001</font>
00005 <font class="comment">    copyright            : (C) 2001 by The BibleTime team</font>
00006 <font class="comment">    email                : info@bibletime.de</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> *                                                                         *</font>
00011 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00012 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00013 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00014 <font class="comment"> *   (at your option) any later version.                                   *</font>
00015 <font class="comment"> *                                                                         *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 <font class="comment">//BIbleTime includes</font>
00018 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00019 <font class="preprocessor">#include "bt_basicfilter.h"</font>
00020 <font class="preprocessor">#include "creferencemanager.h"</font>
00021 <font class="preprocessor">#include "cswordversekey.h"</font>
00022 <font class="preprocessor">#include "../frontend/cbtconfig.h"</font>
00023 
00024 <font class="comment">//Qt includes</font>
00025 <font class="preprocessor">#include &lt;qregexp.h&gt;</font>
00026 <font class="preprocessor">#include &lt;qstringlist.h&gt;</font>
00027 
00028 <font class="keywordtype">char</font> BT_BASICFILTER::ProcessText (<font class="keywordtype">char</font> *text, <font class="keywordtype">int</font> maxlen, <font class="keyword">const</font> SWKey *key, <font class="keyword">const</font> SWModule *module){
00029     m_module = module;
00030     m_key = key;
00031     updateSettings();
00032     SWBasicFilter::ProcessText(text, maxlen, key, module);
00033     
00034     <font class="keywordflow">return</font> 0;
00035 }
00036 
<a name="l00037"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b0">00037</a> <font class="keywordtype">void</font> <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b0">BT_BASICFILTER::updateSettings</a>(){
00038     strcpy(footnote_color,  CBTConfig::get(CBTConfig::footnotesColor    ).name().utf8());
00039     strcpy(strongs_color,       CBTConfig::get(CBTConfig::strongsColor      ).name().utf8());
00040     strcpy(morph_color,         CBTConfig::get(CBTConfig::morphsColor           ).name().utf8());
00041     strcpy(jesuswords_color,CBTConfig::get(CBTConfig::jesuswordsColor   ).name().utf8());
00042     strcpy(swordref_color,  CBTConfig::get(CBTConfig::swordRefColor     ).name().utf8());
00043     strcpy(text_color,          CBTConfig::get(CBTConfig::textColor             ).name().utf8());   
00044     strcpy(standard_bible,  <a class="code" href="class_c_reference_manager.html#d5">CReferenceManager::preferredModule</a>(CReferenceManager::Bible).utf8());
00045     
00046     <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b6">updateTokens</a>();
00047 }
00048 
00049 
<a name="l00051"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b2">00051</a> <font class="keyword">const</font> <font class="keywordtype">char</font>* <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b2">BT_BASICFILTER::parseSimpleRef</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* ref) {
00052     VerseKey parseKey;  
00053     SWModule* m = const_cast&lt;SWModule*&gt;(m_module);
00054     <font class="keyword">const</font> <font class="keywordtype">char</font>* lang = m ? m-&gt;Lang() : <font class="stringliteral">"en"</font>;
00055     parseKey.setLocale(lang);
00056 
00057     parseKey = (m_key ? (<font class="keyword">const</font> <font class="keywordtype">char</font>*)*m_key : <font class="stringliteral">"Genesis 1:1"</font>);
00058     ListKey list;
00059   <font class="keywordtype">char</font>* to = <font class="keyword">new</font> <font class="keywordtype">char</font>[5000];
00060     <font class="keywordtype">char</font>* ret = to;
00061     
00062     QStringList refList = QStringList::split(QRegExp(<font class="stringliteral">"[,.;]"</font>, <font class="keyword">false</font>), QString::fromLocal8Bit(ref));
00063     <font class="keywordtype">int</font> pos = 0;
00064     <font class="keywordflow">for</font> ( QStringList::Iterator it = refList.begin(); it != refList.end(); ++it, pos++ ) {
00065         list = parseKey.ParseVerseList((*it).local8Bit(), parseKey, <font class="keyword">true</font>);
00066         
00067         <font class="keyword">const</font> <font class="keywordtype">int</font> count = list.Count();
00068         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; count; i++) {
00069             SWKey* key = list.GetElement(i);
00070             VerseKey* vk = dynamic_cast&lt;VerseKey*&gt;(key);
00071         
00072         pushString(&amp;to,<font class="stringliteral">"&lt;font color=\"%s\"&gt;&lt;a href=\"sword://Bible/%s/"</font>,
00073                 swordref_color,
00074                 standard_bible
00075             );
00076             
00077             <font class="keywordflow">if</font> (vk) {
00078                 vk-&gt;setLocale(lang);
00079                 vk-&gt;LowerBound().setLocale(lang);
00080                 vk-&gt;UpperBound().setLocale(lang);               
00081             }
00082             <font class="keywordflow">if</font> (vk &amp;&amp; vk-&gt;UpperBound() != vk-&gt;LowerBound()) {               
00083                 pushString(&amp;to, <font class="stringliteral">"%s-%s\"&gt;%s&lt;/a&gt;"</font>,
00084                     (<font class="keyword">const</font> <font class="keywordtype">char</font>*)QString::fromLocal8Bit(vk-&gt;LowerBound()).utf8(),
00085                     (<font class="keyword">const</font> <font class="keywordtype">char</font>*)QString::fromLocal8Bit(vk-&gt;UpperBound()).utf8(),
00086                     (<font class="keyword">const</font> <font class="keywordtype">char</font>*)(*it).utf8()
00087                 );          
00088             }
00089             <font class="keywordflow">else</font> {
00090                 pushString(&amp;to, <font class="stringliteral">"%s\"&gt;%s&lt;/a&gt;"</font>,
00091                     (<font class="keyword">const</font> <font class="keywordtype">char</font>*)QString::fromLocal8Bit((<font class="keyword">const</font> <font class="keywordtype">char</font>*)*key).utf8(),
00092                     (<font class="keyword">const</font> <font class="keywordtype">char</font>*)(*it).utf8()
00093                 );
00094             }
00095             (pos+1 &lt; refList.count()) ? pushString(&amp;to, <font class="stringliteral">"&lt;/font&gt;, "</font>) : pushString(&amp;to, <font class="stringliteral">"&lt;/font&gt;"</font>);
00096         }
00097     }   
00098     *to++ = <font class="charliteral">'\0'</font>;
00099     <font class="keywordflow">return</font> ret;  <font class="comment">//don't forget to delete it!</font>
00100 }
00101 
<a name="l00102"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b3">00102</a> <font class="keyword">const</font> <font class="keywordtype">char</font>* <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b3">BT_BASICFILTER::parseThMLRef</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* ref, <font class="keyword">const</font> <font class="keywordtype">char</font>* mod) {
00103   <font class="keywordtype">char</font>* to = <font class="keyword">new</font> <font class="keywordtype">char</font>[5000];
00104     <font class="keywordtype">char</font>* ret = to;
00105     <font class="keyword">const</font> <font class="keywordtype">char</font>* module = (mod ? mod : standard_bible);  
00106 <font class="comment">//  VerseKey parseKey = (m_key ? (const char*)*m_key : "Genesis 1:1");  </font>
00107 <font class="comment">//  ListKey list = parseKey.ParseVerseList(ref, parseKey, false);       </font>
00108 <font class="comment">//  const int count = list.Count();</font>
00109 
00110 <font class="comment">//  for(int i = 0; i &lt; count; i++) {</font>
00111 <font class="comment">//      SWKey* key = list.GetElement(i);</font>
00112 <font class="comment">//      VerseKey* vk =  dynamic_cast&lt;VerseKey*&gt;(key);</font>
00113 <font class="comment">//      </font>
00114         pushString(&amp;to,<font class="stringliteral">"&lt;font color=\"%s\"&gt;&lt;a href=\"sword://Bible/%s/"</font>,
00115             swordref_color,
00116             module
00117         );
00118 <font class="comment">//      if (vk &amp;&amp; vk-&gt;UpperBound() != vk-&gt;LowerBound()) {</font>
00119 <font class="comment">//          pushString(&amp;to, "%s-%s\"&gt;",</font>
00120 <font class="comment">//              (const char*)QString::fromLocal8Bit(vk-&gt;LowerBound()).utf8(),</font>
00121 <font class="comment">//              (const char*)QString::fromLocal8Bit(vk-&gt;UpperBound()).utf8()</font>
00122 <font class="comment">//          );</font>
00123 <font class="comment">//      }</font>
00124 <font class="comment">//      else {</font>
00125             pushString(&amp;to, <font class="stringliteral">"%s\"&gt;"</font>,
00126                 (<font class="keyword">const</font> <font class="keywordtype">char</font>*)QString::fromLocal8Bit(ref).utf8()
00127             );
00128 <font class="comment">//      }</font>
00129 <font class="comment">//      (i+1 &lt; refList.count()) ? pushString(&amp;to, "&lt;/font&gt;, ") : pushString(&amp;to, "&lt;/font&gt;");    </font>
00130 <font class="comment">//  }</font>
00131     *to++ = <font class="charliteral">'\0'</font>;
00132     <font class="keywordflow">return</font> ret;
00133 }
00134 
00135 <font class="keyword">const</font> <font class="keywordtype">char</font>* BT_BASICFILTER::thmlRefEnd() {
00136     <font class="keywordflow">return</font> <font class="stringliteral">"&lt;/a&gt;&lt;/font&gt;"</font>;
00137 }
00138 
<a name="l00140"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b1">00140</a> <font class="keywordtype">char</font> <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b1">BT_BASICFILTER::ProcessRWPRefs</a>(<font class="keywordtype">char</font>* text, <font class="keywordtype">int</font> maxlen){
00141     <font class="keywordtype">char</font> *to, *from, verse_str[500];
00142     <font class="keywordtype">int</font> len;
00143 
00144     len = strlen(text) + 1; <font class="comment">// shift string to right of buffer</font>
00145     <font class="keywordflow">if</font> (len &lt; maxlen) {
00146         memmove(&amp;text[maxlen - len], text, len);
00147         from = &amp;text[maxlen - len];
00148     }
00149     <font class="keywordflow">else</font>
00150         from = text;    
00151 
00152     <font class="keywordflow">for</font> (to = text; *from; from++) {
00153         <font class="keywordflow">if</font> (*from == <font class="charliteral">'#'</font>) {
00154             <font class="keywordtype">int</font> i=0;
00155             <font class="keywordtype">bool</font> is_verse = <font class="keyword">true</font>;
00156             
00157             <font class="keywordflow">for</font> ( i=0; i &lt; 500 || from[i]==<font class="charliteral">'|'</font>; i++){
00158                 <font class="keywordflow">if</font> ( from[i] == <font class="charliteral">'|'</font> )
00159                     <font class="keywordflow">break</font>;  <font class="comment">//We found a valid verse ref</font>
00160                 <font class="keywordflow">if</font> ( !isalnum(from[i])  &amp;&amp; !isspace(from[i]) &amp;&amp; from[i]!=<font class="charliteral">':'</font>
00161                             &amp;&amp; from[i]!=<font class="charliteral">';'</font> &amp;&amp; from[i]!=<font class="charliteral">','</font> &amp;&amp; from[i]!=<font class="charliteral">'-'</font> &amp;&amp; from[i]!=<font class="charliteral">'#'</font>){
00162                     is_verse = <font class="keyword">false</font>;
00163                     <font class="keywordflow">break</font>; <font class="comment">// can't be a verseref</font>
00164                 }
00165             }
00166             <font class="keywordflow">if</font> ( i==500 || !is_verse ){
00167                 *to++ = *from;
00168                 <font class="keywordflow">continue</font>;
00169             }               
00170             ++from;
00171             
00172             i = 0;
00173             verse_str[0] = <font class="charliteral">'\0'</font>;
00174             <font class="keywordflow">while</font> (*from != <font class="charliteral">'|'</font> &amp;&amp; i&lt;500) { <font class="comment">/* get the bible reference */</font>
00175                 verse_str[i++] = *from;
00176                 verse_str[i + 1] = <font class="charliteral">'\0'</font>;
00177                 from++;
00178             }           
00179             
00180 <font class="comment">//          cerr &lt;&lt; verse_str &lt;&lt; endl;</font>
00181             <font class="keyword">const</font> <font class="keywordtype">char</font>* ref = <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b2">parseSimpleRef</a>(verse_str);            
00182           pushString(&amp;to,<font class="stringliteral">"%s "</font>, ref);
00183           <font class="keyword">delete</font> [] ref;<font class="comment">//delete now because it's unused</font>
00184         
00185             <font class="keywordflow">continue</font>;
00186         }
00187         *to++ = *from;
00188     }
00189     *to++ = 0;
00190     *to = 0;
00191     <font class="keywordflow">return</font> 0;
00192 }
00193 
<a name="l00195"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b5">00195</a> <font class="keywordtype">void</font> <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b5">BT_BASICFILTER::replaceTokenSubstitute</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* findString, <font class="keyword">const</font> <font class="keywordtype">char</font>* replaceString){
00196     <font class="keywordtype">char</font> *buf = 0;
00197     tokenSubMap.erase( tokenSubMap.find(findString) ); <font class="comment">//erase entry</font>
00198     addTokenSubstitute(findString, replaceString);
00199 <font class="comment">//        if (!tokenCaseSensitive) {</font>
00200 <font class="comment">//                stdstr(&amp;buf, findString);</font>
00201 <font class="comment">//                toupperstr(buf);</font>
00202 <font class="comment">//                tokenSubMap.insert(DualStringMap::value_type(buf, replaceString));</font>
00203 <font class="comment">//                delete [] buf;</font>
00204 <font class="comment">//        }</font>
00205 <font class="comment">//        else</font>
00206 <font class="comment">//  tokenSubMap.insert(DualStringMap::value_type(findString, replaceString));   </font>
00207 }
00208 
<a name="l00210"></a><a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b6">00210</a> <font class="keywordtype">void</font> <a class="code" href="class_b_t___b_a_s_i_c_f_i_l_t_e_r.html#b6">BT_BASICFILTER::updateTokens</a>(){
00211 }
</pre></div><hr><address><small>Generated on Sun Mar 10 22:12:45 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
