<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>cindexitem.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>cindexitem.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                          cindexitem.cpp  -  description</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : Sam Jun 22 2002</font>
00005 <font class="comment">    copyright            : (C) 2002 by The BibleTime team</font>
00006 <font class="comment">    email                : info@bibletime.de</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> *                                                                         *</font>
00011 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00012 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00013 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00014 <font class="comment"> *   (at your option) any later version.                                   *</font>
00015 <font class="comment"> *                                                                         *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">//BibleTime includes</font>
00019 <font class="preprocessor">#include "cindexitem.h"</font>
00020 <font class="preprocessor">#include "cmainindex.h"</font>
00021 
00022 <font class="preprocessor">#include "backend/creferencemanager.h"</font>
00023 <font class="preprocessor">#include "backend/cswordmoduleinfo.h"</font>
00024 <font class="preprocessor">#include "backend/cswordversekey.h"</font>
00025 
00026 <font class="preprocessor">#include "frontend/ctoolclass.h"</font>
00027 <font class="preprocessor">#include "frontend/ctooltipmanager.h"</font>
00028 <font class="preprocessor">#include "frontend/cbtconfig.h"</font>
00029 <font class="preprocessor">#include "resource.h"</font>
00030 
00031 <font class="comment">//Qt includes</font>
00032 <font class="preprocessor">#include &lt;qdragobject.h&gt;</font>
00033 <font class="preprocessor">#include &lt;qstringlist.h&gt;</font>
00034 <font class="preprocessor">#include &lt;qfile.h&gt;</font>
00035 <font class="preprocessor">#include &lt;qstring.h&gt;</font>
00036 <font class="preprocessor">#include &lt;qtextstream.h&gt;</font>
00037 
00038 <font class="comment">//KDE includes</font>
00039 <font class="preprocessor">#include &lt;kconfig.h&gt;</font>
00040 <font class="preprocessor">#include &lt;klocale.h&gt;</font>
00041 <font class="preprocessor">#include &lt;kstandarddirs.h&gt;</font>
00042 
00043 <font class="preprocessor">#define CURRENT_SYNTAX_VERSION 1</font>
00044 <font class="preprocessor"></font>
00045 CItemBase::CItemBase(CMainIndex* mainIndex, <font class="keyword">const</font> Type type) : KListViewItem(mainIndex), m_type(type) {
00046   m_type = type;
00047 }
00048 
00049 CItemBase::CItemBase(CItemBase* parentItem, <font class="keyword">const</font> Type type) : KListViewItem(parentItem), m_type(type) {
00050   m_type = type;
00051 }
00052 
00053 CItemBase::~CItemBase() {
00054 }
00055 
00056 <font class="keyword">const</font> QString CItemBase::toolTip() {
00057   <font class="keywordflow">return</font> QString::null;
00058 }
00059 
00061 CMainIndex* CItemBase::listView()<font class="keyword"> const</font>{
00062   <font class="keywordflow">return</font> dynamic_cast&lt;CMainIndex*&gt;( QListViewItem::listView() );
00063 }
00064 
00065 <font class="keywordtype">void</font> CItemBase::init() {
00066   update();
00067 }
00068 
00069 <font class="keywordtype">void</font> CItemBase::update() {
00070 }
00071 
00072 <font class="keyword">const</font> CItemBase::Type&amp; CItemBase::type()<font class="keyword"> const</font>{
00073   <font class="keywordflow">return</font> m_type;
00074 };
00075 
00076 <font class="keywordtype">void</font> CItemBase::moveAfter( CItemBase* <font class="keyword">const</font> item ){
00077     <font class="keywordflow">if</font> (!item)
00078         <font class="keywordflow">return</font>;
00079     
00080     <font class="keywordflow">if</font> ( parent() != item-&gt;parent() ) { <font class="comment">//different levels</font>
00081 <font class="comment">//      if (type == AllowDifferentParents) { //different parents are allowed</font>
00082 <font class="comment">//          if (item-&gt;parent())</font>
00083 <font class="comment">//              item-&gt;parent()-&gt;insertItem(this); //insert item to the childs</font>
00084 <font class="comment">//          else</font>
00085 <font class="comment">//              listView()-&gt;insertItem(this);</font>
00086 <font class="comment">//          moveItem(item);</font>
00087 <font class="comment">//      }</font>
00088     }
00089     <font class="keywordflow">else</font> {
00090         moveItem(item); <font class="comment">//both items are on the same level, so we can use moveItem</font>
00091     }
00092 }
00093 
00094 <font class="keywordtype">void</font> CItemBase::dropped( QDropEvent* e ) {
00095 }
00096 
00097 
00099 <font class="keyword">const</font> <font class="keywordtype">bool</font> CItemBase::enableAction( <font class="keyword">const</font> MenuAction action ){
00100   <font class="keywordflow">return</font> <font class="keyword">false</font>;
00101 }
00102 
00104 <font class="keyword">const</font> <font class="keywordtype">bool</font> CItemBase::isMovable(){
00105   <font class="keywordflow">return</font> <font class="keyword">false</font>;
00106 }
00107 
00108 <font class="comment">/* ---------------------------------------------- */</font>
00109 <font class="comment">/* ---------- new class: CModuleItem ------------ */</font>
00110 <font class="comment">/* ---------------------------------------------- */</font>
00111 
00112 CModuleItem::CModuleItem(<a class="code" href="class_c_tree_folder.html">CTreeFolder</a>* parentItem, <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* module) : CItemBase(parentItem), m_module(module) {
00113 }
00114 
00115 CModuleItem::~CModuleItem() {
00116 }
00117 
00119 <font class="keywordtype">void</font> CModuleItem::update(){
00120   <font class="keywordflow">if</font> (m_module) {
00121     setPixmap(0, <a class="code" href="class_c_tool_class.html#d4">CToolClass::getIconForModule</a>(m_module));
00122     <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0,m_module-&gt;name() );
00123   }
00124 }
00125 
00126 <font class="keywordtype">void</font> CModuleItem::init(){
00127   setDragEnabled(<font class="keyword">false</font>);
00128   setDropEnabled(<font class="keyword">true</font>);
00129 
00130   update();
00131 }
00132 
00133 
00135 <font class="keywordtype">bool</font> CModuleItem::acceptDrop( <font class="keyword">const</font> QMimeSource* src )<font class="keyword"> const </font>{
00136   qWarning(<font class="stringliteral">"CModuleItem::acceptDrop( const QMimeSource* src )"</font>);
00137   <font class="keywordflow">if</font> (src-&gt;provides(<font class="stringliteral">"text/"</font>REFERENCE) || src-&gt;provides(<font class="stringliteral">"text/"</font>BOOKMARK)) {
00138     QString str;
00139     QCString submime;
00140     <font class="keywordflow">if</font> (QTextDrag::canDecode(src) &amp;&amp; (QTextDrag::decode(src,str,submime=REFERENCE) || QTextDrag::decode(src,str,submime=BOOKMARK)) ) {
00141           QString ref;
00142       QString mod;
00143       <a class="code" href="class_c_reference_manager.html#d3">CReferenceManager::decodeReference</a>(str,mod,ref);
00144 
00145       <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* m = <a class="code" href="class_c_pointers.html#d1">backend</a>()-&gt;<a class="code" href="class_c_sword_backend.html#a11">findModuleByName</a>(mod);
00146       <font class="keywordflow">if</font> (m &amp;&amp; module()-&gt;<a class="code" href="class_c_sword_module_info.html#a15">type</a>() == m-&gt;<a class="code" href="class_c_sword_module_info.html#a15">type</a>()) { <font class="comment">//it makes only sense to create a new window for a module with the same type</font>
00147         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00148       }
00149       <font class="keywordflow">else</font>
00150         <font class="keywordflow">return</font> <font class="keyword">false</font>;
00151     }
00152   }
00153   <font class="keywordflow">if</font> (src-&gt;provides(<font class="stringliteral">"text/"</font>TEXT))
00154     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00155   <font class="keywordflow">return</font> <font class="keyword">false</font>;
00156 }
00157 
00159 <font class="keywordtype">void</font> CModuleItem::dropped( QDropEvent* e ){
00160   QString str;
00161   QCString submime;
00162   <font class="keywordflow">if</font> (QTextDrag::canDecode(e) &amp;&amp; (QTextDrag::decode(e,str,submime=REFERENCE) || QTextDrag::decode(e,str,submime=BOOKMARK)) ) {
00163         QString ref;
00164     QString mod;
00165     <a class="code" href="class_c_reference_manager.html#d3">CReferenceManager::decodeReference</a>(str,mod,ref);
00166 
00167     <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* m = <a class="code" href="class_c_pointers.html#d1">backend</a>()-&gt;<a class="code" href="class_c_sword_backend.html#a11">findModuleByName</a>(mod);
00168     <font class="keywordflow">if</font> (m &amp;&amp; module()-&gt;<a class="code" href="class_c_sword_module_info.html#a15">type</a>() == m-&gt;<a class="code" href="class_c_sword_module_info.html#a15">type</a>()) { <font class="comment">//it makes only sense to create a new window for a module with the same type</font>
00169       ListCSwordModuleInfo modules;
00170       modules.append(module());
00171 
00172       listView()-&gt;emitModulesChosen(modules, ref);
00173     }
00174   }
00175   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (QTextDrag::canDecode(e) &amp;&amp; QTextDrag::decode(e,str,submime=TEXT)){
00176         <font class="comment">//plain text was dragged -&gt; open searchdialog</font>
00177         <font class="keywordflow">if</font> ( module() ) {
00178       ListCSwordModuleInfo modules;
00179       modules.append(module());
00180 
00181       listView()-&gt;openSearchDialog(modules, str);
00182     }
00183   }
00184 
00185 }
00186 
00187 
00189 <font class="keyword">const</font> QString CModuleItem::toolTip(){
00190     QString <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a>;
00191         <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> = i18n(<font class="stringliteral">"Module"</font>) + QString::fromLatin1(<font class="stringliteral">": &lt;B&gt;%1&lt;/B&gt;&lt;HR&gt;"</font>).arg( module()-&gt;name() );
00192         <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += module()-&gt;config(CSwordModuleInfo::Description) + QString::fromLatin1(<font class="stringliteral">"&lt;HR&gt;"</font>);
00193         <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += i18n(<font class="stringliteral">"Language"</font>)+ QString::fromLatin1(<font class="stringliteral">": %1&lt;BR&gt;"</font>).arg(module()-&gt;module()-&gt;Lang());
00194         <font class="keywordflow">if</font> (module()-&gt;isEncrypted())
00195             <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += i18n(<font class="stringliteral">"Unlock key"</font>) + QString::fromLatin1(<font class="stringliteral">": %1&lt;BR&gt;"</font>)
00196                 .arg(!module()-&gt;config(CSwordModuleInfo::CipherKey).isEmpty() ? module()-&gt;config(CSwordModuleInfo::CipherKey) : QString("&lt;FONT COLOR=\"red\"&gt;%1&lt;/FONT&gt;").arg(i18n("not set")));
00197         <font class="keywordflow">if</font> (module()-&gt;hasVersion())
00198             <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += i18n(<font class="stringliteral">"Version"</font>) + QString::fromLatin1(<font class="stringliteral">": %1&lt;BR&gt;"</font>).arg(module()-&gt;config(CSwordModuleInfo::ModuleVersion));
00199                 
00200     QString options;
00201     <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> opts;
00202     <font class="keywordflow">for</font> (opts = CSwordBackend::filterOptionsMIN; opts &lt;= CSwordBackend::filterOptionsMAX; ++opts){
00203         <font class="keywordflow">if</font> (module()-&gt;has( (<a class="code" href="class_c_sword_backend.html#s15">CSwordBackend::FilterOptions</a>) opts )) {
00204             <font class="keywordflow">if</font> (!options.isEmpty())
00205                 options += QString::fromLatin1(<font class="stringliteral">", "</font>);
00206             options += <a class="code" href="class_c_sword_backend.html#d3">CSwordBackend::translatedOptionName</a>( (<a class="code" href="class_c_sword_backend.html#s15">CSwordBackend::FilterOptions</a>) opts);
00207         }
00208     }
00209     <font class="keywordflow">if</font> (!options.isEmpty())
00210         <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += i18n(<font class="stringliteral">"Options"</font>) + QString::fromLatin1(<font class="stringliteral">": &lt;font size= \"-1\"&gt;"</font>) + options + QString::fromLatin1(<font class="stringliteral">"&lt;/font&gt;"</font>);
00211             
00212         <font class="keywordflow">if</font> (<a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a>.right(4) == QString::fromLatin1(<font class="stringliteral">"&lt;BR&gt;"</font>))
00213             <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> = <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a>.left(<a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a>.length()-4);
00214         <font class="keywordflow">return</font> <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a>;
00215 }
00216 
00218 <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* <font class="keyword">const</font> CModuleItem::module()<font class="keyword"> const </font>{
00219   <font class="keywordflow">return</font> m_module;
00220 }
00221 
00223 <font class="keyword">const</font> QString CModuleItem::aboutInfo(){
00224     QString <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a>;   
00225 
00226   <font class="keywordflow">if</font> (module()-&gt;hasVersion())
00227     <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += QString::fromLatin1(<font class="stringliteral">"&lt;b&gt;%1:&lt;/b&gt; %2&lt;br&gt;"</font>)
00228         .arg(i18n(<font class="stringliteral">"Version"</font>))
00229         .arg(module()-&gt;config(CSwordModuleInfo::ModuleVersion));
00230 
00231     <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += QString::fromLatin1(<font class="stringliteral">"&lt;b&gt;%1:&lt;/b&gt; %2&lt;br&gt;&lt;b&gt;%3:&lt;/b&gt; %4&lt;br&gt;"</font>)
00232         .arg(i18n(<font class="stringliteral">"Location"</font>))
00233         .arg(module()-&gt;config(CSwordModuleInfo::AbsoluteDataPath))
00234         .arg(i18n(<font class="stringliteral">"Language"</font>))
00235         .arg(module()-&gt;module()-&gt;Lang());
00236 
00237     <font class="keywordflow">if</font> (module()-&gt;module()-&gt;isWritable())
00238         <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += QString::fromLatin1(<font class="stringliteral">"&lt;b&gt;%1:&lt;/b&gt; %2&lt;br&gt;"</font>)
00239                             .arg(i18n(<font class="stringliteral">"Writable"</font>))
00240                             .arg(i18n(<font class="stringliteral">"yes"</font>));
00241 
00242     <font class="keywordflow">if</font> ( module()-&gt;isEncrypted() )
00243         <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += QString::fromLatin1(<font class="stringliteral">"&lt;b&gt;%1:&lt;/b&gt; %2&lt;br&gt;"</font>)
00244                             .arg(i18n(<font class="stringliteral">"Unlock key"</font>))
00245                             .arg(module()-&gt;config(CSwordModuleInfo::CipherKey));    
00246     <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += QString::fromLatin1(<font class="stringliteral">"&lt;b&gt;%1:&lt;/b&gt; %2&lt;br&gt;"</font>).arg(i18n(<font class="stringliteral">"Encoding"</font>)).arg(module()-&gt;isUnicode() ? i18n(<font class="stringliteral">"Unicode"</font>) : i18n("iso8859-1"));
00247 
00248     QString options;
00249     <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> opts;
00250     <font class="keywordflow">for</font> (opts = CSwordBackend::filterOptionsMIN; opts &lt;= CSwordBackend::filterOptionsMAX; ++opts){
00251         <font class="keywordflow">if</font> (module()-&gt;has( static_cast&lt;CSwordBackend::FilterOptions&gt;(opts) )){
00252         <font class="keywordflow">if</font> (!options.isEmpty())
00253             options += QString::fromLatin1(<font class="stringliteral">", "</font>);
00254         options += <a class="code" href="class_c_sword_backend.html#d3">CSwordBackend::translatedOptionName</a>( static_cast&lt;CSwordBackend::FilterOptions&gt;(opts) );
00255         }
00256     }
00257     <font class="keywordflow">if</font> (!options.isEmpty())
00258         <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += QString(<font class="stringliteral">"&lt;b&gt;%1:&lt;/b&gt; %2&lt;br&gt;"</font>)
00259             .arg(i18n(<font class="stringliteral">"Features"</font>))
00260             .arg(options);
00261 
00262     <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a> += QString::fromLatin1(<font class="stringliteral">"&lt;b&gt;%1:&lt;/b&gt;&lt;br&gt; &lt;font size=\"-1\"&gt;%2&lt;/font&gt;"</font>)
00263                         .arg(<font class="stringliteral">"About"</font>)
00264                         .arg(module()-&gt;config(CSwordModuleInfo::AboutInformation));
00265   <font class="keywordflow">return</font> <a class="code" href="class_c_h_t_m_l_read_display.html#a0">text</a>;
00266 }
00267 
00268 
00270 <font class="keyword">const</font> <font class="keywordtype">bool</font> CModuleItem::enableAction( <font class="keyword">const</font> MenuAction action ){
00271   <font class="keywordflow">if</font> (action == SearchInModules || action == AboutModule)
00272     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00273   <font class="keywordflow">if</font> (module()-&gt;isEncrypted() &amp;&amp; action == UnlockModule)
00274     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00275   <font class="keywordflow">return</font> <font class="keyword">false</font>;
00276 }
00277 
00278 <font class="comment">/* ----------------------------------------------*/</font>
00279 <font class="comment">/* ---------- new class: CBookmarkItem ------------*/</font>
00280 <font class="comment">/* ----------------------------------------------*/</font>
00281 
00282 CBookmarkItem::CBookmarkItem(CFolderBase* parentItem, <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* module, <font class="keyword">const</font> QString&amp; key, <font class="keyword">const</font> QString&amp; description) : CItemBase(parentItem), m_key(key), m_description(description), m_module(module) {
00283   <font class="keywordflow">if</font> (module &amp;&amp; (module-&gt;<a class="code" href="class_c_sword_module_info.html#a15">type</a>() == CSwordModuleInfo::Bible || module-&gt;<a class="code" href="class_c_sword_module_info.html#a15">type</a>() == CSwordModuleInfo::Commentary)  ) {
00284     <a class="code" href="class_c_sword_verse_key.html">CSwordVerseKey</a> vk(0);
00285     vk = key;
00286     m_key = vk.<a class="code" href="class_c_sword_verse_key.html#a4">key</a>(); <font class="comment">//now we're sure it's the key in the selected bookname language!</font>
00287   }
00288   <font class="keywordflow">else</font>
00289    m_key = key;
00290   m_startupXML = QDomElement();
00291 }
00292 
00293 CBookmarkItem::CBookmarkItem(CFolderBase* parentItem, QDomElement&amp; xml ) : CItemBase(parentItem), m_key(QString::null), m_description(QString::null), m_module(0) {
00294   m_startupXML = xml;
00295 }
00296 
00297 CBookmarkItem::~CBookmarkItem() {
00298 
00299 }
00300 
00302 <font class="keywordtype">void</font> CBookmarkItem::update(){
00303 <font class="comment">//  CItemBase::update();</font>
00304   <font class="keyword">const</font> QString title = QString::fromLatin1(<font class="stringliteral">"%1 (%2)"</font>).arg(key()).arg(module() ? module()-&gt;name() : i18n("unknown"));
00305   <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0, title);
00306   setPixmap(0,BOOKMARK_ICON_SMALL);
00307 }
00308 
00309 <font class="keywordtype">void</font> CBookmarkItem::init(){
00310   <font class="keywordflow">if</font> (!m_startupXML.isNull())
00311     loadFromXML(m_startupXML);
00312 
00313 <font class="comment">//  CItemBase::init();</font>
00314   update();
00315   setDropEnabled(<font class="keyword">false</font>);
00316   setDragEnabled(<font class="keyword">false</font>);
00317 }
00318 
00320 <font class="keyword">const</font> QString CBookmarkItem::toolTip(){
00321   <font class="keywordflow">if</font> (!module())
00322     <font class="keywordflow">return</font> QString::null;
00323 
00324   <font class="keywordflow">return</font> <a class="code" href="class_c_tooltip_manager.html#d1">CTooltipManager::textForReference</a>(module()-&gt;name(), key(), description());
00325 }
00326 
00328 <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* <font class="keyword">const</font> CBookmarkItem::module() {
00329   <font class="keywordflow">return</font> m_module;
00330 }
00331 
00333 <font class="keyword">const</font> QString&amp; CBookmarkItem::key(){
00334   <font class="keywordflow">return</font> m_key;
00335 }
00336 
00338 <font class="keyword">const</font> QString&amp; CBookmarkItem::description(){
00339    <font class="keywordflow">return</font> m_description;
00340 }
00341 
00343 <font class="keyword">const</font> <font class="keywordtype">bool</font> CBookmarkItem::isMovable(){
00344   <font class="keywordflow">return</font> <font class="keyword">true</font>;
00345 }
00346 
00348 <font class="keyword">const</font> <font class="keywordtype">bool</font> CBookmarkItem::enableAction(<font class="keyword">const</font> MenuAction action){
00349   <font class="keywordflow">if</font> (action == ChangeBookmark || action == PrintBookmarks || action == DeleteEntries)
00350     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00351 
00352   <font class="keywordflow">return</font> <font class="keyword">false</font>;
00353 }
00354 
00355 <font class="keywordtype">void</font> CBookmarkItem::print(){
00356 
00357 }
00358 
00360 <font class="keywordtype">void</font> CBookmarkItem::rename(){
00361 
00362 }
00363 
00365 QDomElement CBookmarkItem::saveToXML( QDomDocument&amp; doc ){
00366   qWarning(<font class="stringliteral">"CBookmarkItem::saveToXML( QDomDocument&amp; doc )"</font>);
00367   QDomElement elem = doc.createElement(<font class="stringliteral">"Bookmark"</font>);
00368 
00369   QString keyName = key();
00370   <font class="keywordflow">if</font> (module()-&gt;type() == CSwordModuleInfo::Bible || module()-&gt;type() == CSwordModuleInfo::Commentary) {
00371     <a class="code" href="class_c_sword_verse_key.html">CSwordVerseKey</a> vk(0);
00372     vk = keyName;
00373     vk.setLocale(<font class="stringliteral">"en"</font>);
00374     keyName = vk.<a class="code" href="class_c_sword_verse_key.html#a4">key</a>(); <font class="comment">//now we're sure the key is in english! All bookname languages support english!</font>
00375   }
00376   elem.setAttribute(<font class="stringliteral">"key"</font>, keyName);
00377 
00378   elem.setAttribute(<font class="stringliteral">"description"</font>, description());
00379   elem.setAttribute(<font class="stringliteral">"modulename"</font>, module()-&gt;name());
00380   elem.setAttribute(<font class="stringliteral">"moduledescription"</font>, module()-&gt;config(CSwordModuleInfo::Description));
00381 
00382   <font class="keywordflow">return</font> elem;
00383 }
00384 
00385 <font class="keywordtype">void</font> CBookmarkItem::loadFromXML( QDomElement&amp; element ) {
00386   <font class="comment">//find the right module</font>
00387   <font class="keywordflow">if</font> (element.hasAttribute(<font class="stringliteral">"modulename"</font>) &amp;&amp; element.hasAttribute(<font class="stringliteral">"moduledescription"</font>)) {
00388     m_module = <a class="code" href="class_c_pointers.html#d1">backend</a>()-&gt;<a class="code" href="class_c_sword_backend.html#a11">findModuleByName</a>(element.attribute(<font class="stringliteral">"modulename"</font>));
00389     <font class="keywordflow">if</font> (m_module-&gt;config(CSwordModuleInfo::Description) != element.attribute(<font class="stringliteral">"moduledescription"</font>)) {
00390       qWarning(<font class="stringliteral">"Can't find module with name %s and description %s"</font>,element.attribute(<font class="stringliteral">"modulename"</font>).latin1(), element.attribute(<font class="stringliteral">"moduledescription"</font>).latin1() );
00391     }
00392   }
00393 
00394   <font class="keywordflow">if</font> (element.hasAttribute(<font class="stringliteral">"key"</font>)) {
00395     QString key = element.attribute(<font class="stringliteral">"key"</font>);
00396 
00397     <font class="keywordflow">if</font> (module() &amp;&amp; (module()-&gt;type() == CSwordModuleInfo::Bible || module()-&gt;type() == CSwordModuleInfo::Commentary)  ) {
00398       <a class="code" href="class_c_sword_verse_key.html">CSwordVerseKey</a> vk(0);
00399       vk = key;
00400       m_key = vk.<a class="code" href="class_c_sword_verse_key.html#a4">key</a>(); <font class="comment">//now we're sure it's the key in the selected bookname language!</font>
00401     }
00402     <font class="keywordflow">else</font>
00403      m_key = key;
00404   }
00405 
00406   <font class="keywordflow">if</font> (element.hasAttribute(<font class="stringliteral">"description"</font>))
00407     m_description = element.attribute(<font class="stringliteral">"description"</font>);
00408 }
00409 
00410 <font class="comment">/****************************************/</font>
00411 <font class="comment">/*****  class: CItemFolder  *************/</font>
00412 <font class="comment">/****************************************/</font>
00413 
00414 CFolderBase::CFolderBase(CMainIndex* mainIndex, <font class="keyword">const</font> Type type) : CItemBase(mainIndex, type) {
00415 }
00416 
00417 CFolderBase::CFolderBase(CFolderBase* parentItem, <font class="keyword">const</font> Type type) : CItemBase(parentItem, type) {
00418 }
00419 
00420 CFolderBase::CFolderBase(CFolderBase* parentFolder, <font class="keyword">const</font> QString&amp; caption) : CItemBase(parentFolder){
00421   <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0, caption);
00422 }
00423 
00424 CFolderBase::~CFolderBase() {
00425 }
00426 
00427 <font class="keyword">const</font> <font class="keywordtype">bool</font> CFolderBase::isFolder() {
00428   <font class="keywordflow">return</font> <font class="keyword">true</font>;
00429 }
00430 
00431 <font class="keywordtype">void</font> CFolderBase::update() {
00432   CItemBase::update();
00433   <font class="keywordflow">if</font> (isOpen() &amp;&amp; childCount())
00434     setPixmap(0,GROUP_OPEN_ICON_SMALL);
00435   <font class="keywordflow">else</font>
00436     setPixmap(0,GROUP_ICON_SMALL);
00437 }
00438 
00439 <font class="keywordtype">void</font> CFolderBase::init() {
00440   CItemBase::init();
00441   setDropEnabled(<font class="keyword">false</font>);
00442   setDragEnabled(<font class="keyword">false</font>);
00443 }
00444 
00446 <font class="keywordtype">void</font> CFolderBase::setOpen( <font class="keywordtype">bool</font> open ){
00447   KListViewItem::setOpen(open);
00448   update();
00449 }
00450 
00452 <font class="keywordtype">void</font> CFolderBase::rename(){
00453   startRename(0);
00454 }
00455 
00457 <font class="keywordtype">void</font> CFolderBase::newSubFolder(){
00458   <font class="keywordflow">if</font> (dynamic_cast&lt;CBookmarkFolder*&gt;(this) || dynamic_cast&lt;CBookmarkFolder::SubFolder*&gt;(this) ) {
00459     CBookmarkFolder::SubFolder* f = <font class="keyword">new</font> CBookmarkFolder::SubFolder(<font class="keyword">this</font>, i18n(<font class="stringliteral">"New folder"</font>));
00460     f-&gt;init();
00461 
00462     listView()-&gt;setCurrentItem(f);
00463     listView()-&gt;ensureItemVisible(f);
00464     f-&gt;rename();
00465   }
00466 }
00467 
00468 <font class="comment">/****************************************/</font>
00469 <font class="comment">/*****  class: CTreeFolder  *************/</font>
00470 <font class="comment">/****************************************/</font>
00471 
00472 
00473 CTreeFolder::CTreeFolder(CMainIndex* mainIndex, <font class="keyword">const</font> Type type, <font class="keyword">const</font> QString&amp; language) : CFolderBase(mainIndex, type) {
00474   m_language = language;
00475 }
00476 
00477 CTreeFolder::CTreeFolder(CFolderBase* item, <font class="keyword">const</font> Type type, <font class="keyword">const</font> QString&amp; language) : CFolderBase(item, type) {
00478   m_language = language;
00479 }
00480 
00481 CTreeFolder::~CTreeFolder(){
00482 }
00483 
00484 <font class="keywordtype">void</font> CTreeFolder::addGroup(<font class="keyword">const</font> Type type, <font class="keyword">const</font> QString language){
00485   <a class="code" href="class_c_tree_folder.html">CTreeFolder</a>* i = 0;
00486   <font class="keywordflow">if</font> (type == BookmarkFolder)
00487     i = <font class="keyword">new</font> CBookmarkFolder(<font class="keyword">this</font>);
00488   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (type == OldBookmarkFolder)
00489     i = <font class="keyword">new</font> COldBookmarkFolder(<font class="keyword">this</font>);
00490   <font class="keywordflow">else</font>
00491     i = <font class="keyword">new</font> <a class="code" href="class_c_tree_folder.html">CTreeFolder</a>(<font class="keyword">this</font>, type, language);
00492   i-&gt;<a class="code" href="class_c_tree_folder.html#a8">init</a>();
00493   <font class="keywordflow">if</font> (!i-&gt;childCount())
00494     <font class="keyword">delete</font> i;
00495 }
00496 
00497 <font class="keywordtype">void</font> CTreeFolder::addModule(<a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* <font class="keyword">const</font> module){
00498   CModuleItem* i = <font class="keyword">new</font> CModuleItem(<font class="keyword">this</font>, module);
00499   i-&gt;init();
00500 }
00501 
00502 <font class="keywordtype">void</font> CTreeFolder::addBookmark(<a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* module, <font class="keyword">const</font> QString&amp; key, <font class="keyword">const</font> QString&amp; description){
00503   CBookmarkItem* i = <font class="keyword">new</font> CBookmarkItem(<font class="keyword">this</font>, module, key, description);
00504   i-&gt;init();
00505 }
00506 
00507 <font class="keywordtype">void</font> CTreeFolder::update(){
00508   CFolderBase::update();
00509 }
00510 
00511 <font class="keywordtype">void</font> CTreeFolder::init(){
00512   <font class="keywordflow">if</font> (language() == <font class="stringliteral">"*"</font>) {
00513     <font class="keywordflow">switch</font> (type()) {
00514       <font class="keywordflow">case</font> BibleModuleFolder:
00515         <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0,i18n(<font class="stringliteral">"Bibles"</font>));
00516         <font class="keywordflow">break</font>;
00517       <font class="keywordflow">case</font> CommentaryModuleFolder:
00518         <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0,i18n(<font class="stringliteral">"Commentaries"</font>));
00519         <font class="keywordflow">break</font>;
00520       <font class="keywordflow">case</font> LexiconModuleFolder:
00521         <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0,i18n(<font class="stringliteral">"Lexicon"</font>));
00522         <font class="keywordflow">break</font>;
00523       <font class="keywordflow">case</font> BookModuleFolder:
00524         <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0,i18n(<font class="stringliteral">"Books"</font>));
00525         <font class="keywordflow">break</font>;
00526       <font class="keywordflow">case</font> DevotionalModuleFolder:
00527         <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0,i18n(<font class="stringliteral">"Daily devotionals"</font>));
00528         <font class="keywordflow">break</font>;
00529       <font class="keywordflow">case</font> GlossaryModuleFolder:
00530         <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0,i18n(<font class="stringliteral">"Glossaries"</font>));
00531         <font class="keywordflow">break</font>;
00532       <font class="keywordflow">case</font> BookmarkFolder:
00533         <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0,i18n(<font class="stringliteral">"Bookmark"</font>));
00534         <font class="keywordflow">break</font>;
00535       <font class="keywordflow">case</font> OldBookmarkFolder:
00536         <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0,i18n(<font class="stringliteral">"Old bookmarks"</font>));
00537         <font class="keywordflow">break</font>;
00538       <font class="keywordflow">default</font>:
00539         <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0, i18n(<font class="stringliteral">"Unknown"</font>));
00540         <font class="keywordflow">break</font>;
00541     };
00542   }
00543   <font class="keywordflow">else</font> {
00544     <a class="code" href="class_c_h_t_m_l_read_display.html#a1">setText</a>(0, language());
00545   }
00546   initTree();
00547   update();
00548 }
00549 
00550 <font class="keywordtype">void</font> CTreeFolder::initTree(){
00551   qWarning(<font class="stringliteral">"CTreeMgr::initTree"</font>);
00552   <font class="keywordflow">if</font> (type() == Unknown)
00553     <font class="keywordflow">return</font>;
00554 
00555   CSwordModuleInfo::ModuleType moduleType = CSwordModuleInfo::Unknown;
00556   <font class="keywordflow">if</font> (type() == BibleModuleFolder) {
00557     qWarning(<font class="stringliteral">"insert Bibles!"</font>);
00558     moduleType = CSwordModuleInfo::Bible;
00559   }
00560   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (type() == CommentaryModuleFolder)
00561     moduleType = CSwordModuleInfo::Commentary;
00562   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (type() == LexiconModuleFolder || type() == GlossaryModuleFolder || type() == DevotionalModuleFolder)
00563     moduleType = CSwordModuleInfo::Lexicon;
00564   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (type() == BookModuleFolder)
00565     moduleType = CSwordModuleInfo::GenericBook;
00566 
00567   <font class="comment">//get all modules by the given type</font>
00568   ListCSwordModuleInfo allModules = <a class="code" href="class_c_pointers.html#d1">backend</a>()-&gt;<a class="code" href="class_c_sword_backend.html#a2">moduleList</a>();
00569   ListCSwordModuleInfo usedModules;
00570   <font class="keywordflow">for</font> (<a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* m = allModules.first(); m; m = allModules.next()) {
00571     <font class="keywordflow">if</font> (m-&gt;<a class="code" href="class_c_sword_module_info.html#a15">type</a>() == moduleType) { <font class="comment">//found a module, check if the type is correct (devotional etc.)</font>
00572       <font class="keywordflow">if</font> (type() == GlossaryModuleFolder &amp;&amp; !m-&gt;<a class="code" href="class_c_sword_module_info.html#a20">has</a>(CSwordModuleInfo::Glossary)) {
00573         <font class="keywordflow">continue</font>;
00574       }
00575       <font class="keywordflow">if</font> (type() == DevotionalModuleFolder &amp;&amp; !m-&gt;<a class="code" href="class_c_sword_module_info.html#a20">has</a>(CSwordModuleInfo::DailyDevotional)) {
00576         <font class="keywordflow">continue</font>;
00577       }
00578       <font class="keywordflow">if</font> (language() == QString::fromLatin1(<font class="stringliteral">"*"</font>) || (language() != QString::fromLatin1(<font class="stringliteral">"*"</font>) &amp;&amp; QString::fromLatin1(m-&gt;<a class="code" href="class_c_sword_module_info.html#a5">module</a>()-&gt;Lang()) == language()) )<font class="comment">//right type and language!</font>
00579         usedModules.append(m);
00580     }
00581   }
00582 
00583   qWarning(<font class="stringliteral">"using %i modules language %s"</font>, usedModules.count(), language().latin1());
00584 
00585   <font class="comment">//we have now all modules we want to have</font>
00586   <font class="keywordflow">if</font> (language() == QString::fromLatin1(<font class="stringliteral">"*"</font>)) { <font class="comment">//create subfolders for each language</font>
00587     QStringList usedLangs;
00588     <font class="keywordflow">for</font> (<a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* m = usedModules.first(); m; m = usedModules.next()) {
00589       QString lang = QString::fromLatin1(m-&gt;<a class="code" href="class_c_sword_module_info.html#a5">module</a>()-&gt;Lang());
00590       <font class="keywordflow">if</font> (lang.isEmpty())
00591         lang = <font class="stringliteral">"xx"</font>;
00592       <font class="keywordflow">if</font> (!usedLangs.contains(lang)) {
00593         usedLangs.append(lang);
00594       }
00595     }
00596     QStringList::iterator it;
00597     <font class="keywordflow">for</font> (it = usedLangs.begin(); it != usedLangs.end(); ++it) {
00598       addGroup( type(), *it);
00599     }
00600   }
00601   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (usedModules.count() &gt; 0){ <font class="comment">//create subitems with the given type and language</font>
00602     <font class="keywordflow">for</font> (<a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* m = usedModules.first(); m; m = usedModules.next()) {
00603       addModule(m);
00604     }
00605   }
00606 
00607   sortChildItems(0,<font class="keyword">true</font>);
00608 }
00609 
<a name="l00610"></a><a class="code" href="class_c_tree_folder.html#a9">00610</a> <font class="keyword">const</font> QString <a class="code" href="class_c_tree_folder.html#a9">CTreeFolder::language</a>()<font class="keyword"> const </font>{
00611   <font class="keywordflow">return</font> m_language;
00612 };
00613 
00614 
00615 <font class="comment">/* ----------------------------------------------*/</font>
00616 <font class="comment">/* ---------- new class: COldBookmarkImportItem -*/</font>
00617 <font class="comment">/* ----------------------------------------------*/</font>
00618 
00619 COldBookmarkFolder::COldBookmarkFolder(<a class="code" href="class_c_tree_folder.html">CTreeFolder</a>* folder) : CBookmarkFolder(folder, OldBookmarkFolder) {
00620 }
00621 
00622 COldBookmarkFolder::~COldBookmarkFolder() {
00623   qWarning(<font class="stringliteral">"descructor of COldBookmarkFolder"</font>);
00624 }
00625 
00627 <font class="keywordtype">void</font> COldBookmarkFolder::initTree(){
00628   <font class="comment">//import the bookmarks of the previous BibleTime versions</font>
00629   <font class="keywordflow">if</font> (CBTConfig::get( CBTConfig::readOldBookmarks )) { <font class="comment">//we already imported them, they'll be restored by our normal readFromXML</font>
00630     <font class="keywordflow">return</font>;
00631   }
00632 
00633   KConfig* configFile = <font class="keyword">new</font> KConfig(<font class="stringliteral">"bt-groupmanager"</font>, <font class="keyword">false</font>, <font class="keyword">false</font> );
00634     KConfigGroupSaver groupSaver(configFile, <font class="stringliteral">"Groupmanager"</font>);   
00635   readGroups(configFile);
00636 
00637   CFolderBase* parent = 0;
00638     QStringList groupList = configFile-&gt;readListEntry(<font class="stringliteral">"Groups"</font>);
00639 
00640     <font class="comment">//read in all bookmarks</font>
00641     QStringList bookmarkList                            = configFile-&gt;readListEntry(<font class="stringliteral">"Bookmarks"</font>);
00642     QStringList bookmarkModulesList             = configFile-&gt;readListEntry(<font class="stringliteral">"Bookmark modules"</font>);
00643     QStringList bookmarkDescriptionsList    = configFile-&gt;readListEntry(<font class="stringliteral">"Bookmark descriptions"</font>);
00644     QValueList&lt;int&gt; parentList                      = configFile-&gt;readIntListEntry(<font class="stringliteral">"Bookmark parents"</font>);
00645 
00646     QStringList::Iterator it_bookmarks  = bookmarkList.begin();
00647     QStringList::Iterator it_modules        = bookmarkModulesList.begin();
00648     QStringList::Iterator it_descriptions   = bookmarkDescriptionsList.begin();
00649     QValueList&lt;int&gt;::Iterator it_parents = parentList.begin();
00650 
00651     <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* moduleInfo = 0;
00652     CItemBase *myItem = 0;  
00653     CItemBase *oldItem = 0;
00654 
00655     <font class="keywordflow">while</font> ( it_bookmarks != bookmarkList.end() &amp;&amp; it_parents != parentList.end()
00656                     &amp;&amp; it_modules != bookmarkModulesList.end() )
00657   {
00658         moduleInfo = <a class="code" href="class_c_pointers.html#d1">backend</a>()-&gt;<a class="code" href="class_c_sword_backend.html#a11">findModuleByName</a>((*it_modules));
00659         <font class="keywordflow">if</font> ( (*it_parents) == -1) {
00660             myItem = <font class="keyword">new</font> CBookmarkItem(<font class="keyword">this</font>, moduleInfo, (*it_bookmarks), (*it_descriptions));
00661         }
00662         <font class="keywordflow">else</font> {
00663             parent = findParent( (*it_parents) );
00664             <font class="keywordflow">if</font> (parent)
00665                 myItem = <font class="keyword">new</font> CBookmarkItem(parent, moduleInfo, (*it_bookmarks), (*it_descriptions));
00666             <font class="keywordflow">else</font>
00667                 myItem = <font class="keyword">new</font> CBookmarkItem(<font class="keyword">this</font>, moduleInfo, (*it_bookmarks), (*it_descriptions));
00668       myItem-&gt;init();
00669         }
00670         <font class="keywordflow">if</font> (myItem &amp;&amp; oldItem) {
00671             myItem-&gt;moveAfter(oldItem);
00672         }
00673         oldItem = myItem;
00674 
00675         ++it_parents;
00676         ++it_modules;
00677         ++it_descriptions;
00678         ++it_bookmarks;
00679     }
00680 }
00681 
00682 CFolderBase* COldBookmarkFolder::findParent( <font class="keyword">const</font> <font class="keywordtype">int</font> ID ){
00683 <font class="comment">//  qWarning("CBookmarkItem::findParent( const int ID )");</font>
00684   CFolderBase* myItem = 0;
00685     <font class="keywordtype">int</font> index = 0;
00686     
00687     QListViewItemIterator it = QListViewItemIterator(<font class="keyword">this</font>);
00688 
00689   <font class="comment">//traverse the tree and try to find the group with the id ID index using comparision</font>
00690   <font class="keywordflow">for</font>( ; it.current(); it++ ) {
00691         myItem = dynamic_cast&lt;CFolderBase*&gt;( it.current() );
00692     Q_ASSERT(myItem);
00693         <font class="keywordflow">if</font> (myItem != <font class="keyword">this</font> &amp;&amp; myItem &amp;&amp; myItem-&gt;isFolder() ) {<font class="comment">//group item</font>
00694             <font class="keywordflow">if</font> (index == ID) {
00695                 <font class="keywordflow">return</font> myItem;
00696             }
00697             <font class="keywordflow">else</font>
00698                 index++;
00699         }
00700     }       
00701     <font class="keywordflow">return</font> 0;   <font class="comment">// return 0 if parent wasn't found</font>
00702 }
00703 
00704 <font class="keyword">const</font> <font class="keywordtype">bool</font> COldBookmarkFolder::readGroups(KConfig* configFile ) {
00705 <font class="comment">//  qWarning("CBookmarkItem::readGroups(KConfig* configFile, CGroupManagerItem* group, const Action action)");</font>
00706  <font class="comment">//read and create group entries</font>
00707     CFolderBase* parent = 0;
00708     <font class="keywordtype">bool</font> groupExists = <font class="keyword">false</font>;   
00709     CFolderBase* oldItem = 0;
00710     CFolderBase* newItem = 0;
00711     
00712     QStringList groupList = configFile-&gt;readListEntry(<font class="stringliteral">"Groups"</font>);
00713     QValueList&lt;int&gt; parentList = configFile-&gt;readIntListEntry(<font class="stringliteral">"Group parents"</font>); 
00714     QStringList::Iterator it_groups = groupList.begin();
00715     QValueList&lt;int&gt;::Iterator it_parents = parentList.begin();
00716     
00717     <font class="keywordflow">while</font> ( (it_groups != groupList.end()) &amp;&amp; (it_parents != parentList.end()) ) {
00718         groupExists = <font class="keyword">false</font>;
00719         <font class="keywordflow">if</font> ( (*it_parents) == -1) { <font class="comment">//no parent item saved</font>
00720             parent = <font class="keyword">this</font>;
00721         }
00722         <font class="keywordflow">else</font> {
00723             parent = findParent( (*it_parents) );
00724 <font class="comment">//          if (!parentItem)</font>
00725 <font class="comment">//              parentItem = this;</font>
00726         }
00727         
00728         <font class="keywordflow">if</font> (!groupExists) {
00729             newItem = <font class="keyword">new</font> SubFolder(parent ? parent : <font class="keyword">this</font>, (*it_groups));
00730           newItem-&gt;init();
00731 
00732             <font class="keywordflow">if</font> (newItem &amp;&amp; oldItem ) {          
00733                 newItem-&gt;moveAfter( oldItem );
00734             }
00735             <font class="keywordflow">if</font> (newItem) {
00736                 <font class="comment">/* we can't move a topgroup behind a subgroup, so we use multiple</font>
00737 <font class="comment">                 parent calls</font>
00738 <font class="comment">                */</font>
00739 <font class="comment">//              while (parentId(newItem) &gt; (*it_parents) ) {</font>
00740 <font class="comment">//                  if ( newItem &amp;&amp; newItem-&gt;parent() )</font>
00741 <font class="comment">//                      newItem = dynamic_cast&lt;CItem*&gt;(newItem-&gt;parent());</font>
00742 <font class="comment">//                  else</font>
00743 <font class="comment">//                      break;</font>
00744 <font class="comment">//              }</font>
00745                 oldItem = newItem;
00746             }                   
00747         }
00748         
00749         ++it_parents;
00750         ++it_groups;
00751     }   
00752     <font class="keywordflow">return</font> <font class="keyword">true</font>;    
00753 };
00754 
00755 <font class="keyword">const</font> <font class="keywordtype">int</font> COldBookmarkFolder::parentId(CItemBase *item) {
00756     <font class="keywordtype">int</font> ret = -1;   <font class="comment">// the view and the parent item have id -1</font>
00757     <font class="keywordtype">int</font> index = 0;
00758     CItemBase* myItem = 0;
00759     
00760     <font class="keywordflow">if</font> (item) {
00761         <font class="keywordflow">if</font> (item-&gt;parent()) {
00762           QListViewItemIterator it = QListViewItemIterator( <font class="keyword">this</font> );
00763             
00764             <font class="keywordflow">while</font> (it.current() &amp;&amp; (it.current() != item-&gt;parent()) ) {
00765                 myItem = dynamic_cast&lt;CItemBase*&gt;(it.current());
00766                 <font class="keywordflow">if</font> (myItem != <font class="keyword">this</font> &amp;&amp; myItem &amp;&amp; myItem-&gt;isFolder()) {
00767                     index++;
00768                 }
00769                 it++;
00770             }
00771             <font class="keywordflow">if</font> (it.current())
00772                 ret = index;
00773         }
00774     }
00775     <font class="keywordflow">return</font> ret;
00776 }
00777 
00778 QDomElement COldBookmarkFolder::saveToXML( QDomDocument&amp; doc ) {
00779   QDomElement elem = doc.createElement(<font class="stringliteral">"Folder"</font>);
00780   elem.setAttribute(<font class="stringliteral">"caption"</font>, text(0));
00781 
00782   <font class="comment">//append the XML nodes of all child items</font>
00783   CItemBase* i = dynamic_cast&lt;CItemBase*&gt;(firstChild());
00784   <font class="keywordflow">while</font>( i ) {
00785     <font class="keywordflow">if</font> (i-&gt;parent() == <font class="keyword">this</font>) {
00786       QDomElement newElem = i-&gt;saveToXML( doc );
00787       <font class="keywordflow">if</font> (!newElem.isNull()) {
00788         elem.appendChild( newElem ); <font class="comment">//append to this folder</font>
00789       }
00790     }
00791     i = dynamic_cast&lt;CItemBase*&gt;( i-&gt;nextSibling() );
00792   }
00793 
00794   CBTConfig::set( CBTConfig::readOldBookmarks, <font class="keyword">true</font> );
00795 
00796   <font class="keywordflow">return</font> elem;
00797 }
00798 
00799 <font class="keywordtype">void</font> COldBookmarkFolder::loadFromXML( QDomElement&amp; element ) {
00800 
00801 }
00802 
00803 <font class="comment">/* --------------------------------------------------*/</font>
00804 <font class="comment">/* ---------- new class: CBookmarkFolder::SubFolder--*/</font>
00805 <font class="comment">/* --------------------------------------------------*/</font>
00806 
00807 CBookmarkFolder::SubFolder::SubFolder(CFolderBase* parentItem, <font class="keyword">const</font> QString&amp; caption) : CFolderBase(parentItem, caption) {
00808   m_startupXML = QDomElement();
00809 }
00810 
00811 CBookmarkFolder::SubFolder::SubFolder(CFolderBase* parentItem, QDomElement&amp; xml ) : CFolderBase(parentItem, QString::null) {
00812   m_startupXML = xml;
00813 }
00814 
00815 CBookmarkFolder::SubFolder::~SubFolder() {
00816 
00817 }
00818 
00819 <font class="keywordtype">void</font> CBookmarkFolder::SubFolder::init() {
00820   CFolderBase::init();
00821   <font class="keywordflow">if</font> (!m_startupXML.isNull())
00822     loadFromXML(m_startupXML);
00823 
00824   setDropEnabled(<font class="keyword">true</font>);
00825   setRenameEnabled(0,<font class="keyword">true</font>);
00826 }
00827 
00829 <font class="keywordtype">void</font> CBookmarkFolder::SubFolder::dropped(QDropEvent * e) {
00830   QString str;
00831   QCString submime;
00832 
00833   <font class="keywordflow">if</font> (acceptDrop(e) &amp;&amp; QTextDrag::decode(e,str,submime=REFERENCE) ) { <font class="comment">//a drag object, we can handle</font>
00834     QString mod;
00835     QString key;
00836     <a class="code" href="class_c_reference_manager.html#d3">CReferenceManager::decodeReference</a>(str,mod,key);
00837 
00838     <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* module = <a class="code" href="class_c_pointers.html#d1">backend</a>()-&gt;<a class="code" href="class_c_sword_backend.html#a11">findModuleByName</a>(mod);
00839     CBookmarkItem* i = <font class="keyword">new</font> CBookmarkItem(<font class="keyword">this</font>, module, key, QString::null);
00840     i-&gt;init();
00841   }
00842   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (acceptDrop(e) &amp;&amp; QTextDrag::decode(e,str,submime=BOOKMARK) ) { <font class="comment">//a drag object, we can handle</font>
00843   }
00844 }
00845 
00846 <font class="keywordtype">bool</font> CBookmarkFolder::SubFolder::acceptDrop(<font class="keyword">const</font> QMimeSource * src)<font class="keyword"> const </font>{
00847   qWarning(<font class="stringliteral">"CBookmarkFolder::SubFolder::acceptDrop(const QMimeSource * src)"</font>);
00848   <font class="keywordflow">if</font> (src-&gt;provides(<font class="stringliteral">"text/"</font>REFERENCE) || src-&gt;provides(<font class="stringliteral">"text/"</font>BOOKMARK)) {
00849     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00850   }
00851   <font class="keywordflow">return</font> <font class="keyword">false</font>;
00852 }
00853 
00855 <font class="keyword">const</font> <font class="keywordtype">bool</font> CBookmarkFolder::SubFolder::enableAction(<font class="keyword">const</font> MenuAction action){
00856   <font class="keywordflow">if</font> (action == ChangeFolder || action == NewFolder || action == DeleteEntries || action == ImportBookmarks )
00857     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00858 
00859   <font class="keywordflow">if</font> (childCount() &gt; 0 &amp;&amp; action == ExportBookmarks)
00860     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00861 
00862   <font class="keywordflow">return</font> <font class="keyword">false</font>;
00863 }
00864 
00866 QDomElement CBookmarkFolder::SubFolder::saveToXML( QDomDocument&amp; doc ) {
00871   qWarning(<font class="stringliteral">"CBookmarkFolder::SubFolder::saveToXML( QDomDocument&amp; doc )"</font>);
00872 
00873   QDomElement elem = doc.createElement(<font class="stringliteral">"Folder"</font>);
00874   elem.setAttribute(<font class="stringliteral">"caption"</font>, text(0));
00875 
00876   <font class="comment">//append the XML nodes of all child items</font>
00877   CItemBase* i = dynamic_cast&lt;CItemBase*&gt;(firstChild());
00878   <font class="keywordflow">while</font>( i ) {
00879     <font class="keywordflow">if</font> (i-&gt;parent() == <font class="keyword">this</font>) {
00880       QDomElement newElem = i-&gt;saveToXML( doc );
00881       <font class="keywordflow">if</font> (!newElem.isNull()) {
00882         elem.appendChild( newElem ); <font class="comment">//append to this folder</font>
00883       }
00884     }
00885     i = dynamic_cast&lt;CItemBase*&gt;( i-&gt;nextSibling() );
00886   }
00887   qWarning(<font class="stringliteral">"finished"</font>);
00888   <font class="keywordflow">return</font> elem;
00889 }
00890 
00892 <font class="keywordtype">void</font> CBookmarkFolder::SubFolder::loadFromXML( QDomElement&amp; elem ) {
00893   <font class="comment">//get the caption and restore all child items!</font>
00894   <font class="keywordflow">if</font> (elem.hasAttribute(<font class="stringliteral">"caption"</font>))
00895     setText(0, elem.attribute(<font class="stringliteral">"caption"</font>));
00896 
00897   <font class="comment">//restore all child items</font>
00898   QDomElement child = elem.firstChild().toElement();
00899   CItemBase* oldItem = 0;
00900   <font class="keywordflow">while</font> ( !child.isNull() &amp;&amp; child.parentNode() == elem ) {
00901     CItemBase* i = 0;
00902     <font class="keywordflow">if</font> (child.tagName() == <font class="stringliteral">"Folder"</font>) {
00903       i = <font class="keyword">new</font> CBookmarkFolder::SubFolder(<font class="keyword">this</font>, child);
00904     }
00905     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (child.tagName() == <font class="stringliteral">"Bookmark"</font>) {
00906       i = <font class="keyword">new</font> CBookmarkItem(<font class="keyword">this</font>, child);
00907     }
00908     i-&gt;init();
00909     <font class="keywordflow">if</font> (oldItem)
00910       i-&gt;moveAfter(oldItem);
00911     oldItem = i;
00912 
00913     child = child.nextSibling().toElement();
00914   }
00915 }
00916 
00917 
00918 <font class="comment">/* --------------------------------------------------*/</font>
00919 <font class="comment">/* ---------- new class: CBookmarkFolder ------------*/</font>
00920 <font class="comment">/* --------------------------------------------------*/</font>
00921 
00922 CBookmarkFolder::CBookmarkFolder(CMainIndex* mainIndex, <font class="keyword">const</font> Type type) : <a class="code" href="class_c_tree_folder.html">CTreeFolder</a>(mainIndex, type, "*") {
00923 }
00924 
00925 CBookmarkFolder::CBookmarkFolder(CFolderBase* parentItem, <font class="keyword">const</font> Type type) : <a class="code" href="class_c_tree_folder.html">CTreeFolder</a>(parentItem, type, "*") {
00926 }
00927 
00928 CBookmarkFolder::~CBookmarkFolder() {
00929     qWarning(<font class="stringliteral">"descructor of CBookmarkFolder"</font>);
00930 
00931 }
00932 
00933 <font class="keywordtype">void</font> CBookmarkFolder::initTree(){
00934   addGroup(OldBookmarkFolder, <font class="stringliteral">"*"</font>);
00935 
00936 
00937   KStandardDirs stdDirs;
00938     <font class="keyword">const</font> QString path = stdDirs.saveLocation(<font class="stringliteral">"data"</font>, <font class="stringliteral">"bibletime/"</font>);    
00939   <font class="keywordflow">if</font> (!path.isEmpty()) {
00940     loadBookmarks(path + <font class="stringliteral">"bookmarks.xml"</font>);
00941   }
00942 }
00943 
00945 <font class="keyword">const</font> <font class="keywordtype">bool</font> CBookmarkFolder::enableAction(<font class="keyword">const</font> MenuAction action){
00946   <font class="keywordflow">if</font> (action == NewFolder || action == ImportBookmarks)
00947     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00948 
00949   <font class="keywordflow">if</font> (action == ExportBookmarks &amp;&amp; childCount())
00950     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00951 
00952   <font class="keywordflow">return</font> <font class="keyword">false</font>;
00953 }
00954 
00955 
00956 <font class="keywordtype">void</font> CBookmarkFolder::exportBookmarks(){
00957 }
00958 
00959 
00960 <font class="keywordtype">void</font> CBookmarkFolder::importBookmarks(){
00961 }
00962 
00963 <font class="keywordtype">bool</font> CBookmarkFolder::acceptDrop(<font class="keyword">const</font> QMimeSource * src)<font class="keyword"> const </font>{
00964   qWarning(<font class="stringliteral">"CBookmarkFolder::acceptDrop(const QMimeSource * src)"</font>);
00965   <font class="keywordflow">if</font> (src-&gt;provides(<font class="stringliteral">"text/"</font>REFERENCE) || src-&gt;provides(<font class="stringliteral">"text/"</font>BOOKMARK)) {
00966     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00967   }
00968   <font class="keywordflow">return</font> <font class="keyword">false</font>;
00969 }
00970 
00971 <font class="keywordtype">void</font> CBookmarkFolder::dropped(QDropEvent * e) {
00972   QString str;
00973   QCString submime;
00974 
00975   <font class="keywordflow">if</font> (acceptDrop(e) &amp;&amp; QTextDrag::decode(e,str,submime=REFERENCE) ) { <font class="comment">//a drag object, we can handle</font>
00976     QString mod;
00977     QString key;
00978     <a class="code" href="class_c_reference_manager.html#d3">CReferenceManager::decodeReference</a>(str,mod,key);
00979 
00980     <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* module = <a class="code" href="class_c_pointers.html#d1">backend</a>()-&gt;<a class="code" href="class_c_sword_backend.html#a11">findModuleByName</a>(mod);
00981     CBookmarkItem* i = <font class="keyword">new</font> CBookmarkItem(<font class="keyword">this</font>, module, key, QString::null);
00982     i-&gt;init();
00983   }
00984   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (acceptDrop(e) &amp;&amp; QTextDrag::decode(e,str,submime=BOOKMARK) ) { <font class="comment">//a drag object, we can handle</font>
00985   }
00986 }
00987 
00989 <font class="keyword">const</font> <font class="keywordtype">bool</font> CBookmarkFolder::saveBookmarks( <font class="keyword">const</font> QString&amp; filename ){
00990   qWarning(<font class="stringliteral">"CBookmarkFolder::saveBookmarks( const QString&amp; filename )"</font>);
00991 
00992     <font class="keywordtype">bool</font> ret = <font class="keyword">false</font>;
00993   QDomDocument doc(<font class="stringliteral">"DOC"</font>);
00994   doc.appendChild( doc.createProcessingInstruction( <font class="stringliteral">"xml"</font>, <font class="stringliteral">"version=\"1.0\" encoding=\"UTF-8\""</font> ) );
00995 
00996   QDomElement content = doc.createElement(<font class="stringliteral">"SwordBookmarks"</font>);
00997   content.setAttribute(<font class="stringliteral">"syntaxVersion"</font>, CURRENT_SYNTAX_VERSION);
00998   doc.appendChild(content);
00999 
01000   <font class="comment">//append the XML nodes of all child items</font>
01001   CItemBase* i = dynamic_cast&lt;CItemBase*&gt;( firstChild() );
01002   <font class="keywordflow">while</font>( i ) {
01003     <font class="keywordflow">if</font> (i-&gt;parent() == <font class="keyword">this</font>) { <font class="comment">//only one level under this</font>
01004       QDomElement newElem = i-&gt;saveToXML( doc );
01005       <font class="keywordflow">if</font> (!newElem.isNull()) {
01006         content.appendChild( newElem ); <font class="comment">//append to this folder</font>
01007       }
01008     }
01009     i = dynamic_cast&lt;CItemBase*&gt;( i-&gt;nextSibling() );
01010   }
01011     
01012   QFile file(filename);
01013     <font class="keywordflow">if</font> ( file.open(IO_WriteOnly) ) {
01014         ret = <font class="keyword">true</font>;
01015         QTextStream t( &amp;file );
01016         t.setEncoding(QTextStream::UnicodeUTF8);
01017         t &lt;&lt; doc.toString();
01018         file.close();
01019     }
01020     <font class="keywordflow">else</font>
01021         ret = <font class="keyword">false</font>;
01022     <font class="keywordflow">return</font> ret;
01023 }
01024 
01026 <font class="keyword">const</font> <font class="keywordtype">bool</font> CBookmarkFolder::loadBookmarks( <font class="keyword">const</font> QString&amp; filename ){
01027     QFile file(filename);   
01028     <font class="keywordflow">if</font> (!file.exists())
01029         <font class="keywordflow">return</font> <font class="keyword">false</font>;
01030     
01031     QDomDocument doc;   
01032     <font class="keywordflow">if</font> (file.open(IO_ReadOnly)) {       
01033         QTextStream t( &amp;file );
01034         t.setEncoding(QTextStream::UnicodeUTF8);
01035         doc.setContent(t.read());
01036         file.close();   
01037     }
01038 
01039   QDomElement document = doc.documentElement();
01040   <font class="keywordflow">if</font>( document.tagName() != <font class="stringliteral">"SwordBookmarks"</font> ) {
01041         <font class="keywordflow">return</font> <font class="keyword">false</font>;
01042     }
01043 
01044   CItemBase* oldItem = 0;
01045   <font class="comment">//restore all child items</font>
01046   QDomElement child = document.firstChild().toElement();
01047   <font class="keywordflow">while</font> ( !child.isNull() &amp;&amp; child.parentNode() == document) {
01048     CItemBase* i = 0;
01049     <font class="keywordflow">if</font> (child.tagName() == <font class="stringliteral">"Folder"</font>) {
01050       i = <font class="keyword">new</font> CBookmarkFolder::SubFolder(<font class="keyword">this</font>, child);
01051     }
01052     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (child.tagName() == <font class="stringliteral">"Bookmark"</font>) {
01053       i = <font class="keyword">new</font> CBookmarkItem(<font class="keyword">this</font>, child);
01054     }
01055     i-&gt;init();
01056     <font class="keywordflow">if</font> (oldItem)
01057       i-&gt;moveAfter(oldItem);
01058     oldItem = i;
01059 
01060     child = child.nextSibling().toElement();
01061   }
01062 }
</pre></div><hr><address align="right"><small>Generated on Tue Jul 16 13:53:08 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
