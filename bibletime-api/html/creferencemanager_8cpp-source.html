<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>creferencemanager.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>creferencemanager.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                          creferencemanager.cpp  -  description</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : Sun Aug 19 2001</font>
00005 <font class="comment">    copyright            : (C) 2001 by The BibleTime team</font>
00006 <font class="comment">    email                : info@bibletime.de</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> *                                                                         *</font>
00011 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00012 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00013 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00014 <font class="comment"> *   (at your option) any later version.                                   *</font>
00015 <font class="comment"> *                                                                         *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include "creferencemanager.h"</font>
00019 <font class="preprocessor">#include "cswordversekey.h"</font>
00020 
00021 <font class="preprocessor">#include "../frontend/cbtconfig.h"</font>
00022 
<a name="l00024"></a><a class="code" href="class_c_reference_manager.html#d1">00024</a> <font class="keyword">const</font> QString <a class="code" href="class_c_reference_manager.html#d1">CReferenceManager::encodeHyperlink</a>( <font class="keyword">const</font> QString&amp; module, <font class="keyword">const</font> QString&amp; key, <font class="keyword">const</font> CReferenceManager::Type&amp; type){
00025     QString ret = QString::null;
00026     <font class="keywordflow">switch</font> (type) {
00027         <font class="keywordflow">case</font> Bible:             
00028             ret = QString::fromLatin1(<font class="stringliteral">"sword://Bible/"</font>);
00029             <font class="keywordflow">break</font>;
00030         <font class="keywordflow">case</font> Commentary:
00031             ret = QString::fromLatin1(<font class="stringliteral">"sword://Commentary/"</font>);
00032             <font class="keywordflow">break</font>;
00033         <font class="keywordflow">case</font> Lexicon:
00034             ret = QString::fromLatin1(<font class="stringliteral">"sword://Lexicon/"</font>);
00035             <font class="keywordflow">break</font>;
00036         <font class="keywordflow">case</font> GenericBook:
00037             ret = QString::fromLatin1(<font class="stringliteral">"sword://Book/"</font>);
00038             <font class="keywordflow">break</font>;          
00039         <font class="keywordflow">case</font> MorphHebrew:               
00040             ret = QString::fromLatin1(<font class="stringliteral">"morph://Hebrew/"</font>);       
00041             <font class="keywordflow">break</font>;
00042         <font class="keywordflow">case</font> MorphGreek:
00043             ret = QString::fromLatin1(<font class="stringliteral">"morph://Greek/"</font>);                
00044             <font class="keywordflow">break</font>;
00045         <font class="keywordflow">case</font> StrongsHebrew:             
00046             ret = QString::fromLatin1(<font class="stringliteral">"strongs://Hebrew/"</font>);             
00047             <font class="keywordflow">break</font>;
00048         <font class="keywordflow">case</font> StrongsGreek:              
00049             ret = QString::fromLatin1(<font class="stringliteral">"strongs://Greek/"</font>);                  
00050             <font class="keywordflow">break</font>;
00051         <font class="keywordflow">default</font>:
00052             <font class="keywordflow">break</font>;
00053     }
00054 
00055     <font class="keywordflow">if</font> (!module.isEmpty())
00056         ret += module + QString::fromLatin1(<font class="stringliteral">"/"</font>);
00057     <font class="keywordflow">else</font> { <font class="comment">//if module is empty use fallback module</font>
00058         ret += <a class="code" href="class_c_reference_manager.html#d5">preferredModule</a>(type) + QString::fromLatin1(<font class="stringliteral">"/"</font>);
00059     }   
00060     
00061     <font class="keyword">const</font> QString s = (!key.isEmpty() ? key : QString::null);
00062     QString newKey = QString::null;
00063   <font class="comment">//replace all / of the key (e.g. of a CSwordTreeKey) with</font>
00064   <font class="comment">// the escape sequence \/ so we know it's a link divider!</font>
00065 <font class="preprocessor">#warning "Needs optimization"</font>
00066 <font class="preprocessor"></font>    <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; s.length(); ++i) {
00067         <font class="keywordflow">if</font> (s[i] == <font class="charliteral">'/'</font>)
00068             newKey += <font class="stringliteral">"\\/"</font>;
00069         <font class="keywordflow">else</font>
00070             newKey += s[i];
00071     }
00072             
00073     ret += newKey;
00074 <font class="comment">//  qWarning("hyperlink is %s", ret.latin1());</font>
00075     <font class="keywordflow">return</font> ret;
00076 }
00077 
<a name="l00079"></a><a class="code" href="class_c_reference_manager.html#d0">00079</a> <font class="keyword">const</font> <font class="keywordtype">bool</font> <a class="code" href="class_c_reference_manager.html#d0">CReferenceManager::decodeHyperlink</a>( <font class="keyword">const</font> QString&amp; hyperlink, QString&amp; module, QString&amp; key, CReferenceManager::Type&amp; type ){
00083   module = QString::null;
00084   key = QString::null;
00085     
00086     type = Unknown; <font class="comment">//not yet known</font>
00087     QString ref = hyperlink;
00088     <font class="comment">//remove the trailing slash</font>
00089     <font class="keywordflow">if</font> (ref.right(1)==<font class="stringliteral">"/"</font>)
00090         ref = ref.left(ref.length()-1);
00091     
00092     <font class="comment">//find out which type we have by looking at the beginning (protocoll section of URL)</font>
00093     <font class="keywordflow">if</font> (ref.left(8) == <font class="stringliteral">"sword://"</font>) { <font class="comment">//Bible, Commentary or Lexicon</font>
00094         ref = ref.mid(8);
00095         <font class="keywordflow">if</font> (ref.left(5) == <font class="stringliteral">"Bible"</font>) { <font class="comment">//a bible hyperlink</font>
00096             type = CReferenceManager::Bible;            
00097             ref = ref.mid(6); <font class="comment">//inclusive trailing slash</font>
00098         }
00099         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ref.left(10) == <font class="stringliteral">"Commentary"</font>) { <font class="comment">// a Commentary hyperlink</font>
00100             type = CReferenceManager::Commentary;           
00101             ref = ref.mid(11); <font class="comment">//inclusive trailing slash</font>
00102         }
00103         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ref.left(7) == <font class="stringliteral">"Lexicon"</font>) { <font class="comment">// a Lexicon hyperlink</font>
00104             type = CReferenceManager::Lexicon;
00105             ref = ref.mid(8); <font class="comment">//inclusive trailing slash</font>
00106         }
00107         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ref.left(4) == <font class="stringliteral">"Book"</font>) { <font class="comment">// a Book hyperlink</font>
00108             type = CReferenceManager::GenericBook;
00109             ref = ref.mid(5); <font class="comment">//inclusive trailing slash</font>
00110         }       
00111         <font class="comment">// string up to next slash is the modulename</font>
00112 <font class="preprocessor">#warning "Needs optimization!!"</font>
00113 <font class="preprocessor"></font>        <font class="keywordflow">while</font> (true) {
00114             <font class="keyword">const</font> <font class="keywordtype">int</font> pos = ref.find(<font class="stringliteral">"/"</font>);
00115             <font class="keywordflow">if</font> (pos&gt;0 &amp;&amp; ref.at(pos-1) != <font class="charliteral">'\\'</font>) { <font class="comment">//found a slash which is not escaped</font>
00116                 module = ref.mid(0,pos);
00117                 ref = ref.mid(pos+1);           
00118                 <font class="keywordflow">break</font>;
00119             }
00120         }
00121         <font class="comment">// the rest is the key</font>
00122         key = ref;
00123         <font class="comment">//replace \/ escapes with /</font>
00124         key.replace(QRegExp(<font class="stringliteral">"\\\\/"</font>), <font class="stringliteral">"/"</font>);
00125     }
00126     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ref.left(8) == <font class="stringliteral">"morph://"</font> || ref.left(10) == <font class="stringliteral">"strongs://"</font>) { <font class="comment">//strongs or morph URL have the same format</font>
00127         <font class="keyword">enum</font> PreType {IsMorph, IsStrongs};
00128         PreType preType;
00129         <font class="keywordflow">if</font> (ref.left(8) == <font class="stringliteral">"morph://"</font>) { <font class="comment">//morph code hyperlink</font>
00130             ref = ref.mid(8);
00131             preType = IsMorph;
00132         }
00133         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ref.left(10) == <font class="stringliteral">"strongs://"</font>) {
00134             ref = ref.mid(10);      
00135             preType = IsStrongs;            
00136         }
00137         <font class="comment">//part up to next slash is the language</font>
00138         <font class="comment">//qWarning("string before testament: %s", ref.latin1());</font>
00139         <font class="keyword">const</font> <font class="keywordtype">int</font> pos = ref.find(<font class="stringliteral">"/"</font>);
00140         <font class="keywordflow">if</font> (pos&gt;0) { <font class="comment">//found</font>
00141             <font class="keyword">const</font> QString language = ref.mid(0,pos);
00142             <font class="keywordflow">if</font> (language == <font class="stringliteral">"Hebrew"</font>) {
00143                 <font class="keywordflow">switch</font> (preType) {
00144                     <font class="keywordflow">case</font> IsMorph:
00145                         type = CReferenceManager::MorphHebrew;
00146                         <font class="keywordflow">break</font>;
00147                     <font class="keywordflow">case</font> IsStrongs:
00148                         type = CReferenceManager::StrongsHebrew;
00149                         <font class="keywordflow">break</font>;                              
00150                 }           
00151             }
00152             <font class="keywordflow">else</font> <font class="keywordflow">if</font> (language == <font class="stringliteral">"Greek"</font>) {
00153                 <font class="keywordflow">switch</font> (preType) {
00154                     <font class="keywordflow">case</font> IsMorph:
00155                         type = CReferenceManager::MorphGreek;
00156                         <font class="keywordflow">break</font>;
00157                     <font class="keywordflow">case</font> IsStrongs:
00158                         type = CReferenceManager::StrongsGreek;
00159                         <font class="keywordflow">break</font>;                              
00160                 }
00161             }
00162             ref = ref.mid(pos+1);
00163             key = ref; <font class="comment">//the remaining part is the key</font>
00164             
00165             module = <a class="code" href="class_c_reference_manager.html#d5">preferredModule</a>(type);
00166         }
00167     }
00168 
00169   <font class="keywordflow">if</font> (key.isEmpty() &amp;&amp; module.isEmpty())
00170     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00171     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00172 }
00173 
<a name="l00174"></a><a class="code" href="class_c_reference_manager.html#d2">00174</a> <font class="keyword">const</font> QString <a class="code" href="class_c_reference_manager.html#d2">CReferenceManager::encodeReference</a>(<font class="keyword">const</font> QString &amp;module, <font class="keyword">const</font> QString &amp;reference){
00175     <font class="keywordflow">return</font> QString::fromLatin1(<font class="stringliteral">"(%1)%2"</font>).arg(module).arg(reference);
00176 }
00177 
<a name="l00178"></a><a class="code" href="class_c_reference_manager.html#d3">00178</a> <font class="keywordtype">void</font> <a class="code" href="class_c_reference_manager.html#d3">CReferenceManager::decodeReference</a>(QString &amp;dragreference, QString &amp;module, QString &amp;reference){
00179   <font class="keyword">const</font> <font class="keywordtype">int</font> pos = dragreference.find(<font class="stringliteral">")"</font>);
00180     <font class="keyword">const</font> QString fallbackModule = dragreference.mid( 1, pos - 1);
00181   dragreference = dragreference.mid(pos+1);
00182 
00183   module = fallbackModule;
00184   reference = dragreference;
00185 }
00186 
<a name="l00188"></a><a class="code" href="class_c_reference_manager.html#d4">00188</a> <font class="keyword">const</font> <font class="keywordtype">bool</font> <a class="code" href="class_c_reference_manager.html#d4">CReferenceManager::isHyperlink</a>( <font class="keyword">const</font> QString&amp; hyperlink ){
00189     <font class="keywordflow">return</font> (    hyperlink.left(8)  == <font class="stringliteral">"sword://"</font>)
00190                     || (hyperlink.left(10) == <font class="stringliteral">"strongs://"</font>)
00191                     || (hyperlink.left(8)  == <font class="stringliteral">"morph://"</font>);
00192 }
00193 
<a name="l00195"></a><a class="code" href="class_c_reference_manager.html#d5">00195</a> <font class="keyword">const</font> QString <a class="code" href="class_c_reference_manager.html#d5">CReferenceManager::preferredModule</a>( <font class="keyword">const</font> CReferenceManager::Type type ){
00196     QString description = QString::null;
00197     <font class="keywordflow">switch</font> (type) {
00198         <font class="keywordflow">case</font> CReferenceManager::Bible:
00199             description = CBTConfig::get( CBTConfig::standardBible );
00200             <font class="keywordflow">break</font>;
00201         <font class="keywordflow">case</font> CReferenceManager::Commentary:
00202             description = CBTConfig::get( CBTConfig::standardCommentary );
00203             <font class="keywordflow">break</font>;          
00204         <font class="keywordflow">case</font> CReferenceManager::Lexicon:
00205             description = CBTConfig::get( CBTConfig::standardLexicon );
00206             <font class="keywordflow">break</font>;          
00207         <font class="keywordflow">case</font> CReferenceManager::StrongsHebrew:
00208             description = CBTConfig::get( CBTConfig::standardHebrewStrongsLexicon );
00209             <font class="keywordflow">break</font>;          
00210         <font class="keywordflow">case</font> CReferenceManager::StrongsGreek:
00211             description = CBTConfig::get( CBTConfig::standardGreekStrongsLexicon );
00212             <font class="keywordflow">break</font>;          
00213         <font class="keywordflow">case</font> CReferenceManager::MorphHebrew:
00214             description = CBTConfig::get( CBTConfig::standardHebrewMorphLexicon );
00215             <font class="keywordflow">break</font>;          
00216         <font class="keywordflow">case</font> CReferenceManager::MorphGreek:
00217             description = CBTConfig::get( CBTConfig::standardGreekMorphLexicon );
00218             <font class="keywordflow">break</font>;          
00219         <font class="keywordflow">default</font>:
00220             qWarning(<font class="stringliteral">"unknwon type"</font>);
00221             description = QString::null;
00222             <font class="keywordflow">break</font>;          
00223     }
00224     <font class="keywordflow">if</font> (!description.isEmpty())
00225         <font class="keywordflow">return</font> <a class="code" href="class_c_sword_backend.html#d0">CSwordBackend::findModuleNameByDescription</a>(description);
00226     <font class="keywordflow">else</font>
00227         <font class="keywordflow">return</font> QString::null;
00228 }
00229 
<a name="l00231"></a><a class="code" href="class_c_reference_manager.html#d6">00231</a> CReferenceManager::Type <a class="code" href="class_c_reference_manager.html#d6">CReferenceManager::typeFromModule</a>( <font class="keyword">const</font> CSwordModuleInfo::ModuleType type){
00232     <font class="keywordflow">switch</font> (type) {
00233         <font class="keywordflow">case</font> CSwordModuleInfo::Bible:
00234             <font class="keywordflow">return</font> CReferenceManager::Bible;
00235         <font class="keywordflow">case</font> CSwordModuleInfo::Commentary:
00236             <font class="keywordflow">return</font> CReferenceManager::Commentary;
00237         <font class="keywordflow">case</font> CSwordModuleInfo::Lexicon:
00238             <font class="keywordflow">return</font> CReferenceManager::Lexicon;
00239         <font class="keywordflow">default</font>:
00240             <font class="keywordflow">return</font> CReferenceManager::Unknown;
00241     }
00242 }
00243 
<a name="l00245"></a><a class="code" href="class_c_reference_manager.html#d7">00245</a> <font class="keyword">const</font> QString <a class="code" href="class_c_reference_manager.html#d7">CReferenceManager::parseVerseReference</a>( <font class="keyword">const</font> QString ref, <font class="keyword">const</font> QString&amp; lang, <font class="keyword">const</font> QString&amp; newLang){
00246     <a class="code" href="class_c_sword_verse_key.html">CSwordVerseKey</a> key(0);
00247     <font class="keywordflow">if</font> (!lang.isEmpty())
00248         key.setLocale( lang.latin1() );
00249     
00250     key.<a class="code" href="class_c_sword_verse_key.html#a5">key</a>(ref);
00251     
00252     <font class="keywordflow">if</font> (!lang.isEmpty() &amp;&amp; lang != newLang)
00253         key.setLocale(newLang.latin1());
00254     <font class="keywordflow">return</font> key.<a class="code" href="class_c_sword_verse_key.html#a5">key</a>();
00255 }
</pre></div><hr><address><small>Generated on Sun Mar 10 22:12:46 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
