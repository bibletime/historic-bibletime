<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>creferencemanager.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>creferencemanager.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                          creferencemanager.cpp  -  description</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : Sun Aug 19 2001</font>
00005 <font class="comment">    copyright            : (C) 2001 by The BibleTime team</font>
00006 <font class="comment">    email                : info@bibletime.de</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> *                                                                         *</font>
00011 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00012 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00013 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00014 <font class="comment"> *   (at your option) any later version.                                   *</font>
00015 <font class="comment"> *                                                                         *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include "creferencemanager.h"</font>
00019 <font class="preprocessor">#include "cswordversekey.h"</font>
00020 
00021 <font class="preprocessor">#include "../frontend/cbtconfig.h"</font>
00022 
00023 <font class="comment">//QT includes</font>
00024 <font class="preprocessor">#include &lt;qregexp.h&gt;</font>
00025 
<a name="l00027"></a><a class="code" href="class_c_reference_manager.html#d1">00027</a> <font class="keyword">const</font> QString <a class="code" href="class_c_reference_manager.html#d1">CReferenceManager::encodeHyperlink</a>( <font class="keyword">const</font> QString&amp; module, <font class="keyword">const</font> QString&amp; key, <font class="keyword">const</font> CReferenceManager::Type&amp; type){
00028     QString ret = QString::null;
00029     <font class="keywordflow">switch</font> (type) {
00030         <font class="keywordflow">case</font> Bible:             
00031             ret = QString::fromLatin1(<font class="stringliteral">"sword://Bible/"</font>);
00032             <font class="keywordflow">break</font>;
00033         <font class="keywordflow">case</font> Commentary:
00034             ret = QString::fromLatin1(<font class="stringliteral">"sword://Commentary/"</font>);
00035             <font class="keywordflow">break</font>;
00036         <font class="keywordflow">case</font> Lexicon:
00037             ret = QString::fromLatin1(<font class="stringliteral">"sword://Lexicon/"</font>);
00038             <font class="keywordflow">break</font>;
00039         <font class="keywordflow">case</font> GenericBook:
00040             ret = QString::fromLatin1(<font class="stringliteral">"sword://Book/"</font>);
00041             <font class="keywordflow">break</font>;          
00042         <font class="keywordflow">case</font> MorphHebrew:               
00043             ret = QString::fromLatin1(<font class="stringliteral">"morph://Hebrew/"</font>);       
00044             <font class="keywordflow">break</font>;
00045         <font class="keywordflow">case</font> MorphGreek:
00046             ret = QString::fromLatin1(<font class="stringliteral">"morph://Greek/"</font>);                
00047             <font class="keywordflow">break</font>;
00048         <font class="keywordflow">case</font> StrongsHebrew:             
00049             ret = QString::fromLatin1(<font class="stringliteral">"strongs://Hebrew/"</font>);             
00050             <font class="keywordflow">break</font>;
00051         <font class="keywordflow">case</font> StrongsGreek:              
00052             ret = QString::fromLatin1(<font class="stringliteral">"strongs://Greek/"</font>);                  
00053             <font class="keywordflow">break</font>;
00054         <font class="keywordflow">default</font>:
00055             <font class="keywordflow">break</font>;
00056     }
00057 
00058     <font class="keywordflow">if</font> (!module.isEmpty())
00059         ret += module + QString::fromLatin1(<font class="stringliteral">"/"</font>);
00060     <font class="keywordflow">else</font> { <font class="comment">//if module is empty use fallback module</font>
00061         ret += <a class="code" href="class_c_reference_manager.html#d5">preferredModule</a>(type) + QString::fromLatin1(<font class="stringliteral">"/"</font>);
00062     }   
00063     
00064     <font class="keywordflow">if</font> (type == GenericBook) {
00065         <font class="keyword">const</font> QString s = (!key.isEmpty() ? key : QString::null);
00066         QString newKey = QString::null; 
00067       <font class="comment">//replace all / of the key (e.g. of a CSwordTreeKey) with</font>
00068       <font class="comment">// the escape sequence \/ so we know it's a link internal divider (e.g. of CSwordTreeKey)!</font>
00069         <font class="keywordflow">for</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0; i &lt; s.length(); ++i) {
00070             <font class="keywordflow">if</font> (s[i] == <font class="charliteral">'/'</font>)
00071                 newKey += <font class="stringliteral">"\\/"</font>;
00072             <font class="keywordflow">else</font>
00073                 newKey += s[i];
00074         }
00075         ret += newKey;      
00076     }
00077     <font class="keywordflow">else</font> { <font class="comment">//slashes do not appear in verses and dictionary entries</font>
00078         ret += key;
00079     }
00080     <font class="keywordflow">return</font> ret;
00081 }
00082 
<a name="l00084"></a><a class="code" href="class_c_reference_manager.html#d0">00084</a> <font class="keyword">const</font> <font class="keywordtype">bool</font> <a class="code" href="class_c_reference_manager.html#d0">CReferenceManager::decodeHyperlink</a>( <font class="keyword">const</font> QString&amp; hyperlink, QString&amp; module, QString&amp; key, CReferenceManager::Type&amp; type ){
00088   module = QString::null;
00089   key = QString::null;
00090     
00091     type = Unknown; <font class="comment">//not yet known</font>
00092     QString ref = hyperlink;
00093     <font class="comment">//remove the trailing slash</font>
00094     <font class="keywordflow">if</font> (ref.right(1)==<font class="stringliteral">"/"</font> &amp;&amp; ref.right(2) != <font class="stringliteral">"\\/"</font>) <font class="comment">//triling slash, but not escaped</font>
00095         ref = ref.left(ref.length()-1);
00096     
00097     <font class="comment">//find out which type we have by looking at the beginning (protocoll section of URL)</font>
00098     <font class="keywordflow">if</font> (ref.left(8) == <font class="stringliteral">"sword://"</font>) { <font class="comment">//Bible, Commentary or Lexicon</font>
00099         ref = ref.mid(8);
00100         <font class="keywordflow">if</font> (ref.left(5) == <font class="stringliteral">"Bible"</font>) { <font class="comment">//a bible hyperlink</font>
00101             type = CReferenceManager::Bible;            
00102             ref = ref.mid(6); <font class="comment">//inclusive trailing slash</font>
00103         }
00104         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ref.left(10) == <font class="stringliteral">"Commentary"</font>) { <font class="comment">// a Commentary hyperlink</font>
00105             type = CReferenceManager::Commentary;           
00106             ref = ref.mid(11); <font class="comment">//inclusive trailing slash</font>
00107         }
00108         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ref.left(7) == <font class="stringliteral">"Lexicon"</font>) { <font class="comment">// a Lexicon hyperlink</font>
00109             type = CReferenceManager::Lexicon;
00110             ref = ref.mid(8); <font class="comment">//inclusive trailing slash</font>
00111         }
00112         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ref.left(4) == <font class="stringliteral">"Book"</font>) { <font class="comment">// a Book hyperlink</font>
00113             type = CReferenceManager::GenericBook;
00114             ref = ref.mid(5); <font class="comment">//inclusive trailing slash</font>
00115         }       
00116         <font class="comment">// string up to next slash is the modulename</font>
00117         <font class="keywordflow">while</font> (true) {
00118             <font class="keyword">const</font> <font class="keywordtype">int</font> pos = ref.find(<font class="stringliteral">"/"</font>);
00119             <font class="keywordflow">if</font> (pos&gt;0 &amp;&amp; ref.at(pos-1) != <font class="charliteral">'\\'</font>) { <font class="comment">//found a slash which is not escaped</font>
00120                 module = ref.mid(0,pos);
00121                 ref = ref.mid(pos+1);           
00122                 <font class="keywordflow">break</font>;
00123             }
00124         }
00125         <font class="comment">// the rest is the key</font>
00126         key = ref;
00127         <font class="comment">//replace \/ escapes with /</font>
00128         key.replace(QRegExp(<font class="stringliteral">"\\\\/"</font>), <font class="stringliteral">"/"</font>);
00129     }
00130     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ref.left(8) == <font class="stringliteral">"morph://"</font> || ref.left(10) == <font class="stringliteral">"strongs://"</font>) { <font class="comment">//strongs or morph URL have the same format</font>
00131         <font class="keyword">enum</font> PreType {IsMorph, IsStrongs};
00132         PreType preType = IsMorph;
00133         <font class="keywordflow">if</font> (ref.left(8) == <font class="stringliteral">"morph://"</font>) { <font class="comment">//morph code hyperlink</font>
00134             ref = ref.mid(8);
00135             preType = IsMorph;
00136         }
00137         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ref.left(10) == <font class="stringliteral">"strongs://"</font>) {
00138             ref = ref.mid(10);      
00139             preType = IsStrongs;            
00140         }
00141         <font class="comment">//part up to next slash is the language</font>
00142         <font class="keyword">const</font> <font class="keywordtype">int</font> pos = ref.find(<font class="stringliteral">"/"</font>);
00143         <font class="keywordflow">if</font> (pos&gt;0) { <font class="comment">//found</font>
00144             <font class="keyword">const</font> QString language = ref.mid(0,pos);
00145             <font class="keywordflow">if</font> (language == <font class="stringliteral">"Hebrew"</font>) {
00146                 <font class="keywordflow">switch</font> (preType) {
00147                     <font class="keywordflow">case</font> IsMorph:
00148                         type = CReferenceManager::MorphHebrew;
00149                         <font class="keywordflow">break</font>;
00150                     <font class="keywordflow">case</font> IsStrongs:
00151                         type = CReferenceManager::StrongsHebrew;
00152                         <font class="keywordflow">break</font>;                              
00153                 }           
00154             }
00155             <font class="keywordflow">else</font> <font class="keywordflow">if</font> (language == <font class="stringliteral">"Greek"</font>) {
00156                 <font class="keywordflow">switch</font> (preType) {
00157                     <font class="keywordflow">case</font> IsMorph:
00158                         type = CReferenceManager::MorphGreek;
00159                         <font class="keywordflow">break</font>;
00160                     <font class="keywordflow">case</font> IsStrongs:
00161                         type = CReferenceManager::StrongsGreek;
00162                         <font class="keywordflow">break</font>;                              
00163                 }
00164             }
00165             ref = ref.mid(pos+1);
00166             key = ref; <font class="comment">//the remaining part is the key</font>
00167             
00168             module = <a class="code" href="class_c_reference_manager.html#d5">preferredModule</a>(type);
00169         }
00170     }
00171 
00172   <font class="keywordflow">if</font> (key.isEmpty() &amp;&amp; module.isEmpty())
00173     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00174     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00175 }
00176 
<a name="l00177"></a><a class="code" href="class_c_reference_manager.html#d2">00177</a> <font class="keyword">const</font> QString <a class="code" href="class_c_reference_manager.html#d2">CReferenceManager::encodeReference</a>(<font class="keyword">const</font> QString &amp;module, <font class="keyword">const</font> QString &amp;reference){
00178     <font class="keywordflow">return</font> QString::fromLatin1(<font class="stringliteral">"(%1)%2"</font>).arg(module).arg(reference);
00179 }
00180 
<a name="l00181"></a><a class="code" href="class_c_reference_manager.html#d3">00181</a> <font class="keywordtype">void</font> <a class="code" href="class_c_reference_manager.html#d3">CReferenceManager::decodeReference</a>(QString &amp;dragreference, QString &amp;module, QString &amp;reference){
00182   <font class="keyword">const</font> <font class="keywordtype">int</font> pos = dragreference.find(<font class="stringliteral">")"</font>);
00183     <font class="keyword">const</font> QString fallbackModule = dragreference.mid( 1, pos - 1);
00184   dragreference = dragreference.mid(pos+1);
00185 
00186   module = fallbackModule;
00187   reference = dragreference;
00188 }
00189 
<a name="l00191"></a><a class="code" href="class_c_reference_manager.html#d4">00191</a> <font class="keyword">const</font> <font class="keywordtype">bool</font> <a class="code" href="class_c_reference_manager.html#d4">CReferenceManager::isHyperlink</a>( <font class="keyword">const</font> QString&amp; hyperlink ){
00192     <font class="keywordflow">return</font> (    hyperlink.left(8)  == <font class="stringliteral">"sword://"</font>)
00193                     || (hyperlink.left(10) == <font class="stringliteral">"strongs://"</font>)
00194                     || (hyperlink.left(8)  == <font class="stringliteral">"morph://"</font>);
00195 }
00196 
<a name="l00198"></a><a class="code" href="class_c_reference_manager.html#d5">00198</a> <font class="keyword">const</font> QString <a class="code" href="class_c_reference_manager.html#d5">CReferenceManager::preferredModule</a>( <font class="keyword">const</font> CReferenceManager::Type type ){
00199     QString description = QString::null;
00200     <font class="keywordflow">switch</font> (type) {
00201         <font class="keywordflow">case</font> CReferenceManager::Bible:
00202             description = CBTConfig::get( CBTConfig::standardBible );
00203             <font class="keywordflow">break</font>;
00204         <font class="keywordflow">case</font> CReferenceManager::Commentary:
00205             description = CBTConfig::get( CBTConfig::standardCommentary );
00206             <font class="keywordflow">break</font>;          
00207         <font class="keywordflow">case</font> CReferenceManager::Lexicon:
00208             description = CBTConfig::get( CBTConfig::standardLexicon );
00209             <font class="keywordflow">break</font>;          
00210         <font class="keywordflow">case</font> CReferenceManager::StrongsHebrew:
00211             description = CBTConfig::get( CBTConfig::standardHebrewStrongsLexicon );
00212             <font class="keywordflow">break</font>;          
00213         <font class="keywordflow">case</font> CReferenceManager::StrongsGreek:
00214             description = CBTConfig::get( CBTConfig::standardGreekStrongsLexicon );
00215             <font class="keywordflow">break</font>;          
00216         <font class="keywordflow">case</font> CReferenceManager::MorphHebrew:
00217             description = CBTConfig::get( CBTConfig::standardHebrewMorphLexicon );
00218             <font class="keywordflow">break</font>;          
00219         <font class="keywordflow">case</font> CReferenceManager::MorphGreek:
00220             description = CBTConfig::get( CBTConfig::standardGreekMorphLexicon );
00221             <font class="keywordflow">break</font>;          
00222         <font class="keywordflow">default</font>:
00223             qWarning(<font class="stringliteral">"unknwon type"</font>);
00224             description = QString::null;
00225             <font class="keywordflow">break</font>;          
00226     }
00227     <font class="keywordflow">if</font> (!description.isEmpty())
00228         <font class="keywordflow">return</font> <a class="code" href="class_c_sword_backend.html#d0">CSwordBackend::findModuleNameByDescription</a>(description);
00229     <font class="keywordflow">else</font>
00230         <font class="keywordflow">return</font> QString::null;
00231 }
00232 
<a name="l00234"></a><a class="code" href="class_c_reference_manager.html#d6">00234</a> CReferenceManager::Type <a class="code" href="class_c_reference_manager.html#d6">CReferenceManager::typeFromModule</a>( <font class="keyword">const</font> CSwordModuleInfo::ModuleType type){
00235     <font class="keywordflow">switch</font> (type) {
00236         <font class="keywordflow">case</font> CSwordModuleInfo::Bible:
00237             <font class="keywordflow">return</font> CReferenceManager::Bible;
00238         <font class="keywordflow">case</font> CSwordModuleInfo::Commentary:
00239             <font class="keywordflow">return</font> CReferenceManager::Commentary;
00240         <font class="keywordflow">case</font> CSwordModuleInfo::Lexicon:
00241             <font class="keywordflow">return</font> CReferenceManager::Lexicon;
00242     <font class="keywordflow">case</font> CSwordModuleInfo::GenericBook:
00243       <font class="keywordflow">return</font> CReferenceManager::GenericBook;
00244         <font class="keywordflow">default</font>:
00245             <font class="keywordflow">return</font> CReferenceManager::Unknown;
00246     }
00247 }
00248 
<a name="l00250"></a><a class="code" href="class_c_reference_manager.html#d7">00250</a> <font class="keyword">const</font> QString <a class="code" href="class_c_reference_manager.html#d7">CReferenceManager::parseVerseReference</a>( <font class="keyword">const</font> QString ref, <font class="keyword">const</font> QString&amp; lang, <font class="keyword">const</font> QString&amp; newLang){
00251     <a class="code" href="class_c_sword_verse_key.html">CSwordVerseKey</a> key(0);
00252     <font class="keywordflow">if</font> (!lang.isEmpty())
00253         key.setLocale( lang.latin1() );
00254     
00255     key.<a class="code" href="class_c_sword_verse_key.html#a4">key</a>(ref);
00256     
00257     <font class="keywordflow">if</font> (!lang.isEmpty() &amp;&amp; lang != newLang)
00258         key.setLocale(newLang.latin1());
00259     <font class="keywordflow">return</font> key.<a class="code" href="class_c_sword_verse_key.html#a4">key</a>();
00260 }
</pre></div><hr><address align="right"><small>Generated on Tue Jul 16 13:53:09 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
