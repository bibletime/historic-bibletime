<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>csearchdialoganalysis.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>csearchdialoganalysis.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                          csearchdialoganalysis.cpp  -  description</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : Sat Mar 4 2000</font>
00005 <font class="comment">    copyright            : (C) 2000 by The BibleTime Team</font>
00006 <font class="comment">    email                : Info@bibletime.de</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> *                                                                         *</font>
00011 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00012 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00013 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00014 <font class="comment"> *   (at your option) any later version.                                   *</font>
00015 <font class="comment"> *                                                                         *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">//BibleTime includes</font>
00019 <font class="preprocessor">#include "csearchdialoganalysis.h"</font>
00020 <font class="preprocessor">#include "backend/cswordmoduleinfo.h"</font>
00021 <font class="preprocessor">#include "backend/cswordbiblemoduleinfo.h"</font>
00022 <font class="preprocessor">#include "backend/cswordcommentarymoduleinfo.h"</font>
00023 <font class="preprocessor">#include "backend/cswordlexiconmoduleinfo.h"</font>
00024 <font class="preprocessor">#include "backend/cswordversekey.h"</font>
00025 <font class="preprocessor">#include "backend/cswordbackend.h"</font>
00026 <font class="preprocessor">#include "frontend/ctoolclass.h"</font>
00027 <font class="preprocessor">#include "csearchdialog.h"</font>
00028 <font class="preprocessor">#include "whatsthisdef.h"</font>
00029 
00030 <font class="comment">//QT includes</font>
00031 <font class="preprocessor">#include &lt;qpixmap.h&gt;</font>
00032 <font class="preprocessor">#include &lt;qdatetime.h&gt;</font>
00033 <font class="preprocessor">#include &lt;qlist.h&gt;</font>
00034 <font class="preprocessor">#include &lt;qpicture.h&gt;</font>
00035 <font class="preprocessor">#include &lt;qpainter.h&gt;</font>
00036 <font class="preprocessor">#include &lt;qtooltip.h&gt;</font>
00037 <font class="preprocessor">#include &lt;qrect.h&gt;</font>
00038 <font class="preprocessor">#include &lt;qpoint.h&gt;</font>
00039 <font class="preprocessor">#include &lt;qtooltip.h&gt;</font>
00040 <font class="preprocessor">#include &lt;qwhatsthis.h&gt;</font>
00041 <font class="preprocessor">#include &lt;qstring.h&gt;</font>
00042 
00043 <font class="comment">//KDE includes</font>
00044 <font class="preprocessor">#include &lt;kfiledialog.h&gt;</font>
00045 <font class="preprocessor">#include &lt;klocale.h&gt;</font>
00046 <font class="preprocessor">#include &lt;kapplication.h&gt;</font>
00047 
00048 <font class="comment">//Sword includes</font>
00049 <font class="preprocessor">#include &lt;swkey.h&gt;</font>
00050 <font class="preprocessor">#include &lt;swmodule.h&gt;</font>
00051 <font class="preprocessor">#include &lt;versekey.h&gt;</font>
00052 
00053 <font class="comment">//library includes</font>
00054 <font class="preprocessor">#include &lt;iostream.h&gt;</font>
00055 
00056 <font class="comment">//our defines</font>
00057 <font class="preprocessor">#define SPACE_BETWEEN_PARTS 5</font>
00058 <font class="preprocessor"></font><font class="preprocessor">#define RIGHT_BORDER 15</font>
00059 <font class="preprocessor"></font><font class="preprocessor">#define LEFT_BORDER 15</font>
00060 <font class="preprocessor"></font><font class="preprocessor">#define LOWER_BORDER 10</font>
00061 <font class="preprocessor"></font><font class="preprocessor">#define UPPER_BORDER 10</font>
00062 <font class="preprocessor"></font>
00063 <font class="preprocessor">#define ITEM_TEXT_SIZE 8</font>
00064 <font class="preprocessor"></font><font class="preprocessor">#define LABEL_TEXT_SIZE 6</font>
00065 <font class="preprocessor"></font>
00066 <font class="comment">//used for the shift between the bars</font>
00067 <font class="preprocessor">#define BAR_DELTAX 4</font>
00068 <font class="preprocessor"></font><font class="preprocessor">#define BAR_DELTAY 2</font>
00069 <font class="preprocessor"></font><font class="preprocessor">#define BAR_WIDTH 2+2*BAR_DELTAX  //should be equal or bigger than the label font size</font>
00070 <font class="preprocessor"></font><font class="comment">//used for the text below the bars</font>
00071 <font class="preprocessor">#define BAR_LOWER_BORDER 100</font>
00072 <font class="preprocessor"></font>
00073 <font class="preprocessor">#define LEGEND_INNER_BORDER 5</font>
00074 <font class="preprocessor"></font><font class="preprocessor">#define LEGEND_DELTAY 4</font>
00075 <font class="preprocessor"></font><font class="preprocessor">#define LEGEND_WIDTH 85</font>
00076 <font class="preprocessor"></font>
00077 CSearchDialogAnalysis::CSearchDialogAnalysis(QObject *parent, <font class="keyword">const</font> <font class="keywordtype">char</font> *name )
00078     : QCanvas(parent,name) {
00079 
00080   m_scaleFactor = 0.0;
00081   m_legend = 0;
00082     setBackgroundColor(Qt::white);  
00083     m_canvasItemList.resize(67);
00084     m_canvasItemList.setAutoDelete(<font class="keyword">true</font>);
00085     resize(1,1);
00086     connect(<font class="keyword">this</font>, SIGNAL(resized()), SLOT(slotResized()));
00087 }
00088 
00089 CSearchDialogAnalysis::~CSearchDialogAnalysis(){
00090 <font class="comment">//  qWarning("CSearchDialogAnalysis::~CSearchDialogAnalysis()");</font>
00091   reset(); <font class="comment">// deletes the legend and the items</font>
00092 }
00093 
00094 QDict&lt;CSearchDialogAnalysisItem&gt;* CSearchDialogAnalysis::getSearchAnalysisItemList(){
00095     <font class="comment">// Returns pointer to the search analysis items</font>
00096     <font class="keywordflow">return</font> &amp;m_canvasItemList;
00097 }
00098 
<a name="l00100"></a><a class="code" href="class_c_search_dialog_analysis.html#a3">00100</a> <font class="keywordtype">void</font> <a class="code" href="class_c_search_dialog_analysis.html#a3">CSearchDialogAnalysis::analyse</a>(){
00101     qDebug(<font class="stringliteral">"void CSearchDialogAnalysis::analyse()"</font>);
00110     m_lastPosList.clear();      
00111     <font class="keyword">const</font> <font class="keywordtype">int</font> numberOfModules = m_moduleList.count();
00112     <font class="keywordflow">if</font> (!numberOfModules)
00113         <font class="keywordflow">return</font>; 
00114     m_legend = <font class="keyword">new</font> CSearchDialogAnalysisLegendItem(<font class="keyword">this</font>, &amp;m_moduleList);    
00115     m_legend-&gt;setX(LEFT_BORDER);
00116     m_legend-&gt;setY(UPPER_BORDER);
00117     m_legend-&gt;setSize(LEGEND_WIDTH,
00118                LEGEND_INNER_BORDER*2 + ITEM_TEXT_SIZE*numberOfModules + LEGEND_DELTAY*(numberOfModules-1));
00119   m_legend-&gt;show(); 
00120 
00121   <font class="keywordtype">int</font> xPos = LEFT_BORDER + m_legend-&gt;width() + SPACE_BETWEEN_PARTS;         
00122     <font class="keywordtype">int</font> moduleIndex = 0;    
00123     m_maxCount = 0; 
00124     <font class="keywordtype">int</font> count = 0;
00125     <a class="code" href="class_c_sword_verse_key.html">CSwordVerseKey</a> key(0);  
00126     key.<a class="code" href="class_c_sword_verse_key.html#a4">key</a>(<font class="stringliteral">"Genesis 1:1"</font>); 
00127     
00128     <a class="code" href="class_c_search_dialog_analysis_item.html">CSearchDialogAnalysisItem</a>* analysisItem = m_canvasItemList[key.<a class="code" href="class_c_sword_verse_key.html#a8">book</a>()];
00129     <font class="keywordtype">bool</font> ok = <font class="keyword">true</font>;
00130     <font class="keywordflow">while</font> (ok &amp;&amp; analysisItem) {
00131         <font class="keywordflow">for</font> (moduleIndex = 0,m_moduleList.first(); m_moduleList.current(); m_moduleList.next(),++moduleIndex) {
00132             KApplication::kApplication()-&gt;processEvents(10);
00133             <font class="keywordflow">if</font> (!m_lastPosList.contains(m_moduleList.current()))
00134                 m_lastPosList.insert(m_moduleList.current(),0);
00135             analysisItem-&gt;<a class="code" href="class_c_search_dialog_analysis_item.html#a2">setCountForModule</a>(moduleIndex, (count = <a class="code" href="class_c_search_dialog_analysis.html#c0">getCount</a>(key.<a class="code" href="class_c_sword_verse_key.html#a8">book</a>(),m_moduleList.current())));
00136             m_maxCount = (count &gt; m_maxCount) ? count : m_maxCount;
00137         }
00138         analysisItem-&gt;setX(xPos);
00139         analysisItem-&gt;setY(UPPER_BORDER);
00140         analysisItem-&gt;show();
00141         
00142         xPos += (int)analysisItem-&gt;<a class="code" href="class_c_search_dialog_analysis_item.html#a4">width</a>() + SPACE_BETWEEN_PARTS;
00143         ok = key.<a class="code" href="class_c_sword_verse_key.html#a6">next</a>(CSwordVerseKey::UseBook);     
00144     analysisItem = m_canvasItemList[key.<a class="code" href="class_c_sword_verse_key.html#a8">book</a>()];
00145     }
00146     resize(xPos+BAR_WIDTH+(m_moduleList.count()-1)*BAR_DELTAX+RIGHT_BORDER, height() ); 
00147     <a class="code" href="class_c_search_dialog_analysis.html#h0">slotResized</a>();
00148 }
00149 
<a name="l00151"></a><a class="code" href="class_c_search_dialog_analysis.html#a2">00151</a> <font class="keywordtype">void</font> <a class="code" href="class_c_search_dialog_analysis.html#a2">CSearchDialogAnalysis::setModuleList</a>(ListCSwordModuleInfo&amp; modules){
00152 <font class="comment">//  ASSERT(modules);</font>
00153     m_moduleList.clear();
00154     <font class="keywordflow">for</font> (modules.first(); modules.current(); modules.next())
00155         <font class="keywordflow">if</font> ( modules.current()-&gt;type() == CSwordModuleInfo::Bible || modules.current()-&gt;type() == CSwordModuleInfo::Commentary )<font class="comment">//a Bible or an commentary</font>
00156             m_moduleList.append(modules.current());
00157 
00158     m_canvasItemList.clear();
00159     <a class="code" href="class_c_search_dialog_analysis_item.html">CSearchDialogAnalysisItem</a>* analysisItem = 0;    
00160     <a class="code" href="class_c_sword_verse_key.html">CSwordVerseKey</a> key(0);  
00161     key.<a class="code" href="class_c_sword_verse_key.html#a4">key</a>(<font class="stringliteral">"Genesis 1:1"</font>);
00162     <font class="keywordflow">do</font> {
00163     analysisItem = <font class="keyword">new</font> <a class="code" href="class_c_search_dialog_analysis_item.html">CSearchDialogAnalysisItem</a>(<font class="keyword">this</font>, m_moduleList.count(), key.<a class="code" href="class_c_sword_verse_key.html#a8">book</a>(), &amp;m_scaleFactor, &amp;m_moduleList);
00164     analysisItem-&gt;hide();
00165         m_canvasItemList.insert(key.<a class="code" href="class_c_sword_verse_key.html#a8">book</a>(), analysisItem);
00166     } <font class="keywordflow">while</font> (key.<a class="code" href="class_c_sword_verse_key.html#a6">next</a>(CSwordVerseKey::UseBook));
00167     update();
00168 }
00169 
<a name="l00171"></a><a class="code" href="class_c_search_dialog_analysis.html#a4">00171</a> <font class="keywordtype">void</font> <a class="code" href="class_c_search_dialog_analysis.html#a4">CSearchDialogAnalysis::reset</a>(){
00172     m_scaleFactor = 0.0;
00173   QDictIterator&lt;CSearchDialogAnalysisItem&gt; it( m_canvasItemList ); <font class="comment">// iterator for items</font>
00174     <font class="keywordflow">while</font> ( it.current() ) {
00175         it.current()-&gt;hide();
00176         ++it;
00177     }   
00178     m_lastPosList.clear();  
00179     
00180     <font class="keywordflow">if</font> (m_legend)
00181         m_legend-&gt;hide();
00182     <font class="keyword">delete</font> m_legend;
00183     m_legend = 0;   
00184     update();
00185 }
00186 
<a name="l00188"></a><a class="code" href="class_c_search_dialog_analysis.html#h0">00188</a> <font class="keywordtype">void</font> <a class="code" href="class_c_search_dialog_analysis.html#h0">CSearchDialogAnalysis::slotResized</a>(){
00189     m_scaleFactor = (double)( (double)(height()-UPPER_BORDER-LOWER_BORDER-BAR_LOWER_BORDER-(m_moduleList.count()-1)*BAR_DELTAY)
00190                                         /(double)m_maxCount);   
00191     QDictIterator&lt;CSearchDialogAnalysisItem&gt; it( m_canvasItemList );
00192     <font class="keywordflow">while</font> ( it.current() ) {
00193         it.current()-&gt;setSize(BAR_WIDTH + (m_moduleList.count()-1)*BAR_DELTAX, height()-UPPER_BORDER-LOWER_BORDER);
00194         it.current()-&gt;setY(UPPER_BORDER);
00195     ++it;
00196     }
00197     update();
00198 }
00199 
<a name="l00201"></a><a class="code" href="class_c_search_dialog_analysis.html#d0">00201</a> QColor <a class="code" href="class_c_search_dialog_analysis.html#d0">CSearchDialogAnalysis::getColor</a>(<font class="keywordtype">int</font> index){
00202   <font class="keywordflow">switch</font> (index){
00203     <font class="keywordflow">case</font>  0: <font class="keywordflow">return</font> Qt::red;
00204     <font class="keywordflow">case</font>    1: <font class="keywordflow">return</font> Qt::darkGreen;
00205     <font class="keywordflow">case</font>  2: <font class="keywordflow">return</font> Qt::blue;
00206     <font class="keywordflow">case</font>  3: <font class="keywordflow">return</font> Qt::cyan;
00207     <font class="keywordflow">case</font>  4: <font class="keywordflow">return</font> Qt::magenta;
00208     <font class="keywordflow">case</font>  5: <font class="keywordflow">return</font> Qt::darkRed;
00209     <font class="keywordflow">case</font>  6: <font class="keywordflow">return</font> Qt::darkGray;
00210     <font class="keywordflow">case</font>  7: <font class="keywordflow">return</font> Qt::black;
00211     <font class="keywordflow">case</font>  8: <font class="keywordflow">return</font> Qt::darkCyan;
00212     <font class="keywordflow">case</font>  9: <font class="keywordflow">return</font> Qt::darkMagenta;
00213     <font class="keywordflow">default</font>: <font class="keywordflow">return</font> Qt::red;
00214   }
00215 }
00216 
<a name="l00218"></a><a class="code" href="class_c_search_dialog_analysis.html#c0">00218</a> <font class="keyword">const</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> <a class="code" href="class_c_search_dialog_analysis.html#c0">CSearchDialogAnalysis::getCount</a>( <font class="keyword">const</font> QString book, <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* module ){
00219     ListKey&amp; result = module-&gt;<a class="code" href="class_c_sword_module_info.html#a12">searchResult</a>();
00220     <font class="keyword">const</font> <font class="keywordtype">int</font> length = book.length();   
00221     <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = m_lastPosList[module];
00222     <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> count = 0;
00223     <font class="keyword">const</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> resultCount = result.Count();
00224     <font class="keywordflow">while</font> (i &lt; resultCount) {
00225         <font class="keywordflow">if</font> ( strncmp(book.local8Bit(), (<font class="keyword">const</font> <font class="keywordtype">char</font>*)*result.GetElement(i), length) )        
00226             <font class="keywordflow">break</font>;
00227         i++;
00228         ++count;        
00229     }
00230     m_lastPosList.contains(module) ? m_lastPosList.replace(module,i) : m_lastPosList.insert(module,i);
00231 <font class="comment">//  m_lastPosList.replace(module,i);</font>
00232     <font class="keywordflow">return</font> count;
00233 }
00234 
00235 
00236 <font class="comment">//------------------------------------------------------------------</font>
00237 <font class="comment">//------------------------------------------------------------------</font>
00238 
<a name="l00239"></a><a class="code" href="class_c_search_dialog_analysis_item.html#a0">00239</a> <a class="code" href="class_c_search_dialog_analysis_item.html#a0">CSearchDialogAnalysisItem::CSearchDialogAnalysisItem</a>(QCanvas *parent, <font class="keyword">const</font> <font class="keywordtype">int</font> moduleCount, <font class="keyword">const</font> QString &amp;bookname, <font class="keywordtype">double</font> *scaleFactor, ListCSwordModuleInfo* modules)
00240     : QCanvasRectangle(parent),
00241     m_moduleList( modules ),
00242     m_scaleFactor(scaleFactor),
00243     m_bookName(bookname),
00244     m_moduleCount(moduleCount),     
00245     m_bufferPixmap(0)
00246 {   
00247     m_resultCountArray.resize(m_moduleCount);
00248     <font class="keywordtype">int</font> index = 0;
00249     <font class="keywordflow">for</font> (index = 0; index &lt; m_moduleCount; ++index)
00250         m_resultCountArray[index] = 0;
00251 }
00252 
00253 CSearchDialogAnalysisItem::~CSearchDialogAnalysisItem() {
00254 <font class="comment">//  qWarning("CSearchDialogAnalysisItem::~CSearchDialogAnalysisItem()");</font>
00255 <font class="comment">//  if (m_bufferPixmap)</font>
00256         <font class="keyword">delete</font> m_bufferPixmap;
00257 }
00258 
<a name="l00260"></a><a class="code" href="class_c_search_dialog_analysis_item.html#a2">00260</a> <font class="keywordtype">void</font> <a class="code" href="class_c_search_dialog_analysis_item.html#a2">CSearchDialogAnalysisItem::setCountForModule</a>( <font class="keyword">const</font> <font class="keywordtype">int</font> moduleIndex, <font class="keyword">const</font> <font class="keywordtype">int</font> count) {
00261     m_resultCountArray[moduleIndex] = count;
00262 }
00263 
<a name="l00265"></a><a class="code" href="class_c_search_dialog_analysis_item.html#a3">00265</a> <font class="keywordtype">int</font> <a class="code" href="class_c_search_dialog_analysis_item.html#a3">CSearchDialogAnalysisItem::getCountForModule</a>( <font class="keyword">const</font> <font class="keywordtype">int</font> moduleIndex) {
00266     <font class="keywordflow">return</font> m_resultCountArray[moduleIndex];
00267 }
00268 
<a name="l00270"></a><a class="code" href="class_c_search_dialog_analysis_item.html#c0">00270</a> <font class="keywordtype">void</font> <a class="code" href="class_c_search_dialog_analysis_item.html#c0">CSearchDialogAnalysisItem::draw</a>(QPainter&amp; painter) {
00271     QFont f = painter.font();
00272     f.setPointSize(ITEM_TEXT_SIZE);
00273     painter.setFont(f);
00274     
00275     setPen(QPen(black,1));
00276     setBrush(Qt::red);
00281     <font class="keywordtype">int</font> index = 0;  
00282     <font class="keywordtype">int</font> drawn = 0;
00283     <font class="keywordtype">int</font> Value = 0;
00284     
00285     <font class="comment">//find out the biggest value</font>
00286     <font class="keywordflow">for</font> (index=0;index &lt; m_moduleCount; index++)
00287       <font class="keywordflow">if</font> (m_resultCountArray[index] &gt; Value)
00288         Value = m_resultCountArray[index];
00289     
00290     <font class="keywordflow">while</font> (drawn &lt; m_moduleCount){
00291     <font class="keywordflow">for</font> (index=0; index &lt; m_moduleCount; index++){
00292       <font class="keywordflow">if</font> (m_resultCountArray[index] == Value){
00293             QPoint p1(x()+(m_moduleCount-drawn-1)*BAR_DELTAX,
00294                       height()+y()-BAR_LOWER_BORDER-(m_moduleCount-drawn)*BAR_DELTAY);
00295             QPoint p2(p1.x() + BAR_WIDTH,
00296                       p1.y() - (!m_resultCountArray[index] ? 0 : ((m_resultCountArray[index])*(*m_scaleFactor))) );
00297             QRect r(p1, p2);
00298             painter.fillRect(r, QBrush(<a class="code" href="class_c_search_dialog_analysis.html#d0">CSearchDialogAnalysis::getColor</a>(index)) );
00299             painter.drawRect(r);
00300             drawn++;
00301       }
00302     }
00303     <font class="comment">//finds the next smaller value</font>
00304       <font class="keywordtype">int</font> newValue = 0;
00305         <font class="keywordflow">for</font> (index=0;index &lt; m_moduleCount; index++)
00306       <font class="keywordflow">if</font> (m_resultCountArray[index] &lt; Value &amp;&amp; m_resultCountArray[index] &gt;= newValue)
00307         newValue = m_resultCountArray[index];
00308     Value = newValue;
00309     }       
00310     <font class="keywordflow">if</font> (!m_bufferPixmap) {
00311         m_bufferPixmap = <font class="keyword">new</font> QPixmap();
00312         m_bufferPixmap-&gt;resize(<a class="code" href="class_c_search_dialog_analysis_item.html#a4">width</a>(),BAR_LOWER_BORDER);
00313         m_bufferPixmap-&gt;fill();     
00314         QPainter p(m_bufferPixmap);             
00315         f = p.font();
00316         f.setPointSize(ITEM_TEXT_SIZE);
00317         p.setFont(f);       
00318         p.rotate(90);
00319         p.drawText(QPoint(5,0), m_bookName);
00320     }
00321     painter.drawPixmap(QPoint(x(),height()+y()-BAR_LOWER_BORDER), *m_bufferPixmap);
00322 }
00323 
<a name="l00325"></a><a class="code" href="class_c_search_dialog_analysis_item.html#a4">00325</a> <font class="keywordtype">int</font> <a class="code" href="class_c_search_dialog_analysis_item.html#a4">CSearchDialogAnalysisItem::width</a>(){
00326     <font class="keywordflow">return</font> m_moduleCount*(m_moduleCount&gt;1 ? BAR_DELTAX : 0) + BAR_WIDTH;    
00327 }
00328 
<a name="l00330"></a><a class="code" href="class_c_search_dialog_analysis_item.html#a5">00330</a> <font class="keyword">const</font> QString <a class="code" href="class_c_search_dialog_analysis_item.html#a5">CSearchDialogAnalysisItem::getToolTip</a>(){
00331     QString ret = QString::fromLatin1(<font class="stringliteral">"&lt;CENTER&gt;&lt;B&gt;%1&lt;/B&gt;&lt;/CENTER&gt;&lt;HR&gt;"</font>).arg(m_bookName);
00332     ret.append(<font class="stringliteral">"&lt;TABLE CELLPADDING=\"3\" WIDTH=\"100%\" ALIGN=\"center\"&gt;"</font>);
00333     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; m_moduleCount; ++i) {
00334         <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* info = m_moduleList-&gt;at(i);
00335         <font class="keyword">const</font> QColor c = <a class="code" href="class_c_search_dialog_analysis.html#d0">CSearchDialogAnalysis::getColor</a>(i);
00336         ret.append(
00337             QString::fromLatin1(<font class="stringliteral">"&lt;TR BGCOLOR=\"white\"&gt;&lt;TD&gt;&lt;B&gt;&lt;FONT COLOR=\"#%1\"&gt;%2&lt;/FONT&gt;&lt;/B&gt;&lt;/TD&gt;&lt;TD&gt;%3&lt;/TD&gt;&lt;/TR&gt;"</font>)
00338                 .arg(QString().sprintf(<font class="stringliteral">"%02X%02X%02X"</font>,c.red(),c.green(),c.blue()))
00339                 .arg(info ? info-&gt;<a class="code" href="class_c_sword_module_info.html#o2">name</a>() : QString::null)
00340                 .arg(m_resultCountArray[i])
00341         );
00342     }
00343     ret.append(<font class="stringliteral">"&lt;/TABLE&gt;"</font>);         
00344     <font class="keywordflow">return</font> ret;
00345 }
00346 
00347 <font class="comment">//------------------------------------------------------------------</font>
00348 <font class="comment">//------------------------------------------------------------------</font>
00349 
00350 CSearchDialogAnalysisView::CSearchDialogAnalysisView(QCanvas* canvas, QWidget* parent)
00351     : QCanvasView(canvas, parent) {
00352     QWhatsThis::add(<font class="keyword">this</font>, WT_SD_ANALYSIS_VIEW);
00353     setFocusPolicy(QWidget::WheelFocus);
00354     m_toolTip = <font class="keyword">new</font> ToolTip(<font class="keyword">this</font>);  
00355     resize(sizeHint());
00356 
00357 }
00358 
00360 QSize CSearchDialogAnalysisView::sizeHint(){
00361     <font class="keywordflow">if</font> ( parentWidget() )
00362         <font class="keywordflow">return</font> parentWidget()-&gt;sizeHint();
00363     <font class="keywordflow">return</font> QCanvasView::sizeHint();
00364 }
00365 
00367 <font class="keywordtype">void</font> CSearchDialogAnalysisView::resizeEvent( QResizeEvent* e){
00368     QCanvasView::resizeEvent(e);
00369     canvas()-&gt;resize( canvas()-&gt;<a class="code" href="class_c_search_dialog_analysis_item.html#a4">width</a>(), viewport()-&gt;height() );
00370 }
00371 
00372 CSearchDialogAnalysisView::ToolTip::ToolTip(QWidget* parent) : QToolTip(parent) {
00373 }
00374 
00375 <font class="keywordtype">void</font> CSearchDialogAnalysisView::ToolTip::maybeTip(<font class="keyword">const</font> QPoint&amp; p) {
00376     CSearchDialogAnalysisView* view = dynamic_cast&lt;CSearchDialogAnalysisView*&gt;(parentWidget());
00377     <font class="keywordflow">if</font> (!view)
00378         <font class="keywordflow">return</font>;
00379     QPoint point(p);
00380     point = view-&gt;viewport()-&gt;mapFrom(view, point);
00381     <a class="code" href="class_c_search_dialog_analysis_item.html">CSearchDialogAnalysisItem</a>* i = view-&gt;itemAt( view-&gt;viewportToContents(point) );
00382     <font class="keywordflow">if</font> (!i)
00383         <font class="keywordflow">return</font>;
00384                 
00385     <font class="comment">//get type of item and display correct text</font>
00386     QString text = i-&gt;<a class="code" href="class_c_search_dialog_analysis_item.html#a5">getToolTip</a>();
00387     <font class="keywordflow">if</font> (text.isEmpty())
00388         <font class="keywordflow">return</font>;
00389     
00390     QPoint p1 = view-&gt;viewport()-&gt;mapTo(view, view-&gt;contentsToViewport(i-&gt;rect().topLeft()));
00391     p1.setY(0); 
00392     QPoint p2 = view-&gt;viewport()-&gt;mapTo(view, view-&gt;contentsToViewport(i-&gt;rect().bottomRight()));
00393     p2.setY(view-&gt;height());    
00394     QRect r = QRect( p1, p2 );  
00395     <font class="keywordflow">if</font> (r.contains(p))
00396         tip(r, text);
00397 }
00398 
00399 
00401 <a class="code" href="class_c_search_dialog_analysis_item.html">CSearchDialogAnalysisItem</a>* CSearchDialogAnalysisView::itemAt( <font class="keyword">const</font> QPoint&amp; p ){
00402     QCanvasItemList l = canvas()-&gt;collisions(p);
00403     <font class="keywordflow">if</font> (!l.count())
00404         <font class="keywordflow">return</font> 0;
00405     <font class="keywordflow">return</font> dynamic_cast&lt;CSearchDialogAnalysisItem*&gt;(l.first()); 
00406 }
00407 
00408 <font class="comment">//------------------------------------------------------------------</font>
00409 <font class="comment">//------------------------------------------------------------------</font>
00410 
00411 CSearchDialogAnalysisLegendItem::CSearchDialogAnalysisLegendItem(QCanvas *parent, ListCSwordModuleInfo *list )
00412     : QCanvasRectangle(parent) {
00413     m_moduleList = list;
00414 }
00415 
00417 <font class="keywordtype">void</font> CSearchDialogAnalysisLegendItem::draw (QPainter&amp; painter) {    
00418     painter.save();
00419         
00420     setPen( QPen(black,2) );
00421     setBrush( Qt::white );
00422   <font class="comment">//the outer rectangle</font>
00423   QPoint p1(x(),y());
00424   QPoint p2(x()+<a class="code" href="class_c_search_dialog_analysis_item.html#a4">width</a>(), y()+height());
00425   QRect r(p1, p2);
00426   r.normalize();
00427     painter.drawRect(r);
00428     
00429   QFont f = painter.font();
00430   f.setPointSize(ITEM_TEXT_SIZE);
00431   painter.setFont(f);
00432     
00433     <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> index=0; index &lt; m_moduleList-&gt;count(); index++){
00434       <font class="comment">// the module color indicators</font>
00435       QPoint p1(x()+LEGEND_INNER_BORDER, y() + LEGEND_INNER_BORDER + index*(LEGEND_DELTAY + ITEM_TEXT_SIZE));
00436       QPoint p2( p1.x() + ITEM_TEXT_SIZE, p1.y() + ITEM_TEXT_SIZE);
00437       QRect r(p1,p2);
00438         painter.fillRect(r, QBrush(<a class="code" href="class_c_search_dialog_analysis.html#d0">CSearchDialogAnalysis::getColor</a>(index)) );
00439         r.normalize();
00440         painter.drawRect(r);
00441         
00442         QPoint p3( p2.x() + LEGEND_INNER_BORDER, p2.y() );
00443     painter.drawText(p3, m_moduleList-&gt;at(index)-&gt;name() );
00444     }
00445   painter.restore();
00446 }
</pre></div><hr><address align="right"><small>Generated on Sun May 12 20:27:13 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
