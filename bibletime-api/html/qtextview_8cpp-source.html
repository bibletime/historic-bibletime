<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>qtextview.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>qtextview.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/****************************************************************************</font>
00002 <font class="comment">** $Id$</font>
00003 <font class="comment">**</font>
00004 <font class="comment">** Implementation of the QTextView class</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** Created : 990101</font>
00007 <font class="comment">**</font>
00008 <font class="comment">** Copyright (C) 1992-2000 Trolltech AS.  All rights reserved.</font>
00009 <font class="comment">**</font>
00010 <font class="comment">** This file is part of the widgets module of the Qt GUI Toolkit.</font>
00011 <font class="comment">**</font>
00012 <font class="comment">** This file may be distributed under the terms of the Q Public License</font>
00013 <font class="comment">** as defined by Trolltech AS of Norway and appearing in the file</font>
00014 <font class="comment">** LICENSE.QPL included in the packaging of this file.</font>
00015 <font class="comment">**</font>
00016 <font class="comment">** This file may be distributed and/or modified under the terms of the</font>
00017 <font class="comment">** GNU General Public License version 2 as published by the Free Software</font>
00018 <font class="comment">** Foundation and appearing in the file LICENSE.GPL included in the</font>
00019 <font class="comment">** packaging of this file.</font>
00020 <font class="comment">**</font>
00021 <font class="comment">** Licensees holding valid Qt Enterprise Edition or Qt Professional Edition</font>
00022 <font class="comment">** licenses may use this file in accordance with the Qt Commercial License</font>
00023 <font class="comment">** Agreement provided with the Software.</font>
00024 <font class="comment">**</font>
00025 <font class="comment">** This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE</font>
00026 <font class="comment">** WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</font>
00027 <font class="comment">**</font>
00028 <font class="comment">** See http://www.trolltech.com/pricing.html or email sales@trolltech.com for</font>
00029 <font class="comment">**   information about Qt Commercial License Agreements.</font>
00030 <font class="comment">** See http://www.trolltech.com/qpl/ for QPL licensing information.</font>
00031 <font class="comment">** See http://www.trolltech.com/gpl/ for GPL licensing information.</font>
00032 <font class="comment">**</font>
00033 <font class="comment">** Contact info@trolltech.com if any conditions of this licensing are</font>
00034 <font class="comment">** not clear to you.</font>
00035 <font class="comment">**</font>
00036 <font class="comment">**********************************************************************/</font>
00037 
00038 <font class="preprocessor">#include "qtextview.h"</font>
00039 <font class="preprocessor">#include "qrichtext_p.h"</font>
00040 <font class="preprocessor">#include "qpainter.h"</font>
00041 <font class="preprocessor">#include "qpen.h"</font>
00042 <font class="preprocessor">#include "qbrush.h"</font>
00043 <font class="preprocessor">#include "qpixmap.h"</font>
00044 <font class="preprocessor">#include "qfont.h"</font>
00045 <font class="preprocessor">#include "qcolor.h"</font>
00046 <font class="preprocessor">#include "qsize.h"</font>
00047 <font class="preprocessor">#include "qevent.h"</font>
00048 <font class="preprocessor">#include "qtimer.h"</font>
00049 <font class="preprocessor">#include "qapplication.h"</font>
00050 <font class="preprocessor">#include "qlistbox.h"</font>
00051 <font class="preprocessor">#include "qvbox.h"</font>
00052 <font class="preprocessor">#include "qapplication.h"</font>
00053 <font class="preprocessor">#include "qclipboard.h"</font>
00054 <font class="preprocessor">#include "qcolordialog.h"</font>
00055 <font class="preprocessor">#include "qfontdialog.h"</font>
00056 <font class="preprocessor">#include "qstylesheet.h"</font>
00057 <font class="preprocessor">#include "qdragobject.h"</font>
00058 <font class="preprocessor">#include "qurl.h"</font>
00059 <font class="preprocessor">#include "qcursor.h"</font>
00060 <font class="preprocessor">#include "qregexp.h"</font>
00061 <font class="preprocessor">#include "qpopupmenu.h"</font>
00062 
00063 <font class="keyword">using</font> <font class="keyword">namespace </font>Qt3;
00064 
00065 <font class="keyword">struct </font>Qt3::QUndoRedoInfoPrivate
00066 {
00067     QTextString text;
00068 };
00069 
00070 <font class="keyword">class </font>Qt3::QTextViewPrivate
00071 {
00072 <font class="keyword">public</font>:
00073     <font class="keywordtype">int</font> id[ 7 ];
00074 };
00075 
00076 <font class="keyword">static</font> <font class="keywordtype">bool</font> block_set_alignment = FALSE;
00077 
00247 QTextView::QTextView( QWidget *parent, <font class="keyword">const</font> <font class="keywordtype">char</font> *name )
00248     : QScrollView( parent, name, WNorthWestGravity | WRepaintNoErase | WResizeNoErase ),
00249       doc( new QTextDocument( 0 ) ), undoRedoInfo( doc )
00250 {
00251     init();
00252 }
00253 
00275 QTextView::QTextView( <font class="keyword">const</font> QString&amp; text, <font class="keyword">const</font> QString&amp; context,
00276               QWidget *parent, <font class="keyword">const</font> <font class="keywordtype">char</font> *name)
00277     : QScrollView( parent, name, WNorthWestGravity | WRepaintNoErase | WResizeNoErase ),
00278       doc( new QTextDocument( 0 ) ), undoRedoInfo( doc )
00279 {
00280     init();
00281     setText( text, context );
00282 }
00283 
00286 QTextView::~QTextView()
00287 {
00288     <font class="keyword">delete</font> undoRedoInfo.d;
00289     undoRedoInfo.d = 0;
00290     <font class="keyword">delete</font> cursor;
00291     <font class="keyword">delete</font> doc;
00292     <font class="keyword">delete</font> d;
00293 }
00294 
00295 <font class="keywordtype">void</font> QTextView::init()
00296 {
00297     d = <font class="keyword">new</font> QTextViewPrivate;
00298     connect( doc, SIGNAL( minimumWidthChanged( <font class="keywordtype">int</font> ) ),
00299          <font class="keyword">this</font>, SLOT( setRealWidth( <font class="keywordtype">int</font> ) ) );
00300 
00301     mousePressed = FALSE;
00302     inDoubleClick = FALSE;
00303     modified = FALSE;
00304     onLink = QString::null;
00305     overWrite = FALSE;
00306     wrapMode = WidgetWidth;
00307     wrapWidth = -1;
00308     wPolicy = AtWhiteSpace;
00309     setMode = Auto;
00310     inDnD = FALSE;
00311 
00312     doc-&gt;setFormatter( <font class="keyword">new</font> QTextFormatterBreakWords );
00313     currentFormat = doc-&gt;formatCollection()-&gt;defaultFormat();
00314     currentAlignment = Qt3::AlignAuto;
00315 
00316     viewport()-&gt;setBackgroundMode( PaletteBase );
00317     viewport()-&gt;setAcceptDrops( TRUE );
00318     resizeContents( 0, doc-&gt;lastParag() ?
00319             ( doc-&gt;lastParag()-&gt;paragId() + 1 ) * doc-&gt;formatCollection()-&gt;defaultFormat()-&gt;height() : 0 );
00320 
00321     setKeyCompression( TRUE );
00322     viewport()-&gt;setMouseTracking( TRUE );
00323 <font class="preprocessor">#ifndef QT_NO_CURSOR</font>
00324 <font class="preprocessor"></font>    viewport()-&gt;setCursor( isReadOnly() ? arrowCursor : ibeamCursor );
00325 <font class="preprocessor">#endif</font>
00326 <font class="preprocessor"></font>    cursor = <font class="keyword">new</font> QTextCursor( doc );
00327 
00328     formatTimer = <font class="keyword">new</font> QTimer( <font class="keyword">this</font> );
00329     connect( formatTimer, SIGNAL( timeout() ),
00330          <font class="keyword">this</font>, SLOT( formatMore() ) );
00331     lastFormatted = doc-&gt;firstParag();
00332 
00333     scrollTimer = <font class="keyword">new</font> QTimer( <font class="keyword">this</font> );
00334     connect( scrollTimer, SIGNAL( timeout() ),
00335          <font class="keyword">this</font>, SLOT( doAutoScroll() ) );
00336 
00337     interval = 0;
00338     changeIntervalTimer = <font class="keyword">new</font> QTimer( <font class="keyword">this</font> );
00339     connect( changeIntervalTimer, SIGNAL( timeout() ),
00340          <font class="keyword">this</font>, SLOT( doChangeInterval() ) );
00341 
00342     cursorVisible = TRUE;
00343     blinkTimer = <font class="keyword">new</font> QTimer( <font class="keyword">this</font> );
00344     connect( blinkTimer, SIGNAL( timeout() ),
00345          <font class="keyword">this</font>, SLOT( blinkCursor() ) );
00346 
00347 <font class="preprocessor">#ifndef QT_NO_DRAGANDDROP</font>
00348 <font class="preprocessor"></font>    dragStartTimer = <font class="keyword">new</font> QTimer( <font class="keyword">this</font> );
00349     connect( dragStartTimer, SIGNAL( timeout() ),
00350          <font class="keyword">this</font>, SLOT( startDrag() ) );
00351 <font class="preprocessor">#endif</font>
00352 <font class="preprocessor"></font>
00353     resizeTimer = <font class="keyword">new</font> QTimer( <font class="keyword">this</font> );
00354     connect( resizeTimer, SIGNAL( timeout() ),
00355          <font class="keyword">this</font>, SLOT( doResize() ) );
00356 
00357     formatMore();
00358 
00359     blinkCursorVisible = FALSE;
00360 
00361     connect( <font class="keyword">this</font>, SIGNAL( textChanged() ),
00362          <font class="keyword">this</font>, SLOT( <a class="code" href="class_q_text_edit.html#g21">setModified</a>() ) );
00363     viewport()-&gt;setFocusProxy( <font class="keyword">this</font> );
00364     viewport()-&gt;setFocusPolicy( WheelFocus );
00365     viewport()-&gt;installEventFilter( <font class="keyword">this</font> );
00366     installEventFilter( <font class="keyword">this</font> );
00367 
00368 <font class="preprocessor">#if 0 // ### background paper test code</font>
00369 <font class="preprocessor"></font>    QBrush *b = <font class="keyword">new</font> QBrush( red, QPixmap( <font class="stringliteral">"/home/reggie/kde2/share/wallpapers/All-Good-People-1.jpg"</font> ) );
00370     doc-&gt;setPaper( b );
00371     QPalette pal( palette() );
00372     pal.setBrush( QColorGroup::Base, *b );
00373     setPalette( pal );
00374 <font class="preprocessor">#endif</font>
00375 <font class="preprocessor"></font>}
00376 
00377 <font class="keywordtype">void</font> QTextView::paintDocument( <font class="keywordtype">bool</font> drawAll, QPainter *p, <font class="keywordtype">int</font> cx, <font class="keywordtype">int</font> cy, <font class="keywordtype">int</font> cw, <font class="keywordtype">int</font> ch )
00378 {
00379     <font class="keywordtype">bool</font> drawCur = hasFocus() || viewport()-&gt;hasFocus();
00380     <font class="keywordflow">if</font> ( isReadOnly() || !cursorVisible )
00381     drawCur = FALSE;
00382     QColorGroup g = colorGroup();
00383     <font class="keywordflow">if</font> ( doc-&gt;paper() )
00384     g.setBrush( QColorGroup::Base, *doc-&gt;paper() );
00385 
00386     <font class="keywordflow">if</font> ( contentsY() == 0 ) {
00387     p-&gt;fillRect( contentsX(), contentsY(), visibleWidth(), doc-&gt;y(),
00388              g.brush( QColorGroup::Base ) );
00389     }
00390 
00391     p-&gt;setBrushOrigin( -contentsX(), -contentsY() );
00392 
00393     lastFormatted = doc-&gt;draw( p, cx, cy, cw, ch, g, !drawAll, drawCur, cursor );
00394 
00395     <font class="keywordflow">if</font> ( lastFormatted == doc-&gt;lastParag() )
00396     resizeContents( contentsWidth(), doc-&gt;height() );
00397 
00398     <font class="keywordflow">if</font> ( contentsHeight() &lt; visibleHeight() &amp;&amp; ( !doc-&gt;lastParag() || doc-&gt;lastParag()-&gt;isValid() ) &amp;&amp; drawAll )
00399     p-&gt;fillRect( 0, contentsHeight(), visibleWidth(),
00400              visibleHeight() - contentsHeight(), g.brush( QColorGroup::Base ) );
00401 }
00402 
00405 <font class="keywordtype">void</font> QTextView::drawContents( QPainter *p, <font class="keywordtype">int</font> cx, <font class="keywordtype">int</font> cy, <font class="keywordtype">int</font> cw, <font class="keywordtype">int</font> ch )
00406 {
00407     paintDocument( TRUE, p, cx, cy, cw, ch );
00408 }
00409 
00412 <font class="keywordtype">bool</font> QTextView::event( QEvent *e )
00413 {
00414     <font class="keywordflow">if</font> ( e-&gt;type() == QEvent::AccelOverride &amp;&amp; !isReadOnly() ) {
00415     QKeyEvent* ke = (QKeyEvent*) e;
00416     <font class="keywordflow">if</font> ( ke-&gt;state() &amp; ControlButton ) {
00417         <font class="keywordflow">switch</font> ( ke-&gt;key() ) {
00418         <font class="keywordflow">case</font> Key_A:
00419         <font class="keywordflow">case</font> Key_E:
00420 <font class="preprocessor">#if defined (Q_WS_WIN)</font>
00421 <font class="preprocessor"></font>        <font class="keywordflow">case</font> Key_Insert:
00422 <font class="preprocessor">#endif</font>
00423 <font class="preprocessor"></font>        <font class="keywordflow">case</font> Key_X:
00424         <font class="keywordflow">case</font> Key_V:
00425         <font class="keywordflow">case</font> Key_C:
00426         <font class="keywordflow">case</font> Key_Left:
00427         <font class="keywordflow">case</font> Key_Right:
00428         <font class="keywordflow">case</font> Key_Up:
00429         <font class="keywordflow">case</font> Key_Down:
00430         <font class="keywordflow">case</font> Key_Home:
00431         <font class="keywordflow">case</font> Key_End:
00432         ke-&gt;accept();
00433         <font class="keywordflow">default</font>:
00434         <font class="keywordflow">break</font>;
00435         }
00436     } <font class="keywordflow">else</font> {
00437         <font class="keywordflow">switch</font> ( ke-&gt;key() ) {
00438         <font class="keywordflow">case</font> Key_Delete:
00439         <font class="keywordflow">case</font> Key_Home:
00440         <font class="keywordflow">case</font> Key_End:
00441         <font class="keywordflow">case</font> Key_Backspace:
00442         ke-&gt;accept();
00443         <font class="keywordflow">default</font>:
00444         <font class="keywordflow">break</font>;
00445         }
00446     }
00447     }
00448     <font class="keywordflow">return</font> QWidget::event( e );
00449 }
00450 
00454 <font class="keywordtype">void</font> QTextView::keyPressEvent( QKeyEvent *e )
00455 {
00456     changeIntervalTimer-&gt;stop();
00457     interval = 10;
00458 
00459     <font class="keywordflow">if</font> ( isReadOnly() ) {
00460     handleReadOnlyKeyEvent( e );
00461     changeIntervalTimer-&gt;start( 100, TRUE );
00462     <font class="keywordflow">return</font>;
00463     }
00464 
00465 
00466     <font class="keywordtype">bool</font> selChanged = FALSE;
00467     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 1; i &lt; doc-&gt;numSelections(); ++i ) <font class="comment">// start with 1 as we don't want to remove the Standard-Selection</font>
00468     selChanged = doc-&gt;removeSelection( i ) || selChanged;
00469 
00470     <font class="keywordflow">if</font> ( selChanged ) {
00471     cursor-&gt;parag()-&gt;document()-&gt;nextDoubleBuffered = TRUE;
00472     repaintChanged();
00473     }
00474 
00475     <font class="keywordtype">bool</font> clearUndoRedoInfo = TRUE;
00476 
00477     <font class="keywordflow">switch</font> ( e-&gt;key() ) {
00478     <font class="keywordflow">case</font> Key_Left:
00479     <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveLeft, e-&gt;state() &amp; ShiftButton, e-&gt;state() &amp; ControlButton );
00480     <font class="keywordflow">break</font>;
00481     <font class="keywordflow">case</font> Key_Right:
00482     <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveRight, e-&gt;state() &amp; ShiftButton, e-&gt;state() &amp; ControlButton );
00483     <font class="keywordflow">break</font>;
00484     <font class="keywordflow">case</font> Key_Up:
00485     <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveUp, e-&gt;state() &amp; ShiftButton, e-&gt;state() &amp; ControlButton );
00486     <font class="keywordflow">break</font>;
00487     <font class="keywordflow">case</font> Key_Down:
00488     <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveDown, e-&gt;state() &amp; ShiftButton, e-&gt;state() &amp; ControlButton );
00489     <font class="keywordflow">break</font>;
00490     <font class="keywordflow">case</font> Key_Home:
00491     <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveHome, e-&gt;state() &amp; ShiftButton, e-&gt;state() &amp; ControlButton );
00492     <font class="keywordflow">break</font>;
00493     <font class="keywordflow">case</font> Key_End:
00494     <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveEnd, e-&gt;state() &amp; ShiftButton, e-&gt;state() &amp; ControlButton );
00495     <font class="keywordflow">break</font>;
00496     <font class="keywordflow">case</font> Key_Prior:
00497     <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MovePgUp, e-&gt;state() &amp; ShiftButton, e-&gt;state() &amp; ControlButton );
00498     <font class="keywordflow">break</font>;
00499     <font class="keywordflow">case</font> Key_Next:
00500     <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MovePgDown, e-&gt;state() &amp; ShiftButton, e-&gt;state() &amp; ControlButton );
00501     <font class="keywordflow">break</font>;
00502     <font class="keywordflow">case</font> Key_Return: <font class="keywordflow">case</font> Key_Enter:
00503     doc-&gt;removeSelection( QTextDocument::Standard );
00504 <font class="preprocessor">#ifndef QT_NO_CURSOR</font>
00505 <font class="preprocessor"></font>    viewport()-&gt;setCursor( isReadOnly() ? arrowCursor : ibeamCursor );
00506 <font class="preprocessor">#endif</font>
00507 <font class="preprocessor"></font>    clearUndoRedoInfo = FALSE;
00508     <a class="code" href="class_q_text_edit.html#b5">doKeyboardAction</a>( ActionReturn );
00509     emitReturnPressed();
00510     <font class="keywordflow">break</font>;
00511     <font class="keywordflow">case</font> Key_Delete:
00512     <font class="keywordflow">if</font> ( doc-&gt;hasSelection( QTextDocument::Standard ) ) {
00513         <a class="code" href="class_q_text_edit.html#g24">removeSelectedText</a>();
00514         <font class="keywordflow">break</font>;
00515     }
00516 
00517     <a class="code" href="class_q_text_edit.html#b5">doKeyboardAction</a>( ActionDelete );
00518     clearUndoRedoInfo = FALSE;
00519 
00520     <font class="keywordflow">break</font>;
00521     <font class="keywordflow">case</font> Key_Backspace:
00522     <font class="keywordflow">if</font> ( doc-&gt;hasSelection( QTextDocument::Standard ) ) {
00523         <a class="code" href="class_q_text_edit.html#g24">removeSelectedText</a>();
00524         <font class="keywordflow">break</font>;
00525     }
00526 
00527     <font class="keywordflow">if</font> ( !cursor-&gt;parag()-&gt;prev() &amp;&amp;
00528          cursor-&gt;atParagStart() )
00529         <font class="keywordflow">break</font>;
00530 
00531     <a class="code" href="class_q_text_edit.html#b5">doKeyboardAction</a>( ActionBackspace );
00532     clearUndoRedoInfo = FALSE;
00533 
00534     <font class="keywordflow">break</font>;
00535     <font class="keywordflow">case</font> Key_F16: <font class="comment">// Copy key on Sun keyboards</font>
00536     copy();
00537     <font class="keywordflow">break</font>;
00538     <font class="keywordflow">case</font> Key_F18:  <font class="comment">// Paste key on Sun keyboards</font>
00539     <a class="code" href="class_q_text_edit.html#g4">paste</a>();
00540     <font class="keywordflow">break</font>;
00541     <font class="keywordflow">case</font> Key_F20:  <font class="comment">// Cut key on Sun keyboards</font>
00542     <a class="code" href="class_q_text_edit.html#g3">cut</a>();
00543     <font class="keywordflow">break</font>;
00544     <font class="keywordflow">default</font>: {
00545         <font class="keywordflow">if</font> ( e-&gt;text().length() &amp;&amp;
00546 <font class="comment">//       !( e-&gt;state() &amp; AltButton ) &amp;&amp; !( e-&gt;state() &amp; MetaButton ) &amp;&amp;</font>
00547          ( !e-&gt;ascii() || e-&gt;ascii() &gt;= 32 ) ||
00548          ( e-&gt;text() == <font class="stringliteral">"\t"</font> &amp;&amp; !( e-&gt;state() &amp; ControlButton ) ) ) {
00549         clearUndoRedoInfo = FALSE;
00550         <font class="keywordflow">if</font> ( e-&gt;key() == Key_Tab ) {
00551             <font class="keywordflow">if</font> ( cursor-&gt;index() == 0 &amp;&amp; cursor-&gt;parag()-&gt;style() &amp;&amp;
00552              cursor-&gt;parag()-&gt;style()-&gt;displayMode() == QStyleSheetItem::DisplayListItem ) {
00553             cursor-&gt;parag()-&gt;incDepth();
00554             drawCursor( FALSE );
00555             repaintChanged();
00556             drawCursor( TRUE );
00557             <font class="keywordflow">break</font>;
00558             }
00559         }
00560         <font class="keywordflow">if</font> ( cursor-&gt;parag()-&gt;style() &amp;&amp;
00561              cursor-&gt;parag()-&gt;style()-&gt;displayMode() == QStyleSheetItem::DisplayBlock &amp;&amp;
00562              cursor-&gt;index() == 0 &amp;&amp; ( e-&gt;text() == <font class="stringliteral">"-"</font> || e-&gt;text() == <font class="stringliteral">"*"</font> ) ) {
00563             <a class="code" href="class_q_text_edit.html#g17">setParagType</a>( QStyleSheetItem::DisplayListItem, QStyleSheetItem::ListDisc );
00564         } <font class="keywordflow">else</font> {
00565             <a class="code" href="class_q_text_edit.html#a14">insert</a>( e-&gt;text(), TRUE, FALSE );
00566         }
00567         <font class="keywordflow">break</font>;
00568         }
00569         <font class="keywordflow">if</font> ( e-&gt;state() &amp; ControlButton ) {
00570         <font class="keywordflow">switch</font> ( e-&gt;key() ) {
00571         <font class="keywordflow">case</font> Key_C: <font class="keywordflow">case</font> Key_F16: <font class="comment">// Copy key on Sun keyboards</font>
00572             copy();
00573             <font class="keywordflow">break</font>;
00574         <font class="keywordflow">case</font> Key_V:
00575             <a class="code" href="class_q_text_edit.html#g4">paste</a>();
00576             <font class="keywordflow">break</font>;
00577         <font class="keywordflow">case</font> Key_X:
00578             <a class="code" href="class_q_text_edit.html#g3">cut</a>();
00579             <font class="keywordflow">break</font>;
00580         <font class="keywordflow">case</font> Key_I: <font class="keywordflow">case</font> Key_T: <font class="keywordflow">case</font> Key_Tab:
00581             <a class="code" href="class_q_text_edit.html#g8">indent</a>();
00582             <font class="keywordflow">break</font>;
00583         <font class="keywordflow">case</font> Key_A:
00584 <font class="preprocessor">#if defined(Q_WS_X11)</font>
00585 <font class="preprocessor"></font>            <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveHome, e-&gt;state() &amp; ShiftButton, FALSE );
00586 <font class="preprocessor">#else</font>
00587 <font class="preprocessor"></font>            selectAll( TRUE );
00588 <font class="preprocessor">#endif</font>
00589 <font class="preprocessor"></font>            <font class="keywordflow">break</font>;
00590         <font class="keywordflow">case</font> Key_B:
00591             <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveLeft, e-&gt;state() &amp; ShiftButton, FALSE );
00592             <font class="keywordflow">break</font>;
00593         <font class="keywordflow">case</font> Key_F:
00594             <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveRight, e-&gt;state() &amp; ShiftButton, FALSE );
00595             <font class="keywordflow">break</font>;
00596         <font class="keywordflow">case</font> Key_D:
00597             <font class="keywordflow">if</font> ( doc-&gt;hasSelection( QTextDocument::Standard ) ) {
00598             <a class="code" href="class_q_text_edit.html#g24">removeSelectedText</a>();
00599             <font class="keywordflow">break</font>;
00600             }
00601             <a class="code" href="class_q_text_edit.html#b5">doKeyboardAction</a>( ActionDelete );
00602             clearUndoRedoInfo = FALSE;
00603             <font class="keywordflow">break</font>;
00604         <font class="keywordflow">case</font> Key_H:
00605             <font class="keywordflow">if</font> ( doc-&gt;hasSelection( QTextDocument::Standard ) ) {
00606             <a class="code" href="class_q_text_edit.html#g24">removeSelectedText</a>();
00607             <font class="keywordflow">break</font>;
00608             }
00609             <font class="keywordflow">if</font> ( !cursor-&gt;parag()-&gt;prev() &amp;&amp;
00610              cursor-&gt;atParagStart() )
00611             <font class="keywordflow">break</font>;
00612 
00613             <a class="code" href="class_q_text_edit.html#b5">doKeyboardAction</a>( ActionBackspace );
00614             clearUndoRedoInfo = FALSE;
00615             <font class="keywordflow">break</font>;
00616         <font class="keywordflow">case</font> Key_E:
00617             <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveEnd, e-&gt;state() &amp; ShiftButton, FALSE );
00618             <font class="keywordflow">break</font>;
00619         <font class="keywordflow">case</font> Key_N:
00620             <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveDown, e-&gt;state() &amp; ShiftButton, FALSE );
00621             <font class="keywordflow">break</font>;
00622         <font class="keywordflow">case</font> Key_P:
00623             <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( MoveUp, e-&gt;state() &amp; ShiftButton, FALSE );
00624             <font class="keywordflow">break</font>;
00625         <font class="keywordflow">case</font> Key_Z:
00626             <a class="code" href="class_q_text_edit.html#g1">undo</a>();
00627             <font class="keywordflow">break</font>;
00628         <font class="keywordflow">case</font> Key_Y:
00629             <a class="code" href="class_q_text_edit.html#g2">redo</a>();
00630             <font class="keywordflow">break</font>;
00631         <font class="keywordflow">case</font> Key_K:
00632             <a class="code" href="class_q_text_edit.html#b5">doKeyboardAction</a>( ActionKill );
00633             <font class="keywordflow">break</font>;
00634         <font class="keywordflow">case</font> Key_Insert:
00635 <font class="preprocessor">#if defined(Q_WS_WIN)</font>
00636 <font class="preprocessor"></font>            copy();
00637 <font class="preprocessor">#endif</font>
00638 <font class="preprocessor"></font>            <font class="keywordflow">break</font>;
00639         }
00640         <font class="keywordflow">break</font>;
00641         }
00642     }
00643     }
00644 
00645     emitCursorPositionChanged( cursor );
00646     <font class="keywordflow">if</font> ( clearUndoRedoInfo )
00647     clearUndoRedo();
00648     changeIntervalTimer-&gt;start( 100, TRUE );
00649 }
00650 
00651 <font class="keywordtype">void</font> QTextView::doKeyboardAction( KeyboardActionPrivate action )
00652 {
00653     <font class="keywordflow">if</font> ( isReadOnly() )
00654     <font class="keywordflow">return</font>;
00655 
00656     <font class="keywordflow">if</font> ( cursor-&gt;nestedDepth() != 0 ) <font class="comment">// #### for 3.0, disable editing of tables as this is not advanced enough</font>
00657     <font class="keywordflow">return</font>;
00658 
00659     lastFormatted = cursor-&gt;parag();
00660     drawCursor( FALSE );
00661 
00662     <font class="keywordflow">switch</font> ( action ) {
00663     <font class="keywordflow">case</font> ActionDelete:
00664     checkUndoRedoInfo( UndoRedoInfo::Delete );
00665     <font class="keywordflow">if</font> ( !undoRedoInfo.valid() ) {
00666         undoRedoInfo.id = cursor-&gt;parag()-&gt;paragId();
00667         undoRedoInfo.index = cursor-&gt;index();
00668         undoRedoInfo.d-&gt;text = QString::null;
00669     }
00670     undoRedoInfo.d-&gt;text += cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;c;
00671     <font class="keywordflow">if</font> ( cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format() ) {
00672         cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;addRef();
00673         undoRedoInfo.d-&gt;text.at( undoRedoInfo.d-&gt;text.length() - 1 ).setFormat( cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format() );
00674     }
00675     <font class="keywordflow">if</font> ( cursor-&gt;remove() )
00676         undoRedoInfo.d-&gt;text += <font class="stringliteral">"\n"</font>;
00677     <font class="keywordflow">break</font>;
00678     <font class="keywordflow">case</font> ActionBackspace:
00679     <font class="keywordflow">if</font> ( cursor-&gt;parag()-&gt;style() &amp;&amp; cursor-&gt;parag()-&gt;style()-&gt;displayMode() == QStyleSheetItem::DisplayListItem &amp;&amp;
00680          cursor-&gt;index() == 0 ) {
00681         cursor-&gt;parag()-&gt;decDepth();
00682         lastFormatted = cursor-&gt;parag();
00683         repaintChanged();
00684         drawCursor( TRUE );
00685         <font class="keywordflow">return</font>;
00686     }
00687     checkUndoRedoInfo( UndoRedoInfo::Delete );
00688     <font class="keywordflow">if</font> ( !undoRedoInfo.valid() ) {
00689         undoRedoInfo.id = cursor-&gt;parag()-&gt;paragId();
00690         undoRedoInfo.index = cursor-&gt;index();
00691         undoRedoInfo.d-&gt;text = QString::null;
00692     }
00693     cursor-&gt;gotoLeft();
00694     undoRedoInfo.d-&gt;text.prepend( QString( cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;c ) );
00695     <font class="keywordflow">if</font> ( cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format() ) {
00696         cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;addRef();
00697         undoRedoInfo.d-&gt;text.at( 0 ).setFormat( cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format() );
00698     }
00699     undoRedoInfo.index = cursor-&gt;index();
00700     <font class="keywordflow">if</font> ( cursor-&gt;remove() ) {
00701         undoRedoInfo.d-&gt;text.remove( 0, 1 );
00702         undoRedoInfo.d-&gt;text.prepend( <font class="stringliteral">"\n"</font> );
00703         undoRedoInfo.index = cursor-&gt;index();
00704         undoRedoInfo.id = cursor-&gt;parag()-&gt;paragId();
00705     }
00706     lastFormatted = cursor-&gt;parag();
00707     <font class="keywordflow">break</font>;
00708     <font class="keywordflow">case</font> ActionReturn:
00709     checkUndoRedoInfo( UndoRedoInfo::Return );
00710     <font class="keywordflow">if</font> ( !undoRedoInfo.valid() ) {
00711         undoRedoInfo.id = cursor-&gt;parag()-&gt;paragId();
00712         undoRedoInfo.index = cursor-&gt;index();
00713         undoRedoInfo.d-&gt;text = QString::null;
00714     }
00715     undoRedoInfo.d-&gt;text += <font class="stringliteral">"\n"</font>;
00716     cursor-&gt;splitAndInsertEmptyParag();
00717     <font class="keywordflow">if</font> ( cursor-&gt;parag()-&gt;prev() )
00718         lastFormatted = cursor-&gt;parag()-&gt;prev();
00719     <font class="keywordflow">break</font>;
00720     <font class="keywordflow">case</font> ActionKill:
00721     checkUndoRedoInfo( UndoRedoInfo::Delete );
00722     <font class="keywordflow">if</font> ( !undoRedoInfo.valid() ) {
00723         undoRedoInfo.id = cursor-&gt;parag()-&gt;paragId();
00724         undoRedoInfo.index = cursor-&gt;index();
00725         undoRedoInfo.d-&gt;text = QString::null;
00726     }
00727     <font class="keywordflow">if</font> ( cursor-&gt;atParagEnd() ) {
00728         undoRedoInfo.d-&gt;text += cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;c;
00729         <font class="keywordflow">if</font> ( cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format() ) {
00730         cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;addRef();
00731         undoRedoInfo.d-&gt;text.at( undoRedoInfo.d-&gt;text.length() - 1 ).setFormat( cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format() );
00732         }
00733         <font class="keywordflow">if</font> ( cursor-&gt;remove() )
00734         undoRedoInfo.d-&gt;text += <font class="stringliteral">"\n"</font>;
00735     } <font class="keywordflow">else</font> {
00736         <font class="keywordtype">int</font> oldLen = undoRedoInfo.d-&gt;text.length();
00737         undoRedoInfo.d-&gt;text += cursor-&gt;parag()-&gt;string()-&gt;toString().mid( cursor-&gt;index() );
00738         <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = cursor-&gt;index(); i &lt; cursor-&gt;parag()-&gt;length(); ++i ) {
00739         <font class="keywordflow">if</font> ( cursor-&gt;parag()-&gt;at( i )-&gt;format() ) {
00740             cursor-&gt;parag()-&gt;at( i )-&gt;format()-&gt;addRef();
00741             undoRedoInfo.d-&gt;text.at( oldLen + i - cursor-&gt;index() ).setFormat( cursor-&gt;parag()-&gt;at( i )-&gt;format() );
00742         }
00743         }
00744         undoRedoInfo.d-&gt;text.remove( undoRedoInfo.d-&gt;text.length() - 1, 1 );
00745         cursor-&gt;killLine();
00746     }
00747     <font class="keywordflow">break</font>;
00748     }
00749 
00750     formatMore();
00751     repaintChanged();
00752     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
00753     drawCursor( TRUE );
00754 
00755     <font class="keywordflow">if</font> ( hasFocus() || viewport()-&gt;hasFocus() ) {
00756     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
00757     QFont f = cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;font();
00758     setMicroFocusHint( cursor-&gt;x() - contentsX() + frameWidth(),
00759                cursor-&gt;y() + cursor-&gt;parag()-&gt;rect().y() - contentsY() + frameWidth(), 0, h, TRUE<font class="comment">/*, &amp;f*/</font> ); <font class="comment">// QT2HACK</font>
00760     }
00761 
00762     updateCurrentFormat();
00763     emit textChanged();
00764 }
00765 
00766 <font class="keywordtype">void</font> QTextView::readFormats( QTextCursor &amp;c1, QTextCursor &amp;c2, <font class="keywordtype">int</font> oldLen, QTextString &amp;text, <font class="keywordtype">bool</font> fillStyles )
00767 {
00768     c2.restoreState();
00769     c1.restoreState();
00770     <font class="keywordflow">if</font> ( c1.parag() == c2.parag() ) {
00771     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = c1.index(); i &lt; c2.index(); ++i ) {
00772         <font class="keywordflow">if</font> ( c1.parag()-&gt;at( i )-&gt;format() ) {
00773         c1.parag()-&gt;at( i )-&gt;format()-&gt;addRef();
00774         text.at( oldLen + i - c1.index() ).setFormat( c1.parag()-&gt;at( i )-&gt;format() );
00775         }
00776     }
00777     <font class="keywordflow">if</font> ( fillStyles ) {
00778         undoRedoInfo.oldAligns[ 0 ] = c1.parag()-&gt;alignment();
00779         undoRedoInfo.oldStyles &lt;&lt; c1.parag()-&gt;styleSheetItems();
00780         undoRedoInfo.oldListStyles &lt;&lt; c1.parag()-&gt;listStyle();
00781     }
00782     } <font class="keywordflow">else</font> {
00783     <font class="keywordtype">int</font> lastIndex = oldLen;
00784     <font class="keywordtype">int</font> i;
00785     <font class="keywordflow">for</font> ( i = c1.index(); i &lt; c1.parag()-&gt;length(); ++i ) {
00786         <font class="keywordflow">if</font> ( c1.parag()-&gt;at( i )-&gt;format() ) {
00787         c1.parag()-&gt;at( i )-&gt;format()-&gt;addRef();
00788         text.at( lastIndex ).setFormat( c1.parag()-&gt;at( i )-&gt;format() );
00789         lastIndex++;
00790         }
00791     }
00792     lastIndex++;
00793     QTextParag *p = c1.parag()-&gt;next();
00794     <font class="keywordflow">while</font> ( p &amp;&amp; p != c2.parag() ) {
00795         <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; p-&gt;length(); ++i ) {
00796         <font class="keywordflow">if</font> ( p-&gt;at( i )-&gt;format() ) {
00797             p-&gt;at( i )-&gt;format()-&gt;addRef();
00798             text.at( i + lastIndex ).setFormat( p-&gt;at( i )-&gt;format() );
00799         }
00800         }
00801         lastIndex += p-&gt;length() + 1;
00802         p = p-&gt;next();
00803     }
00804     <font class="keywordflow">for</font> ( i = 0; i &lt; c2.index(); ++i ) {
00805         <font class="keywordflow">if</font> ( c2.parag()-&gt;at( i )-&gt;format() ) {
00806         c2.parag()-&gt;at( i )-&gt;format()-&gt;addRef();
00807         text.at( i + lastIndex ).setFormat( c2.parag()-&gt;at( i )-&gt;format() );
00808         }
00809     }
00810     <font class="keywordflow">if</font> ( fillStyles ) {
00811         QTextParag *p = c1.parag();
00812         i = 0;
00813         <font class="keywordflow">while</font> ( p ) {
00814         <font class="keywordflow">if</font> ( i &lt; (int)undoRedoInfo.oldAligns.size() )
00815             undoRedoInfo.oldAligns[ i ] = p-&gt;alignment();
00816         undoRedoInfo.oldStyles &lt;&lt; p-&gt;styleSheetItems();
00817         undoRedoInfo.oldListStyles &lt;&lt; p-&gt;listStyle();
00818         <font class="keywordflow">if</font> ( p == c2.parag() )
00819             <font class="keywordflow">break</font>;
00820         p = p-&gt;next();
00821         ++i;
00822         }
00823     }
00824     }
00825 }
00826 
00827 <font class="keywordtype">void</font> QTextView::removeSelectedText()
00828 {
00829     <font class="keywordflow">if</font> ( isReadOnly() )
00830     <font class="keywordflow">return</font>;
00831 
00832     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 1; i &lt; (int)doc-&gt;numSelections(); ++i )
00833     doc-&gt;removeSelection( i );
00834 
00835     drawCursor( FALSE );
00836     checkUndoRedoInfo( UndoRedoInfo::RemoveSelected );
00837     <font class="keywordflow">if</font> ( !undoRedoInfo.valid() ) {
00838     doc-&gt;selectionStart( QTextDocument::Standard, undoRedoInfo.id, undoRedoInfo.index );
00839     undoRedoInfo.d-&gt;text = QString::null;
00840     }
00841     <font class="keywordtype">int</font> oldLen = undoRedoInfo.d-&gt;text.length();
00842     undoRedoInfo.d-&gt;text = doc-&gt;selectedText( QTextDocument::Standard );
00843     QTextCursor c1 = doc-&gt;selectionStartCursor( QTextDocument::Standard );
00844     QTextCursor c2 = doc-&gt;selectionEndCursor( QTextDocument::Standard );
00845     undoRedoInfo.oldAligns.resize( undoRedoInfo.oldAligns.size() + QMAX( 0, c2.parag()-&gt;paragId() - c1.parag()-&gt;paragId() + 1 ) );
00846     readFormats( c1, c2, oldLen, undoRedoInfo.d-&gt;text, TRUE );
00847     doc-&gt;removeSelectedText( QTextDocument::Standard, cursor );
00848     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
00849     lastFormatted = cursor-&gt;parag();
00850     formatMore();
00851     repaintChanged();
00852     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
00853     drawCursor( TRUE );
00854     clearUndoRedo();
00855     emit textChanged();
00856 <font class="preprocessor">#if defined(Q_WS_WIN)</font>
00857 <font class="preprocessor"></font>    <font class="comment">// there seems to be a problem with repainting or erasing the area</font>
00858     <font class="comment">// of the scrollview which is not the contents on windows</font>
00859     <font class="keywordflow">if</font> ( contentsHeight() &lt; visibleHeight() )
00860     viewport()-&gt;repaint( 0, contentsHeight(), visibleWidth(), visibleHeight() - contentsHeight(), TRUE );
00861 <font class="preprocessor">#endif</font>
00862 <font class="preprocessor"></font><font class="preprocessor">#ifndef QT_NO_CURSOR</font>
00863 <font class="preprocessor"></font>    viewport()-&gt;setCursor( isReadOnly() ? arrowCursor : ibeamCursor );
00864 <font class="preprocessor">#endif</font>
00865 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( hasFocus() || viewport()-&gt;hasFocus() ) {
00866     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
00867     QFont f = cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;font();
00868     setMicroFocusHint( cursor-&gt;x() - contentsX() + frameWidth(),
00869                cursor-&gt;y() + cursor-&gt;parag()-&gt;rect().y() - contentsY() + frameWidth(), 0, h, TRUE<font class="comment">/*, &amp;f*/</font> ); <font class="comment">// QT2HACK</font>
00870     }
00871 }
00872 
00873 <font class="keywordtype">void</font> QTextView::moveCursor( MoveDirectionPrivate direction, <font class="keywordtype">bool</font> shift, <font class="keywordtype">bool</font> control )
00874 {
00875     drawCursor( FALSE );
00876     <font class="keywordflow">if</font> ( shift ) {
00877     <font class="keywordflow">if</font> ( !doc-&gt;hasSelection( QTextDocument::Standard ) )
00878         doc-&gt;setSelectionStart( QTextDocument::Standard, cursor );
00879     <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( direction, control );
00880     <font class="keywordflow">if</font> ( doc-&gt;setSelectionEnd( QTextDocument::Standard, cursor ) ) {
00881         cursor-&gt;parag()-&gt;document()-&gt;nextDoubleBuffered = TRUE;
00882         repaintChanged();
00883     } <font class="keywordflow">else</font> {
00884         drawCursor( TRUE );
00885     }
00886     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
00887     emit selectionChanged();
00888     emit copyAvailable( doc-&gt;hasSelection( QTextDocument::Standard ) );
00889     } <font class="keywordflow">else</font> {
00890     <font class="keywordtype">bool</font> redraw = doc-&gt;removeSelection( QTextDocument::Standard );
00891     <a class="code" href="class_q_text_edit.html#b3">moveCursor</a>( direction, control );
00892     <font class="keywordflow">if</font> ( !redraw ) {
00893         <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
00894         drawCursor( TRUE );
00895     } <font class="keywordflow">else</font> {
00896         cursor-&gt;parag()-&gt;document()-&gt;nextDoubleBuffered = TRUE;
00897         repaintChanged();
00898         <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
00899         drawCursor( TRUE );
00900 <font class="preprocessor">#ifndef QT_NO_CURSOR</font>
00901 <font class="preprocessor"></font>        viewport()-&gt;setCursor( isReadOnly() ? arrowCursor : ibeamCursor );
00902 <font class="preprocessor">#endif</font>
00903 <font class="preprocessor"></font>    }
00904     <font class="keywordflow">if</font> ( redraw ) {
00905         emit copyAvailable( doc-&gt;hasSelection( QTextDocument::Standard ) );
00906         emit selectionChanged();
00907     }
00908     }
00909 
00910     drawCursor( TRUE );
00911     updateCurrentFormat();
00912     <font class="keywordflow">if</font> ( hasFocus() || viewport()-&gt;hasFocus() ) {
00913     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
00914     QFont f = cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;font();
00915     setMicroFocusHint( cursor-&gt;x() - contentsX() + frameWidth(),
00916                cursor-&gt;y() + cursor-&gt;parag()-&gt;rect().y() - contentsY() + frameWidth(), 0, h, TRUE<font class="comment">/*, &amp;f*/</font> ); <font class="comment">// QT2HACK</font>
00917     }
00918 }
00919 
00920 <font class="keywordtype">void</font> QTextView::moveCursor( MoveDirectionPrivate direction, <font class="keywordtype">bool</font> control )
00921 {
00922     <font class="keywordflow">switch</font> ( direction ) {
00923     <font class="keywordflow">case</font> MoveLeft: {
00924     <font class="keywordflow">if</font> ( !control )
00925         cursor-&gt;gotoLeft();
00926     <font class="keywordflow">else</font>
00927         cursor-&gt;gotoWordLeft();
00928     } <font class="keywordflow">break</font>;
00929     <font class="keywordflow">case</font> MoveRight: {
00930     <font class="keywordflow">if</font> ( !control )
00931         cursor-&gt;gotoRight();
00932     <font class="keywordflow">else</font>
00933         cursor-&gt;gotoWordRight();
00934     } <font class="keywordflow">break</font>;
00935     <font class="keywordflow">case</font> MoveUp: {
00936     <font class="keywordflow">if</font> ( !control )
00937         cursor-&gt;gotoUp();
00938     <font class="keywordflow">else</font>
00939         cursor-&gt;gotoPageUp( visibleHeight() );
00940     } <font class="keywordflow">break</font>;
00941     <font class="keywordflow">case</font> MoveDown: {
00942     <font class="keywordflow">if</font> ( !control )
00943         cursor-&gt;gotoDown();
00944     <font class="keywordflow">else</font>
00945         cursor-&gt;gotoPageDown( visibleHeight() );
00946     } <font class="keywordflow">break</font>;
00947     <font class="keywordflow">case</font> MoveHome: {
00948     <font class="keywordflow">if</font> ( !control )
00949         cursor-&gt;gotoLineStart();
00950     <font class="keywordflow">else</font>
00951         cursor-&gt;gotoHome();
00952     } <font class="keywordflow">break</font>;
00953     <font class="keywordflow">case</font> MoveEnd: {
00954     <font class="keywordflow">if</font> ( !control )
00955         cursor-&gt;gotoLineEnd();
00956     <font class="keywordflow">else</font>
00957         cursor-&gt;gotoEnd();
00958     } <font class="keywordflow">break</font>;
00959     <font class="keywordflow">case</font> MovePgUp:
00960     cursor-&gt;gotoPageUp( visibleHeight() );
00961     <font class="keywordflow">break</font>;
00962     <font class="keywordflow">case</font> MovePgDown:
00963     cursor-&gt;gotoPageDown( visibleHeight() );
00964     <font class="keywordflow">break</font>;
00965     }
00966 
00967     <font class="keywordflow">if</font> ( hasFocus() || viewport()-&gt;hasFocus() ) {
00968     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
00969     QFont f = cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;font();
00970     setMicroFocusHint( cursor-&gt;x() - contentsX() + frameWidth(),
00971                cursor-&gt;y() + cursor-&gt;parag()-&gt;rect().y() - contentsY() + frameWidth(), 0, h, TRUE<font class="comment">/*, &amp;f*/</font> ); <font class="comment">// QT2HACK</font>
00972     }
00973     updateCurrentFormat();
00974 }
00975 
00978 <font class="keywordtype">void</font> QTextView::resizeEvent( QResizeEvent *e )
00979 {
00980     QScrollView::resizeEvent( e );
00981 <font class="preprocessor">#if defined(Q_WS_X11)</font>
00982 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( e-&gt;oldSize().width() != e-&gt;size().width() )
00983 <font class="preprocessor">#endif</font>
00984 <font class="preprocessor"></font>    doResize();
00985 }
00986 
00987 <font class="keywordtype">void</font> QTextView::ensureCursorVisible()
00988 {
00989     lastFormatted = cursor-&gt;parag();
00990     formatMore();
00991     QTextStringChar *chr = cursor-&gt;parag()-&gt;at( cursor-&gt;index() );
00992     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
00993     <font class="keywordtype">int</font> x = cursor-&gt;parag()-&gt;rect().x() + chr-&gt;x + cursor-&gt;offsetX();
00994     <font class="keywordtype">int</font> y = 0; <font class="keywordtype">int</font> dummy;
00995     cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index(), &amp;dummy, &amp;y );
00996     y += cursor-&gt;parag()-&gt;rect().y() + cursor-&gt;offsetY();
00997     <font class="keywordtype">int</font> w = 1;
00998     ensureVisible( x, y + h / 2, w, h / 2 + 2 );
00999 }
01000 
01001 <font class="keywordtype">void</font> QTextView::drawCursor( <font class="keywordtype">bool</font> visible )
01002 {
01003     <font class="keywordflow">if</font> ( !cursor-&gt;parag() ||
01004      !cursor-&gt;parag()-&gt;isValid() ||
01005      ( !hasFocus() &amp;&amp; !viewport()-&gt;hasFocus() &amp;&amp; !inDnD ) ||
01006      isReadOnly() )
01007     <font class="keywordflow">return</font>;
01008 
01009     QPainter p( viewport() );
01010     QRect r( cursor-&gt;topParag()-&gt;rect() );
01011     cursor-&gt;parag()-&gt;setChanged( TRUE );
01012     p.translate( -contentsX() + cursor-&gt;totalOffsetX(), -contentsY() + cursor-&gt;totalOffsetY() );
01013     QPixmap *pix = 0;
01014     QColorGroup cg( colorGroup() );
01015     <font class="keywordflow">if</font> ( cursor-&gt;parag()-&gt;background() )
01016     cg.setBrush( QColorGroup::Base, *cursor-&gt;parag()-&gt;background() );
01017     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( doc-&gt;paper() )
01018     cg.setBrush( QColorGroup::Base, *doc-&gt;paper() );
01019     p.setBrushOrigin( -contentsX(), -contentsY() );
01020     cursor-&gt;parag()-&gt;document()-&gt;nextDoubleBuffered = TRUE;
01021     <font class="keywordflow">if</font> ( !cursor-&gt;nestedDepth() ) {
01022     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
01023     p.setClipRect( QRect( r.x() - cursor-&gt;totalOffsetX() + cursor-&gt;x() - 5 - contentsX(),
01024                   r.y() - cursor-&gt;totalOffsetY() + cursor-&gt;y() - contentsY(), 10, h ) );
01025     doc-&gt;drawParag( &amp;p, cursor-&gt;parag(), r.x() - cursor-&gt;totalOffsetX() + cursor-&gt;x() - 5,
01026             r.y() - cursor-&gt;totalOffsetY() + cursor-&gt;y(), 10, h, pix, cg, visible, cursor );
01027     } <font class="keywordflow">else</font> {
01028     doc-&gt;drawParag( &amp;p, cursor-&gt;parag(), r.x() - cursor-&gt;totalOffsetX(),
01029             r.y() - cursor-&gt;totalOffsetY(), r.width(), r.height(),
01030             pix, cg, visible, cursor );
01031     }
01032     cursorVisible = visible;
01033 }
01034 
01035 <font class="keyword">enum</font> {
01036     IdUndo = 0,
01037     IdRedo = 1,
01038     IdCut = 2,
01039     IdCopy = 3,
01040     IdPaste = 4,
01041     IdClear = 5,
01042     IdSelectAll = 6
01043 };
01044 
01047 <font class="keywordtype">void</font> QTextView::contentsWheelEvent( QWheelEvent *e )
01048 {
01049     <font class="keywordflow">if</font> ( isReadOnly() ) {
01050     <font class="keywordflow">if</font> ( e-&gt;state() &amp; ControlButton ) {
01051         <font class="keywordflow">if</font> ( e-&gt;delta() &gt; 0 )
01052         zoomOut();
01053         <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( e-&gt;delta() &lt; 0 )
01054         zoomIn();
01055         <font class="keywordflow">return</font>;
01056     }
01057     }
01058     QScrollView::contentsWheelEvent( e );
01059 }
01060 
01063 <font class="keywordtype">void</font> QTextView::contentsMousePressEvent( QMouseEvent *e )
01064 {
01065     clearUndoRedo();
01066     QTextCursor oldCursor = *cursor;
01067     QTextCursor c = *cursor;
01068     mousePos = e-&gt;pos();
01069     mightStartDrag = FALSE;
01070     pressedLink = QString::null;
01071 
01072     <font class="keywordflow">if</font> ( e-&gt;button() == LeftButton ) {
01073     mousePressed = TRUE;
01074     drawCursor( FALSE );
01075     <a class="code" href="class_q_text_edit.html#b2">placeCursor</a>( e-&gt;pos() );
01076     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
01077 
01078     <font class="keywordflow">if</font> ( isReadOnly() &amp;&amp; linksEnabled() ) {
01079         QTextCursor c = *cursor;
01080         <a class="code" href="class_q_text_edit.html#b2">placeCursor</a>( e-&gt;pos(), &amp;c );
01081         <font class="keywordflow">if</font> ( c.parag() &amp;&amp; c.parag()-&gt;at( c.index() ) &amp;&amp;
01082          c.parag()-&gt;at( c.index() )-&gt;format()-&gt;isAnchor() ) {
01083         pressedLink = c.parag()-&gt;at( c.index() )-&gt;format()-&gt;anchorHref();
01084         }
01085     }
01086 
01087 <font class="preprocessor">#ifndef QT_NO_DRAGANDDROP</font>
01088 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( doc-&gt;inSelection( QTextDocument::Standard, e-&gt;pos() ) ) {
01089         mightStartDrag = TRUE;
01090         drawCursor( TRUE );
01091         dragStartTimer-&gt;start( QApplication::startDragTime(), TRUE );
01092         dragStartPos = e-&gt;pos();
01093         <font class="keywordflow">return</font>;
01094     }
01095 <font class="preprocessor">#endif</font>
01096 <font class="preprocessor"></font>
01097     <font class="keywordtype">bool</font> redraw = FALSE;
01098     <font class="keywordflow">if</font> ( doc-&gt;hasSelection( QTextDocument::Standard ) ) {
01099         emit copyAvailable( doc-&gt;hasSelection( QTextDocument::Standard ) );
01100         emit selectionChanged();
01101         <font class="keywordflow">if</font> ( !( e-&gt;state() &amp; ShiftButton ) ) {
01102         redraw = doc-&gt;removeSelection( QTextDocument::Standard );
01103         doc-&gt;setSelectionStart( QTextDocument::Standard, cursor );
01104         } <font class="keywordflow">else</font> {
01105         redraw = doc-&gt;setSelectionEnd( QTextDocument::Standard, cursor ) || redraw;
01106         }
01107     } <font class="keywordflow">else</font> {
01108         <font class="keywordflow">if</font> ( !( e-&gt;state() &amp; ShiftButton ) ) {
01109         doc-&gt;setSelectionStart( QTextDocument::Standard, cursor );
01110         } <font class="keywordflow">else</font> {
01111         doc-&gt;setSelectionStart( QTextDocument::Standard, &amp;c );
01112         redraw = doc-&gt;setSelectionEnd( QTextDocument::Standard, cursor ) || redraw;
01113         }
01114     }
01115 
01116     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 1; i &lt; doc-&gt;numSelections(); ++i ) <font class="comment">// start with 1 as we don't want to remove the Standard-Selection</font>
01117         redraw = doc-&gt;removeSelection( i ) || redraw;
01118 
01119     <font class="keywordflow">if</font> ( !redraw ) {
01120         drawCursor( TRUE );
01121     } <font class="keywordflow">else</font> {
01122         repaintChanged();
01123 <font class="preprocessor">#ifndef QT_NO_CURSOR</font>
01124 <font class="preprocessor"></font>        viewport()-&gt;setCursor( isReadOnly() ? arrowCursor : ibeamCursor );
01125 <font class="preprocessor">#endif</font>
01126 <font class="preprocessor"></font>    }
01127     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( e-&gt;button() == MidButton ) {
01128 <font class="preprocessor">#if 0 // QT2HACK</font>
01129 <font class="preprocessor"></font>    <font class="keywordflow">if</font> (QApplication::clipboard()-&gt;supportsSelection()) {
01130 <font class="preprocessor">#endif</font>
01131 <font class="preprocessor"></font>        <font class="comment">// only do middle-click pasting on systems that have selections (ie. X11)</font>
01132 <font class="preprocessor">#if 0 // QT2HACK</font>
01133 <font class="preprocessor"></font>        QApplication::clipboard()-&gt;setSelectionMode(TRUE);
01134 <font class="preprocessor">#endif</font>
01135 <font class="preprocessor"></font>        <a class="code" href="class_q_text_edit.html#g4">paste</a>();
01136 <font class="preprocessor">#if 0 // QT2HACK</font>
01137 <font class="preprocessor"></font>        QApplication::clipboard()-&gt;setSelectionMode(FALSE);
01138     }
01139 <font class="preprocessor">#endif</font>
01140 <font class="preprocessor"></font>    }
01141 
01142     <font class="keywordflow">if</font> ( *cursor != oldCursor )
01143     updateCurrentFormat();
01144 }
01145 
01148 <font class="keywordtype">void</font> QTextView::contentsMouseMoveEvent( QMouseEvent *e )
01149 {
01150     <font class="keywordflow">if</font> ( mousePressed ) {
01151 <font class="preprocessor">#ifndef QT_NO_DRAGANDDROP</font>
01152 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( mightStartDrag ) {
01153         dragStartTimer-&gt;stop();
01154         <font class="keywordflow">if</font> ( ( e-&gt;pos() - dragStartPos ).manhattanLength() &gt; QApplication::startDragDistance() )
01155         startDrag();
01156         <font class="keywordflow">if</font> ( !isReadOnly() )
01157         viewport()-&gt;setCursor( ibeamCursor );
01158         <font class="keywordflow">return</font>;
01159     }
01160 <font class="preprocessor">#endif</font>
01161 <font class="preprocessor"></font>    mousePos = e-&gt;pos();
01162     doAutoScroll();
01163     oldMousePos = mousePos;
01164     }
01165 
01166     <font class="keywordflow">if</font> ( !isReadOnly() &amp;&amp; !mousePressed ) {
01167     <font class="keywordflow">if</font> ( doc-&gt;hasSelection( QTextDocument::Standard ) &amp;&amp; doc-&gt;inSelection( QTextDocument::Standard, e-&gt;pos() ) )
01168         viewport()-&gt;setCursor( arrowCursor );
01169     <font class="keywordflow">else</font>
01170         viewport()-&gt;setCursor( ibeamCursor );
01171     }
01172 
01173     <font class="keywordflow">if</font> ( isReadOnly() &amp;&amp; linksEnabled() ) {
01174     QTextCursor c = *cursor;
01175     <a class="code" href="class_q_text_edit.html#b2">placeCursor</a>( e-&gt;pos(), &amp;c );
01176 <font class="preprocessor">#ifndef QT_NO_NETWORKPROTOCOL</font>
01177 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( c.parag() &amp;&amp; c.parag()-&gt;at( c.index() ) &amp;&amp;
01178          c.parag()-&gt;at( c.index() )-&gt;format()-&gt;isAnchor() ) {
01179 <font class="preprocessor">#ifndef QT_NO_CURSOR</font>
01180 <font class="preprocessor"></font>        viewport()-&gt;setCursor( pointingHandCursor );
01181 <font class="preprocessor">#endif</font>
01182 <font class="preprocessor"></font>        onLink = c.parag()-&gt;at( c.index() )-&gt;format()-&gt;anchorHref();
01183         QUrl u( doc-&gt;context(), onLink, TRUE );
01184         emitHighlighted( u.toString( FALSE, FALSE ) );
01185     } <font class="keywordflow">else</font> {
01186 <font class="preprocessor">#ifndef QT_NO_CURSOR</font>
01187 <font class="preprocessor"></font>        viewport()-&gt;setCursor( isReadOnly() ? arrowCursor : ibeamCursor );
01188 <font class="preprocessor">#endif</font>
01189 <font class="preprocessor"></font>        onLink = QString::null;
01190         emitHighlighted( QString::null );
01191     }
01192 <font class="preprocessor">#endif</font>
01193 <font class="preprocessor"></font>    }
01194 }
01195 
01198 <font class="keywordtype">void</font> QTextView::contentsMouseReleaseEvent( QMouseEvent * )
01199 {
01200     QTextCursor oldCursor = *cursor;
01201     <font class="keywordflow">if</font> ( scrollTimer-&gt;isActive() )
01202     scrollTimer-&gt;stop();
01203 <font class="preprocessor">#ifndef QT_NO_DRAGANDDROP</font>
01204 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( dragStartTimer-&gt;isActive() )
01205     dragStartTimer-&gt;stop();
01206     <font class="keywordflow">if</font> ( mightStartDrag ) {
01207     selectAll( FALSE );
01208     mousePressed = FALSE;
01209     }
01210 <font class="preprocessor">#endif</font>
01211 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( mousePressed ) {
01212     mousePressed = FALSE;
01213 <font class="preprocessor">#if 0 // QT2HACK</font>
01214 <font class="preprocessor"></font>    <font class="keywordflow">if</font> (QApplication::clipboard()-&gt;supportsSelection()) {
01215         QApplication::clipboard()-&gt;setSelectionMode(TRUE);
01216 <font class="preprocessor">#endif</font>
01217 <font class="preprocessor"></font>        <font class="comment">// only do middle-click selection on systems that support it (ie. X11)</font>
01218         <font class="keywordflow">if</font> ( !doc-&gt;selectedText( QTextDocument::Standard ).isEmpty() )
01219         doc-&gt;copySelectedText( QTextDocument::Standard );
01220 <font class="preprocessor">#if 0 // QT2HACK</font>
01221 <font class="preprocessor"></font>        QApplication::clipboard()-&gt;setSelectionMode(FALSE);
01222 <font class="preprocessor">#endif</font>
01223 <font class="preprocessor"></font>        emit copyAvailable( doc-&gt;hasSelection( QTextDocument::Standard ) );
01224         emit selectionChanged();
01225 <font class="preprocessor">#if 0 // QT2HACK</font>
01226 <font class="preprocessor"></font>    }
01227 <font class="preprocessor">#endif</font>
01228 <font class="preprocessor"></font>    }
01229     emitCursorPositionChanged( cursor );
01230     <font class="keywordflow">if</font> ( oldCursor != *cursor )
01231     updateCurrentFormat();
01232     inDoubleClick = FALSE;
01233 
01234 <font class="preprocessor">#ifndef QT_NO_NETWORKPROTOCOL</font>
01235 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( !onLink.isEmpty() &amp;&amp; onLink == pressedLink &amp;&amp; linksEnabled() ) {
01236     QUrl u( doc-&gt;context(), onLink, TRUE );
01237     emitLinkClicked( u.toString( FALSE, FALSE ) );
01238     }
01239 <font class="preprocessor">#endif</font>
01240 <font class="preprocessor"></font>    drawCursor( TRUE );
01241 }
01242 
01245 <font class="keywordtype">void</font> QTextView::contentsMouseDoubleClickEvent( QMouseEvent * )
01246 {
01247     QTextCursor c1 = *cursor;
01248     QTextCursor c2 = *cursor;
01249     c1.gotoWordLeft();
01250     c2.gotoWordRight();
01251 
01252     doc-&gt;setSelectionStart( QTextDocument::Standard, &amp;c1 );
01253     doc-&gt;setSelectionEnd( QTextDocument::Standard, &amp;c2 );
01254 
01255     *cursor = c2;
01256 
01257     repaintChanged();
01258 
01259     inDoubleClick = TRUE;
01260     mousePressed = TRUE;
01261 }
01262 
01263 <font class="preprocessor">#ifndef QT_NO_DRAGANDDROP</font>
01264 <font class="preprocessor"></font>
01267 <font class="keywordtype">void</font> QTextView::contentsDragEnterEvent( QDragEnterEvent *e )
01268 {
01269     e-&gt;acceptAction();
01270     inDnD = TRUE;
01271 }
01272 
01275 <font class="keywordtype">void</font> QTextView::contentsDragMoveEvent( QDragMoveEvent *e )
01276 {
01277     drawCursor( FALSE );
01278     <a class="code" href="class_q_text_edit.html#b2">placeCursor</a>( e-&gt;pos(),  cursor );
01279     drawCursor( TRUE );
01280     e-&gt;acceptAction();
01281 }
01282 
01285 <font class="keywordtype">void</font> QTextView::contentsDragLeaveEvent( QDragLeaveEvent * )
01286 {
01287     inDnD = FALSE;
01288 }
01289 
01292 <font class="keywordtype">void</font> QTextView::contentsDropEvent( QDropEvent *e )
01293 {
01294     <font class="keywordflow">if</font> ( isReadOnly() )
01295     <font class="keywordflow">return</font>;
01296     inDnD = FALSE;
01297     e-&gt;acceptAction();
01298     QString text;
01299     <font class="keywordtype">int</font> i = -1;
01300     <font class="keywordflow">while</font> ( ( i = text.find( <font class="charliteral">'\r'</font> ) ) != -1 )
01301     text.replace( i, 1, <font class="stringliteral">""</font> );
01302     <font class="keywordflow">if</font> ( QTextDrag::decode( e, text ) ) {
01303     <font class="keywordflow">if</font> ( ( e-&gt;source() == <font class="keyword">this</font> ||
01304            e-&gt;source() == viewport() ) &amp;&amp;
01305          e-&gt;action() == QDropEvent::Move ) {
01306         <a class="code" href="class_q_text_edit.html#g24">removeSelectedText</a>();
01307     } <font class="keywordflow">else</font> {
01308         doc-&gt;removeSelection( QTextDocument::Standard );
01309 <font class="preprocessor">#ifndef QT_NO_CURSOR</font>
01310 <font class="preprocessor"></font>        viewport()-&gt;setCursor( isReadOnly() ? arrowCursor : ibeamCursor );
01311 <font class="preprocessor">#endif</font>
01312 <font class="preprocessor"></font>    }
01313     drawCursor( FALSE );
01314     <a class="code" href="class_q_text_edit.html#b2">placeCursor</a>( e-&gt;pos(),  cursor );
01315     drawCursor( TRUE );
01316     <a class="code" href="class_q_text_edit.html#a14">insert</a>( text, FALSE, TRUE, FALSE );
01317     }
01318 }
01319 
01320 <font class="preprocessor">#endif</font>
01321 <font class="preprocessor"></font>
01322 <font class="preprocessor">#if 0 // QT2HACK</font>
01323 <font class="preprocessor"></font>
01324 <font class="keywordtype">void</font> QTextView::contentsContextMenuEvent( QContextMenuEvent *e )
01325 {
01326     clearUndoRedo();
01327 
01328     e-&gt;accept();
01329     <font class="keywordflow">if</font> ( !isReadOnly() ) {
01330     QPopupMenu *popup = createPopupMenu();
01331     <font class="keywordtype">int</font> r = popup-&gt;exec( e-&gt;globalPos() );
01332     <font class="keyword">delete</font> popup;
01333 
01334     <font class="keywordflow">if</font> ( r == d-&gt;id[ IdClear ] )
01335         <a class="code" href="class_q_text_edit.html#g6">clear</a>();
01336     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( r == d-&gt;id[ IdSelectAll ] )
01337         selectAll();
01338     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( r == d-&gt;id[ IdUndo ] )
01339         <a class="code" href="class_q_text_edit.html#g1">undo</a>();
01340     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( r == d-&gt;id[ IdRedo ] )
01341         <a class="code" href="class_q_text_edit.html#g2">redo</a>();
01342 <font class="preprocessor">#ifndef QT_NO_CLIPBOARD</font>
01343 <font class="preprocessor"></font>    <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( r == d-&gt;id[ IdCut ] )
01344         <a class="code" href="class_q_text_edit.html#g3">cut</a>();
01345     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( r == d-&gt;id[ IdCopy ] )
01346         copy();
01347     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( r == d-&gt;id[ IdPaste ] )
01348         <a class="code" href="class_q_text_edit.html#g4">paste</a>();
01349 <font class="preprocessor">#endif</font>
01350 <font class="preprocessor"></font>    }
01351 }
01352 <font class="preprocessor">#endif</font>
01353 <font class="preprocessor"></font>
01354 <font class="keywordtype">void</font> QTextView::doAutoScroll()
01355 {
01356     <font class="keywordflow">if</font> ( !mousePressed )
01357     <font class="keywordflow">return</font>;
01358 
01359     QPoint pos( mapFromGlobal( QCursor::pos() ) );
01360     drawCursor( FALSE );
01361     QTextCursor oldCursor = *cursor;
01362     <a class="code" href="class_q_text_edit.html#b2">placeCursor</a>( viewportToContents( pos ) );
01363     <font class="keywordflow">if</font> ( inDoubleClick ) {
01364     QTextCursor cl = *cursor;
01365     cl.gotoWordLeft();
01366     QTextCursor cr = *cursor;
01367     cr.gotoWordRight();
01368 
01369     <font class="keywordtype">int</font> diff = QABS( oldCursor.parag()-&gt;at( oldCursor.index() )-&gt;x - mousePos.x() );
01370     <font class="keywordtype">int</font> ldiff = QABS( cl.parag()-&gt;at( cl.index() )-&gt;x - mousePos.x() );
01371     <font class="keywordtype">int</font> rdiff = QABS( cr.parag()-&gt;at( cr.index() )-&gt;x - mousePos.x() );
01372 
01373 
01374     <font class="keywordflow">if</font> ( cursor-&gt;parag()-&gt;lineStartOfChar( cursor-&gt;index() ) !=
01375          oldCursor.parag()-&gt;lineStartOfChar( oldCursor.index() ) )
01376         diff = 0xFFFFFF;
01377 
01378     <font class="keywordflow">if</font> ( rdiff &lt; diff &amp;&amp; rdiff &lt; ldiff )
01379         *cursor = cr;
01380     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( ldiff &lt; diff &amp;&amp; ldiff &lt; rdiff )
01381         *cursor = cl;
01382     <font class="keywordflow">else</font>
01383         *cursor = oldCursor;
01384 
01385     }
01386     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
01387 
01388     <font class="keywordtype">bool</font> redraw = FALSE;
01389     <font class="keywordflow">if</font> ( doc-&gt;hasSelection( QTextDocument::Standard ) ) {
01390     redraw = doc-&gt;setSelectionEnd( QTextDocument::Standard, cursor ) || redraw;
01391     }
01392 
01393     <font class="keywordflow">if</font> ( !redraw ) {
01394     drawCursor( TRUE );
01395     } <font class="keywordflow">else</font> {
01396     repaintChanged();
01397     drawCursor( TRUE );
01398     }
01399 
01400     <font class="keywordflow">if</font> ( !scrollTimer-&gt;isActive() &amp;&amp; pos.y() &lt; 0 || pos.y() &gt; height() )
01401     scrollTimer-&gt;start( 100, FALSE );
01402     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( scrollTimer-&gt;isActive() &amp;&amp; pos.y() &gt;= 0 &amp;&amp; pos.y() &lt;= height() )
01403     scrollTimer-&gt;stop();
01404 }
01405 
01406 <font class="keywordtype">void</font> QTextView::placeCursor( <font class="keyword">const</font> QPoint &amp;pos, QTextCursor *c )
01407 {
01408     <font class="keywordflow">if</font> ( !c )
01409     c = cursor;
01410 
01411     c-&gt;restoreState();
01412     QTextParag *s = doc-&gt;firstParag();
01413     c-&gt;place( pos,  s );
01414     <font class="keywordflow">if</font> ( hasFocus() || viewport()-&gt;hasFocus() ) {
01415     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
01416     QFont f = cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;font();
01417     setMicroFocusHint( cursor-&gt;x() - contentsX() + frameWidth(),
01418                cursor-&gt;y() + cursor-&gt;parag()-&gt;rect().y() - contentsY() + frameWidth(), 0, h, TRUE<font class="comment">/*, &amp;f*/</font> ); <font class="comment">// QT2HACK</font>
01419     }
01420 }
01421 
01422 <font class="keywordtype">void</font> QTextView::formatMore()
01423 {
01424     <font class="keywordflow">if</font> ( !lastFormatted )
01425     <font class="keywordflow">return</font>;
01426 
01427     <font class="keywordtype">int</font> bottom = contentsHeight();
01428     <font class="keywordtype">int</font> lastBottom = -1;
01429     <font class="keywordtype">int</font> to = !sender() ? 2 : 20;
01430     <font class="keywordtype">bool</font> firstVisible = FALSE;
01431     QRect cr( contentsX(), contentsY(), visibleWidth(), visibleHeight() );
01432     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; ( i &lt; to || firstVisible ) &amp;&amp; lastFormatted; ++i ) {
01433     lastFormatted-&gt;format();
01434     <font class="keywordflow">if</font> ( i == 0 )
01435         firstVisible = lastFormatted-&gt;rect().intersects( cr );
01436     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( firstVisible )
01437         firstVisible = lastFormatted-&gt;rect().intersects( cr );
01438     bottom = QMAX( bottom, lastFormatted-&gt;rect().top() +
01439                lastFormatted-&gt;rect().height() );
01440     lastBottom = lastFormatted-&gt;rect().top() + lastFormatted-&gt;rect().height();
01441     lastFormatted = lastFormatted-&gt;next();
01442     <font class="keywordflow">if</font> ( lastFormatted )
01443         lastBottom = -1;
01444     }
01445 
01446     <font class="keywordflow">if</font> ( bottom &gt; contentsHeight() &amp;&amp; !cursor-&gt;document()-&gt;parent() )
01447     resizeContents( contentsWidth(), QMAX( doc-&gt;height(), bottom ) );
01448     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( lastBottom != -1 &amp;&amp; lastBottom &lt; contentsHeight() &amp;&amp; !cursor-&gt;document()-&gt;parent() )
01449     resizeContents( contentsWidth(), QMAX( doc-&gt;height(), lastBottom ) );
01450 
01451     <font class="keywordflow">if</font> ( lastFormatted )
01452     formatTimer-&gt;start( interval, TRUE );
01453     <font class="keywordflow">else</font>
01454     interval = QMAX( 0, interval );
01455 }
01456 
01457 <font class="keywordtype">void</font> QTextView::doResize()
01458 {
01459     <font class="keywordflow">if</font> ( wrapMode != WidgetWidth )
01460     <font class="keywordflow">return</font>;
01461     doc-&gt;setMinimumWidth( -1, 0 );
01462     resizeContents( width() - verticalScrollBar()-&gt;width(), contentsHeight() );
01463     QScrollView::setHScrollBarMode( AlwaysOff );
01464     doc-&gt;setWidth( visibleWidth() );
01465     wrapWidth = visibleWidth();
01466     doc-&gt;invalidate();
01467     viewport()-&gt;repaint( FALSE );
01468     lastFormatted = doc-&gt;firstParag();
01469     interval = 0;
01470     formatMore();
01471 }
01472 
01473 <font class="comment">/* \internal */</font>
01474 
01475 <font class="keywordtype">void</font> QTextView::doChangeInterval()
01476 {
01477     interval = 0;
01478 }
01479 
01482 <font class="keywordtype">bool</font> QTextView::eventFilter( QObject *o, QEvent *e )
01483 {
01484     <font class="keywordflow">if</font> ( !o || !e )
01485     <font class="keywordflow">return</font> TRUE;
01486 
01487     <font class="keywordflow">if</font> ( o == <font class="keyword">this</font> || o == viewport() ) {
01488     <font class="keywordflow">if</font> ( e-&gt;type() == QEvent::FocusIn ) {
01489         blinkTimer-&gt;start( QApplication::cursorFlashTime() / 2 );
01490         <font class="keywordflow">return</font> TRUE;
01491     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( e-&gt;type() == QEvent::FocusOut ) {
01492         blinkTimer-&gt;stop();
01493         drawCursor( FALSE );
01494         <font class="keywordflow">return</font> TRUE;
01495     }
01496     }
01497 
01498     <font class="keywordflow">return</font> QScrollView::eventFilter( o, e );
01499 }
01500 
01501 <font class="keywordtype">void</font> QTextView::insert( <font class="keyword">const</font> QString &amp;text, <font class="keywordtype">bool</font> indent, <font class="keywordtype">bool</font> checkNewLine, <font class="keywordtype">bool</font> removeSelected )
01502 {
01503     <font class="keywordflow">if</font> ( cursor-&gt;nestedDepth() != 0 ) <font class="comment">// #### for 3.0, disable editing of tables as this is not advanced enough</font>
01504     <font class="keywordflow">return</font>;
01505     QTextCursor c2 = *cursor;
01506     QString txt( text );
01507     drawCursor( FALSE );
01508     <font class="keywordflow">if</font> ( !isReadOnly() &amp;&amp; doc-&gt;hasSelection( QTextDocument::Standard ) &amp;&amp; removeSelected ) {
01509     checkUndoRedoInfo( UndoRedoInfo::RemoveSelected );
01510     <font class="keywordflow">if</font> ( !undoRedoInfo.valid() ) {
01511         doc-&gt;selectionStart( QTextDocument::Standard, undoRedoInfo.id, undoRedoInfo.index );
01512         undoRedoInfo.d-&gt;text = QString::null;
01513     }
01514     undoRedoInfo.d-&gt;text = doc-&gt;selectedText( QTextDocument::Standard );
01515     doc-&gt;removeSelectedText( QTextDocument::Standard, cursor );
01516     }
01517     checkUndoRedoInfo( UndoRedoInfo::Insert );
01518     <font class="keywordflow">if</font> ( !undoRedoInfo.valid() ) {
01519     undoRedoInfo.id = cursor-&gt;parag()-&gt;paragId();
01520     undoRedoInfo.index = cursor-&gt;index();
01521     undoRedoInfo.d-&gt;text = QString::null;
01522     }
01523     <font class="keywordtype">int</font> oldLen = undoRedoInfo.d-&gt;text.length();
01524     lastFormatted = checkNewLine &amp;&amp; cursor-&gt;parag()-&gt;prev() ?
01525             cursor-&gt;parag()-&gt;prev() : cursor-&gt;parag();
01526     <font class="keywordtype">int</font> idx = cursor-&gt;index();
01527     QTextCursor oldCursor = *cursor;
01528     cursor-&gt;insert( txt, checkNewLine );
01529     <font class="keywordflow">if</font> ( doc-&gt;useFormatCollection() )
01530     cursor-&gt;parag()-&gt;setFormat( idx, txt.length(), currentFormat, TRUE );
01531 
01532     <font class="keywordflow">if</font> ( <a class="code" href="class_q_text_edit.html#g8">indent</a> &amp;&amp; ( txt == <font class="stringliteral">"{"</font> || txt == <font class="stringliteral">"}"</font> ) )
01533     cursor-&gt;indent();
01534     formatMore();
01535     repaintChanged();
01536     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
01537     drawCursor( TRUE );
01538     undoRedoInfo.d-&gt;text += txt;
01539 
01540     <font class="keywordflow">if</font> ( !doc-&gt;preProcessor() ) {
01541     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)txt.length(); ++i ) {
01542         <font class="keywordflow">if</font> ( txt[ i ] == <font class="charliteral">'\n'</font> )
01543         <font class="keywordflow">continue</font>;
01544         <font class="keywordflow">if</font> ( c2.parag()-&gt;at( c2.index() )-&gt;format() ) {
01545         c2.parag()-&gt;at( c2.index() )-&gt;format()-&gt;addRef();
01546         undoRedoInfo.d-&gt;text.setFormat( oldLen + i, c2.parag()-&gt;at( c2.index() )-&gt;format(), TRUE );
01547         }
01548         c2.gotoRight();
01549     }
01550     }
01551 
01552     emit textChanged();
01553     <font class="keywordflow">if</font> ( !removeSelected ) {
01554     doc-&gt;setSelectionStart( QTextDocument::Standard, &amp;oldCursor );
01555     doc-&gt;setSelectionEnd( QTextDocument::Standard, cursor );
01556     repaintChanged();
01557     }
01558     <font class="keywordflow">if</font> ( hasFocus() || viewport()-&gt;hasFocus() ) {
01559     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
01560     QFont f = cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;font();
01561     setMicroFocusHint( cursor-&gt;x() - contentsX() + frameWidth(),
01562                cursor-&gt;y() + cursor-&gt;parag()-&gt;rect().y() - contentsY() + frameWidth(), 0, h, TRUE<font class="comment">/*, &amp;f*/</font> ); <font class="comment">// QT2HACK</font>
01563     }
01564 }
01565 
01566 <font class="keywordtype">void</font> QTextView::undo()
01567 {
01568     <font class="keywordflow">if</font> ( isReadOnly() )
01569     <font class="keywordflow">return</font>;
01570 
01571     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)doc-&gt;numSelections(); ++i )
01572     doc-&gt;removeSelection( i );
01573 
01574 <font class="preprocessor">#ifndef QT_NO_CURSOR</font>
01575 <font class="preprocessor"></font>    viewport()-&gt;setCursor( isReadOnly() ? arrowCursor : ibeamCursor );
01576 <font class="preprocessor">#endif</font>
01577 <font class="preprocessor"></font>
01578     clearUndoRedo();
01579     drawCursor( FALSE );
01580     QTextCursor *c = doc-&gt;undo( cursor );
01581     <font class="keywordflow">if</font> ( !c ) {
01582     drawCursor( TRUE );
01583     <font class="keywordflow">return</font>;
01584     }
01585     lastFormatted = 0;
01586     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
01587     repaintChanged();
01588     drawCursor( TRUE );
01589     emit textChanged();
01590     <font class="keywordflow">if</font> ( hasFocus() || viewport()-&gt;hasFocus() ) {
01591     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
01592     QFont f = cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;font();
01593     setMicroFocusHint( cursor-&gt;x() - contentsX() + frameWidth(),
01594                cursor-&gt;y() + cursor-&gt;parag()-&gt;rect().y() - contentsY() + frameWidth(), 0, h, TRUE<font class="comment">/*, &amp;f*/</font> ); <font class="comment">// QT2HACK</font>
01595     }
01596 }
01597 
01598 <font class="keywordtype">void</font> QTextView::redo()
01599 {
01600     <font class="keywordflow">if</font> ( isReadOnly() )
01601     <font class="keywordflow">return</font>;
01602 
01603     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)doc-&gt;numSelections(); ++i )
01604     doc-&gt;removeSelection( i );
01605 
01606 <font class="preprocessor">#ifndef QT_NO_CURSOR</font>
01607 <font class="preprocessor"></font>    viewport()-&gt;setCursor( isReadOnly() ? arrowCursor : ibeamCursor );
01608 <font class="preprocessor">#endif</font>
01609 <font class="preprocessor"></font>
01610     clearUndoRedo();
01611     drawCursor( FALSE );
01612     QTextCursor *c = doc-&gt;redo( cursor );
01613     <font class="keywordflow">if</font> ( !c ) {
01614     drawCursor( TRUE );
01615     <font class="keywordflow">return</font>;
01616     }
01617     lastFormatted = 0;
01618     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
01619     repaintChanged();
01620     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
01621     drawCursor( TRUE );
01622     emit textChanged();
01623     <font class="keywordflow">if</font> ( hasFocus() || viewport()-&gt;hasFocus() ) {
01624     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
01625     QFont f = cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;font();
01626     setMicroFocusHint( cursor-&gt;x() - contentsX() + frameWidth(),
01627                cursor-&gt;y() + cursor-&gt;parag()-&gt;rect().y() - contentsY() + frameWidth(), 0, h, TRUE<font class="comment">/*, &amp;f*/</font> ); <font class="comment">// QT2HACK</font>
01628     }
01629 }
01630 
01631 <font class="keywordtype">void</font> QTextView::paste()
01632 {
01633 <font class="preprocessor">#ifndef QT_NO_CLIPBOARD</font>
01634 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( isReadOnly() )
01635     <font class="keywordflow">return</font>;
01636     <a class="code" href="class_q_text_edit.html#g5">pasteSubType</a>( <font class="stringliteral">"plain"</font> );
01637     <font class="keywordflow">if</font> ( hasFocus() || viewport()-&gt;hasFocus() ) {
01638     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
01639     QFont f = cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;font();
01640     setMicroFocusHint( cursor-&gt;x() - contentsX() + frameWidth(),
01641                cursor-&gt;y() + cursor-&gt;parag()-&gt;rect().y() - contentsY() + frameWidth(), 0, h, TRUE<font class="comment">/*, &amp;f*/</font> ); <font class="comment">// QT2HACK</font>
01642     }
01643 <font class="preprocessor">#endif</font>
01644 <font class="preprocessor"></font>}
01645 
01646 <font class="keywordtype">void</font> QTextView::checkUndoRedoInfo( UndoRedoInfo::Type t )
01647 {
01648     <font class="keywordflow">if</font> ( undoRedoInfo.valid() &amp;&amp; t != undoRedoInfo.type ) {
01649     clearUndoRedo();
01650     }
01651     undoRedoInfo.type = t;
01652 }
01653 
01660 <font class="keywordtype">void</font> QTextView::repaintChanged()
01661 {
01662     QPainter p( viewport() );
01663     p.translate( -contentsX(), -contentsY() );
01664     paintDocument( FALSE, &amp;p, contentsX(), contentsY(), visibleWidth(), visibleHeight() );
01665 }
01666 
01667 <font class="keywordtype">void</font> QTextView::cut()
01668 {
01669     <font class="keywordflow">if</font> ( isReadOnly() )
01670     <font class="keywordflow">return</font>;
01671 
01672     <font class="keywordflow">if</font> ( doc-&gt;hasSelection( QTextDocument::Standard ) ) {
01673     doc-&gt;copySelectedText( QTextDocument::Standard );
01674     <a class="code" href="class_q_text_edit.html#g24">removeSelectedText</a>();
01675     }
01676     <font class="keywordflow">if</font> ( hasFocus() || viewport()-&gt;hasFocus() ) {
01677     <font class="keywordtype">int</font> h = cursor-&gt;parag()-&gt;lineHeightOfChar( cursor-&gt;index() );
01678     QFont f = cursor-&gt;parag()-&gt;at( cursor-&gt;index() )-&gt;format()-&gt;font();
01679     setMicroFocusHint( cursor-&gt;x() - contentsX() + frameWidth(),
01680                cursor-&gt;y() + cursor-&gt;parag()-&gt;rect().y() - contentsY() + frameWidth(), 0, h, TRUE<font class="comment">/*, &amp;f*/</font> ); <font class="comment">// QT2HACK</font>
01681     }
01682 }
01683 
01689 <font class="keywordtype">void</font> QTextView::copy()
01690 {
01691     <font class="keywordflow">if</font> ( !doc-&gt;selectedText( QTextDocument::Standard ).isEmpty() )
01692     doc-&gt;copySelectedText( QTextDocument::Standard );
01693 }
01694 
01695 <font class="keywordtype">void</font> QTextView::indent()
01696 {
01697     <font class="keywordflow">if</font> ( isReadOnly() )
01698     <font class="keywordflow">return</font>;
01699 
01700     drawCursor( FALSE );
01701     <font class="keywordflow">if</font> ( !doc-&gt;hasSelection( QTextDocument::Standard ) )
01702     cursor-&gt;indent();
01703     <font class="keywordflow">else</font>
01704     doc-&gt;indentSelection( QTextDocument::Standard );
01705     repaintChanged();
01706     drawCursor( TRUE );
01707     emit textChanged();
01708 }
01709 
01713 <font class="keywordtype">bool</font> QTextView::focusNextPrevChild( <font class="keywordtype">bool</font> n )
01714 {
01715     <font class="keywordflow">if</font> ( !isReadOnly() || !linksEnabled() )
01716     <font class="keywordflow">return</font> FALSE;
01717     <font class="keywordtype">bool</font> b = doc-&gt;focusNextPrevChild( n );
01718     <font class="keywordflow">if</font> ( b ) {
01719     repaintChanged();
01720     makeParagVisible( doc-&gt;focusIndicator.parag );
01721     }
01722     <font class="keywordflow">return</font> b;
01723 }
01724 
01725 <font class="keywordtype">void</font> QTextView::setFormat( QTextFormat *f, <font class="keywordtype">int</font> flags )
01726 {
01727     <font class="keywordflow">if</font> ( isReadOnly() )
01728     <font class="keywordflow">return</font>;
01729 
01730     <font class="keywordflow">if</font> ( doc-&gt;hasSelection( QTextDocument::Standard ) ) {
01731     drawCursor( FALSE );
01732     QString str = doc-&gt;selectedText( QTextDocument::Standard );
01733     QTextCursor c1 = doc-&gt;selectionStartCursor( QTextDocument::Standard );
01734     QTextCursor c2 = doc-&gt;selectionEndCursor( QTextDocument::Standard );
01735     clearUndoRedo();
01736     undoRedoInfo.type = UndoRedoInfo::Format;
01737     undoRedoInfo.id = c1.parag()-&gt;paragId();
01738     undoRedoInfo.index = c1.index();
01739     undoRedoInfo.eid = c2.parag()-&gt;paragId();
01740     undoRedoInfo.eindex = c2.index();
01741     undoRedoInfo.d-&gt;text = str;
01742     readFormats( c1, c2, 0, undoRedoInfo.d-&gt;text );
01743     undoRedoInfo.format = f;
01744     undoRedoInfo.flags = flags;
01745     clearUndoRedo();
01746     doc-&gt;setFormat( QTextDocument::Standard, f, flags );
01747     repaintChanged();
01748     formatMore();
01749     drawCursor( TRUE );
01750     emit textChanged();
01751     }
01752     <font class="keywordflow">if</font> ( currentFormat &amp;&amp; currentFormat-&gt;key() != f-&gt;key() ) {
01753     currentFormat-&gt;removeRef();
01754     currentFormat = doc-&gt;formatCollection()-&gt;format( f );
01755     <font class="keywordflow">if</font> ( currentFormat-&gt;isMisspelled() ) {
01756         currentFormat-&gt;removeRef();
01757         currentFormat = doc-&gt;formatCollection()-&gt;format( currentFormat-&gt;font(), currentFormat-&gt;color() );
01758     }
01759     emitCurrentFontChanged( currentFormat-&gt;font() );
01760     emitCurrentColorChanged( currentFormat-&gt;color() );
01761     <font class="keywordflow">if</font> ( cursor-&gt;index() == cursor-&gt;parag()-&gt;length() - 1 ) {
01762         currentFormat-&gt;addRef();
01763         cursor-&gt;parag()-&gt;string()-&gt;setFormat( cursor-&gt;index(), currentFormat, TRUE );
01764     }
01765     }
01766 }
01767 
01770 <font class="keywordtype">void</font> QTextView::setPalette( <font class="keyword">const</font> QPalette &amp;p )
01771 {
01772     QScrollView::setPalette( p );
01773     <font class="keywordflow">if</font> ( textFormat() == PlainText ) {
01774     QTextFormat *f = doc-&gt;formatCollection()-&gt;defaultFormat();
01775     f-&gt;setColor( colorGroup().text() );
01776     viewport()-&gt;repaint( FALSE );
01777     }
01778 }
01779 
01780 <font class="keywordtype">void</font> QTextView::setParagType( QStyleSheetItem::DisplayMode dm, QStyleSheetItem::ListStyle listStyle )
01781 {
01782     <font class="keywordflow">if</font> ( isReadOnly() )
01783     <font class="keywordflow">return</font>;
01784 
01785     drawCursor( FALSE );
01786     <font class="keywordflow">if</font> ( !doc-&gt;hasSelection( QTextDocument::Standard ) ) {
01787     clearUndoRedo();
01788     undoRedoInfo.type = UndoRedoInfo::ParagType;
01789     QValueList&lt; QVector&lt;QStyleSheetItem&gt; &gt; oldStyles;
01790     undoRedoInfo.oldStyles.clear();
01791     undoRedoInfo.oldStyles &lt;&lt; cursor-&gt;parag()-&gt;styleSheetItems();
01792     undoRedoInfo.oldListStyles.clear();
01793     undoRedoInfo.oldListStyles &lt;&lt; cursor-&gt;parag()-&gt;listStyle();
01794     undoRedoInfo.list = dm == QStyleSheetItem::DisplayListItem;
01795     undoRedoInfo.listStyle = listStyle;
01796     undoRedoInfo.id = cursor-&gt;parag()-&gt;paragId();
01797     undoRedoInfo.eid = cursor-&gt;parag()-&gt;paragId();
01798     undoRedoInfo.d-&gt;text = <font class="stringliteral">" "</font>;
01799     undoRedoInfo.index = 1;
01800     clearUndoRedo();
01801     cursor-&gt;parag()-&gt;setList( dm == QStyleSheetItem::DisplayListItem, listStyle );
01802     repaintChanged();
01803     } <font class="keywordflow">else</font> {
01804     QTextParag *start = doc-&gt;selectionStart( QTextDocument::Standard );
01805     QTextParag *end = doc-&gt;selectionEnd( QTextDocument::Standard );
01806     lastFormatted = start;
01807     clearUndoRedo();
01808     undoRedoInfo.type = UndoRedoInfo::ParagType;
01809     undoRedoInfo.id = start-&gt;paragId();
01810     undoRedoInfo.eid = end-&gt;paragId();
01811     undoRedoInfo.list = dm == QStyleSheetItem::DisplayListItem;
01812     undoRedoInfo.listStyle = listStyle;
01813     undoRedoInfo.oldStyles.clear();
01814     undoRedoInfo.oldListStyles.clear();
01815     <font class="keywordflow">while</font> ( start ) {
01816         undoRedoInfo.oldStyles &lt;&lt; start-&gt;styleSheetItems();
01817         undoRedoInfo.oldListStyles &lt;&lt; start-&gt;listStyle();
01818         start-&gt;setList( dm == QStyleSheetItem::DisplayListItem, listStyle );
01819         <font class="keywordflow">if</font> ( start == end )
01820         <font class="keywordflow">break</font>;
01821         start = start-&gt;next();
01822     }
01823     undoRedoInfo.d-&gt;text = <font class="stringliteral">" "</font>;
01824     undoRedoInfo.index = 1;
01825     clearUndoRedo();
01826     repaintChanged();
01827     formatMore();
01828     }
01829     drawCursor( TRUE );
01830     emit textChanged();
01831 }
01832 
01833 <font class="keywordtype">void</font> QTextView::setAlignment( <font class="keywordtype">int</font> a )
01834 {
01835     <font class="keywordflow">if</font> ( isReadOnly() || block_set_alignment )
01836     <font class="keywordflow">return</font>;
01837 
01838     drawCursor( FALSE );
01839     <font class="keywordflow">if</font> ( !doc-&gt;hasSelection( QTextDocument::Standard ) ) {
01840     <font class="keywordflow">if</font> ( cursor-&gt;parag()-&gt;alignment() != a ) {
01841         clearUndoRedo();
01842         undoRedoInfo.type = UndoRedoInfo::Alignment;
01843         QArray&lt;int&gt; oa( 1 );
01844         oa[ 0 ] = cursor-&gt;parag()-&gt;alignment();
01845         undoRedoInfo.oldAligns = oa;
01846         undoRedoInfo.newAlign = a;
01847         undoRedoInfo.id = cursor-&gt;parag()-&gt;paragId();
01848         undoRedoInfo.eid = cursor-&gt;parag()-&gt;paragId();
01849         undoRedoInfo.d-&gt;text = <font class="stringliteral">" "</font>;
01850         undoRedoInfo.index = 1;
01851         clearUndoRedo();
01852         cursor-&gt;parag()-&gt;setAlignment( a );
01853         repaintChanged();
01854     }
01855     } <font class="keywordflow">else</font> {
01856     QTextParag *start = doc-&gt;selectionStart( QTextDocument::Standard );
01857     QTextParag *end = doc-&gt;selectionEnd( QTextDocument::Standard );
01858     lastFormatted = start;
01859     <font class="keywordtype">int</font> len = end-&gt;paragId() - start-&gt;paragId() + 1;
01860     clearUndoRedo();
01861     undoRedoInfo.type = UndoRedoInfo::Alignment;
01862     undoRedoInfo.id = start-&gt;paragId();
01863     undoRedoInfo.eid = end-&gt;paragId();
01864     QArray&lt;int&gt; oa( QMAX( 0, len ) );
01865     <font class="keywordtype">int</font> i = 0;
01866     <font class="keywordflow">while</font> ( start ) {
01867         <font class="keywordflow">if</font> ( i &lt; (int)oa.size() )
01868         oa[ i ] = start-&gt;alignment();
01869         start-&gt;setAlignment( a );
01870         <font class="keywordflow">if</font> ( start == end )
01871         <font class="keywordflow">break</font>;
01872         start = start-&gt;next();
01873         ++i;
01874     }
01875     undoRedoInfo.oldAligns = oa;
01876     undoRedoInfo.newAlign = a;
01877     undoRedoInfo.d-&gt;text = <font class="stringliteral">" "</font>;
01878     undoRedoInfo.index = 1;
01879     clearUndoRedo();
01880     repaintChanged();
01881     formatMore();
01882     }
01883     drawCursor( TRUE );
01884     <font class="keywordflow">if</font> ( currentAlignment != a ) {
01885     currentAlignment = a;
01886     emitCurrentAlignmentChanged( currentAlignment );
01887     }
01888     emit textChanged();
01889 }
01890 
01891 <font class="keywordtype">void</font> QTextView::updateCurrentFormat()
01892 {
01893     <font class="keywordtype">int</font> i = cursor-&gt;index();
01894     <font class="keywordflow">if</font> ( i &gt; 0 )
01895     --i;
01896     <font class="keywordflow">if</font> ( currentFormat-&gt;key() != cursor-&gt;parag()-&gt;at( i )-&gt;format()-&gt;key() &amp;&amp; doc-&gt;useFormatCollection() ) {
01897     <font class="keywordflow">if</font> ( currentFormat )
01898         currentFormat-&gt;removeRef();
01899     currentFormat = doc-&gt;formatCollection()-&gt;format( cursor-&gt;parag()-&gt;at( i )-&gt;format() );
01900     <font class="keywordflow">if</font> ( currentFormat-&gt;isMisspelled() ) {
01901         currentFormat-&gt;removeRef();
01902         currentFormat = doc-&gt;formatCollection()-&gt;format( currentFormat-&gt;font(), currentFormat-&gt;color() );
01903     }
01904     emitCurrentFontChanged( currentFormat-&gt;font() );
01905     emitCurrentColorChanged( currentFormat-&gt;color() );
01906     }
01907 
01908     <font class="keywordflow">if</font> ( currentAlignment != cursor-&gt;parag()-&gt;alignment() ) {
01909     currentAlignment = cursor-&gt;parag()-&gt;alignment();
01910     block_set_alignment = TRUE;
01911     emitCurrentAlignmentChanged( currentAlignment );
01912     block_set_alignment = FALSE;
01913     }
01914 }
01915 
01916 <font class="keywordtype">void</font> QTextView::setItalic( <font class="keywordtype">bool</font> b )
01917 {
01918     QTextFormat f( *currentFormat );
01919     f.setItalic( b );
01920     <a class="code" href="class_q_text_edit.html#b0">setFormat</a>( &amp;f, QTextFormat::Italic );
01921 }
01922 
01923 <font class="keywordtype">void</font> QTextView::setBold( <font class="keywordtype">bool</font> b )
01924 {
01925     QTextFormat f( *currentFormat );
01926     f.setBold( b );
01927     <a class="code" href="class_q_text_edit.html#b0">setFormat</a>( &amp;f, QTextFormat::Bold );
01928 }
01929 
01930 <font class="keywordtype">void</font> QTextView::setUnderline( <font class="keywordtype">bool</font> b )
01931 {
01932     QTextFormat f( *currentFormat );
01933     f.setUnderline( b );
01934     <a class="code" href="class_q_text_edit.html#b0">setFormat</a>( &amp;f, QTextFormat::Underline );
01935 }
01936 
01937 <font class="keywordtype">void</font> QTextView::setFamily( <font class="keyword">const</font> QString &amp;f_ )
01938 {
01939     QTextFormat f( *currentFormat );
01940     f.setFamily( f_ );
01941     <a class="code" href="class_q_text_edit.html#b0">setFormat</a>( &amp;f, QTextFormat::Family );
01942 }
01943 
01944 <font class="keywordtype">void</font> QTextView::setPointSize( <font class="keywordtype">int</font> s )
01945 {
01946     QTextFormat f( *currentFormat );
01947     f.setPointSize( s );
01948     <a class="code" href="class_q_text_edit.html#b0">setFormat</a>( &amp;f, QTextFormat::Size );
01949 }
01950 
01951 <font class="keywordtype">void</font> QTextView::setColor( <font class="keyword">const</font> QColor &amp;c )
01952 {
01953     QTextFormat f( *currentFormat );
01954     f.setColor( c );
01955     <a class="code" href="class_q_text_edit.html#b0">setFormat</a>( &amp;f, QTextFormat::Color );
01956 }
01957 
01958 <font class="keywordtype">void</font> QTextView::setFontInternal( <font class="keyword">const</font> QFont &amp;f_ )
01959 {
01960     QTextFormat f( *currentFormat );
01961     f.setFont( f_ );
01962     <a class="code" href="class_q_text_edit.html#b0">setFormat</a>( &amp;f, QTextFormat::Font );
01963 }
01964 
01976 QString QTextView::text()<font class="keyword"> const</font>
01977 <font class="keyword"></font>{
01978     <font class="keywordflow">if</font> ( isReadOnly() )
01979     <font class="keywordflow">return</font> doc-&gt;originalText();
01980     <font class="keywordflow">return</font> doc-&gt;text();
01981 }
01982 
01990 QString QTextView::text( <font class="keywordtype">int</font> para )<font class="keyword"> const</font>
01991 <font class="keyword"></font>{
01992     <font class="keywordflow">return</font> doc-&gt;text( para );
01993 }
01994 
02010 <font class="keywordtype">void</font> QTextView::setText( <font class="keyword">const</font> QString &amp;text, <font class="keyword">const</font> QString &amp;context )
02011 {
02012     emitUndoAvailable( FALSE );
02013     emitRedoAvailable( FALSE );
02014     undoRedoInfo.clear();
02015     doc-&gt;commands()-&gt;clear();
02016 
02017     lastFormatted = 0;
02018     cursor-&gt;restoreState();
02019     doc-&gt;setText( text, context );
02020     doc-&gt;setMinimumWidth( -1, 0 );
02021     resizeContents( 0, 0 );
02022     cursor-&gt;setDocument( doc );
02023     cursor-&gt;setParag( doc-&gt;firstParag() );
02024     cursor-&gt;setIndex( 0 );
02025 
02026     <font class="keywordflow">if</font> ( qApp-&gt;font().pointSize() != QScrollView::font().pointSize() )
02027     <a class="code" href="class_q_text_edit.html#g15">setFont</a>( QScrollView::font() );
02028 
02029     viewport()-&gt;repaint( FALSE );
02030     emit textChanged();
02031     formatMore();
02032     updateCurrentFormat();
02033 }
02034 
02035 
02056 <font class="keywordtype">bool</font> QTextView::find( <font class="keyword">const</font> QString &amp;expr, <font class="keywordtype">bool</font> cs, <font class="keywordtype">bool</font> wo, <font class="keywordtype">bool</font> forward,
02057               <font class="keywordtype">int</font> *para, <font class="keywordtype">int</font> *index )
02058 {
02059     drawCursor( FALSE );
02060     doc-&gt;removeSelection( QTextDocument::Standard );
02061 <font class="preprocessor">#ifndef QT_NO_CURSOR</font>
02062 <font class="preprocessor"></font>    viewport()-&gt;setCursor( isReadOnly() ? arrowCursor : ibeamCursor );
02063 <font class="preprocessor">#endif</font>
02064 <font class="preprocessor"></font>    <font class="keywordtype">bool</font> found = doc-&gt;find( expr, cs, wo, forward, para, index, cursor );
02065     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
02066     drawCursor( TRUE );
02067     repaintChanged();
02068     <font class="keywordflow">return</font> found;
02069 }
02070 
02071 <font class="keywordtype">void</font> QTextView::blinkCursor()
02072 {
02073     <font class="keywordflow">if</font> ( !cursorVisible )
02074     <font class="keywordflow">return</font>;
02075     <font class="keywordtype">bool</font> cv = cursorVisible;
02076     blinkCursorVisible = !blinkCursorVisible;
02077     drawCursor( blinkCursorVisible );
02078     cursorVisible = cv;
02079 }
02080 
02081 <font class="keywordtype">void</font> QTextView::setCursorPosition( <font class="keywordtype">int</font> parag, <font class="keywordtype">int</font> index )
02082 {
02083     QTextParag *p = doc-&gt;paragAt( parag );
02084     <font class="keywordflow">if</font> ( !p )
02085     <font class="keywordflow">return</font>;
02086 
02087     <font class="keywordflow">if</font> ( index &gt; p-&gt;length() - 1 )
02088     index = p-&gt;length() - 1;
02089 
02090     drawCursor( FALSE );
02091     cursor-&gt;setParag( p );
02092     cursor-&gt;setIndex( index );
02093     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
02094     drawCursor( TRUE );
02095 }
02096 
02097 <font class="keywordtype">void</font> QTextView::getCursorPosition( <font class="keywordtype">int</font> &amp;parag, <font class="keywordtype">int</font> &amp;index )<font class="keyword"> const</font>
02098 <font class="keyword"></font>{
02099     parag = cursor-&gt;parag()-&gt;paragId();
02100     index = cursor-&gt;index();
02101 }
02102 
02103 <font class="keywordtype">void</font> QTextView::setSelection( <font class="keywordtype">int</font> parag_from, <font class="keywordtype">int</font> index_from,
02104                   <font class="keywordtype">int</font> parag_to, <font class="keywordtype">int</font> index_to, <font class="keywordtype">int</font> selNum )
02105 {
02106     <font class="keywordflow">if</font> ( selNum &gt; doc-&gt;numSelections() - 1 )
02107     doc-&gt;addSelection( selNum );
02108     QTextParag *p1 = doc-&gt;paragAt( parag_from );
02109     <font class="keywordflow">if</font> ( !p1 )
02110     <font class="keywordflow">return</font>;
02111     QTextParag *p2 = doc-&gt;paragAt( parag_to );
02112     <font class="keywordflow">if</font> ( !p2 )
02113     <font class="keywordflow">return</font>;
02114 
02115     <font class="keywordflow">if</font> ( index_from &gt; p1-&gt;length() - 1 )
02116     index_from = p1-&gt;length() - 1;
02117     <font class="keywordflow">if</font> ( index_to &gt; p2-&gt;length() - 1 )
02118     index_to = p2-&gt;length() - 1;
02119 
02120     drawCursor( FALSE );
02121     QTextCursor c = *cursor;
02122     c.setParag( p1 );
02123     c.setIndex( index_from );
02124     cursor-&gt;setParag( p2 );
02125     cursor-&gt;setIndex( index_to );
02126     doc-&gt;setSelectionStart( selNum, &amp;c );
02127     doc-&gt;setSelectionEnd( selNum, cursor );
02128     repaintChanged();
02129     <a class="code" href="class_q_text_edit.html#b1">ensureCursorVisible</a>();
02130     drawCursor( TRUE );
02131 }
02132 
02151 <font class="keywordtype">void</font> QTextView::getSelection( <font class="keywordtype">int</font> &amp;paraFrom, <font class="keywordtype">int</font> &amp;indexFrom,
02152                   <font class="keywordtype">int</font> &amp;paraTo, <font class="keywordtype">int</font> &amp;indexTo, <font class="keywordtype">int</font> selNum )<font class="keyword"> const</font>
02153 <font class="keyword"></font>{
02154     <font class="keywordflow">if</font> ( !doc-&gt;hasSelection( selNum ) ) {
02155     paraFrom = -1;
02156     indexFrom = -1;
02157     paraTo = -1;
02158     indexTo = -1;
02159     <font class="keywordflow">return</font>;
02160     }
02161 
02162     doc-&gt;selectionStart( selNum, paraFrom, indexFrom );
02163     doc-&gt;selectionEnd( selNum, paraTo, indexTo );
02164 }
02165 
02184 <font class="keywordtype">void</font> QTextView::setTextFormat( TextFormat format )
02185 {
02186     doc-&gt;setTextFormat( format );
02187 }
02188 
02194 Qt::TextFormat QTextView::textFormat()<font class="keyword"> const</font>
02195 <font class="keyword"></font>{
02196     <font class="keywordflow">return</font> doc-&gt;textFormat();
02197 }
02198 
02202 <font class="keywordtype">int</font> QTextView::paragraphs()<font class="keyword"> const</font>
02203 <font class="keyword"></font>{
02204     <font class="keywordflow">return</font> doc-&gt;lastParag()-&gt;paragId() + 1;
02205 }
02206 
02210 <font class="keywordtype">int</font> QTextView::linesOfParagraph( <font class="keywordtype">int</font> para )<font class="keyword"> const</font>
02211 <font class="keyword"></font>{
02212     QTextParag *p = doc-&gt;paragAt( para );
02213     <font class="keywordflow">if</font> ( !p )
02214     <font class="keywordflow">return</font> -1;
02215     <font class="keywordflow">return</font> p-&gt;lines();
02216 }
02217 
02225 <font class="keywordtype">int</font> QTextView::lines()<font class="keyword"> const</font>
02226 <font class="keyword"></font>{
02227     QTextParag *p = doc-&gt;firstParag();
02228     <font class="keywordtype">int</font> l = 0;
02229     <font class="keywordflow">while</font> ( p ) {
02230     l += p-&gt;lines();
02231     p = p-&gt;next();
02232     }
02233 
02234     <font class="keywordflow">return</font> l;
02235 }
02236 
02243 <font class="keywordtype">int</font> QTextView::lineOfChar( <font class="keywordtype">int</font> para, <font class="keywordtype">int</font> index )
02244 {
02245     QTextParag *p = doc-&gt;paragAt( para );
02246     <font class="keywordflow">if</font> ( !p )
02247     <font class="keywordflow">return</font> -1;
02248 
02249     <font class="keywordtype">int</font> idx, line;
02250     QTextStringChar *c = p-&gt;lineStartOfChar( index, &amp;idx, &amp;line );
02251     <font class="keywordflow">if</font> ( !c )
02252     <font class="keywordflow">return</font> -1;
02253 
02254     <font class="keywordflow">return</font> line;
02255 }
02256 
02257 <font class="keywordtype">void</font> QTextView::setModified( <font class="keywordtype">bool</font> m )
02258 {
02259     <font class="keywordflow">if</font> ( modified != m )
02260     emitModificationChanged( m );
02261     modified = m;
02262     <font class="keywordflow">if</font> ( modified ) {
02263     disconnect( <font class="keyword">this</font>, SIGNAL( textChanged() ),
02264             <font class="keyword">this</font>, SLOT( <a class="code" href="class_q_text_edit.html#g21">setModified</a>() ) );
02265     } <font class="keywordflow">else</font> {
02266     connect( <font class="keyword">this</font>, SIGNAL( textChanged() ),
02267          <font class="keyword">this</font>, SLOT( <a class="code" href="class_q_text_edit.html#g21">setModified</a>() ) );
02268     }
02269 }
02270 
02271 <font class="keywordtype">bool</font> QTextView::isModified()<font class="keyword"> const</font>
02272 <font class="keyword"></font>{
02273     <font class="keywordflow">return</font> modified;
02274 }
02275 
02276 <font class="keywordtype">void</font> QTextView::setModified()
02277 {
02278     <a class="code" href="class_q_text_edit.html#g21">setModified</a>( TRUE );
02279 }
02280 
02281 <font class="keywordtype">bool</font> QTextView::italic()<font class="keyword"> const</font>
02282 <font class="keyword"></font>{
02283     <font class="keywordflow">return</font> currentFormat-&gt;font().italic();
02284 }
02285 
02286 <font class="keywordtype">bool</font> QTextView::bold()<font class="keyword"> const</font>
02287 <font class="keyword"></font>{
02288     <font class="keywordflow">return</font> currentFormat-&gt;font().bold();
02289 }
02290 
02291 <font class="keywordtype">bool</font> QTextView::underline()<font class="keyword"> const</font>
02292 <font class="keyword"></font>{
02293     <font class="keywordflow">return</font> currentFormat-&gt;font().underline();
02294 }
02295 
02296 QString QTextView::family()<font class="keyword"> const</font>
02297 <font class="keyword"></font>{
02298     <font class="keywordflow">return</font> currentFormat-&gt;font().family();
02299 }
02300 
02301 <font class="keywordtype">int</font> QTextView::pointSize()<font class="keyword"> const</font>
02302 <font class="keyword"></font>{
02303     <font class="keywordflow">return</font> currentFormat-&gt;font().pointSize();
02304 }
02305 
02306 QColor QTextView::color()<font class="keyword"> const</font>
02307 <font class="keyword"></font>{
02308     <font class="keywordflow">return</font> currentFormat-&gt;color();
02309 }
02310 
02311 QFont QTextView::font()<font class="keyword"> const</font>
02312 <font class="keyword"></font>{
02313     <font class="keywordflow">return</font> currentFormat-&gt;font();
02314 }
02315 
02316 <font class="keywordtype">int</font> QTextView::alignment()<font class="keyword"> const</font>
02317 <font class="keyword"></font>{
02318     <font class="keywordflow">return</font> currentAlignment;
02319 }
02320 
02321 <font class="keywordtype">void</font> QTextView::startDrag()
02322 {
02323 <font class="preprocessor">#ifndef QT_NO_DRAGANDDROP</font>
02324 <font class="preprocessor"></font>    mousePressed = FALSE;
02325     inDoubleClick = FALSE;
02326     QDragObject *drag = <font class="keyword">new</font> QTextDrag( doc-&gt;selectedText( QTextDocument::Standard ), viewport() );
02327     <font class="keywordflow">if</font> ( isReadOnly() ) {
02328     drag-&gt;dragCopy();
02329     } <font class="keywordflow">else</font> {
02330     <font class="keywordflow">if</font> ( drag-&gt;drag() &amp;&amp; QDragObject::target() != <font class="keyword">this</font> &amp;&amp; QDragObject::target() != viewport() ) {
02331         doc-&gt;removeSelectedText( QTextDocument::Standard, cursor );
02332         repaintChanged();
02333     }
02334     }
02335 <font class="preprocessor">#endif</font>
02336 <font class="preprocessor"></font>}
02337 
02344 <font class="keywordtype">void</font> QTextView::selectAll( <font class="keywordtype">bool</font> select )
02345 {
02346     <font class="keywordflow">if</font> ( !select )
02347     doc-&gt;removeSelection( QTextDocument::Standard );
02348     <font class="keywordflow">else</font>
02349     doc-&gt;selectAll( QTextDocument::Standard );
02350     repaintChanged();
02351     emit copyAvailable( doc-&gt;hasSelection( QTextDocument::Standard ) );
02352     emit selectionChanged();
02353 <font class="preprocessor">#ifndef QT_NO_CURSOR</font>
02354 <font class="preprocessor"></font>    viewport()-&gt;setCursor( isReadOnly() ? arrowCursor : ibeamCursor );
02355 <font class="preprocessor">#endif</font>
02356 <font class="preprocessor"></font>}
02357 
02358 <font class="keywordtype">void</font> QTextView::UndoRedoInfo::clear()
02359 {
02360     <font class="keywordflow">if</font> ( valid() ) {
02361     <font class="keywordflow">if</font> ( type == Insert || type == Return )
02362         doc-&gt;addCommand( <font class="keyword">new</font> QTextInsertCommand( doc, id, index, d-&gt;text.rawData(), oldStyles, oldListStyles, oldAligns ) );
02363     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( type == Format )
02364         doc-&gt;addCommand( <font class="keyword">new</font> QTextFormatCommand( doc, id, index, eid, eindex, d-&gt;text.rawData(), format, flags ) );
02365     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( type == Alignment )
02366         doc-&gt;addCommand( <font class="keyword">new</font> QTextAlignmentCommand( doc, id, eid, newAlign, oldAligns ) );
02367     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( type == ParagType )
02368         doc-&gt;addCommand( <font class="keyword">new</font> QTextParagTypeCommand( doc, id, eid, list, listStyle, oldStyles, oldListStyles ) );
02369     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( type != Invalid )
02370         doc-&gt;addCommand( <font class="keyword">new</font> QTextDeleteCommand( doc, id, index, d-&gt;text.rawData(), oldStyles, oldListStyles, oldAligns ) );
02371     }
02372     d-&gt;text = QString::null;
02373     id = -1;
02374     index = -1;
02375     oldStyles.clear();
02376     oldListStyles.clear();
02377     oldAligns.resize( 0 );
02378 }
02379 
02380 
02381 <font class="keywordtype">void</font> QTextView::del()
02382 {
02383     <font class="keywordflow">if</font> ( doc-&gt;hasSelection( QTextDocument::Standard ) ) {
02384     <a class="code" href="class_q_text_edit.html#g24">removeSelectedText</a>();
02385     <font class="keywordflow">return</font>;
02386     }
02387 
02388     <a class="code" href="class_q_text_edit.html#b5">doKeyboardAction</a>( ActionDelete );
02389 }
02390 
02391 
02392 QTextView::UndoRedoInfo::UndoRedoInfo( QTextDocument *dc )
02393     : type( Invalid ), doc( dc )
02394 {
02395     d = <font class="keyword">new</font> QUndoRedoInfoPrivate;
02396     d-&gt;text = QString::null;
02397     id = -1;
02398     index = -1;
02399 }
02400 
02401 QTextView::UndoRedoInfo::~UndoRedoInfo()
02402 {
02403     <font class="keyword">delete</font> d;
02404 }
02405 
02406 <font class="keywordtype">bool</font> QTextView::UndoRedoInfo::valid()<font class="keyword"> const</font>
02407 <font class="keyword"></font>{
02408     <font class="keywordflow">return</font> d-&gt;text.length() &gt; 0  &amp;&amp; id &gt;= 0 &amp;&amp; index &gt;= 0;
02409 }
02410 
02411 <font class="keywordtype">void</font> QTextView::resetFormat()
02412 {
02413     <a class="code" href="class_q_text_edit.html#g16">setAlignment</a>( Qt3::AlignAuto );
02414     <a class="code" href="class_q_text_edit.html#g17">setParagType</a>( QStyleSheetItem::DisplayBlock, QStyleSheetItem::ListDisc );
02415     <a class="code" href="class_q_text_edit.html#b0">setFormat</a>( doc-&gt;formatCollection()-&gt;defaultFormat(), QTextFormat::Format );
02416 }
02417 
02421 <a class="code" href="class_q_style_sheet.html">QStyleSheet</a>* QTextView::styleSheet()<font class="keyword"> const</font>
02422 <font class="keyword"></font>{
02423     <font class="keywordflow">return</font> doc-&gt;styleSheet();
02424 }
02425 
02429 <font class="keywordtype">void</font> QTextView::setStyleSheet( <a class="code" href="class_q_style_sheet.html">QStyleSheet</a>* styleSheet )
02430 {
02431     doc-&gt;setStyleSheet( styleSheet );
02432 }
02433 
02438 <font class="keywordtype">void</font> QTextView::setPaper( <font class="keyword">const</font> QBrush&amp; pap )
02439 {
02440     doc-&gt;setPaper( <font class="keyword">new</font> QBrush( pap ) );
02441     viewport()-&gt;setBackgroundColor( pap.color() );
02442     viewport()-&gt;update();
02443 }
02444 
02449 QBrush QTextView::paper()<font class="keyword"> const</font>
02450 <font class="keyword"></font>{
02451     <font class="keywordflow">if</font> ( doc-&gt;paper() )
02452     <font class="keywordflow">return</font> *doc-&gt;paper();
02453     <font class="keywordflow">return</font> QBrush();
02454 }
02455 
02462 <font class="keywordtype">void</font> QTextView::setLinkUnderline( <font class="keywordtype">bool</font> b )
02463 {
02464     doc-&gt;setUnderlineLinks( b );
02465 }
02466 
02471 <font class="keywordtype">bool</font> QTextView::linkUnderline()<font class="keyword"> const</font>
02472 <font class="keyword"></font>{
02473     <font class="keywordflow">return</font> doc-&gt;underlineLinks();
02474 }
02475 
02480 <font class="keywordtype">void</font> QTextView::setMimeSourceFactory( QMimeSourceFactory* factory )
02481 {
02482     doc-&gt;setMimeSourceFactory( factory );
02483 }
02484 
02489 QMimeSourceFactory* QTextView::mimeSourceFactory()<font class="keyword"> const</font>
02490 <font class="keyword"></font>{
02491     <font class="keywordflow">return</font> doc-&gt;mimeSourceFactory();
02492 }
02493 
02499 <font class="keywordtype">int</font> QTextView::heightForWidth( <font class="keywordtype">int</font> w )<font class="keyword"> const</font>
02500 <font class="keyword"></font>{
02501     <font class="keywordtype">int</font> oldw = doc-&gt;width();
02502     doc-&gt;doLayout( 0, w );
02503     <font class="keywordtype">int</font> h = doc-&gt;height();
02504     doc-&gt;setWidth( oldw );
02505     doc-&gt;invalidate();
02506     ( (<a class="code" href="class_q_text_view.html">QTextView</a>*)<font class="keyword">this</font> )-&gt;formatMore();
02507     <font class="keywordflow">return</font> h;
02508 }
02509 
02513 <font class="keywordtype">void</font> QTextView::append( <font class="keyword">const</font> QString &amp;text )
02514 {
02515     doc-&gt;removeSelection( QTextDocument::Standard );
02516     TextFormat f = doc-&gt;textFormat();
02517     <font class="keywordflow">if</font> ( f == AutoText ) {
02518     <font class="keywordflow">if</font> ( QStyleSheet::mightBeRichText( text ) )
02519         f = RichText;
02520     <font class="keywordflow">else</font>
02521         f = PlainText;
02522     }
02523     <font class="keywordflow">if</font> ( f == PlainText ) {
02524     QTextCursor oldc( *cursor );
02525     cursor-&gt;gotoEnd();
02526     <a class="code" href="class_q_text_edit.html#a14">insert</a>( text, FALSE, TRUE );
02527     *cursor = oldc;
02528     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( f == RichText ) {
02529     doc-&gt;setRichTextInternal( text );
02530     repaintChanged();
02531     }
02532 }
02533 
02537 <font class="keywordtype">bool</font> QTextView::hasSelectedText()<font class="keyword"> const</font>
02538 <font class="keyword"></font>{
02539     <font class="keywordflow">return</font> doc-&gt;hasSelection( QTextDocument::Standard );
02540 }
02541 
02551 QString QTextView::selectedText()<font class="keyword"> const</font>
02552 <font class="keyword"></font>{
02553     <font class="keywordflow">return</font> doc-&gt;selectedText( QTextDocument::Standard );
02554 }
02555 
02556 <font class="keywordtype">void</font> QTextView::handleReadOnlyKeyEvent( QKeyEvent *e )
02557 {
02558     <font class="keywordflow">switch</font>( e-&gt;key() ) {
02559     <font class="keywordflow">case</font> Key_Down:
02560     setContentsPos( contentsX(), contentsY() + 10 );
02561     <font class="keywordflow">break</font>;
02562     <font class="keywordflow">case</font> Key_Up:
02563     setContentsPos( contentsX(), contentsY() - 10 );
02564     <font class="keywordflow">break</font>;
02565     <font class="keywordflow">case</font> Key_Left:
02566     setContentsPos( contentsX() - 10, contentsY() );
02567     <font class="keywordflow">break</font>;
02568     <font class="keywordflow">case</font> Key_Right:
02569     setContentsPos( contentsX() + 10, contentsY() );
02570     <font class="keywordflow">break</font>;
02571     <font class="keywordflow">case</font> Key_PageUp:
02572     setContentsPos( contentsX(), contentsY() - visibleHeight() );
02573     <font class="keywordflow">break</font>;
02574     <font class="keywordflow">case</font> Key_PageDown:
02575     setContentsPos( contentsX(), contentsY() + visibleHeight() );
02576     <font class="keywordflow">break</font>;
02577     <font class="keywordflow">case</font> Key_Home:
02578     setContentsPos( contentsX(), 0 );
02579     <font class="keywordflow">break</font>;
02580     <font class="keywordflow">case</font> Key_End:
02581     setContentsPos( contentsX(), contentsHeight() - visibleHeight() );
02582     <font class="keywordflow">break</font>;
02583 <font class="preprocessor">#ifndef QT_NO_NETWORKPROTOCOL</font>
02584 <font class="preprocessor"></font>    <font class="keywordflow">case</font> Key_Return:
02585     <font class="keywordflow">case</font> Key_Enter:
02586     <font class="keywordflow">case</font> Key_Space: {
02587     <font class="keywordflow">if</font> ( !doc-&gt;focusIndicator.href.isEmpty() ) {
02588         QUrl u( doc-&gt;context(), doc-&gt;focusIndicator.href, TRUE );
02589         emitLinkClicked( u.toString( FALSE, FALSE ) );
02590     }
02591     } <font class="keywordflow">break</font>;
02592 <font class="preprocessor">#endif</font>
02593 <font class="preprocessor"></font>    <font class="keywordflow">default</font>:
02594     <font class="keywordflow">break</font>;
02595     }
02596 }
02597 
02606 QString QTextView::context()<font class="keyword"> const</font>
02607 <font class="keyword"></font>{
02608     <font class="keywordflow">return</font> doc-&gt;context();
02609 }
02610 
02619 QString QTextView::documentTitle()<font class="keyword"> const</font>
02620 <font class="keyword"></font>{
02621     <font class="keywordflow">return</font> doc-&gt;attributes()[ <font class="stringliteral">"title"</font> ];
02622 }
02623 
02624 <font class="keywordtype">void</font> QTextView::makeParagVisible( QTextParag *p )
02625 {
02626     setContentsPos( contentsX(), QMIN( p-&gt;rect().y(), contentsHeight() - visibleHeight() ) );
02627 }
02628 
02634 <font class="keywordtype">void</font> QTextView::scrollToAnchor( <font class="keyword">const</font> QString&amp; name )
02635 {
02636     <font class="keywordflow">if</font> ( name.isEmpty() )
02637     <font class="keywordflow">return</font>;
02638 
02639     QTextParag *p = doc-&gt;firstParag();
02640 
02641     <font class="keywordflow">if</font> ( !doc-&gt;lastParag()-&gt;isValid() ) {
02642     <font class="keywordflow">while</font> ( p ) {
02643         <font class="keywordflow">if</font> ( !p-&gt;isValid() )
02644         p-&gt;format();
02645         p = p-&gt;next();
02646     }
02647     resizeContents( contentsWidth(), doc-&gt;height() );
02648     }
02649 
02650     p = doc-&gt;firstParag();
02651     <font class="keywordflow">while</font> ( p ) {
02652     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; p-&gt;length(); ++i ) {
02653         <font class="keywordflow">if</font> ( p-&gt;at( i )-&gt;format()-&gt;isAnchor() &amp;&amp;
02654          p-&gt;at( i )-&gt;format()-&gt;anchorName() == name ) {
02655         makeParagVisible( p );
02656         <font class="keywordflow">return</font>;
02657         }
02658     }
02659     p = p-&gt;next();
02660     }
02661 }
02662 
02668 QString QTextView::anchorAt( <font class="keyword">const</font> QPoint&amp; pos )
02669 {
02670     QTextCursor c( doc );
02671     <a class="code" href="class_q_text_edit.html#b2">placeCursor</a>( pos, &amp;c );
02672     <font class="keywordflow">return</font> c.parag()-&gt;at( c.index() )-&gt;format()-&gt;anchorHref();
02673 }
02674 
02675 <font class="keywordtype">void</font> QTextView::setRealWidth( <font class="keywordtype">int</font> w )
02676 {
02677     w = QMAX( w, visibleWidth() - verticalScrollBar()-&gt;width() );
02678     resizeContents( w, contentsHeight() );
02679     QScrollView::setHScrollBarMode( setMode );
02680 }
02681 
02687 <font class="keywordtype">void</font> QTextView::updateStyles()
02688 {
02689     doc-&gt;updateStyles();
02690 }
02691 
02692 <font class="keywordtype">void</font> QTextView::setDocument( QTextDocument *dc )
02693 {
02694     <font class="keywordflow">if</font> ( dc == doc )
02695     <font class="keywordflow">return</font>;
02696     doc = dc;
02697     cursor-&gt;setDocument( doc );
02698     clearUndoRedo();
02699     lastFormatted = 0;
02700 }
02701 
02702 <font class="preprocessor">#ifndef QT_NO_CLIPBOARD</font>
02703 <font class="preprocessor"></font>
02709 <font class="keywordtype">void</font> QTextView::pasteSubType( <font class="keyword">const</font> QCString&amp; subtype )
02710 {
02711     QCString st = subtype;
02712     QString t = QApplication::clipboard()-&gt;text(st);
02713     <font class="keywordflow">if</font> ( !t.isEmpty() ) {
02714 <font class="preprocessor">#if defined(Q_OS_WIN32)</font>
02715 <font class="preprocessor"></font>    <font class="comment">// Need to convert CRLF to NL</font>
02716     QRegExp crlf( QString::fromLatin1(<font class="stringliteral">"\r\n"</font>) );
02717     t.replace( crlf, QChar(<font class="charliteral">'\n'</font>) );
02718 <font class="preprocessor">#endif</font>
02719 <font class="preprocessor"></font>    <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i=0; (uint) i&lt;t.length(); i++ ) {
02720         <font class="keywordflow">if</font> ( t[ i ] &lt; <font class="charliteral">' '</font> &amp;&amp; t[ i ] != <font class="charliteral">'\n'</font> &amp;&amp; t[ i ] != <font class="charliteral">'\t'</font> )
02721         t[ i ] = <font class="charliteral">' '</font>;
02722     }
02723     <font class="keywordflow">if</font> ( !t.isEmpty() )
02724         <a class="code" href="class_q_text_edit.html#a14">insert</a>( t, FALSE, TRUE );
02725     }
02726 }
02727 
02728 <font class="preprocessor">#ifndef QT_NO_MIMECLIPBOARD</font>
02729 <font class="preprocessor"></font>
02735 <font class="keywordtype">void</font> QTextView::pasteSpecial( <font class="keyword">const</font> QPoint&amp; pt )
02736 {
02737     QCString st = pickSpecial( QApplication::clipboard()-&gt;data(), TRUE, pt );
02738     <font class="keywordflow">if</font> ( !st.isEmpty() )
02739     <a class="code" href="class_q_text_edit.html#g5">pasteSubType</a>( st );
02740 }
02741 <font class="preprocessor">#endif</font>
02742 <font class="preprocessor"></font><font class="preprocessor">#ifndef QT_NO_MIME</font>
02743 <font class="preprocessor"></font>QCString QTextView::pickSpecial( QMimeSource* ms, <font class="keywordtype">bool</font> always_ask, <font class="keyword">const</font> QPoint&amp; pt )
02744 {
02745     <font class="keywordflow">if</font> ( ms )  {
02746     QPopupMenu popup( <font class="keyword">this</font> );
02747     QString fmt;
02748     <font class="keywordtype">int</font> n = 0;
02749     QDict&lt;void&gt; done;
02750     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; !( fmt = ms-&gt;format( i ) ).isNull(); i++) {
02751         <font class="keywordtype">int</font> semi = fmt.find( <font class="stringliteral">";"</font> );
02752         <font class="keywordflow">if</font> ( semi &gt;= 0 )
02753         fmt = fmt.left( semi );
02754         <font class="keywordflow">if</font> ( fmt.left( 5 ) == <font class="stringliteral">"text/"</font> ) {
02755         fmt = fmt.mid( 5 );
02756         <font class="keywordflow">if</font> ( !done.find( fmt ) ) {
02757             done.insert( fmt,(<font class="keywordtype">void</font>*)1 );
02758             popup.insertItem( fmt, i );
02759             n++;
02760         }
02761         }
02762     }
02763     <font class="keywordflow">if</font> ( n ) {
02764         <font class="keywordtype">int</font> i = n ==1 &amp;&amp; !always_ask ? popup.idAt( 0 ) : popup.exec( pt );
02765         <font class="keywordflow">if</font> ( i &gt;= 0 )
02766         <font class="keywordflow">return</font> popup.text(i).latin1();
02767     }
02768     }
02769     <font class="keywordflow">return</font> QCString();
02770 }
02771 <font class="preprocessor">#endif // QT_NO_MIME</font>
02772 <font class="preprocessor"></font><font class="preprocessor">#endif // QT_NO_CLIPBOARD</font>
02773 <font class="preprocessor"></font>
02812 <font class="keywordtype">void</font> QTextView::setWordWrap( WordWrap mode )
02813 {
02814     wrapMode = mode;
02815     <font class="keywordflow">switch</font> ( mode ) {
02816     <font class="keywordflow">case</font> NoWrap:
02817     document()-&gt;formatter()-&gt;setWrapEnabled( FALSE );
02818     document()-&gt;formatter()-&gt;setWrapAtColumn( -1 );
02819     <font class="keywordflow">break</font>;
02820     <font class="keywordflow">case</font> WidgetWidth:
02821     document()-&gt;formatter()-&gt;setWrapEnabled( TRUE );
02822     document()-&gt;formatter()-&gt;setWrapAtColumn( -1 );
02823     doResize();
02824     <font class="keywordflow">break</font>;
02825     <font class="keywordflow">case</font> FixedPixelWidth:
02826     document()-&gt;formatter()-&gt;setWrapEnabled( TRUE );
02827     document()-&gt;formatter()-&gt;setWrapAtColumn( -1 );
02828     setWrapColumnOrWidth( wrapWidth );
02829     <font class="keywordflow">break</font>;
02830     <font class="keywordflow">case</font> FixedColumnWidth:
02831     document()-&gt;formatter()-&gt;setWrapEnabled( TRUE );
02832     document()-&gt;formatter()-&gt;setWrapAtColumn( wrapWidth );
02833     setWrapColumnOrWidth( wrapWidth );
02834     <font class="keywordflow">break</font>;
02835     }
02836 }
02837 
02842 QTextView::WordWrap QTextView::wordWrap()<font class="keyword"> const</font>
02843 <font class="keyword"></font>{
02844     <font class="keywordflow">return</font> wrapMode;
02845 }
02846 
02857 <font class="keywordtype">void</font> QTextView::setWrapColumnOrWidth( <font class="keywordtype">int</font> value )
02858 {
02859     wrapWidth = value;
02860     <font class="keywordflow">if</font> ( wrapMode == FixedColumnWidth ) {
02861     document()-&gt;formatter()-&gt;setWrapAtColumn( wrapWidth );
02862     } <font class="keywordflow">else</font> {
02863     document()-&gt;formatter()-&gt;setWrapAtColumn( -1 );
02864     resizeContents( wrapWidth, contentsHeight() );
02865     doc-&gt;setWidth( wrapWidth );
02866     doc-&gt;invalidate();
02867     viewport()-&gt;repaint( FALSE );
02868     lastFormatted = doc-&gt;firstParag();
02869     interval = 0;
02870     formatMore();
02871     }
02872 }
02873 
02883 <font class="keywordtype">int</font> QTextView::wrapColumnOrWidth()<font class="keyword"> const</font>
02884 <font class="keyword"></font>{
02885     <font class="keywordflow">return</font> wrapWidth;
02886 }
02887 
02888 
02908 <font class="keywordtype">void</font> QTextView::setWrapPolicy( WrapPolicy policy )
02909 {
02910     <font class="keywordflow">if</font> ( wPolicy == policy )
02911     <font class="keywordflow">return</font>;
02912     QTextFormatter *formatter;
02913     <font class="keywordflow">if</font> ( policy == AtWhiteSpace )
02914     formatter = <font class="keyword">new</font> QTextFormatterBreakWords;
02915     <font class="keywordflow">else</font>
02916     formatter = <font class="keyword">new</font> QTextFormatterBreakInWords;
02917     formatter-&gt;setWrapAtColumn( document()-&gt;formatter()-&gt;wrapAtColumn() );
02918     formatter-&gt;setWrapEnabled( document()-&gt;formatter()-&gt;isWrapEnabled() );
02919     document()-&gt;setFormatter( formatter );
02920     doc-&gt;invalidate();
02921     viewport()-&gt;repaint( FALSE );
02922     lastFormatted = doc-&gt;firstParag();
02923     interval = 0;
02924     formatMore();
02925 }
02926 
02933 QTextView::WrapPolicy QTextView::wrapPolicy()<font class="keyword"> const</font>
02934 <font class="keyword"></font>{
02935     <font class="keywordflow">return</font> wPolicy;
02936 }
02937 
02941 <font class="keywordtype">void</font> QTextView::clear()
02942 {
02943     cursor-&gt;restoreState();
02944     doc-&gt;clear( TRUE );
02945     cursor-&gt;setDocument( doc );
02946     cursor-&gt;setParag( doc-&gt;firstParag() );
02947     cursor-&gt;setIndex( 0 );
02948     viewport()-&gt;repaint( FALSE );
02949 }
02950 
02951 <font class="keywordtype">int</font> QTextView::undoDepth()<font class="keyword"> const</font>
02952 <font class="keyword"></font>{
02953     <font class="keywordflow">return</font> document()-&gt;undoDepth();
02954 }
02955 
02959 <font class="keywordtype">int</font> QTextView::length()<font class="keyword"> const</font>
02960 <font class="keyword"></font>{
02961     <font class="keywordflow">return</font> document()-&gt;length();
02962 }
02963 
02967 <font class="keywordtype">int</font> QTextView::tabStopWidth()<font class="keyword"> const</font>
02968 <font class="keyword"></font>{
02969     <font class="keywordflow">return</font> document()-&gt;tabStopWidth();
02970 }
02971 
02972 <font class="keywordtype">void</font> QTextView::setUndoDepth( <font class="keywordtype">int</font> d )
02973 {
02974     document()-&gt;setUndoDepth( d );
02975 }
02976 
02980 <font class="keywordtype">void</font> QTextView::setTabStops( <font class="keywordtype">int</font> ts )
02981 {
02982     document()-&gt;setTabStops( ts );
02983 }
02984 
02987 <font class="keywordtype">void</font>  QTextView::setHScrollBarMode( ScrollBarMode sm )
02988 {
02989     setMode = sm;
02990 }
02991 
02994 QSize QTextView::sizeHint()<font class="keyword"> const</font>
02995 <font class="keyword"></font>{
02996     <font class="comment">// ### calculate a reasonable one</font>
02997     <font class="keywordflow">return</font> QSize( 100, 100 );
02998 }
02999 
03000 <font class="keywordtype">void</font> QTextView::clearUndoRedo()
03001 {
03002     undoRedoInfo.clear();
03003     emitUndoAvailable( doc-&gt;commands()-&gt;isUndoAvailable() );
03004     emitRedoAvailable( doc-&gt;commands()-&gt;isRedoAvailable() );
03005 }
03006 
03007 <font class="keywordtype">bool</font> QTextView::getFormat( <font class="keywordtype">int</font> parag, <font class="keywordtype">int</font> index, QFont &amp;font, QColor &amp;color )
03008 {
03009     QTextParag *p = doc-&gt;paragAt( parag );
03010     <font class="keywordflow">if</font> ( !p )
03011     <font class="keywordflow">return</font> FALSE;
03012     <font class="keywordflow">if</font> ( index &lt; 0 || index &gt;= p-&gt;length() )
03013     <font class="keywordflow">return</font> FALSE;
03014     <a class="code" href="class_q_text_edit.html#a10">font</a> = p-&gt;at( index )-&gt;format()-&gt;font();
03015     <a class="code" href="class_q_text_edit.html#a9">color</a> = p-&gt;at( index )-&gt;format()-&gt;color();
03016     <font class="keywordflow">return</font> TRUE;
03017 }
03018 
03026 QPopupMenu *QTextView::createPopupMenu()
03027 {
03028     QPopupMenu *popup = <font class="keyword">new</font> QPopupMenu( <font class="keyword">this</font> );
03029     d-&gt;id[ IdUndo ] = popup-&gt;insertItem( tr( <font class="stringliteral">"Undo"</font> ) );
03030     d-&gt;id[ IdRedo ] = popup-&gt;insertItem( tr( <font class="stringliteral">"Redo"</font> ) );
03031     popup-&gt;insertSeparator();
03032 <font class="preprocessor">#ifndef QT_NO_CLIPBOARD</font>
03033 <font class="preprocessor"></font>    d-&gt;id[ IdCut ] = popup-&gt;insertItem( tr( <font class="stringliteral">"Cut"</font> ) );
03034     d-&gt;id[ IdCopy ] = popup-&gt;insertItem( tr( <font class="stringliteral">"Copy"</font> ) );
03035     d-&gt;id[ IdPaste ] = popup-&gt;insertItem( tr( <font class="stringliteral">"Paste"</font> ) );
03036 <font class="preprocessor">#endif</font>
03037 <font class="preprocessor"></font>    d-&gt;id[ IdClear ] = popup-&gt;insertItem( tr( <font class="stringliteral">"Clear"</font> ) );
03038     popup-&gt;insertSeparator();
03039     d-&gt;id[ IdSelectAll ] = popup-&gt;insertItem( tr( <font class="stringliteral">"Select All"</font> ) );
03040     popup-&gt;setItemEnabled( d-&gt;id[ IdUndo ], !isReadOnly() &amp;&amp; doc-&gt;commands()-&gt;isUndoAvailable() );
03041     popup-&gt;setItemEnabled( d-&gt;id[ IdRedo ], !isReadOnly() &amp;&amp; doc-&gt;commands()-&gt;isRedoAvailable() );
03042 <font class="preprocessor">#ifndef QT_NO_CLIPBOARD</font>
03043 <font class="preprocessor"></font>    popup-&gt;setItemEnabled( d-&gt;id[ IdCut ], !isReadOnly() &amp;&amp; doc-&gt;hasSelection( QTextDocument::Standard ) );
03044     popup-&gt;setItemEnabled( d-&gt;id[ IdCopy ], doc-&gt;hasSelection( QTextDocument::Standard ) );
03045     popup-&gt;setItemEnabled( d-&gt;id[ IdPaste ], !isReadOnly() &amp;&amp; !QApplication::clipboard()-&gt;text().isEmpty() );
03046 <font class="preprocessor">#endif</font>
03047 <font class="preprocessor"></font>    popup-&gt;setItemEnabled( d-&gt;id[ IdClear ], !isReadOnly() &amp;&amp; !text().isEmpty() );
03048     popup-&gt;setItemEnabled( d-&gt;id[ IdSelectAll ], (<font class="keywordtype">bool</font>)text().length() );
03049     <font class="keywordflow">return</font> popup;
03050 }
03051 
03054 <font class="keywordtype">void</font> QTextView::setFont( <font class="keyword">const</font> QFont &amp;f )
03055 {
03056     QScrollView::setFont( f );
03057     doc-&gt;setMinimumWidth( -1, 0 );
03058 
03059     <font class="comment">// ### that is a bit hacky</font>
03060     <font class="keyword">static</font> <font class="keywordtype">short</font> diff = 1;
03061     diff *= -1;
03062     doc-&gt;setWidth( visibleWidth() + diff );
03063 
03064     doc-&gt;updateFontSizes( f.pointSize() );
03065     lastFormatted = doc-&gt;firstParag();
03066     formatMore();
03067     repaintChanged();
03068 }
03069 
03093 <font class="keywordtype">void</font> QTextView::zoomIn( <font class="keywordtype">int</font> range )
03094 {
03095     QFont f( QScrollView::font() );
03096     f.setPointSize( f.pointSize() + range );
03097     <a class="code" href="class_q_text_edit.html#g15">setFont</a>( f );
03098 }
03099 
03105 <font class="keywordtype">void</font> QTextView::zoomOut( <font class="keywordtype">int</font> range )
03106 {
03107     QFont f( QScrollView::font() );
03108     f.setPointSize( QMAX( 1, f.pointSize() - range ) );
03109     <a class="code" href="class_q_text_edit.html#g15">setFont</a>( f );
03110 }
03111 
03112 <font class="comment">/* As the engine of QTextView is optimized for large amounts text, it</font>
03113 <font class="comment">   is not sure that after e.g. calling setText() the whole document is</font>
03114 <font class="comment">   formatted, as only the visible part is formatted immediately, and</font>
03115 <font class="comment">   the rest delayed or on demand if needed.</font>
03116 <font class="comment"></font>
03117 <font class="comment">   If you need some information (like contentsHeight() to get the</font>
03118 <font class="comment">   height of the document) to be correct after e.g. calling setText(),</font>
03119 <font class="comment">   call this function to ensure that the whole document has been</font>
03120 <font class="comment">   formatted properly.</font>
03121 <font class="comment">*/</font>
03122 
03123 <font class="keywordtype">void</font> QTextView::sync()
03124 {
03125     <font class="keywordflow">if</font> ( !lastFormatted )
03126     <font class="keywordflow">return</font>;
03127     QTextParag *p = lastFormatted;
03128     <font class="keywordflow">while</font> ( p ) {
03129     p-&gt;format();
03130     p = p-&gt;next();
03131     }
03132     resizeContents( contentsWidth(), doc-&gt;height() );
03133 }
03134 
03137 <font class="keywordtype">void</font> QTextView::setEnabled( <font class="keywordtype">bool</font> b )
03138 {
03139     QScrollView::setEnabled( b );
03140     <font class="keywordflow">if</font> ( textFormat() == PlainText ) {
03141     QTextFormat *f = doc-&gt;formatCollection()-&gt;defaultFormat();
03142     f-&gt;setColor( colorGroup().text() );
03143     viewport()-&gt;repaint( FALSE );
03144     }
03145 }
03146 
03147 <font class="keywordtype">void</font> QTextView::setSelectionAttributes( <font class="keywordtype">int</font> selNum, <font class="keyword">const</font> QColor &amp;back, <font class="keywordtype">bool</font> invertText )
03148 {
03149     <font class="keywordflow">if</font> ( selNum &lt; 1 )
03150     <font class="keywordflow">return</font>;
03151     <font class="keywordflow">if</font> ( selNum &gt; doc-&gt;numSelections() )
03152     doc-&gt;addSelection( selNum );
03153     doc-&gt;setSelectionColor( selNum, back );
03154     doc-&gt;setInvertSelectionText( selNum, invertText );
03155 }
</pre></div><hr><address><small>Generated on Sun Mar 10 22:12:50 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
