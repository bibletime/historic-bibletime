<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>qrichtext.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>qrichtext.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/****************************************************************************</font>
00002 <font class="comment">** Implementation of the internal Qt classes dealing with rich text</font>
00003 <font class="comment">**</font>
00004 <font class="comment">** Created : 990101</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** Copyright (C) 1992-2000 Trolltech AS.  All rights reserved.</font>
00007 <font class="comment">**</font>
00008 <font class="comment">** This file is part of the kernel module of the Qt GUI Toolkit.</font>
00009 <font class="comment">**</font>
00010 <font class="comment">** This file may be distributed under the terms of the Q Public License</font>
00011 <font class="comment">** as defined by Trolltech AS of Norway and appearing in the file</font>
00012 <font class="comment">** LICENSE.QPL included in the packaging of this file.</font>
00013 <font class="comment">**</font>
00014 <font class="comment">** This file may be distributed and/or modified under the terms of the</font>
00015 <font class="comment">** GNU General Public License version 2 as published by the Free Software</font>
00016 <font class="comment">** Foundation and appearing in the file LICENSE.GPL included in the</font>
00017 <font class="comment">** packaging of this file.</font>
00018 <font class="comment">**</font>
00019 <font class="comment">** Licensees holding valid Qt Enterprise Edition or Qt Professional Edition</font>
00020 <font class="comment">** licenses may use this file in accordance with the Qt Commercial License</font>
00021 <font class="comment">** Agreement provided with the Software.</font>
00022 <font class="comment">**</font>
00023 <font class="comment">** This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE</font>
00024 <font class="comment">** WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</font>
00025 <font class="comment">**</font>
00026 <font class="comment">** See http://www.trolltech.com/pricing.html or email sales@trolltech.com for</font>
00027 <font class="comment">**   information about Qt Commercial License Agreements.</font>
00028 <font class="comment">** See http://www.trolltech.com/qpl/ for QPL licensing information.</font>
00029 <font class="comment">** See http://www.trolltech.com/gpl/ for GPL licensing information.</font>
00030 <font class="comment">**</font>
00031 <font class="comment">** Contact info@trolltech.com if any conditions of this licensing are</font>
00032 <font class="comment">** not clear to you.</font>
00033 <font class="comment">**</font>
00034 <font class="comment">**********************************************************************/</font>
00035 
00036 <font class="preprocessor">#include "qrichtext_p.h"</font>
00037 <font class="preprocessor">#include "qstringlist.h"</font>
00038 <font class="preprocessor">#include "qfont.h"</font>
00039 <font class="preprocessor">#include "qtextstream.h"</font>
00040 <font class="preprocessor">#include "qfile.h"</font>
00041 <font class="preprocessor">#include "qregexp.h"</font>
00042 <font class="preprocessor">#include "qapplication.h"</font>
00043 <font class="preprocessor">#include "qclipboard.h"</font>
00044 <font class="preprocessor">#include "qmap.h"</font>
00045 <font class="preprocessor">#include "qfileinfo.h"</font>
00046 <font class="preprocessor">#include "qstylesheet.h"</font>
00047 <font class="preprocessor">#include "qmime.h"</font>
00048 <font class="preprocessor">#include "qregexp.h"</font>
00049 <font class="preprocessor">#include "qimage.h"</font>
00050 <font class="preprocessor">#include "qdragobject.h"</font>
00051 <font class="preprocessor">#include "qpaintdevicemetrics.h"</font>
00052 <font class="preprocessor">#include "qpainter.h"</font>
00053 <font class="preprocessor">#include "qdrawutil.h"</font>
00054 <font class="preprocessor">#include "qcursor.h"</font>
00055 <font class="preprocessor">#include "qstack.h"</font>
00056 <font class="preprocessor">#include "qcomplextext_p.h"</font>
00057 
00058 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00059 
00060 <font class="keyword">using</font> <font class="keyword">namespace </font>Qt3;
00061 
00062 <font class="comment">//#define PARSER_DEBUG</font>
00063 <font class="comment">//#define DEBUG_COLLECTION</font>
00064 <font class="comment">//#define DEBUG_TABLE_RENDERING</font>
00065 
00066 <font class="keyword">static</font> QTextFormatCollection *qFormatCollection = 0;
00067 
00068 <font class="comment">//ANY_CHARSET_BEGIN</font>
00069 QMap&lt;QString, QFont::CharSet&gt;* m_charsetMap = 0;
00070 <font class="comment">//ANY_CHARSET_END</font>
00071 
00072 <font class="preprocessor">#if defined(PARSER_DEBUG)</font>
00073 <font class="preprocessor"></font><font class="keyword">static</font> QString debug_indent;
00074 <font class="preprocessor">#endif</font>
00075 <font class="preprocessor"></font>
00076 <font class="keyword">static</font> <font class="keywordtype">double</font> scale_factor( <font class="keywordtype">double</font> v )
00077 {
00078     <font class="keywordflow">return</font> v/QPaintDevice::x11AppDpiY();
00079 }
00080 
00081 <font class="keyword">static</font> <font class="keywordtype">bool</font> is_printer( QPainter *p )
00082 {
00083     <font class="comment">//if ( !p || !p-&gt;device() )</font>
00084     <font class="keywordflow">return</font> FALSE;
00085     <font class="comment">//return p-&gt;device()-&gt;devType() == QInternal::Printer;</font>
00086 }
00087 
00088 <font class="comment">// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
00089 
00090 <font class="keywordtype">void</font> QTextCommandHistory::addCommand( QTextCommand *cmd )
00091 {
00092     <font class="keywordflow">if</font> ( current &lt; (int)history.count() - 1 ) {
00093     QPtrList&lt;QTextCommand&gt; commands;
00094     commands.setAutoDelete( FALSE );
00095 
00096     <font class="keywordflow">for</font>( <font class="keywordtype">int</font> i = 0; i &lt;= current; ++i ) {
00097         commands.insert( i, history.at( 0 ) );
00098         history.take( 0 );
00099     }
00100 
00101     commands.append( cmd );
00102     history.clear();
00103     history = commands;
00104     history.setAutoDelete( TRUE );
00105     } <font class="keywordflow">else</font> {
00106     history.append( cmd );
00107     }
00108 
00109     <font class="keywordflow">if</font> ( (int)history.count() &gt; steps )
00110     history.removeFirst();
00111     <font class="keywordflow">else</font>
00112     ++current;
00113 }
00114 
00115 QTextCursor *QTextCommandHistory::undo( QTextCursor *c )
00116 {
00117     <font class="keywordflow">if</font> ( current &gt; -1 ) {
00118     QTextCursor *c2 = history.at( current )-&gt;unexecute( c );
00119     --current;
00120     <font class="keywordflow">return</font> c2;
00121     }
00122     <font class="keywordflow">return</font> 0;
00123 }
00124 
00125 QTextCursor *QTextCommandHistory::redo( QTextCursor *c )
00126 {
00127     <font class="keywordflow">if</font> ( current &gt; -1 ) {
00128     <font class="keywordflow">if</font> ( current &lt; (int)history.count() - 1 ) {
00129         ++current;
00130         <font class="keywordflow">return</font> history.at( current )-&gt;execute( c );
00131     }
00132     } <font class="keywordflow">else</font> {
00133     <font class="keywordflow">if</font> ( history.count() &gt; 0 ) {
00134         ++current;
00135         <font class="keywordflow">return</font> history.at( current )-&gt;execute( c );
00136     }
00137     }
00138     <font class="keywordflow">return</font> 0;
00139 }
00140 
00141 <font class="keywordtype">bool</font> QTextCommandHistory::isUndoAvailable()
00142 {
00143     <font class="keywordflow">return</font> current &gt; -1;
00144 }
00145 
00146 <font class="keywordtype">bool</font> QTextCommandHistory::isRedoAvailable()
00147 {
00148    <font class="keywordflow">return</font> current &gt; -1 || history.count() &gt; 0;
00149 }
00150 
00151 <font class="comment">// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
00152 
00153 QTextDeleteCommand::QTextDeleteCommand( QTextDocument *d, <font class="keywordtype">int</font> i, <font class="keywordtype">int</font> idx, <font class="keyword">const</font> QMemArray&lt;QTextStringChar&gt; &amp;str,
00154                     <font class="keyword">const</font> QValueList&lt; QPtrVector&lt;QStyleSheetItem&gt; &gt; &amp;os,
00155                     <font class="keyword">const</font> QValueList&lt;QStyleSheetItem::ListStyle&gt; &amp;ols,
00156                     <font class="keyword">const</font> QMemArray&lt;int&gt; &amp;oas)
00157     : QTextCommand( d ), id( i ), index( idx ), parag( 0 ), text( str ), oldStyles( os ), oldListStyles( ols ), oldAligns( oas )
00158 {
00159     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> j = 0; j &lt; (int)text.size(); ++j ) {
00160     <font class="keywordflow">if</font> ( text[ j ].format() )
00161         text[ j ].format()-&gt;addRef();
00162     }
00163 }
00164 
00165 QTextDeleteCommand::QTextDeleteCommand( QTextParag *p, <font class="keywordtype">int</font> idx, <font class="keyword">const</font> QMemArray&lt;QTextStringChar&gt; &amp;str )
00166     : QTextCommand( 0 ), id( -1 ), index( idx ), parag( p ), text( str )
00167 {
00168     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)text.size(); ++i ) {
00169     <font class="keywordflow">if</font> ( text[ i ].format() )
00170         text[ i ].format()-&gt;addRef();
00171     }
00172 }
00173 
00174 QTextDeleteCommand::~QTextDeleteCommand()
00175 {
00176     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)text.size(); ++i ) {
00177     <font class="keywordflow">if</font> ( text[ i ].format() )
00178         text[ i ].format()-&gt;removeRef();
00179     }
00180     text.resize( 0 );
00181 }
00182 
00183 QTextCursor *QTextDeleteCommand::execute( QTextCursor *c )
00184 {
00185     QTextParag *s = doc ? doc-&gt;paragAt( id ) : parag;
00186     <font class="keywordflow">if</font> ( !s ) {
00187     qWarning( <font class="stringliteral">"can't locate parag at %d, last parag: %d"</font>, id, doc-&gt;lastParag()-&gt;paragId() );
00188     <font class="keywordflow">return</font> 0;
00189     }
00190 
00191     cursor.setParag( s );
00192     cursor.setIndex( index );
00193     <font class="keywordtype">int</font> len = text.size();
00194     <font class="keywordflow">if</font> ( c )
00195     *c = cursor;
00196     <font class="keywordflow">if</font> ( doc ) {
00197     doc-&gt;setSelectionStart( QTextDocument::Temp, &amp;cursor );
00198     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; len; ++i )
00199         cursor.gotoRight();
00200     doc-&gt;setSelectionEnd( QTextDocument::Temp, &amp;cursor );
00201     doc-&gt;removeSelectedText( QTextDocument::Temp, &amp;cursor );
00202     <font class="keywordflow">if</font> ( c )
00203         *c = cursor;
00204     } <font class="keywordflow">else</font> {
00205     s-&gt;remove( index, len );
00206     }
00207 
00208     <font class="keywordflow">return</font> c;
00209 }
00210 
00211 QTextCursor *QTextDeleteCommand::unexecute( QTextCursor *c )
00212 {
00213     QTextParag *s = doc ? doc-&gt;paragAt( id ) : parag;
00214     <font class="keywordflow">if</font> ( !s ) {
00215     qWarning( <font class="stringliteral">"can't locate parag at %d, last parag: %d"</font>, id, doc-&gt;lastParag()-&gt;paragId() );
00216     <font class="keywordflow">return</font> 0;
00217     }
00218 
00219     cursor.setParag( s );
00220     cursor.setIndex( index );
00221     QString str = QTextString::toString( text );
00222     cursor.insert( str, TRUE, &amp;text );
00223     cursor.setParag( s );
00224     cursor.setIndex( index );
00225     <font class="keywordflow">if</font> ( c ) {
00226     c-&gt;setParag( s );
00227     c-&gt;setIndex( index );
00228     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)text.size(); ++i )
00229         c-&gt;gotoRight();
00230     }
00231 
00232     QValueList&lt; QPtrVector&lt;QStyleSheetItem&gt; &gt;::Iterator it = oldStyles.begin();
00233     QValueList&lt;QStyleSheetItem::ListStyle&gt;::Iterator lit = oldListStyles.begin();
00234     <font class="keywordtype">int</font> i = 0;
00235     QTextParag *p = s;
00236     <font class="keywordtype">bool</font> end = FALSE;
00237     <font class="keywordflow">while</font> ( p ) {
00238     <font class="keywordflow">if</font> ( it != oldStyles.end() )
00239         p-&gt;setStyleSheetItems( *it );
00240     <font class="keywordflow">else</font>
00241         end = TRUE;
00242     <font class="keywordflow">if</font> ( lit != oldListStyles.end() )
00243         p-&gt;setListStyle( *lit );
00244     <font class="keywordflow">else</font>
00245         end = TRUE;
00246     <font class="keywordflow">if</font> ( i &lt; (int)oldAligns.size() )
00247         p-&gt;setAlignment( oldAligns.at( i ) );
00248     <font class="keywordflow">else</font>
00249         end = TRUE;
00250     <font class="keywordflow">if</font> ( end )
00251         <font class="keywordflow">break</font>;
00252     p = p-&gt;next();
00253     ++it;
00254     ++lit;
00255     ++i;
00256     }
00257 
00258     s = cursor.parag();
00259     <font class="keywordflow">while</font> ( s ) {
00260     s-&gt;format();
00261     s-&gt;setChanged( TRUE );
00262     <font class="keywordflow">if</font> ( s == c-&gt;parag() )
00263         <font class="keywordflow">break</font>;
00264     s = s-&gt;next();
00265     }
00266 
00267     <font class="keywordflow">return</font> &amp;cursor;
00268 }
00269 
00270 QTextFormatCommand::QTextFormatCommand( QTextDocument *d, <font class="keywordtype">int</font> sid, <font class="keywordtype">int</font> sidx, <font class="keywordtype">int</font> eid, <font class="keywordtype">int</font> eidx,
00271                     <font class="keyword">const</font> QMemArray&lt;QTextStringChar&gt; &amp;old, QTextFormat *f, <font class="keywordtype">int</font> fl )
00272     : QTextCommand( d ), startId( sid ), startIndex( sidx ), endId( eid ), endIndex( eidx ), format( f ), oldFormats( old ), flags( fl )
00273 {
00274     format = d-&gt;formatCollection()-&gt;format( f );
00275     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> j = 0; j &lt; (int)oldFormats.size(); ++j ) {
00276     <font class="keywordflow">if</font> ( oldFormats[ j ].format() )
00277         oldFormats[ j ].format()-&gt;addRef();
00278     }
00279 }
00280 
00281 QTextFormatCommand::~QTextFormatCommand()
00282 {
00283     format-&gt;removeRef();
00284     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> j = 0; j &lt; (int)oldFormats.size(); ++j ) {
00285     <font class="keywordflow">if</font> ( oldFormats[ j ].format() )
00286         oldFormats[ j ].format()-&gt;removeRef();
00287     }
00288 }
00289 
00290 QTextCursor *QTextFormatCommand::execute( QTextCursor *c )
00291 {
00292     QTextParag *sp = doc-&gt;paragAt( startId );
00293     QTextParag *ep = doc-&gt;paragAt( endId );
00294     <font class="keywordflow">if</font> ( !sp || !ep )
00295     <font class="keywordflow">return</font> c;
00296 
00297     QTextCursor start( doc );
00298     start.setParag( sp );
00299     start.setIndex( startIndex );
00300     QTextCursor end( doc );
00301     end.setParag( ep );
00302     end.setIndex( endIndex );
00303 
00304     doc-&gt;setSelectionStart( QTextDocument::Temp, &amp;start );
00305     doc-&gt;setSelectionEnd( QTextDocument::Temp, &amp;end );
00306     doc-&gt;setFormat( QTextDocument::Temp, format, flags );
00307     doc-&gt;removeSelection( QTextDocument::Temp );
00308     *c = end;
00309     <font class="keywordflow">return</font> c;
00310 }
00311 
00312 QTextCursor *QTextFormatCommand::unexecute( QTextCursor *c )
00313 {
00314     QTextParag *sp = doc-&gt;paragAt( startId );
00315     QTextParag *ep = doc-&gt;paragAt( endId );
00316     <font class="keywordflow">if</font> ( !sp || !ep )
00317     <font class="keywordflow">return</font> 0;
00318 
00319     <font class="keywordtype">int</font> idx = startIndex;
00320     <font class="keywordtype">int</font> fIndex = 0;
00321     <font class="keywordflow">while</font> ( TRUE ) {
00322     <font class="keywordflow">if</font> ( oldFormats.at( fIndex ).c == <font class="charliteral">'\n'</font> ) {
00323         <font class="keywordflow">if</font> ( idx &gt; 0 ) {
00324         <font class="keywordflow">if</font> ( idx &lt; sp-&gt;length() &amp;&amp; fIndex &gt; 0 )
00325             sp-&gt;setFormat( idx, 1, oldFormats.at( fIndex - 1 ).format() );
00326         <font class="keywordflow">if</font> ( sp == ep )
00327             <font class="keywordflow">break</font>;
00328         sp = sp-&gt;next();
00329         idx = 0;
00330         }
00331         fIndex++;
00332     }
00333     <font class="keywordflow">if</font> ( oldFormats.at( fIndex ).format() )
00334         sp-&gt;setFormat( idx, 1, oldFormats.at( fIndex ).format() );
00335     idx++;
00336     fIndex++;
00337     <font class="keywordflow">if</font> ( fIndex &gt;= (int)oldFormats.size() )
00338         <font class="keywordflow">break</font>;
00339     <font class="keywordflow">if</font> ( idx &gt;= sp-&gt;length() ) {
00340         <font class="keywordflow">if</font> ( sp == ep )
00341         <font class="keywordflow">break</font>;
00342         sp = sp-&gt;next();
00343         idx = 0;
00344     }
00345     }
00346 
00347     QTextCursor end( doc );
00348     end.setParag( ep );
00349     end.setIndex( endIndex );
00350     *c = end;
00351     <font class="keywordflow">return</font> c;
00352 }
00353 
00354 QTextAlignmentCommand::QTextAlignmentCommand( QTextDocument *d, <font class="keywordtype">int</font> fParag, <font class="keywordtype">int</font> lParag, <font class="keywordtype">int</font> na, <font class="keyword">const</font> QMemArray&lt;int&gt; &amp;oa )
00355     : QTextCommand( d ), firstParag( fParag ), lastParag( lParag ), newAlign( na ), oldAligns( oa )
00356 {
00357 }
00358 
00359 QTextCursor *QTextAlignmentCommand::execute( QTextCursor *c )
00360 {
00361     QTextParag *p = doc-&gt;paragAt( firstParag );
00362     <font class="keywordflow">if</font> ( !p )
00363     <font class="keywordflow">return</font> c;
00364     <font class="keywordflow">while</font> ( p ) {
00365     p-&gt;setAlignment( newAlign );
00366     <font class="keywordflow">if</font> ( p-&gt;paragId() == lastParag )
00367         <font class="keywordflow">break</font>;
00368     p = p-&gt;next();
00369     }
00370     <font class="keywordflow">return</font> c;
00371 }
00372 
00373 QTextCursor *QTextAlignmentCommand::unexecute( QTextCursor *c )
00374 {
00375     QTextParag *p = doc-&gt;paragAt( firstParag );
00376     <font class="keywordflow">if</font> ( !p )
00377     <font class="keywordflow">return</font> c;
00378     <font class="keywordtype">int</font> i = 0;
00379     <font class="keywordflow">while</font> ( p ) {
00380     <font class="keywordflow">if</font> ( i &lt; (int)oldAligns.size() )
00381         p-&gt;setAlignment( oldAligns.at( i ) );
00382     <font class="keywordflow">if</font> ( p-&gt;paragId() == lastParag )
00383         <font class="keywordflow">break</font>;
00384     p = p-&gt;next();
00385     ++i;
00386     }
00387     <font class="keywordflow">return</font> c;
00388 }
00389 
00390 QTextParagTypeCommand::QTextParagTypeCommand( QTextDocument *d, <font class="keywordtype">int</font> fParag, <font class="keywordtype">int</font> lParag, <font class="keywordtype">bool</font> l,
00391                           QStyleSheetItem::ListStyle s, <font class="keyword">const</font> QValueList&lt; QPtrVector&lt;QStyleSheetItem&gt; &gt; &amp;os,
00392                           <font class="keyword">const</font> QValueList&lt;QStyleSheetItem::ListStyle&gt; &amp;ols )
00393     : QTextCommand( d ), firstParag( fParag ), lastParag( lParag ), list( l ), listStyle( s ), oldStyles( os ), oldListStyles( ols )
00394 {
00395 }
00396 
00397 QTextCursor *QTextParagTypeCommand::execute( QTextCursor *c )
00398 {
00399     QTextParag *p = doc-&gt;paragAt( firstParag );
00400     <font class="keywordflow">if</font> ( !p )
00401     <font class="keywordflow">return</font> c;
00402     <font class="keywordflow">while</font> ( p ) {
00403     p-&gt;setList( list, (<font class="keywordtype">int</font>)listStyle );
00404     <font class="keywordflow">if</font> ( p-&gt;paragId() == lastParag )
00405         <font class="keywordflow">break</font>;
00406     p = p-&gt;next();
00407     }
00408     <font class="keywordflow">return</font> c;
00409 }
00410 
00411 QTextCursor *QTextParagTypeCommand::unexecute( QTextCursor *c )
00412 {
00413     QTextParag *p = doc-&gt;paragAt( firstParag );
00414     <font class="keywordflow">if</font> ( !p )
00415     <font class="keywordflow">return</font> c;
00416     QValueList&lt; QPtrVector&lt;QStyleSheetItem&gt; &gt;::Iterator it = oldStyles.begin();
00417     QValueList&lt;QStyleSheetItem::ListStyle&gt;::Iterator lit = oldListStyles.begin();
00418     <font class="keywordflow">while</font> ( p ) {
00419     <font class="keywordflow">if</font> ( it != oldStyles.end() )
00420         p-&gt;setStyleSheetItems( *it );
00421     <font class="keywordflow">if</font> ( lit != oldListStyles.end() )
00422         p-&gt;setListStyle( *lit );
00423     <font class="keywordflow">if</font> ( p-&gt;paragId() == lastParag )
00424         <font class="keywordflow">break</font>;
00425     p = p-&gt;next();
00426     ++it;
00427     ++lit;
00428     }
00429     <font class="keywordflow">return</font> c;
00430 }
00431 
00432 <font class="comment">// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
00433 
00434 QTextCursor::QTextCursor( QTextDocument *d )
00435     : doc( d ), ox( 0 ), oy( 0 )
00436 {
00437     nested = FALSE;
00438     idx = 0;
00439     string = doc ? doc-&gt;firstParag() : 0;
00440     tmpIndex = -1;
00441 }
00442 
00443 QTextCursor::QTextCursor()
00444 {
00445 }
00446 
00447 QTextCursor::QTextCursor( <font class="keyword">const</font> QTextCursor &amp;c )
00448 {
00449     doc = c.doc;
00450     ox = c.ox;
00451     oy = c.oy;
00452     nested = c.nested;
00453     idx = c.idx;
00454     string = c.string;
00455     tmpIndex = c.tmpIndex;
00456     indices = c.indices;
00457     parags = c.parags;
00458     xOffsets = c.xOffsets;
00459     yOffsets = c.yOffsets;
00460 }
00461 
00462 QTextCursor &amp;QTextCursor::operator=( <font class="keyword">const</font> QTextCursor &amp;c )
00463 {
00464     doc = c.doc;
00465     ox = c.ox;
00466     oy = c.oy;
00467     nested = c.nested;
00468     idx = c.idx;
00469     string = c.string;
00470     tmpIndex = c.tmpIndex;
00471     indices = c.indices;
00472     parags = c.parags;
00473     xOffsets = c.xOffsets;
00474     yOffsets = c.yOffsets;
00475 
00476     <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00477 }
00478 
00479 <font class="keywordtype">bool</font> QTextCursor::operator==( <font class="keyword">const</font> QTextCursor &amp;c )<font class="keyword"> const</font>
00480 <font class="keyword"></font>{
00481     <font class="keywordflow">return</font> doc == c.doc &amp;&amp; string == c.string &amp;&amp; idx == c.idx;
00482 }
00483 
00484 <font class="keywordtype">int</font> QTextCursor::totalOffsetX()<font class="keyword"> const</font>
00485 <font class="keyword"></font>{
00486     <font class="keywordflow">if</font> ( !nested )
00487     <font class="keywordflow">return</font> 0;
00488     QValueStack&lt;int&gt;::ConstIterator xit = xOffsets.begin();
00489     <font class="keywordtype">int</font> xoff = ox;
00490     <font class="keywordflow">for</font> ( ; xit != xOffsets.end(); ++xit )
00491     xoff += *xit;
00492     <font class="keywordflow">return</font> xoff;
00493 }
00494 
00495 <font class="keywordtype">int</font> QTextCursor::totalOffsetY()<font class="keyword"> const</font>
00496 <font class="keyword"></font>{
00497     <font class="keywordflow">if</font> ( !nested )
00498     <font class="keywordflow">return</font> 0;
00499     QValueStack&lt;int&gt;::ConstIterator yit = yOffsets.begin();
00500     <font class="keywordtype">int</font> yoff = oy;
00501     <font class="keywordflow">for</font> ( ; yit != yOffsets.end(); ++yit )
00502     yoff += *yit;
00503     <font class="keywordflow">return</font> yoff;
00504 }
00505 
00506 <font class="keywordtype">void</font> QTextCursor::gotoIntoNested( <font class="keyword">const</font> QPoint &amp;globalPos )
00507 {
00508     <font class="keywordflow">if</font> ( !doc )
00509     <font class="keywordflow">return</font>;
00510     push();
00511     ox = 0;
00512     <font class="keywordtype">int</font> bl, y;
00513     string-&gt;lineHeightOfChar( idx, &amp;bl, &amp;y );
00514     oy = y + string-&gt;rect().y();
00515     nested = TRUE;
00516     QPoint p( globalPos.x() - offsetX(), globalPos.y() - offsetY() );
00517     Q_ASSERT( string-&gt;at( idx )-&gt;isCustom() );
00518     string-&gt;at( idx )-&gt;customItem()-&gt;enterAt( <font class="keyword">this</font>, doc, string, idx, ox, oy, p );
00519 }
00520 
00521 <font class="keywordtype">void</font> QTextCursor::invalidateNested()
00522 {
00523     <font class="keywordflow">if</font> ( nested ) {
00524     QValueStack&lt;QTextParag*&gt;::Iterator it = parags.begin();
00525     QValueStack&lt;int&gt;::Iterator it2 = indices.begin();
00526     <font class="keywordflow">for</font> ( ; it != parags.end(); ++it, ++it2 ) {
00527         <font class="keywordflow">if</font> ( *it == string )
00528         <font class="keywordflow">continue</font>;
00529         (*it)-&gt;invalidate( 0 );
00530         <font class="keywordflow">if</font> ( (*it)-&gt;at( *it2 )-&gt;isCustom() )
00531         (*it)-&gt;at( *it2 )-&gt;customItem()-&gt;invalidate();
00532     }
00533     }
00534 }
00535 
00536 <font class="keywordtype">void</font> QTextCursor::insert( <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">bool</font> checkNewLine, QMemArray&lt;QTextStringChar&gt; *formatting )
00537 {
00538     tmpIndex = -1;
00539     <font class="keywordtype">bool</font> justInsert = TRUE;
00540     QString s( str );
00541 <font class="preprocessor">#if defined(Q_WS_WIN)</font>
00542 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( checkNewLine )
00543     s = s.replace( QRegExp( <font class="stringliteral">"\\r"</font> ), <font class="stringliteral">""</font> );
00544 <font class="preprocessor">#endif</font>
00545 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( checkNewLine )
00546     justInsert = s.find( <font class="charliteral">'\n'</font> ) == -1;
00547     <font class="keywordflow">if</font> ( justInsert ) {
00548     string-&gt;insert( idx, s );
00549     <font class="keywordflow">if</font> ( formatting ) {
00550         <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)s.length(); ++i ) {
00551         <font class="keywordflow">if</font> ( formatting-&gt;at( i ).format() ) {
00552             formatting-&gt;at( i ).format()-&gt;addRef();
00553             string-&gt;string()-&gt;setFormat( idx + i, formatting-&gt;at( i ).format(), TRUE );
00554         }
00555         }
00556     }
00557     idx += s.length();
00558     } <font class="keywordflow">else</font> {
00559     QStringList lst = QStringList::split( <font class="charliteral">'\n'</font>, s, TRUE );
00560     QStringList::Iterator it = lst.begin();
00561     <font class="keywordtype">int</font> y = string-&gt;rect().y() + string-&gt;rect().height();
00562     <font class="keywordtype">int</font> lastIndex = 0;
00563     <font class="keywordflow">for</font> ( ; it != lst.end(); ++it ) {
00564         <font class="keywordflow">if</font> ( it != lst.begin() ) {
00565         splitAndInsertEmptyParag( FALSE, TRUE );
00566         string-&gt;setEndState( -1 );
00567         string-&gt;prev()-&gt;format( -1, FALSE );
00568         }
00569         QString s = *it;
00570         <font class="keywordflow">if</font> ( s.isEmpty() )
00571         <font class="keywordflow">continue</font>;
00572         string-&gt;insert( idx, s );
00573         <font class="keywordflow">if</font> ( formatting ) {
00574         <font class="keywordtype">int</font> len = s.length();
00575         <font class="keywordflow">if</font> ( it != --lst.end() )
00576             len++;
00577         <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; len; ++i ) {
00578             <font class="keywordflow">if</font> ( formatting-&gt;at( i + lastIndex ).format() ) {
00579             formatting-&gt;at( i + lastIndex ).format()-&gt;addRef();
00580             string-&gt;string()-&gt;setFormat( i + idx, formatting-&gt;at( i + lastIndex ).format(), TRUE );
00581             }
00582         }
00583         lastIndex += len;
00584         }
00585 
00586         idx += s.length();
00587     }
00588     string-&gt;format( -1, FALSE );
00589     <font class="keywordtype">int</font> dy = string-&gt;rect().y() + string-&gt;rect().height() - y;
00590     QTextParag *p = string;
00591     p-&gt;setParagId( p-&gt;prev()-&gt;paragId() + 1 );
00592     p = p-&gt;next();
00593     <font class="keywordflow">while</font> ( p ) {
00594         p-&gt;setParagId( p-&gt;prev()-&gt;paragId() + 1 );
00595         p-&gt;move( dy );
00596         p-&gt;invalidate( 0 );
00597         p-&gt;setEndState( -1 );
00598         p = p-&gt;next();
00599     }
00600     }
00601 
00602     <font class="keywordtype">int</font> h = string-&gt;rect().height();
00603     string-&gt;format( -1, TRUE );
00604     <font class="keywordflow">if</font> ( h != string-&gt;rect().height() )
00605     invalidateNested();
00606     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( doc &amp;&amp; doc-&gt;parent() )
00607     doc-&gt;nextDoubleBuffered = TRUE;
00608 }
00609 
00610 <font class="keywordtype">void</font> QTextCursor::gotoLeft()
00611 {
00612     tmpIndex = -1;
00613 
00614     <font class="keywordflow">if</font> ( idx &gt; 0 ) {
00615     idx--;
00616     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( string-&gt;prev() ) {
00617     string = string-&gt;prev();
00618     <font class="keywordflow">while</font> ( !string-&gt;isVisible() )
00619         string = string-&gt;prev();
00620     idx = string-&gt;length() - 1;
00621     } <font class="keywordflow">else</font> {
00622     <font class="keywordflow">if</font> ( nested ) {
00623         pop();
00624         processNesting( Prev );
00625         <font class="keywordflow">if</font> ( idx == -1 ) {
00626         pop();
00627         <font class="keywordflow">if</font> ( idx &gt; 0 ) {
00628             idx--;
00629         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( string-&gt;prev() ) {
00630             string = string-&gt;prev();
00631             idx = string-&gt;length() - 1;
00632         }
00633         }
00634     }
00635     }
00636 
00637     <font class="keywordflow">if</font> ( string-&gt;at( idx )-&gt;isCustom() &amp;&amp;
00638      string-&gt;at( idx )-&gt;customItem()-&gt;isNested() ) {
00639     processNesting( EnterEnd );
00640     }
00641 }
00642 
00643 <font class="keywordtype">void</font> QTextCursor::push()
00644 {
00645     indices.push( idx );
00646     parags.push( string );
00647     xOffsets.push( ox );
00648     yOffsets.push( oy );
00649     nestedStack.push( nested );
00650 }
00651 
00652 <font class="keywordtype">void</font> QTextCursor::pop()
00653 {
00654     <font class="keywordflow">if</font> ( !doc )
00655     <font class="keywordflow">return</font>;
00656     idx = indices.pop();
00657     string = parags.pop();
00658     ox = xOffsets.pop();
00659     oy = yOffsets.pop();
00660     <font class="keywordflow">if</font> ( doc-&gt;parent() )
00661     doc = doc-&gt;parent();
00662     nested = nestedStack.pop();
00663 }
00664 
00665 <font class="keywordtype">void</font> QTextCursor::restoreState()
00666 {
00667     <font class="keywordflow">while</font> ( !indices.isEmpty() )
00668     pop();
00669 }
00670 
00671 <font class="keywordtype">bool</font> QTextCursor::place( <font class="keyword">const</font> QPoint &amp;p, QTextParag *s )
00672 {
00673     QPoint pos( p );
00674     QRect r;
00675     <font class="keywordflow">if</font> ( pos.y() &lt; s-&gt;rect().y() )
00676     pos.setY( s-&gt;rect().y() );
00677     <font class="keywordflow">while</font> ( s ) {
00678     r = s-&gt;rect();
00679     r.setWidth( doc ? doc-&gt;width() : QWIDGETSIZE_MAX );
00680     <font class="keywordflow">if</font> ( !s-&gt;next() || ( pos.y() &gt;= r.y() &amp;&amp; pos.y() &lt; s-&gt;next()-&gt;rect().y() ) )
00681         <font class="keywordflow">break</font>;
00682     s = s-&gt;next();
00683     }
00684 
00685     <font class="keywordflow">if</font> ( !s )
00686     <font class="keywordflow">return</font> FALSE;
00687 
00688     setParag( s, FALSE );
00689     <font class="keywordtype">int</font> y = s-&gt;rect().y();
00690     <font class="keywordtype">int</font> lines = s-&gt;lines();
00691     QTextStringChar *chr = 0;
00692     <font class="keywordtype">int</font> index = 0;
00693     <font class="keywordtype">int</font> i = 0;
00694     <font class="keywordtype">int</font> cy = 0;
00695     <font class="comment">//int ch = 0;</font>
00696     <font class="keywordflow">for</font> ( ; i &lt; lines; ++i ) {
00697     chr = s-&gt;lineStartOfLine( i, &amp;index );
00698     cy = s-&gt;lineY( i );
00699     <font class="comment">//ch = s-&gt;lineHeight( i );</font>
00700     <font class="keywordflow">if</font> ( !chr )
00701         <font class="keywordflow">return</font> FALSE;
00702     <font class="keywordflow">if</font> ( i &lt; lines - 1 &amp;&amp; pos.y() &gt;= y + cy &amp;&amp; pos.y() &lt;= y + s-&gt;lineY( i+1 ) )
00703         <font class="keywordflow">break</font>;
00704     }
00705     <font class="keywordtype">int</font> nextLine;
00706     <font class="keywordflow">if</font> ( i &lt; lines - 1 )
00707     s-&gt;lineStartOfLine( i+1, &amp;nextLine );
00708     <font class="keywordflow">else</font>
00709     nextLine = s-&gt;length();
00710     i = index;
00711     <font class="keywordtype">int</font> x = s-&gt;rect().x();
00712     <font class="keywordflow">if</font> ( pos.x() &lt; x )
00713     pos.setX( x + 1 );
00714     <font class="keywordtype">int</font> cw;
00715     <font class="keywordtype">int</font> curpos = s-&gt;length()-1;
00716     <font class="keywordtype">int</font> dist = 10000000;
00717     <font class="keywordtype">bool</font> inCustom = FALSE;
00718     <font class="keywordflow">while</font> ( i &lt; nextLine ) {
00719     chr = s-&gt;at(i);
00720     <font class="keywordtype">int</font> cpos = x + chr-&gt;x;
00721     cw = s-&gt;string()-&gt;width( i );
00722     <font class="keywordflow">if</font> ( chr-&gt;isCustom() &amp;&amp; chr-&gt;customItem()-&gt;isNested() ) {
00723         <font class="keywordflow">if</font> ( pos.x() &gt;= cpos &amp;&amp; pos.x() &lt;= cpos + cw &amp;&amp;
00724          pos.y() &gt;= y + cy &amp;&amp; pos.y() &lt;= y + cy + chr-&gt;height() ) {
00725         inCustom = TRUE;
00726         curpos = i;
00727         <font class="keywordflow">break</font>;
00728         }
00729     } <font class="keywordflow">else</font> {
00730         <font class="keywordflow">if</font>( chr-&gt;rightToLeft )
00731         cpos += cw;
00732         <font class="keywordtype">int</font> d = cpos - pos.x();
00733         <font class="keywordtype">bool</font> dm = d &lt; 0 ? !chr-&gt;rightToLeft : chr-&gt;rightToLeft;
00734         <font class="keywordflow">if</font> ( QABS( d ) &lt; dist || (dist == d &amp;&amp; dm == TRUE ) ) {
00735         dist = QABS( d );
00736         curpos = i;
00737         }
00738     }
00739     i++;
00740     }
00741     setIndex( curpos, FALSE );
00742 
00743     <font class="keywordflow">if</font> ( inCustom &amp;&amp; doc &amp;&amp; parag()-&gt;at( curpos )-&gt;isCustom() &amp;&amp; parag()-&gt;at( curpos )-&gt;customItem()-&gt;isNested() ) {
00744     gotoIntoNested( pos );
00745     QPoint p( pos.x() - offsetX(), pos.y() - offsetY() );
00746     <font class="keywordflow">if</font> ( !place( p, document()-&gt;firstParag() ) )
00747         pop();
00748     }
00749     <font class="keywordflow">return</font> TRUE;
00750 }
00751 
00752 <font class="keywordtype">void</font> QTextCursor::processNesting( Operation op )
00753 {
00754     <font class="keywordflow">if</font> ( !doc )
00755     <font class="keywordflow">return</font>;
00756     push();
00757     ox = 0;
00758     <font class="keywordtype">int</font> bl, y;
00759     string-&gt;lineHeightOfChar( idx, &amp;bl, &amp;y );
00760     oy = y + string-&gt;rect().y();
00761     nested = TRUE;
00762 
00763     <font class="keywordflow">switch</font> ( op ) {
00764     <font class="keywordflow">case</font> EnterBegin:
00765     string-&gt;at( idx )-&gt;customItem()-&gt;enter( <font class="keyword">this</font>, doc, string, idx, ox, oy );
00766     <font class="keywordflow">break</font>;
00767     <font class="keywordflow">case</font> EnterEnd:
00768     string-&gt;at( idx )-&gt;customItem()-&gt;enter( <font class="keyword">this</font>, doc, string, idx, ox, oy, TRUE );
00769     <font class="keywordflow">break</font>;
00770     <font class="keywordflow">case</font> Next:
00771     string-&gt;at( idx )-&gt;customItem()-&gt;next( <font class="keyword">this</font>, doc, string, idx, ox, oy );
00772     <font class="keywordflow">break</font>;
00773     <font class="keywordflow">case</font> Prev:
00774     string-&gt;at( idx )-&gt;customItem()-&gt;prev( <font class="keyword">this</font>, doc, string, idx, ox, oy );
00775     <font class="keywordflow">break</font>;
00776     <font class="keywordflow">case</font> Down:
00777     string-&gt;at( idx )-&gt;customItem()-&gt;down( <font class="keyword">this</font>, doc, string, idx, ox, oy );
00778     <font class="keywordflow">break</font>;
00779     <font class="keywordflow">case</font> Up:
00780     string-&gt;at( idx )-&gt;customItem()-&gt;up( <font class="keyword">this</font>, doc, string, idx, ox, oy );
00781     <font class="keywordflow">break</font>;
00782     }
00783 }
00784 
00785 <font class="keywordtype">void</font> QTextCursor::gotoRight()
00786 {
00787     tmpIndex = -1;
00788 
00789     <font class="keywordflow">if</font> ( string-&gt;at( idx )-&gt;isCustom() &amp;&amp;
00790      string-&gt;at( idx )-&gt;customItem()-&gt;isNested() ) {
00791     processNesting( EnterBegin );
00792     <font class="keywordflow">return</font>;
00793     }
00794 
00795     <font class="keywordflow">if</font> ( idx &lt; string-&gt;length() - 1 ) {
00796     idx++;
00797     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( string-&gt;next() ) {
00798     string = string-&gt;next();
00799     <font class="keywordflow">while</font> ( !string-&gt;isVisible() )
00800         string = string-&gt;next();
00801     idx = 0;
00802     } <font class="keywordflow">else</font> {
00803     <font class="keywordflow">if</font> ( nested ) {
00804         pop();
00805         processNesting( Next );
00806         <font class="keywordflow">if</font> ( idx == -1 ) {
00807         pop();
00808         <font class="keywordflow">if</font> ( idx &lt; string-&gt;length() - 1 ) {
00809             idx++;
00810         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( string-&gt;next() ) {
00811             string = string-&gt;next();
00812             idx = 0;
00813         }
00814         }
00815     }
00816     }
00817 }
00818 
00819 <font class="keywordtype">void</font> QTextCursor::gotoUp()
00820 {
00821     <font class="keywordtype">int</font> indexOfLineStart;
00822     <font class="keywordtype">int</font> line;
00823     QTextStringChar *c = string-&gt;lineStartOfChar( idx, &amp;indexOfLineStart, &amp;line );
00824     <font class="keywordflow">if</font> ( !c )
00825     <font class="keywordflow">return</font>;
00826 
00827     tmpIndex = QMAX( tmpIndex, idx - indexOfLineStart );
00828     <font class="keywordflow">if</font> ( indexOfLineStart == 0 ) {
00829     <font class="keywordflow">if</font> ( !string-&gt;prev() ) {
00830         <font class="keywordflow">if</font> ( !nested )
00831         <font class="keywordflow">return</font>;
00832         pop();
00833         processNesting( Up );
00834         <font class="keywordflow">if</font> ( idx == -1 ) {
00835         pop();
00836         <font class="keywordflow">if</font> ( !string-&gt;prev() )
00837             <font class="keywordflow">return</font>;
00838         idx = tmpIndex = 0;
00839         } <font class="keywordflow">else</font> {
00840         tmpIndex = -1;
00841         <font class="keywordflow">return</font>;
00842         }
00843     }
00844     string = string-&gt;prev();
00845     <font class="keywordflow">while</font> ( !string-&gt;isVisible() )
00846         string = string-&gt;prev();
00847     <font class="keywordtype">int</font> lastLine = string-&gt;lines() - 1;
00848     <font class="keywordflow">if</font> ( !string-&gt;lineStartOfLine( lastLine, &amp;indexOfLineStart ) )
00849         <font class="keywordflow">return</font>;
00850     <font class="keywordflow">if</font> ( indexOfLineStart + tmpIndex &lt; string-&gt;length() )
00851         idx = indexOfLineStart + tmpIndex;
00852     <font class="keywordflow">else</font>
00853         idx = string-&gt;length() - 1;
00854     } <font class="keywordflow">else</font> {
00855     --line;
00856     <font class="keywordtype">int</font> oldIndexOfLineStart = indexOfLineStart;
00857     <font class="keywordflow">if</font> ( !string-&gt;lineStartOfLine( line, &amp;indexOfLineStart ) )
00858         <font class="keywordflow">return</font>;
00859     <font class="keywordflow">if</font> ( indexOfLineStart + tmpIndex &lt; oldIndexOfLineStart )
00860         idx = indexOfLineStart + tmpIndex;
00861     <font class="keywordflow">else</font>
00862         idx = oldIndexOfLineStart - 1;
00863     }
00864 }
00865 
00866 <font class="keywordtype">void</font> QTextCursor::gotoDown()
00867 {
00868     <font class="keywordtype">int</font> indexOfLineStart;
00869     <font class="keywordtype">int</font> line;
00870     QTextStringChar *c = string-&gt;lineStartOfChar( idx, &amp;indexOfLineStart, &amp;line );
00871     <font class="keywordflow">if</font> ( !c )
00872     <font class="keywordflow">return</font>;
00873 
00874     tmpIndex = QMAX( tmpIndex, idx - indexOfLineStart );
00875     <font class="keywordflow">if</font> ( line == string-&gt;lines() - 1 ) {
00876     <font class="keywordflow">if</font> ( !string-&gt;next() ) {
00877         <font class="keywordflow">if</font> ( !nested )
00878         <font class="keywordflow">return</font>;
00879         pop();
00880         processNesting( Down );
00881         <font class="keywordflow">if</font> ( idx == -1 ) {
00882         pop();
00883         <font class="keywordflow">if</font> ( !string-&gt;next() )
00884             <font class="keywordflow">return</font>;
00885         idx = tmpIndex = 0;
00886         } <font class="keywordflow">else</font> {
00887         tmpIndex = -1;
00888         <font class="keywordflow">return</font>;
00889         }
00890     }
00891     string = string-&gt;next();
00892     <font class="keywordflow">while</font> ( !string-&gt;isVisible() )
00893         string = string-&gt;next();
00894     <font class="keywordflow">if</font> ( !string-&gt;lineStartOfLine( 0, &amp;indexOfLineStart ) )
00895         <font class="keywordflow">return</font>;
00896     <font class="keywordtype">int</font> end;
00897     <font class="keywordflow">if</font> ( string-&gt;lines() == 1 )
00898         end = string-&gt;length();
00899     <font class="keywordflow">else</font>
00900         string-&gt;lineStartOfLine( 1, &amp;end );
00901     <font class="keywordflow">if</font> ( indexOfLineStart + tmpIndex &lt; end )
00902         idx = indexOfLineStart + tmpIndex;
00903     <font class="keywordflow">else</font>
00904         idx = end - 1;
00905     } <font class="keywordflow">else</font> {
00906     ++line;
00907     <font class="keywordtype">int</font> end;
00908     <font class="keywordflow">if</font> ( line == string-&gt;lines() - 1 )
00909         end = string-&gt;length();
00910     <font class="keywordflow">else</font>
00911         string-&gt;lineStartOfLine( line + 1, &amp;end );
00912     <font class="keywordflow">if</font> ( !string-&gt;lineStartOfLine( line, &amp;indexOfLineStart ) )
00913         <font class="keywordflow">return</font>;
00914     <font class="keywordflow">if</font> ( indexOfLineStart + tmpIndex &lt; end )
00915         idx = indexOfLineStart + tmpIndex;
00916     <font class="keywordflow">else</font>
00917         idx = end - 1;
00918     }
00919 }
00920 
00921 <font class="keywordtype">void</font> QTextCursor::gotoLineEnd()
00922 {
00923     tmpIndex = -1;
00924     <font class="keywordtype">int</font> indexOfLineStart;
00925     <font class="keywordtype">int</font> line;
00926     QTextStringChar *c = string-&gt;lineStartOfChar( idx, &amp;indexOfLineStart, &amp;line );
00927     <font class="keywordflow">if</font> ( !c )
00928     <font class="keywordflow">return</font>;
00929 
00930     <font class="keywordflow">if</font> ( line == string-&gt;lines() - 1 ) {
00931     idx = string-&gt;length() - 1;
00932     } <font class="keywordflow">else</font> {
00933     c = string-&gt;lineStartOfLine( ++line, &amp;indexOfLineStart );
00934     indexOfLineStart--;
00935     idx = indexOfLineStart;
00936     }
00937 }
00938 
00939 <font class="keywordtype">void</font> QTextCursor::gotoLineStart()
00940 {
00941     tmpIndex = -1;
00942     <font class="keywordtype">int</font> indexOfLineStart;
00943     <font class="keywordtype">int</font> line;
00944     QTextStringChar *c = string-&gt;lineStartOfChar( idx, &amp;indexOfLineStart, &amp;line );
00945     <font class="keywordflow">if</font> ( !c )
00946     <font class="keywordflow">return</font>;
00947 
00948     idx = indexOfLineStart;
00949 }
00950 
00951 <font class="keywordtype">void</font> QTextCursor::gotoHome()
00952 {
00953     tmpIndex = -1;
00954     <font class="keywordflow">if</font> ( doc )
00955     string = doc-&gt;firstParag();
00956     idx = 0;
00957 }
00958 
00959 <font class="keywordtype">void</font> QTextCursor::gotoEnd()
00960 {
00961     <font class="keywordflow">if</font> ( doc &amp;&amp; !doc-&gt;lastParag()-&gt;isValid() )
00962     {
00963         qDebug(<font class="stringliteral">"Last parag, %d, is invalid - aborting gotoEnd() !"</font>,doc-&gt;lastParag()-&gt;paragId());
00964     <font class="keywordflow">return</font>;
00965     }
00966 
00967     tmpIndex = -1;
00968     <font class="keywordflow">if</font> ( doc )
00969     string = doc-&gt;lastParag();
00970     idx = string-&gt;length() - 1;
00971     qDebug(<font class="stringliteral">"gotoEnd: going to parag %d, index %d"</font>,string-&gt;paragId(),idx);
00972 }
00973 
00974 <font class="keywordtype">void</font> QTextCursor::gotoPageUp( <font class="keywordtype">int</font> visibleHeight )
00975 {
00976     tmpIndex = -1;
00977     QTextParag *s = string;
00978     <font class="keywordtype">int</font> h = visibleHeight;
00979     <font class="keywordtype">int</font> y = s-&gt;rect().y();
00980     <font class="keywordflow">while</font> ( s ) {
00981     <font class="keywordflow">if</font> ( y - s-&gt;rect().y() &gt;= h )
00982         <font class="keywordflow">break</font>;
00983     s = s-&gt;prev();
00984     }
00985 
00986     <font class="keywordflow">if</font> ( !s &amp;&amp; doc )
00987     s = doc-&gt;firstParag();
00988 
00989     string = s;
00990     idx = 0;
00991 }
00992 
00993 <font class="keywordtype">void</font> QTextCursor::gotoPageDown( <font class="keywordtype">int</font> visibleHeight )
00994 {
00995     tmpIndex = -1;
00996     QTextParag *s = string;
00997     <font class="keywordtype">int</font> h = visibleHeight;
00998     <font class="keywordtype">int</font> y = s-&gt;rect().y();
00999     <font class="keywordflow">while</font> ( s ) {
01000     <font class="keywordflow">if</font> ( s-&gt;rect().y() - y &gt;= h )
01001         <font class="keywordflow">break</font>;
01002     s = s-&gt;next();
01003     }
01004 
01005     <font class="keywordflow">if</font> ( !s &amp;&amp; doc ) {
01006     s = doc-&gt;lastParag();
01007     string = s;
01008     idx = string-&gt;length() - 1;
01009     <font class="keywordflow">return</font>;
01010     }
01011 
01012     <font class="keywordflow">if</font> ( !s-&gt;isValid() )
01013     <font class="keywordflow">return</font>;
01014 
01015     string = s;
01016     idx = 0;
01017 }
01018 
01019 <font class="keywordtype">void</font> QTextCursor::gotoWordLeft()
01020 {
01021     gotoLeft();
01022     tmpIndex = -1;
01023     QTextString *s = string-&gt;string();
01024     <font class="keywordtype">bool</font> allowSame = FALSE;
01025     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = idx - 1; i &gt;= 0; --i ) {
01026     <font class="keywordflow">if</font> ( s-&gt;at( i ).c.isSpace() || s-&gt;at( i ).c == <font class="charliteral">'\t'</font> ) {
01027         <font class="keywordflow">if</font> ( !allowSame &amp;&amp; s-&gt;at( i ).c == s-&gt;at( idx ).c )
01028         <font class="keywordflow">continue</font>;
01029         idx = i + 1;
01030         <font class="keywordflow">return</font>;
01031     }
01032     <font class="keywordflow">if</font> ( !allowSame &amp;&amp; s-&gt;at( i ).c != s-&gt;at( idx ).c )
01033         allowSame = TRUE;
01034     }
01035 
01036     idx = 0;
01037 }
01038 
01039 <font class="keywordtype">void</font> QTextCursor::gotoWordRight()
01040 {
01041     tmpIndex = -1;
01042     QTextString *s = string-&gt;string();
01043     <font class="keywordtype">bool</font> allowSame = FALSE;
01044     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = idx + 1; i &lt; (int)s-&gt;length(); ++i ) {
01045     <font class="keywordflow">if</font> ( s-&gt;at( i ).c.isSpace() || s-&gt;at( i ).c == <font class="charliteral">'\t'</font> ) {
01046         <font class="keywordflow">if</font> ( !allowSame &amp;&amp;  s-&gt;at( i ).c == s-&gt;at( idx ).c )
01047         <font class="keywordflow">continue</font>;
01048         idx = i;
01049         <font class="keywordflow">return</font>;
01050     }
01051     <font class="keywordflow">if</font> ( !allowSame &amp;&amp; s-&gt;at( i ).c != s-&gt;at( idx ).c )
01052         allowSame = TRUE;
01053     }
01054 
01055     <font class="keywordflow">if</font> ( string-&gt;next() ) {
01056     string = string-&gt;next();
01057     <font class="keywordflow">while</font> ( !string-&gt;isVisible() )
01058         string = string-&gt;next();
01059     idx = 0;
01060     } <font class="keywordflow">else</font> {
01061     gotoLineEnd();
01062     }
01063 }
01064 
01065 <font class="keywordtype">bool</font> QTextCursor::atParagStart()
01066 {
01067     <font class="keywordflow">return</font> idx == 0;
01068 }
01069 
01070 <font class="keywordtype">bool</font> QTextCursor::atParagEnd()
01071 {
01072     <font class="keywordflow">return</font> idx == string-&gt;length() - 1;
01073 }
01074 
01075 <font class="keywordtype">void</font> QTextCursor::splitAndInsertEmptyParag( <font class="keywordtype">bool</font> ind, <font class="keywordtype">bool</font> updateIds )
01076 {
01077     <font class="keywordflow">if</font> ( !doc )
01078     <font class="keywordflow">return</font>;
01079     tmpIndex = -1;
01080     QTextFormat *f = 0;
01081     <font class="keywordflow">if</font> ( doc-&gt;useFormatCollection() ) {
01082     f = string-&gt;at( idx )-&gt;format();
01083     <font class="keywordflow">if</font> ( idx == string-&gt;length() - 1 &amp;&amp; idx &gt; 0 )
01084         f = string-&gt;at( idx - 1 )-&gt;format();
01085     <font class="keywordflow">if</font> ( f-&gt;isMisspelled() ) {
01086         f-&gt;removeRef();
01087         f = doc-&gt;formatCollection()-&gt;format( f-&gt;font(), f-&gt;color() );
01088     }
01089     }
01090 
01091     <font class="keywordflow">if</font> ( atParagStart() ) {
01092     QTextParag *p = string-&gt;prev();
01093     QTextParag *s = doc-&gt;createParag( doc, p, string, updateIds );
01094     <font class="keywordflow">if</font> ( f )
01095         s-&gt;setFormat( 0, 1, f, TRUE );
01096     s-&gt;copyParagData( string );
01097     <font class="keywordflow">if</font> ( ind ) {
01098         s-&gt;indent();
01099         s-&gt;format();
01100         indent();
01101         string-&gt;format();
01102     }
01103     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( atParagEnd() ) {
01104     QTextParag *n = string-&gt;next();
01105     QTextParag *s = doc-&gt;createParag( doc, string, n, updateIds );
01106     <font class="keywordflow">if</font> ( f )
01107         s-&gt;setFormat( 0, 1, f, TRUE );
01108     s-&gt;copyParagData( string );
01109     <font class="keywordflow">if</font> ( ind ) {
01110         <font class="keywordtype">int</font> oi, ni;
01111         s-&gt;indent( &amp;oi, &amp;ni );
01112         string = s;
01113         idx = ni;
01114     } <font class="keywordflow">else</font> {
01115         string = s;
01116         idx = 0;
01117     }
01118     } <font class="keywordflow">else</font> {
01119     QString str = string-&gt;string()-&gt;toString().mid( idx, 0xFFFFFF );
01120     QTextParag *n = string-&gt;next();
01121     QTextParag *s = doc-&gt;createParag( doc, string, n, updateIds );
01122     s-&gt;copyParagData( string );
01123     s-&gt;remove( 0, 1 );
01124     s-&gt;append( str, TRUE );
01125     <font class="keywordflow">for</font> ( uint i = 0; i &lt; str.length(); ++i ) {
01126         s-&gt;setFormat( i, 1, string-&gt;at( idx + i )-&gt;format(), TRUE );
01127         <font class="keywordflow">if</font> ( string-&gt;at( idx + i )-&gt;isCustom() ) {
01128         QTextCustomItem * item = string-&gt;at( idx + i )-&gt;customItem();
01129         s-&gt;at( i )-&gt;setCustomItem( item );
01130         string-&gt;at( idx + i )-&gt;loseCustomItem();
01131 <font class="preprocessor">#if 0</font>
01132 <font class="preprocessor"></font>        s-&gt;addCustomItem();
01133         string-&gt;removeCustomItem();
01134 <font class="preprocessor">#endif</font>
01135 <font class="preprocessor"></font>        doc-&gt;unregisterCustomItem( item, string );
01136         doc-&gt;registerCustomItem( item, s );
01137         }
01138     }
01139     string-&gt;truncate( idx );
01140     <font class="keywordflow">if</font> ( ind ) {
01141         <font class="keywordtype">int</font> oi, ni;
01142         s-&gt;indent( &amp;oi, &amp;ni );
01143         string = s;
01144         idx = ni;
01145     } <font class="keywordflow">else</font> {
01146         string = s;
01147         idx = 0;
01148     }
01149     }
01150 
01151     invalidateNested();
01152 }
01153 
01154 <font class="keywordtype">bool</font> QTextCursor::remove()
01155 {
01156     tmpIndex = -1;
01157     <font class="keywordflow">if</font> ( !atParagEnd() ) {
01158     string-&gt;remove( idx, 1 );
01159     <font class="keywordtype">int</font> h = string-&gt;rect().height();
01160     string-&gt;format( -1, TRUE );
01161     <font class="keywordflow">if</font> ( h != string-&gt;rect().height() )
01162         invalidateNested();
01163     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( doc &amp;&amp; doc-&gt;parent() )
01164         doc-&gt;nextDoubleBuffered = TRUE;
01165     <font class="keywordflow">return</font> FALSE;
01166     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( string-&gt;next() ) {
01167 
01168     <font class="keywordflow">if</font> ( string-&gt;length() == 1 ) {
01169         string-&gt;next()-&gt;setPrev( string-&gt;prev() );
01170         <font class="keywordflow">if</font> ( string-&gt;prev() )
01171         string-&gt;prev()-&gt;setNext( string-&gt;next() );
01172         QTextParag *p = string-&gt;next();
01173         <font class="keyword">delete</font> string;
01174         string = p;
01175         string-&gt;invalidate( 0 );
01176         QTextParag *s = string;
01177         <font class="keywordflow">while</font> ( s ) {
01178         s-&gt;id = s-&gt;p ? s-&gt;p-&gt;id + 1 : 0;
01179         s-&gt;state = -1;
01180         s-&gt;needPreProcess = TRUE;
01181         s-&gt;changed = TRUE;
01182         s = s-&gt;n;
01183         }
01184         string-&gt;format();
01185     } <font class="keywordflow">else</font> {
01186         string-&gt;join( string-&gt;next() );
01187     }
01188     invalidateNested();
01189     <font class="keywordflow">return</font> TRUE;
01190     }
01191     <font class="keywordflow">return</font> FALSE;
01192 }
01193 
01194 <font class="keywordtype">void</font> QTextCursor::killLine()
01195 {
01196     <font class="keywordflow">if</font> ( atParagEnd() )
01197     <font class="keywordflow">return</font>;
01198     string-&gt;remove( idx, string-&gt;length() - idx - 1 );
01199     <font class="keywordtype">int</font> h = string-&gt;rect().height();
01200     string-&gt;format( -1, TRUE );
01201     <font class="keywordflow">if</font> ( h != string-&gt;rect().height() )
01202     invalidateNested();
01203     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( doc &amp;&amp; doc-&gt;parent() )
01204     doc-&gt;nextDoubleBuffered = TRUE;
01205 }
01206 
01207 <font class="keywordtype">void</font> QTextCursor::indent()
01208 {
01209     <font class="keywordtype">int</font> oi = 0, ni = 0;
01210     string-&gt;indent( &amp;oi, &amp;ni );
01211     <font class="keywordflow">if</font> ( oi == ni )
01212     <font class="keywordflow">return</font>;
01213 
01214     <font class="keywordflow">if</font> ( idx &gt;= oi )
01215     idx += ni - oi;
01216     <font class="keywordflow">else</font>
01217     idx = ni;
01218 }
01219 
01220 <font class="keywordtype">void</font> QTextCursor::setDocument( QTextDocument *d )
01221 {
01222     doc = d;
01223     string = d-&gt;firstParag();
01224     idx = 0;
01225     nested = FALSE;
01226     restoreState();
01227     tmpIndex = -1;
01228 }
01229 
01230 <font class="comment">// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
01231 
01232 QTextDocument::QTextDocument( QTextDocument *p )
01233     : par( p ), parParag( 0 ), tc( 0 ), tArray( 0 ), tStopWidth( 0 )
01234 {
01235     fCollection = <font class="keyword">new</font> QTextFormatCollection;
01236     init();
01237 }
01238 
01239 QTextDocument::QTextDocument( QTextDocument *p, QTextFormatCollection *f )
01240     : par( p ), parParag( 0 ), tc( 0 ), tArray( 0 ), tStopWidth( 0 )
01241 {
01242     fCollection = f;
01243     init();
01244 }
01245 
01246 <font class="keywordtype">void</font> QTextDocument::init()
01247 {
01248 <font class="comment">//ANY_CHARSET_BEGIN</font>
01249     m_assignedFontMap = <font class="keyword">false</font>;  
01250     charsetMap = <font class="keyword">new</font> QMap&lt;QString, QFont::CharSet&gt;; 
01251     ASSERT(m_charsetMap);
01252     
01253     <font class="keywordflow">if</font> (!m_charsetMap) {
01254         m_assignedFontMap = <font class="keyword">true</font>;
01255         m_charsetMap = charsetMap;
01256     }
01257 <font class="comment">//ANY_CHARSET_END</font>
01258 
01259 <font class="preprocessor">#if defined(PARSER_DEBUG)</font>
01260 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">"new QTextDocument (%p)"</font>, <font class="keyword">this</font> );
01261 <font class="preprocessor">#endif</font>
01262 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( par )
01263     par-&gt;insertChild( <font class="keyword">this</font> );
01264     pProcessor = 0;
01265     useFC = TRUE;
01266     pFormatter = 0;
01267     indenter = 0;
01268     fParag = 0;
01269     txtFormat = Qt::AutoText;
01270     preferRichText = FALSE;
01271     pages = FALSE;
01272     focusIndicator.parag = 0;
01273     minw = 0;
01274     minwParag = 0;
01275     align = Qt3::AlignAuto;
01276     nSelections = 1;
01277     addMargs = FALSE;
01278 
01279     sheet_ = QStyleSheet::defaultSheet();
01280     factory_ = QMimeSourceFactory::defaultFactory();
01281     contxt = QString::null;
01282     fCollection-&gt;setStyleSheet( sheet_ );
01283 
01284     linkC = Qt::blue;
01285     underlLinks = TRUE;
01286     backBrush = 0;
01287     buf_pixmap = 0;
01288     nextDoubleBuffered = FALSE;
01289 
01290     <font class="keywordflow">if</font> ( par )
01291     withoutDoubleBuffer = par-&gt;withoutDoubleBuffer;
01292     <font class="keywordflow">else</font>
01293     withoutDoubleBuffer = FALSE;
01294 
01295     lParag = fParag = createParag( <font class="keyword">this</font>, 0, 0 );
01296     tmpCursor = 0;
01297 
01298     cx = 0;
01299     cy = 2;
01300     <font class="keywordflow">if</font> ( par )
01301     cx = cy = 0;
01302     cw = 600;
01303     vw = 0;
01304     flow_ = <font class="keyword">new</font> QTextFlow;
01305     flow_-&gt;setWidth( cw );
01306 
01307     selectionColors[ Standard ] = QApplication::palette().color( QPalette::Active, QColorGroup::Highlight );
01308     selectionText[ Standard ] = TRUE;
01309     commandHistory = <font class="keyword">new</font> QTextCommandHistory( 100 );
01310     tStopWidth = formatCollection()-&gt;defaultFormat()-&gt;width( <font class="charliteral">'x'</font> ) * 8;
01311 }
01312 
01313 QTextDocument::~QTextDocument()
01314 {
01315     <font class="keywordflow">if</font> ( par )
01316     par-&gt;removeChild( <font class="keyword">this</font> );
01317     clear();
01318     <font class="keyword">delete</font> commandHistory;
01319     <font class="keyword">delete</font> flow_;
01320     <font class="keywordflow">if</font> ( !par )
01321     <font class="keyword">delete</font> pFormatter;
01322     <font class="keyword">delete</font> fCollection;
01323     <font class="keyword">delete</font> pProcessor;
01324     <font class="keyword">delete</font> buf_pixmap;
01325     <font class="keyword">delete</font> indenter;
01326     <font class="keyword">delete</font> backBrush;
01327     <font class="keywordflow">if</font> ( tArray )
01328     <font class="keyword">delete</font> [] tArray;
01329 <font class="comment">//ANY_CHARSET_BEGIN    </font>
01330     <font class="keywordflow">if</font> (charsetMap) {
01331     <font class="keyword">delete</font> charsetMap;
01332     charsetMap = 0;
01333     <font class="keywordflow">if</font> (m_assignedFontMap)
01334         m_charsetMap = 0;
01335     m_assignedFontMap = <font class="keyword">false</font>;
01336     }
01337 <font class="comment">//ANY_CHARSET_END</font>
01338 }
01339 
01340 <font class="keywordtype">void</font> QTextDocument::clear( <font class="keywordtype">bool</font> createEmptyParag )
01341 {
01342     <font class="keywordflow">if</font> ( flow_ )
01343     flow_-&gt;clear();
01344     <font class="keywordflow">while</font> ( fParag ) {
01345     QTextParag *p = fParag-&gt;next();
01346     <font class="keyword">delete</font> fParag;
01347     fParag = p;
01348     }
01349     fParag = lParag = 0;
01350     <font class="keywordflow">if</font> ( createEmptyParag )
01351     fParag = lParag = createParag( <font class="keyword">this</font> );
01352     selections.clear();
01353 }
01354 
01355 <font class="keywordtype">int</font> QTextDocument::widthUsed()<font class="keyword"> const</font>
01356 <font class="keyword"></font>{
01357     QTextParag *p = fParag;
01358     <font class="keywordtype">int</font> w = 0;
01359     <font class="keywordflow">while</font> ( p ) {
01360     <font class="keywordtype">int</font> a = p-&gt;alignment();
01361     p-&gt;setAlignment( Qt::AlignLeft );
01362     p-&gt;invalidate( 0 );
01363     p-&gt;format();
01364     w = QMAX( w, p-&gt;rect().width() );
01365     p-&gt;setAlignment( a );
01366     p-&gt;invalidate( 0 );
01367     p = p-&gt;next();
01368     }
01369     <font class="keywordflow">return</font> w;
01370 }
01371 
01372 QTextParag *QTextDocument::createParag( QTextDocument *d, QTextParag *pr, QTextParag *nx, <font class="keywordtype">bool</font> updateIds )
01373 {
01374     <font class="keywordflow">return</font> <font class="keyword">new</font> QTextParag( d, pr, nx, updateIds );
01375 }
01376 
01377 <font class="keywordtype">bool</font> QTextDocument::setMinimumWidth( <font class="keywordtype">int</font> w, QTextParag *p )
01378 {
01379     <font class="keywordflow">if</font> ( w == -1 ) {
01380     minw = 0;
01381     p = 0;
01382     }
01383     <font class="keywordflow">if</font> ( p == minwParag ) {
01384     minw = w;
01385     emit minimumWidthChanged( minw );
01386     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( w &gt; minw ) {
01387     minw = w;
01388     minwParag = p;
01389     emit minimumWidthChanged( minw );
01390     }
01391     cw = QMAX( minw, cw );
01392     <font class="keywordflow">return</font> TRUE;
01393 }
01394 
01395 <font class="keywordtype">void</font> QTextDocument::setPlainText( <font class="keyword">const</font> QString &amp;text )
01396 {
01397     clear();
01398     preferRichText = FALSE;
01399 
01400     QString s;
01401     lParag = 0;
01402     QStringList lst = QStringList::split( <font class="charliteral">'\n'</font>, text, TRUE );
01403     <font class="keywordflow">for</font> ( QStringList::Iterator it = lst.begin(); it != lst.end(); ++it ) {
01404     lParag = createParag( <font class="keyword">this</font>, lParag, 0 );
01405     <font class="keywordflow">if</font> ( !fParag )
01406         fParag = lParag;
01407     s = *it;
01408     <font class="keywordflow">if</font> ( !s.isEmpty() ) {
01409         <font class="keywordflow">if</font> ( s[ (int)s.length() - 1 ] == <font class="charliteral">'\r'</font> )
01410         s.remove( s.length() - 1, 1 );
01411         lParag-&gt;append( s );
01412     }
01413     }
01414 
01415     <font class="keywordflow">if</font> ( !lParag )
01416     lParag = fParag = createParag( <font class="keyword">this</font>, 0, 0 );
01417 }
01418 
01419 <font class="keyword">struct </font>Q_EXPORT Tag {
01420     Tag(){}
01421     Tag( <font class="keyword">const</font> QString&amp;n, <font class="keyword">const</font> <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a>* s ):name(n),style(s) {
01422     wsm = QStyleSheetItem::WhiteSpaceNormal;
01423     }
01424     QString name;
01425     <font class="keyword">const</font> <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a>* style;
01426     QStyleSheetItem::WhiteSpaceMode wsm;
01427     QTextFormat format;
01428 
01429 <font class="preprocessor">#if defined(Q_FULL_TEMPLATE_INSTANTIATION)</font>
01430 <font class="preprocessor"></font>    <font class="keywordtype">bool</font> operator==( <font class="keyword">const</font> Tag&amp; )<font class="keyword"> const </font>{ <font class="keywordflow">return</font> FALSE; }
01431 <font class="preprocessor">#endif</font>
01432 <font class="preprocessor"></font>};
01433 
01434 <font class="preprocessor">#define NEWPAR       if ( !curpar || ( curtag.name != "table" &amp;&amp; curtag.name != "li" ) || curpar-&gt;length() &gt; 1 ) { if ( !hasNewPar ) curpar = createParag( this, curpar ); \</font>
01435 <font class="preprocessor">            hasNewPar = TRUE;  \</font>
01436 <font class="preprocessor">            QPtrVector&lt;QStyleSheetItem&gt; vec( tags.count() ); \</font>
01437 <font class="preprocessor">            int i = 0; \</font>
01438 <font class="preprocessor">            for ( QValueStack&lt;Tag&gt;::Iterator it = tags.begin(); it != tags.end(); ++it ) \</font>
01439 <font class="preprocessor">            vec.insert( i++, (*it).style ); \</font>
01440 <font class="preprocessor">            curpar-&gt;setStyleSheetItems( vec ); }while(FALSE)</font>
01441 <font class="preprocessor"></font><font class="preprocessor">#define NEWPAROPEN(nstyle)       if ( !curpar || ( curtag.name != "table" &amp;&amp; curtag.name != "li" ) || curpar-&gt;length() &gt; 1 )  { if ( !hasNewPar ) curpar = createParag( this, curpar ); \</font>
01442 <font class="preprocessor">            hasNewPar = TRUE;  \</font>
01443 <font class="preprocessor">            QPtrVector&lt;QStyleSheetItem&gt; vec( tags.count()+1 ); \</font>
01444 <font class="preprocessor">            int i = 0; \</font>
01445 <font class="preprocessor">            for ( QValueStack&lt;Tag&gt;::Iterator it = tags.begin(); it != tags.end(); ++it ) \</font>
01446 <font class="preprocessor">            vec.insert( i++, (*it).style ); \</font>
01447 <font class="preprocessor">            vec.insert( i, nstyle ); \</font>
01448 <font class="preprocessor">            curpar-&gt;setStyleSheetItems( vec ); }while(FALSE)</font>
01449 <font class="preprocessor"></font>
01450 
01451 <font class="keywordtype">void</font> QTextDocument::setRichText( <font class="keyword">const</font> QString &amp;text, <font class="keyword">const</font> QString &amp;context )
01452 {
01453     setTextFormat( Qt::RichText );
01454     <font class="keywordflow">if</font> ( !context.isEmpty() )
01455     setContext( context );
01456     clear();
01457     fParag = lParag = createParag( <font class="keyword">this</font> );
01458     setRichTextInternal( text );
01459 }
01460 
01461 <font class="keywordtype">void</font> QTextDocument::setRichTextInternal( <font class="keyword">const</font> QString &amp;text )
01462 {
01463     QTextParag* curpar = lParag;
01464     <font class="keywordtype">int</font> pos = 0;
01465     QValueStack&lt;Tag&gt; tags;
01466     Tag curtag( <font class="stringliteral">""</font>, sheet_-&gt;item(<font class="stringliteral">""</font>) );
01467     curtag.format = *formatCollection()-&gt;defaultFormat();
01468     <font class="keywordtype">bool</font> space = FALSE;
01469 
01470     QString doc = text;
01471     <font class="keywordtype">int</font> depth = 0;
01472     <font class="keywordtype">bool</font> hasNewPar = TRUE;
01473     QStyleSheetItem::ListStyle curListStyle;
01474     <font class="keywordflow">while</font> ( pos &lt; int( doc.length() ) ) {
01475     <font class="keywordflow">if</font> (hasPrefix(doc, pos, <font class="charliteral">'&lt;'</font> ) ){
01476         <font class="keywordflow">if</font> (!hasPrefix(doc, pos+1, QChar(<font class="charliteral">'/'</font>))) {
01477         <font class="comment">// open tag</font>
01478         QMap&lt;QString, QString&gt; attr;
01479         <font class="keywordtype">bool</font> emptyTag = FALSE;
01480         QString tagname = parseOpenTag(doc, pos, attr, emptyTag);
01481         <font class="keywordflow">if</font> ( tagname.isEmpty() )
01482             <font class="keywordflow">continue</font>; <font class="comment">// nothing we could do with this, probably parse error</font>
01483         <font class="keywordflow">while</font> ( eat( doc, pos, <font class="charliteral">'\n'</font> ) )
01484             ; <font class="comment">// eliminate newlines right after openings</font>
01485 
01486         <font class="keyword">const</font> <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a>* nstyle = sheet_-&gt;item(tagname);
01487         <font class="keywordflow">if</font> ( nstyle ) {
01488             <font class="comment">// we might have to close some 'forgotten' tags</font>
01489             <font class="keywordflow">while</font> ( !nstyle-&gt;allowedInContext( curtag.style ) ) {
01490             QString msg;
01491             msg.sprintf( <font class="stringliteral">"QText Warning: Document not valid ( '%s' not allowed in '%s' #%d)"</font>,
01492                      tagname.ascii(), curtag.style-&gt;name().ascii(), pos);
01493             sheet_-&gt;error( msg );
01494             <font class="keywordflow">if</font> ( tags.isEmpty() )
01495                 <font class="keywordflow">break</font>;
01496             curtag = tags.pop();
01497             depth--;
01498             }
01499             <font class="keywordflow">if</font> ( nstyle-&gt;name() == <font class="stringliteral">"ol"</font> ) {
01500             curListStyle = nstyle-&gt;listStyle();
01501             QMap&lt;QString, QString&gt;::Iterator it = attr.find( <font class="stringliteral">"type"</font> );
01502             <font class="keywordflow">if</font> ( it != attr.end() ) {
01503                 QString sl = *it;
01504                 <font class="keywordflow">if</font> ( sl == <font class="stringliteral">"1"</font> ) {
01505                 curListStyle = QStyleSheetItem::ListDecimal;
01506                 } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( sl == <font class="stringliteral">"a"</font> ) {
01507                 curListStyle =  QStyleSheetItem::ListLowerAlpha;
01508                 } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( sl == <font class="stringliteral">"A"</font> ) {
01509                 curListStyle = QStyleSheetItem::ListUpperAlpha;
01510                 } <font class="keywordflow">else</font> {
01511                 sl = sl.lower();
01512                 <font class="keywordflow">if</font> ( sl == <font class="stringliteral">"square"</font> )
01513                     curListStyle = QStyleSheetItem::ListSquare;
01514                 <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( sl == <font class="stringliteral">"disc"</font> )
01515                 curListStyle = QStyleSheetItem::ListDisc;
01516                 <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( sl == <font class="stringliteral">"circle"</font> )
01517                     curListStyle = QStyleSheetItem::ListCircle;
01518                 }
01519             }
01520             }
01521         }
01522 
01523         QTextCustomItem* custom =  0;
01524         <font class="comment">// some well-known empty tags</font>
01525         <font class="keywordflow">if</font> ( tagname == <font class="stringliteral">"br"</font> ) {
01526             emptyTag = TRUE;
01527             NEWPAR;
01528         }  <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( tagname == <font class="stringliteral">"hr"</font> ) {
01529             emptyTag = TRUE;
01530             custom = sheet_-&gt;tag( tagname, attr, contxt, *factory_ , emptyTag, <font class="keyword">this</font> );
01531             NEWPAR;
01532         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( tagname == <font class="stringliteral">"table"</font> ) {
01533             QTextFormat format = curtag.format.makeTextFormat(  nstyle, attr );
01534             custom = parseTable( attr, format, doc, pos, curpar );
01535             (void ) eatSpace( doc, pos );
01536             emptyTag = TRUE;
01537         } <font class="keywordflow">else</font> {
01538             custom = sheet_-&gt;tag( tagname, attr, contxt, *factory_ , emptyTag, <font class="keyword">this</font> );
01539         }
01540 
01541         <font class="keywordflow">if</font> ( !nstyle &amp;&amp; !custom ) <font class="comment">// we have no clue what this tag could be, ignore it</font>
01542             <font class="keywordflow">continue</font>;
01543 
01544         <font class="keywordflow">if</font> ( custom ) {
01545             QTextFormat format = curtag.format.makeTextFormat(  nstyle, attr );
01546             <font class="keywordtype">int</font> index = curpar-&gt;length() - 1;
01547             <font class="keywordflow">if</font> ( index &lt; 0 )
01548             index = 0;
01549             curpar-&gt;append( QChar(<font class="charliteral">'b'</font>) );
01550             curpar-&gt;setFormat( index, 1, &amp;format );
01551             curpar-&gt;at( index )-&gt;setCustomItem( custom );
01552             curpar-&gt;addCustomItem();
01553             registerCustomItem( custom, curpar );
01554             hasNewPar = FALSE;
01555         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( !emptyTag ) {
01556             tags += curtag;
01557             <font class="keywordflow">if</font> ( nstyle ) {
01558             <font class="comment">// ignore whitespace for inline elements if there was already one</font>
01559             <font class="keywordflow">if</font> ( nstyle-&gt;whiteSpaceMode() == QStyleSheetItem::WhiteSpaceNormal
01560                  &amp;&amp; ( space || nstyle-&gt;displayMode() != QStyleSheetItem::DisplayInline ) )
01561                 eatSpace( doc, pos );
01562 
01563             <font class="comment">// some styles are not self nesting</font>
01564             <font class="keywordflow">if</font> ( nstyle == curtag.style &amp;&amp; !nstyle-&gt;selfNesting() )
01565                 (void) tags.pop();
01566 
01567             <font class="keywordflow">if</font> ( curtag.style-&gt;displayMode() == QStyleSheetItem::DisplayListItem )
01568                 hasNewPar = FALSE; <font class="comment">// we want empty paragraphs in this case</font>
01569             <font class="keywordflow">if</font> ( nstyle-&gt;displayMode() != QStyleSheetItem::DisplayInline )
01570                 NEWPAROPEN(nstyle);
01571             <font class="keywordflow">if</font> ( nstyle-&gt;displayMode() == QStyleSheetItem::DisplayListItem )
01572                 curpar-&gt;setListStyle( curListStyle );
01573             curtag.style = nstyle;
01574             curtag.wsm = nstyle-&gt;whiteSpaceMode();
01575             curtag.format = curtag.format.makeTextFormat( nstyle, attr );
01576             <font class="keywordflow">if</font> ( nstyle-&gt;displayMode() != QStyleSheetItem::DisplayInline )
01577                 curpar-&gt;setFormat( &amp;curtag.format );
01578             <font class="keywordflow">if</font> ( nstyle-&gt;name() == <font class="stringliteral">"li"</font> ) {
01579                 <font class="keywordflow">if</font> ( attr.find( <font class="stringliteral">"value"</font> ) != attr.end() )
01580                 curpar-&gt;setListValue( (*attr.find( <font class="stringliteral">"value"</font> )).toInt() );
01581             }
01582             }
01583             curtag.name = tagname;
01584             <font class="keywordflow">if</font> ( curtag.name == <font class="stringliteral">"a"</font> &amp;&amp; attr.find( <font class="stringliteral">"name"</font> ) != attr.end() &amp;&amp; doc[ pos] == <font class="charliteral">'&lt;'</font> )  <font class="comment">// hack to be sure</font>
01585             doc.insert( pos, <font class="stringliteral">" "</font> );                     <font class="comment">// &lt;a name=".."&gt;&lt;/a&gt; formats or inserted</font>
01586             <font class="keywordflow">if</font> ( attr.find( <font class="stringliteral">"align"</font> ) != attr.end() &amp;&amp;
01587              ( curtag.name == <font class="stringliteral">"p"</font> || curtag.name == <font class="stringliteral">"li"</font> || curtag.name[ 0 ] == <font class="charliteral">'h'</font> ) ) {
01588             <font class="keywordflow">if</font> ( *attr.find( <font class="stringliteral">"align"</font> ) == <font class="stringliteral">"center"</font> )
01589                 curpar-&gt;setAlignment( Qt::AlignCenter );
01590             <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( *attr.find( <font class="stringliteral">"align"</font> ) == <font class="stringliteral">"right"</font> )
01591                 curpar-&gt;setAlignment( Qt::AlignRight );
01592             <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( *attr.find( <font class="stringliteral">"align"</font> ) == <font class="stringliteral">"justify"</font> )
01593                 curpar-&gt;setAlignment( Qt3::AlignJustify );
01594             }
01595             depth++;
01596         }
01597         } <font class="keywordflow">else</font> {
01598         <font class="comment">// close tag</font>
01599         QString tagname = parseCloseTag( doc, pos );
01600         <font class="keywordflow">if</font> ( tagname.isEmpty() )
01601             <font class="keywordflow">continue</font>; <font class="comment">// nothing we could do with this, probably parse error</font>
01602         <font class="keywordflow">while</font> ( eat( doc, pos, <font class="charliteral">'\n'</font> ) )
01603             ; <font class="comment">// eliminate newlines right after closings</font>
01604         <font class="keywordflow">if</font> ( !sheet_-&gt;item( tagname ) ) <font class="comment">// ignore unknown tags</font>
01605             <font class="keywordflow">continue</font>;
01606         depth--;
01607         <font class="keywordflow">while</font> ( curtag.name != tagname ) {
01608             QString msg;
01609             msg.sprintf( <font class="stringliteral">"QText Warning: Document not valid ( '%s' not closed before '%s' #%d)"</font>,
01610                  curtag.name.ascii(), tagname.ascii(), pos);
01611             sheet_-&gt;error( msg );
01612             <font class="keywordflow">if</font> ( !hasNewPar &amp;&amp; curtag.style-&gt;displayMode() != QStyleSheetItem::DisplayInline
01613              &amp;&amp; curtag.wsm == QStyleSheetItem::WhiteSpaceNormal ) {
01614             eatSpace( doc, pos );
01615             NEWPAR;
01616             }
01617             <font class="keywordflow">if</font> ( tags.isEmpty() )
01618             <font class="keywordflow">break</font>;
01619             curtag = tags.pop();
01620             depth--;
01621         }
01622 
01623         <font class="keywordflow">if</font> ( !hasNewPar &amp;&amp; curtag.style-&gt;displayMode() != QStyleSheetItem::DisplayInline
01624              &amp;&amp; curtag.wsm == QStyleSheetItem::WhiteSpaceNormal ) {
01625             eatSpace( doc, pos );
01626             NEWPAR;
01627         }
01628         <font class="keywordflow">if</font> ( !tags.isEmpty() )
01629             curtag = tags.pop();
01630         }
01631     } <font class="keywordflow">else</font> {
01632         <font class="comment">// normal contents</font>
01633         QString s;
01634         QChar c;
01635         <font class="keywordtype">bool</font> hadNonSpace = !curpar-&gt;string()-&gt;toString().simplifyWhiteSpace().isEmpty();
01636         <font class="keywordflow">while</font> ( pos &lt; int( doc.length() ) &amp;&amp; !hasPrefix(doc, pos, <font class="charliteral">'&lt;'</font> ) ){
01637         c = parseChar( doc, pos, curtag.wsm );
01638         space = c.isSpace();
01639         hadNonSpace = hadNonSpace || !space;
01640         <font class="keywordflow">if</font> ( c == <font class="charliteral">'\n'</font> ) <font class="comment">// happens in WhiteSpacePre mode</font>
01641             <font class="keywordflow">break</font>;
01642         <font class="keywordflow">if</font> ( !hadNonSpace &amp;&amp; space &amp;&amp; curtag.wsm == QStyleSheetItem::WhiteSpaceNormal )
01643             <font class="keywordflow">continue</font>;
01644         <font class="keywordflow">if</font> ( c == <font class="charliteral">'\r'</font> )
01645             <font class="keywordflow">continue</font>;
01646         s += c;
01647         }
01648         <font class="keywordflow">if</font> ( !s.isEmpty() &amp;&amp; curtag.style-&gt;displayMode() != QStyleSheetItem::DisplayNone ) {
01649         hasNewPar = FALSE;
01650         <font class="keywordtype">int</font> index = curpar-&gt;length() - 1;
01651         <font class="keywordflow">if</font> ( index &lt; 0 )
01652             index = 0;
01653         curpar-&gt;append( s );
01654         curpar-&gt;setFormat( index, s.length(), &amp;curtag.format );
01655         }
01656         <font class="keywordflow">if</font> ( c == <font class="charliteral">'\n'</font> )
01657         NEWPAR;
01658 
01659     }
01660     }
01661 }
01662 
01663 <font class="keywordtype">void</font> QTextDocument::setText( <font class="keyword">const</font> QString &amp;text, <font class="keyword">const</font> QString &amp;context )
01664 {
01665     oText = text;
01666     focusIndicator.parag = 0;
01667     selections.clear();
01668     <font class="keywordflow">if</font> ( txtFormat == Qt::AutoText &amp;&amp; QStyleSheet::mightBeRichText( text ) ||
01669      txtFormat == Qt::RichText )
01670     setRichText( text, context );
01671     <font class="keywordflow">else</font>
01672     setPlainText( text );
01673 }
01674 
01675 QString QTextDocument::plainText( QTextParag *p )<font class="keyword"> const</font>
01676 <font class="keyword"></font>{
01677     <font class="keywordflow">if</font> ( !p ) {
01678     QString buffer;
01679     QString s;
01680     QTextParag *p = fParag;
01681     <font class="keywordflow">while</font> ( p ) {
01682         s = p-&gt;string()-&gt;toString();
01683         s.remove( s.length() - 1, 1 );
01684         <font class="keywordflow">if</font> ( p-&gt;next() )
01685         s += <font class="stringliteral">"\n"</font>;
01686         buffer += s;
01687         p = p-&gt;next();
01688     }
01689     <font class="keywordflow">return</font> buffer;
01690     } <font class="keywordflow">else</font> {
01691     <font class="keywordflow">return</font> p-&gt;string()-&gt;toString();
01692     }
01693 }
01694 
01695 <font class="keyword">static</font> QString align_to_string( <font class="keyword">const</font> QString &amp;tag, <font class="keywordtype">int</font> a )
01696 {
01697     <font class="keywordflow">if</font> ( tag == <font class="stringliteral">"p"</font> || tag == <font class="stringliteral">"li"</font> || tag[ 0 ] == <font class="charliteral">'h'</font> ) {
01698     <font class="keywordflow">if</font> ( a &amp; Qt::AlignRight )
01699         <font class="keywordflow">return</font> <font class="stringliteral">" align=right "</font>;
01700     <font class="keywordflow">if</font> ( a &amp; Qt::AlignCenter )
01701         <font class="keywordflow">return</font> <font class="stringliteral">" align=center "</font>;
01702     <font class="keywordflow">if</font> ( a &amp; Qt3::AlignJustify )
01703         <font class="keywordflow">return</font> <font class="stringliteral">" align=justify "</font>;
01704     }
01705     <font class="keywordflow">return</font> <font class="stringliteral">""</font>;
01706 }
01707 
01708 QString QTextDocument::richText( QTextParag *p )<font class="keyword"> const</font>
01709 <font class="keyword"></font>{
01710     QString s;
01711     <font class="keywordflow">if</font> ( !p ) {
01712     p = fParag;
01713     QPtrVector&lt;QStyleSheetItem&gt; lastItems, items;
01714     <font class="keywordflow">while</font> ( p ) {
01715         items = p-&gt;styleSheetItems();
01716         <font class="keywordflow">if</font> ( items.size() ) {
01717         <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *item = items[ items.size() - 1 ];
01718         items.resize( items.size() - 1 );
01719         <font class="keywordflow">if</font> ( items.size() &gt; lastItems.size() ) {
01720             <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = lastItems.size(); i &lt; (int)items.size(); ++i ) {
01721             <font class="keywordflow">if</font> ( items[ i ]-&gt;name().isEmpty() )
01722                 <font class="keywordflow">continue</font>;
01723             <font class="keywordflow">if</font> ( items[ i ]-&gt;name() == <font class="stringliteral">"li"</font> &amp;&amp; p-&gt;listValue() != -1 )
01724                 s += <font class="stringliteral">"&lt;li value=\""</font> + QString::number( p-&gt;listValue() ) + <font class="stringliteral">"\"&gt;"</font>;
01725             <font class="keywordflow">else</font>
01726                 s += <font class="stringliteral">"&lt;"</font> + items[ i ]-&gt;name() + align_to_string( items[ i ]-&gt;name(), p-&gt;alignment() ) + <font class="stringliteral">"&gt;"</font>;
01727             }
01728         } <font class="keywordflow">else</font> {
01729             QString end;
01730             <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = items.size(); i &lt; (int)lastItems.size(); ++i ) {
01731             <font class="keywordflow">if</font> ( lastItems[ i ]-&gt;name().isEmpty() )
01732                 <font class="keywordflow">continue</font>;
01733             end.prepend( <font class="stringliteral">"&lt;/"</font> + lastItems[ i ]-&gt;name() + <font class="stringliteral">"&gt;"</font> );
01734             }
01735             s += end;
01736         }
01737         lastItems = items;
01738         <font class="keywordflow">if</font> ( item-&gt;name() == <font class="stringliteral">"li"</font> &amp;&amp; p-&gt;listValue() != -1 )
01739             s += <font class="stringliteral">"&lt;li value=\""</font> + QString::number( p-&gt;listValue() ) + <font class="stringliteral">"\"&gt;"</font>;
01740         <font class="keywordflow">else</font>
01741             s += <font class="stringliteral">"&lt;"</font> + item-&gt;name() + align_to_string( item-&gt;name(), p-&gt;alignment() ) + <font class="stringliteral">"&gt;"</font> +
01742              p-&gt;richText() + <font class="stringliteral">"&lt;/"</font> + item-&gt;name() + <font class="stringliteral">"&gt;\n"</font>;
01743         } <font class="keywordflow">else</font> {
01744         QString end;
01745         <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)lastItems.size(); ++i ) {
01746             <font class="keywordflow">if</font> ( lastItems[ i ]-&gt;name().isEmpty() )
01747             <font class="keywordflow">continue</font>;
01748             end.prepend( <font class="stringliteral">"&lt;/"</font> + lastItems[ i ]-&gt;name() + <font class="stringliteral">"&gt;"</font> );
01749         }
01750         s += end;
01751         s += <font class="stringliteral">"&lt;p"</font> + align_to_string( <font class="stringliteral">"p"</font>, p-&gt;alignment() ) + <font class="stringliteral">"&gt;"</font> + p-&gt;richText() + <font class="stringliteral">"&lt;/p&gt;\n"</font>;
01752         lastItems = items;
01753         }
01754         p = p-&gt;next();
01755     }
01756     } <font class="keywordflow">else</font> {
01757     s = p-&gt;richText();
01758     }
01759 
01760     <font class="keywordflow">return</font> s;
01761 }
01762 
01763 QString QTextDocument::text()<font class="keyword"> const</font>
01764 <font class="keyword"></font>{
01765     <font class="keywordflow">if</font> ( plainText().simplifyWhiteSpace().isEmpty() )
01766     <font class="keywordflow">return</font> QString::null;
01767     <font class="keywordflow">if</font> ( txtFormat == Qt::AutoText &amp;&amp; preferRichText || txtFormat == Qt::RichText )
01768     <font class="keywordflow">return</font> richText();
01769     <font class="keywordflow">return</font> plainText( 0 );
01770 }
01771 
01772 QString QTextDocument::text( <font class="keywordtype">int</font> parag )<font class="keyword"> const</font>
01773 <font class="keyword"></font>{
01774     QTextParag *p = paragAt( parag );
01775     <font class="keywordflow">if</font> ( !p )
01776     <font class="keywordflow">return</font> QString::null;
01777 
01778     <font class="keywordflow">if</font> ( txtFormat == Qt::AutoText &amp;&amp; preferRichText || txtFormat == Qt::RichText )
01779     <font class="keywordflow">return</font> richText( p );
01780     <font class="keywordflow">else</font>
01781     <font class="keywordflow">return</font> plainText( p );
01782 }
01783 
01784 <font class="keywordtype">void</font> QTextDocument::invalidate()
01785 {
01786     QTextParag *s = fParag;
01787     <font class="keywordflow">while</font> ( s ) {
01788     s-&gt;invalidate( 0 );
01789     s = s-&gt;next();
01790     }
01791 }
01792 
01793 <font class="keywordtype">void</font> QTextDocument::selectionStart( <font class="keywordtype">int</font> id, <font class="keywordtype">int</font> &amp;paragId, <font class="keywordtype">int</font> &amp;index )
01794 {
01795     QMap&lt;int, QTextDocumentSelection&gt;::Iterator it = selections.find( id );
01796     <font class="keywordflow">if</font> ( it == selections.end() )
01797     <font class="keywordflow">return</font>;
01798     QTextDocumentSelection &amp;sel = *it;
01799     paragId = !sel.swapped ? sel.startCursor.parag()-&gt;paragId() : sel.endCursor.parag()-&gt;paragId();
01800     index = !sel.swapped ? sel.startCursor.index() : sel.endCursor.index();
01801 }
01802 
01803 QTextCursor QTextDocument::selectionStartCursor( <font class="keywordtype">int</font> id)
01804 {
01805     QMap&lt;int, QTextDocumentSelection&gt;::Iterator it = selections.find( id );
01806     <font class="keywordflow">if</font> ( it == selections.end() )
01807     <font class="keywordflow">return</font> QTextCursor( <font class="keyword">this</font> );
01808     QTextDocumentSelection &amp;sel = *it;
01809     <font class="keywordflow">if</font> ( sel.swapped )
01810     <font class="keywordflow">return</font> sel.endCursor;
01811     <font class="keywordflow">return</font> sel.startCursor;
01812 }
01813 
01814 QTextCursor QTextDocument::selectionEndCursor( <font class="keywordtype">int</font> id)
01815 {
01816     QMap&lt;int, QTextDocumentSelection&gt;::Iterator it = selections.find( id );
01817     <font class="keywordflow">if</font> ( it == selections.end() )
01818     <font class="keywordflow">return</font> QTextCursor( <font class="keyword">this</font> );
01819     QTextDocumentSelection &amp;sel = *it;
01820     <font class="keywordflow">if</font> ( !sel.swapped )
01821     <font class="keywordflow">return</font> sel.endCursor;
01822     <font class="keywordflow">return</font> sel.startCursor;
01823 }
01824 
01825 <font class="keywordtype">void</font> QTextDocument::selectionEnd( <font class="keywordtype">int</font> id, <font class="keywordtype">int</font> &amp;paragId, <font class="keywordtype">int</font> &amp;index )
01826 {
01827     QMap&lt;int, QTextDocumentSelection&gt;::Iterator it = selections.find( id );
01828     <font class="keywordflow">if</font> ( it == selections.end() )
01829     <font class="keywordflow">return</font>;
01830     QTextDocumentSelection &amp;sel = *it;
01831     paragId = sel.swapped ? sel.startCursor.parag()-&gt;paragId() : sel.endCursor.parag()-&gt;paragId();
01832     index = sel.swapped ? sel.startCursor.index() : sel.endCursor.index();
01833 }
01834 
01835 QTextParag *QTextDocument::selectionStart( <font class="keywordtype">int</font> id )
01836 {
01837     QMap&lt;int, QTextDocumentSelection&gt;::Iterator it = selections.find( id );
01838     <font class="keywordflow">if</font> ( it == selections.end() )
01839     <font class="keywordflow">return</font> 0;
01840     QTextDocumentSelection &amp;sel = *it;
01841     <font class="keywordflow">if</font> ( sel.startCursor.parag()-&gt;paragId() &lt;  sel.endCursor.parag()-&gt;paragId() )
01842     <font class="keywordflow">return</font> sel.startCursor.parag();
01843     <font class="keywordflow">return</font> sel.endCursor.parag();
01844 }
01845 
01846 QTextParag *QTextDocument::selectionEnd( <font class="keywordtype">int</font> id )
01847 {
01848     QMap&lt;int, QTextDocumentSelection&gt;::Iterator it = selections.find( id );
01849     <font class="keywordflow">if</font> ( it == selections.end() )
01850     <font class="keywordflow">return</font> 0;
01851     QTextDocumentSelection &amp;sel = *it;
01852     <font class="keywordflow">if</font> ( sel.startCursor.parag()-&gt;paragId() &gt;  sel.endCursor.parag()-&gt;paragId() )
01853     <font class="keywordflow">return</font> sel.startCursor.parag();
01854     <font class="keywordflow">return</font> sel.endCursor.parag();
01855 }
01856 
01857 <font class="keywordtype">void</font> QTextDocument::addSelection( <font class="keywordtype">int</font> id )
01858 {
01859     nSelections = QMAX( nSelections, id + 1 );
01860 }
01861 
01862 <font class="keywordtype">bool</font> QTextDocument::setSelectionEnd( <font class="keywordtype">int</font> id, QTextCursor *cursor )
01863 {
01864     QMap&lt;int, QTextDocumentSelection&gt;::Iterator it = selections.find( id );
01865     <font class="keywordflow">if</font> ( it == selections.end() )
01866     <font class="keywordflow">return</font> FALSE;
01867 
01868     QTextDocumentSelection &amp;sel = *it;
01869 
01870     QTextCursor start = sel.startCursor;
01871     QTextCursor end = *cursor;
01872 
01873     <font class="keywordflow">if</font> ( sel.endCursor.parag() == end.parag() ) {
01874     QTextCursor c1 = start;
01875     QTextCursor c2 = end;
01876     <font class="keywordflow">if</font> ( sel.swapped ) {
01877         c1 = end;
01878         c2 = start;
01879     }
01880 
01881     c1.parag()-&gt;removeSelection( id );
01882     c2.parag()-&gt;removeSelection( id );
01883     <font class="keywordflow">if</font> ( c1.parag() != c2.parag() ) {
01884         c1.parag()-&gt;setSelection( id, c1.index(), c1.parag()-&gt;length() - 1 );
01885         c2.parag()-&gt;setSelection( id, 0, c2.index() );
01886     } <font class="keywordflow">else</font> {
01887         c1.parag()-&gt;setSelection( id, QMIN( c1.index(), c2.index() ), QMAX( c1.index(), c2.index() ) );
01888     }
01889 
01890     sel.startCursor = start;
01891     sel.endCursor = end;
01892     <font class="keywordflow">if</font> ( sel.startCursor.parag() == sel.endCursor.parag() )
01893         sel.swapped = sel.startCursor.index() &gt; sel.endCursor.index();
01894 
01895     <font class="keywordflow">return</font> TRUE;
01896     }
01897 
01898     <font class="keywordtype">bool</font> inSelection = FALSE;
01899     QTextCursor c( <font class="keyword">this</font> );
01900     QTextCursor tmp = sel.startCursor;
01901     <font class="keywordflow">if</font> ( sel.swapped )
01902     tmp = sel.endCursor;
01903     tmp.restoreState();
01904     QTextCursor tmp2 = *cursor;
01905     tmp2.restoreState();
01906     c.setParag( tmp.parag()-&gt;paragId() &lt; tmp2.parag()-&gt;paragId() ? tmp.parag() : tmp2.parag() );
01907     QTextCursor old;
01908     <font class="keywordtype">bool</font> hadStart = FALSE;
01909     <font class="keywordtype">bool</font> hadEnd = FALSE;
01910     <font class="keywordtype">bool</font> hadStartParag = FALSE;
01911     <font class="keywordtype">bool</font> hadEndParag = FALSE;
01912     <font class="keywordtype">bool</font> hadOldStart = FALSE;
01913     <font class="keywordtype">bool</font> hadOldEnd = FALSE;
01914     <font class="keywordtype">bool</font> leftSelection = FALSE;
01915     sel.swapped = FALSE;
01916     <font class="keywordflow">while</font> ( TRUE ) {
01917     <font class="keywordflow">if</font> ( c == start )
01918         hadStart = TRUE;
01919     <font class="keywordflow">if</font> ( c == end )
01920         hadEnd = TRUE;
01921     <font class="keywordflow">if</font> ( c.parag() == start.parag() )
01922         hadStartParag = TRUE;
01923     <font class="keywordflow">if</font> ( c.parag() == end.parag() )
01924         hadEndParag = TRUE;
01925     <font class="keywordflow">if</font> ( c == sel.startCursor )
01926         hadOldStart = TRUE;
01927     <font class="keywordflow">if</font> ( c == sel.endCursor )
01928         hadOldEnd = TRUE;
01929 
01930     <font class="keywordflow">if</font> ( !sel.swapped &amp;&amp;
01931          ( hadEnd &amp;&amp; !hadStart ||
01932            hadEnd &amp;&amp; hadStart &amp;&amp; start.parag() == end.parag() &amp;&amp; start.index() &gt; end.index() ) )
01933         sel.swapped = TRUE;
01934 
01935     <font class="keywordflow">if</font> ( c == end &amp;&amp; hadStartParag ||
01936          c == start &amp;&amp; hadEndParag ) {
01937         QTextCursor tmp = c;
01938         tmp.restoreState();
01939         <font class="keywordflow">if</font> ( tmp.parag() != c.parag() ) {
01940         <font class="keywordtype">int</font> sstart = tmp.parag()-&gt;selectionStart( id );
01941         tmp.parag()-&gt;removeSelection( id );
01942         tmp.parag()-&gt;setSelection( id, sstart, tmp.index() );
01943         }
01944     }
01945 
01946     <font class="keywordflow">if</font> ( inSelection &amp;&amp;
01947          ( c == end &amp;&amp; hadStart || c == start &amp;&amp; hadEnd ) )
01948          leftSelection = TRUE;
01949     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( !leftSelection &amp;&amp; !inSelection &amp;&amp; ( hadStart || hadEnd ) )
01950         inSelection = TRUE;
01951 
01952     <font class="keywordtype">bool</font> noSelectionAnymore = hadOldStart &amp;&amp; hadOldEnd &amp;&amp; leftSelection &amp;&amp; !inSelection &amp;&amp; !c.parag()-&gt;hasSelection( id ) &amp;&amp; c.atParagEnd();
01953     <font class="keywordflow">if</font> ( !c.parag()-&gt;hasChanged() ) {
01954         c.parag()-&gt;removeSelection( id );
01955         <font class="keywordflow">if</font> ( inSelection ) {
01956         <font class="keywordflow">if</font> ( c.parag() == start.parag() &amp;&amp; start.parag() == end.parag() ) {
01957             c.parag()-&gt;setSelection( id, QMIN( start.index(), end.index() ), QMAX( start.index(), end.index() ) );
01958         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( c.parag() == start.parag() &amp;&amp; !hadEndParag ) {
01959             c.parag()-&gt;setSelection( id, start.index(), c.parag()-&gt;length() - 1 );
01960         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( c.parag() == end.parag() &amp;&amp; !hadStartParag ) {
01961             c.parag()-&gt;setSelection( id, end.index(), c.parag()-&gt;length() - 1 );
01962         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( c.parag() == end.parag() &amp;&amp; hadEndParag ) {
01963             c.parag()-&gt;setSelection( id, 0, end.index() );
01964         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( c.parag() == start.parag() &amp;&amp; hadStartParag ) {
01965             c.parag()-&gt;setSelection( id, 0, start.index() );
01966         } <font class="keywordflow">else</font> {
01967             c.parag()-&gt;setSelection( id, 0, c.parag()-&gt;length() - 1 );
01968         }
01969         }
01970     }
01971 
01972     <font class="keywordflow">if</font> ( leftSelection )
01973         inSelection = FALSE;
01974 
01975     old = c;
01976     c.gotoRight();
01977     <font class="keywordflow">if</font> ( old == c || noSelectionAnymore )
01978         <font class="keywordflow">break</font>;
01979     }
01980 
01981     <font class="keywordflow">if</font> ( !sel.swapped )
01982     sel.startCursor.parag()-&gt;setSelection( id, sel.startCursor.index(), sel.startCursor.parag()-&gt;length() - 1 );
01983 
01984     sel.startCursor = start;
01985     sel.endCursor = end;
01986     <font class="keywordflow">if</font> ( sel.startCursor.parag() == sel.endCursor.parag() )
01987     sel.swapped = sel.startCursor.index() &gt; sel.endCursor.index();
01988 
01989     <font class="keywordflow">return</font> TRUE;
01990 }
01991 
01992 <font class="keywordtype">void</font> QTextDocument::selectAll( <font class="keywordtype">int</font> id )
01993 {
01994     removeSelection( id );
01995 
01996     QTextDocumentSelection sel;
01997     sel.swapped = FALSE;
01998     QTextCursor c( <font class="keyword">this</font> );
01999 
02000     c.setParag( fParag );
02001     c.setIndex( 0 );
02002     sel.startCursor = c;
02003 
02004     c.setParag( lParag );
02005     c.setIndex( lParag-&gt;length() - 1 );
02006     sel.endCursor = c;
02007 
02008     QTextParag *p = fParag;
02009     <font class="keywordflow">while</font> ( p ) {
02010     p-&gt;setSelection( id, 0, p-&gt;length() - 1 );
02011     p = p-&gt;next();
02012     }
02013 
02014     selections.insert( id, sel );
02015 }
02016 
02017 <font class="keywordtype">bool</font> QTextDocument::removeSelection( <font class="keywordtype">int</font> id )
02018 {
02019     QMap&lt;int, QTextDocumentSelection&gt;::Iterator it = selections.find( id );
02020     <font class="keywordflow">if</font> ( it == selections.end() )
02021     <font class="keywordflow">return</font> FALSE;
02022 
02023     QTextDocumentSelection &amp;sel = *it;
02024 
02025     QTextCursor c( <font class="keyword">this</font> );
02026     QTextCursor tmp = sel.startCursor;
02027     <font class="keywordflow">if</font> ( sel.swapped )
02028     tmp = sel.endCursor;
02029     tmp.restoreState();
02030     c.setParag( tmp.parag() );
02031     QTextCursor old;
02032     <font class="keywordtype">bool</font> hadStart = FALSE;
02033     <font class="keywordtype">bool</font> hadEnd = FALSE;
02034     QTextParag *lastParag = 0;
02035     <font class="keywordtype">bool</font> leftSelection = FALSE;
02036     <font class="keywordtype">bool</font> inSelection = FALSE;
02037     sel.swapped = FALSE;
02038     <font class="keywordflow">while</font> ( TRUE ) {
02039     <font class="keywordflow">if</font> ( c.parag() == sel.startCursor.parag() )
02040         hadStart = TRUE;
02041     <font class="keywordflow">if</font> ( c.parag() == sel.endCursor.parag() )
02042         hadEnd = TRUE;
02043 
02044     <font class="keywordflow">if</font> ( inSelection &amp;&amp;
02045          ( c == sel.endCursor &amp;&amp; hadStart || c == sel.startCursor &amp;&amp; hadEnd ) )
02046          leftSelection = TRUE;
02047     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( !leftSelection &amp;&amp; !inSelection &amp;&amp; ( c.parag() == sel.startCursor.parag() || c.parag() == sel.endCursor.parag() ) )
02048         inSelection = TRUE;
02049 
02050     <font class="keywordtype">bool</font> noSelectionAnymore = leftSelection &amp;&amp; !inSelection &amp;&amp; !c.parag()-&gt;hasSelection( id ) &amp;&amp; c.atParagEnd();
02051 
02052     <font class="keywordflow">if</font> ( lastParag != c.parag() )
02053         c.parag()-&gt;removeSelection( id );
02054 
02055     old = c;
02056     lastParag = c.parag();
02057     c.gotoRight();
02058     <font class="keywordflow">if</font> ( old == c || noSelectionAnymore )
02059         <font class="keywordflow">break</font>;
02060     }
02061 
02062     selections.remove( id );
02063     <font class="keywordflow">return</font> TRUE;
02064 }
02065 
02066 QString QTextDocument::selectedText( <font class="keywordtype">int</font> id )<font class="keyword"> const</font>
02067 <font class="keyword"></font>{
02068     <font class="comment">// ######## TODO: look at textFormat() and return rich text or plain text (like the text() method!)</font>
02069     QMap&lt;int, QTextDocumentSelection&gt;::ConstIterator it = selections.find( id );
02070     <font class="keywordflow">if</font> ( it == selections.end() )
02071     <font class="keywordflow">return</font> QString::null;
02072 
02073     QTextDocumentSelection sel = *it;
02074 
02075     QTextCursor c1 = sel.startCursor;
02076     QTextCursor c2 = sel.endCursor;
02077     <font class="keywordflow">if</font> ( sel.swapped ) {
02078     c2 = sel.startCursor;
02079     c1 = sel.endCursor;
02080     }
02081 
02082     c2.restoreState();
02083     c1.restoreState();
02084 
02085     <font class="keywordflow">if</font> ( c1.parag() == c2.parag() )
02086     <font class="keywordflow">return</font> c1.parag()-&gt;string()-&gt;toString().mid( c1.index(), c2.index() - c1.index() );
02087 
02088     QString s;
02089     s += c1.parag()-&gt;string()-&gt;toString().mid( c1.index() ) + <font class="stringliteral">"\n"</font>;
02090     QTextParag *p = c1.parag()-&gt;next();
02091     <font class="keywordflow">while</font> ( p &amp;&amp; p != c2.parag() ) {
02092     s += p-&gt;string()-&gt;toString() + <font class="stringliteral">"\n"</font>;
02093     p = p-&gt;next();
02094     }
02095     s += c2.parag()-&gt;string()-&gt;toString().left( c2.index() );
02096     <font class="keywordflow">return</font> s;
02097 }
02098 
02099 <font class="keywordtype">void</font> QTextDocument::setFormat( <font class="keywordtype">int</font> id, QTextFormat *f, <font class="keywordtype">int</font> flags )
02100 {
02101     QMap&lt;int, QTextDocumentSelection&gt;::ConstIterator it = selections.find( id );
02102     <font class="keywordflow">if</font> ( it == selections.end() )
02103     <font class="keywordflow">return</font>;
02104 
02105     QTextDocumentSelection sel = *it;
02106 
02107     QTextCursor c1 = sel.startCursor;
02108     QTextCursor c2 = sel.endCursor;
02109     <font class="keywordflow">if</font> ( sel.swapped ) {
02110     c2 = sel.startCursor;
02111     c1 = sel.endCursor;
02112     }
02113 
02114     c2.restoreState();
02115     c1.restoreState();
02116 
02117     <font class="keywordflow">if</font> ( c1.parag() == c2.parag() ) {
02118     c1.parag()-&gt;setFormat( c1.index(), c2.index() - c1.index(), f, TRUE, flags );
02119     <font class="keywordflow">return</font>;
02120     }
02121 
02122     c1.parag()-&gt;setFormat( c1.index(), c1.parag()-&gt;length() - c1.index(), f, TRUE, flags );
02123     QTextParag *p = c1.parag()-&gt;next();
02124     <font class="keywordflow">while</font> ( p &amp;&amp; p != c2.parag() ) {
02125     p-&gt;setFormat( 0, p-&gt;length() <font class="comment">/*- 1 removed, bug #26064*/</font>, f, TRUE, flags );
02126     p = p-&gt;next();
02127     }
02128     c2.parag()-&gt;setFormat( 0, c2.index(), f, TRUE, flags );
02129 }
02130 
02131 <font class="keywordtype">void</font> QTextDocument::copySelectedText( <font class="keywordtype">int</font> id )
02132 {
02133 <font class="preprocessor">#ifndef QT_NO_CLIPBOARD</font>
02134 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( !hasSelection( id ) )
02135     <font class="keywordflow">return</font>;
02136 
02137     QApplication::clipboard()-&gt;setText( selectedText( id ) );
02138 <font class="preprocessor">#endif</font>
02139 <font class="preprocessor"></font>}
02140 
02141 <font class="keywordtype">void</font> QTextDocument::removeSelectedText( <font class="keywordtype">int</font> id, QTextCursor *cursor )
02142 {
02143     QMap&lt;int, QTextDocumentSelection&gt;::Iterator it = selections.find( id );
02144     <font class="keywordflow">if</font> ( it == selections.end() )
02145     <font class="keywordflow">return</font>;
02146 
02147     QTextDocumentSelection sel = *it;
02148 
02149     QTextCursor c1 = sel.startCursor;
02150     QTextCursor c2 = sel.endCursor;
02151     <font class="keywordflow">if</font> ( sel.swapped ) {
02152     c2 = sel.startCursor;
02153     c1 = sel.endCursor;
02154     }
02155 
02156     <font class="comment">// ### no support for editing tables yet</font>
02157     <font class="keywordflow">if</font> ( c1.nestedDepth() || c2.nestedDepth() )
02158     <font class="keywordflow">return</font>;
02159 
02160     c2.restoreState();
02161     c1.restoreState();
02162 
02163     *cursor = c1;
02164     removeSelection( id );
02165 
02166     <font class="keywordflow">if</font> ( c1.parag() == c2.parag() ) {
02167     c1.parag()-&gt;remove( c1.index(), c2.index() - c1.index() );
02168     <font class="keywordflow">return</font>;
02169     }
02170 
02171     <font class="keywordflow">if</font> (  c1.index() == 0 )
02172     cursor-&gt;gotoLeft();
02173 
02174     c1.parag()-&gt;remove( c1.index(), c1.parag()-&gt;length() - c1.index() );
02175     QTextParag *p = c1.parag()-&gt;next();
02176     <font class="keywordtype">int</font> dy = 0;
02177     QTextParag *tmp;
02178     <font class="keywordflow">while</font> ( p &amp;&amp; p != c2.parag() ) {
02179     tmp = p-&gt;next();
02180     dy -= p-&gt;rect().height();
02181     <font class="keyword">delete</font> p;
02182     p = tmp;
02183     }
02184     c2.parag()-&gt;remove( 0, c2.index() );
02185     <font class="keywordflow">while</font> ( p ) {
02186     p-&gt;move( dy );
02187     p-&gt;invalidate( 0 );
02188     p-&gt;setEndState( -1 );
02189     p = p-&gt;next();
02190     }
02191 
02192     c1.parag()-&gt;join( c2.parag() );
02193 }
02194 
02195 <font class="keywordtype">void</font> QTextDocument::indentSelection( <font class="keywordtype">int</font> id )
02196 {
02197     QMap&lt;int, QTextDocumentSelection&gt;::Iterator it = selections.find( id );
02198     <font class="keywordflow">if</font> ( it == selections.end() )
02199     <font class="keywordflow">return</font>;
02200 
02201     QTextDocumentSelection sel = *it;
02202     QTextParag *startParag = sel.startCursor.parag();
02203     QTextParag *endParag = sel.endCursor.parag();
02204     <font class="keywordflow">if</font> ( sel.endCursor.parag()-&gt;paragId() &lt; sel.startCursor.parag()-&gt;paragId() ) {
02205     endParag = sel.startCursor.parag();
02206     startParag = sel.endCursor.parag();
02207     }
02208 
02209     QTextParag *p = startParag;
02210     <font class="keywordflow">while</font> ( p &amp;&amp; p != endParag ) {
02211     p-&gt;indent();
02212     p = p-&gt;next();
02213     }
02214 }
02215 
02216 <font class="keywordtype">void</font> QTextDocument::addCommand( QTextCommand *cmd )
02217 {
02218     commandHistory-&gt;addCommand( cmd );
02219 }
02220 
02221 QTextCursor *QTextDocument::undo( QTextCursor *c )
02222 {
02223     <font class="keywordflow">return</font> commandHistory-&gt;undo( c );
02224 }
02225 
02226 QTextCursor *QTextDocument::redo( QTextCursor *c )
02227 {
02228     <font class="keywordflow">return</font> commandHistory-&gt;redo( c );
02229 }
02230 
02231 <font class="keywordtype">bool</font> QTextDocument::find( <font class="keyword">const</font> QString &amp;expr, <font class="keywordtype">bool</font> cs, <font class="keywordtype">bool</font> wo, <font class="keywordtype">bool</font> forward,
02232                   <font class="keywordtype">int</font> *parag, <font class="keywordtype">int</font> *index, QTextCursor *cursor )
02233 {
02234     QTextParag *p = forward ? fParag : lParag;
02235     <font class="keywordflow">if</font> ( parag )
02236     p = paragAt( *parag );
02237     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( cursor )
02238     p = cursor-&gt;parag();
02239     <font class="keywordtype">bool</font> first = TRUE;
02240 
02241     <font class="keywordflow">while</font> ( p ) {
02242     QString s = p-&gt;string()-&gt;toString();
02243     s.remove( s.length() - 1, 1 ); <font class="comment">// get rid of trailing space</font>
02244     <font class="keywordtype">int</font> start = forward ? 0 : s.length() - 1;
02245     <font class="keywordflow">if</font> ( first &amp;&amp; index )
02246         start = *index;
02247     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( first )
02248         start = cursor-&gt;index();
02249     first = FALSE;
02250     <font class="keywordtype">int</font> res = forward ? s.find( expr, start, cs ) : s.findRev( expr, start, cs );
02251     <font class="keywordflow">if</font> ( res != -1 ) {
02252         <font class="keywordtype">bool</font> ok = TRUE;
02253         <font class="keywordflow">if</font> ( wo ) {
02254         <font class="keywordtype">int</font> end = res + expr.length();
02255         <font class="keywordflow">if</font> ( ( res == 0 || s[ res ].isSpace() || s[ res ].isPunct() ) &amp;&amp;
02256              ( end == (int)s.length() - 1 || s[ end ].isSpace() || s[ end ].isPunct() ) )
02257             ok = TRUE;
02258         <font class="keywordflow">else</font>
02259             ok = FALSE;
02260         }
02261         <font class="keywordflow">if</font> ( ok ) {
02262         cursor-&gt;setParag( p );
02263         cursor-&gt;setIndex( res );
02264         setSelectionStart( Standard, cursor );
02265         cursor-&gt;setIndex( res + expr.length() );
02266         setSelectionEnd( Standard, cursor );
02267         <font class="keywordflow">if</font> ( parag )
02268             *parag = p-&gt;paragId();
02269         <font class="keywordflow">if</font> ( index )
02270             *index = res;
02271         <font class="keywordflow">return</font> TRUE;
02272         }
02273     }
02274     p = forward ? p-&gt;next() : p-&gt;prev();
02275     }
02276 
02277     <font class="keywordflow">return</font> FALSE;
02278 }
02279 
02280 <font class="keywordtype">void</font> QTextDocument::setTextFormat( Qt::TextFormat f )
02281 {
02282     txtFormat = f;
02283 }
02284 
02285 Qt::TextFormat QTextDocument::textFormat()<font class="keyword"> const</font>
02286 <font class="keyword"></font>{
02287     <font class="keywordflow">return</font> txtFormat;
02288 }
02289 
02290 <font class="keywordtype">bool</font> QTextDocument::inSelection( <font class="keywordtype">int</font> selId, <font class="keyword">const</font> QPoint &amp;pos )<font class="keyword"> const</font>
02291 <font class="keyword"></font>{
02292     QMap&lt;int, QTextDocumentSelection&gt;::ConstIterator it = selections.find( selId );
02293     <font class="keywordflow">if</font> ( it == selections.end() )
02294     <font class="keywordflow">return</font> FALSE;
02295 
02296     QTextDocumentSelection sel = *it;
02297     QTextParag *startParag = sel.startCursor.parag();
02298     QTextParag *endParag = sel.endCursor.parag();
02299     <font class="keywordflow">if</font> ( sel.startCursor.parag() == sel.endCursor.parag() &amp;&amp;
02300      sel.startCursor.parag()-&gt;selectionStart( selId ) == sel.endCursor.parag()-&gt;selectionEnd( selId ) )
02301     <font class="keywordflow">return</font> FALSE;
02302     <font class="keywordflow">if</font> ( sel.endCursor.parag()-&gt;paragId() &lt; sel.startCursor.parag()-&gt;paragId() ) {
02303     endParag = sel.startCursor.parag();
02304     startParag = sel.endCursor.parag();
02305     }
02306 
02307     QTextParag *p = startParag;
02308     <font class="keywordflow">while</font> ( p ) {
02309     <font class="keywordflow">if</font> ( p-&gt;rect().contains( pos ) ) {
02310         <font class="keywordtype">bool</font> inSel = FALSE;
02311         <font class="keywordtype">int</font> selStart = p-&gt;selectionStart( selId );
02312         <font class="keywordtype">int</font> selEnd = p-&gt;selectionEnd( selId );
02313         <font class="keywordtype">int</font> y = 0;
02314         <font class="keywordtype">int</font> h = 0;
02315         <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; p-&gt;length(); ++i ) {
02316         <font class="keywordflow">if</font> ( i == selStart )
02317             inSel = TRUE;
02318         <font class="keywordflow">if</font> ( i == selEnd )
02319             <font class="keywordflow">break</font>;
02320         <font class="keywordflow">if</font> ( p-&gt;at( i )-&gt;lineStart ) {
02321             y = (*p-&gt;lineStarts.find( i ))-&gt;y;
02322             h = (*p-&gt;lineStarts.find( i ))-&gt;h;
02323         }
02324         <font class="keywordflow">if</font> ( pos.y() - p-&gt;rect().y() &gt;= y &amp;&amp; pos.y() - p-&gt;rect().y() &lt;= y + h ) {
02325             <font class="keywordflow">if</font> ( inSel &amp;&amp; pos.x() &gt;= p-&gt;at( i )-&gt;x &amp;&amp;
02326              pos.x() &lt;= p-&gt;at( i )-&gt;x + p-&gt;at( i )-&gt;format()-&gt;width( p-&gt;at( i )-&gt;c ) )
02327             <font class="keywordflow">return</font> TRUE;
02328         }
02329         }
02330     }
02331     <font class="keywordflow">if</font> ( pos.y() &lt; p-&gt;rect().y() )
02332         <font class="keywordflow">break</font>;
02333     <font class="keywordflow">if</font> ( p == endParag )
02334         <font class="keywordflow">break</font>;
02335     p = p-&gt;next();
02336     }
02337 
02338     <font class="keywordflow">return</font> FALSE;
02339 }
02340 
02341 <font class="keywordtype">void</font> QTextDocument::doLayout( QPainter *p, <font class="keywordtype">int</font> w )
02342 {
02343     withoutDoubleBuffer = ( p != 0 );
02344     flow_-&gt;setWidth( w );
02345     cw = w;
02346     vw = w;
02347     <font class="keywordflow">if</font> ( !par &amp;&amp; is_printer( p ) )
02348     fCollection-&gt;setPainter( p );
02349     QTextParag *parag = fParag;
02350     <font class="keywordflow">while</font> ( parag ) {
02351     parag-&gt;invalidate( 0 );
02352     <font class="keywordflow">if</font> ( is_printer( p ) )
02353         parag-&gt;setPainter( p );
02354     parag-&gt;format();
02355     parag = parag-&gt;next();
02356     }
02357     <font class="keywordflow">if</font> ( !par &amp;&amp; is_printer( p ) ) {
02358     fCollection-&gt;setPainter( 0 );
02359     parag = fParag;
02360     <font class="keywordflow">while</font> ( parag ) {
02361         parag-&gt;setPainter( 0 );
02362         parag = parag-&gt;next();
02363     }
02364     }
02365 }
02366 
02367 QPixmap *QTextDocument::bufferPixmap( <font class="keyword">const</font> QSize &amp;s )
02368 {
02369     <font class="keywordflow">if</font> ( !buf_pixmap ) {
02370     buf_pixmap = <font class="keyword">new</font> QPixmap( s );
02371     } <font class="keywordflow">else</font> {
02372     <font class="keywordflow">if</font> ( buf_pixmap-&gt;width() &lt; s.width() ||
02373          buf_pixmap-&gt;height() &lt; s.height() ) {
02374         buf_pixmap-&gt;resize( QMAX( s.width(), buf_pixmap-&gt;width() ),
02375                 QMAX( s.height(), buf_pixmap-&gt;height() ) );
02376     }
02377     }
02378 
02379     <font class="keywordflow">return</font> buf_pixmap;
02380 }
02381 
02382 <font class="keywordtype">void</font> QTextDocument::draw( QPainter *p, <font class="keyword">const</font> QRegion &amp;reg, <font class="keyword">const</font> QColorGroup &amp;cg, <font class="keyword">const</font> QBrush *paper )
02383 {
02384     <font class="keywordflow">if</font> ( !firstParag() )
02385     <font class="keywordflow">return</font>;
02386 
02387     <font class="keywordflow">if</font> ( paper ) {
02388 <font class="comment">//QT2HACK</font>
02389 <font class="comment">//  p-&gt;setBrushOrigin( -(int)p-&gt;translationX(),</font>
02390 <font class="comment">//             -(int)p-&gt;translationY() );</font>
02391     p-&gt;setBrushOrigin( -(<font class="keywordtype">int</font>)p-&gt;worldMatrix().dx(),
02392                -(int)p-&gt;worldMatrix().dy() );
02393     p-&gt;fillRect( reg.boundingRect(), *paper );
02394     }
02395 
02396     QTextParag *parag = firstParag();
02397     QRect cr;
02398     <font class="keywordflow">if</font> ( !reg.isNull() )
02399     cr = reg.boundingRect();
02400     <font class="keywordflow">while</font> ( parag ) {
02401     <font class="keywordflow">if</font> ( !parag-&gt;isValid() )
02402         parag-&gt;format();
02403     <font class="keywordtype">int</font> y = parag-&gt;rect().y();
02404     QRect pr( parag-&gt;rect() );
02405     pr.setX( 0 );
02406     pr.setWidth( QWIDGETSIZE_MAX );
02407     <font class="keywordflow">if</font> ( !reg.isNull() &amp;&amp; !cr.isNull() &amp;&amp; !cr.intersects( pr ) ) {
02408         parag = parag-&gt;next();
02409         <font class="keywordflow">continue</font>;
02410     }
02411     p-&gt;translate( 0, y );
02412     parag-&gt;paint( *p, cg, 0, FALSE );
02413     p-&gt;translate( 0, -y );
02414     parag = parag-&gt;next();
02415     }
02416 }
02417 
02418 <font class="keywordtype">void</font> QTextDocument::drawParag( QPainter *p, QTextParag *parag, <font class="keywordtype">int</font> cx, <font class="keywordtype">int</font> cy, <font class="keywordtype">int</font> cw, <font class="keywordtype">int</font> ch,
02419                    QPixmap *&amp;doubleBuffer, <font class="keyword">const</font> QColorGroup &amp;cg,
02420                    <font class="keywordtype">bool</font> drawCursor, QTextCursor *cursor, <font class="keywordtype">bool</font> resetChanged )
02421 {
02422     QPainter *painter = 0;
02423     <font class="keywordflow">if</font> ( resetChanged )
02424     parag-&gt;setChanged( FALSE );
02425     QRect ir( parag-&gt;rect() );
02426     <font class="keywordtype">bool</font> useDoubleBuffer = !parag-&gt;document()-&gt;parent();
02427     <font class="keywordflow">if</font> ( !useDoubleBuffer &amp;&amp; parag-&gt;document()-&gt;nextDoubleBuffered )
02428     useDoubleBuffer = TRUE;
02429     <font class="keywordflow">if</font> ( p-&gt;device()-&gt;devType() == QInternal::Printer )
02430     useDoubleBuffer = FALSE;
02431 
02432     <font class="keywordflow">if</font> ( useDoubleBuffer  ) {
02433     painter = <font class="keyword">new</font> QPainter;
02434     <font class="keywordflow">if</font> ( cx &gt;= 0 &amp;&amp; cy &gt;= 0 )
02435         ir = ir.intersect( QRect( cx, cy, cw, ch ) );
02436     <font class="keywordflow">if</font> ( !doubleBuffer ||
02437          ir.width() &gt; doubleBuffer-&gt;width() ||
02438          ir.height() &gt; doubleBuffer-&gt;height() ) {
02439         doubleBuffer = bufferPixmap( ir.size() );
02440         painter-&gt;begin( doubleBuffer );
02441     } <font class="keywordflow">else</font> {
02442         painter-&gt;begin( doubleBuffer );
02443     }
02444     } <font class="keywordflow">else</font> {
02445     painter = p;
02446     painter-&gt;translate( ir.x(), ir.y() );
02447     }
02448 
02449     painter-&gt;setBrushOrigin( -ir.x(), -ir.y() );
02450 
02451     <font class="keywordflow">if</font> ( useDoubleBuffer ) {
02452         painter-&gt;fillRect( QRect( 0, 0, ir.width(), ir.height() ),
02453                            cg.brush( QColorGroup::Base ) );
02454     } <font class="keywordflow">else</font> {
02455     <font class="keywordflow">if</font> ( cursor &amp;&amp; cursor-&gt;parag() == parag ) {
02456         painter-&gt;fillRect( QRect( parag-&gt;at( cursor-&gt;index() )-&gt;x, 0, 2, ir.height() ),
02457                    cg.brush( QColorGroup::Base ) );
02458     }
02459     }
02460 
02461     painter-&gt;translate( -( ir.x() - parag-&gt;rect().x() ),
02462                -( ir.y() - parag-&gt;rect().y() ) );
02463     parag-&gt;paint( *painter, cg, drawCursor ? cursor : 0, TRUE, cx, cy, cw, ch );
02464     <font class="keywordflow">if</font> ( !flow()-&gt;isEmpty() ) {
02465     painter-&gt;translate( 0, -parag-&gt;rect().y() );
02466     QRect cr( cx, cy, cw, ch );
02467     cr = cr.intersect( QRect( 0, parag-&gt;rect().y(), parag-&gt;rect().width(), parag-&gt;rect().height() ) );
02468     flow()-&gt;drawFloatingItems( painter, cr.x(), cr.y(), cr.width(), cr.height(), cg, FALSE );
02469     painter-&gt;translate( 0, +parag-&gt;rect().y() );
02470     }
02471 
02472     <font class="keywordflow">if</font> ( useDoubleBuffer ) {
02473     <font class="keyword">delete</font> painter;
02474     painter = 0;
02475     p-&gt;drawPixmap( ir.topLeft(), *doubleBuffer, QRect( QPoint( 0, 0 ), ir.size() ) );
02476     } <font class="keywordflow">else</font> {
02477     painter-&gt;translate( -ir.x(), -ir.y() );
02478     }
02479 
02480     <font class="keywordflow">if</font> ( parag-&gt;rect().x() + parag-&gt;rect().width() &lt; parag-&gt;document()-&gt;x() + parag-&gt;document()-&gt;width() ) {
02481     p-&gt;fillRect( parag-&gt;rect().x() + parag-&gt;rect().width(), parag-&gt;rect().y(),
02482              ( parag-&gt;document()-&gt;x() + parag-&gt;document()-&gt;width() ) -
02483              ( parag-&gt;rect().x() + parag-&gt;rect().width() ),
02484              parag-&gt;rect().height(), cg.brush( QColorGroup::Base ) );
02485     }
02486 
02487     <font class="keywordflow">if</font> ( verticalBreak() &amp;&amp; parag-&gt;lastInFrame &amp;&amp; parag-&gt;document()-&gt;flow() )
02488     parag-&gt;document()-&gt;flow()-&gt;eraseAfter( parag, p, cg );
02489 
02490     parag-&gt;document()-&gt;nextDoubleBuffered = FALSE;
02491 }
02492 
02493 QTextParag *QTextDocument::draw( QPainter *p, <font class="keywordtype">int</font> cx, <font class="keywordtype">int</font> cy, <font class="keywordtype">int</font> cw, <font class="keywordtype">int</font> ch, <font class="keyword">const</font> QColorGroup &amp;cg,
02494                  <font class="keywordtype">bool</font> onlyChanged, <font class="keywordtype">bool</font> drawCursor, QTextCursor *cursor, <font class="keywordtype">bool</font> resetChanged )
02495 {
02496     <font class="keywordflow">if</font> ( withoutDoubleBuffer || par &amp;&amp; par-&gt;withoutDoubleBuffer ) {
02497     withoutDoubleBuffer = TRUE;
02498     QRegion rg;
02499     draw( p, rg, cg );
02500     <font class="keywordflow">return</font> 0;
02501     }
02502     withoutDoubleBuffer = FALSE;
02503 
02504     <font class="keywordflow">if</font> ( !firstParag() )
02505     <font class="keywordflow">return</font> 0;
02506 
02507     <font class="keywordflow">if</font> ( drawCursor &amp;&amp; cursor )
02508     tmpCursor = cursor;
02509     <font class="keywordflow">if</font> ( cx &lt; 0 &amp;&amp; cy &lt; 0 ) {
02510     cx = 0;
02511     cy = 0;
02512     cw = width();
02513     ch = height();
02514     }
02515 
02516     QTextParag *lastFormatted = 0;
02517     QTextParag *parag = firstParag();
02518 
02519     QPixmap *doubleBuffer = 0;
02520     QPainter painter;
02521 
02522     <font class="keywordflow">while</font> ( parag ) {
02523     lastFormatted = parag;
02524     <font class="keywordflow">if</font> ( !parag-&gt;isValid() )
02525         parag-&gt;format();
02526 
02527     <font class="keywordflow">if</font> ( !parag-&gt;rect().intersects( QRect( cx, cy, cw, ch ) ) ) {
02528         QRect pr( parag-&gt;rect() );
02529         pr.setWidth( parag-&gt;document()-&gt;width() );
02530         <font class="keywordflow">if</font> ( pr.intersects( QRect( cx, cy, cw, ch ) ) )
02531                 p-&gt;fillRect( pr.intersect( QRect( cx, cy, cw, ch ) ), cg.brush( QColorGroup::Base ) );
02532         <font class="keywordflow">if</font> ( parag-&gt;rect().y() &gt; cy + ch ) {
02533         tmpCursor = 0;
02534         <font class="keywordflow">if</font> ( buf_pixmap &amp;&amp; buf_pixmap-&gt;height() &gt; 300 ) {
02535             <font class="keyword">delete</font> buf_pixmap;
02536             buf_pixmap = 0;
02537         }
02538         <font class="keywordflow">if</font> ( verticalBreak() &amp;&amp; flow() )
02539             flow()-&gt;draw( p, cx, cy, cw, ch );
02540 
02541         <font class="keywordflow">return</font> lastFormatted;
02542         }
02543         parag = parag-&gt;next();
02544         <font class="keywordflow">continue</font>;
02545     }
02546 
02547     <font class="keywordflow">if</font> ( !parag-&gt;hasChanged() &amp;&amp; onlyChanged ) {
02548         parag = parag-&gt;next();
02549         <font class="keywordflow">continue</font>;
02550     }
02551 
02552     drawParag( p, parag, cx, cy, cw, ch, doubleBuffer, cg, drawCursor, cursor, resetChanged );
02553     parag = parag-&gt;next();
02554     }
02555 
02556     parag = lastParag();
02557     <font class="keywordflow">if</font> ( parag-&gt;rect().y() + parag-&gt;rect().height() &lt; parag-&gt;document()-&gt;height() ) {
02558     p-&gt;fillRect( 0, parag-&gt;rect().y() + parag-&gt;rect().height(), parag-&gt;document()-&gt;width(),
02559              parag-&gt;document()-&gt;height() - ( parag-&gt;rect().y() + parag-&gt;rect().height() ),
02560              cg.brush( QColorGroup::Base ) );
02561     <font class="keywordflow">if</font> ( !flow()-&gt;isEmpty() ) {
02562         QRect cr( cx, cy, cw, ch );
02563         cr = cr.intersect( QRect( 0, parag-&gt;rect().y() + parag-&gt;rect().height(), parag-&gt;document()-&gt;width(),
02564                       parag-&gt;document()-&gt;height() - ( parag-&gt;rect().y() + parag-&gt;rect().height() ) ) );
02565         flow()-&gt;drawFloatingItems( p, cr.x(), cr.y(), cr.width(), cr.height(), cg, FALSE );
02566     }
02567     }
02568 
02569     <font class="keywordflow">if</font> ( buf_pixmap &amp;&amp; buf_pixmap-&gt;height() &gt; 300 ) {
02570     <font class="keyword">delete</font> buf_pixmap;
02571     buf_pixmap = 0;
02572     }
02573 
02574     <font class="keywordflow">if</font> ( verticalBreak() &amp;&amp; flow() )
02575     flow()-&gt;draw( p, cx, cy, cw, ch );
02576 
02577     tmpCursor = 0;
02578     <font class="keywordflow">return</font> lastFormatted;
02579 }
02580 
02581 <font class="keywordtype">void</font> QTextDocument::setDefaultFont( <font class="keyword">const</font> QFont &amp;f )
02582 {
02583     updateFontSizes( f.pointSize() );
02584 }
02585 
02586 <font class="keywordtype">void</font> QTextDocument::registerCustomItem( QTextCustomItem *i, QTextParag *p )
02587 {
02588     <font class="keywordflow">if</font> ( i &amp;&amp; i-&gt;placement() != QTextCustomItem::PlaceInline ) {
02589     flow_-&gt;registerFloatingItem( i, i-&gt;placement() == QTextCustomItem::PlaceRight );
02590     p-&gt;registerFloatingItem( i );
02591     }
02592     i-&gt;setParagraph( p );
02593     customItems.append( i );
02594 }
02595 
02596 <font class="keywordtype">void</font> QTextDocument::unregisterCustomItem( QTextCustomItem *i, QTextParag *p )
02597 {
02598     flow_-&gt;unregisterFloatingItem( i );
02599     p-&gt;unregisterFloatingItem( i );
02600     customItems.removeRef( i );
02601     i-&gt;setParagraph( 0L );
02602 }
02603 
02604 <font class="keywordtype">bool</font> QTextDocument::focusNextPrevChild( <font class="keywordtype">bool</font> next )
02605 {
02606     <font class="keywordflow">if</font> ( !focusIndicator.parag ) {
02607     <font class="keywordflow">if</font> ( next ) {
02608         focusIndicator.parag = fParag;
02609         focusIndicator.start = 0;
02610         focusIndicator.len = 0;
02611     } <font class="keywordflow">else</font> {
02612         focusIndicator.parag = lParag;
02613         focusIndicator.start = lParag-&gt;length();
02614         focusIndicator.len = 0;
02615     }
02616     } <font class="keywordflow">else</font> {
02617     focusIndicator.parag-&gt;setChanged( TRUE );
02618     }
02619     focusIndicator.href = QString::null;
02620 
02621     <font class="keywordflow">if</font> ( next ) {
02622     QTextParag *p = focusIndicator.parag;
02623     <font class="keywordtype">int</font> index = focusIndicator.start + focusIndicator.len;
02624     <font class="keywordflow">while</font> ( p ) {
02625         <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = index; i &lt; p-&gt;length(); ++i ) {
02626         <font class="keywordflow">if</font> ( p-&gt;at( i )-&gt;format()-&gt;isAnchor() ) {
02627             p-&gt;setChanged( TRUE );
02628             focusIndicator.parag = p;
02629             focusIndicator.start = i;
02630             focusIndicator.len = 0;
02631             focusIndicator.href = p-&gt;at( i )-&gt;format()-&gt;anchorHref();
02632             <font class="keywordflow">while</font> ( i &lt; p-&gt;length() ) {
02633             <font class="keywordflow">if</font> ( !p-&gt;at( i )-&gt;format()-&gt;isAnchor() )
02634                 <font class="keywordflow">return</font> TRUE;
02635             focusIndicator.len++;
02636             i++;
02637             }
02638         }
02639         }
02640         index = 0;
02641         p = p-&gt;next();
02642     }
02643     } <font class="keywordflow">else</font> {
02644     QTextParag *p = focusIndicator.parag;
02645     <font class="keywordtype">int</font> index = focusIndicator.start - 1;
02646     <font class="keywordflow">while</font> ( p ) {
02647         <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = index; i &gt;= 0; --i ) {
02648         <font class="keywordflow">if</font> ( p-&gt;at( i )-&gt;format()-&gt;isAnchor() ) {
02649             p-&gt;setChanged( TRUE );
02650             focusIndicator.parag = p;
02651             focusIndicator.start = i;
02652             focusIndicator.len = 0;
02653             focusIndicator.href = p-&gt;at( i )-&gt;format()-&gt;anchorHref();
02654             <font class="keywordflow">while</font> ( i &gt;= -1 ) {
02655             <font class="keywordflow">if</font> ( i &lt; 0 || !p-&gt;at( i )-&gt;format()-&gt;isAnchor() ) {
02656                 focusIndicator.start++;
02657                 <font class="keywordflow">return</font> TRUE;
02658             }
02659             <font class="keywordflow">if</font> ( i &lt; 0 )
02660                 <font class="keywordflow">break</font>;
02661             focusIndicator.len++;
02662             focusIndicator.start--;
02663             i--;
02664             }
02665         }
02666         }
02667         p = p-&gt;prev();
02668         <font class="keywordflow">if</font> ( p )
02669         index = p-&gt;length() - 1;
02670     }
02671     }
02672 
02673     <font class="keywordflow">return</font> FALSE;
02674 }
02675 
02676 <font class="keywordtype">int</font> QTextDocument::length()<font class="keyword"> const</font>
02677 <font class="keyword"></font>{
02678     <font class="keywordtype">int</font> l = 0;
02679     QTextParag *p = fParag;
02680     <font class="keywordflow">while</font> ( p ) {
02681     l += p-&gt;length();
02682     p = p-&gt;next();
02683     }
02684     <font class="keywordflow">return</font> l;
02685 }
02686 
02687 <font class="comment">// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
02688 
02689 <font class="keywordtype">int</font> QTextFormat::width( <font class="keyword">const</font> QChar &amp;c )<font class="keyword"> const</font>
02690 <font class="keyword"></font>{
02691     <font class="keywordflow">if</font> ( c.unicode() == 0xad ) <font class="comment">// soft hyphen</font>
02692     <font class="keywordflow">return</font> 0;
02693     <font class="keywordflow">if</font> ( !painter || !painter-&gt;isActive() ) {
02694     <font class="keywordflow">if</font> ( c == <font class="charliteral">'\t'</font> )
02695         <font class="keywordflow">return</font> fm.width( <font class="charliteral">'x'</font> ) * 8;
02696     <font class="keywordflow">if</font> ( ha == AlignNormal ) {
02697         <font class="keywordtype">int</font> w;
02698         <font class="keywordflow">if</font> ( c.row() )
02699         w = fm.width( c );
02700         <font class="keywordflow">else</font>
02701         w = widths[ c.unicode() ];
02702         <font class="keywordflow">if</font> ( w == 0 &amp;&amp; !c.row() ) {
02703         w = fm.width( c );
02704         ( (QTextFormat*)<font class="keyword">this</font> )-&gt;widths[ c.unicode() ] = w;
02705         }
02706         <font class="keywordflow">return</font> w;
02707     } <font class="keywordflow">else</font> {
02708         QFont f( fn );
02709         f.setPointSize( ( f.pointSize() * 2 ) / 3 );
02710         QFontMetrics fm_( f );
02711         <font class="keywordflow">return</font> fm_.width( c );
02712     }
02713     }
02714 
02715     QFont f( fn );
02716     <font class="keywordflow">if</font> ( ha != AlignNormal )
02717     f.setPointSize( ( f.pointSize() * 2 ) / 3 );
02718     painter-&gt;setFont( f );
02719 
02720     <font class="keywordflow">return</font> painter-&gt;fontMetrics().width( c );
02721 }
02722 
02723 <font class="keywordtype">int</font> QTextFormat::width( <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">int</font> pos )<font class="keyword"> const</font>
02724 <font class="keyword"></font>{
02725     <font class="keywordtype">int</font> w;
02726     <font class="keywordflow">if</font> ( str[ pos ].unicode() == 0xad )
02727     <font class="keywordflow">return</font> 0;
02728     <font class="keywordflow">if</font> ( !painter || !painter-&gt;isActive() ) {
02729     <font class="keywordflow">if</font> ( ha == AlignNormal ) {
02730 <font class="comment">//          w = fm.charWidth( str, pos );</font>
02731             w = fm.width( str[pos] );
02732     } <font class="keywordflow">else</font> {
02733         QFont f( fn );
02734         f.setPointSize( ( f.pointSize() * 2 ) / 3 );
02735         QFontMetrics fm_( f );
02736             w = fm_.width( str[pos] );
02737 <font class="comment">//      w = fm_.charWidth( str, pos );</font>
02738     }
02739     } <font class="keywordflow">else</font> {
02740     QFont f( fn );
02741     <font class="keywordflow">if</font> ( ha != AlignNormal )
02742         f.setPointSize( ( f.pointSize() * 2 ) / 3 );
02743     painter-&gt;setFont( f );
02744     w = painter-&gt;fontMetrics().width( str[pos] );
02745 <font class="comment">//  w = painter-&gt;fontMetrics().charWidth( str, pos );</font>
02746     }
02747     <font class="keywordflow">return</font> w;
02748 }
02749 
02750 <font class="comment">// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
02751 
02752 QTextString::QTextString()
02753 {
02754     textChanged = FALSE;
02755     bidi = FALSE;
02756     rightToLeft = FALSE;
02757 }
02758 
02759 QTextString::QTextString( <font class="keyword">const</font> QTextString &amp;s )
02760 {
02761     textChanged = s.textChanged;
02762     bidi = s.bidi;
02763     rightToLeft = s.rightToLeft;
02764     data = s.subString();
02765 }
02766 
02767 <font class="keywordtype">void</font> QTextString::insert( <font class="keywordtype">int</font> index, <font class="keyword">const</font> QString &amp;s, QTextFormat *f )
02768 {
02769     <font class="keywordtype">int</font> os = data.size();
02770     data.resize( data.size() + s.length() );
02771     <font class="keywordflow">if</font> ( index &lt; os ) {
02772     memmove( data.data() + index + s.length(), data.data() + index,
02773          <font class="keyword">sizeof</font>( QTextStringChar ) * ( os - index ) );
02774     }
02775     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)s.length(); ++i ) {
02776     data[ (int)index + i ].x = 0;
02777     data[ (int)index + i ].lineStart = 0;
02778     data[ (int)index + i ].d.format = 0;
02779     data[ (int)index + i ].type = QTextStringChar::Regular;
02780     data[ (int)index + i ].rightToLeft = 0;
02781     data[ (int)index + i ].startOfRun = 0;
02782 <font class="preprocessor">#if defined(Q_WS_X11)</font>
02783 <font class="preprocessor"></font>    <font class="comment">//### workaround for broken courier fonts on X11</font>
02784     <font class="keywordflow">if</font> ( s[ i ] == QChar( 0x00a0U ) )
02785         data[ (int)index + i ].c = <font class="charliteral">' '</font>;
02786     <font class="keywordflow">else</font>
02787         data[ (int)index + i ].c = s[ i ];
02788 <font class="preprocessor">#else</font>
02789 <font class="preprocessor"></font>    data[ (int)index + i ].c = s[ i ];
02790 <font class="preprocessor">#endif</font>
02791 <font class="preprocessor"></font><font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
02792 <font class="preprocessor"></font>    qDebug(<font class="stringliteral">"QTextString::insert setting format %p to character %d"</font>,f,(<font class="keywordtype">int</font>)index+i);
02793 <font class="preprocessor">#endif</font>
02794 <font class="preprocessor"></font>    data[ (int)index + i ].setFormat( f );
02795     }
02796     textChanged = TRUE;
02797 }
02798 
02799 QTextString::~QTextString()
02800 {
02801     clear();
02802 }
02803 
02804 <font class="keywordtype">void</font> QTextString::insert( <font class="keywordtype">int</font> index, QTextStringChar *c )
02805 {
02806     <font class="keywordtype">int</font> os = data.size();
02807     data.resize( data.size() + 1 );
02808     <font class="keywordflow">if</font> ( index &lt; os ) {
02809     memmove( data.data() + index + 1, data.data() + index,
02810          <font class="keyword">sizeof</font>( QTextStringChar ) * ( os - index ) );
02811     }
02812     data[ (int)index ].c = c-&gt;c;
02813     data[ (int)index ].x = 0;
02814     data[ (int)index ].lineStart = 0;
02815     data[ (int)index ].rightToLeft = 0;
02816     data[ (int)index ].d.format = 0;
02817     data[ (int)index ].type = QTextStringChar::Regular;
02818     data[ (int)index ].setFormat( c-&gt;format() );
02819     textChanged = TRUE;
02820 }
02821 
02822 <font class="keywordtype">void</font> QTextString::truncate( <font class="keywordtype">int</font> index )
02823 {
02824     index = QMAX( index, 0 );
02825     index = QMIN( index, (<font class="keywordtype">int</font>)data.size() - 1 );
02826     <font class="keywordflow">if</font> ( index &lt; (int)data.size() ) {
02827     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = index + 1; i &lt; (int)data.size(); ++i ) {
02828         <font class="keywordflow">if</font> ( data[ i ].isCustom() ) {
02829         <font class="keyword">delete</font> data[ i ].customItem();
02830         <font class="keywordflow">if</font> ( data[ i ].d.custom-&gt;format )
02831             data[ i ].d.custom-&gt;format-&gt;removeRef();
02832         data[ i ].d.custom = 0;
02833         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( data[ i ].format() ) {
02834         data[ i ].format()-&gt;removeRef();
02835         }
02836     }
02837     }
02838     data.truncate( index );
02839     textChanged = TRUE;
02840 }
02841 
02842 <font class="keywordtype">void</font> QTextString::remove( <font class="keywordtype">int</font> index, <font class="keywordtype">int</font> len )
02843 {
02844     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = index; i &lt; (int)data.size() &amp;&amp; i - index &lt; len; ++i ) {
02845     <font class="keywordflow">if</font> ( data[ i ].isCustom() ) {
02846         <font class="keyword">delete</font> data[ i ].customItem();
02847         <font class="keywordflow">if</font> ( data[ i ].d.custom-&gt;format )
02848         data[ i ].d.custom-&gt;format-&gt;removeRef();
02849         data[ i ].d.custom = 0;
02850     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( data[ i ].format() ) {
02851         data[ i ].format()-&gt;removeRef();
02852     }
02853     }
02854     memmove( data.data() + index, data.data() + index + len,
02855          <font class="keyword">sizeof</font>( QTextStringChar ) * ( data.size() - index - len ) );
02856     data.resize( data.size() - len );
02857     textChanged = TRUE;
02858 }
02859 
02860 <font class="keywordtype">void</font> QTextString::clear()
02861 {
02862     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)data.count(); ++i ) {
02863     <font class="keywordflow">if</font> ( data[ i ].isCustom() ) {
02864         <font class="keyword">delete</font> data[ i ].customItem();
02865         <font class="keywordflow">if</font> ( data[ i ].d.custom-&gt;format )
02866         data[ i ].d.custom-&gt;format-&gt;removeRef();
02867         <font class="keyword">delete</font> data[ i ].d.custom;
02868         data[ i ].d.custom = 0;
02869     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( data[ i ].format() ) {
02870         data[ i ].format()-&gt;removeRef();
02871     }
02872     }
02873     data.resize( 0 );
02874 }
02875 
02876 <font class="keywordtype">void</font> QTextString::setFormat( <font class="keywordtype">int</font> index, QTextFormat *f, <font class="keywordtype">bool</font> useCollection )
02877 {
02878 <font class="comment">//    qDebug("QTextString::setFormat index=%d f=%p",index,f);</font>
02879     <font class="keywordflow">if</font> ( useCollection &amp;&amp; data[ index ].format() )
02880     {
02881         <font class="comment">//qDebug("QTextString::setFormat removing ref on old format %p",data[ index ].format());</font>
02882     data[ index ].format()-&gt;removeRef();
02883     }
02884     data[ index ].setFormat( f );
02885 }
02886 
02887 <font class="keywordtype">void</font> QTextString::checkBidi()<font class="keyword"> const</font>
02888 <font class="keyword"></font>{
02889     <font class="keywordtype">int</font> len = data.size();
02890     <font class="keyword">const</font> QTextStringChar *c = data.data();
02891     ((QTextString *)<font class="keyword">this</font>)-&gt;bidi = FALSE;
02892     ((QTextString *)<font class="keyword">this</font>)-&gt;rightToLeft = FALSE;
02893     <font class="keywordflow">while</font>( len ) {
02894     uchar row = c-&gt;c.row();
02895     <font class="keywordflow">if</font>( (row &gt; 0x04 &amp;&amp; row &lt; 0x09) || row &gt; 0xfa ) {
02896         ((QTextString *)<font class="keyword">this</font>)-&gt;bidi = TRUE;
02897         basicDirection();
02898         <font class="keywordflow">return</font>;
02899     }
02900     len--;
02901     ++c;
02902     }
02903 }
02904 
02905 <font class="keywordtype">void</font> QTextString::basicDirection()<font class="keyword"> const</font>
02906 <font class="keyword"></font>{
02907     <font class="keywordtype">int</font> pos = 0;
02908     ((QTextString *)<font class="keyword">this</font>)-&gt;rightToLeft = FALSE;
02909     <font class="keywordflow">while</font>( pos &lt; length() ) {
02910     <font class="keywordflow">switch</font>( at(pos).c.direction() )
02911     {
02912     <font class="keywordflow">case</font> QChar::DirL:
02913     <font class="keywordflow">case</font> QChar::DirLRO:
02914     <font class="keywordflow">case</font> QChar::DirLRE:
02915         <font class="keywordflow">return</font>;
02916     <font class="keywordflow">case</font> QChar::DirR:
02917     <font class="keywordflow">case</font> QChar::DirAL:
02918     <font class="keywordflow">case</font> QChar::DirRLO:
02919     <font class="keywordflow">case</font> QChar::DirRLE:
02920         ((QTextString *)<font class="keyword">this</font>)-&gt;rightToLeft = TRUE;
02921         <font class="keywordflow">return</font>;
02922     <font class="keywordflow">default</font>:
02923         <font class="keywordflow">break</font>;
02924     }
02925     ++pos;
02926     }
02927     <font class="keywordflow">return</font>;
02928 }
02929 
02930 
02931 <font class="keywordtype">void</font> QTextDocument::setStyleSheet( <a class="code" href="class_q_style_sheet.html">QStyleSheet</a> *s )
02932 {
02933     <font class="keywordflow">if</font> ( !s )
02934     <font class="keywordflow">return</font>;
02935     sheet_ = s;
02936     fCollection-&gt;setStyleSheet( s );
02937     updateStyles();
02938 }
02939 
02940 <font class="keywordtype">void</font> QTextDocument::updateStyles()
02941 {
02942     invalidate();
02943     fCollection-&gt;updateStyles();
02944     <font class="keywordflow">for</font> ( QTextDocument *d = childList.first(); d; d = childList.next() )
02945     d-&gt;updateStyles();
02946 }
02947 
02948 <font class="keywordtype">void</font> QTextDocument::updateFontSizes( <font class="keywordtype">int</font> base )
02949 {
02950     <font class="keywordflow">for</font> ( QTextDocument *d = childList.first(); d; d = childList.next() )
02951     d-&gt;updateFontSizes( base );
02952     invalidate();
02953     fCollection-&gt;updateFontSizes( base );
02954 }
02955 
02956 <font class="keywordtype">void</font> QTextDocument::updateFontAttributes( <font class="keyword">const</font> QFont &amp;f, <font class="keyword">const</font> QFont &amp;old )
02957 {
02958     <font class="keywordflow">for</font> ( QTextDocument *d = childList.first(); d; d = childList.next() )
02959     d-&gt;updateFontAttributes( f, old );
02960     invalidate();
02961     fCollection-&gt;updateFontAttributes( f, old );
02962 }
02963 
02964 <font class="keywordtype">void</font> QTextStringChar::setFormat( QTextFormat *f )
02965 {
02966     <font class="keywordflow">if</font> ( type == Regular ) {
02967     d.format = f;
02968     } <font class="keywordflow">else</font> {
02969     <font class="keywordflow">if</font> ( !d.custom ) {
02970         d.custom = <font class="keyword">new</font> CustomData;
02971         d.custom-&gt;custom = 0;
02972     }
02973     d.custom-&gt;format = f;
02974     }
02975 }
02976 
02977 <font class="keywordtype">void</font> QTextStringChar::setCustomItem( QTextCustomItem *i )
02978 {
02979     <font class="keywordflow">if</font> ( !isCustom() ) {
02980     QTextFormat *f = format();
02981     d.custom = <font class="keyword">new</font> CustomData;
02982     d.custom-&gt;format = f;
02983     type = Custom;
02984     } <font class="keywordflow">else</font> {
02985     <font class="keyword">delete</font> d.custom-&gt;custom;
02986     }
02987     d.custom-&gt;custom = i;
02988 }
02989 
02990 <font class="keywordtype">void</font> QTextStringChar::loseCustomItem() <font class="comment">// setRegular() might be a better name</font>
02991 {
02992     <font class="keywordflow">if</font> ( isCustom() ) {
02993     QTextFormat *f = d.custom-&gt;format;
02994     d.custom-&gt;custom = 0;
02995     <font class="keyword">delete</font> d.custom;
02996     type = Regular;
02997     d.format = f;
02998     }
02999 }
03000 
03001 <font class="keywordtype">int</font> QTextString::width(<font class="keywordtype">int</font> idx)<font class="keyword"> const</font>
03002 <font class="keyword"></font>{
03003      <font class="keywordtype">int</font> w = 0;
03004      QTextStringChar *c = &amp;at( idx );
03005      <font class="keywordflow">if</font> ( c-&gt;c.unicode() == 0xad )
03006      <font class="keywordflow">return</font> 0;
03007      <font class="keywordflow">if</font>( c-&gt;isCustom() ) {
03008      <font class="keywordflow">if</font>( c-&gt;customItem()-&gt;placement() == QTextCustomItem::PlaceInline )
03009          w = c-&gt;customItem()-&gt;width;
03010      } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( c-&gt;type == QTextStringChar::Mark ) {
03011      <font class="keywordflow">return</font> 0;
03012      } <font class="keywordflow">else</font> {
03013      <font class="keywordtype">int</font> r = c-&gt;c.row();
03014      <font class="keywordflow">if</font>( r &lt; 0x06 || r &gt; 0x1f )
03015          w = c-&gt;format()-&gt;width( c-&gt;c );
03016      <font class="keywordflow">else</font> {
03017          <font class="comment">// complex text. We need some hacks to get the right metric here</font>
03018          QString str;
03019          <font class="keywordtype">int</font> pos = 0;
03020          <font class="keywordflow">if</font>( idx &gt; 3 )
03021          pos = idx - 3;
03022          <font class="keywordtype">int</font> off = idx - pos;
03023          <font class="keywordtype">int</font> end = QMIN( length(), idx + 3 );
03024          <font class="keywordflow">while</font> ( pos &lt; end ) {
03025          str += at(pos).c;
03026          pos++;
03027          }
03028          w = c-&gt;format()-&gt;width( str, off );
03029      }
03030      }
03031      <font class="keywordflow">return</font> w;
03032 }
03033 
03034 QMemArray&lt;QTextStringChar&gt; QTextString::subString( <font class="keywordtype">int</font> start, <font class="keywordtype">int</font> len )<font class="keyword"> const</font>
03035 <font class="keyword"></font>{
03036     <font class="keywordflow">if</font> ( len == 0xFFFFFF )
03037     len = data.size();
03038     QMemArray&lt;QTextStringChar&gt; a;
03039     a.resize( len );
03040     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; len; ++i ) {
03041     QTextStringChar *c = &amp;data[ i + start ];
03042     a[ i ].c = c-&gt;c;
03043     a[ i ].x = 0;
03044     a[ i ].lineStart = 0;
03045     a[ i ].rightToLeft = 0;
03046     a[ i ].d.format = 0;
03047     a[ i ].type = QTextStringChar::Regular;
03048     a[ i ].setFormat( c-&gt;format() );
03049     <font class="keywordflow">if</font> ( c-&gt;format() )
03050         c-&gt;format()-&gt;addRef();
03051     }
03052     <font class="keywordflow">return</font> a;
03053 }
03054 
03055 QTextStringChar *QTextStringChar::clone()<font class="keyword"> const</font>
03056 <font class="keyword"></font>{
03057     QTextStringChar *chr = <font class="keyword">new</font> QTextStringChar;
03058     chr-&gt;c = c;
03059     chr-&gt;x = 0;
03060     chr-&gt;lineStart = 0;
03061     chr-&gt;rightToLeft = 0;
03062     chr-&gt;d.format = 0;
03063     chr-&gt;type = QTextStringChar::Regular;
03064     chr-&gt;setFormat( format() );
03065     <font class="keywordflow">if</font> ( chr-&gt;format() )
03066     chr-&gt;format()-&gt;addRef();
03067     <font class="keywordflow">return</font> chr;
03068 }
03069 
03070 <font class="comment">// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
03071 
03072 QTextParag::QTextParag( QTextDocument *d, QTextParag *pr, QTextParag *nx, <font class="keywordtype">bool</font> updateIds )
03073     : invalid( 0 ), p( pr ), n( nx ), doc( d ), align( -1 ), numSubParag( -1 ),
03074       tm( -1 ), bm( -1 ), lm( -1 ), rm( -1 ), flm( -1 ), tc( 0 ),
03075       numCustomItems( 0 ), pFormatter( 0 ),
03076       tArray( 0 ), tabStopWidth( 0 ), eData( 0 ), pntr( 0 )
03077 {
03078     visible = TRUE;
03079     list_val = -1;
03080     newLinesAllowed = FALSE;
03081     lastInFrame = FALSE;
03082     movedDown = FALSE;
03083     defFormat = formatCollection()-&gt;defaultFormat();
03084     <font class="keywordflow">if</font> ( !doc ) {
03085     tabStopWidth = defFormat-&gt;width( <font class="charliteral">'x'</font> ) * 8;
03086     commandHistory = <font class="keyword">new</font> QTextCommandHistory( 100 );
03087     }
03088 <font class="preprocessor">#if defined(PARSER_DEBUG)</font>
03089 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">"new QTextParag"</font> );
03090 <font class="preprocessor">#endif</font>
03091 <font class="preprocessor"></font>    fullWidth = TRUE;
03092 
03093     <font class="keywordflow">if</font> ( p ) {
03094     p-&gt;n = <font class="keyword">this</font>;
03095     <font class="keywordflow">if</font> ( p-&gt;tc )
03096         tc = p-&gt;tc;
03097     }
03098     <font class="keywordflow">if</font> ( n ) {
03099     n-&gt;p = <font class="keyword">this</font>;
03100     <font class="keywordflow">if</font> ( n-&gt;tc )
03101         tc = n-&gt;tc;
03102     }
03103 
03104     <font class="keywordflow">if</font> ( !tc &amp;&amp; d &amp;&amp; d-&gt;tableCell() )
03105     tc = d-&gt;tableCell();
03106 
03107     <font class="keywordflow">if</font> ( !p &amp;&amp; doc )
03108     doc-&gt;setFirstParag( <font class="keyword">this</font> );
03109     <font class="keywordflow">if</font> ( !n &amp;&amp; doc )
03110     doc-&gt;setLastParag( <font class="keyword">this</font> );
03111 
03112     changed = FALSE;
03113     firstFormat = TRUE;
03114     state = -1;
03115     needPreProcess = FALSE;
03116 
03117     <font class="keywordflow">if</font> ( p )
03118     id = p-&gt;id + 1;
03119     <font class="keywordflow">else</font>
03120     id = 0;
03121     <font class="keywordflow">if</font> ( n &amp;&amp; updateIds ) {
03122     QTextParag *s = n;
03123     <font class="keywordflow">while</font> ( s ) {
03124         s-&gt;id = s-&gt;p-&gt;id + 1;
03125         s-&gt;numSubParag = -1;
03126         s-&gt;lm = s-&gt;rm = s-&gt;tm = s-&gt;bm = -1, s-&gt;flm = -1;
03127         s = s-&gt;n;
03128     }
03129     }
03130     firstPProcess = TRUE;
03131 
03132     str = <font class="keyword">new</font> QTextString();
03133     str-&gt;insert( 0, <font class="stringliteral">" "</font>, formatCollection()-&gt;defaultFormat() );
03134 }
03135 
03136 QTextParag::~QTextParag()
03137 {
03138     <font class="comment">//qDebug("QTextParag::~QTextParag %p id=%d",this,paragId());</font>
03139     <font class="keyword">delete</font> str;
03140     <font class="keywordflow">if</font> ( doc &amp;&amp; p == doc-&gt;minwParag ) {
03141     doc-&gt;minwParag = 0;
03142     doc-&gt;minw = 0;
03143     }
03144     <font class="keywordflow">if</font> ( !doc ) {
03145     <font class="keyword">delete</font> pFormatter;
03146     <font class="keyword">delete</font> commandHistory;
03147     }
03148     <font class="keywordflow">if</font> ( tArray )
03149     <font class="keyword">delete</font> [] tArray;
03150     <font class="keyword">delete</font> eData;
03151     QMap&lt;int, QTextParagLineStart*&gt;::Iterator it = lineStarts.begin();
03152     <font class="keywordflow">for</font> ( ; it != lineStarts.end(); ++it )
03153     <font class="keyword">delete</font> *it;
03154 }
03155 
03156 <font class="keywordtype">void</font> QTextParag::setNext( QTextParag *s )
03157 {
03158     n = s;
03159     <font class="keywordflow">if</font> ( !n &amp;&amp; doc )
03160     doc-&gt;setLastParag( <font class="keyword">this</font> );
03161 }
03162 
03163 <font class="keywordtype">void</font> QTextParag::setPrev( QTextParag *s )
03164 {
03165     p = s;
03166     <font class="keywordflow">if</font> ( !p &amp;&amp; doc )
03167     doc-&gt;setFirstParag( <font class="keyword">this</font> );
03168 }
03169 
03170 <font class="keywordtype">void</font> QTextParag::invalidate( <font class="keywordtype">int</font> chr )
03171 {
03172     <font class="keywordflow">if</font> ( invalid &lt; 0 )
03173     invalid = chr;
03174     <font class="keywordflow">else</font>
03175     invalid = QMIN( invalid, chr );
03176     <font class="keywordflow">for</font> ( QTextCustomItem *i = floatingItems.first(); i; i = floatingItems.next() )
03177     i-&gt;move( 0, -1 );
03178     lm = rm = bm = tm = flm = -1;
03179 }
03180 
03181 <font class="keywordtype">void</font> QTextParag::insert( <font class="keywordtype">int</font> index, <font class="keyword">const</font> QString &amp;s )
03182 {
03183     <font class="keywordflow">if</font> ( doc &amp;&amp; !doc-&gt;useFormatCollection() &amp;&amp; doc-&gt;preProcessor() )
03184     str-&gt;insert( index, s,
03185              doc-&gt;preProcessor()-&gt;format( QTextPreProcessor::Standard ) );
03186     <font class="keywordflow">else</font>
03187     str-&gt;insert( index, s, formatCollection()-&gt;defaultFormat() );
03188     invalidate( index );
03189     needPreProcess = TRUE;
03190 }
03191 
03192 <font class="keywordtype">void</font> QTextParag::truncate( <font class="keywordtype">int</font> index )
03193 {
03194     str-&gt;truncate( index );
03195     insert( length(), <font class="stringliteral">" "</font> );
03196     needPreProcess = TRUE;
03197 }
03198 
03199 <font class="keywordtype">void</font> QTextParag::remove( <font class="keywordtype">int</font> index, <font class="keywordtype">int</font> len )
03200 {
03201     <font class="keywordflow">if</font> ( index + len - str-&gt;length() &gt; 0 )
03202     <font class="keywordflow">return</font>;
03203     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = index; i &lt; len; ++i ) {
03204     QTextStringChar *c = at( i );
03205     <font class="keywordflow">if</font> ( doc &amp;&amp; c-&gt;isCustom() ) {
03206         doc-&gt;unregisterCustomItem( c-&gt;customItem(), <font class="keyword">this</font> );
03207         removeCustomItem();
03208     }
03209     }
03210     str-&gt;remove( index, len );
03211     invalidate( 0 );
03212     needPreProcess = TRUE;
03213 }
03214 
03215 <font class="keywordtype">void</font> QTextParag::join( QTextParag *s )
03216 {
03217     <font class="comment">//qDebug("QTextParag::join this=%d (length %d) with %d (length %d)",paragId(),length(),s-&gt;paragId(),s-&gt;length());</font>
03218     <font class="keywordtype">int</font> oh = r.height() + s-&gt;r.height();
03219     n = s-&gt;n;
03220     <font class="keywordflow">if</font> ( n )
03221     n-&gt;p = <font class="keyword">this</font>;
03222     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( doc )
03223     doc-&gt;setLastParag( <font class="keyword">this</font> );
03224 
03225     <font class="keywordtype">int</font> start = str-&gt;length();
03226     <font class="keywordflow">if</font> ( length() &gt; 0 &amp;&amp; at( length() - 1 )-&gt;c == <font class="charliteral">' '</font> ) {
03227     remove( length() - 1, 1 );
03228     --start;
03229     }
03230     append( s-&gt;str-&gt;toString(), TRUE );
03231 
03232     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; s-&gt;length(); ++i ) {
03233     <font class="keywordflow">if</font> ( !doc || doc-&gt;useFormatCollection() ) {
03234         s-&gt;str-&gt;at( i ).format()-&gt;addRef();
03235         str-&gt;setFormat( i + start, s-&gt;str-&gt;at( i ).format(), TRUE );
03236     }
03237     <font class="keywordflow">if</font> ( s-&gt;str-&gt;at( i ).isCustom() ) {
03238         QTextCustomItem * item = s-&gt;str-&gt;at( i ).customItem();
03239         str-&gt;at( i + start ).setCustomItem( item );
03240         s-&gt;str-&gt;at( i ).loseCustomItem();
03241         doc-&gt;unregisterCustomItem( item, s );
03242         doc-&gt;registerCustomItem( item, <font class="keyword">this</font> );
03243     }
03244     }
03245     ASSERT(str-&gt;at(str-&gt;length()-1).c == <font class="charliteral">' '</font>);
03246 
03247     <font class="keywordflow">if</font> ( !extraData() &amp;&amp; s-&gt;extraData() ) {
03248     setExtraData( s-&gt;extraData() );
03249     s-&gt;setExtraData( 0 );
03250     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( extraData() &amp;&amp; s-&gt;extraData() ) {
03251     extraData()-&gt;join( s-&gt;extraData() );
03252     }
03253     <font class="keyword">delete</font> s;
03254     invalidate( 0 );
03255     r.setHeight( oh );
03256     needPreProcess = TRUE;
03257     <font class="keywordflow">if</font> ( n ) {
03258     QTextParag *s = n;
03259     <font class="keywordflow">while</font> ( s ) {
03260         s-&gt;id = s-&gt;p-&gt;id + 1;
03261         s-&gt;state = -1;
03262         s-&gt;needPreProcess = TRUE;
03263         s-&gt;changed = TRUE;
03264         s = s-&gt;n;
03265     }
03266     }
03267     format();
03268     state = -1;
03269 }
03270 
03271 <font class="keywordtype">void</font> QTextParag::move( <font class="keywordtype">int</font> &amp;dy )
03272 {
03273     <font class="comment">//qDebug("QTextParag::move paragId=%d dy=%d",paragId(),dy);</font>
03274     <font class="keywordflow">if</font> ( dy == 0 )
03275     <font class="keywordflow">return</font>;
03276     changed = TRUE;
03277     r.moveBy( 0, dy );
03278     <font class="keywordflow">for</font> ( QTextCustomItem *i = floatingItems.first(); i; i = floatingItems.next() )
03279     i-&gt;move( i-&gt;x(), i-&gt;y() + dy );
03280     <font class="keywordflow">if</font> ( p )
03281     p-&gt;lastInFrame = FALSE;
03282     movedDown = FALSE;
03283     <font class="keywordflow">if</font> ( doc &amp;&amp; doc-&gt;verticalBreak() ) {
03284     <font class="keyword">const</font> <font class="keywordtype">int</font> oy = r.y();
03285     <font class="keywordtype">int</font> y = oy;
03286     doc-&gt;flow()-&gt;adjustFlow( y, r.width(), r.height(), <font class="keyword">this</font>, TRUE );
03287     <font class="keywordflow">if</font> ( oy != y ) {
03288         <font class="keywordflow">if</font> ( p ) {
03289         p-&gt;lastInFrame = TRUE;
03290         p-&gt;setChanged( TRUE );
03291         }
03292         movedDown = TRUE;
03293         <font class="keywordtype">int</font> oh = r.height();
03294         r.setY( y );
03295         r.setHeight( oh );
03296         dy += y - oy;
03297             <font class="comment">//qDebug("QTextParag::move done. paragId=%d dy=%d lastInFrame=true",paragId(),dy);</font>
03298     }
03299     }
03300 }
03301 
03302 <font class="keywordtype">void</font> QTextParag::format( <font class="keywordtype">int</font> start, <font class="keywordtype">bool</font> doMove )
03303 {
03304     <font class="keywordflow">if</font> ( str-&gt;length() == 0 || !formatter() )
03305     <font class="keywordflow">return</font>;
03306 
03307     <font class="keywordflow">if</font> ( doc &amp;&amp;
03308      doc-&gt;preProcessor() &amp;&amp;
03309      ( needPreProcess || state == -1 ) )
03310     doc-&gt;preProcessor()-&gt;process( doc, <font class="keyword">this</font>, invalid &lt;= 0 ? 0 : invalid );
03311     needPreProcess = FALSE;
03312 
03313     <font class="keywordflow">if</font> ( invalid == -1 )
03314     <font class="keywordflow">return</font>;
03315 
03316     <font class="comment">//qDebug("QTextParag::format id=%d invalid, formatting (moving after previous parag)",paragId());</font>
03317     r.moveTopLeft( QPoint( documentX(), p ? p-&gt;r.y() + p-&gt;r.height() : documentY() ) );
03318     r.setWidth( documentWidth() );
03319     <font class="keywordflow">if</font> ( p )
03320     p-&gt;lastInFrame = FALSE;
03321     movedDown = FALSE;
03322  formatAgain:
03323     <font class="keywordflow">if</font> ( doc ) {
03324     <font class="keywordflow">for</font> ( QTextCustomItem *i = floatingItems.first(); i; i = floatingItems.next() ) {
03325         <font class="keywordflow">if</font> ( i-&gt;placement() == QTextCustomItem::PlaceRight )
03326                 i-&gt;move( r.x() + r.width() - i-&gt;width, r.y() );
03327             <font class="keywordflow">else</font>
03328         i-&gt;move( 0, r.y() );
03329         doc-&gt;flow()-&gt;updateHeight( i );
03330     }
03331     }
03332     QMap&lt;int, QTextParagLineStart*&gt; oldLineStarts = lineStarts;
03333     lineStarts.clear();
03334     <font class="keywordtype">int</font> y = formatter()-&gt;format( doc, <font class="keyword">this</font>, start, oldLineStarts );
03335     r.setWidth( QMAX( r.width(), minimumWidth() ) );
03336     QMap&lt;int, QTextParagLineStart*&gt;::Iterator it = oldLineStarts.begin();
03337     <font class="keywordflow">for</font> ( ; it != oldLineStarts.end(); ++it )
03338     <font class="keyword">delete</font> *it;
03339 
03340     QTextStringChar *c = 0;
03341     <font class="keywordflow">if</font> ( lineStarts.count() == 1 &amp;&amp; ( !doc || doc-&gt;flow()-&gt;isEmpty() ) &amp;&amp; !string()-&gt;isBidi() ) {
03342     c = &amp;str-&gt;at( str-&gt;length() - 1 );
03343     r.setWidth( c-&gt;x + str-&gt;width( str-&gt;length() - 1 ) );
03344     }
03345 
03346     <font class="keywordflow">if</font> ( newLinesAllowed ) {
03347     it = lineStarts.begin();
03348     <font class="keywordtype">int</font> usedw = 0;
03349     <font class="keywordflow">for</font> ( ; it != lineStarts.end(); ++it )
03350         usedw = QMAX( usedw, (*it)-&gt;w );
03351     r.setWidth( QMIN( usedw, r.width() ) );
03352     }
03353 
03354     <font class="keywordflow">if</font> ( y != r.height() )
03355     r.setHeight( y );
03356 
03357     <font class="keywordflow">if</font> ( !visible )
03358     r.setHeight( 0 );
03359 
03360     <font class="keywordflow">if</font> ( doc &amp;&amp; doc-&gt;verticalBreak() ) {
03361     <font class="keyword">const</font> <font class="keywordtype">int</font> oy = r.y();
03362     <font class="keywordtype">int</font> y = oy;
03363     doc-&gt;flow()-&gt;adjustFlow( y, r.width(), r.height(), <font class="keyword">this</font>, TRUE );
03364     <font class="keywordflow">if</font> ( oy != y ) {
03365         <font class="keywordflow">if</font> ( p ) {
03366         p-&gt;lastInFrame = TRUE;
03367         p-&gt;setChanged( TRUE );
03368         }
03369         movedDown = TRUE;
03370         <font class="keywordtype">int</font> oh = r.height();
03371         r.setY( y );
03372         r.setHeight( oh );
03373         <font class="keywordflow">goto</font> formatAgain;
03374     }
03375 
03376     }
03377 
03378     <font class="keywordflow">if</font> ( n &amp;&amp; doMove &amp;&amp; n-&gt;invalid == -1 &amp;&amp; r.y() + r.height() != n-&gt;r.y() ) {
03379     <font class="keywordtype">int</font> dy = ( r.y() + r.height() ) - n-&gt;r.y();
03380     QTextParag *s = n;
03381         <font class="keywordtype">bool</font> makeInvalid = p &amp;&amp; p-&gt;lastInFrame;
03382         <font class="comment">//qDebug("moving. previous's lastInFrame (=makeInvalid): %d",makeInvalid);</font>
03383     <font class="keywordflow">while</font> ( s &amp;&amp; dy ) {
03384         <font class="keywordflow">if</font> ( !s-&gt;isFullWidth() || s-&gt;movedDown )
03385         makeInvalid = TRUE;
03386         <font class="keywordflow">if</font> ( makeInvalid )
03387         s-&gt;invalidate( 0 );
03388         s-&gt;move( dy );
03389         <font class="keywordflow">if</font> ( s-&gt;lastInFrame )
03390         makeInvalid = TRUE;
03391         s = s-&gt;n;
03392     }
03393     }
03394 
03395     firstFormat = FALSE;
03396     changed = TRUE;
03397     invalid = -1;
03398     string()-&gt;setTextChanged( FALSE );
03399 }
03400 
03401 <font class="keywordtype">int</font> QTextParag::lineHeightOfChar( <font class="keywordtype">int</font> i, <font class="keywordtype">int</font> *bl, <font class="keywordtype">int</font> *y )<font class="keyword"> const</font>
03402 <font class="keyword"></font>{
03403     <font class="keywordflow">if</font> ( !isValid() )
03404     ( (QTextParag*)<font class="keyword">this</font> )-&gt;format();
03405 
03406     QMap&lt;int, QTextParagLineStart*&gt;::ConstIterator it = lineStarts.end();
03407     --it;
03408     <font class="keywordflow">for</font> ( ;; ) {
03409     <font class="keywordflow">if</font> ( i &gt;= it.key() ) {
03410         <font class="keywordflow">if</font> ( bl )
03411         *bl = ( *it )-&gt;baseLine;
03412         <font class="keywordflow">if</font> ( y )
03413         *y = ( *it )-&gt;y;
03414         <font class="keywordflow">return</font> ( *it )-&gt;h;
03415     }
03416     <font class="keywordflow">if</font> ( it == lineStarts.begin() )
03417         <font class="keywordflow">break</font>;
03418     --it;
03419     }
03420 
03421     qWarning( <font class="stringliteral">"QTextParag::lineHeightOfChar: couldn't find lh for %d"</font>, i );
03422     <font class="keywordflow">return</font> 15;
03423 }
03424 
03425 QTextStringChar *QTextParag::lineStartOfChar( <font class="keywordtype">int</font> i, <font class="keywordtype">int</font> *index, <font class="keywordtype">int</font> *line )<font class="keyword"> const</font>
03426 <font class="keyword"></font>{
03427     <font class="keywordflow">if</font> ( !isValid() )
03428     ( (QTextParag*)<font class="keyword">this</font> )-&gt;format();
03429 
03430     <font class="keywordtype">int</font> l = lineStarts.count() - 1;
03431     QMap&lt;int, QTextParagLineStart*&gt;::ConstIterator it = lineStarts.end();
03432     --it;
03433     <font class="keywordflow">for</font> ( ;; ) {
03434     <font class="keywordflow">if</font> ( i &gt;= it.key() ) {
03435         <font class="keywordflow">if</font> ( index )
03436         *index = it.key();
03437         <font class="keywordflow">if</font> ( line )
03438         *line = l;
03439         <font class="keywordflow">return</font> &amp;str-&gt;at( it.key() );
03440     }
03441     <font class="keywordflow">if</font> ( it == lineStarts.begin() )
03442         <font class="keywordflow">break</font>;
03443     --it;
03444     --l;
03445     }
03446 
03447     qWarning( <font class="stringliteral">"QTextParag::lineStartOfChar: couldn't find %d"</font>, i );
03448     <font class="keywordflow">return</font> 0;
03449 }
03450 
03451 <font class="keywordtype">int</font> QTextParag::lines()<font class="keyword"> const</font>
03452 <font class="keyword"></font>{
03453     <font class="keywordflow">if</font> ( !isValid() )
03454     ( (QTextParag*)<font class="keyword">this</font> )-&gt;format();
03455 
03456     <font class="keywordflow">return</font> lineStarts.count();
03457 }
03458 
03459 QTextStringChar *QTextParag::lineStartOfLine( <font class="keywordtype">int</font> line, <font class="keywordtype">int</font> *index )<font class="keyword"> const</font>
03460 <font class="keyword"></font>{
03461     <font class="keywordflow">if</font> ( !isValid() )
03462     ( (QTextParag*)<font class="keyword">this</font> )-&gt;format();
03463 
03464     <font class="keywordflow">if</font> ( line &gt;= 0 &amp;&amp; line &lt; (int)lineStarts.count() ) {
03465     QMap&lt;int, QTextParagLineStart*&gt;::ConstIterator it = lineStarts.begin();
03466     <font class="keywordflow">while</font> ( line-- &gt; 0 )
03467         ++it;
03468     <font class="keywordtype">int</font> i = it.key();
03469     <font class="keywordflow">if</font> ( index )
03470         *index = i;
03471     <font class="keywordflow">return</font> &amp;str-&gt;at( i );
03472     }
03473 
03474     qWarning( <font class="stringliteral">"QTextParag::lineStartOfLine: couldn't find %d"</font>, line );
03475     <font class="keywordflow">return</font> 0;
03476 }
03477 
03478 <font class="keywordtype">void</font> QTextParag::setFormat( <font class="keywordtype">int</font> index, <font class="keywordtype">int</font> len, QTextFormat *f, <font class="keywordtype">bool</font> useCollection, <font class="keywordtype">int</font> flags )
03479 {
03480     <font class="keywordflow">if</font> ( index &lt; 0 )
03481     index = 0;
03482     <font class="keywordflow">if</font> ( index &gt; str-&gt;length() - 1 )
03483     index = str-&gt;length() - 1;
03484     <font class="keywordflow">if</font> ( index + len &gt;= str-&gt;length() )
03485     len = str-&gt;length() - index;
03486 
03487     QTextFormatCollection *fc = 0;
03488     <font class="keywordflow">if</font> ( useCollection )
03489     fc = formatCollection();
03490     QTextFormat *of;
03491     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; len; ++i ) {
03492     of = str-&gt;at( i + index ).format();
03493     <font class="keywordflow">if</font> ( !changed &amp;&amp; f-&gt;key() != of-&gt;key() )
03494         changed = TRUE;
03495     <font class="keywordflow">if</font> ( invalid == -1 &amp;&amp;
03496          ( f-&gt;font().family() != of-&gt;font().family() ||
03497            f-&gt;font().pointSize() != of-&gt;font().pointSize() ||
03498            f-&gt;font().weight() != of-&gt;font().weight() ||
03499            f-&gt;font().italic() != of-&gt;font().italic() ||
03500            f-&gt;vAlign() != of-&gt;vAlign() ) ) {
03501         invalidate( 0 );
03502     }
03503     <font class="keywordflow">if</font> ( flags == -1 || flags == QTextFormat::Format || !fc ) {
03504 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
03505 <font class="preprocessor"></font>        qDebug(<font class="stringliteral">" QTextParag::setFormat, will use format(f) %p %s"</font>, f, f-&gt;key().latin1());
03506 <font class="preprocessor">#endif</font>
03507 <font class="preprocessor"></font>        <font class="keywordflow">if</font> ( fc )
03508         f = fc-&gt;format( f );
03509         str-&gt;setFormat( i + index, f, useCollection );
03510     } <font class="keywordflow">else</font> {
03511 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
03512 <font class="preprocessor"></font>        qDebug(<font class="stringliteral">" QTextParag::setFormat, will use format(of,f,flags) of=%p %s, f=%p %s"</font>, of, of-&gt;key().latin1(), f, f-&gt;key().latin1() );
03513 <font class="preprocessor">#endif</font>
03514 <font class="preprocessor"></font>        QTextFormat *fm = fc-&gt;format( of, f, flags );
03515 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
03516 <font class="preprocessor"></font>        qDebug(<font class="stringliteral">" QTextParag::setFormat, format(of,f,flags) returned %p %s "</font>, fm,fm-&gt;key().latin1());
03517 <font class="preprocessor">#endif</font>
03518 <font class="preprocessor"></font>        str-&gt;setFormat( i + index, fm, useCollection );
03519     }
03520     }
03521 }
03522 
03523 <font class="keywordtype">void</font> QTextParag::indent( <font class="keywordtype">int</font> *oldIndent, <font class="keywordtype">int</font> *newIndent )
03524 {
03525     <font class="keywordflow">if</font> ( !doc || !doc-&gt;indent() || style() &amp;&amp; style()-&gt;displayMode() != QStyleSheetItem::DisplayBlock ) {
03526     <font class="keywordflow">if</font> ( oldIndent )
03527         *oldIndent = 0;
03528     <font class="keywordflow">if</font> ( newIndent )
03529         *newIndent = 0;
03530     <font class="keywordflow">if</font> ( oldIndent &amp;&amp; newIndent )
03531         *newIndent = *oldIndent;
03532     <font class="keywordflow">return</font>;
03533     }
03534     doc-&gt;indent()-&gt;indent( doc, <font class="keyword">this</font>, oldIndent, newIndent );
03535 }
03536 
03537 <font class="keywordtype">void</font> QTextParag::paint( QPainter &amp;painter, <font class="keyword">const</font> QColorGroup &amp;cg, QTextCursor *cursor, <font class="keywordtype">bool</font> drawSelections,
03538             <font class="keywordtype">int</font> clipx, <font class="keywordtype">int</font> clipy, <font class="keywordtype">int</font> clipw, <font class="keywordtype">int</font> cliph )
03539 {
03540     <font class="keywordflow">if</font> ( !visible )
03541     <font class="keywordflow">return</font>;
03542     QTextStringChar *chr = at( 0 );
03543     ASSERT( chr );
03544     <font class="keywordflow">if</font> (!chr) { qDebug(<font class="stringliteral">"paragraph %p %d, can't paint, EMPTY !"</font>, <font class="keyword">this</font>, paragId()); <font class="keywordflow">return</font>; }
03545     <font class="keywordtype">int</font> i = 0;
03546     <font class="keywordtype">int</font> h = 0;
03547     <font class="keywordtype">int</font> baseLine = 0, lastBaseLine = 0;
03548     QTextFormat *lastFormat = 0;
03549     <font class="keywordtype">int</font> lastY = -1;
03550     <font class="keywordtype">int</font> startX = 0;
03551     <font class="keywordtype">int</font> bw = 0;
03552     <font class="keywordtype">int</font> cy = 0;
03553     <font class="keywordtype">int</font> curx = -1, cury = 0, curh = 0, curline = 0;
03554     <font class="keywordtype">bool</font> lastDirection = chr-&gt;rightToLeft;
03555     QTextStringChar::Type lastType = chr-&gt;type;
03556     <font class="keywordtype">int</font> tw = 0;
03557 
03558     QString qstr = str-&gt;toString();
03559 
03560     <font class="keyword">const</font> <font class="keywordtype">int</font> nSels = doc ? doc-&gt;numSelections() : 1;
03561     QMemArray&lt;int&gt; selectionStarts( nSels );
03562     QMemArray&lt;int&gt; selectionEnds( nSels );
03563     <font class="keywordflow">if</font> ( drawSelections ) {
03564     <font class="keywordtype">bool</font> hasASelection = FALSE;
03565     <font class="keywordflow">for</font> ( i = 0; i &lt; nSels; ++i ) {
03566         <font class="keywordflow">if</font> ( !hasSelection( i ) ) {
03567         selectionStarts[ i ] = -1;
03568         selectionEnds[ i ] = -1;
03569         } <font class="keywordflow">else</font> {
03570         hasASelection = TRUE;
03571         selectionStarts[ i ] = selectionStart( i );
03572         <font class="keywordtype">int</font> end = selectionEnd( i );
03573         <font class="keywordflow">if</font> ( end == length() - 1 &amp;&amp; n &amp;&amp; n-&gt;hasSelection( i ) )
03574             end++;
03575         selectionEnds[ i ] = end;
03576         }
03577     }
03578     <font class="keywordflow">if</font> ( !hasASelection )
03579         drawSelections = FALSE;
03580     }
03581 
03582     <font class="keywordtype">int</font> line = -1;
03583     <font class="keywordtype">int</font> cw;
03584     <font class="keywordtype">bool</font> didListLabel = FALSE;
03585     <font class="keywordtype">int</font> paintStart = 0;
03586     <font class="keywordtype">int</font> paintEnd = -1;
03587     <font class="keywordtype">int</font> lasth = 0;
03588     <font class="keywordflow">for</font> ( i = 0; i &lt; length(); i++ ) {
03589     chr = at( i );
03590     <font class="keywordflow">if</font> ( !str-&gt;isBidi() &amp;&amp; is_printer( &amp;painter ) ) { <font class="comment">// ### fix our broken ps-printer</font>
03591         <font class="keywordflow">if</font> ( !chr-&gt;lineStart )
03592         chr-&gt;x = QMAX( chr-&gt;x, tw );
03593         <font class="keywordflow">else</font>
03594         tw = 0;
03595     }
03596     cw = string()-&gt;width( i );
03597     <font class="keywordflow">if</font> ( chr-&gt;c == <font class="charliteral">'\t'</font> &amp;&amp; i &lt; length() - 1 )
03598         cw = at( i + 1 )-&gt;x - chr-&gt;x + 1;
03599     <font class="keywordflow">if</font> ( chr-&gt;c.unicode() == 0xad &amp;&amp; i &lt; length() - 1 )
03600         cw = 0;
03601 
03602     <font class="comment">// init a new line</font>
03603     <font class="keywordflow">if</font> ( chr-&gt;lineStart ) {
03604         tw = 0;
03605         ++line;
03606         lineInfo( line, cy, h, baseLine );
03607         lasth = h;
03608         <font class="keywordflow">if</font> ( clipy != -1 &amp;&amp; cy &gt; clipy - r.y() + cliph ) <font class="comment">// outside clip area, leave</font>
03609         <font class="keywordflow">break</font>;
03610         <font class="keywordflow">if</font> ( lastBaseLine == 0 )
03611         lastBaseLine = baseLine;
03612     }
03613 
03614     <font class="comment">// draw bullet list items</font>
03615     <font class="keywordflow">if</font> ( !didListLabel &amp;&amp; line == 0 &amp;&amp; style() &amp;&amp; style()-&gt;displayMode() == QStyleSheetItem::DisplayListItem ) {
03616         didListLabel = TRUE;
03617         drawLabel( &amp;painter, chr-&gt;x, cy, 0, 0, baseLine, cg );
03618     }
03619 
03620     <font class="comment">// check for cursor mark</font>
03621     <font class="keywordflow">if</font> ( cursor &amp;&amp; <font class="keyword">this</font> == cursor-&gt;parag() &amp;&amp; i == cursor-&gt;index() ) {
03622         curx = chr-&gt;x;
03623         <font class="keywordflow">if</font> ( chr-&gt;rightToLeft )
03624         curx += cw;
03625         curh = h;
03626         cury = cy;
03627             curline = line;
03628     }
03629 
03630     <font class="comment">// first time - start again...</font>
03631     <font class="keywordflow">if</font> ( !lastFormat || lastY == -1 ) {
03632         lastFormat = chr-&gt;format();
03633         lastY = cy;
03634         startX = chr-&gt;x;
03635         <font class="keywordflow">if</font> ( !chr-&gt;isCustom() &amp;&amp; chr-&gt;c != <font class="charliteral">'\n'</font> )
03636         paintEnd = i;
03637         bw = cw;
03638         <font class="keywordflow">if</font> ( !chr-&gt;isCustom() )
03639         <font class="keywordflow">continue</font>;
03640     }
03641 
03642     <font class="comment">// check if selection state changed</font>
03643     <font class="keywordtype">bool</font> selectionChange = FALSE;
03644     <font class="keywordflow">if</font> ( drawSelections ) {
03645         <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> j = 0; j &lt; nSels; ++j ) {
03646         selectionChange = selectionStarts[ j ] == i || selectionEnds[ j ] == i;
03647         <font class="keywordflow">if</font> ( selectionChange )
03648             <font class="keywordflow">break</font>;
03649         }
03650     }
03651 
03652     <font class="comment">//if something (format, etc.) changed, draw what we have so far</font>
03653     <font class="keywordflow">if</font> ( ( ( ( alignment() &amp; Qt3::AlignJustify ) == Qt3::AlignJustify &amp;&amp; at(paintEnd)-&gt;c.isSpace() ) ||
03654            lastDirection != (bool)chr-&gt;rightToLeft ||
03655            chr-&gt;startOfRun ||
03656            lastY != cy || chr-&gt;format() != lastFormat ||
03657            ( paintEnd != -1 &amp;&amp; at( paintEnd )-&gt;c ==<font class="charliteral">'\t'</font> ) || chr-&gt;c == <font class="charliteral">'\t'</font> ||
03658            ( paintEnd != -1 &amp;&amp; at( paintEnd )-&gt;c.unicode() == 0xad ) || chr-&gt;c.unicode() == 0xad ||
03659            selectionChange || chr-&gt;isCustom() ) ) {
03660         <font class="keywordflow">if</font> ( paintStart &lt;= paintEnd ) {
03661         <font class="comment">// ### temporary hack until I get the new placement/shaping stuff working</font>
03662         <font class="keywordtype">int</font> x = startX;
03663         <font class="keywordflow">if</font> ( lastType == QTextStringChar::Mark &amp;&amp; i &gt; 0 ) {
03664             <font class="keywordflow">if</font> ( !lastDirection )
03665             x += str-&gt;at(i - 1).d.mark-&gt;xoff;
03666             <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( i &gt; 1 )
03667             x -= str-&gt;at(i - 1).d.mark-&gt;xoff + str-&gt;width( i - 2 );
03668         }
03669         drawParagString( painter, qstr, paintStart, paintEnd - paintStart + 1, x, lastY,
03670                  lastBaseLine, bw, lasth, drawSelections,
03671                  lastFormat, i, selectionStarts, selectionEnds, cg, lastDirection );
03672         }
03673         <font class="keywordflow">if</font> ( !str-&gt;isBidi() &amp;&amp; is_printer( &amp;painter ) ) { <font class="comment">// ### fix our broken ps-printer</font>
03674         <font class="keywordflow">if</font> ( !chr-&gt;lineStart ) {
03675             <font class="comment">// ### the next line doesn't look 100% correct for arabic</font>
03676             tw = startX + painter.fontMetrics().width( qstr.mid(paintStart, paintEnd - paintStart +1) );
03677             chr-&gt;x = QMAX( chr-&gt;x, tw );
03678         } <font class="keywordflow">else</font> {
03679             tw = 0;
03680         }
03681         }
03682         <font class="keywordflow">if</font> ( !chr-&gt;isCustom() ) {
03683         <font class="keywordflow">if</font> ( chr-&gt;c != <font class="charliteral">'\n'</font> ) {
03684             paintStart = i;
03685             paintEnd = i;
03686         } <font class="keywordflow">else</font> {
03687             paintStart = i+1;
03688             paintEnd = -1;
03689         }
03690         lastFormat = chr-&gt;format();
03691         lastY = cy;
03692         startX = chr-&gt;x;
03693         bw = cw;
03694         } <font class="keywordflow">else</font> {
03695         <font class="keywordflow">if</font> ( chr-&gt;customItem()-&gt;placement() == QTextCustomItem::PlaceInline ) {
03696             chr-&gt;customItem()-&gt;draw( &amp;painter, chr-&gt;x, cy, clipx - r.x(), clipy - r.y(), clipw, cliph, cg,
03697                          nSels &amp;&amp; selectionStarts[ 0 ] &lt;= i &amp;&amp; selectionEnds[ 0 ] &gt;= i );
03698             paintStart = i+1;
03699             paintEnd = -1;
03700             lastFormat = chr-&gt;format();
03701             lastY = cy;
03702             startX = chr-&gt;x + string()-&gt;width( i );
03703             bw = 0;
03704         } <font class="keywordflow">else</font> {
03705             chr-&gt;customItem()-&gt;resize( pntr, chr-&gt;customItem()-&gt;width );
03706             paintStart = i+1;
03707             paintEnd = -1;
03708             lastFormat = chr-&gt;format();
03709             lastY = cy;
03710             startX = chr-&gt;x + string()-&gt;width( i );
03711             bw = 0;
03712         }
03713         }
03714     } <font class="keywordflow">else</font> {
03715         <font class="keywordflow">if</font> ( chr-&gt;c != <font class="charliteral">'\n'</font> ) {
03716         <font class="keywordflow">if</font>( chr-&gt;rightToLeft ) {
03717             startX = chr-&gt;x;
03718         }
03719         paintEnd = i;
03720         }
03721         bw += cw;
03722     }
03723     lastBaseLine = baseLine;
03724     lasth = h;
03725     lastDirection = chr-&gt;rightToLeft;
03726     lastType = chr-&gt;type;
03727     }
03728 
03729     <font class="comment">// if we are through the parag, but still have some stuff left to draw, draw it now</font>
03730     <font class="keywordflow">if</font> ( paintStart &lt;= paintEnd ) {
03731     <font class="keywordtype">bool</font> selectionChange = FALSE;
03732     <font class="keywordflow">if</font> ( drawSelections ) {
03733         <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> j = 0; j &lt; nSels; ++j ) {
03734         selectionChange = selectionStarts[ j ] == i || selectionEnds[ j ] == i;
03735         <font class="keywordflow">if</font> ( selectionChange )
03736             <font class="keywordflow">break</font>;
03737         }
03738     }
03739     <font class="comment">// ### temporary hack until I get the new placement/shaping stuff working</font>
03740     <font class="keywordtype">int</font> x = startX;
03741     <font class="keywordflow">if</font> ( lastType == QTextStringChar::Mark &amp;&amp; i &gt; 0 ) {
03742         <font class="keywordflow">if</font> ( !lastDirection )
03743         x += str-&gt;at(i - 1).d.mark-&gt;xoff;
03744         <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( i &gt; 1 )
03745         x -= str-&gt;at(i - 1).d.mark-&gt;xoff + str-&gt;width( i - 2 );
03746     }
03747     drawParagString( painter, qstr, paintStart, paintEnd-paintStart+1, x, lastY,
03748              lastBaseLine, bw, h, drawSelections,
03749              lastFormat, i, selectionStarts, selectionEnds, cg, lastDirection );
03750     }
03751 
03752     <font class="comment">// if we should draw a cursor, draw it now</font>
03753     <font class="keywordflow">if</font> ( curx != -1 &amp;&amp; cursor ) {
03754     painter.fillRect( QRect( curx, cury, 1, curh - lineSpacing( curline ) ), cg.color( QColorGroup::Text ) );
03755     painter.save();
03756     <font class="keywordflow">if</font> ( string()-&gt;isBidi() ) {
03757         <font class="keyword">const</font> <font class="keywordtype">int</font> d = 4;
03758         <font class="keywordflow">if</font> ( at( cursor-&gt;index() )-&gt;rightToLeft ) {
03759         painter.setPen( Qt::black );
03760         painter.drawLine( curx, cury, curx - d / 2, cury + d / 2 );
03761         painter.drawLine( curx, cury + d, curx - d / 2, cury + d / 2 );
03762         } <font class="keywordflow">else</font> {
03763         painter.setPen( Qt::black );
03764         painter.drawLine( curx, cury, curx + d / 2, cury + d / 2 );
03765         painter.drawLine( curx, cury + d, curx + d / 2, cury + d / 2 );
03766         }
03767     }
03768     painter.restore();
03769     }
03770 }
03771 
03772 <font class="keywordtype">void</font> QTextParag::drawParagString( QPainter &amp;painter, <font class="keyword">const</font> QString &amp;s, <font class="keywordtype">int</font> start, <font class="keywordtype">int</font> len, <font class="keywordtype">int</font> startX,
03773                       <font class="keywordtype">int</font> lastY, <font class="keywordtype">int</font> baseLine, <font class="keywordtype">int</font> bw, <font class="keywordtype">int</font> h, <font class="keywordtype">bool</font> drawSelections,
03774                       QTextFormat *lastFormat, <font class="keywordtype">int</font> i, <font class="keyword">const</font> QMemArray&lt;int&gt; &amp;selectionStarts,
03775                       <font class="keyword">const</font> QMemArray&lt;int&gt; &amp;selectionEnds, <font class="keyword">const</font> QColorGroup &amp;cg, <font class="keywordtype">bool</font> <font class="comment">/*rightToLeft*/</font> )
03776 {
03777     <font class="keywordflow">if</font> ( start + len == length() )
03778     len--;
03779     QString str( s );
03780     <font class="keywordflow">if</font> ( str[ (int)str.length() - 1 ].unicode() == 0xad )
03781     str.remove( str.length() - 1, 1 );
03782     painter.setPen( QPen( lastFormat-&gt;color() ) );
03783     painter.setFont( lastFormat-&gt;font() );
03784 
03785     <font class="keywordflow">if</font> ( doc &amp;&amp; lastFormat-&gt;isAnchor() &amp;&amp; !lastFormat-&gt;anchorHref().isEmpty() &amp;&amp; lastFormat-&gt;useLinkColor() ) {
03786     painter.setPen( QPen( Qt::blue <font class="comment">/* cg.link() */</font> ) ); <font class="comment">// QT2HACK</font>
03787     <font class="keywordflow">if</font> ( doc-&gt;underlineLinks() ) {
03788         QFont fn = lastFormat-&gt;font();
03789         fn.setUnderline( TRUE );
03790         painter.setFont( fn );
03791     }
03792     }
03793 
03794     <font class="keywordflow">if</font> ( drawSelections ) {
03795     <font class="keyword">const</font> <font class="keywordtype">int</font> nSels = doc ? doc-&gt;numSelections() : 1;
03796     <font class="keyword">const</font> <font class="keywordtype">int</font> startSel = painter.device()-&gt;devType() != QInternal::Printer ? 0 : 1;
03797     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> j = startSel; j &lt; nSels; ++j ) {
03798         <font class="keywordflow">if</font> ( i &gt; selectionStarts[ j ] &amp;&amp; i &lt;= selectionEnds[ j ] ) {
03799         <font class="keywordflow">if</font> ( !doc || doc-&gt;invertSelectionText( j ) )
03800             painter.setPen( QPen( cg.color( QColorGroup::HighlightedText ) ) );
03801         <font class="keywordflow">if</font> ( j == QTextDocument::Standard )
03802             painter.fillRect( startX, lastY, bw, h, cg.color( QColorGroup::Highlight ) );
03803         <font class="keywordflow">else</font>
03804             painter.fillRect( startX, lastY, bw, h, doc ? doc-&gt;selectionColor( j ) : cg.color( QColorGroup::Highlight ) );
03805         }
03806     }
03807     }
03808     <font class="comment">//QT2HACK</font>
03809     <font class="comment">//QPainter::TextDirection dir = QPainter::LTR;</font>
03810     <font class="comment">//if ( rightToLeft )</font>
03811     <font class="comment">//dir = QPainter::RTL;</font>
03812     <font class="keywordflow">if</font> ( str[start] != <font class="charliteral">'\t'</font> &amp;&amp; str[ start ].unicode() != 0xad ) {
03813     <font class="keywordflow">if</font> ( lastFormat-&gt;vAlign() == QTextFormat::AlignNormal ) {
03814             <font class="comment">//QT2HACK painter.drawText( startX, lastY + baseLine, str, start, len, dir );</font>
03815             painter.drawText( startX, lastY + baseLine, str.mid(start), len );
03816     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( lastFormat-&gt;vAlign() == QTextFormat::AlignSuperScript ) {
03817         QFont f( painter.font() );
03818         f.setPointSize( ( f.pointSize() * 2 ) / 3 );
03819         painter.setFont( f );
03820         <font class="comment">//QT2HACK painter.drawText( startX, lastY + baseLine - ( h - painter.fontMetrics().height() ), str, start, len, dir );</font>
03821         painter.drawText( startX, lastY + baseLine - ( h - painter.fontMetrics().height() ), str.mid(start), len );
03822     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( lastFormat-&gt;vAlign() == QTextFormat::AlignSubScript ) {
03823         QFont f( painter.font() );
03824         f.setPointSize( ( f.pointSize() * 2 ) / 3 );
03825         painter.setFont( f );
03826         <font class="comment">//QT2HACK painter.drawText( startX, lastY + baseLine, str, start, len, dir );</font>
03827         painter.drawText( startX, lastY + baseLine, str.mid(start), len );
03828     }
03829     }
03830     <font class="keywordflow">if</font> ( i + 1 &lt; length() &amp;&amp; at( i + 1 )-&gt;lineStart &amp;&amp; at( i )-&gt;c.unicode() == 0xad ) {
03831     painter.drawText( startX + bw, lastY + baseLine, <font class="stringliteral">"\xad"</font> );
03832     }
03833     <font class="keywordflow">if</font> ( lastFormat-&gt;isMisspelled() ) {
03834     painter.save();
03835     painter.setPen( QPen( Qt::red, 1, Qt::DotLine ) );
03836     painter.drawLine( startX, lastY + baseLine + 1, startX + bw, lastY + baseLine + 1 );
03837     painter.restore();
03838     }
03839 
03840     i -= len;
03841     <font class="keywordflow">if</font> ( doc &amp;&amp; lastFormat-&gt;isAnchor() &amp;&amp; !lastFormat-&gt;anchorHref().isEmpty() &amp;&amp;
03842      doc-&gt;focusIndicator.parag == <font class="keyword">this</font> &amp;&amp;
03843      doc-&gt;focusIndicator.start &gt;= i &amp;&amp;
03844      doc-&gt;focusIndicator.start + doc-&gt;focusIndicator.len &lt;= i + len ) {
03845     painter.drawWinFocusRect( QRect( startX, lastY, bw, h ) );
03846     }
03847 
03848 }
03849 
03850 <font class="keywordtype">void</font> QTextParag::drawLabel( QPainter* p, <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y, <font class="keywordtype">int</font> w, <font class="keywordtype">int</font> h, <font class="keywordtype">int</font> base, <font class="keyword">const</font> QColorGroup&amp; cg )
03851 {
03852     <font class="keywordflow">if</font> ( !style() )
03853     <font class="keywordflow">return</font>;
03854     QRect r ( x, y, w, h );
03855     QStyleSheetItem::ListStyle s = listStyle();
03856 
03857     QFont font = p-&gt;font();
03858     p-&gt;setFont( defFormat-&gt;font() );
03859     QFontMetrics fm( p-&gt;fontMetrics() );
03860     <font class="keywordtype">int</font> size = fm.lineSpacing() / 3;
03861 
03862     <font class="keywordflow">switch</font> ( s ) {
03863     <font class="keywordflow">case</font> QStyleSheetItem::ListDecimal:
03864     <font class="keywordflow">case</font> QStyleSheetItem::ListLowerAlpha:
03865     <font class="keywordflow">case</font> QStyleSheetItem::ListUpperAlpha:
03866     {
03867         <font class="keywordtype">int</font> n = numberOfSubParagraph();
03868         QString l;
03869         <font class="keywordflow">switch</font> ( s ) {
03870         <font class="keywordflow">case</font> QStyleSheetItem::ListLowerAlpha:
03871         <font class="keywordflow">if</font> ( n &lt; 27 ) {
03872             l = QChar( (<font class="charliteral">'a'</font> + (<font class="keywordtype">char</font>) (n-1)));
03873             <font class="keywordflow">break</font>;
03874         }
03875         <font class="keywordflow">case</font> QStyleSheetItem::ListUpperAlpha:
03876         <font class="keywordflow">if</font> ( n &lt; 27 ) {
03877             l = QChar( (<font class="charliteral">'A'</font> + (<font class="keywordtype">char</font>) (n-1)));
03878             <font class="keywordflow">break</font>;
03879         }
03880         <font class="keywordflow">break</font>;
03881         <font class="keywordflow">default</font>:  <font class="comment">//QStyleSheetItem::ListDecimal:</font>
03882         l.setNum( n );
03883         <font class="keywordflow">break</font>;
03884         }
03885         l += QString::fromLatin1(<font class="stringliteral">". "</font>);
03886         p-&gt;drawText( r.right() - fm.width( l ), r.top() + base, l );
03887     }
03888     <font class="keywordflow">break</font>;
03889     <font class="keywordflow">case</font> QStyleSheetItem::ListSquare:
03890     {
03891         QRect er( r.right() - size * 2, r.top() + base - fm.boundingRect( <font class="charliteral">'A'</font> ).height() / 2 - size / 2 - 1, size, size );
03892         p-&gt;fillRect( er , cg.brush( QColorGroup::Foreground ) );
03893     }
03894     <font class="keywordflow">break</font>;
03895     <font class="keywordflow">case</font> QStyleSheetItem::ListCircle:
03896     {
03897         QRect er( r.right()-size*2, r.top() + base - fm.boundingRect(<font class="charliteral">'A'</font>).height()/2 - size/2 - 1, size, size);
03898         p-&gt;drawEllipse( er );
03899     }
03900     <font class="keywordflow">break</font>;
03901     <font class="keywordflow">case</font> QStyleSheetItem::ListDisc:
03902     <font class="keywordflow">default</font>:
03903     {
03904         p-&gt;setBrush( cg.brush( QColorGroup::Foreground ));
03905         QRect er( r.right()-size*2, r.top() + base - fm.boundingRect(<font class="charliteral">'A'</font>).height()/2 - size/2 - 1, size, size);
03906         p-&gt;drawEllipse( er );
03907         p-&gt;setBrush( Qt::NoBrush );
03908     }
03909     <font class="keywordflow">break</font>;
03910     }
03911 
03912     p-&gt;setFont( font );
03913 }
03914 
03915 <font class="keywordtype">void</font> QTextParag::setStyleSheetItems( <font class="keyword">const</font> QPtrVector&lt;QStyleSheetItem&gt; &amp;vec )
03916 {
03917     styleSheetItemsVec = vec;
03918     invalidate( 0 );
03919     lm = rm = tm = bm = flm = -1;
03920     numSubParag = -1;
03921 }
03922 
03923 <font class="keywordtype">void</font> QTextParag::setList( <font class="keywordtype">bool</font> b, <font class="keywordtype">int</font> listStyle )
03924 {
03925     <font class="keywordflow">if</font> ( !doc )
03926     <font class="keywordflow">return</font>;
03927 
03928     <font class="keywordflow">if</font> ( !style() ) {
03929     styleSheetItemsVec.resize( 2 );
03930     styleSheetItemsVec.insert( 0, doc-&gt;styleSheet()-&gt;item( <font class="stringliteral">"html"</font> ) );
03931     styleSheetItemsVec.insert( 1, doc-&gt;styleSheet()-&gt;item( <font class="stringliteral">"p"</font> ) );
03932     }
03933 
03934     <font class="keywordflow">if</font> ( b ) {
03935     <font class="keywordflow">if</font> ( style()-&gt;displayMode() != QStyleSheetItem::DisplayListItem || this-&gt;listStyle() != listStyle ) {
03936         styleSheetItemsVec.remove( styleSheetItemsVec.size() - 1 );
03937         <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *item = styleSheetItemsVec[ styleSheetItemsVec.size() - 2 ];
03938         <font class="keywordflow">if</font> ( item )
03939         styleSheetItemsVec.remove( styleSheetItemsVec.size() - 2 );
03940         styleSheetItemsVec.insert( styleSheetItemsVec.size() - 2,
03941                        listStyle == QStyleSheetItem::ListDisc || listStyle == QStyleSheetItem::ListCircle
03942                        || listStyle == QStyleSheetItem::ListSquare ?
03943                        doc-&gt;styleSheet()-&gt;item( <font class="stringliteral">"ul"</font> ) : doc-&gt;styleSheet()-&gt;item( "ol" ) );
03944         styleSheetItemsVec.insert( styleSheetItemsVec.size() - 1, doc-&gt;styleSheet()-&gt;item( <font class="stringliteral">"li"</font> ) );
03945         setListStyle( (QStyleSheetItem::ListStyle)listStyle );
03946     } <font class="keywordflow">else</font> {
03947         <font class="keywordflow">return</font>;
03948     }
03949     } <font class="keywordflow">else</font> {
03950     <font class="keywordflow">if</font> ( style()-&gt;displayMode() != QStyleSheetItem::DisplayBlock ) {
03951         styleSheetItemsVec.remove( styleSheetItemsVec.size() - 1 );
03952         <font class="keywordflow">if</font> ( styleSheetItemsVec.size() &gt;= 2 ) {
03953         styleSheetItemsVec.remove( styleSheetItemsVec.size() - 2 );
03954         styleSheetItemsVec.resize( styleSheetItemsVec.size() - 2 );
03955         } <font class="keywordflow">else</font> {
03956         styleSheetItemsVec.resize( styleSheetItemsVec.size() - 1 );
03957         }
03958     } <font class="keywordflow">else</font> {
03959         <font class="keywordflow">return</font>;
03960     }
03961     }
03962     invalidate( 0 );
03963     lm = rm = tm = bm = flm = -1;
03964     numSubParag = -1;
03965     <font class="keywordflow">if</font> ( next() ) {
03966     QTextParag *s = next();
03967     <font class="keywordflow">while</font> ( s ) {
03968         s-&gt;numSubParag = -1;
03969         s-&gt;lm = s-&gt;rm = s-&gt;tm = s-&gt;bm = flm = -1;
03970         s-&gt;numSubParag = -1;
03971         s-&gt;invalidate( 0 );
03972         s = s-&gt;next();
03973     }
03974     }
03975 }
03976 
03977 <font class="keywordtype">void</font> QTextParag::incDepth()
03978 {
03979     <font class="keywordflow">if</font> ( !style() || !doc )
03980     <font class="keywordflow">return</font>;
03981     <font class="keywordflow">if</font> ( style()-&gt;displayMode() != QStyleSheetItem::DisplayListItem )
03982     <font class="keywordflow">return</font>;
03983     styleSheetItemsVec.resize( styleSheetItemsVec.size() + 1 );
03984     styleSheetItemsVec.insert( styleSheetItemsVec.size() - 1, styleSheetItemsVec[ styleSheetItemsVec.size() - 2 ] );
03985     styleSheetItemsVec.insert( styleSheetItemsVec.size() - 2,
03986                    listStyle() == QStyleSheetItem::ListDisc || listStyle() == QStyleSheetItem::ListCircle ||
03987                    listStyle() == QStyleSheetItem::ListSquare ?
03988                    doc-&gt;styleSheet()-&gt;item( <font class="stringliteral">"ul"</font> ) : doc-&gt;styleSheet()-&gt;item( "ol" ) );
03989     invalidate( 0 );
03990     lm = -1;
03991     flm = -1;
03992 }
03993 
03994 <font class="keywordtype">void</font> QTextParag::decDepth()
03995 {
03996     <font class="keywordflow">if</font> ( !style() || !doc )
03997     <font class="keywordflow">return</font>;
03998     <font class="keywordflow">if</font> ( style()-&gt;displayMode() != QStyleSheetItem::DisplayListItem )
03999     <font class="keywordflow">return</font>;
04000     <font class="keywordtype">int</font> numLists = 0;
04001     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *lastList = 0;
04002     <font class="keywordtype">int</font> lastIndex = 0;
04003     <font class="keywordtype">int</font> i;
04004     <font class="keywordflow">for</font> ( i = 0; i &lt; (int)styleSheetItemsVec.size(); ++i ) {
04005     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *item = styleSheetItemsVec[ i ];
04006     <font class="keywordflow">if</font> ( item-&gt;name() == <font class="stringliteral">"ol"</font> || item-&gt;name() == <font class="stringliteral">"ul"</font> ) {
04007         lastList = item;
04008         lastIndex = i;
04009         numLists++;
04010     }
04011     }
04012 
04013     <font class="keywordflow">if</font> ( !lastList )
04014     <font class="keywordflow">return</font>;
04015     styleSheetItemsVec.remove( lastIndex );
04016     <font class="keywordflow">for</font> ( i = lastIndex; i &lt; (int)styleSheetItemsVec.size() - 1; ++i )
04017     styleSheetItemsVec.insert( i, styleSheetItemsVec[ i + 1 ] );
04018     styleSheetItemsVec.resize( styleSheetItemsVec.size() - 1 );
04019     <font class="keywordflow">if</font> ( numLists == 1 )
04020     setList( FALSE, -1 );
04021     invalidate( 0 );
04022     lm = -1;
04023     flm = -1;
04024 }
04025 
04026 <font class="keywordtype">int</font> QTextParag::nextTab( <font class="keywordtype">int</font>, <font class="keywordtype">int</font> x )
04027 {
04028     <font class="keywordtype">int</font> *ta = tArray;
04029     <font class="keywordflow">if</font> ( doc ) {
04030     <font class="keywordflow">if</font> ( !ta )
04031        ta = doc-&gt;tabArray();
04032     tabStopWidth = doc-&gt;tabStopWidth();
04033     }
04034     <font class="keywordflow">if</font> ( ta ) {
04035     <font class="keywordtype">int</font> i = 0;
04036     <font class="keywordflow">while</font> ( ta[ i ] ) {
04037         <font class="keywordflow">if</font> ( ta[ i ] &gt;= x )
04038         <font class="keywordflow">return</font> tArray[ i ];
04039         ++i;
04040     }
04041     <font class="keywordflow">return</font> tArray[ 0 ];
04042     } <font class="keywordflow">else</font> {
04043     <font class="keywordtype">int</font> d;
04044     <font class="keywordflow">if</font> ( tabStopWidth != 0 )
04045         d = x / tabStopWidth;
04046     <font class="keywordflow">else</font>
04047         <font class="keywordflow">return</font> x;
04048     <font class="keywordflow">return</font> tabStopWidth * ( d + 1 );
04049     }
04050 }
04051 
04052 <font class="keywordtype">void</font> QTextParag::setPainter( QPainter *p )
04053 {
04054     pntr = p;
04055     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; length(); ++i ) {
04056     <font class="keywordflow">if</font> ( at( i )-&gt;isCustom() )
04057         at( i )-&gt;customItem()-&gt;adjustToPainter( p );
04058     }
04059 }
04060 
04061 QTextFormatCollection *QTextParag::formatCollection()<font class="keyword"> const</font>
04062 <font class="keyword"></font>{
04063     <font class="keywordflow">if</font> ( doc )
04064     <font class="keywordflow">return</font> doc-&gt;formatCollection();
04065     <font class="keywordflow">if</font> ( !qFormatCollection )
04066     qFormatCollection = <font class="keyword">new</font> QTextFormatCollection;
04067     <font class="keywordflow">return</font> qFormatCollection;
04068 }
04069 
04070 QString QTextParag::richText()<font class="keyword"> const</font>
04071 <font class="keyword"></font>{
04072     QString s;
04073     QTextFormat *lastFormat = 0;
04074     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; length(); ++i ) {
04075     QTextStringChar *c = &amp;str-&gt;at( i );
04076     <font class="keywordflow">if</font> ( !lastFormat || ( lastFormat-&gt;key() != c-&gt;format()-&gt;key() &amp;&amp; c-&gt;c != <font class="charliteral">' '</font> ) ) {
04077         s += c-&gt;format()-&gt;makeFormatChangeTags( lastFormat );
04078         lastFormat = c-&gt;format();
04079     }
04080     <font class="keywordflow">if</font> ( c-&gt;c == <font class="charliteral">'&lt;'</font> ) {
04081         s += <font class="stringliteral">"&amp;lt;"</font>;
04082     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( c-&gt;c == <font class="charliteral">'&gt;'</font> ) {
04083         s += <font class="stringliteral">"&amp;gt;"</font>;
04084     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( c-&gt;isCustom() ) {
04085         s += c-&gt;customItem()-&gt;richText();
04086     } <font class="keywordflow">else</font> {
04087         s += c-&gt;c;
04088     }
04089     }
04090     <font class="keywordflow">return</font> s;
04091 }
04092 
04093 <font class="keywordtype">void</font> QTextParag::addCommand( QTextCommand *cmd )
04094 {
04095     <font class="keywordflow">if</font> ( !doc )
04096     commandHistory-&gt;addCommand( cmd );
04097     <font class="keywordflow">else</font>
04098     doc-&gt;commands()-&gt;addCommand( cmd );
04099 }
04100 
04101 QTextCursor *QTextParag::undo( QTextCursor *c )
04102 {
04103     <font class="keywordflow">if</font> ( !doc )
04104     <font class="keywordflow">return</font> commandHistory-&gt;undo( c );
04105     <font class="keywordflow">return</font> doc-&gt;commands()-&gt;undo( c );
04106 }
04107 
04108 QTextCursor *QTextParag::redo( QTextCursor *c )
04109 {
04110     <font class="keywordflow">if</font> ( !doc )
04111     <font class="keywordflow">return</font> commandHistory-&gt;redo( c );
04112     <font class="keywordflow">return</font> doc-&gt;commands()-&gt;redo( c );
04113 }
04114 
04115 <font class="keywordtype">int</font> QTextParag::topMargin()<font class="keyword"> const</font>
04116 <font class="keyword"></font>{
04117     <font class="keywordflow">if</font> ( !p &amp;&amp; ( !doc || !doc-&gt;addMargins() ) )
04118     <font class="keywordflow">return</font> 0;
04119     <font class="keywordflow">if</font> ( tm != -1 )
04120     <font class="keywordflow">return</font> tm;
04121     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *item = style();
04122     <font class="keywordflow">if</font> ( !item ) {
04123     ( (QTextParag*)<font class="keyword">this</font> )-&gt;tm = 0;
04124     <font class="keywordflow">return</font> 0;
04125     }
04126 
04127     <font class="keywordtype">int</font> m = 0;
04128     <font class="keywordflow">if</font> ( item-&gt;margin( QStyleSheetItem::MarginTop ) != QStyleSheetItem::Undefined )
04129     m = item-&gt;margin( QStyleSheetItem::MarginTop );
04130     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *it = 0;
04131     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *p = prev() ? prev()-&gt;style() : 0;
04132     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = (int)styleSheetItemsVec.size() - 2 ; i &gt;= 0; --i ) {
04133     it = styleSheetItemsVec[ i ];
04134     <font class="keywordflow">if</font> ( it != p )
04135         <font class="keywordflow">break</font>;
04136     <font class="keywordtype">int</font> mar = it-&gt;margin( QStyleSheetItem::MarginTop );
04137     m += mar != QStyleSheetItem::Undefined ? mar : 0;
04138     <font class="keywordflow">if</font> ( it-&gt;displayMode() != QStyleSheetItem::DisplayInline )
04139         <font class="keywordflow">break</font>;
04140     }
04141 
04142     <font class="keywordflow">if</font> ( is_printer( painter() ) ) {
04143     QPaintDeviceMetrics metrics( painter()-&gt;device() );
04144     <font class="keywordtype">double</font> yscale = scale_factor( metrics.logicalDpiY() );
04145     m = (int)( (double)m * yscale );
04146     }
04147 
04148     ( (QTextParag*)<font class="keyword">this</font> )-&gt;tm = m;
04149     <font class="keywordflow">return</font> tm;
04150 }
04151 
04152 <font class="keywordtype">int</font> QTextParag::bottomMargin()<font class="keyword"> const</font>
04153 <font class="keyword"></font>{
04154     <font class="keywordflow">if</font> ( bm != -1 )
04155     <font class="keywordflow">return</font> bm;
04156     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *item = style();
04157     <font class="keywordflow">if</font> ( !item ) {
04158     ( (QTextParag*)<font class="keyword">this</font> )-&gt;bm = 0;
04159     <font class="keywordflow">return</font> 0;
04160     }
04161 
04162     <font class="keywordtype">int</font> m = 0;
04163     <font class="keywordflow">if</font> ( item-&gt;margin( QStyleSheetItem::MarginBottom ) != QStyleSheetItem::Undefined )
04164     m = item-&gt;margin( QStyleSheetItem::MarginBottom );
04165     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *it = 0;
04166     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *n = next() ? next()-&gt;style() : 0;
04167     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i =(int)styleSheetItemsVec.size() - 2 ; i &gt;= 0; --i ) {
04168     it = styleSheetItemsVec[ i ];
04169     <font class="keywordflow">if</font> ( it != n )
04170         <font class="keywordflow">break</font>;
04171     <font class="keywordtype">int</font> mar = it-&gt;margin( QStyleSheetItem::MarginBottom );
04172     m += mar != QStyleSheetItem::Undefined ? mar : 0;
04173     <font class="keywordflow">if</font> ( it-&gt;displayMode() != QStyleSheetItem::DisplayInline )
04174         <font class="keywordflow">break</font>;
04175     }
04176 
04177     <font class="keywordflow">if</font> ( is_printer( painter() ) ) {
04178     QPaintDeviceMetrics metrics( painter()-&gt;device() );
04179     <font class="keywordtype">double</font> yscale = scale_factor( metrics.logicalDpiY() );
04180     m = (int)( (double)m * yscale );
04181     }
04182 
04183     ( (QTextParag*)<font class="keyword">this</font> )-&gt;bm = m;
04184     <font class="keywordflow">return</font> bm;
04185 }
04186 
04187 <font class="keywordtype">int</font> QTextParag::leftMargin()<font class="keyword"> const</font>
04188 <font class="keyword"></font>{
04189     <font class="keywordflow">if</font> ( lm != -1 )
04190     <font class="keywordflow">return</font> lm;
04191     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *item = style();
04192     <font class="keywordflow">if</font> ( !item ) {
04193     ( (QTextParag*)<font class="keyword">this</font> )-&gt;lm = 0;
04194     <font class="keywordflow">return</font> 0;
04195     }
04196     <font class="keywordtype">int</font> m = 0;
04197     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)styleSheetItemsVec.size(); ++i ) {
04198     item = styleSheetItemsVec[ i ];
04199     <font class="keywordtype">int</font> mar = item-&gt;margin( QStyleSheetItem::MarginLeft );
04200     m += mar != QStyleSheetItem::Undefined ? mar : 0;
04201     <font class="keywordflow">if</font> ( item-&gt;name() == <font class="stringliteral">"ol"</font> || item-&gt;name() == <font class="stringliteral">"ul"</font> ) {
04202         m += defFormat-&gt;width( <font class="charliteral">'1'</font> ) +
04203          defFormat-&gt;width( <font class="charliteral">'2'</font> ) +
04204          defFormat-&gt;width( <font class="charliteral">'3'</font> ) +
04205          defFormat-&gt;width( <font class="charliteral">'.'</font> );
04206     }
04207     }
04208 
04209     <font class="keywordflow">if</font> ( is_printer( painter() ) ) {
04210     QPaintDeviceMetrics metrics( painter()-&gt;device() );
04211     <font class="keywordtype">double</font> yscale = scale_factor( metrics.logicalDpiY() );
04212     m = (int)( (double)m * yscale );
04213     }
04214 
04215     ( (QTextParag*)<font class="keyword">this</font> )-&gt;lm = m;
04216     <font class="keywordflow">return</font> lm;
04217 }
04218 
04219 <font class="keywordtype">int</font> QTextParag::firstLineMargin()<font class="keyword"> const</font>
04220 <font class="keyword"></font>{
04221     <font class="keywordflow">if</font> ( flm != -1 )
04222     <font class="keywordflow">return</font> lm;
04223     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *item = style();
04224     <font class="keywordflow">if</font> ( !item ) {
04225     ( (QTextParag*)<font class="keyword">this</font> )-&gt;flm = 0;
04226     <font class="keywordflow">return</font> 0;
04227     }
04228     <font class="keywordtype">int</font> m = 0;
04229     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)styleSheetItemsVec.size(); ++i ) {
04230     item = styleSheetItemsVec[ i ];
04231     <font class="keywordtype">int</font> mar = item-&gt;margin( QStyleSheetItem::MarginFirstLine );
04232     m += mar != QStyleSheetItem::Undefined ? mar : 0;
04233     }
04234 
04235     <font class="keywordflow">if</font> ( is_printer( painter() ) ) {
04236     QPaintDeviceMetrics metrics( painter()-&gt;device() );
04237     <font class="keywordtype">double</font> yscale = scale_factor( metrics.logicalDpiY() );
04238     m = (int)( (double)m * yscale );
04239     }
04240 
04241     ( (QTextParag*)<font class="keyword">this</font> )-&gt;flm = m;
04242     <font class="keywordflow">return</font> flm;
04243 }
04244 
04245 <font class="keywordtype">int</font> QTextParag::rightMargin()<font class="keyword"> const</font>
04246 <font class="keyword"></font>{
04247     <font class="keywordflow">if</font> ( rm != -1 )
04248     <font class="keywordflow">return</font> rm;
04249     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *item = style();
04250     <font class="keywordflow">if</font> ( !item ) {
04251     ( (QTextParag*)<font class="keyword">this</font> )-&gt;rm = 0;
04252     <font class="keywordflow">return</font> 0;
04253     }
04254     <font class="keywordtype">int</font> m = 0;
04255     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)styleSheetItemsVec.size(); ++i ) {
04256     item = styleSheetItemsVec[ i ];
04257     <font class="keywordtype">int</font> mar = item-&gt;margin( QStyleSheetItem::MarginRight );
04258     m += mar != QStyleSheetItem::Undefined ? mar : 0;
04259     }
04260 
04261     <font class="keywordflow">if</font> ( is_printer( painter() ) ) {
04262     QPaintDeviceMetrics metrics( painter()-&gt;device() );
04263     <font class="keywordtype">double</font> yscale = scale_factor( metrics.logicalDpiY() );
04264     m = (int)( (double)m * yscale );
04265     }
04266 
04267     ( (QTextParag*)<font class="keyword">this</font> )-&gt;rm = m;
04268     <font class="keywordflow">return</font> rm;
04269 }
04270 
04271 <font class="keywordtype">int</font> QTextParag::lineSpacing( <font class="keywordtype">int</font> <font class="comment">/*line*/</font> )<font class="keyword"> const</font>
04272 <font class="keyword"></font>{
04273     <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *item = style();
04274     <font class="keywordflow">if</font> ( !item )
04275     <font class="keywordflow">return</font> 0;
04276 
04277     <font class="keywordtype">int</font> ls = item-&gt;lineSpacing();
04278     <font class="keywordflow">if</font> ( ls == QStyleSheetItem::Undefined )
04279     <font class="keywordflow">return</font> 0;
04280     <font class="keywordflow">if</font> ( is_printer( painter() ) ) {
04281     QPaintDeviceMetrics metrics( painter()-&gt;device() );
04282     <font class="keywordtype">double</font> yscale = scale_factor( metrics.logicalDpiY() );
04283     ls = (int)( (double)ls * yscale );
04284     }
04285 
04286     <font class="keywordflow">return</font> ls;
04287 }
04288 
04289 <font class="keywordtype">void</font> QTextParag::copyParagData( QTextParag *parag )
04290 {
04291     setStyleSheetItems( parag-&gt;styleSheetItems() );
04292     setListStyle( parag-&gt;listStyle() );
04293     setAlignment( parag-&gt;alignment() );
04294 }
04295 
04296 <font class="keywordtype">void</font> QTextParag::show()
04297 {
04298     <font class="keywordflow">if</font> ( visible || !doc )
04299     <font class="keywordflow">return</font>;
04300     visible = TRUE;
04301 }
04302 
04303 <font class="keywordtype">void</font> QTextParag::hide()
04304 {
04305     <font class="keywordflow">if</font> ( !visible || !doc )
04306     <font class="keywordflow">return</font>;
04307     visible = FALSE;
04308 }
04309 
04310 <font class="comment">// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
04311 
04312 
04313 QTextPreProcessor::QTextPreProcessor()
04314 {
04315 }
04316 
04317 <font class="comment">// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
04318 
04319 QTextFormatter::QTextFormatter()
04320     : wrapEnabled( TRUE ), wrapColumn( -1 ), biw( FALSE )
04321 {
04322 }
04323 
04324 <font class="comment">/* only used for bidi or complex text reordering</font>
04325 <font class="comment"> */</font>
04326 QTextParagLineStart *QTextFormatter::formatLine( QTextParag * <font class="comment">/*parag*/</font>, QTextString *string, QTextParagLineStart *line,
04327                            QTextStringChar *startChar, QTextStringChar *lastChar, <font class="keywordtype">int</font> align, <font class="keywordtype">int</font> space )
04328 {
04329 <font class="comment">//QT2HACK</font>
04330 <font class="preprocessor">#if 0</font>
04331 <font class="preprocessor"></font>    <font class="keywordflow">if</font>( string-&gt;isBidi() )
04332     <font class="keywordflow">return</font> bidiReorderLine( parag, string, line, startChar, lastChar, align, space );
04333 <font class="preprocessor">#endif</font>
04334 <font class="preprocessor"></font>    space = QMAX( space, 0 ); <font class="comment">// #### with nested tables this gets negative because of a bug I didn't find yet, so workaround for now. This also means non-left aligned nested tables do not work at the moment</font>
04335     <font class="keywordtype">int</font> start = (startChar - &amp;string-&gt;at(0));
04336     <font class="keywordtype">int</font> last = (lastChar - &amp;string-&gt;at(0) );
04337     <font class="comment">// do alignment Auto == Left in this case</font>
04338     <font class="keywordflow">if</font> ( align &amp; Qt::AlignHCenter || align &amp; Qt::AlignRight ) {
04339     <font class="keywordflow">if</font> ( align &amp; Qt::AlignHCenter )
04340         space /= 2;
04341     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> j = start; j &lt;= last; ++j )
04342         string-&gt;at( j ).x += space;
04343     } <font class="keywordflow">else</font> if ( align &amp; Qt3::AlignJustify ) {
04344     <font class="keywordtype">int</font> numSpaces = 0;
04345     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> j = start; j &lt; last; ++j ) {
04346         <font class="keywordflow">if</font>( isBreakable( string, j ) ) {
04347         numSpaces++;
04348         }
04349     }
04350     <font class="keywordtype">int</font> toAdd = 0;
04351     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> k = start + 1; k &lt;= last; ++k ) {
04352         <font class="keywordflow">if</font>( isBreakable( string, k ) &amp;&amp; numSpaces ) {
04353         <font class="keywordtype">int</font> s = space / numSpaces;
04354         toAdd += s;
04355         space -= s;
04356         numSpaces--;
04357         }
04358         string-&gt;at( k ).x += toAdd;
04359     }
04360     }
04361 
04362     if ( last &gt;= 0 &amp;&amp; last &lt; string-&gt;length() )
04363     line-&gt;w = string-&gt;at( last ).x + string-&gt;width( last ); <font class="comment">// #### Lars, I guess this breaks for Bidi</font>
04364     <font class="keywordflow">else</font>
04365     line-&gt;w = 0;
04366 
04367     <font class="keywordflow">return</font> <font class="keyword">new</font> QTextParagLineStart();
04368 }
04369 
04370 <font class="comment">//QT2HACK</font>
04371 <font class="preprocessor">#if 0</font>
04372 <font class="preprocessor"></font>
04373 <font class="preprocessor">#ifdef BIDI_DEBUG</font>
04374 <font class="preprocessor"></font><font class="preprocessor">#include &lt;iostream&gt;</font>
04375 <font class="preprocessor">#endif</font>
04376 <font class="preprocessor"></font>
04377 <font class="comment">// collects one line of the paragraph and transforms it to visual order</font>
04378 QTextParagLineStart *QTextFormatter::bidiReorderLine( QTextParag *parag, QTextString *text, QTextParagLineStart *line,
04379                             QTextStringChar *startChar, QTextStringChar *lastChar, <font class="keywordtype">int</font> align, <font class="keywordtype">int</font> space )
04380 {
04381     <font class="keywordtype">int</font> start = (startChar - &amp;text-&gt;at(0));
04382     <font class="keywordtype">int</font> last = (lastChar - &amp;text-&gt;at(0) );
04383     <font class="comment">//printf("doing BiDi reordering from %d to %d!\n", start, last);</font>
04384 
04385     QBidiControl *control = <font class="keyword">new</font> QBidiControl( line-&gt;context(), line-&gt;status );
04386     QString str;
04387     str.setUnicode( 0, last - start + 1 );
04388     <font class="comment">// fill string with logically ordered chars.</font>
04389     QTextStringChar *ch = startChar;
04390     QChar *qch = (QChar *)str.unicode();
04391     <font class="keywordflow">while</font>( ch &lt;= lastChar ) {
04392     *qch = ch-&gt;c;
04393     qch++;
04394     ch++;
04395     }
04396 
04397     QPtrList&lt;QTextRun&gt; *runs;
04398     runs = QComplexText::bidiReorderLine(control, str, 0, last - start + 1);
04399 
04400     <font class="comment">// now construct the reordered string out of the runs...</font>
04401 
04402     <font class="keywordtype">int</font> left = parag-&gt;document() ? parag-&gt;leftMargin() + 4 : 4;
04403     <font class="keywordtype">int</font> x = left + ( parag-&gt;document() ? parag-&gt;firstLineMargin() : 0 );
04404     <font class="keywordflow">if</font> ( parag-&gt;document() )
04405     x = parag-&gt;document()-&gt;flow()-&gt;adjustLMargin( parag-&gt;rect().y(), parag-&gt;rect().height(), left, 4 );
04406     <font class="keywordtype">int</font> numSpaces = 0;
04407     <font class="comment">// set the correct alignment. This is a bit messy....</font>
04408     <font class="keywordflow">if</font>( align == Qt3::AlignAuto ) {
04409     <font class="comment">// align according to directionality of the paragraph...</font>
04410     <font class="keywordflow">if</font> ( text-&gt;isRightToLeft() )
04411         align = Qt::AlignRight;
04412     }
04413 
04414     <font class="keywordflow">if</font> ( align &amp; Qt::AlignHCenter )
04415     x += space/2;
04416     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( align &amp; Qt::AlignRight )
04417     x += space;
04418     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( align &amp; Qt3::AlignJustify ) {
04419     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> j = start; j &lt; last; ++j ) {
04420         <font class="keywordflow">if</font>( isBreakable( text, j ) ) {
04421         numSpaces++;
04422         }
04423     }
04424     }
04425     <font class="keywordtype">int</font> toAdd = 0;
04426 
04427     <font class="comment">// in rtl text the leftmost character is usually a space</font>
04428     <font class="comment">// this space should not take up visible space on the left side, to get alignment right.</font>
04429     <font class="comment">// the following bool is used for that purpose</font>
04430     <font class="keywordtype">bool</font> first = TRUE;
04431     QTextRun *r = runs-&gt;first();
04432     <font class="keywordflow">while</font> ( r ) {
04433     <font class="keywordflow">if</font>(r-&gt;level %2) {
04434         <font class="comment">// odd level, need to reverse the string</font>
04435         <font class="keywordtype">int</font> pos = r-&gt;stop + start;
04436         <font class="keywordflow">while</font>(pos &gt;= r-&gt;start + start) {
04437         QTextStringChar *c = &amp;text-&gt;at(pos);
04438         <font class="keywordflow">if</font>( numSpaces &amp;&amp; !first &amp;&amp; isBreakable( text, pos ) ) {
04439             <font class="keywordtype">int</font> s = space / numSpaces;
04440             toAdd += s;
04441             space -= s;
04442             numSpaces--;
04443         }
04444         <font class="keywordflow">if</font> ( first ) {
04445             first = FALSE;
04446             <font class="keywordflow">if</font> ( c-&gt;c == <font class="charliteral">' '</font> )
04447             x -= text-&gt;width( pos );
04448         }
04449         c-&gt;x = x + toAdd;
04450         c-&gt;rightToLeft = TRUE;
04451         c-&gt;startOfRun = FALSE;
04452         <font class="keywordtype">int</font> ww = 0;
04453         <font class="keywordflow">if</font> ( c-&gt;c.unicode() &gt;= 32 || c-&gt;c == <font class="charliteral">'\t'</font> || c-&gt;isCustom() ) {
04454             ww = text-&gt;width( pos );
04455         } <font class="keywordflow">else</font> {
04456             ww = c-&gt;format()-&gt;width( <font class="charliteral">' '</font> );
04457         }
04458         <font class="comment">//qDebug("setting char %d at pos %d width=%d", pos, x, ww);</font>
04459         x += ww;
04460         pos--;
04461         }
04462     } <font class="keywordflow">else</font> {
04463         <font class="keywordtype">int</font> pos = r-&gt;start + start;
04464         <font class="keywordflow">while</font>(pos &lt;= r-&gt;stop + start) {
04465         QTextStringChar* c = &amp;text-&gt;at(pos);
04466         <font class="keywordflow">if</font>( numSpaces &amp;&amp; !first &amp;&amp; isBreakable( text, pos ) ) {
04467             <font class="keywordtype">int</font> s = space / numSpaces;
04468             toAdd += s;
04469             space -= s;
04470             numSpaces--;
04471         }
04472         <font class="keywordflow">if</font> ( first ) {
04473             first = FALSE;
04474             <font class="keywordflow">if</font> ( c-&gt;c == <font class="charliteral">' '</font> )
04475             x -= text-&gt;width( pos );
04476         }
04477         c-&gt;x = x + toAdd;
04478         c-&gt;rightToLeft = FALSE;
04479         c-&gt;startOfRun = FALSE;
04480         <font class="keywordtype">int</font> ww = 0;
04481         <font class="keywordflow">if</font> ( c-&gt;c.unicode() &gt;= 32 || c-&gt;c == <font class="charliteral">'\t'</font> || c-&gt;isCustom() ) {
04482             ww = text-&gt;width( pos );
04483         } <font class="keywordflow">else</font> {
04484             ww = c-&gt;format()-&gt;width( <font class="charliteral">' '</font> );
04485         }
04486         <font class="comment">//qDebug("setting char %d at pos %d", pos, x);</font>
04487         x += ww;
04488         pos++;
04489         }
04490     }
04491     text-&gt;at( r-&gt;start ).startOfRun = TRUE;
04492     r = runs-&gt;next();
04493     }
04494     QTextParagLineStart *ls = <font class="keyword">new</font> QTextParagLineStart( control-&gt;context, control-&gt;status );
04495     <font class="keyword">delete</font> control;
04496     <font class="keyword">delete</font> runs;
04497     <font class="keywordflow">return</font> ls;
04498 }
04499 <font class="preprocessor">#endif</font>
04500 <font class="preprocessor"></font>
04501 <font class="keywordtype">bool</font> QTextFormatter::isBreakable( QTextString *string, <font class="keywordtype">int</font> pos )<font class="keyword"> const</font>
04502 <font class="keyword"></font>{
04503     <font class="keyword">const</font> QChar &amp;c = string-&gt;at( pos ).c;
04504     <font class="keywordtype">char</font> ch = c.latin1();
04505     <font class="keywordflow">if</font> ( c.isSpace() &amp;&amp; ch != <font class="charliteral">'\n'</font> )
04506     <font class="keywordflow">return</font> TRUE;
04507     <font class="keywordflow">if</font> ( c.unicode() == 0xad ) <font class="comment">// soft hyphen</font>
04508     <font class="keywordflow">return</font> TRUE;
04509     <font class="keywordflow">if</font> ( !ch ) {
04510     <font class="comment">// not latin1, need to do more sophisticated checks for other scripts</font>
04511     uchar row = c.row();
04512     <font class="keywordflow">if</font> ( row == 0x0e ) {
04513         <font class="comment">// 0e00 - 0e7f == Thai</font>
04514         <font class="keywordflow">if</font> ( c.cell() &lt; 0x80 ) {
04515 <font class="preprocessor">#ifdef HAVE_THAI_BREAKS</font>
04516 <font class="preprocessor"></font>        <font class="comment">// check for thai</font>
04517         <font class="keywordflow">if</font>( string != cachedString ) {
04518             <font class="comment">// build up string of thai chars</font>
04519             QTextCodec *thaiCodec = QTextCodec::codecForMib(2259);
04520             <font class="keywordflow">if</font> ( !thaiCache )
04521             thaiCache = <font class="keyword">new</font> QCString;
04522             <font class="keywordflow">if</font> ( !thaiIt )
04523             thaiIt = ThBreakIterator::createWordInstance();
04524             *thaiCache = thaiCodec-&gt;fromUnicode( s-&gt;string() );
04525         }
04526         thaiIt-&gt;setText(thaiCache-&gt;data());
04527         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = thaiIt-&gt;first(); i != thaiIt-&gt;DONE; i = thaiIt-&gt;next() ) {
04528             <font class="keywordflow">if</font>( i == pos )
04529             <font class="keywordflow">return</font> TRUE;
04530             <font class="keywordflow">if</font>( i &gt; pos )
04531             <font class="keywordflow">return</font> FALSE;
04532         }
04533         <font class="keywordflow">return</font> FALSE;
04534 <font class="preprocessor">#else</font>
04535 <font class="preprocessor"></font>        <font class="comment">// if we don't have a thai line breaking lib, allow</font>
04536         <font class="comment">// breaks everywhere except directly before punctuation.</font>
04537         <font class="keywordflow">return</font> TRUE;
04538 <font class="preprocessor">#endif</font>
04539 <font class="preprocessor"></font>        } <font class="keywordflow">else</font>
04540         <font class="keywordflow">return</font> FALSE;
04541     }
04542     <font class="keywordflow">if</font> ( row &lt; 0x11 ) <font class="comment">// no asian font</font>
04543         <font class="keywordflow">return</font> FALSE;
04544     <font class="keywordflow">if</font> ( row &gt; 0x2d &amp;&amp; row &lt; 0xfb || row == 0x11 )
04545         <font class="comment">// asian line breaking. Everywhere allowed except directly</font>
04546         <font class="comment">// in front of a punctuation character.</font>
04547         <font class="keywordflow">return</font> TRUE;
04548     }
04549     <font class="keywordflow">return</font> FALSE;
04550 }
04551 
04552 <font class="keywordtype">void</font> QTextFormatter::insertLineStart( QTextParag *parag, <font class="keywordtype">int</font> index, QTextParagLineStart *ls )
04553 {
04554     <font class="keywordflow">if</font> ( index &gt; 0 ) { <font class="comment">// we can assume that only first line starts are insrted multiple times</font>
04555     parag-&gt;lineStartList().insert( index, ls );
04556     <font class="keywordflow">return</font>;
04557     }
04558     QMap&lt;int, QTextParagLineStart*&gt;::Iterator it;
04559     <font class="keywordflow">if</font> ( ( it = parag-&gt;lineStartList().find( index ) ) == parag-&gt;lineStartList().end() ) {
04560     parag-&gt;lineStartList().insert( index, ls );
04561     } <font class="keywordflow">else</font> {
04562     <font class="keyword">delete</font> *it;
04563     parag-&gt;lineStartList().remove( it );
04564     parag-&gt;lineStartList().insert( index, ls );
04565     }
04566 }
04567 
04568 <font class="comment">// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
04569 
04570 QTextFormatterBreakInWords::QTextFormatterBreakInWords()
04571 {
04572 }
04573 
04574 <font class="keywordtype">int</font> QTextFormatterBreakInWords::format( QTextDocument *doc,QTextParag *parag,
04575                     <font class="keywordtype">int</font> start, <font class="keyword">const</font> QMap&lt;int, QTextParagLineStart*&gt; &amp; )
04576 {
04577     QTextStringChar *c = 0;
04578     QTextStringChar *firstChar = 0;
04579     <font class="keywordtype">int</font> left = doc ? parag-&gt;leftMargin() + 4 : 4;
04580     <font class="keywordtype">int</font> x = left + ( doc ? parag-&gt;firstLineMargin() : 0 );
04581     <font class="keywordtype">int</font> dw = parag-&gt;documentVisibleWidth() - ( doc ? 8 : 0 );
04582     <font class="keywordtype">int</font> y = doc-&gt;addMargins() ? parag-&gt;topMargin() : 0;
04583     <font class="keywordtype">int</font> h = y;
04584     <font class="keywordtype">int</font> len = parag-&gt;length();
04585     <font class="keywordflow">if</font> ( doc )
04586     x = doc-&gt;flow()-&gt;adjustLMargin( y + parag-&gt;rect().y(), parag-&gt;rect().height(), x, 4 );
04587     <font class="keywordtype">int</font> rm = parag-&gt;rightMargin();
04588     <font class="keywordtype">int</font> w = dw - ( doc ? doc-&gt;flow()-&gt;adjustRMargin( y + parag-&gt;rect().y(), parag-&gt;rect().height(), rm, 4 ) : 0 );
04589     <font class="keywordtype">bool</font> fullWidth = TRUE;
04590     <font class="keywordtype">int</font> minw = 0;
04591 
04592     start = 0;
04593     <font class="keywordflow">if</font> ( start == 0 )
04594     c = &amp;parag-&gt;string()-&gt;at( 0 );
04595 
04596     <font class="keywordtype">int</font> i = start;
04597     QTextParagLineStart *lineStart = <font class="keyword">new</font> QTextParagLineStart( y, y, 0 );
04598     insertLineStart( parag, 0, lineStart );
04599 
04600     <font class="keywordtype">int</font> col = 0;
04601     <font class="keywordtype">int</font> ww = 0;
04602     QChar lastChr;
04603     <font class="keywordflow">for</font> ( ; i &lt; len; ++i, ++col ) {
04604     <font class="keywordflow">if</font> ( c )
04605         lastChr = c-&gt;c;
04606     c = &amp;parag-&gt;string()-&gt;at( i );
04607     <font class="keywordflow">if</font> ( i &gt; 0 ) {
04608         c-&gt;lineStart = 0;
04609     } <font class="keywordflow">else</font> {
04610         c-&gt;lineStart = 1;
04611         firstChar = c;
04612     }
04613     <font class="keywordflow">if</font> ( c-&gt;c.unicode() &gt;= 32 || c-&gt;isCustom() ) {
04614         ww = parag-&gt;string()-&gt;width( i );
04615     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( c-&gt;c == <font class="charliteral">'\t'</font> ) {
04616         <font class="keywordtype">int</font> nx = parag-&gt;nextTab( i, x );
04617         <font class="keywordflow">if</font> ( nx &lt; x )
04618         ww = w - x;
04619         <font class="keywordflow">else</font>
04620         ww = nx - x + 1;
04621     } <font class="keywordflow">else</font> {
04622         ww = c-&gt;format()-&gt;width( <font class="charliteral">' '</font> );
04623     }
04624 
04625     <font class="keywordflow">if</font> ( c-&gt;isCustom() &amp;&amp; c-&gt;customItem()-&gt;ownLine() ) {
04626         <font class="keywordflow">if</font> ( doc )
04627         x = doc ? doc-&gt;flow()-&gt;adjustLMargin( y + parag-&gt;rect().y(), parag-&gt;rect().height(), left, 4 ) : left;
04628         w = dw - ( doc ? doc-&gt;flow()-&gt;adjustRMargin( y + parag-&gt;rect().y(), parag-&gt;rect().height(), rm, 4 ) : 0 );
04629         c-&gt;customItem()-&gt;resize( parag-&gt;painter(), dw );
04630         <font class="keywordflow">if</font> ( x != left || w != dw )
04631         fullWidth = FALSE;
04632         w = dw;
04633         y += h;
04634         h = c-&gt;height();
04635         lineStart = <font class="keyword">new</font> QTextParagLineStart( y, h, h );
04636         insertLineStart( parag, i, lineStart );
04637         c-&gt;lineStart = 1;
04638         firstChar = c;
04639         x = 0xffffff;
04640         <font class="keywordflow">continue</font>;
04641     }
04642 
04643     <font class="keywordflow">if</font> ( isWrapEnabled() &amp;&amp;
04644          ( wrapAtColumn() == -1 &amp;&amp; x + ww &gt; w ||
04645            wrapAtColumn() != -1 &amp;&amp; col &gt;= wrapAtColumn() ) ||
04646            parag-&gt;isNewLinesAllowed() &amp;&amp; lastChr == <font class="charliteral">'\n'</font> ) {
04647         x = doc ? parag-&gt;document()-&gt;flow()-&gt;adjustLMargin( y + parag-&gt;rect().y(), parag-&gt;rect().height(), left, 4 ) : left;
04648         <font class="keywordflow">if</font> ( x != left )
04649         fullWidth = FALSE;
04650         w = dw;
04651         y += h;
04652         h = c-&gt;height();
04653         lineStart = formatLine( parag, parag-&gt;string(), lineStart, firstChar, c-1 );
04654         lineStart-&gt;y = y;
04655         insertLineStart( parag, i, lineStart );
04656         lineStart-&gt;baseLine = c-&gt;ascent();
04657         lineStart-&gt;h = c-&gt;height();
04658         c-&gt;lineStart = 1;
04659         firstChar = c;
04660         col = 0;
04661         <font class="keywordflow">if</font> ( wrapAtColumn() != -1 )
04662         minw = QMAX( minw, w );
04663     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( lineStart ) {
04664         lineStart-&gt;baseLine = QMAX( lineStart-&gt;baseLine, c-&gt;ascent() );
04665         h = QMAX( h, c-&gt;height() );
04666         lineStart-&gt;h = h;
04667     }
04668 
04669     c-&gt;x = x;
04670     x += ww;
04671     }
04672 
04673     <font class="keywordtype">int</font> m = parag-&gt;bottomMargin();
04674     <font class="keywordflow">if</font> ( parag-&gt;next() &amp;&amp; !doc-&gt;addMargins() )
04675     m = QMAX( m, parag-&gt;next()-&gt;topMargin() );
04676     parag-&gt;setFullWidth( fullWidth );
04677     <font class="keywordflow">if</font> ( is_printer( parag-&gt;painter() ) ) {
04678     QPaintDeviceMetrics metrics( parag-&gt;painter()-&gt;device() );
04679     <font class="keywordtype">double</font> yscale = scale_factor( metrics.logicalDpiY() );
04680     m = (int)( (double)m * yscale );
04681     }
04682     y += h + m;
04683     <font class="keywordflow">if</font> ( !isWrapEnabled() )
04684     minw = QMAX( minw, c-&gt;x + ww ); <font class="comment">// #### Lars: Fix this for BiDi, please</font>
04685     <font class="keywordflow">if</font> ( doc )
04686     doc-&gt;setMinimumWidth( minw, parag );
04687     <font class="keywordflow">return</font> y;
04688 }
04689 
04690 <font class="comment">// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
04691 
04692 QTextFormatterBreakWords::QTextFormatterBreakWords()
04693 {
04694 }
04695 
04696 <font class="keywordtype">int</font> QTextFormatterBreakWords::format( QTextDocument *doc, QTextParag *parag,
04697                       <font class="keywordtype">int</font> start, <font class="keyword">const</font> QMap&lt;int, QTextParagLineStart*&gt; &amp; )
04698 {
04699     QTextStringChar *c = 0;
04700     start = 0;
04701     <font class="keywordflow">if</font> ( start == 0 )
04702     c = &amp;parag-&gt;string()-&gt;at( 0 );
04703 
04704     QTextStringChar *firstChar = 0;
04705     <font class="keywordtype">int</font> firstCharIndex = 0;
04706     QTextString *string = parag-&gt;string();
04707     <font class="keywordtype">int</font> left = doc ? parag-&gt;leftMargin() + 4 : 0;
04708     <font class="keywordtype">int</font> x = left + ( doc ? parag-&gt;firstLineMargin() : 0 );
04709     <font class="keywordtype">int</font> curLeft = left;
04710     <font class="keywordtype">int</font> y = doc &amp;&amp; doc-&gt;addMargins() ? parag-&gt;topMargin() : 0;
04711     <font class="keywordtype">int</font> h = 0;
04712     <font class="keywordtype">int</font> len = parag-&gt;length();
04713 
04714     <font class="keywordtype">int</font> initialHeight = h + c-&gt;height(); <font class="comment">// remember what adjustLMargin was called with</font>
04715     <font class="keywordflow">if</font> ( doc )
04716     x = doc-&gt;flow()-&gt;adjustLMargin( y + parag-&gt;rect().y(), h + c-&gt;height(), x, 4 );
04717     <font class="keywordtype">int</font> initialLMargin = x;              <font class="comment">// and remember the resulting adjustement we got</font>
04718     <font class="keywordtype">int</font> dw = parag-&gt;documentVisibleWidth() - ( doc ? ( left != x ? 0 : 8 ) : -4 );
04719 
04720     curLeft = x;
04721     <font class="keywordtype">int</font> rm = parag-&gt;rightMargin();
04722     <font class="keywordtype">int</font> initialRMargin = doc ? doc-&gt;flow()-&gt;adjustRMargin( y + parag-&gt;rect().y(), h + c-&gt;height(), rm, 4 ) : 0;
04723     <font class="keywordtype">int</font> w = dw - initialRMargin;
04724     <font class="keywordtype">bool</font> fullWidth = TRUE;
04725     <font class="keywordtype">int</font> marg = left + initialRMargin;
04726     <font class="keywordtype">int</font> minw = 0;
04727     <font class="keywordtype">int</font> tminw = marg;
04728     <font class="keywordtype">int</font> line = 0;
04729 
04730     <font class="keywordtype">int</font> i = start;
04731     <font class="comment">//qDebug( "Initial QTextParagLineStart at y=%d", y );</font>
04732     QTextParagLineStart *lineStart = <font class="keyword">new</font> QTextParagLineStart( y, 0, 0 );
04733     insertLineStart( parag, 0, lineStart );
04734     <font class="keywordtype">int</font> lastBreak = -1;
04735     <font class="keywordtype">int</font> tmpBaseLine = 0, tmph = 0;
04736     <font class="keywordtype">bool</font> lastWasNonInlineCustom = FALSE;
04737 
04738     <font class="keywordtype">int</font> align = parag-&gt;alignment();
04739     <font class="keywordflow">if</font> ( align == Qt3::AlignAuto &amp;&amp; doc &amp;&amp; doc-&gt;alignment() != Qt3::AlignAuto )
04740     align = doc-&gt;alignment();
04741 
04742     <font class="keywordtype">int</font> col = 0;
04743     <font class="keywordtype">int</font> ww = 0;
04744     QChar lastChr;
04745     <font class="keywordflow">for</font> ( ; i &lt; len; ++i, ++col ) {
04746     <font class="keywordflow">if</font> ( c )
04747         lastChr = c-&gt;c;
04748     c = &amp;string-&gt;at( i );
04749     <font class="keywordflow">if</font> ( i &gt; 0 &amp;&amp; x &gt; curLeft || lastWasNonInlineCustom ) {
04750         c-&gt;lineStart = 0;
04751     } <font class="keywordflow">else</font> {
04752         c-&gt;lineStart = 1;
04753         firstChar = c;
04754             firstCharIndex = i;
04755     }
04756 
04757     <font class="keywordflow">if</font> ( c-&gt;isCustom() &amp;&amp; c-&gt;customItem()-&gt;placement() != QTextCustomItem::PlaceInline )
04758         lastWasNonInlineCustom = TRUE;
04759     <font class="keywordflow">else</font>
04760         lastWasNonInlineCustom = FALSE;
04761 
04762     <font class="keywordflow">if</font> ( c-&gt;c.unicode() &gt;= 32 || c-&gt;isCustom() ) {
04763         ww = string-&gt;width( i );
04764     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( c-&gt;c == <font class="charliteral">'\t'</font> ) {
04765         <font class="keywordtype">int</font> nx = parag-&gt;nextTab( i, x );
04766         <font class="keywordflow">if</font> ( nx &lt; x )
04767         ww = w - x;
04768         <font class="keywordflow">else</font>
04769         ww = nx - x + 1;
04770     } <font class="keywordflow">else</font> {
04771         ww = c-&gt;format()-&gt;width( <font class="charliteral">' '</font> );
04772     }
04773 
04774         <font class="comment">// Custom item that forces a new line</font>
04775     <font class="keywordflow">if</font> ( c-&gt;isCustom() &amp;&amp; c-&gt;customItem()-&gt;ownLine() ) {
04776         x = doc ? doc-&gt;flow()-&gt;adjustLMargin( y + parag-&gt;rect().y(), c-&gt;height(), left, 4 ) : left;
04777         w = dw - ( doc ? doc-&gt;flow()-&gt;adjustRMargin( y + parag-&gt;rect().y(), c-&gt;height(), rm, 4 ) : 0 );
04778         QTextParagLineStart *lineStart2 = formatLine( parag, string, lineStart, firstChar, c-1, align, w - x );
04779         c-&gt;customItem()-&gt;resize( parag-&gt;painter(), dw );
04780         <font class="keywordflow">if</font> ( x != left || w != dw )
04781         fullWidth = FALSE;
04782         curLeft = x;
04783         <font class="keywordflow">if</font> ( i == 0 || !isBreakable( string, i - 1 ) || string-&gt;at( i - 1 ).lineStart == 0 ) {
04784                 <font class="comment">// Create a new line for this custom item</font>
04785                 lineStart-&gt;h += doc ? parag-&gt;lineSpacing( line++ ) : 0;
04786         y += QMAX( h, tmph );
04787         tmph = c-&gt;height();
04788         h = tmph;
04789         lineStart = lineStart2;
04790         lineStart-&gt;y = y;
04791         insertLineStart( parag, i, lineStart );
04792         c-&gt;lineStart = 1;
04793         firstChar = c;
04794         } <font class="keywordflow">else</font> {
04795                 <font class="comment">// No need for a new line, already at beginning of line</font>
04796         tmph = c-&gt;height();
04797         h = tmph;
04798         <font class="keyword">delete</font> lineStart2;
04799         }
04800         lineStart-&gt;h = h;
04801         lineStart-&gt;baseLine = h;
04802         tmpBaseLine = lineStart-&gt;baseLine;
04803         lastBreak = -2;
04804         x = 0xffffff;
04805         minw = QMAX( minw, tminw );
04806         <font class="keywordtype">int</font> tw = QMAX( c-&gt;customItem()-&gt;minimumWidth(), QMIN( c-&gt;customItem()-&gt;widthHint(), c-&gt;customItem()-&gt;width ) );
04807         <font class="keywordflow">if</font> ( tw &lt; 32000 )
04808         tminw = tw;
04809         <font class="keywordflow">else</font>
04810         tminw = marg;
04811         <font class="keywordflow">continue</font>;
04812     }
04813         <font class="comment">//qDebug("c=%c i=%d/%d x=%d ww=%d w=%d (test is x+ww&gt;w) lastBreak=%d isBreakable=%d",c-&gt;c.latin1(),i,len,x,ww,w,lastBreak,isBreakable(string,i));</font>
04814         <font class="comment">// Wrapping at end of line</font>
04815     <font class="keywordflow">if</font> ( isWrapEnabled() &amp;&amp;
04816              ( !isBreakable( string, i ) || ( i &gt; 0 &amp;&amp; !isBreakable( string, i - 1 ) ) ) &amp;&amp; <font class="comment">// break after '  '</font>
04817              ( lastBreak != -1 || allowBreakInWords() ) &amp;&amp;
04818          ( wrapAtColumn() == -1 &amp;&amp; x + ww &gt; w &amp;&amp; lastBreak != -1 ||
04819            wrapAtColumn() == -1 &amp;&amp; x + ww &gt; w - 4 &amp;&amp; lastBreak == -1 &amp;&amp; allowBreakInWords() ||
04820            wrapAtColumn() != -1 &amp;&amp; col &gt;= wrapAtColumn() ) ||
04821            parag-&gt;isNewLinesAllowed() &amp;&amp; lastChr == <font class="charliteral">'\n'</font> ) {
04822             <font class="comment">//qDebug( "BREAKING" );</font>
04823         <font class="keywordflow">if</font> ( wrapAtColumn() != -1 )
04824         minw = QMAX( minw, x + ww );
04825             <font class="comment">// No breakable char found -&gt; break at current char</font>
04826         <font class="keywordflow">if</font> ( lastBreak &lt; 0 ) {
04827                 ASSERT( lineStart );
04828         <font class="comment">//if ( lineStart ) {</font>
04829                     <font class="comment">// (combine lineStart and tmpBaseLine/tmph)</font>
04830                     <font class="keywordtype">int</font> belowBaseLine = QMAX( h - lineStart-&gt;baseLine, tmph - tmpBaseLine );
04831                     lineStart-&gt;baseLine = QMAX( lineStart-&gt;baseLine, tmpBaseLine );
04832                     h = lineStart-&gt;baseLine + belowBaseLine;
04833             lineStart-&gt;h = h;
04834                 <font class="comment">//}</font>
04835         QTextParagLineStart *lineStart2 = formatLine( parag, string, lineStart, firstChar, c-1, align, w - x );
04836                 lineStart-&gt;h += doc ? parag-&gt;lineSpacing( line++ ) : 0;
04837         y += lineStart-&gt;h;
04838 
04839                 lineStart = lineStart2;
04840         tmph = c-&gt;height();
04841         h = 0;
04842         x = doc ? doc-&gt;flow()-&gt;adjustLMargin( y + parag-&gt;rect().y(), tmph, left, 4 ) : left;
04843                 initialHeight = tmph;
04844                 initialLMargin = x;
04845                 initialRMargin = ( doc ? doc-&gt;flow()-&gt;adjustRMargin( y + parag-&gt;rect().y(), tmph, rm, 4 ) : 0 );
04846         w = dw - initialRMargin;
04847         <font class="keywordflow">if</font> ( parag-&gt;isNewLinesAllowed() &amp;&amp; c-&gt;c == <font class="charliteral">'\t'</font> ) {
04848             <font class="keywordtype">int</font> nx = parag-&gt;nextTab( i, x );
04849             <font class="keywordflow">if</font> ( nx &lt; x )
04850             ww = w - x;
04851             <font class="keywordflow">else</font>
04852             ww = nx - x + 1;
04853         }
04854         <font class="keywordflow">if</font> ( x != left || w != dw )
04855             fullWidth = FALSE;
04856         curLeft = x;
04857         lineStart-&gt;y = y;
04858         insertLineStart( parag, i, lineStart );
04859         lineStart-&gt;baseLine = c-&gt;ascent();
04860         lineStart-&gt;h = c-&gt;height();
04861         c-&gt;lineStart = 1;
04862         firstChar = c;
04863         tmpBaseLine = lineStart-&gt;baseLine;
04864         lastBreak = -1;
04865         col = 0;
04866         } <font class="keywordflow">else</font> {
04867                 <font class="comment">// Breakable char was found</font>
04868         i = lastBreak;
04869         QTextParagLineStart *lineStart2 = formatLine( parag, string, lineStart, firstChar, parag-&gt;at( lastBreak ), align, w - string-&gt;at( i ).x );
04870                 lineStart-&gt;h += doc ? parag-&gt;lineSpacing( line++ ) : 0;
04871         y += lineStart-&gt;h;
04872         lineStart = lineStart2;
04873         tmph = c-&gt;height();
04874         h = tmph;
04875         x = doc ? doc-&gt;flow()-&gt;adjustLMargin( y + parag-&gt;rect().y(), h, left, 4 ) : left;
04876                 initialHeight = h;
04877                 initialLMargin = x;
04878                 initialRMargin = ( doc ? doc-&gt;flow()-&gt;adjustRMargin( y + parag-&gt;rect().y(), h, rm, 4 ) : 0 );
04879         w = dw - initialRMargin;
04880         <font class="keywordflow">if</font> ( parag-&gt;isNewLinesAllowed() &amp;&amp; c-&gt;c == <font class="charliteral">'\t'</font> ) {
04881             <font class="keywordtype">int</font> nx = parag-&gt;nextTab( i, x );
04882             <font class="keywordflow">if</font> ( nx &lt; x )
04883             ww = w - x;
04884             <font class="keywordflow">else</font>
04885             ww = nx - x + 1;
04886         }
04887         <font class="keywordflow">if</font> ( x != left || w != dw )
04888             fullWidth = FALSE;
04889         curLeft = x;
04890         lineStart-&gt;y = y;
04891         insertLineStart( parag, i + 1, lineStart );
04892         lineStart-&gt;baseLine = c-&gt;ascent();
04893         lineStart-&gt;h = c-&gt;height();
04894         c-&gt;lineStart = 1;
04895         firstChar = c;
04896         tmpBaseLine = lineStart-&gt;baseLine;
04897         lastBreak = -1;
04898         col = 0;
04899         tminw = marg;
04900         <font class="keywordflow">continue</font>;
04901         }
04902     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( lineStart &amp;&amp; ( isBreakable( string, i ) || parag-&gt;isNewLinesAllowed() &amp;&amp; c-&gt;c == <font class="charliteral">'\n'</font> ) ) {
04903             <font class="comment">// Breakable character</font>
04904         <font class="keywordflow">if</font> ( len &lt;= 2 || i &lt; len - 1 ) {
04905                 <font class="comment">//qDebug( " Breakable character (i=%d len=%d): combining %d/%d with %d/%d", i, len,</font>
04906                 <font class="comment">//        tmpBaseLine, tmph, c-&gt;ascent(), c-&gt;height()+ls );</font>
04907                 <font class="comment">// (combine tmpBaseLine/tmph and this character)</font>
04908                 <font class="keywordtype">int</font> belowBaseLine = QMAX( tmph - tmpBaseLine, c-&gt;height() - c-&gt;ascent() );
04909                 tmpBaseLine = QMAX( tmpBaseLine, c-&gt;ascent() );
04910                 tmph = tmpBaseLine + belowBaseLine;
04911                 <font class="comment">//qDebug(  " -&gt; tmpBaseLine/tmph : %d/%d", tmpBaseLine, tmph );</font>
04912         }
04913         minw = QMAX( minw, tminw );
04914         tminw = marg + ww;
04915             <font class="comment">// (combine lineStart and tmpBaseLine/tmph)</font>
04916             <font class="comment">//qDebug( "Breakable character: combining %d/%d with %d/%d", lineStart-&gt;baseLine, h, tmpBaseLine, tmph );</font>
04917             <font class="keywordtype">int</font> belowBaseLine = QMAX( h - lineStart-&gt;baseLine, tmph - tmpBaseLine );
04918             lineStart-&gt;baseLine = QMAX( lineStart-&gt;baseLine, tmpBaseLine );
04919         h = lineStart-&gt;baseLine + belowBaseLine;
04920             lineStart-&gt;h = h;
04921             <font class="comment">// if h &gt; initialHeight,  call adjust[LR]Margin, and if the result is != initial[LR]Margin,</font>
04922             <font class="comment">// format this line again</font>
04923             <font class="keywordflow">if</font> ( doc &amp;&amp; h &gt; initialHeight )
04924             {
04925                 <font class="keywordtype">int</font> newLMargin = doc-&gt;flow()-&gt;adjustLMargin( y + parag-&gt;rect().y(), h, left, 4 );
04926                 <font class="keywordtype">int</font> newRMargin = doc-&gt;flow()-&gt;adjustRMargin( y + parag-&gt;rect().y(), h, rm, 4 );
04927                 <font class="comment">//qDebug("new height: %d =&gt; newLMargin=%d newRMargin=%d", h, newLMargin, newRMargin);</font>
04928                 <font class="keywordflow">if</font> ( newLMargin != initialLMargin || newRMargin != initialRMargin )
04929                 {
04930                     <font class="comment">//qDebug("formatting again");</font>
04931                     i = firstCharIndex;
04932                     x = newLMargin;
04933                     w = dw - newRMargin;
04934                     initialLMargin = newLMargin;
04935                     initialRMargin = newRMargin;
04936                     initialHeight = h;
04937                     curLeft = x;
04938                     lastBreak = -1;
04939                     col = 0;
04940                     <font class="keywordflow">if</font> ( parag-&gt;isNewLinesAllowed() &amp;&amp; firstChar-&gt;c == <font class="charliteral">'\t'</font> ) {
04941                         <font class="keywordtype">int</font> nx = parag-&gt;nextTab( i, x );
04942                         <font class="keywordflow">if</font> ( nx &lt; x )
04943                             ww = w - x;
04944                         <font class="keywordflow">else</font>
04945                             ww = nx - x + 1;
04946                     }
04947                     <font class="comment">//minw ? tminw ?</font>
04948                 }
04949             }
04950 
04951             <font class="comment">//qDebug(  " -&gt; lineStart-&gt;baseLine/lineStart-&gt;h : %d/%d", lineStart-&gt;baseLine, lineStart-&gt;h );</font>
04952         <font class="keywordflow">if</font> ( i &lt; len - 2 || c-&gt;c != <font class="charliteral">' '</font> )
04953         lastBreak = i;
04954     } <font class="keywordflow">else</font> {
04955             <font class="comment">// Non-breakable character</font>
04956         tminw += ww;
04957             <font class="comment">//qDebug( " Non-breakable character: combining %d/%d with %d/%d", tmpBaseLine, tmph, c-&gt;ascent(), c-&gt;height()+ls );</font>
04958             <font class="comment">// (combine tmpBaseLine/tmph and this character)</font>
04959             <font class="keywordtype">int</font> belowBaseLine = QMAX( tmph - tmpBaseLine, c-&gt;height() - c-&gt;ascent() );
04960             tmpBaseLine = QMAX( tmpBaseLine, c-&gt;ascent() );
04961         tmph = tmpBaseLine + belowBaseLine;
04962             <font class="comment">//qDebug(  " -&gt; tmpBaseLine/tmph : %d/%d", tmpBaseLine, tmph );</font>
04963     }
04964 
04965     c-&gt;x = x;
04966         <font class="comment">//qDebug("setting c-&gt;x to %d",c-&gt;x);</font>
04967         <font class="keywordflow">if</font> ( c-&gt;isCustom() )
04968         {
04969             <font class="comment">//qDebug("custom item -&gt; moving to %d,%d",x,y);</font>
04970             c-&gt;customItem()-&gt;move( x, y );
04971         }
04972     x += ww;
04973         <font class="comment">//qDebug("added %d -&gt; now x=%d",ww,x);</font>
04974     }
04975 
04976     <font class="comment">// Finish formatting the last line</font>
04977     <font class="keywordflow">if</font> ( lineStart ) {
04978         <font class="comment">//qDebug( "Last Line.... Combining %d/%d with %d/%d", lineStart-&gt;baseLine, h, tmpBaseLine, tmph );</font>
04979         <font class="comment">// (combine lineStart and tmpBaseLine/tmph)</font>
04980         <font class="keywordtype">int</font> belowBaseLine = QMAX( h - lineStart-&gt;baseLine, tmph - tmpBaseLine );
04981         lineStart-&gt;baseLine = QMAX( lineStart-&gt;baseLine, tmpBaseLine );
04982         h = lineStart-&gt;baseLine + belowBaseLine;
04983     lineStart-&gt;h = h;
04984         <font class="comment">//qDebug(  " -&gt; lineStart-&gt;baseLine/lineStart-&gt;h : %d/%d", lineStart-&gt;baseLine, lineStart-&gt;h );</font>
04985     <font class="comment">// last line in a paragraph is not justified</font>
04986     <font class="keywordflow">if</font> ( align == Qt3::AlignJustify )
04987         align = Qt3::AlignAuto;
04988     QTextParagLineStart *lineStart2 = formatLine( parag, string, lineStart, firstChar, c, align, w - x );
04989         h += doc ? parag-&gt;lineSpacing( line++ ) : 0;
04990         lineStart-&gt;h = h;
04991     <font class="keyword">delete</font> lineStart2;
04992     }
04993 
04994     minw = QMAX( minw, tminw );
04995 
04996     <font class="keywordtype">int</font> m = parag-&gt;bottomMargin();
04997     <font class="keywordflow">if</font> ( parag-&gt;next() &amp;&amp; !doc-&gt;addMargins() )
04998     m = QMAX( m, parag-&gt;next()-&gt;topMargin() );
04999     parag-&gt;setFullWidth( fullWidth );
05000     <font class="keywordflow">if</font> ( is_printer( parag-&gt;painter() ) ) {
05001     QPaintDeviceMetrics metrics( parag-&gt;painter()-&gt;device() );
05002     <font class="keywordtype">double</font> yscale = scale_factor( metrics.logicalDpiY() );
05003     m = (int)( (double)m * yscale );
05004     }
05005     <font class="comment">//qDebug( "Adding h(%d) and bottomMargin(%d) to y(%d) =&gt; %d", h, m, y, y+h+m );</font>
05006     y += h + m;
05007     <font class="comment">//if ( doc &amp;&amp; doc-&gt;addMargins() )</font>
05008     <font class="comment">//    y -= parag-&gt;topMargin(); // Was already in y's initial value</font>
05009 
05010     <font class="keywordflow">if</font> ( !isWrapEnabled() )
05011     minw = QMAX( minw, c-&gt;x + ww ); <font class="comment">// #### Lars: Fix this for BiDi, please</font>
05012     <font class="keywordflow">if</font> ( doc ) {
05013     <font class="keywordflow">if</font> ( minw &lt; 32000 )
05014         doc-&gt;setMinimumWidth( minw, parag );
05015     }
05016 
05017     <font class="keywordflow">return</font> y;
05018 }
05019 
05020 <font class="comment">// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
05021 
05022 QTextIndent::QTextIndent()
05023 {
05024 }
05025 
05026 <font class="comment">// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
05027 
05028 QTextFormatCollection::QTextFormatCollection()
05029     : cKey( 307 ), sheet( 0 )
05030 {
05031 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05032 <font class="preprocessor"></font>    qDebug(<font class="stringliteral">"QTextFormatCollection::QTextFormatCollection %p"</font>, <font class="keyword">this</font>);
05033 <font class="preprocessor">#endif</font>
05034 <font class="preprocessor"></font>    defFormat = <font class="keyword">new</font> QTextFormat( QApplication::font(),
05035                  QApplication::palette().color( QPalette::Active, QColorGroup::Text ) );
05036     lastFormat = cres = 0;
05037     cflags = -1;
05038     cKey.setAutoDelete( TRUE );
05039     cachedFormat = 0;
05040 }
05041 
05042 QTextFormatCollection::~QTextFormatCollection()
05043 {
05044 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05045 <font class="preprocessor"></font>    qDebug(<font class="stringliteral">"QTextFormatCollection::~QTextFormatCollection %p"</font>, <font class="keyword">this</font>);
05046 <font class="preprocessor">#endif</font>
05047 <font class="preprocessor"></font>    <font class="keyword">delete</font> defFormat;
05048 }
05049 
05050 QTextFormat *QTextFormatCollection::format( <font class="keyword">const</font> QTextFormat *f )
05051 {
05052     <font class="keywordflow">if</font> ( f-&gt;parent() == <font class="keyword">this</font> || f == defFormat ) {
05053 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05054 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">" format(f) need '%s', best case!"</font>, f-&gt;key().latin1() );
05055 <font class="preprocessor">#endif</font>
05056 <font class="preprocessor"></font>    lastFormat = const_cast&lt;QTextFormat*&gt;(f);
05057     lastFormat-&gt;addRef();
05058     <font class="keywordflow">return</font> lastFormat;
05059     }
05060 
05061     <font class="keywordflow">if</font> ( f == lastFormat || ( lastFormat &amp;&amp; f-&gt;key() == lastFormat-&gt;key() ) ) {
05062 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05063 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">" format(f) need '%s', good case!"</font>, f-&gt;key().latin1() );
05064 <font class="preprocessor">#endif</font>
05065 <font class="preprocessor"></font>    lastFormat-&gt;addRef();
05066     <font class="keywordflow">return</font> lastFormat;
05067     }
05068 
05069 <font class="preprocessor">#if 0 // #### disabled, because if this format is not in the</font>
05070 <font class="preprocessor"></font> <font class="comment">// formatcollection, it doesn't get the painter through</font>
05071  <font class="comment">// QTextFormatCollection::setPainter() which breaks printing on</font>
05072  <font class="comment">// windows</font>
05073     <font class="keywordflow">if</font> ( f-&gt;isAnchor() ) {
05074     lastFormat = createFormat( *f );
05075     lastFormat-&gt;collection = 0;
05076     <font class="keywordflow">return</font> lastFormat;
05077     }
05078 <font class="preprocessor">#endif</font>
05079 <font class="preprocessor"></font>
05080     QTextFormat *fm = cKey.find( f-&gt;key() );
05081     <font class="keywordflow">if</font> ( fm ) {
05082 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05083 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">" format(f) need '%s', normal case!"</font>, f-&gt;key().latin1() );
05084 <font class="preprocessor">#endif</font>
05085 <font class="preprocessor"></font>    lastFormat = fm;
05086     lastFormat-&gt;addRef();
05087     <font class="keywordflow">return</font> lastFormat;
05088     }
05089 
05090 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05091 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">" format(f) need '%s', worst case!"</font>, f-&gt;key().latin1() );
05092 <font class="preprocessor">#endif</font>
05093 <font class="preprocessor"></font>    lastFormat = createFormat( *f );
05094     lastFormat-&gt;collection = <font class="keyword">this</font>;
05095     cKey.insert( lastFormat-&gt;key(), lastFormat );
05096     <font class="keywordflow">return</font> lastFormat;
05097 }
05098 
05099 QTextFormat *QTextFormatCollection::format( QTextFormat *of, QTextFormat *nf, <font class="keywordtype">int</font> flags )
05100 {
05101     <font class="keywordflow">if</font> ( cres &amp;&amp; kof == of-&gt;key() &amp;&amp; knf == nf-&gt;key() &amp;&amp; cflags == flags ) {
05102 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05103 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">" format(of,nf,flags) mix of '%s' and '%s, best case!"</font>, of-&gt;key().latin1(), nf-&gt;key().latin1() );
05104 <font class="preprocessor">#endif</font>
05105 <font class="preprocessor"></font>    cres-&gt;addRef();
05106     <font class="keywordflow">return</font> cres;
05107     }
05108 
05109 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05110 <font class="preprocessor"></font>    qDebug(<font class="stringliteral">" format(of,nf,%d) calling createFormat(of=%p %s)"</font>,flags,of,of-&gt;key().latin1());
05111 <font class="preprocessor">#endif</font>
05112 <font class="preprocessor"></font>    cres = createFormat( *of );
05113     kof = of-&gt;key();
05114     knf = nf-&gt;key();
05115     cflags = flags;
05116 
05117 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05118 <font class="preprocessor"></font>    qDebug(<font class="stringliteral">" format(of,nf,%d) calling copyFormat(nf=%p %s)"</font>,flags,nf,nf-&gt;key().latin1());
05119 <font class="preprocessor">#endif</font>
05120 <font class="preprocessor"></font>    cres-&gt;copyFormat( *nf, flags );
05121 
05122     QTextFormat *fm = cKey.find( cres-&gt;key() );
05123     <font class="keywordflow">if</font> ( !fm ) {
05124 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05125 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">" format(of,nf,flags) mix of '%s' and '%s, worst case!"</font>, of-&gt;key().latin1(), nf-&gt;key().latin1() );
05126 <font class="preprocessor">#endif</font>
05127 <font class="preprocessor"></font>    cres-&gt;collection = <font class="keyword">this</font>;
05128     cKey.insert( cres-&gt;key(), cres );
05129     } <font class="keywordflow">else</font> {
05130 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05131 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">" format(of,nf,flags) mix of '%s' and '%s, good case!"</font>, of-&gt;key().latin1(), nf-&gt;key().latin1() );
05132 <font class="preprocessor">#endif</font>
05133 <font class="preprocessor"></font>    <font class="keyword">delete</font> cres;
05134     cres = fm;
05135     cres-&gt;addRef();
05136     }
05137 
05138     <font class="keywordflow">return</font> cres;
05139 }
05140 
05141 QTextFormat *QTextFormatCollection::format( <font class="keyword">const</font> QFont &amp;f, <font class="keyword">const</font> QColor &amp;c )
05142 {
05143     <font class="keywordflow">if</font> ( cachedFormat &amp;&amp; cfont == f &amp;&amp; ccol == c ) {
05144 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05145 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">" format of font and col '%s' - best case"</font>, cachedFormat-&gt;key().latin1() );
05146 <font class="preprocessor">#endif</font>
05147 <font class="preprocessor"></font>    cachedFormat-&gt;addRef();
05148     <font class="keywordflow">return</font> cachedFormat;
05149     }
05150 
05151     QString key = QTextFormat::getKey( f, c, FALSE, QString::null, QString::null, QTextFormat::AlignNormal );
05152     cachedFormat = cKey.find( key );
05153     cfont = f;
05154     ccol = c;
05155 
05156     <font class="keywordflow">if</font> ( cachedFormat ) {
05157 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05158 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">" format of font and col '%s' - good case"</font>, cachedFormat-&gt;key().latin1() );
05159 <font class="preprocessor">#endif</font>
05160 <font class="preprocessor"></font>    cachedFormat-&gt;addRef();
05161     <font class="keywordflow">return</font> cachedFormat;
05162     }
05163 
05164     cachedFormat = createFormat( f, c );
05165     cachedFormat-&gt;collection = <font class="keyword">this</font>;
05166     cKey.insert( cachedFormat-&gt;key(), cachedFormat );
05167 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
05168 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">" format of font and col '%s' - worst case"</font>, cachedFormat-&gt;key().latin1() );
05169 <font class="preprocessor">#endif</font>
05170 <font class="preprocessor"></font>    <font class="keywordflow">return</font> cachedFormat;
05171 }
05172 
05173 <font class="keywordtype">void</font> QTextFormatCollection::remove( QTextFormat *f )
05174 {
05175     <font class="keywordflow">if</font> ( lastFormat == f )
05176     lastFormat = 0;
05177     <font class="keywordflow">if</font> ( cres == f )
05178     cres = 0;
05179     <font class="keywordflow">if</font> ( cachedFormat == f )
05180     cachedFormat = 0;
05181     cKey.remove( f-&gt;key() );
05182 }
05183 
05184 <font class="keywordtype">void</font> QTextFormatCollection::setPainter( QPainter *p )
05185 {
05186     QDictIterator&lt;QTextFormat&gt; it( cKey );
05187     QTextFormat *f;
05188     <font class="keywordflow">while</font> ( ( f = it.current() ) ) {
05189     ++it;
05190     f-&gt;setPainter( p );
05191     }
05192 }
05193 
05194 <font class="keywordtype">void</font> QTextFormatCollection::debug()
05195 {
05196     qDebug( <font class="stringliteral">"------------ QTextFormatCollection: debug --------------- BEGIN"</font> );
05197     QDictIterator&lt;QTextFormat&gt; it( cKey );
05198     <font class="keywordflow">for</font> ( ; it.current(); ++it ) {
05199     qDebug( <font class="stringliteral">"format '%s' (%p): refcount: %d"</font>, it.current()-&gt;key().latin1(),
05200         it.current(), it.current()-&gt;ref );
05201     }
05202     qDebug( <font class="stringliteral">"------------ QTextFormatCollection: debug --------------- END"</font> );
05203 }
05204 
05205 <font class="keywordtype">void</font> QTextFormatCollection::updateStyles()
05206 {
05207     QDictIterator&lt;QTextFormat&gt; it( cKey );
05208     QTextFormat *f;
05209     <font class="keywordflow">while</font> ( ( f = it.current() ) ) {
05210     ++it;
05211     f-&gt;updateStyle();
05212     }
05213 }
05214 
05215 <font class="keywordtype">void</font> QTextFormatCollection::updateFontSizes( <font class="keywordtype">int</font> base )
05216 {
05217     QDictIterator&lt;QTextFormat&gt; it( cKey );
05218     QTextFormat *f;
05219     <font class="keywordflow">while</font> ( ( f = it.current() ) ) {
05220     ++it;
05221     f-&gt;stdPointSize = base;
05222     f-&gt;fn.setPointSize( f-&gt;stdPointSize );
05223     styleSheet()-&gt;scaleFont( f-&gt;fn, f-&gt;logicalFontSize );
05224     f-&gt;update();
05225     }
05226     f = defFormat;
05227     f-&gt;stdPointSize = base;
05228     f-&gt;fn.setPointSize( f-&gt;stdPointSize );
05229     styleSheet()-&gt;scaleFont( f-&gt;fn, f-&gt;logicalFontSize );
05230     f-&gt;update();
05231 }
05232 
05233 <font class="keywordtype">void</font> QTextFormatCollection::updateFontAttributes( <font class="keyword">const</font> QFont &amp;f, <font class="keyword">const</font> QFont &amp;old )
05234 {
05235     QDictIterator&lt;QTextFormat&gt; it( cKey );
05236     QTextFormat *fm;
05237     <font class="keywordflow">while</font> ( ( fm = it.current() ) ) {
05238     ++it;
05239     <font class="keywordflow">if</font> ( fm-&gt;fn.family() == old.family() &amp;&amp;
05240          fm-&gt;fn.weight() == old.weight() &amp;&amp;
05241          fm-&gt;fn.italic() == old.italic() &amp;&amp;
05242          fm-&gt;fn.underline() == old.underline() ) {
05243         fm-&gt;fn.setFamily( f.family() );
05244         fm-&gt;fn.setWeight( f.weight() );
05245         fm-&gt;fn.setItalic( f.italic() );
05246         fm-&gt;fn.setUnderline( f.underline() );
05247         fm-&gt;update();
05248     }
05249     }
05250     fm = defFormat;
05251     <font class="keywordflow">if</font> ( fm-&gt;fn.family() == old.family() &amp;&amp;
05252      fm-&gt;fn.weight() == old.weight() &amp;&amp;
05253      fm-&gt;fn.italic() == old.italic() &amp;&amp;
05254      fm-&gt;fn.underline() == old.underline() ) {
05255     fm-&gt;fn.setFamily( f.family() );
05256     fm-&gt;fn.setWeight( f.weight() );
05257     fm-&gt;fn.setItalic( f.italic() );
05258     fm-&gt;fn.setUnderline( f.underline() );
05259     fm-&gt;update();
05260     }
05261 }
05262 
05263 <font class="comment">// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
05264 
05265 <font class="keywordtype">void</font> QTextFormat::copyFormat( <font class="keyword">const</font> QTextFormat &amp; nf, <font class="keywordtype">int</font> flags )
05266 {
05267     <font class="keywordflow">if</font> ( flags &amp; QTextFormat::Bold )
05268     fn.setBold( nf.fn.bold() );
05269     <font class="keywordflow">if</font> ( flags &amp; QTextFormat::Italic )
05270     fn.setItalic( nf.fn.italic() );
05271     <font class="keywordflow">if</font> ( flags &amp; QTextFormat::Underline )
05272     fn.setUnderline( nf.fn.underline() );
05273     <font class="keywordflow">if</font> ( flags &amp; QTextFormat::Family )
05274     fn.setFamily( nf.fn.family() );
05275     <font class="keywordflow">if</font> ( flags &amp; QTextFormat::Size )
05276     fn.setPointSize( nf.fn.pointSize() );
05277     <font class="keywordflow">if</font> ( flags &amp; QTextFormat::Color )
05278     col = nf.col;
05279     <font class="keywordflow">if</font> ( flags &amp; QTextFormat::Misspelled )
05280     missp = nf.missp;
05281     <font class="keywordflow">if</font> ( flags &amp; QTextFormat::VAlign )
05282     ha = nf.ha;
05283     update();
05284 }
05285 
05286 <font class="keywordtype">void</font> QTextFormat::setBold( <font class="keywordtype">bool</font> b )
05287 {
05288     <font class="keywordflow">if</font> ( b == fn.bold() )
05289     <font class="keywordflow">return</font>;
05290     fn.setBold( b );
05291     update();
05292 }
05293 
05294 <font class="keywordtype">void</font> QTextFormat::setMisspelled( <font class="keywordtype">bool</font> b )
05295 {
05296     <font class="keywordflow">if</font> ( b == (bool)missp )
05297     <font class="keywordflow">return</font>;
05298     missp = b;
05299     update();
05300 }
05301 
05302 <font class="keywordtype">void</font> QTextFormat::setVAlign( VerticalAlignment a )
05303 {
05304     <font class="keywordflow">if</font> ( a == ha )
05305     <font class="keywordflow">return</font>;
05306     ha = a;
05307     update();
05308 }
05309 
05310 <font class="keywordtype">void</font> QTextFormat::setItalic( <font class="keywordtype">bool</font> b )
05311 {
05312     <font class="keywordflow">if</font> ( b == fn.italic() )
05313     <font class="keywordflow">return</font>;
05314     fn.setItalic( b );
05315     update();
05316 }
05317 
05318 <font class="keywordtype">void</font> QTextFormat::setUnderline( <font class="keywordtype">bool</font> b )
05319 {
05320     <font class="keywordflow">if</font> ( b == fn.underline() )
05321     <font class="keywordflow">return</font>;
05322     fn.setUnderline( b );
05323     update();
05324 }
05325 
05326 <font class="keywordtype">void</font> QTextFormat::setFamily( <font class="keyword">const</font> QString &amp;f )
05327 {
05328     <font class="keywordflow">if</font> ( f == fn.family() )
05329     <font class="keywordflow">return</font>;
05330     fn.setFamily( f );
05331 
05332 <font class="comment">//ANY_CHARSET_BEGIN</font>
05333   <font class="keywordflow">if</font> ( m_charsetMap &amp;&amp; m_charsetMap-&gt;contains(f) ) {
05334         fn.setCharSet((*m_charsetMap)[f]);
05335   }
05336 <font class="comment">//ANY_CHARSET_END</font>
05337     update();
05338 }
05339 
05340 <font class="keywordtype">void</font> QTextFormat::setPointSize( <font class="keywordtype">int</font> s )
05341 {
05342     <font class="keywordflow">if</font> ( s == fn.pointSize() )
05343     <font class="keywordflow">return</font>;
05344     fn.setPointSize( s );
05345     update();
05346 }
05347 
05348 <font class="keywordtype">void</font> QTextFormat::setFont( <font class="keyword">const</font> QFont &amp;f )
05349 {
05350     <font class="keywordflow">if</font> ( f == fn &amp;&amp; !k.isEmpty() )
05351     <font class="keywordflow">return</font>;
05352     fn = f;
05353 <font class="comment">//ANY_CHARSET_BEGIN</font>
05354     <font class="keywordflow">if</font> (m_charsetMap &amp;&amp; m_charsetMap-&gt;contains(fn.family()))
05355         fn.setCharSet((*m_charsetMap)[fn.family()]);
05356 <font class="comment">//ANY_CHARSET_END</font>
05357     update();
05358 }
05359 
05360 <font class="keywordtype">void</font> QTextFormat::setColor( <font class="keyword">const</font> QColor &amp;c )
05361 {
05362     <font class="keywordflow">if</font> ( c == col )
05363     <font class="keywordflow">return</font>;
05364     col = c;
05365     update();
05366 }
05367 
05368 <font class="keywordtype">void</font> QTextFormat::setPainter( QPainter *p )
05369 {
05370     painter = p;
05371     update();
05372 }
05373 
05374 <font class="keyword">static</font> <font class="keywordtype">int</font> makeLogicFontSize( <font class="keywordtype">int</font> s )
05375 {
05376     <font class="keywordtype">int</font> defSize = QApplication::font().pointSize();
05377     <font class="keywordflow">if</font> ( s &lt; defSize - 4 )
05378     <font class="keywordflow">return</font> 1;
05379     <font class="keywordflow">if</font> ( s &lt; defSize )
05380     <font class="keywordflow">return</font> 2;
05381     <font class="keywordflow">if</font> ( s &lt; defSize + 4 )
05382     <font class="keywordflow">return</font> 3;
05383     <font class="keywordflow">if</font> ( s &lt; defSize + 8 )
05384     <font class="keywordflow">return</font> 4;
05385     <font class="keywordflow">if</font> ( s &lt; defSize + 12 )
05386     <font class="keywordflow">return</font> 5;
05387     <font class="keywordflow">if</font> (s &lt; defSize + 16 )
05388     <font class="keywordflow">return</font> 6;
05389     <font class="keywordflow">return</font> 7;
05390 }
05391 
05392 <font class="keyword">static</font> QTextFormat *defaultFormat = 0;
05393 
05394 QString QTextFormat::makeFormatChangeTags( QTextFormat *f )<font class="keyword"> const</font>
05395 <font class="keyword"></font>{
05396     <font class="keywordflow">if</font> ( !defaultFormat )
05397     defaultFormat = <font class="keyword">new</font> QTextFormat( QApplication::font(),
05398                          QApplication::palette().color( QPalette::Active, QColorGroup::Text ) );
05399 
05400     QString tag;
05401 
05402     <font class="keywordflow">if</font> ( f ) {
05403     <font class="keywordflow">if</font> ( f-&gt;font() != defaultFormat-&gt;font() ||
05404          f-&gt;color().rgb() != defaultFormat-&gt;color().rgb() )
05405         tag += <font class="stringliteral">"&lt;/font&gt;"</font>;
05406     <font class="keywordflow">if</font> ( f-&gt;font() != defaultFormat-&gt;font() ) {
05407         <font class="keywordflow">if</font> ( f-&gt;font().underline() &amp;&amp; f-&gt;font().underline() != defaultFormat-&gt;font().underline() )
05408         tag += <font class="stringliteral">"&lt;/u&gt;"</font>;
05409         <font class="keywordflow">if</font> ( f-&gt;font().italic() &amp;&amp; f-&gt;font().italic() != defaultFormat-&gt;font().italic() )
05410         tag += <font class="stringliteral">"&lt;/i&gt;"</font>;
05411         <font class="keywordflow">if</font> ( f-&gt;font().bold() &amp;&amp; f-&gt;font().bold() != defaultFormat-&gt;font().bold() )
05412         tag += <font class="stringliteral">"&lt;/b&gt;"</font>;
05413     }
05414     <font class="keywordflow">if</font> ( f-&gt;isAnchor() &amp;&amp; !f-&gt;anchorHref().isEmpty() )
05415         tag += <font class="stringliteral">"&lt;/a&gt;"</font>;
05416     }
05417 
05418     <font class="keywordflow">if</font> ( isAnchor() ) {
05419     <font class="keywordflow">if</font> ( !anchor_href.isEmpty() )
05420         tag += <font class="stringliteral">"&lt;a href=\""</font> + anchor_href + <font class="stringliteral">"\"&gt;"</font>;
05421     <font class="keywordflow">else</font>
05422         tag += <font class="stringliteral">"&lt;a name=\""</font> + anchor_name + <font class="stringliteral">"\"&gt;&lt;/a&gt;"</font>;
05423     }
05424 
05425     <font class="keywordflow">if</font> ( font() != defaultFormat-&gt;font() ) {
05426     <font class="keywordflow">if</font> ( font().bold() &amp;&amp; font().bold() != defaultFormat-&gt;font().bold() )
05427         tag += <font class="stringliteral">"&lt;b&gt;"</font>;
05428     <font class="keywordflow">if</font> ( font().italic() &amp;&amp; font().italic() != defaultFormat-&gt;font().italic() )
05429         tag += <font class="stringliteral">"&lt;i&gt;"</font>;
05430     <font class="keywordflow">if</font> ( font().underline() &amp;&amp; font().underline() != defaultFormat-&gt;font().underline() )
05431         tag += <font class="stringliteral">"&lt;u&gt;"</font>;
05432     }
05433     <font class="keywordflow">if</font> ( font() != defaultFormat-&gt;font() ||
05434      color().rgb() != defaultFormat-&gt;color().rgb() ) {
05435     tag += <font class="stringliteral">"&lt;font "</font>;
05436     <font class="keywordflow">if</font> ( font().family() != defaultFormat-&gt;font().family() )
05437         tag +=<font class="stringliteral">"face=\""</font> + fn.family() + <font class="stringliteral">"\" "</font>;
05438     <font class="keywordflow">if</font> ( font().pointSize() != defaultFormat-&gt;font().pointSize() )
05439         tag +=<font class="stringliteral">"size=\""</font> + QString::number( makeLogicFontSize( fn.pointSize() ) ) + <font class="stringliteral">"\" "</font>;
05440     <font class="keywordflow">if</font> ( color().rgb() != defaultFormat-&gt;color().rgb() )
05441         tag +=<font class="stringliteral">"color=\""</font> + col.name() + <font class="stringliteral">"\" "</font>;
05442     tag += <font class="stringliteral">"&gt;"</font>;
05443     }
05444 
05445     <font class="keywordflow">return</font> tag;
05446 }
05447 
05448 QString QTextFormat::makeFormatEndTags()<font class="keyword"> const</font>
05449 <font class="keyword"></font>{
05450     <font class="keywordflow">if</font> ( !defaultFormat )
05451     defaultFormat = <font class="keyword">new</font> QTextFormat( QApplication::font(),
05452                          QApplication::palette().color( QPalette::Active, QColorGroup::Text ) );
05453 
05454     QString tag;
05455     <font class="keywordflow">if</font> ( font() != defaultFormat-&gt;font() ||
05456      color().rgb() != defaultFormat-&gt;color().rgb() )
05457     tag += <font class="stringliteral">"&lt;/font&gt;"</font>;
05458     <font class="keywordflow">if</font> ( font() != defaultFormat-&gt;font() ) {
05459     <font class="keywordflow">if</font> ( font().underline() &amp;&amp; font().underline() != defaultFormat-&gt;font().underline() )
05460         tag += <font class="stringliteral">"&lt;/u&gt;"</font>;
05461     <font class="keywordflow">if</font> ( font().italic() &amp;&amp; font().italic() != defaultFormat-&gt;font().italic() )
05462         tag += <font class="stringliteral">"&lt;/i&gt;"</font>;
05463     <font class="keywordflow">if</font> ( font().bold() &amp;&amp; font().bold() != defaultFormat-&gt;font().bold() )
05464         tag += <font class="stringliteral">"&lt;/b&gt;"</font>;
05465     }
05466     <font class="keywordflow">if</font> ( isAnchor() &amp;&amp; anchorHref().isEmpty() )
05467     tag += <font class="stringliteral">"&lt;/a&gt;"</font>;
05468     <font class="keywordflow">return</font> tag;
05469 }
05470 
05471 QTextFormat QTextFormat::makeTextFormat( <font class="keyword">const</font> <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *style, <font class="keyword">const</font> QMap&lt;QString,QString&gt;&amp; attr )<font class="keyword"> const</font>
05472 <font class="keyword"></font>{
05473     QTextFormat format(*<font class="keyword">this</font>);
05474     <font class="keywordtype">bool</font> changed = FALSE;
05475     <font class="keywordflow">if</font> ( style ) {
05476     format.style = style-&gt;name();
05477     <font class="keywordflow">if</font> ( style-&gt;name() == <font class="stringliteral">"font"</font>) {
05478         <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"color"</font>) ) {
05479         QString s = attr[<font class="stringliteral">"color"</font>];
05480         <font class="keywordflow">if</font> ( !s.isEmpty() ) {
05481             format.col.setNamedColor( s );
05482             format.linkColor = FALSE;
05483         }
05484         }
05485         <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"size"</font>) ) {
05486         QString a = attr[<font class="stringliteral">"size"</font>];
05487         <font class="keywordtype">int</font> n = a.toInt();
05488         <font class="keywordflow">if</font> ( a[0] == <font class="charliteral">'+'</font> || a[0] == <font class="charliteral">'-'</font> )
05489             n += format.logicalFontSize;
05490         format.logicalFontSize = n;
05491         format.fn.setPointSize( format.stdPointSize );
05492         style-&gt;styleSheet()-&gt;scaleFont( format.fn, format.logicalFontSize );
05493         }
05494         <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"face"</font>) ) {
05495         QString a = attr[<font class="stringliteral">"face"</font>];
05496         <font class="keywordflow">if</font> ( a.contains(<font class="charliteral">','</font>) )
05497             a = a.left( a.find(<font class="charliteral">','</font>) );
05498         format.fn.setFamily( a );
05499 <font class="comment">//ANY_CHARSET_BEGIN     </font>
05500         <font class="keywordflow">if</font> (m_charsetMap &amp;&amp; m_charsetMap-&gt;contains(format.fn.family())) {
05501             format.fn.setCharSet((*m_charsetMap)[format.fn.family()]);
05502         }
05503 <font class="comment">//ANY_CHARSET_END</font>
05504         }
05505     } <font class="keywordflow">else</font> {
05506 
05507         <font class="keywordflow">if</font> ( style-&gt;isAnchor() ) {
05508         format.anchor_href = attr[<font class="stringliteral">"href"</font>];
05509         format.anchor_name = attr[<font class="stringliteral">"name"</font>];
05510         changed = TRUE;
05511         }
05512 
05513         <font class="keywordflow">if</font> ( style-&gt;fontWeight() != QStyleSheetItem::Undefined )
05514         format.fn.setWeight( style-&gt;fontWeight() );
05515         <font class="keywordflow">if</font> ( style-&gt;fontSize() != QStyleSheetItem::Undefined )
05516         format.fn.setPointSize( style-&gt;fontSize() );
05517         <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( style-&gt;logicalFontSize() != QStyleSheetItem::Undefined ) {
05518         format.logicalFontSize = style-&gt;logicalFontSize();
05519         format.fn.setPointSize( format.stdPointSize );
05520         style-&gt;styleSheet()-&gt;scaleFont( format.fn, format.logicalFontSize );
05521         }
05522         <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( style-&gt;logicalFontSizeStep() ) {
05523         format.logicalFontSize += style-&gt;logicalFontSizeStep();
05524         format.fn.setPointSize( format.stdPointSize );
05525         style-&gt;styleSheet()-&gt;scaleFont( format.fn, format.logicalFontSize );
05526         }
05527         <font class="keywordflow">if</font> ( !style-&gt;fontFamily().isEmpty() )
05528         format.fn.setFamily( style-&gt;fontFamily() );
05529 <font class="comment">//ANY_CHARSET_BEGIN</font>
05530         <font class="keywordflow">if</font> ( !style-&gt;fontFamily().isEmpty() )
05531         <font class="keywordflow">if</font> (m_charsetMap &amp;&amp; m_charsetMap-&gt;contains(style-&gt;fontFamily()))
05532             format.fn.setCharSet( (*m_charsetMap)[style-&gt;fontFamily()] );
05533 <font class="comment">//ANY_CHARSET_END</font>
05534         <font class="keywordflow">if</font> ( style-&gt;color().isValid() )
05535         format.col = style-&gt;color();
05536         <font class="keywordflow">if</font> ( style-&gt;definesFontItalic() )
05537         format.fn.setItalic( style-&gt;fontItalic() );
05538         <font class="keywordflow">if</font> ( style-&gt;definesFontUnderline() )
05539         format.fn.setUnderline( style-&gt;fontUnderline() );
05540     }
05541     }
05542 
05543     <font class="keywordflow">if</font> ( fn != format.fn || changed || col != format.col ) <font class="comment">// slight performance improvement</font>
05544     format.generateKey();
05545     format.update();
05546     <font class="keywordflow">return</font> format;
05547 }
05548 
05549 QTextCustomItem::QTextCustomItem( QTextDocument *p )
05550       :  width(-1), height(0), parent(p), xpos(0), ypos(-1), parag(0)
05551 {
05552 }
05553 
05554 QTextCustomItem::~QTextCustomItem()
05555 {
05556 }
05557 
05558 <font class="keyword">struct </font>QPixmapInt
05559 {
05560     QPixmapInt() : ref( 0 ) {}
05561     QPixmap pm;
05562     <font class="keywordtype">int</font>     ref;
05563 };
05564 
05565 <font class="keyword">static</font> QMap&lt;QString, QPixmapInt&gt; *pixmap_map = 0;
05566 
05567 QTextImage::QTextImage( QTextDocument *p, <font class="keyword">const</font> QMap&lt;QString, QString&gt; &amp;attr, <font class="keyword">const</font> QString&amp; context,
05568             QMimeSourceFactory &amp;factory )
05569     : QTextCustomItem( p )
05570 {
05571 <font class="preprocessor">#if defined(PARSER_DEBUG)</font>
05572 <font class="preprocessor"></font>    qDebug( debug_indent + <font class="stringliteral">"new QTextImage (pappi: %p)"</font>, p );
05573 <font class="preprocessor">#endif</font>
05574 <font class="preprocessor"></font>
05575     width = height = 0;
05576     <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"width"</font>) )
05577     width = attr[<font class="stringliteral">"width"</font>].toInt();
05578     <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"height"</font>) )
05579     height = attr[<font class="stringliteral">"height"</font>].toInt();
05580 
05581     reg = 0;
05582     QString imageName = attr[<font class="stringliteral">"src"</font>];
05583 
05584     <font class="keywordflow">if</font> (!imageName)
05585     imageName = attr[<font class="stringliteral">"source"</font>];
05586 
05587 <font class="preprocessor">#if defined(PARSER_DEBUG)</font>
05588 <font class="preprocessor"></font>    qDebug( debug_indent + <font class="stringliteral">"    .."</font> + imageName );
05589 <font class="preprocessor">#endif</font>
05590 <font class="preprocessor"></font>
05591     <font class="keywordflow">if</font> ( !imageName.isEmpty() ) {
05592     imgId = QString( <font class="stringliteral">"%1,%2,%3,%4"</font> ).arg( imageName ).arg( width ).arg( height ).arg( (ulong)&amp;factory );
05593     <font class="keywordflow">if</font> ( !pixmap_map )
05594         pixmap_map = <font class="keyword">new</font> QMap&lt;QString, QPixmapInt&gt;;
05595     <font class="keywordflow">if</font> ( pixmap_map-&gt;contains( imgId ) ) {
05596         QPixmapInt&amp; pmi = pixmap_map-&gt;operator[](imgId);
05597         pm = pmi.pm;
05598         pmi.ref++;
05599         width = pm.width();
05600         height = pm.height();
05601     } <font class="keywordflow">else</font> {
05602         QImage img;
05603         <font class="keyword">const</font> QMimeSource* m =
05604         factory.data( imageName, context );
05605         <font class="keywordflow">if</font> ( !m ) {
05606         qWarning(<font class="stringliteral">"QTextImage: no mimesource for %s"</font>, imageName.latin1() );
05607         }
05608         <font class="keywordflow">else</font> {
05609         <font class="keywordflow">if</font> ( !QImageDrag::decode( m, img ) ) {
05610             qWarning(<font class="stringliteral">"QTextImage: cannot decode %s"</font>, imageName.latin1() );
05611         }
05612         }
05613 
05614         <font class="keywordflow">if</font> ( !img.isNull() ) {
05615         <font class="keywordflow">if</font> ( width == 0 ) {
05616             width = img.width();
05617             <font class="keywordflow">if</font> ( height != 0 ) {
05618             width = img.width() * height / img.height();
05619             }
05620         }
05621         <font class="keywordflow">if</font> ( height == 0 ) {
05622             height = img.height();
05623             <font class="keywordflow">if</font> ( width != img.width() ) {
05624             height = img.height() * width / img.width();
05625             }
05626         }
05627 
05628         <font class="keywordflow">if</font> ( img.width() != width || img.height() != height ){
05629             img = img.smoothScale(width, height);
05630             width = img.width();
05631             height = img.height();
05632         }
05633         pm.convertFromImage( img );
05634         }
05635         <font class="keywordflow">if</font> ( !pm.isNull() ) {
05636         QPixmapInt&amp; pmi = pixmap_map-&gt;operator[](imgId);
05637         pmi.pm = pm;
05638         pmi.ref++;
05639         }
05640     }
05641     <font class="keywordflow">if</font> ( pm.mask() ) {
05642         QRegion mask( *pm.mask() );
05643         QRegion all( 0, 0, pm.width(), pm.height() );
05644         reg = <font class="keyword">new</font> QRegion( all.subtract( mask ) );
05645     }
05646     }
05647 
05648     <font class="keywordflow">if</font> ( pm.isNull() &amp;&amp; (width*height)==0 )
05649     width = height = 50;
05650 
05651     place = PlaceInline;
05652     <font class="keywordflow">if</font> ( attr[<font class="stringliteral">"align"</font>] == <font class="stringliteral">"left"</font> )
05653     place = PlaceLeft;
05654     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( attr[<font class="stringliteral">"align"</font>] == <font class="stringliteral">"right"</font> )
05655     place = PlaceRight;
05656 
05657     tmpwidth = width;
05658     tmpheight = height;
05659 
05660     attributes = attr;
05661 }
05662 
05663 QTextImage::~QTextImage()
05664 {
05665     <font class="keywordflow">if</font> ( pixmap_map &amp;&amp; pixmap_map-&gt;contains( imgId ) ) {
05666     QPixmapInt&amp; pmi = pixmap_map-&gt;operator[](imgId);
05667     pmi.ref--;
05668     <font class="keywordflow">if</font> ( !pmi.ref ) {
05669         pixmap_map-&gt;remove( imgId );
05670         <font class="keywordflow">if</font> ( pixmap_map-&gt;isEmpty() ) {
05671         <font class="keyword">delete</font> pixmap_map;
05672         pixmap_map = 0;
05673         }
05674     }
05675     }
05676 }
05677 
05678 QString QTextImage::richText()<font class="keyword"> const</font>
05679 <font class="keyword"></font>{
05680     QString s;
05681     s += <font class="stringliteral">"&lt;img "</font>;
05682     QMap&lt;QString, QString&gt;::ConstIterator it = attributes.begin();
05683     <font class="keywordflow">for</font> ( ; it != attributes.end(); ++it )
05684     s += it.key() + <font class="stringliteral">"="</font> + *it + <font class="stringliteral">" "</font>;
05685     s += <font class="stringliteral">"&gt;"</font>;
05686     <font class="keywordflow">return</font> s;
05687 }
05688 
05689 <font class="keywordtype">void</font> QTextImage::adjustToPainter( QPainter* p )
05690 {
05691     width = tmpwidth;
05692     height = tmpheight;
05693     <font class="keywordflow">if</font> ( !is_printer( p ) )
05694     <font class="keywordflow">return</font>;
05695     QPaintDeviceMetrics metrics(p-&gt;device());
05696     width = int( width * scale_factor( metrics.logicalDpiX() ) );
05697     height = int( height * scale_factor( metrics.logicalDpiY() ) );
05698 }
05699 
05700 <font class="preprocessor">#if !defined(Q_WS_X11)</font>
05701 <font class="preprocessor"></font><font class="preprocessor">#include &lt;qbitmap.h&gt;</font>
05702 <font class="preprocessor">#include &lt;qcleanuphandler.h&gt;</font>
05703 <font class="keyword">static</font> QPixmap *qrt_selection = 0;
05704 <font class="keyword">static</font> QCleanupHandler&lt;QPixmap&gt; qrt_cleanup_pixmap;
05705 <font class="keyword">static</font> <font class="keywordtype">void</font> qrt_createSelectionPixmap( <font class="keyword">const</font> QColorGroup &amp;cg )
05706 {
05707     qrt_selection = <font class="keyword">new</font> QPixmap( 2, 2 );
05708     qrt_cleanup_pixmap.add( qrt_selection );
05709     qrt_selection-&gt;fill( Qt::color0 );
05710     QBitmap m( 2, 2 );
05711     m.fill( Qt::color1 );
05712     QPainter p( &amp;m );
05713     p.setPen( Qt::color0 );
05714     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> j = 0; j &lt; 2; ++j ) {
05715     p.drawPoint( j % 2, j );
05716     }
05717     p.end();
05718     qrt_selection-&gt;setMask( m );
05719     qrt_selection-&gt;fill( cg.highlight() );
05720 }
05721 <font class="preprocessor">#endif</font>
05722 <font class="preprocessor"></font>
05723 <font class="keywordtype">void</font> QTextImage::draw( QPainter* p, <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y, <font class="keywordtype">int</font> cx, <font class="keywordtype">int</font> cy, <font class="keywordtype">int</font> cw, <font class="keywordtype">int</font> ch, <font class="keyword">const</font> QColorGroup&amp; cg, <font class="keywordtype">bool</font> selected )
05724 {
05725     <font class="keywordflow">if</font> ( placement() != PlaceInline ) {
05726     x = xpos;
05727     y = ypos;
05728     }
05729 
05730     <font class="keywordflow">if</font> ( pm.isNull() ) {
05731     p-&gt;fillRect( x , y, width, height,  cg.dark() );
05732     <font class="keywordflow">return</font>;
05733     }
05734 
05735     <font class="keywordflow">if</font> ( is_printer( p ) ) {
05736 <font class="preprocessor">#ifndef QT_NO_TRANSFORMATIONS</font>
05737 <font class="preprocessor"></font>    p-&gt;saveWorldMatrix();
05738     QPaintDeviceMetrics metrics( p-&gt;device() );
05739     p-&gt;translate( x, y );
05740     p-&gt;scale( scale_factor( metrics.logicalDpiY() ),
05741           scale_factor( metrics.logicalDpiY() ) );
05742     p-&gt;drawPixmap( 0, 0, pm );
05743     p-&gt;restoreWorldMatrix();
05744 <font class="preprocessor">#else</font>
05745 <font class="preprocessor"></font>    p-&gt;drawPixmap( x, y, pm );
05746 <font class="preprocessor">#endif</font>
05747 <font class="preprocessor"></font>    <font class="keywordflow">return</font>;
05748     }
05749 
05750     <font class="keywordflow">if</font> ( placement() != PlaceInline &amp;&amp; !QRect( xpos, ypos, width, height ).intersects( QRect( cx, cy, cw, ch ) ) )
05751     <font class="keywordflow">return</font>;
05752 
05753     <font class="keywordflow">if</font> ( placement() == PlaceInline )
05754     p-&gt;drawPixmap( x , y, pm );
05755     <font class="keywordflow">else</font>
05756     p-&gt;drawPixmap( cx , cy, pm, cx - x, cy - y, cw, ch );
05757 
05758     <font class="keywordflow">if</font> ( selected &amp;&amp; placement() == PlaceInline &amp;&amp; p-&gt;device()-&gt;devType() != QInternal::Printer ) {
05759     p-&gt;save();
05760 <font class="preprocessor">#if defined(Q_WS_X11)</font>
05761 <font class="preprocessor"></font>    p-&gt;fillRect( QRect( QPoint( x, y ), pm.size() ), QBrush( cg.highlight(), QBrush::Dense4Pattern) );
05762 <font class="preprocessor">#else // in WIN32 Dense4Pattern doesn't work correctly (transparency problem), so work around it</font>
05763 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( !qrt_selection )
05764         qrt_createSelectionPixmap( cg );
05765     p-&gt;drawTiledPixmap( x, y, pm.width(), pm.height(), *qrt_selection );
05766 <font class="preprocessor">#endif</font>
05767 <font class="preprocessor"></font>    }
05768 }
05769 
05770 <font class="keywordtype">void</font> QTextHorizontalLine::adjustToPainter( QPainter* p )
05771 {
05772     <font class="keywordflow">if</font> ( !is_printer( p ) )
05773     <font class="keywordflow">return</font>;
05774     QPaintDeviceMetrics metrics(p-&gt;device());
05775     height = int( tmpheight * scale_factor( metrics.logicalDpiY() ) );
05776 }
05777 
05778 
05779 QTextHorizontalLine::QTextHorizontalLine( QTextDocument *p )
05780     : QTextCustomItem( p )
05781 {
05782     height = tmpheight = 8;
05783 }
05784 
05785 QTextHorizontalLine::~QTextHorizontalLine()
05786 {
05787 }
05788 
05789 QString QTextHorizontalLine::richText()<font class="keyword"> const</font>
05790 <font class="keyword"></font>{
05791     <font class="keywordflow">return</font> <font class="stringliteral">"&lt;hr&gt;"</font>;
05792 }
05793 
05794 <font class="keywordtype">void</font> QTextHorizontalLine::draw( QPainter* p, <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y, <font class="keywordtype">int</font> , <font class="keywordtype">int</font> , <font class="keywordtype">int</font> , <font class="keywordtype">int</font> , <font class="keyword">const</font> QColorGroup&amp; cg, <font class="keywordtype">bool</font> selected )
05795 {
05796     QRect r( x, y, width, height);
05797     <font class="keywordflow">if</font> ( is_printer( p ) || ( p &amp;&amp; p-&gt;device() &amp;&amp; p-&gt;device()-&gt;devType() == QInternal::Printer ) ) {
05798     QPen oldPen = p-&gt;pen();
05799     p-&gt;setPen( QPen( cg.text(), height/8 ) );
05800     p-&gt;drawLine( r.left()-1, y + height / 2, r.right() + 1, y + height / 2 );
05801     p-&gt;setPen( oldPen );
05802     } <font class="keywordflow">else</font> {
05803     <font class="keywordflow">if</font> ( selected )
05804         p-&gt;fillRect( r.left(), y, r.right(), y + height, cg.highlight() );
05805     qDrawShadeLine( p, r.left() - 1, y + height / 2, r.right() + 1, y + height / 2, cg, TRUE, height / 8 );
05806     }
05807 }
05808 
05809 
05810 <font class="comment">/*****************************************************************/</font>
05811 <font class="comment">// Small set of utility functions to make the parser a bit simpler</font>
05812 <font class="comment">//</font>
05813 
05814 <font class="keywordtype">bool</font> QTextDocument::hasPrefix(<font class="keyword">const</font> QString&amp; doc, <font class="keywordtype">int</font> pos, QChar c)
05815 {
05816     <font class="keywordflow">if</font> ( pos &gt;= (int)doc.length() )
05817     <font class="keywordflow">return</font> FALSE;
05818     <font class="keywordflow">return</font> ( doc.unicode() )[ pos ].lower() == c.lower();
05819 }
05820 
05821 <font class="keywordtype">bool</font> QTextDocument::hasPrefix( <font class="keyword">const</font> QString&amp; doc, <font class="keywordtype">int</font> pos, <font class="keyword">const</font> QString&amp; s )
05822 {
05823     <font class="keywordflow">if</font> ( pos + s.length() &gt;= doc.length() )
05824     <font class="keywordflow">return</font> FALSE;
05825     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)s.length(); i++ ) {
05826     <font class="keywordflow">if</font> ( ( doc.unicode() )[ pos + i ].lower() != s[ i ].lower() )
05827         <font class="keywordflow">return</font> FALSE;
05828     }
05829     <font class="keywordflow">return</font> TRUE;
05830 }
05831 
05832 <font class="keyword">static</font> <font class="keywordtype">bool</font> qt_is_cell_in_use( QPtrList&lt;QTextTableCell&gt;&amp; cells, <font class="keywordtype">int</font> row, <font class="keywordtype">int</font> col )
05833 {
05834     <font class="keywordflow">for</font> ( QTextTableCell* c = cells.first(); c; c = cells.next() ) {
05835     <font class="keywordflow">if</font> ( row &gt;= c-&gt;row() &amp;&amp; row &lt; c-&gt;row() + c-&gt;rowspan()
05836          &amp;&amp; col &gt;= c-&gt;column() &amp;&amp; col &lt; c-&gt;column() + c-&gt;colspan() )
05837         <font class="keywordflow">return</font> TRUE;
05838     }
05839     <font class="keywordflow">return</font> FALSE;
05840 }
05841 
05842 QTextCustomItem* QTextDocument::parseTable( <font class="keyword">const</font> QMap&lt;QString, QString&gt; &amp;attr, <font class="keyword">const</font> QTextFormat &amp;fmt,
05843                         <font class="keyword">const</font> QString &amp;doc, <font class="keywordtype">int</font>&amp; pos, QTextParag *curpar )
05844 {
05845 
05846     QTextTable* table = <font class="keyword">new</font> QTextTable( <font class="keyword">this</font>, attr );
05847     <font class="keywordtype">int</font> row = -1;
05848     <font class="keywordtype">int</font> col = -1;
05849 
05850     QString rowbgcolor;
05851     QString rowalign;
05852     QString tablebgcolor = attr[<font class="stringliteral">"bgcolor"</font>];
05853 
05854     QPtrList&lt;QTextTableCell&gt; multicells;
05855 
05856     QString tagname;
05857     (void) eatSpace(doc, pos);
05858     <font class="keywordflow">while</font> ( pos &lt; int(doc.length() )) {
05859     <font class="keywordtype">int</font> beforePos = pos;
05860     <font class="keywordflow">if</font> (hasPrefix(doc, pos, QChar(<font class="charliteral">'&lt;'</font>)) ){
05861         <font class="keywordflow">if</font> (hasPrefix(doc, pos+1, QChar(<font class="charliteral">'/'</font>))) {
05862         tagname = parseCloseTag( doc, pos );
05863         <font class="keywordflow">if</font> ( tagname == <font class="stringliteral">"table"</font> ) {
05864             pos = beforePos;
05865 <font class="preprocessor">#if defined(PARSER_DEBUG)</font>
05866 <font class="preprocessor"></font>            debug_indent.remove( debug_indent.length() - 3, 2 );
05867 <font class="preprocessor">#endif</font>
05868 <font class="preprocessor"></font>            <font class="keywordflow">return</font> table;
05869         }
05870         } <font class="keywordflow">else</font> {
05871         QMap&lt;QString, QString&gt; attr2;
05872         <font class="keywordtype">bool</font> emptyTag = FALSE;
05873         tagname = parseOpenTag( doc, pos, attr2, emptyTag );
05874         <font class="keywordflow">if</font> ( tagname == <font class="stringliteral">"tr"</font> ) {
05875             rowbgcolor = attr2[<font class="stringliteral">"bgcolor"</font>];
05876             rowalign = attr2[<font class="stringliteral">"align"</font>];
05877             row++;
05878             col = -1;
05879         }
05880         <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( tagname == <font class="stringliteral">"td"</font> || tagname == <font class="stringliteral">"th"</font> ) {
05881             col++;
05882             <font class="keywordflow">while</font> ( qt_is_cell_in_use( multicells, row, col ) ) {
05883             col++;
05884             }
05885 
05886             <font class="keywordflow">if</font> ( row &gt;= 0 &amp;&amp; col &gt;= 0 ) {
05887             <font class="keyword">const</font> <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a>* s = sheet_-&gt;item(tagname);
05888             <font class="keywordflow">if</font> ( !attr2.contains(<font class="stringliteral">"bgcolor"</font>) ) {
05889                 <font class="keywordflow">if</font> (!rowbgcolor.isEmpty() )
05890                 attr2[<font class="stringliteral">"bgcolor"</font>] = rowbgcolor;
05891                 <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!tablebgcolor.isEmpty() )
05892                 attr2[<font class="stringliteral">"bgcolor"</font>] = tablebgcolor;
05893             }
05894             <font class="keywordflow">if</font> ( !attr2.contains(<font class="stringliteral">"align"</font>) ) {
05895                 <font class="keywordflow">if</font> (!rowalign.isEmpty() )
05896                 attr2[<font class="stringliteral">"align"</font>] = rowalign;
05897             }
05898 
05899             <font class="comment">// extract the cell contents</font>
05900             <font class="keywordtype">int</font> end = pos;
05901             <font class="keywordflow">while</font> ( end &lt; (int) doc.length()
05902                 &amp;&amp; !hasPrefix( doc, end, <font class="stringliteral">"&lt;/td"</font>)
05903                 &amp;&amp; !hasPrefix( doc, end, <font class="stringliteral">"&lt;td"</font>)
05904                 &amp;&amp; !hasPrefix( doc, end, <font class="stringliteral">"&lt;/th"</font>)
05905                 &amp;&amp; !hasPrefix( doc, end, <font class="stringliteral">"&lt;th"</font>)
05906                 &amp;&amp; !hasPrefix( doc, end, <font class="stringliteral">"&lt;td"</font>)
05907                 &amp;&amp; !hasPrefix( doc, end, <font class="stringliteral">"&lt;/tr"</font>)
05908                 &amp;&amp; !hasPrefix( doc, end, <font class="stringliteral">"&lt;tr"</font>)
05909                 &amp;&amp; !hasPrefix( doc, end, <font class="stringliteral">"&lt;/table"</font>) ) {
05910                 <font class="keywordflow">if</font> ( hasPrefix( doc, end, <font class="stringliteral">"&lt;table"</font> ) ) { <font class="comment">// nested table</font>
05911                 <font class="keywordtype">int</font> nested = 1;
05912                 ++end;
05913                 <font class="keywordflow">while</font> ( end &lt; (int)doc.length() &amp;&amp; nested != 0 ) {
05914                     <font class="keywordflow">if</font> ( hasPrefix( doc, end, <font class="stringliteral">"&lt;/table"</font> ) )
05915                     nested--;
05916                     <font class="keywordflow">if</font> ( hasPrefix( doc, end, <font class="stringliteral">"&lt;table"</font> ) )
05917                     nested++;
05918                     end++;
05919                 }
05920                 }
05921                 end++;
05922             }
05923             QTextTableCell* cell  = <font class="keyword">new</font> QTextTableCell( table, row, col,
05924                                     attr2, s, fmt.makeTextFormat( s, attr2 ),
05925                                     contxt, *factory_, sheet_, doc.mid( pos, end - pos ) );
05926             cell-&gt;richText()-&gt;parParag = curpar;
05927             <font class="keywordflow">if</font> ( cell-&gt;colspan() &gt; 1 || cell-&gt;rowspan() &gt; 1 )
05928                 multicells.append( cell );
05929             col += cell-&gt;colspan()-1;
05930             pos = end;
05931             }
05932         }
05933         }
05934 
05935     } <font class="keywordflow">else</font> {
05936         ++pos;
05937     }
05938     }
05939 <font class="preprocessor">#if defined(PARSER_DEBUG)</font>
05940 <font class="preprocessor"></font>    debug_indent.remove( debug_indent.length() - 3, 2 );
05941 <font class="preprocessor">#endif</font>
05942 <font class="preprocessor"></font>    <font class="keywordflow">return</font> table;
05943 }
05944 
05945 <font class="keywordtype">bool</font> QTextDocument::eatSpace(<font class="keyword">const</font> QString&amp; doc, <font class="keywordtype">int</font>&amp; pos, <font class="keywordtype">bool</font> includeNbsp )
05946 {
05947     <font class="keywordtype">int</font> old_pos = pos;
05948     <font class="keywordflow">while</font> (pos &lt; int(doc.length()) &amp;&amp; (doc.unicode())[pos].isSpace() &amp;&amp; ( includeNbsp || (doc.unicode())[pos] != QChar::nbsp ) )
05949     pos++;
05950     <font class="keywordflow">return</font> old_pos &lt; pos;
05951 }
05952 
05953 <font class="keywordtype">bool</font> QTextDocument::eat(<font class="keyword">const</font> QString&amp; doc, <font class="keywordtype">int</font>&amp; pos, QChar c)
05954 {
05955     <font class="keywordtype">bool</font> ok = pos &lt; int(doc.length()) &amp;&amp; ((doc.unicode())[pos] == c);
05956     <font class="keywordflow">if</font> ( ok )
05957     pos++;
05958     <font class="keywordflow">return</font> ok;
05959 }
05960 <font class="comment">/*****************************************************************/</font>
05961 
05962 
05963 
05964 <font class="keyword">static</font> QMap&lt;QCString, QChar&gt; *html_map = 0;
05965 <font class="keyword">static</font> <font class="keywordtype">void</font> qt_cleanup_html_map()
05966 {
05967     <font class="keyword">delete</font> html_map;
05968     html_map = 0;
05969 }
05970 
05971 <font class="keyword">static</font> QMap&lt;QCString, QChar&gt; *htmlMap()
05972 {
05973     <font class="keywordflow">if</font> ( !html_map ) {
05974     html_map = <font class="keyword">new</font> QMap&lt;QCString, QChar&gt;;
05975     qAddPostRoutine( qt_cleanup_html_map );
05976     html_map-&gt;insert( <font class="stringliteral">"lt"</font>, <font class="charliteral">'&lt;'</font>);
05977     html_map-&gt;insert( <font class="stringliteral">"gt"</font>, <font class="charliteral">'&gt;'</font>);
05978     html_map-&gt;insert( <font class="stringliteral">"amp"</font>, <font class="charliteral">'&amp;'</font>);
05979     html_map-&gt;insert( <font class="stringliteral">"nbsp"</font>, 0x00a0U);
05980     html_map-&gt;insert( <font class="stringliteral">"bull"</font>, 0x2022U);
05981     html_map-&gt;insert( <font class="stringliteral">"aring"</font>, '\xe5');
05982     html_map-&gt;insert( <font class="stringliteral">"oslash"</font>, '\xf8');
05983     html_map-&gt;insert( <font class="stringliteral">"ouml"</font>, '\xf6');
05984     html_map-&gt;insert( <font class="stringliteral">"auml"</font>, '\xe4');
05985     html_map-&gt;insert( <font class="stringliteral">"uuml"</font>, '\xfc');
05986     html_map-&gt;insert( <font class="stringliteral">"Ouml"</font>, '\xd6');
05987     html_map-&gt;insert( <font class="stringliteral">"Auml"</font>, '\xc4');
05988     html_map-&gt;insert( <font class="stringliteral">"Uuml"</font>, '\xdc');
05989     html_map-&gt;insert( <font class="stringliteral">"szlig"</font>, '\xdf');
05990     html_map-&gt;insert( <font class="stringliteral">"copy"</font>, '\xa9');
05991     html_map-&gt;insert( <font class="stringliteral">"deg"</font>, '\xb0');
05992     html_map-&gt;insert( <font class="stringliteral">"micro"</font>, '\xb5');
05993     html_map-&gt;insert( <font class="stringliteral">"plusmn"</font>, '\xb1');
05994     html_map-&gt;insert( <font class="stringliteral">"middot"</font>, <font class="charliteral">'*'</font>);
05995     html_map-&gt;insert( <font class="stringliteral">"quot"</font>, <font class="charliteral">'\"'</font>);
05996     html_map-&gt;insert( <font class="stringliteral">"commat"</font>, <font class="charliteral">'@'</font>);
05997     html_map-&gt;insert( <font class="stringliteral">"num"</font>, <font class="charliteral">'#'</font>);
05998     html_map-&gt;insert( <font class="stringliteral">"dollar"</font>, <font class="charliteral">'$'</font>);
05999     html_map-&gt;insert( <font class="stringliteral">"ldquo"</font>, <font class="charliteral">'`'</font>);
06000     html_map-&gt;insert( <font class="stringliteral">"rdquo"</font>, <font class="charliteral">'\''</font>);
06001     html_map-&gt;insert( <font class="stringliteral">"sol"</font>, <font class="charliteral">'/'</font> );
06002     html_map-&gt;insert( <font class="stringliteral">"bsol"</font>, <font class="charliteral">'\\'</font>);
06003     html_map-&gt;insert( <font class="stringliteral">"lowbar"</font>, <font class="charliteral">'_'</font>);
06004     html_map-&gt;insert( <font class="stringliteral">"shy"</font>, '\xad');
06005     }
06006     <font class="keywordflow">return</font> html_map;
06007 }
06008 
06009 QChar QTextDocument::parseHTMLSpecialChar(<font class="keyword">const</font> QString&amp; doc, <font class="keywordtype">int</font>&amp; pos)
06010 {
06011     QCString s;
06012     pos++;
06013     <font class="keywordtype">int</font> recoverpos = pos;
06014     <font class="keywordflow">while</font> ( pos &lt; int(doc.length()) &amp;&amp; (doc.unicode())[pos] != <font class="charliteral">';'</font> &amp;&amp; !(doc.unicode())[pos].isSpace() &amp;&amp; pos &lt; recoverpos + 6) {
06015     s += (doc.unicode())[pos];
06016     pos++;
06017     }
06018     <font class="keywordflow">if</font> ((doc.unicode())[pos] != <font class="charliteral">';'</font> &amp;&amp; !(doc.unicode())[pos].isSpace() ) {
06019     pos = recoverpos;
06020     <font class="keywordflow">return</font> <font class="charliteral">'&amp;'</font>;
06021     }
06022     pos++;
06023 
06024     <font class="keywordflow">if</font> ( s.length() &gt; 1 &amp;&amp; s[0] == <font class="charliteral">'#'</font>) {
06025     <font class="keywordtype">int</font> num = s.mid(1).toInt();
06026     <font class="keywordflow">if</font> ( num == 151 ) <font class="comment">// ### hack for designer manual</font>
06027         <font class="keywordflow">return</font> <font class="charliteral">'-'</font>;
06028     <font class="keywordflow">return</font> num;
06029     }
06030 
06031     QMap&lt;QCString, QChar&gt;::Iterator it = htmlMap()-&gt;find(s);
06032     <font class="keywordflow">if</font> ( it != htmlMap()-&gt;end() ) {
06033     <font class="keywordflow">return</font> *it;
06034     }
06035 
06036     pos = recoverpos;
06037     <font class="keywordflow">return</font> <font class="charliteral">'&amp;'</font>;
06038 }
06039 
06040 QString QTextDocument::parseWord(<font class="keyword">const</font> QString&amp; doc, <font class="keywordtype">int</font>&amp; pos, <font class="keywordtype">bool</font> lower)
06041 {
06042     QString s;
06043 
06044     <font class="keywordflow">if</font> ((doc.unicode())[pos] == <font class="charliteral">'"'</font>) {
06045     pos++;
06046     <font class="keywordflow">while</font> ( pos &lt; int(doc.length()) &amp;&amp; (doc.unicode())[pos] != <font class="charliteral">'"'</font> ) {
06047         s += (doc.unicode())[pos];
06048         pos++;
06049     }
06050     eat(doc, pos, <font class="charliteral">'"'</font>);
06051     } <font class="keywordflow">else</font> {
06052     <font class="keyword">static</font> QString term = QString::fromLatin1(<font class="stringliteral">"/&gt;"</font>);
06053     <font class="keywordflow">while</font>( pos &lt; int(doc.length()) &amp;&amp;
06054            ((doc.unicode())[pos] != <font class="charliteral">'&gt;'</font> &amp;&amp; !hasPrefix( doc, pos, term))
06055            &amp;&amp; (doc.unicode())[pos] != <font class="charliteral">'&lt;'</font>
06056            &amp;&amp; (doc.unicode())[pos] != <font class="charliteral">'='</font>
06057            &amp;&amp; !(doc.unicode())[pos].isSpace())
06058     {
06059         <font class="keywordflow">if</font> ( (doc.unicode())[pos] == <font class="charliteral">'&amp;'</font>)
06060         s += parseHTMLSpecialChar( doc, pos );
06061         <font class="keywordflow">else</font> {
06062         s += (doc.unicode())[pos];
06063         pos++;
06064         }
06065     }
06066     <font class="keywordflow">if</font> (lower)
06067         s = s.lower();
06068     }
06069     <font class="keywordflow">return</font> s;
06070 }
06071 
06072 QChar QTextDocument::parseChar(<font class="keyword">const</font> QString&amp; doc, <font class="keywordtype">int</font>&amp; pos, QStyleSheetItem::WhiteSpaceMode wsm )
06073 {
06074     <font class="keywordflow">if</font> ( pos &gt;=  int(doc.length() ) )
06075     <font class="keywordflow">return</font> QChar::null;
06076 
06077     QChar c = (doc.unicode())[pos++];
06078 
06079     <font class="keywordflow">if</font> (c == <font class="charliteral">'&lt;'</font> )
06080     <font class="keywordflow">return</font> QChar::null;
06081 
06082     <font class="keywordflow">if</font> ( c.isSpace() &amp;&amp; c != QChar::nbsp ) {
06083     <font class="keywordflow">if</font> ( wsm == QStyleSheetItem::WhiteSpacePre ) {
06084         <font class="keywordflow">if</font> ( c == <font class="charliteral">' '</font> )
06085         <font class="keywordflow">return</font> QChar::nbsp;
06086         <font class="keywordflow">else</font>
06087         <font class="keywordflow">return</font> c;
06088     } <font class="keywordflow">else</font> { <font class="comment">// non-pre mode: collapse whitespace except nbsp</font>
06089         <font class="keywordflow">while</font> ( pos&lt; int(doc.length() ) &amp;&amp;
06090             (doc.unicode())[pos].isSpace()  &amp;&amp; (doc.unicode())[pos] != QChar::nbsp )
06091         pos++;
06092         <font class="keywordflow">if</font> ( wsm == QStyleSheetItem::WhiteSpaceNoWrap )
06093         <font class="keywordflow">return</font> QChar::nbsp;
06094         <font class="keywordflow">else</font>
06095         <font class="keywordflow">return</font> <font class="charliteral">' '</font>;
06096     }
06097     }
06098     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( c == <font class="charliteral">'&amp;'</font> )
06099     <font class="keywordflow">return</font> parseHTMLSpecialChar( doc, --pos );
06100     <font class="keywordflow">else</font>
06101     <font class="keywordflow">return</font> c;
06102 }
06103 
06104 QString QTextDocument::parseOpenTag(<font class="keyword">const</font> QString&amp; doc, <font class="keywordtype">int</font>&amp; pos,
06105                   QMap&lt;QString, QString&gt; &amp;attr, <font class="keywordtype">bool</font>&amp; emptyTag)
06106 {
06107     emptyTag = FALSE;
06108     pos++;
06109     <font class="keywordflow">if</font> ( hasPrefix(doc, pos, <font class="charliteral">'!'</font>) ) {
06110     <font class="keywordflow">if</font> ( hasPrefix( doc, pos+1, <font class="stringliteral">"--"</font>)) {
06111         pos += 3;
06112         <font class="comment">// eat comments</font>
06113         QString pref = QString::fromLatin1(<font class="stringliteral">"--&gt;"</font>);
06114         <font class="keywordflow">while</font> ( !hasPrefix(doc, pos, pref ) &amp;&amp; pos &lt; int(doc.length()) )
06115         pos++;
06116         <font class="keywordflow">if</font> ( hasPrefix(doc, pos, pref ) ) {
06117         pos += 3;
06118         eatSpace(doc, pos, TRUE);
06119         }
06120         emptyTag = TRUE;
06121         <font class="keywordflow">return</font> QString::null;
06122     }
06123     <font class="keywordflow">else</font> {
06124         <font class="comment">// eat strange internal tags</font>
06125         <font class="keywordflow">while</font> ( !hasPrefix(doc, pos, <font class="charliteral">'&gt;'</font>) &amp;&amp; pos &lt; int(doc.length()) )
06126         pos++;
06127         <font class="keywordflow">if</font> ( hasPrefix(doc, pos, <font class="charliteral">'&gt;'</font>) ) {
06128         pos++;
06129         eatSpace(doc, pos, TRUE);
06130         }
06131         <font class="keywordflow">return</font> QString::null;
06132     }
06133     }
06134 
06135     QString tag = parseWord(doc, pos );
06136     eatSpace(doc, pos, TRUE);
06137     <font class="keyword">static</font> QString term = QString::fromLatin1(<font class="stringliteral">"/&gt;"</font>);
06138     <font class="keyword">static</font> QString s_TRUE = QString::fromLatin1(<font class="stringliteral">"TRUE"</font>);
06139 
06140     <font class="keywordflow">while</font> ((doc.unicode())[pos] != <font class="charliteral">'&gt;'</font> &amp;&amp; ! (emptyTag = hasPrefix(doc, pos, term) )) {
06141     QString key = parseWord(doc, pos );
06142     eatSpace(doc, pos, TRUE);
06143     <font class="keywordflow">if</font> ( key.isEmpty()) {
06144         <font class="comment">// error recovery</font>
06145         <font class="keywordflow">while</font> ( pos &lt; int(doc.length()) &amp;&amp; (doc.unicode())[pos] != <font class="charliteral">'&gt;'</font> )
06146         pos++;
06147         <font class="keywordflow">break</font>;
06148     }
06149     QString value;
06150     <font class="keywordflow">if</font> (hasPrefix(doc, pos, <font class="charliteral">'='</font>) ){
06151         pos++;
06152         eatSpace(doc, pos);
06153         value = parseWord(doc, pos, FALSE);
06154     }
06155     <font class="keywordflow">else</font>
06156         value = s_TRUE;
06157     attr.insert(key, value );
06158     eatSpace(doc, pos, TRUE);
06159     }
06160 
06161     <font class="keywordflow">if</font> (emptyTag) {
06162     eat(doc, pos, <font class="charliteral">'/'</font>);
06163     eat(doc, pos, <font class="charliteral">'&gt;'</font>);
06164     }
06165     <font class="keywordflow">else</font>
06166     eat(doc, pos, <font class="charliteral">'&gt;'</font>);
06167 
06168     <font class="keywordflow">return</font> tag;
06169 }
06170 
06171 QString QTextDocument::parseCloseTag( <font class="keyword">const</font> QString&amp; doc, <font class="keywordtype">int</font>&amp; pos )
06172 {
06173     pos++;
06174     pos++;
06175     QString tag = parseWord(doc, pos );
06176     eatSpace(doc, pos, TRUE);
06177     eat(doc, pos, <font class="charliteral">'&gt;'</font>);
06178     <font class="keywordflow">return</font> tag;
06179 }
06180 
06181 QTextFlow::QTextFlow()
06182 {
06183     width = height = pagesize = 0;
06184     leftItems.setAutoDelete( FALSE );
06185     rightItems.setAutoDelete( FALSE );
06186 }
06187 
06188 QTextFlow::~QTextFlow()
06189 {
06190 }
06191 
06192 <font class="keywordtype">void</font> QTextFlow::clear()
06193 {
06194     leftItems.clear();
06195     rightItems.clear();
06196 }
06197 
06198 <font class="keywordtype">void</font> QTextFlow::setWidth( <font class="keywordtype">int</font> w )
06199 {
06200     height = 0;
06201     width = w;
06202 }
06203 
06204 <font class="keywordtype">int</font> QTextFlow::adjustLMargin( <font class="keywordtype">int</font> yp, <font class="keywordtype">int</font>, <font class="keywordtype">int</font> margin, <font class="keywordtype">int</font> space )
06205 {
06206     <font class="keywordflow">for</font> ( QTextCustomItem* item = leftItems.first(); item; item = leftItems.next() ) {
06207     <font class="keywordflow">if</font> ( item-&gt;y() == -1 )
06208         <font class="keywordflow">continue</font>;
06209     <font class="keywordflow">if</font> ( yp &gt;= item-&gt;y() &amp;&amp; yp &lt; item-&gt;y() + item-&gt;height )
06210         margin = QMAX( margin, item-&gt;x() + item-&gt;width + space );
06211     }
06212     <font class="keywordflow">return</font> margin;
06213 }
06214 
06215 <font class="keywordtype">int</font> QTextFlow::adjustRMargin( <font class="keywordtype">int</font> yp, <font class="keywordtype">int</font>, <font class="keywordtype">int</font> margin, <font class="keywordtype">int</font> space )
06216 {
06217     <font class="keywordflow">for</font> ( QTextCustomItem* item = rightItems.first(); item; item = rightItems.next() ) {
06218     <font class="keywordflow">if</font> ( item-&gt;y() == -1 )
06219         <font class="keywordflow">continue</font>;
06220     <font class="keywordflow">if</font> ( yp &gt;= item-&gt;y() &amp;&amp; yp &lt; item-&gt;y() + item-&gt;height )
06221         margin = QMAX( margin, width - item-&gt;x() - space );
06222     }
06223     <font class="keywordflow">return</font> margin;
06224 }
06225 
06226 <font class="keywordtype">void</font> QTextFlow::adjustFlow( <font class="keywordtype">int</font> &amp;yp, <font class="keywordtype">int</font> , <font class="keywordtype">int</font> h, QTextParag *, <font class="keywordtype">bool</font> pages )
06227 {
06228     <font class="keywordflow">if</font> ( pages &amp;&amp; pagesize &gt; 0 ) { <font class="comment">// check pages</font>
06229     <font class="keywordtype">int</font> ty = yp;
06230     <font class="keywordtype">int</font> yinpage = ty % pagesize;
06231     <font class="keywordflow">if</font> ( yinpage &lt; 2 )
06232         yp += 2 - yinpage;
06233     <font class="keywordflow">else</font>
06234         <font class="keywordflow">if</font> ( yinpage + h &gt; pagesize - 2 )
06235         yp += ( pagesize - yinpage ) + 2;
06236     }
06237 
06238     <font class="keywordflow">if</font> ( yp + h &gt; height )
06239     {
06240     height = yp + h;
06241     <font class="comment">//qDebug("QTextFlow::adjustFlow now height=%d",height);</font>
06242     }
06243 }
06244 
06245 <font class="keywordtype">void</font> QTextFlow::unregisterFloatingItem( QTextCustomItem* item )
06246 {
06247     leftItems.removeRef( item );
06248     rightItems.removeRef( item );
06249 }
06250 
06251 <font class="keywordtype">void</font> QTextFlow::registerFloatingItem( QTextCustomItem* item, <font class="keywordtype">bool</font> right )
06252 {
06253     <font class="keywordflow">if</font> ( right ) {
06254     <font class="keywordflow">if</font> ( !rightItems.contains( item ) )
06255         rightItems.append( item );
06256     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( !leftItems.contains( item ) ) {
06257     leftItems.append( item );
06258     }
06259 }
06260 
06261 <font class="keywordtype">void</font> QTextFlow::drawFloatingItems( QPainter* p, <font class="keywordtype">int</font> cx, <font class="keywordtype">int</font> cy, <font class="keywordtype">int</font> cw, <font class="keywordtype">int</font> ch, <font class="keyword">const</font> QColorGroup&amp; cg, <font class="keywordtype">bool</font> selected )
06262 {
06263     QTextCustomItem *item;
06264     <font class="keywordflow">for</font> ( item = leftItems.first(); item; item = leftItems.next() ) {
06265     <font class="keywordflow">if</font> ( item-&gt;x() == -1 || item-&gt;y() == -1 )
06266         <font class="keywordflow">continue</font>;
06267     item-&gt;draw( p, item-&gt;x(), item-&gt;y(), cx, cy, cw, ch, cg, selected );
06268     }
06269 
06270     <font class="keywordflow">for</font> ( item = rightItems.first(); item; item = rightItems.next() ) {
06271     <font class="keywordflow">if</font> ( item-&gt;x() == -1 || item-&gt;y() == -1 )
06272         <font class="keywordflow">continue</font>;
06273     item-&gt;draw( p, item-&gt;x(), item-&gt;y(), cx, cy, cw, ch, cg, selected );
06274     }
06275 }
06276 
06277 <font class="keywordtype">void</font> QTextFlow::updateHeight( QTextCustomItem *i )
06278 {
06279     height = QMAX( height, i-&gt;y() + i-&gt;height );
06280 }
06281 
06282 <font class="comment">// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</font>
06283 
06284 QTextTable::QTextTable( QTextDocument *p, <font class="keyword">const</font> QMap&lt;QString, QString&gt; &amp; attr  )
06285     : QTextCustomItem( p ), painter( 0 )
06286 {
06287     cells.setAutoDelete( FALSE );
06288 <font class="preprocessor">#if defined(PARSER_DEBUG)</font>
06289 <font class="preprocessor"></font>    debug_indent += <font class="stringliteral">"\t"</font>;
06290     qDebug( debug_indent + <font class="stringliteral">"new QTextTable (%p)"</font>, <font class="keyword">this</font> );
06291     debug_indent += <font class="stringliteral">"\t"</font>;
06292 <font class="preprocessor">#endif</font>
06293 <font class="preprocessor"></font>    cellspacing = 2;
06294     <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"cellspacing"</font>) )
06295     cellspacing = attr[<font class="stringliteral">"cellspacing"</font>].toInt();
06296     cellpadding = 1;
06297     <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"cellpadding"</font>) )
06298     cellpadding = attr[<font class="stringliteral">"cellpadding"</font>].toInt();
06299     border = 0;
06300     innerborder = us_ib = 1;
06301     <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"border"</font> ) ) {
06302     QString s( attr[<font class="stringliteral">"border"</font>] );
06303     <font class="keywordflow">if</font> ( s == <font class="stringliteral">"TRUE"</font> )
06304         border = 1;
06305     <font class="keywordflow">else</font>
06306         border = attr[<font class="stringliteral">"border"</font>].toInt();
06307     }
06308     us_b = border;
06309 
06310     <font class="keywordflow">if</font> ( border )
06311     cellspacing += 2;
06312     us_cs = cellspacing;
06313     outerborder = cellspacing + border;
06314     us_ob = outerborder;
06315     layout = <font class="keyword">new</font> QGridLayout( 1, 1, cellspacing );
06316 
06317     fixwidth = 0;
06318     stretch = 0;
06319     <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"width"</font>) ) {
06320     <font class="keywordtype">bool</font> b;
06321     QString s( attr[<font class="stringliteral">"width"</font>] );
06322     <font class="keywordtype">int</font> w = s.toInt( &amp;b );
06323     <font class="keywordflow">if</font> ( b ) {
06324         fixwidth = w;
06325     } <font class="keywordflow">else</font> {
06326         s = s.stripWhiteSpace();
06327         <font class="keywordflow">if</font> ( s.length() &gt; 1 &amp;&amp; s[ (int)s.length()-1 ] == <font class="charliteral">'%'</font> )
06328         stretch = s.left( s.length()-1).toInt();
06329     }
06330     }
06331 
06332     place = PlaceInline;
06333     <font class="keywordflow">if</font> ( attr[<font class="stringliteral">"align"</font>] == <font class="stringliteral">"left"</font> )
06334     place = PlaceLeft;
06335     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( attr[<font class="stringliteral">"align"</font>] == <font class="stringliteral">"right"</font> )
06336     place = PlaceRight;
06337     cachewidth = 0;
06338     attributes = attr;
06339 }
06340 
06341 QTextTable::~QTextTable()
06342 {
06343     <font class="keyword">delete</font> layout;
06344 }
06345 
06346 QString QTextTable::richText()<font class="keyword"> const</font>
06347 <font class="keyword"></font>{
06348     QString s;
06349     s = <font class="stringliteral">"&lt;table "</font>;
06350     QMap&lt;QString, QString&gt;::ConstIterator it = attributes.begin();
06351     <font class="keywordflow">for</font> ( ; it != attributes.end(); ++it )
06352     s += it.key() + <font class="stringliteral">"="</font> + *it + <font class="stringliteral">" "</font>;
06353     s += <font class="stringliteral">"&gt;\n"</font>;
06354 
06355     <font class="keywordtype">int</font> lastRow = -1;
06356     <font class="keywordtype">bool</font> needEnd = FALSE;
06357     QPtrListIterator&lt;QTextTableCell&gt; it2( cells );
06358     <font class="keywordflow">while</font> ( it2.current() ) {
06359     QTextTableCell *cell = it2.current();
06360     ++it2;
06361     <font class="keywordflow">if</font> ( lastRow != cell-&gt;row() ) {
06362         <font class="keywordflow">if</font> ( lastRow != -1 )
06363         s += <font class="stringliteral">"&lt;/tr&gt;\n"</font>;
06364         s += <font class="stringliteral">"&lt;tr&gt;"</font>;
06365         lastRow = cell-&gt;row();
06366         needEnd = TRUE;
06367     }
06368     s += <font class="stringliteral">"&lt;td "</font>;
06369     it = cell-&gt;attributes.begin();
06370     <font class="keywordflow">for</font> ( ; it != cell-&gt;attributes.end(); ++it )
06371         s += it.key() + <font class="stringliteral">"="</font> + *it + <font class="stringliteral">" "</font>;
06372     s += <font class="stringliteral">"&gt;"</font>;
06373     s += cell-&gt;richText()-&gt;richText();
06374     s += <font class="stringliteral">"&lt;/td&gt;"</font>;
06375     }
06376     <font class="keywordflow">if</font> ( needEnd )
06377     s += <font class="stringliteral">"&lt;/tr&gt;\n"</font>;
06378     s += <font class="stringliteral">"&lt;/table&gt;\n"</font>;
06379     <font class="keywordflow">return</font> s;
06380 }
06381 
06382 <font class="keywordtype">void</font> QTextTable::adjustToPainter( QPainter* p)
06383 {
06384     painter = p;
06385     <font class="keywordflow">if</font> ( is_printer( p ) ) {
06386     QPaintDeviceMetrics metrics(p-&gt;device());
06387     <font class="keywordtype">double</font> xscale = QMAX( scale_factor( metrics.logicalDpiX() ),
06388                   scale_factor( metrics.logicalDpiY() ) );
06389     xscale = QMAX( xscale, 1 );
06390     cellspacing = int(us_cs * xscale);
06391     border = int(us_b * xscale);
06392     innerborder = int(us_ib * xscale);
06393     outerborder = int(us_ob * xscale);
06394     }
06395     <font class="keywordflow">for</font> ( QTextTableCell* cell = cells.first(); cell; cell = cells.next() )
06396     cell-&gt;adjustToPainter();
06397 
06398     width = 0;
06399 }
06400 
06401 <font class="keywordtype">void</font> QTextTable::verticalBreak( <font class="keywordtype">int</font>  yt, QTextFlow* flow )
06402 {
06403     <font class="keywordflow">if</font> ( flow-&gt;pageSize() &lt;= 0 )
06404     <font class="keywordflow">return</font>;
06405     <font class="keywordtype">int</font> shift = 0;
06406     <font class="keywordflow">for</font> (QTextTableCell* cell = cells.first(); cell; cell = cells.next() ) {
06407     QRect r = cell-&gt;geometry();
06408     r.moveBy(0, shift );
06409     cell-&gt;setGeometry( r );
06410     <font class="keywordflow">if</font> ( cell-&gt;column() == 0 ) {
06411         <font class="keywordtype">int</font> y = yt + outerborder + cell-&gt;geometry().y();
06412         <font class="keywordtype">int</font> oldy = y;
06413         flow-&gt;adjustFlow( y, width, cell-&gt;geometry().height() + 2*cellspacing, 0 );
06414         shift += y - oldy;
06415         r = cell-&gt;geometry();
06416         r.moveBy(0, y - oldy );
06417         cell-&gt;setGeometry( r );
06418     }
06419     }
06420     height += shift;
06421 }
06422 
06423 <font class="keywordtype">void</font> QTextTable::draw(QPainter* p, <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y, <font class="keywordtype">int</font> cx, <font class="keywordtype">int</font> cy, <font class="keywordtype">int</font> cw, <font class="keywordtype">int</font> ch, <font class="keyword">const</font> QColorGroup&amp; cg, <font class="keywordtype">bool</font> selected )
06424 {
06425     <font class="keywordflow">if</font> ( placement() != PlaceInline ) {
06426     x = xpos;
06427     y = ypos;
06428     }
06429 
06430     lastX = x;
06431     lastY = y;
06432 
06433     painter = p;
06434 
06435     <font class="keywordflow">for</font> (QTextTableCell* cell = cells.first(); cell; cell = cells.next() ) {
06436     <font class="keywordflow">if</font> ( cx &lt; 0 &amp;&amp; cy &lt; 0 ||
06437          QRect( cx, cy, cw, ch ).intersects( QRect( x + outerborder + cell-&gt;geometry().x(),
06438                             y + outerborder + cell-&gt;geometry().y(),
06439                             cell-&gt;geometry().width(), cell-&gt;geometry().height() ) ) ) {
06440         cell-&gt;draw( x+outerborder, y+outerborder, cx, cy, cw, ch, cg, selected );
06441         <font class="keywordflow">if</font> ( border ) {
06442         QRect r( x+outerborder+cell-&gt;geometry().x() - us_ib,
06443              y+outerborder+cell-&gt;geometry().y() - us_ib,
06444              cell-&gt;geometry().width() + 2 * us_ib,
06445              cell-&gt;geometry().height() + 2 * us_ib );
06446         <font class="keywordtype">int</font> s = cellspacing;
06447         <font class="keywordflow">if</font> ( is_printer( p ) || ( p &amp;&amp; p-&gt;device() &amp;&amp; p-&gt;device()-&gt;devType() == QInternal::Printer ) ) {
06448             qDrawPlainRect( p, r, cg.text(), us_ib );
06449         } <font class="keywordflow">else</font> {
06450             p-&gt;fillRect( r.left()-s, r.top(), s, r.height(), cg.button() );
06451             p-&gt;fillRect( r.right(), r.top(), s, r.height(), cg.button() );
06452             p-&gt;fillRect( r.left()-s, r.top()-s, r.width()+2*s, s, cg.button() );
06453             p-&gt;fillRect( r.left()-s, r.bottom(), r.width()+2*s, s, cg.button() );
06454             qDrawShadePanel( p, r, cg, TRUE, us_ib );
06455         }
06456         }
06457     }
06458     }
06459     <font class="keywordflow">if</font> ( border ) {
06460     QRect r ( x, y, width, height );
06461     <font class="keywordflow">if</font> ( is_printer( p ) || ( p &amp;&amp; p-&gt;device() &amp;&amp; p-&gt;device()-&gt;devType() == QInternal::Printer ) ) {
06462         qDrawPlainRect( p, QRect(QMAX( 0, r.x()+1 ), QMAX( 0, r.y()+1 ), QMAX( r.width()-2, 0 ), QMAX( 0, r.height()-2 ) ), cg.text(), us_b );
06463     } <font class="keywordflow">else</font> {
06464         <font class="keywordtype">int</font> s = border;
06465         p-&gt;fillRect( r.left(), r.top(), s, r.height(), cg.button() );
06466         p-&gt;fillRect( r.right()-s, r.top(), s, r.height(), cg.button() );
06467         p-&gt;fillRect( r.left(), r.top(), r.width(), s, cg.button() );
06468         p-&gt;fillRect( r.left(), r.bottom()-s, r.width(), s, cg.button() );
06469         qDrawShadePanel( p, r, cg, FALSE, us_b );
06470     }
06471     }
06472 
06473 <font class="preprocessor">#if defined(DEBUG_TABLE_RENDERING)</font>
06474 <font class="preprocessor"></font>    p-&gt;save();
06475     p-&gt;setPen( Qt::red );
06476     p-&gt;drawRect( x, y, width, height );
06477     p-&gt;restore();
06478 <font class="preprocessor">#endif</font>
06479 <font class="preprocessor"></font>}
06480 
06481 <font class="keywordtype">void</font> QTextTable::resize( QPainter* p, <font class="keywordtype">int</font> nwidth )
06482 {
06483     <font class="keywordflow">if</font> ( fixwidth &amp;&amp; cachewidth != 0 )
06484     <font class="keywordflow">return</font>;
06485     <font class="keywordflow">if</font> ( nwidth == cachewidth )
06486     <font class="keywordflow">return</font>;
06487     cachewidth = nwidth;
06488     <font class="keywordtype">int</font> w = nwidth;
06489     painter = p;
06490     <font class="keywordflow">if</font> ( is_printer( painter ) ) {
06491     adjustToPainter( painter );
06492     } <font class="keywordflow">else</font> {
06493     painter = 0;
06494     }
06495     format( w );
06496     <font class="keywordflow">if</font> ( nwidth &gt;= 32000 )
06497     nwidth = w;
06498     <font class="keywordflow">if</font> ( stretch )
06499     nwidth = nwidth * stretch / 100;
06500 
06501     width = nwidth + 2*outerborder;
06502     layout-&gt;invalidate();
06503     <font class="keywordtype">int</font> shw = layout-&gt;sizeHint().width() + 2*outerborder;
06504     <font class="keywordtype">int</font> mw = layout-&gt;minimumSize().width() + 2*outerborder;
06505     <font class="keywordflow">if</font> ( stretch )
06506     width = QMAX( mw, nwidth );
06507     <font class="keywordflow">else</font>
06508     width = QMAX( mw, QMIN( nwidth, shw ) );
06509 
06510     <font class="keywordflow">if</font> ( fixwidth )
06511     width = fixwidth;
06512 
06513     layout-&gt;invalidate();
06514     mw = layout-&gt;minimumSize().width() + 2*outerborder;
06515     width = QMAX( width, mw );
06516 
06517     <font class="keywordtype">int</font> h = layout-&gt;heightForWidth( width-2*outerborder );
06518     layout-&gt;setGeometry( QRect(0, 0, width-2*outerborder, h)  );
06519     height = layout-&gt;geometry().height()+2*outerborder;
06520 };
06521 
06522 <font class="keywordtype">void</font> QTextTable::format( <font class="keywordtype">int</font> &amp;w )
06523 {
06524     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)cells.count(); ++i ) {
06525     QTextTableCell *cell = cells.at( i );
06526     cell-&gt;richText()-&gt;doLayout( painter, QWIDGETSIZE_MAX );
06527     cell-&gt;cached_sizehint = cell-&gt;richText()-&gt;widthUsed() + 2 * ( innerborder + 4 );
06528     <font class="keywordflow">if</font> ( cell-&gt;cached_sizehint &gt; 32000 ) <font class="comment">// nested table in paragraph</font>
06529         cell-&gt;cached_sizehint = cell-&gt;minimumSize().width();
06530     cell-&gt;richText()-&gt;doLayout( painter, cell-&gt;cached_sizehint );
06531     cell-&gt;cached_width = -1;
06532     }
06533     w = widthHint();
06534     layout-&gt;invalidate();
06535     layout-&gt;activate();
06536     width = minimumWidth();
06537 }
06538 
06539 <font class="keywordtype">void</font> QTextTable::addCell( QTextTableCell* cell )
06540 {
06541     cells.append( cell );
06542     layout-&gt;addMultiCell( cell, cell-&gt;row(), cell-&gt;row() + cell-&gt;rowspan()-1,
06543               cell-&gt;column(), cell-&gt;column() + cell-&gt;colspan()-1 );
06544 }
06545 
06546 <font class="keywordtype">void</font> QTextTable::enter( QTextCursor *c, QTextDocument *&amp;doc, QTextParag *&amp;parag, <font class="keywordtype">int</font> &amp;idx, <font class="keywordtype">int</font> &amp;ox, <font class="keywordtype">int</font> &amp;oy, <font class="keywordtype">bool</font> atEnd )
06547 {
06548     currCell.remove( c );
06549     <font class="keywordflow">if</font> ( !atEnd ) {
06550     next( c, doc, parag, idx, ox, oy );
06551     } <font class="keywordflow">else</font> {
06552     currCell.insert( c, cells.count() );
06553     prev( c, doc, parag, idx, ox, oy );
06554     }
06555 }
06556 
06557 <font class="keywordtype">void</font> QTextTable::enterAt( QTextCursor *c, QTextDocument *&amp;doc, QTextParag *&amp;parag, <font class="keywordtype">int</font> &amp;idx, <font class="keywordtype">int</font> &amp;ox, <font class="keywordtype">int</font> &amp;oy, <font class="keyword">const</font> QPoint &amp;pos )
06558 {
06559     currCell.remove( c );
06560     <font class="keywordtype">int</font> lastCell = -1;
06561     <font class="keywordtype">int</font> lastY = -1;
06562     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; (int)cells.count(); ++i ) {
06563     QTextTableCell *cell = cells.at( i );
06564     <font class="keywordflow">if</font> ( !cell )
06565         <font class="keywordflow">continue</font>;
06566     <font class="keywordflow">if</font> ( cell-&gt;geometry().x() - innerborder &lt;= pos.x() &amp;&amp;
06567          cell-&gt;geometry().x() + cell-&gt;geometry().width() + innerborder &gt;= pos.x() ) {
06568         <font class="keywordflow">if</font> ( cell-&gt;geometry().y() &gt; lastY ) {
06569         lastCell = i;
06570         lastY = cell-&gt;geometry().y();
06571         }
06572         <font class="keywordflow">if</font> ( cell-&gt;geometry().y() - innerborder &lt;= pos.y() &amp;&amp;
06573          cell-&gt;geometry().y() + cell-&gt;geometry().height() + innerborder &gt;= pos.y() ) {
06574         currCell.insert( c, i );
06575         <font class="keywordflow">break</font>;
06576         }
06577     }
06578     }
06579 
06580     <font class="keywordflow">if</font> ( currCell.find( c ) == currCell.end() ) {
06581     <font class="keywordflow">if</font> ( lastY != -1 )
06582         currCell.insert( c, lastCell );
06583     }
06584 
06585     QTextTableCell *cell = cells.at( *currCell.find( c ) );
06586     <font class="keywordflow">if</font> ( !cell )
06587     <font class="keywordflow">return</font>;
06588     doc = cell-&gt;richText();
06589     parag = doc-&gt;firstParag();
06590     idx = 0;
06591     ox += cell-&gt;geometry().x() + outerborder + parent-&gt;x();
06592     oy += cell-&gt;geometry().y() + outerborder;
06593 }
06594 
06595 <font class="keywordtype">void</font> QTextTable::next( QTextCursor *c, QTextDocument *&amp;doc, QTextParag *&amp;parag, <font class="keywordtype">int</font> &amp;idx, <font class="keywordtype">int</font> &amp;ox, <font class="keywordtype">int</font> &amp;oy )
06596 {
06597     <font class="keywordtype">int</font> cc = *currCell.find( c );
06598     <font class="keywordflow">if</font> ( cc &gt; (int)cells.count() - 1 || cc &lt; 0 )
06599     cc = -1;
06600     currCell.remove( c );
06601     currCell.insert( c, ++cc );
06602     <font class="keywordflow">if</font> ( cc &gt;= (int)cells.count() ) {
06603     currCell.insert( c, 0 );
06604     QTextCustomItem::next( c, doc, parag, idx, ox, oy );
06605     QTextTableCell *cell = cells.at( 0 );
06606     <font class="keywordflow">if</font> ( !cell )
06607         <font class="keywordflow">return</font>;
06608     doc = cell-&gt;richText();
06609     idx = -1;
06610     <font class="keywordflow">return</font>;
06611     }
06612 
06613     QTextTableCell *cell = cells.at( *currCell.find( c ) );
06614     <font class="keywordflow">if</font> ( !cell )
06615     <font class="keywordflow">return</font>;
06616     doc = cell-&gt;richText();
06617     parag = doc-&gt;firstParag();
06618     idx = 0;
06619     ox += cell-&gt;geometry().x() + outerborder + parent-&gt;x();
06620     oy += cell-&gt;geometry().y() + outerborder;
06621 }
06622 
06623 <font class="keywordtype">void</font> QTextTable::prev( QTextCursor *c, QTextDocument *&amp;doc, QTextParag *&amp;parag, <font class="keywordtype">int</font> &amp;idx, <font class="keywordtype">int</font> &amp;ox, <font class="keywordtype">int</font> &amp;oy )
06624 {
06625     <font class="keywordtype">int</font> cc = *currCell.find( c );
06626     <font class="keywordflow">if</font> ( cc &gt; (int)cells.count() - 1 || cc &lt; 0 )
06627     cc = cells.count();
06628     currCell.remove( c );
06629     currCell.insert( c, --cc );
06630     <font class="keywordflow">if</font> ( cc &lt; 0 ) {
06631     currCell.insert( c, 0 );
06632     QTextCustomItem::prev( c, doc, parag, idx, ox, oy );
06633     QTextTableCell *cell = cells.at( 0 );
06634     <font class="keywordflow">if</font> ( !cell )
06635         <font class="keywordflow">return</font>;
06636     doc = cell-&gt;richText();
06637     idx = -1;
06638     <font class="keywordflow">return</font>;
06639     }
06640 
06641     QTextTableCell *cell = cells.at( *currCell.find( c ) );
06642     <font class="keywordflow">if</font> ( !cell )
06643     <font class="keywordflow">return</font>;
06644     doc = cell-&gt;richText();
06645     parag = doc-&gt;firstParag();
06646     idx = parag-&gt;length() - 1;
06647     ox += cell-&gt;geometry().x() + outerborder + parent-&gt;x();
06648     oy += cell-&gt;geometry().y() + outerborder;
06649 }
06650 
06651 <font class="keywordtype">void</font> QTextTable::down( QTextCursor *c, QTextDocument *&amp;doc, QTextParag *&amp;parag, <font class="keywordtype">int</font> &amp;idx, <font class="keywordtype">int</font> &amp;ox, <font class="keywordtype">int</font> &amp;oy )
06652 {
06653     QTextTableCell *cell = cells.at( *currCell.find( c ) );
06654     <font class="keywordflow">if</font> ( cell-&gt;row_ == layout-&gt;numRows() - 1 ) {
06655     currCell.insert( c, 0 );
06656     QTextCustomItem::down( c, doc, parag, idx, ox, oy );
06657     QTextTableCell *cell = cells.at( 0 );
06658     <font class="keywordflow">if</font> ( !cell )
06659         <font class="keywordflow">return</font>;
06660     doc = cell-&gt;richText();
06661     idx = -1;
06662     <font class="keywordflow">return</font>;
06663     }
06664 
06665     <font class="keywordtype">int</font> oldRow = cell-&gt;row_;
06666     <font class="keywordtype">int</font> oldCol = cell-&gt;col_;
06667     <font class="keywordtype">int</font> cc = *currCell.find( c );
06668     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = cc; i &lt; (int)cells.count(); ++i ) {
06669     cell = cells.at( i );
06670     <font class="keywordflow">if</font> ( cell-&gt;row_ &gt; oldRow &amp;&amp; cell-&gt;col_ == oldCol ) {
06671         currCell.insert( c, i );
06672         <font class="keywordflow">break</font>;
06673     }
06674     }
06675     doc = cell-&gt;richText();
06676     <font class="keywordflow">if</font> ( !cell )
06677     <font class="keywordflow">return</font>;
06678     parag = doc-&gt;firstParag();
06679     idx = 0;
06680     ox += cell-&gt;geometry().x() + outerborder + parent-&gt;x(),
06681     oy += cell-&gt;geometry().y() + outerborder;
06682 }
06683 
06684 <font class="keywordtype">void</font> QTextTable::up( QTextCursor *c, QTextDocument *&amp;doc, QTextParag *&amp;parag, <font class="keywordtype">int</font> &amp;idx, <font class="keywordtype">int</font> &amp;ox, <font class="keywordtype">int</font> &amp;oy )
06685 {
06686     QTextTableCell *cell = cells.at( *currCell.find( c ) );
06687     <font class="keywordflow">if</font> ( cell-&gt;row_ == 0 ) {
06688     currCell.insert( c, 0 );
06689     QTextCustomItem::up( c, doc, parag, idx, ox, oy );
06690     QTextTableCell *cell = cells.at( 0 );
06691     <font class="keywordflow">if</font> ( !cell )
06692         <font class="keywordflow">return</font>;
06693     doc = cell-&gt;richText();
06694     idx = -1;
06695     <font class="keywordflow">return</font>;
06696     }
06697 
06698     <font class="keywordtype">int</font> oldRow = cell-&gt;row_;
06699     <font class="keywordtype">int</font> oldCol = cell-&gt;col_;
06700     <font class="keywordtype">int</font> cc = *currCell.find( c );
06701     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = cc; i &gt;= 0; --i ) {
06702     cell = cells.at( i );
06703     <font class="keywordflow">if</font> ( cell-&gt;row_ &lt; oldRow &amp;&amp; cell-&gt;col_ == oldCol ) {
06704         currCell.insert( c, i );
06705         <font class="keywordflow">break</font>;
06706     }
06707     }
06708     doc = cell-&gt;richText();
06709     <font class="keywordflow">if</font> ( !cell )
06710     <font class="keywordflow">return</font>;
06711     parag = doc-&gt;lastParag();
06712     idx = parag-&gt;length() - 1;
06713     ox += cell-&gt;geometry().x() + outerborder + parent-&gt;x();
06714     oy += cell-&gt;geometry().y() + outerborder;
06715 }
06716 
06717 QTextTableCell::QTextTableCell( QTextTable* table,
06718                 <font class="keywordtype">int</font> row, <font class="keywordtype">int</font> column,
06719                 <font class="keyword">const</font> QMap&lt;QString, QString&gt; &amp;attr,
06720                 <font class="keyword">const</font> <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a>* <font class="comment">/*style*/</font>, <font class="comment">// ### use them</font>
06721                 <font class="keyword">const</font> QTextFormat&amp; <font class="comment">/*fmt*/</font>, <font class="keyword">const</font> QString&amp; context,
06722                 QMimeSourceFactory &amp;factory, <a class="code" href="class_q_style_sheet.html">QStyleSheet</a> *sheet,
06723                 <font class="keyword">const</font> QString&amp; doc)
06724 {
06725 <font class="preprocessor">#if defined(PARSER_DEBUG)</font>
06726 <font class="preprocessor"></font>    qDebug( debug_indent + <font class="stringliteral">"new QTextTableCell1 (pappi: %p)"</font>, table );
06727     qDebug( debug_indent + doc );
06728 <font class="preprocessor">#endif</font>
06729 <font class="preprocessor"></font>    cached_width = -1;
06730     cached_sizehint = -1;
06731 
06732     maxw = QWIDGETSIZE_MAX;
06733     minw = 0;
06734 
06735     parent = table;
06736     row_ = row;
06737     col_ = column;
06738     stretch_ = 0;
06739     richtext = <font class="keyword">new</font> QTextDocument( table-&gt;parent );
06740     richtext-&gt;setTableCell( <font class="keyword">this</font> );
06741     QString align = *attr.find( <font class="stringliteral">"align"</font> );
06742     <font class="keywordflow">if</font> ( !align.isEmpty() ) {
06743     <font class="keywordflow">if</font> ( align.lower() == <font class="stringliteral">"left"</font> )
06744         richtext-&gt;setAlignment( Qt::AlignLeft );
06745     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( align.lower() == <font class="stringliteral">"center"</font> )
06746         richtext-&gt;setAlignment( Qt::AlignHCenter );
06747     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( align.lower() == <font class="stringliteral">"right"</font> )
06748         richtext-&gt;setAlignment( Qt::AlignRight );
06749     }
06750     richtext-&gt;setFormatter( table-&gt;parent-&gt;formatter() );
06751     richtext-&gt;setUseFormatCollection( table-&gt;parent-&gt;useFormatCollection() );
06752     richtext-&gt;setMimeSourceFactory( &amp;factory );
06753     richtext-&gt;setStyleSheet( sheet );
06754     richtext-&gt;setDefaultFont( table-&gt;parent-&gt;formatCollection()-&gt;defaultFormat()-&gt;font() );
06755     richtext-&gt;setRichText( doc, context );
06756     rowspan_ = 1;
06757     colspan_ = 1;
06758     <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"colspan"</font>) )
06759     colspan_ = attr[<font class="stringliteral">"colspan"</font>].toInt();
06760     <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"rowspan"</font>) )
06761     rowspan_ = attr[<font class="stringliteral">"rowspan"</font>].toInt();
06762 
06763     background = 0;
06764     <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"bgcolor"</font>) ) {
06765     background = <font class="keyword">new</font> QBrush(QColor( attr[<font class="stringliteral">"bgcolor"</font>] ));
06766     }
06767 
06768     hasFixedWidth = FALSE;
06769     <font class="keywordflow">if</font> ( attr.contains(<font class="stringliteral">"width"</font>) ) {
06770     <font class="keywordtype">bool</font> b;
06771     QString s( attr[<font class="stringliteral">"width"</font>] );
06772     <font class="keywordtype">int</font> w = s.toInt( &amp;b );
06773     <font class="keywordflow">if</font> ( b ) {
06774         maxw = w;
06775         minw = maxw;
06776         hasFixedWidth = TRUE;
06777     } <font class="keywordflow">else</font> {
06778         s = s.stripWhiteSpace();
06779         <font class="keywordflow">if</font> ( s.length() &gt; 1 &amp;&amp; s[ (int)s.length()-1 ] == <font class="charliteral">'%'</font> )
06780         stretch_ = s.left( s.length()-1).toInt();
06781     }
06782     }
06783 
06784     attributes = attr;
06785 
06786     parent-&gt;addCell( <font class="keyword">this</font> );
06787 }
06788 
06789 QTextTableCell::QTextTableCell( QTextTable* table, <font class="keywordtype">int</font> row, <font class="keywordtype">int</font> column )
06790 {
06791 <font class="preprocessor">#if defined(PARSER_DEBUG)</font>
06792 <font class="preprocessor"></font>    qDebug( debug_indent + <font class="stringliteral">"new QTextTableCell2( pappi: %p"</font>, table );
06793 <font class="preprocessor">#endif</font>
06794 <font class="preprocessor"></font>    maxw = QWIDGETSIZE_MAX;
06795     minw = 0;
06796     cached_width = -1;
06797     cached_sizehint = -1;
06798 
06799     parent = table;
06800     row_ = row;
06801     col_ = column;
06802     stretch_ = 0;
06803     richtext = <font class="keyword">new</font> QTextDocument( table-&gt;parent );
06804     richtext-&gt;setTableCell( <font class="keyword">this</font> );
06805     richtext-&gt;setFormatter( table-&gt;parent-&gt;formatter() );
06806     richtext-&gt;setUseFormatCollection( table-&gt;parent-&gt;useFormatCollection() );
06807     richtext-&gt;setDefaultFont( table-&gt;parent-&gt;formatCollection()-&gt;defaultFormat()-&gt;font() );
06808     richtext-&gt;setRichText( <font class="stringliteral">"&lt;html&gt;&lt;/html&gt;"</font>, QString::null );
06809     rowspan_ = 1;
06810     colspan_ = 1;
06811     background = 0;
06812     hasFixedWidth = FALSE;
06813     parent-&gt;addCell( <font class="keyword">this</font> );
06814 }
06815 
06816 
06817 QTextTableCell::~QTextTableCell()
06818 {
06819     <font class="keyword">delete</font> background;
06820     background = 0;
06821     <font class="keyword">delete</font> richtext;
06822     richtext = 0;
06823 }
06824 
06825 QSize QTextTableCell::sizeHint()<font class="keyword"> const</font>
06826 <font class="keyword"></font>{
06827     <font class="keywordflow">if</font> ( cached_sizehint != -1 )
06828     <font class="keywordflow">return</font> QSize( cached_sizehint, 0 );
06829     QTextTableCell *that = (QTextTableCell*)<font class="keyword">this</font>;
06830     <font class="keywordflow">if</font> ( stretch_ )
06831     <font class="keywordflow">return</font> QSize( ( that-&gt;cached_sizehint = QWIDGETSIZE_MAX ), 0 );
06832     <font class="keywordflow">return</font> QSize( ( that-&gt;cached_sizehint = richtext-&gt;widthUsed() + 2 * ( table()-&gt;innerborder + 4 ) ), 0 );
06833 }
06834 
06835 QSize QTextTableCell::minimumSize()<font class="keyword"> const</font>
06836 <font class="keyword"></font>{
06837     <font class="keywordflow">if</font> ( stretch_ )
06838     <font class="keywordflow">return</font> QSize( QMAX( minw, parent-&gt;width * stretch_ / 100 - 2*parent-&gt;cellspacing), 0 );
06839     <font class="keywordflow">return</font> QSize(QMAX( richtext-&gt;minimumWidth(), minw ),0);
06840 }
06841 
06842 QSize QTextTableCell::maximumSize()<font class="keyword"> const</font>
06843 <font class="keyword"></font>{
06844     <font class="keywordflow">return</font> QSize( QWIDGETSIZE_MAX, QWIDGETSIZE_MAX );
06845 }
06846 
06847 QSizePolicy::ExpandData QTextTableCell::expanding()<font class="keyword"> const</font>
06848 <font class="keyword"></font>{
06849     <font class="keywordflow">return</font> QSizePolicy::BothDirections;
06850 }
06851 
06852 <font class="keywordtype">bool</font> QTextTableCell::isEmpty()<font class="keyword"> const</font>
06853 <font class="keyword"></font>{
06854     <font class="keywordflow">return</font> FALSE;
06855 }
06856 <font class="keywordtype">void</font> QTextTableCell::setGeometry( <font class="keyword">const</font> QRect&amp; r )
06857 {
06858     <font class="keywordflow">if</font> ( r.width() != cached_width )
06859     richtext-&gt;doLayout( painter(), r.width() );
06860     cached_width = r.width();
06861     richtext-&gt;setWidth( r.width() );
06862     richtext-&gt;flow()-&gt;height = r.height();
06863     geom = r;
06864 }
06865 
06866 QRect QTextTableCell::geometry()<font class="keyword"> const</font>
06867 <font class="keyword"></font>{
06868     <font class="keywordflow">return</font> geom;
06869 }
06870 
06871 <font class="keywordtype">bool</font> QTextTableCell::hasHeightForWidth()<font class="keyword"> const</font>
06872 <font class="keyword"></font>{
06873     <font class="keywordflow">return</font> TRUE;
06874 }
06875 
06876 <font class="keywordtype">int</font> QTextTableCell::heightForWidth( <font class="keywordtype">int</font> w )<font class="keyword"> const</font>
06877 <font class="keyword"></font>{
06878     w = QMAX( minw, w );
06879 
06880     <font class="keywordflow">if</font> ( cached_width != w ) {
06881     QTextTableCell* that = (QTextTableCell*) <font class="keyword">this</font>;
06882     that-&gt;richtext-&gt;doLayout( painter(), w );
06883     that-&gt;cached_width = w;
06884     }
06885     <font class="keywordflow">return</font> richtext-&gt;height() + 2 * parent-&gt;innerborder;
06886 }
06887 
06888 <font class="keywordtype">void</font> QTextTableCell::adjustToPainter()
06889 {
06890     <font class="keywordflow">if</font> ( !is_printer( painter() ) )
06891     <font class="keywordflow">return</font>;
06892     richtext-&gt;formatCollection()-&gt;setPainter( painter() );
06893     QTextParag *parag = richtext-&gt;firstParag();
06894     <font class="keywordflow">while</font> ( parag ) {
06895     parag-&gt;setPainter( painter() );
06896     parag = parag-&gt;next();
06897     }
06898 }
06899 
06900 QPainter* QTextTableCell::painter()<font class="keyword"> const</font>
06901 <font class="keyword"></font>{
06902     <font class="keywordflow">return</font> parent-&gt;painter;
06903 }
06904 
06905 <font class="keywordtype">void</font> QTextTableCell::draw( <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y, <font class="keywordtype">int</font> cx, <font class="keywordtype">int</font> cy, <font class="keywordtype">int</font> cw, <font class="keywordtype">int</font> ch, <font class="keyword">const</font> QColorGroup&amp; cg, <font class="keywordtype">bool</font> )
06906 {
06907     <font class="keywordflow">if</font> ( cached_width != geom.width() ) {
06908     richtext-&gt;doLayout( painter(), geom.width() );
06909     cached_width = geom.width();
06910     }
06911     QColorGroup g( cg );
06912     <font class="keywordflow">if</font> ( background )
06913     g.setBrush( QColorGroup::Base, *background );
06914     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( richtext-&gt;paper() )
06915     g.setBrush( QColorGroup::Base, *richtext-&gt;paper() );
06916 
06917     painter()-&gt;save();
06918     painter()-&gt;translate( x + geom.x(), y + geom.y() );
06919     <font class="keywordflow">if</font> ( background )
06920     painter()-&gt;fillRect( 0, 0, geom.width(), geom.height(), *background );
06921     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( richtext-&gt;paper() )
06922     painter()-&gt;fillRect( 0, 0, geom.width(), geom.height(), *richtext-&gt;paper() );
06923 
06924     QRegion r;
06925     QTextCursor *c = 0;
06926     <font class="keywordflow">if</font> ( richtext-&gt;parent()-&gt;tmpCursor )
06927     c = richtext-&gt;parent()-&gt;tmpCursor;
06928     <font class="keywordflow">if</font> ( cx &gt;= 0 &amp;&amp; cy &gt;= 0 )
06929     richtext-&gt;draw( painter(), cx - ( x + geom.x() ), cy - ( y + geom.y() ), cw, ch, g, FALSE, (c != 0), c );
06930     <font class="keywordflow">else</font>
06931     richtext-&gt;draw( painter(), -1, -1, -1, -1, g, FALSE, (c != 0), c );
06932 
06933 <font class="preprocessor">#if defined(DEBUG_TABLE_RENDERING)</font>
06934 <font class="preprocessor"></font>    painter()-&gt;save();
06935     painter()-&gt;setPen( Qt::blue );
06936     painter()-&gt;drawRect( 0, 0, geom.width(), geom.height() );
06937     painter()-&gt;restore();
06938 <font class="preprocessor">#endif</font>
06939 <font class="preprocessor"></font>
06940     painter()-&gt;restore();
06941 }
06942 
06943 
06945 
06946 QTextFormat::QTextFormat()
06947     : fm( QFontMetrics( fn ) ), linkColor( TRUE ), logicalFontSize( 3 ), stdPointSize( qApp-&gt;font().pointSize() ),
06948       painter( 0 ), different( NoFlags )
06949 {
06950     ref = 0;
06951     missp = FALSE;
06952     ha = AlignNormal;
06953     collection = 0;
06954 <font class="comment">//#ifdef DEBUG_COLLECTION</font>
06955 <font class="comment">//    qDebug("QTextFormat simple ctor, no addRef ! %p",this);</font>
06956 <font class="comment">//#endif</font>
06957 }
06958 
06959 QTextFormat::QTextFormat( <font class="keyword">const</font> <a class="code" href="class_q_style_sheet_item.html">QStyleSheetItem</a> *style )
06960     : fm( QFontMetrics( fn ) ), linkColor( TRUE ), logicalFontSize( 3 ), stdPointSize( qApp-&gt;font().pointSize() ),
06961       painter( 0 ), different( NoFlags )
06962 {
06963 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
06964 <font class="preprocessor"></font>    qDebug(<font class="stringliteral">"QTextFormat::QTextFormat( const QStyleSheetItem *style )"</font>);
06965 <font class="preprocessor">#endif</font>
06966 <font class="preprocessor"></font>    ref = 0;
06967     this-&gt;style = style-&gt;name();
06968     missp = FALSE;
06969     ha = AlignNormal;
06970     collection = 0;
06971     fn = QFont( style-&gt;fontFamily(),
06972                 style-&gt;fontSize(),
06973                 style-&gt;fontWeight(),
06974                 style-&gt;fontItalic() );
06975     fn.setUnderline( style-&gt;fontUnderline() );
06976     col = style-&gt;color();
06977     fm = QFontMetrics( fn );
06978     leftBearing = fm.minLeftBearing();
06979     rightBearing = fm.minRightBearing();
06980     hei = fm.height();
06981     asc = fm.ascent();
06982     dsc = fm.descent();
06983     missp = FALSE;
06984     ha = AlignNormal;
06985     memset( widths, 0, 256 );
06986     generateKey();
06987     addRef();
06988     updateStyleFlags();
06989 }
06990 
06991 QTextFormat::QTextFormat( <font class="keyword">const</font> QFont &amp;f, <font class="keyword">const</font> QColor &amp;c, QTextFormatCollection * coll )
06992     : fn( f ), col( c ), fm( QFontMetrics( f ) ), linkColor( TRUE ),
06993       logicalFontSize( 3 ), stdPointSize( f.pointSize() ), painter( 0 ),
06994       different( NoFlags )
06995 {
06996 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
06997 <font class="preprocessor"></font>    qDebug(<font class="stringliteral">"QTextFormat with font &amp; color &amp; coll (%p), addRef. %p"</font>,coll,<font class="keyword">this</font>);
06998 <font class="preprocessor">#endif</font>
06999 <font class="preprocessor"></font>    ref = 0;
07000     collection = coll;
07001     leftBearing = fm.minLeftBearing();
07002     rightBearing = fm.minRightBearing();
07003     hei = fm.height();
07004     asc = fm.ascent();
07005     dsc = fm.descent();
07006     missp = FALSE;
07007     ha = AlignNormal;
07008     memset( widths, 0, 256 );
07009     generateKey();
07010     addRef();
07011     updateStyleFlags();
07012 }
07013 
07014 QTextFormat::QTextFormat( <font class="keyword">const</font> QTextFormat &amp;f )
07015     : fm( f.fm )
07016 {
07017 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
07018 <font class="preprocessor"></font>    <font class="comment">//qDebug("QTextFormat::QTextFormat %p copy ctor (copying %p). Will addRef.",this,&amp;f);</font>
07019 <font class="preprocessor">#endif</font>
07020 <font class="preprocessor"></font>    ref = 0;
07021     collection = 0;
07022     fn = f.fn;
07023     col = f.col;
07024     painter = f.painter;
07025     leftBearing = f.leftBearing;
07026     rightBearing = f.rightBearing;
07027     memset( widths, 0, 256 );
07028     hei = f.hei;
07029     asc = f.asc;
07030     dsc = f.dsc;
07031     stdPointSize = f.stdPointSize;
07032     logicalFontSize = f.logicalFontSize;
07033     missp = f.missp;
07034     ha = f.ha;
07035     k = f.k;
07036     anchor_name = f.anchor_name;
07037     anchor_href = f.anchor_href;
07038     linkColor = f.linkColor;
07039     style = f.style;
07040     different = f.different;
07041     addRef();
07042 }
07043 
07044 QTextFormat&amp; QTextFormat::operator=( <font class="keyword">const</font> QTextFormat &amp;f )
07045 {
07046 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
07047 <font class="preprocessor"></font>    qDebug(<font class="stringliteral">"QTextFormat::operator= %p (copying %p). Will addRef"</font>,<font class="keyword">this</font>,&amp;f);
07048 <font class="preprocessor">#endif</font>
07049 <font class="preprocessor"></font>    ref = 0;
07050     collection = f.collection;
07051     fn = f.fn;
07052     col = f.col;
07053     fm = f.fm;
07054     leftBearing = f.leftBearing;
07055     rightBearing = f.rightBearing;
07056     memset( widths, 0, 256 );
07057     hei = f.hei;
07058     asc = f.asc;
07059     dsc = f.dsc;
07060     stdPointSize = f.stdPointSize;
07061     logicalFontSize = f.logicalFontSize;
07062     missp = f.missp;
07063     ha = f.ha;
07064     k = f.k;
07065     anchor_name = f.anchor_name;
07066     anchor_href = f.anchor_href;
07067     linkColor = f.linkColor;
07068     style = f.style;
07069     different = f.different;
07070     addRef();
07071     <font class="keywordflow">return</font> *<font class="keyword">this</font>;
07072 }
07073 
07074 <font class="keywordtype">void</font> QTextFormat::update()
07075 {
07076     fm = QFontMetrics( fn );
07077     leftBearing = fm.minLeftBearing();
07078     rightBearing = fm.minRightBearing();
07079     hei = fm.height();
07080     asc = fm.ascent();
07081     dsc = fm.descent();
07082     memset( widths, 0, 256 );
07083     generateKey();
07084     updateStyleFlags();
07085 }
07086 
07087 <font class="keywordtype">void</font> QTextFormat::addRef()
07088 {
07089     ref++;
07090 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
07091 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( collection )
07092         qDebug( <font class="stringliteral">"  add ref of '%s' to %d (%p) (coll %p)"</font>, k.latin1(), ref, <font class="keyword">this</font>, collection );
07093 <font class="preprocessor">#endif</font>
07094 <font class="preprocessor"></font>}
07095 
07096 <font class="keywordtype">void</font> QTextFormat::removeRef()
07097 {
07098     ref--;
07099     <font class="keywordflow">if</font> ( !collection )
07100         <font class="keywordflow">return</font>;
07101 <font class="preprocessor">#ifdef DEBUG_COLLECTION</font>
07102 <font class="preprocessor"></font>    qDebug( <font class="stringliteral">"  remove ref of '%s' to %d (%p) (coll %p)"</font>, k.latin1(), ref, <font class="keyword">this</font>, collection );
07103 <font class="preprocessor">#endif</font>
07104 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ( ref == 0 )
07105         collection-&gt;remove( <font class="keyword">this</font> );
07106 }
07107 
07108 <font class="keywordtype">void</font> QTextParag::setTabArray( <font class="keywordtype">int</font> *a )
07109 {
07110     <font class="keywordflow">if</font> ( tArray )
07111         <font class="keyword">delete</font> [] tArray;
07112     tArray = a;
07113 }
07114 
07115 <font class="keywordtype">void</font> QTextParag::setTabStops( <font class="keywordtype">int</font> tw )
07116 {
07117     <font class="keywordflow">if</font> ( doc )
07118         doc-&gt;setTabStops( tw );
07119     <font class="keywordflow">else</font>
07120         tabStopWidth = tw;
07121 }
07122 
07123 
07124 
</pre></div><hr><address><small>Generated on Sun Mar 10 22:12:49 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
