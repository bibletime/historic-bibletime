<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>cprinter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>cprinter.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                          cprinter.cpp  -  description</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : Sat Aug 5 2000</font>
00005 <font class="comment">    copyright            : (C) 2000 by The BibleTime team</font>
00006 <font class="comment">    email                : info@bibletime.de</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> *                                                                         *</font>
00011 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00012 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00013 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00014 <font class="comment"> *   (at your option) any later version.                                   *</font>
00015 <font class="comment"> *                                                                         *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include "cprinter.h"</font>
00019 <font class="preprocessor">#include "cprintitem.h"</font>
00020 <font class="preprocessor">#include "cprintdialogpages.h"</font>
00021 
00022 <font class="preprocessor">#include "backend/cswordbackend.h"</font>
00023 <font class="preprocessor">#include "backend/cswordversekey.h"</font>
00024 <font class="preprocessor">#include "backend/cswordldkey.h"</font>
00025 
00026 <font class="comment">//KDE includes</font>
00027 <font class="preprocessor">#include &lt;kconfig.h&gt;</font>
00028 <font class="preprocessor">#include &lt;kprocess.h&gt;</font>
00029 <font class="preprocessor">#include &lt;kconfigbase.h&gt;</font>
00030 <font class="preprocessor">#include &lt;kstandarddirs.h&gt;</font>
00031 <font class="preprocessor">#include &lt;klocale.h&gt;</font>
00032 <font class="preprocessor">#include &lt;kapplication.h&gt;</font>
00033 
00034 <font class="comment">//Qt includes</font>
00035 <font class="preprocessor">#include &lt;qfile.h&gt;</font>
00036 <font class="preprocessor">#include &lt;qdir.h&gt;</font>
00037 <font class="preprocessor">#include &lt;qstringlist.h&gt;</font>
00038 <font class="preprocessor">#include &lt;qpainter.h&gt;</font>
00039 <font class="preprocessor">#include &lt;qpaintdevice.h&gt;</font>
00040 <font class="preprocessor">#include &lt;qpaintdevicemetrics.h&gt;</font>
00041 
00042 CPrinter::CPrinter( QObject* parent ) : QObject(parent) {
00043     m_config = <font class="keyword">new</font> KConfig(<font class="stringliteral">"bt-printing"</font>, <font class="keyword">false</font>, <font class="keyword">true</font> );
00044 
00045     m_queue.setAutoDelete(<font class="keyword">true</font>);            
00046     m_styleList.setAutoDelete(<font class="keyword">true</font>);        
00047     m_cachedPage.initialized = <font class="keyword">false</font>;
00048     m_cachedPage.refresh = <font class="keyword">false</font>;   
00049     m_addedItem = <font class="keyword">false</font>;
00050     
00051     {
00052         KConfigGroupSaver gs(m_config, <font class="stringliteral">"Options"</font>);  
00053         QMap&lt;QString, QString&gt; map = m_config-&gt;entryMap(<font class="stringliteral">"Options"</font>);
00054         setOptions(map);
00055     }
00056     
00057     m_styleDir = <font class="stringliteral">"printing/"</font>;
00058     KStandardDirs stdDirs;
00059     m_styleSaveLocation = stdDirs.saveLocation(<font class="stringliteral">"data"</font>, <font class="stringliteral">"bibletime/"</font>+m_styleDir);        
00060     
00061     readSettings();
00062     setupStyles();
00063     setupStandardStyle();       
00064 }
00065 
00066 CPrinter::~CPrinter(){
00067     saveSettings();
00068     saveStyles();   
00069     m_config-&gt;sync();
00070             
00071     <font class="keyword">delete</font> m_config;
00072 }
00073 
00075 <font class="keyword">const</font> <font class="keywordtype">bool</font> CPrinter::newPage(){
00076     <font class="keywordflow">if</font> (aborted()) {
00077         qWarning(<font class="stringliteral">"CPrinter::newPage: Printing was aborted!"</font>);
00078         <font class="keywordflow">return</font> <font class="keyword">false</font>;
00079     }
00080     <font class="keyword">const</font> <font class="keywordtype">bool</font> result = KPrinter::newPage();
00081     <font class="keywordflow">if</font> (result) {
00082         m_pagePosition.curPage++;
00083         m_pagePosition.rect = contentSize();            
00084         setVerticalPos(pageMargins().top);
00085     }
00086     <font class="keywordflow">return</font> result;
00087 }
00088 
00090 <font class="keywordtype">void</font> CPrinter::setAllMargins( <font class="keyword">const</font> CPageMargin margins ) {
00091     m_cachedPage.refresh = <font class="keyword">true</font>;    
00092     m_pageMargin = margins;
00093 }
00094 
00096 <font class="keyword">const</font> CPrinter::CPageMargin&amp; CPrinter::pageMargins()<font class="keyword"> const </font>{
00097     <font class="keywordflow">return</font> m_pageMargin;
00098 }
00099 
00101 <font class="keywordtype">void</font> CPrinter::setup( QWidget* parent ){
00102     KPrinter::addDialogPage( <font class="keyword">new</font> <a class="code" href="class_c_print_item_list_page.html">CPrintItemListPage</a>(<font class="keyword">this</font>) );
00103     KPrinter::addDialogPage( <font class="keyword">new</font> <a class="code" href="class_c_style_list_page.html">CStyleListPage</a>(<font class="keyword">this</font>) );
00104 
00105     <font class="keywordflow">if</font> ( KPrinter::setup(parent) ) {
00106         saveSettings();
00107         readSettings();
00108         print();
00109     }
00110 }
00111 
00113 <font class="keywordtype">void</font> CPrinter::print(){
00114     emit printingStarted();
00115     QPainter p;
00116     <font class="keywordflow">if</font> (!p.begin(<font class="keyword">this</font>)) {
00117         p.end();
00118         <font class="keywordflow">return</font>;
00119     }   
00120     <font class="keywordtype">int</font> lastPercent = 0;
00121     <font class="keywordtype">int</font> pos = 1;
00122     <font class="keyword">const</font> <font class="keywordtype">int</font> count = m_queue.count();
00123     <font class="keyword">const</font> <font class="keywordtype">int</font> copies = numCopies();
00124     <font class="keywordtype">float</font> copyFrac;
00125     emit percentCompleted(0);
00126     
00127     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> copy = 0; copy &lt; copies &amp;&amp; !aborted(); copy++) {   <font class="comment">//make numCopies() copies of the pages</font>
00128         copyFrac = (float(copies))/ (float)(copy+1);
00129         <font class="keywordflow">for</font> (m_queue.first(), pos = 1; m_queue.current(); m_queue.next(), ++pos) {
00130             KApplication::kApplication()-&gt;processEvents(5); <font class="comment">//do not lock the GUI!</font>
00131             <font class="keywordflow">if</font> (!aborted()) {
00132                 m_queue.current()-&gt;draw(&amp;p,<font class="keyword">this</font>);               
00133                 <font class="keywordflow">if</font> ((int)((float)pos / (float)count *(float)100 * copyFrac) &gt; lastPercent)
00134                     emit percentCompleted(++lastPercent);
00135             }
00136         };
00137         <font class="keywordflow">if</font> (!aborted() &amp;&amp; (copy+1 &lt; copies) )
00138             newPage();  <font class="comment">//new pages seperate copies</font>
00139     }
00140     emit printingFinished();    
00141     clearQueue();<font class="comment">//delete all items</font>
00142 }
00143 
00145 <font class="keywordtype">void</font> CPrinter::appendItems( ListCPrintItem&amp; items ){
00146     <font class="keywordflow">for</font>(items.first(); items.current(); items.next()) {
00147         items.current()-&gt;setStyle(m_standardStyle);
00148         m_queue.append(items.current());
00149     }
00150     <font class="keywordflow">if</font> (items.count() &amp;&amp; !m_addedItem) {
00151         m_addedItem = <font class="keyword">true</font>;
00152         emit addedFirstQueueItem(); 
00153     }
00154 }
00155 
00157 <font class="keywordtype">void</font> CPrinter::clearQueue(){
00158     m_queue.clear();
00159     m_addedItem = <font class="keyword">false</font>;<font class="comment">//queue is empty    </font>
00160     emit queueCleared();    
00161 }
00162 
00164 ListCPrintItem&amp; CPrinter::printQueue() {
00165     <font class="keywordflow">return</font> m_queue;
00166 }
00167 
00169 <font class="keywordtype">void</font> CPrinter::setPrintQueue( ListCPrintItem&amp; queue ){
00170     clearQueue();
00171     m_queue = queue; <font class="comment">//copy items</font>
00172 }
00173 
00175 <font class="keywordtype">void</font> CPrinter::appendItem(<a class="code" href="class_c_print_item.html">CPrintItem</a>* newItem){
00176     <font class="keywordflow">if</font> (!newItem)
00177         <font class="keywordflow">return</font>;
00178     newItem-&gt;<a class="code" href="class_c_print_item.html#a1">setStyle</a>(m_standardStyle);
00179     m_queue.append(newItem);
00180 
00181     <font class="keywordflow">if</font> (!m_addedItem) {
00182         m_addedItem = <font class="keyword">true</font>;
00183         emit addedFirstQueueItem();
00184     }
00185 }
00186 
00188 <font class="keywordtype">void</font> CPrinter::setupStyles(){   
00189 <font class="comment">//load local styles </font>
00190     QDir d( m_styleSaveLocation );
00191     QStringList files = d.entryList(<font class="stringliteral">"*.xml"</font>);
00192     <font class="keywordflow">for</font> ( QStringList::Iterator it = files.begin(); it != files.end(); ++it ) {
00193         m_styleList.append( <font class="keyword">new</font> CStyle(m_styleSaveLocation + *it) ); <font class="comment">//automatically load from file     </font>
00194     }
00195     
00196 <font class="comment">//load systemwide styles, probably standard styles installed by BibleTime</font>
00197     KStandardDirs stdDirs;
00198     QStringList globalPaths = stdDirs.findDirs(<font class="stringliteral">"data"</font>, <font class="stringliteral">"bibletime/"</font>+m_styleDir);
00199     <font class="keywordflow">if</font> (globalPaths.count()) { <font class="comment">//try to find some new global styles </font>
00200         <font class="keywordflow">for</font> (QStringList::Iterator path = globalPaths.begin(); path!=globalPaths.end(); ++path) {
00201             d = QDir( *path );
00202             QStringList files = d.entryList(<font class="stringliteral">"*.xml"</font>);
00203             <font class="keywordflow">for</font> ( QStringList::Iterator it = files.begin(); it != files.end(); ++it ) {
00204                 CStyle* newStyle = <font class="keyword">new</font> CStyle(*path + *it);
00205                 
00206                 <font class="keywordtype">bool</font> found = <font class="keyword">false</font>;             
00207                 <font class="keywordflow">for</font>(m_styleList.first(); m_styleList.current() &amp;&amp; !found; m_styleList.next()) {
00208                     <font class="keywordflow">if</font> (newStyle-&gt;styleName() == m_styleList.current()-&gt;styleName()) {
00209                         found = <font class="keyword">true</font>;
00210                     }
00211                 }       
00212                 
00213                 <font class="keywordflow">if</font> (!found) {
00214                     m_styleList.append( newStyle );
00215                 }
00216             }       
00217         }
00218     }
00219 }
00220 
00222 <font class="keywordtype">void</font> CPrinter::saveStyles(){
00223     QDir d(m_styleSaveLocation);    
00224     QStringList files = d.entryList(<font class="stringliteral">"*.xml"</font>);
00225     <font class="keywordflow">for</font> ( QStringList::Iterator it = files.begin(); it != files.end(); ++it ) {
00226         d.remove(*it);
00227     }
00228     
00229     <font class="keywordflow">for</font> (m_styleList.first(); m_styleList.current(); m_styleList.next()) {
00230         m_styleList.current()-&gt;save(  m_styleSaveLocation + QString::fromLatin1(<font class="stringliteral">"printing-style-%1"</font>).arg(m_styleList.at()) + <font class="stringliteral">".xml"</font> );
00231     }
00232 }
00233 
00235 <font class="keywordtype">void</font> CPrinter::readSettings(){
00236     KConfigGroupSaver gs(m_config, <font class="stringliteral">"Settings"</font>);
00237     <font class="keyword">const</font> QString leading = <font class="stringliteral">"kde-bibletime-"</font>;
00238         
00239     setFullPage(<font class="keyword">true</font>);
00240     m_pagePosition.curPage = 1;
00241     m_pagePosition.rect = contentSize();
00242 
00243     QPaintDeviceMetrics m(<font class="keyword">this</font>);
00244     <font class="keyword">const</font> <font class="keywordtype">float</font> r = static_cast&lt;float&gt;(m.width()) / m.widthMM();        
00245     m_pageMargin.left   = (int)(r * m_config-&gt;readNumEntry(<font class="stringliteral">"Left margin"</font>, 15));
00246     setOption(leading+<font class="stringliteral">"left_margin"</font>, QString::number(m_config-&gt;readNumEntry(<font class="stringliteral">"Left margin"</font>, 15)));
00247     
00248     m_pageMargin.right  = (int)(r * m_config-&gt;readNumEntry(<font class="stringliteral">"Right margin"</font>, 15));
00249     setOption(leading+<font class="stringliteral">"right_margin"</font>, QString::number(m_config-&gt;readNumEntry(<font class="stringliteral">"Right margin"</font>, 15)));
00250         
00251     m_pageMargin.top        = (int)(r * m_config-&gt;readNumEntry(<font class="stringliteral">"Top margin"</font>, 15));
00252     setOption(leading+<font class="stringliteral">"upper_margin"</font>, QString::number(m_config-&gt;readNumEntry(<font class="stringliteral">"Top margin"</font>, 15)));
00253         
00254     m_pageMargin.bottom = (int)(r * m_config-&gt;readNumEntry(<font class="stringliteral">"Bottom margin"</font>, 15));
00255     setOption(leading+<font class="stringliteral">"lower_margin"</font>, QString::number(m_config-&gt;readNumEntry(<font class="stringliteral">"Bottom margin"</font>, 15)));        
00256     
00257     m_cachedPage.refresh = <font class="keyword">true</font>;    
00258 }
00259 
00261 <font class="keywordtype">void</font> CPrinter::saveSettings(){  
00262     <font class="keyword">const</font> QString leading = <font class="stringliteral">"kde-bibletime-"</font>;
00263     KConfigGroupSaver gs(m_config, <font class="stringliteral">"Settings"</font>);
00264     m_config-&gt;writeEntry(<font class="stringliteral">"Left margin"</font>, option(leading+<font class="stringliteral">"left_margin"</font>).toInt());
00265     m_config-&gt;writeEntry(<font class="stringliteral">"Right margin"</font>, option(leading+<font class="stringliteral">"right_margin"</font>).toInt());
00266     m_config-&gt;writeEntry(<font class="stringliteral">"Top margin"</font>, option(leading+<font class="stringliteral">"upper_margin"</font>).toInt());
00267     m_config-&gt;writeEntry(<font class="stringliteral">"Bottom margin"</font>, option(leading+<font class="stringliteral">"lower_margin"</font>).toInt());
00268 }
00269 
00271 StyleItemList&amp; CPrinter::styleList() {
00272     <font class="keywordflow">return</font> m_styleList;
00273 }
00274 
00276 <font class="keywordtype">void</font> CPrinter::setStyleList( StyleItemList&amp; list){
00277     m_styleList = list; <font class="comment">//copy items</font>
00278 }
00279 
00281 <font class="keyword">const</font> QRect CPrinter::contentSize() {
00282   <font class="keywordflow">if</font>    (   m_cachedPage.refresh || !m_cachedPage.initialized || (m_cachedPage.initialized &amp;&amp; (m_cachedPage.cachedPaper != pageSize())) )
00283   { <font class="comment">//refresh page size info</font>
00284         m_cachedPage.initialized = <font class="keyword">true</font>;
00285         m_cachedPage.refresh = <font class="keyword">false</font>;
00286         m_cachedPage.cachedPaper = pageSize();      
00287         
00288       QPaintDeviceMetrics metric( <font class="keyword">this</font> ); <font class="comment">//note that metric's width and height span the whole page             </font>
00289       m_cachedPage.size.setLeft( m_pageMargin.left );
00290       m_cachedPage.size.setTop( m_pageMargin.top );
00291       m_cachedPage.size.setRight( metric.width() -  m_pageMargin.right );
00292       m_cachedPage.size.setBottom( metric.height() <font class="comment">/*- m_pageMargin.top*/</font> - m_pageMargin.bottom );
00293     }
00294   <font class="keywordflow">return</font> m_cachedPage.size;
00295 }
00296 
00298 KConfig* <font class="keyword">const</font> CPrinter::config()<font class="keyword"> const </font>{
00299     <font class="keywordflow">return</font> m_config;    
00300 }
00301 
00303 <font class="keywordtype">void</font> CPrinter::setupStandardStyle(){
00304     <font class="comment">//see if m_items contains standard style</font>
00305     <font class="keywordtype">bool</font> found = <font class="keyword">false</font>;
00306     <font class="keywordflow">for</font> (m_styleList.first(); m_styleList.current(); m_styleList.next()) {
00307         <font class="keywordflow">if</font> (m_styleList.current()-&gt;styleName() == i18n(<font class="stringliteral">"Standard"</font>)) {   <font class="comment">//found the style</font>
00308             found = <font class="keyword">true</font>;
00309             m_standardStyle = m_styleList.current();
00310             <font class="keywordflow">break</font>;
00311         }
00312     }
00313         
00314     <font class="keywordflow">if</font> (!found) {
00315         m_standardStyle = <font class="keyword">new</font> CStyle();     
00316         m_standardStyle-&gt;setStyleName(i18n(<font class="stringliteral">"Standard"</font>));        
00317         m_styleList.append( m_standardStyle );
00318     }
00319 }
00320 
00322 <font class="keyword">const</font> <font class="keywordtype">int</font> CPrinter::verticalPos()<font class="keyword"> const </font>{
00323     <font class="keywordflow">return</font> m_pagePosition.rect.y();
00324 }
00325 
00327 <font class="keywordtype">void</font> CPrinter::setVerticalPos( <font class="keyword">const</font> <font class="keywordtype">int</font> yPos ){
00328     m_pagePosition.rect.setY(yPos);
00329 }
00330 
00332 <font class="keywordtype">void</font> CPrinter::emitStylesChanged(){
00333     emit sigStylesChanged();
00334 }
00335 
00337 CStyle* <font class="keyword">const</font> CPrinter::standardStyle()<font class="keyword"> const </font>{
00338     <font class="keywordflow">return</font> m_standardStyle;
00339 }
</pre></div><hr><address align="right"><small>Generated on Sun May 12 20:27:13 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
