<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>cmainindex.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>cmainindex.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                          cmainindex.cpp  -  description</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : Sam Jun 22 2002</font>
00005 <font class="comment">    copyright            : (C) 2002 by The BibleTime team</font>
00006 <font class="comment">    email                : info@bibletime.de</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> *                                                                         *</font>
00011 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00012 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00013 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00014 <font class="comment"> *   (at your option) any later version.                                   *</font>
00015 <font class="comment"> *                                                                         *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">//BibleTime includes</font>
00019 <font class="preprocessor">#include "cmainindex.h"</font>
00020 <font class="preprocessor">#include "cindexitem.h"</font>
00021 
00022 <font class="preprocessor">#include "backend/creferencemanager.h"</font>
00023 <font class="preprocessor">#include "frontend/searchdialog/csearchdialog.h"</font>
00024 
00025 <font class="preprocessor">#include "resource.h"</font>
00026 <font class="preprocessor">#include "tooltipdef.h"</font>
00027 <font class="preprocessor">#include "whatsthisdef.h"</font>
00028 
00029 <font class="comment">//Qt includes</font>
00030 <font class="preprocessor">#include &lt;qheader.h&gt;</font>
00031 <font class="preprocessor">#include &lt;qwhatsthis.h&gt;</font>
00032 <font class="preprocessor">#include &lt;qlistview.h&gt;</font>
00033 <font class="preprocessor">#include &lt;qdragobject.h&gt;</font>
00034 <font class="preprocessor">#include &lt;qinputdialog.h&gt;</font>
00035 
00036 <font class="comment">//KDE includes</font>
00037 <font class="preprocessor">#include &lt;klocale.h&gt;</font>
00038 <font class="preprocessor">#include &lt;kstandarddirs.h&gt;</font>
00039 <font class="preprocessor">#include &lt;kpopupmenu.h&gt;</font>
00040 <font class="preprocessor">#include &lt;kmessagebox.h&gt;</font>
00041 <font class="preprocessor">#include &lt;kglobalsettings.h&gt;</font>
00042 
00043 CMainIndex::ToolTip::ToolTip(QWidget* parent) : <a class="code" href="class_c_tool_tip.html">CToolTip</a>(parent) {
00044 }
00045 
00046 <font class="keywordtype">void</font> CMainIndex::ToolTip::maybeTip(<font class="keyword">const</font> QPoint&amp; p) {
00047     <font class="keywordflow">if</font> (!parentWidget()-&gt;inherits(<font class="stringliteral">"CMainIndex"</font>))
00048         <font class="keywordflow">return</font>;
00049     
00050     CMainIndex* m = 0;
00051     <font class="keywordflow">if</font> ( !(m = dynamic_cast&lt;CMainIndex*&gt;(parentWidget())) )
00052         <font class="keywordflow">return</font>; 
00053 
00054   CItemBase* i = 0;
00055     <font class="keywordflow">if</font> ( !( i = dynamic_cast&lt;CItemBase*&gt;(m-&gt;itemAt(p))) )
00056         <font class="keywordflow">return</font>;
00057     
00058     QRect r = m-&gt;itemRect(i);
00059     <font class="keywordflow">if</font> (!r.isValid())
00060         <font class="keywordflow">return</font>;
00061     
00062     <font class="comment">//get type of item and display correct text</font>
00063     <font class="keyword">const</font> QString text = i-&gt;toolTip();
00064     <font class="keywordflow">if</font> (!text.isEmpty()) {
00065     QPoint globalPoint = m-&gt;viewport()-&gt;mapTo(m, p);
00066         tip(globalPoint, r, text);
00067     }
00068 }
00069 
00070 <font class="comment">/*new class : CMainIndex*/</font>
00071 CMainIndex::CMainIndex(QWidget *parent) : KListView(parent),
00072   m_searchDialog(0), m_toolTip(0), m_itemsMovable(false), m_autoOpenFolder(0), m_autoOpenTimer(this)
00073 {
00074   qWarning(<font class="stringliteral">"constructor of CMainIndex!"</font>);
00075   <a class="code" href="class_c_lexicon_read_window.html#b2">initView</a>();
00076   <a class="code" href="class_c_lexicon_read_window.html#b1">initConnections</a>();
00077 }
00078 
00079 CMainIndex::~CMainIndex(){
00080   qWarning(<font class="stringliteral">"destructor of CMainIndex"</font>);
00081 
00082   <font class="comment">//find the bookmark folder</font>
00083   CItemBase* i = 0;
00084   QListViewItemIterator it( <font class="keyword">this</font> );
00085   <font class="keywordflow">while</font> ( it.current() != 0 ) {
00086     i = dynamic_cast&lt;CItemBase*&gt;( it.current() );
00087     <font class="keywordflow">if</font> (i &amp;&amp; i-&gt;type() == CItemBase::BookmarkFolder) { <font class="comment">//found the bookmark folder</font>
00088       KStandardDirs stdDirs;
00089         <font class="keyword">const</font> QString path = stdDirs.saveLocation(<font class="stringliteral">"data"</font>, <font class="stringliteral">"bibletime/"</font>);    
00090       <font class="keywordflow">if</font> (!path.isEmpty()) {
00091         <font class="comment">//save the bookmarks to the right file</font>
00092         <font class="keywordflow">if</font> (CBookmarkFolder* f = dynamic_cast&lt;CBookmarkFolder*&gt;(i))
00093           f-&gt;saveBookmarks( path + <font class="stringliteral">"bookmarks.xml"</font> );
00094       }
00095       <font class="keywordflow">break</font>;
00096     }
00097     ++it;
00098   }
00099 }
00100 
00102 <font class="keywordtype">void</font> CMainIndex::addGroup(<font class="keyword">const</font> CItemBase::Type type, <font class="keyword">const</font> QString language){
00103   <a class="code" href="class_c_tree_folder.html">CTreeFolder</a> *i = 0;
00104   <font class="keywordflow">if</font> (type == CItemBase::BookmarkFolder)
00105     i = <font class="keyword">new</font> CBookmarkFolder(<font class="keyword">this</font>);
00106   <font class="keywordflow">else</font>
00107     i = <font class="keyword">new</font> <a class="code" href="class_c_tree_folder.html">CTreeFolder</a>(<font class="keyword">this</font>, type, language);
00108   i-&gt;<a class="code" href="class_c_tree_folder.html#a8">init</a>();
00109 
00110   <font class="keywordflow">if</font> (!i-&gt;childCount() &amp;&amp; type != CItemBase::BookmarkFolder)
00111     <font class="keyword">delete</font> i;
00112 }
00113 
00114 
00116 <font class="keywordtype">void</font> CMainIndex::initView(){
00117   setRootIsDecorated(<font class="keyword">true</font>);
00118     addColumn(i18n(<font class="stringliteral">"Caption"</font>));
00119     header()-&gt;hide();
00120 
00121     m_toolTip = <font class="keyword">new</font> ToolTip(<font class="keyword">this</font>);
00122   setTooltipColumn(-1);
00123   setShowToolTips(<font class="keyword">false</font>);<font class="comment">//to disable Qt's tooltips     </font>
00124     QWhatsThis::add(<font class="keyword">this</font>, WT_GM_WIDGET );
00125             
00126     setBackgroundMode(PaletteBase);
00127     setSorting(-1);
00128   setFullWidth(<font class="keyword">true</font>);
00129 
00130   setAcceptDrops( <font class="keyword">true</font> );
00131   setDragEnabled( <font class="keyword">true</font> );
00132   setDropVisualizer( <font class="keyword">true</font> );
00133   setDropHighlighter( <font class="keyword">true</font> );
00134   setAutoOpen(<font class="keyword">true</font>);
00135     viewport()-&gt;setAcceptDrops(<font class="keyword">true</font>);
00136     setRootIsDecorated(<font class="keyword">false</font>);
00137     setAllColumnsShowFocus(<font class="keyword">true</font>);
00138   setItemsMovable(<font class="keyword">false</font>);
00139   setSelectionModeExt(Extended);
00140 
00141   <font class="comment">//setup the popup menu</font>
00142   m_popup = <font class="keyword">new</font> KPopupMenu(<font class="keyword">this</font>);
00143   m_popup-&gt;insertTitle(i18n(<font class="stringliteral">"Main index"</font>));
00144 
00145   m_actions.newFolder = <font class="keyword">new</font> KAction(i18n(<font class="stringliteral">"Create a new folder"</font>),GROUP_NEW_ICON_SMALL, 0, <font class="keyword">this</font>, SLOT(createNewFolder()), <font class="keyword">this</font>);
00146   m_actions.changeFolder = <font class="keyword">new</font> KAction(i18n(<font class="stringliteral">"Change this folder"</font>),GROUP_CHANGE_ICON_SMALL, 0, <font class="keyword">this</font>, SLOT(changeFolder()), <font class="keyword">this</font>);
00147 
00148   m_actions.changeBookmark = <font class="keyword">new</font> KAction(i18n(<font class="stringliteral">"Change this bookmark"</font>),BOOKMARK_CHANGE_ICON_SMALL, 0, <font class="keyword">this</font>, SLOT(changeBookmark()), <font class="keyword">this</font>);
00149   m_actions.importBookmarks = <font class="keyword">new</font> KAction(i18n(<font class="stringliteral">"Import bookmarks"</font>),BOOKMARK_IMPORT_ICON_SMALL, 0, <font class="keyword">this</font>, SLOT(importBookmarks()), <font class="keyword">this</font>);
00150   m_actions.exportBookmarks = <font class="keyword">new</font> KAction(i18n(<font class="stringliteral">"Export bookmarks"</font>),BOOKMARK_EXPORT_ICON_SMALL, 0, <font class="keyword">this</font>, SLOT(exportBookmarks()), <font class="keyword">this</font>);
00151   m_actions.printBookmarks = <font class="keyword">new</font> KAction(i18n(<font class="stringliteral">"Print bookmarks"</font>),BOOKMARK_PRINT_ICON_SMALL, 0, <font class="keyword">this</font>, SLOT(printBookmarks()), <font class="keyword">this</font>);
00152 
00153   m_actions.deleteEntries = <font class="keyword">new</font> KAction(i18n(<font class="stringliteral">"Remove selected item(s)"</font>),ITEMS_DELETE_ICON_SMALL, 0, <font class="keyword">this</font>, SLOT(deleteEntries()), <font class="keyword">this</font>);
00154 
00155   m_actions.searchInModules = <font class="keyword">new</font> KAction(i18n(<font class="stringliteral">"Search in selected module(s)"</font>),MODULE_SEARCH_ICON_SMALL, 0, <font class="keyword">this</font>, SLOT(searchInModules()), <font class="keyword">this</font>);
00156   m_actions.unlockModule = <font class="keyword">new</font> KAction(i18n(<font class="stringliteral">"Unlock this module"</font>),MODULE_UNLOCK_ICON_SMALL, 0, <font class="keyword">this</font>, SLOT(unlockModule()), <font class="keyword">this</font>);
00157   m_actions.aboutModule = <font class="keyword">new</font> KAction(i18n(<font class="stringliteral">"About this module"</font>),MODULE_ABOUT_ICON_SMALL, 0, <font class="keyword">this</font>, SLOT(aboutModule()), <font class="keyword">this</font>);
00158 
00159 
00160   m_actions.newFolder-&gt;plug(m_popup);
00161   m_actions.changeFolder-&gt;plug(m_popup);
00162   (<font class="keyword">new</font> KActionSeparator(<font class="keyword">this</font>))-&gt;plug(m_popup);
00163   m_actions.changeBookmark-&gt;plug(m_popup);
00164   m_actions.importBookmarks-&gt;plug(m_popup);
00165   m_actions.exportBookmarks-&gt;plug(m_popup);
00166   m_actions.printBookmarks-&gt;plug(m_popup);
00167   (<font class="keyword">new</font> KActionSeparator(<font class="keyword">this</font>))-&gt;plug(m_popup);
00168   m_actions.deleteEntries-&gt;plug(m_popup);
00169   (<font class="keyword">new</font> KActionSeparator(<font class="keyword">this</font>))-&gt;plug(m_popup);
00170   m_actions.searchInModules-&gt;plug(m_popup);
00171   m_actions.unlockModule-&gt;plug(m_popup);
00172   m_actions.aboutModule-&gt;plug(m_popup);
00173 }
00174 
00176 <font class="keywordtype">void</font> CMainIndex::initConnections(){
00177   connect(<font class="keyword">this</font>, SIGNAL(executed(QListViewItem*)),
00178     SLOT(slotExecuted(QListViewItem*)));
00179   connect(<font class="keyword">this</font>, SIGNAL(dropped(QDropEvent*, QListViewItem*)),
00180     SLOT(dropped(QDropEvent*, QListViewItem*)));
00181 <font class="comment">//  connect(this, SIGNAL(moved( QPtrList&lt;QListViewItem&gt;&amp; items, QPtrList&lt;QListViewItem&gt;&amp; afterFirst, QPtrList&lt;QListViewItem&gt;&amp; afterNow)),</font>
00182 <font class="comment">//    SLOT(moved( QPtrList&lt;QListViewItem&gt;&amp; items, QPtrList&lt;QListViewItem&gt;&amp; afterFirst, QPtrList&lt;QListViewItem&gt;&amp; afterNow)));</font>
00183   connect(<font class="keyword">this</font>, SIGNAL(contextMenu(KListView*, QListViewItem*, <font class="keyword">const</font> QPoint&amp;)),
00184     SLOT(contextMenu(KListView*, QListViewItem*, <font class="keyword">const</font> QPoint&amp;)));
00185   connect(&amp;m_autoOpenTimer, SIGNAL(timeout()),
00186     <font class="keyword">this</font>, SLOT(autoOpenTimeout()));
00187 }
00188 
00190 <font class="keywordtype">void</font> CMainIndex::slotExecuted( QListViewItem* i ){
00191   CItemBase* ci = dynamic_cast&lt;CItemBase*&gt;(i);
00192   <font class="keywordflow">if</font> (!ci)
00193     <font class="keywordflow">return</font>;
00194 
00195   <font class="keywordflow">if</font> (ci-&gt;isFolder()) {
00196     i-&gt;setOpen(!i-&gt;isOpen());
00197   }
00198   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (CModuleItem* m = dynamic_cast&lt;CModuleItem*&gt;(i))  { <font class="comment">//clicked on a module</font>
00199     <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* mod = m-&gt;module();
00200     ListCSwordModuleInfo <a class="code" href="class_c_display_window.html#a2">modules</a>;
00201     <a class="code" href="class_c_display_window.html#a2">modules</a>.append(mod);
00202 
00203     emit modulesChosen(<a class="code" href="class_c_display_window.html#a2">modules</a>, QString::null);
00204   }
00205   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (CBookmarkItem* b = dynamic_cast&lt;CBookmarkItem*&gt;(i) ) { <font class="comment">//clicked on a bookmark</font>
00206     <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* mod = b-&gt;module();
00207     ListCSwordModuleInfo <a class="code" href="class_c_display_window.html#a2">modules</a>;
00208     <a class="code" href="class_c_display_window.html#a2">modules</a>.append(mod);
00209 
00210     emit modulesChosen(<a class="code" href="class_c_display_window.html#a2">modules</a>, b-&gt;key());
00211   }
00212 }
00213 
00215 QDragObject* CMainIndex::dragObject() {
00216   <font class="keywordflow">if</font> (CBookmarkItem* bookmark = dynamic_cast&lt;CBookmarkItem*&gt;(currentItem())) {
00217     <font class="keyword">const</font> QString ref = bookmark-&gt;key();
00218     <font class="keyword">const</font> QString mod = bookmark-&gt;module()-&gt;name();
00219 
00220       QTextDrag* d = <font class="keyword">new</font> QTextDrag(<a class="code" href="class_c_reference_manager.html#d2">CReferenceManager::encodeReference</a>(mod,ref), viewport());
00221     d-&gt;setSubtype(BOOKMARK);
00222     <font class="keywordflow">return</font> d;
00223   }
00224   <font class="keywordflow">return</font> 0;
00225 }
00226 
00228 <font class="keywordtype">bool</font> CMainIndex::acceptDrag( QDropEvent* event )<font class="keyword"> const </font>{
00229   qWarning(<font class="stringliteral">"CMainIndex::acceptDrag( QDropEvent* event )"</font>);
00230   <font class="keywordflow">if</font> (m_itemsMovable) {
00231     qWarning(<font class="stringliteral">"return true"</font>);
00232     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00233   }
00234 
00235   QPoint pos = contentsToViewport(event-&gt;pos());
00236   <font class="keywordflow">if</font> (QListViewItem* i = itemAt(pos)) {
00237     <font class="keywordflow">return</font> i-&gt;acceptDrop(event);
00238   }
00239   <font class="keywordflow">return</font> <font class="keyword">false</font>;
00240 }
00241 
00243 <font class="keywordtype">void</font> CMainIndex::initTree(){
00244   addGroup(CItemBase::BookmarkFolder, QString::fromLatin1(<font class="stringliteral">"*"</font>));
00245   addGroup(CItemBase::BibleModuleFolder, QString::fromLatin1(<font class="stringliteral">"*"</font>));
00246   addGroup(CItemBase::BookModuleFolder, QString::fromLatin1(<font class="stringliteral">"*"</font>));
00247   addGroup(CItemBase::CommentaryModuleFolder, QString::fromLatin1(<font class="stringliteral">"*"</font>));
00248   addGroup(CItemBase::DevotionalModuleFolder, QString::fromLatin1(<font class="stringliteral">"*"</font>));
00249   addGroup(CItemBase::GlossaryModuleFolder, QString::fromLatin1(<font class="stringliteral">"*"</font>));
00250   addGroup(CItemBase::LexiconModuleFolder, QString::fromLatin1(<font class="stringliteral">"*"</font>));
00251 }
00252 
00254 <font class="keywordtype">void</font> CMainIndex::dropped( QDropEvent* e, QListViewItem* after){
00255   qWarning(<font class="stringliteral">"CMainIndex::dropped( QDropEvent* e, QListViewItem* after)"</font>);
00256 <font class="comment">//  if (m_itemsMovable)</font>
00257 <font class="comment">//    KListView::dropped(e, after);</font>
00258   <font class="keywordflow">if</font> (CItemBase* i = dynamic_cast&lt;CItemBase*&gt;(after))
00259     i-&gt;dropped(e);
00260 }
00261 
00263 <font class="keywordtype">void</font> CMainIndex::openSearchDialog( ListCSwordModuleInfo modules, <font class="keyword">const</font> QString searchText){
00264     <font class="keywordflow">if</font> (!m_searchDialog)
00265         m_searchDialog = <font class="keyword">new</font> <a class="code" href="class_c_search_dialog.html">CSearchDialog</a>(<a class="code" href="class_c_display_window.html#a2">modules</a>,0);
00266     <font class="keywordflow">else</font>
00267         m_searchDialog-&gt;setModuleList(<a class="code" href="class_c_display_window.html#a2">modules</a>);
00268   m_searchDialog-&gt;setSearchText(searchText);
00269   m_searchDialog-&gt;show();
00270   m_searchDialog-&gt;raise();
00271     <font class="keywordflow">if</font> (!searchText.isEmpty())
00272     m_searchDialog-&gt;startSearch();  
00273 
00274 }
00275 
00277 <font class="keywordtype">void</font> CMainIndex::emitModulesChosen( ListCSwordModuleInfo modules, QString key ){
00278   emit modulesChosen(<a class="code" href="class_c_display_window.html#a2">modules</a>, <a class="code" href="class_c_display_window.html#a16">key</a>);
00279 }
00280 
00282 KAction* CMainIndex::action( <font class="keyword">const</font> CItemBase::MenuAction type ){
00283   <font class="keywordflow">switch</font> (type) {
00284     <font class="keywordflow">case</font> CItemBase::NewFolder:
00285       <font class="keywordflow">return</font> m_actions.newFolder;
00286     <font class="keywordflow">case</font> CItemBase::ChangeFolder:
00287       <font class="keywordflow">return</font> m_actions.changeFolder;
00288 
00289     <font class="keywordflow">case</font> CItemBase::ChangeBookmark:
00290       <font class="keywordflow">return</font> m_actions.changeBookmark;
00291     <font class="keywordflow">case</font> CItemBase::ImportBookmarks:
00292       <font class="keywordflow">return</font> m_actions.importBookmarks;
00293     <font class="keywordflow">case</font> CItemBase::ExportBookmarks:
00294       <font class="keywordflow">return</font> m_actions.exportBookmarks;
00295     <font class="keywordflow">case</font> CItemBase::PrintBookmarks:
00296       <font class="keywordflow">return</font> m_actions.printBookmarks;
00297 
00298     <font class="keywordflow">case</font> CItemBase::DeleteEntries:
00299       <font class="keywordflow">return</font> m_actions.deleteEntries;
00300     <font class="keywordflow">case</font> CItemBase::SearchInModules:
00301       <font class="keywordflow">return</font> m_actions.searchInModules;
00302     <font class="keywordflow">case</font> CItemBase::UnlockModule:
00303       <font class="keywordflow">return</font> m_actions.unlockModule;
00304     <font class="keywordflow">case</font> CItemBase::AboutModule:
00305       <font class="keywordflow">return</font> m_actions.aboutModule;
00306     <font class="keywordflow">default</font>:
00307       <font class="keywordflow">return</font> 0;
00308   };
00309 }
00310 
00312 <font class="keywordtype">void</font> CMainIndex::contextMenu(KListView* list, QListViewItem* i, <font class="keyword">const</font> QPoint&amp; p){
00313   <font class="comment">//setup menu entries depending on current selection</font>
00314   QPtrList&lt;QListViewItem&gt; items = selectedItems();
00315 
00316   <font class="keywordflow">if</font> (items.count() == 0) { <font class="comment">//special handling for no selection</font>
00317 
00318   }
00319   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (items.count() == 1) { <font class="comment">//special handling for one selected item</font>
00320     CItemBase* item = dynamic_cast&lt;CItemBase*&gt;(i);
00321     CItemBase::MenuAction actionType;
00322     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> index = CItemBase::ActionBegin; index &lt;= CItemBase::ActionEnd; ++index) {
00323       actionType = static_cast&lt;CItemBase::MenuAction&gt;(index);
00324       <font class="keywordflow">if</font> (KAction* a = action(actionType))
00325         a-&gt;setEnabled(item-&gt;enableAction(actionType));
00326     }
00327   }
00328   <font class="keywordflow">else</font> {
00329     <font class="comment">//first disable all actions</font>
00330     CItemBase::MenuAction actionType;
00331     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> index = CItemBase::ActionBegin; index &lt;= CItemBase::ActionEnd; ++index) {
00332       actionType = static_cast&lt;CItemBase::MenuAction&gt;(index);
00333       <font class="keywordflow">if</font> (KAction* a = action(actionType))
00334         a-&gt;setEnabled(<font class="keyword">false</font>);
00335     }
00336 
00337     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> index = CItemBase::ActionBegin; index &lt;= CItemBase::ActionEnd; ++index) {
00338       actionType = static_cast&lt;CItemBase::MenuAction&gt;(index);
00339       <font class="keywordtype">bool</font> enableAction = isMultiAction(actionType);
00340       <font class="keywordflow">for</font> (items.first(); items.current(); items.next()) {
00341         CItemBase* i = dynamic_cast&lt;CItemBase*&gt;(items.current());
00342         enableAction = enableAction &amp;&amp; i-&gt;enableAction(actionType);
00343       }
00344       <font class="keywordflow">if</font> (enableAction) {
00345         KAction* a = action(actionType) ;
00346         <font class="keywordflow">if</font> (i &amp;&amp; a)
00347           a-&gt;setEnabled(enableAction);
00348       }
00349     }
00350   }
00351   m_popup-&gt;exec(p);
00352 }
00353 
00355 <font class="keywordtype">void</font> CMainIndex::createNewFolder(){
00356   <font class="keywordflow">if</font> (CFolderBase* i = dynamic_cast&lt;CFolderBase*&gt;(currentItem()) ) {
00357     i-&gt;newSubFolder();
00358   }
00359 }
00360 
00362 <font class="keywordtype">void</font> CMainIndex::changeFolder(){
00363   <font class="keywordflow">if</font> (CFolderBase* i = dynamic_cast&lt;CFolderBase*&gt;(currentItem()) ) {
00364     i-&gt;rename();
00365   }
00366 }
00367 
00369 <font class="keywordtype">void</font> CMainIndex::changeBookmark(){
00370   <font class="keywordflow">if</font> (CBookmarkItem* i = dynamic_cast&lt;CBookmarkItem*&gt;(currentItem()) ) {
00371     i-&gt;rename();
00372   }
00373 }
00374 
00376 <font class="keywordtype">void</font> CMainIndex::exportBookmarks(){
00377   <font class="keywordflow">if</font> (CBookmarkFolder* i = dynamic_cast&lt;CBookmarkFolder*&gt;(currentItem()) ) {
00378     i-&gt;exportBookmarks();
00379   }
00380 }
00381 
00383 <font class="keywordtype">void</font> CMainIndex::importBookmarks(){
00384   <font class="keywordflow">if</font> (CBookmarkFolder* i = dynamic_cast&lt;CBookmarkFolder*&gt;(currentItem()) ) {
00385     i-&gt;importBookmarks();
00386   }
00387 }
00388 
00390 <font class="keywordtype">void</font> CMainIndex::printBookmarks(){
00391   QPtrList&lt;QListViewItem&gt; items = selectedItems();
00392   <font class="keywordflow">for</font> (items.first(); items.current(); items.next()) {
00393     <font class="keywordflow">if</font> (CBookmarkItem* i = dynamic_cast&lt;CBookmarkItem*&gt;(items.current())) {
00394       i-&gt;print();
00395     }
00396   }
00397 }
00398 
00400 <font class="keywordtype">void</font> CMainIndex::deleteEntries(){
00401   QPtrList&lt;QListViewItem&gt; items = selectedItems();
00402   QPtrList&lt;QListViewItem&gt; deleteItems;
00403 
00404   <font class="keywordflow">for</font> (items.first(); items.current(); items.next()) {
00405     <font class="keywordflow">if</font> (CItemBase* i = dynamic_cast&lt;CItemBase*&gt;(items.current())) {
00406       <font class="keywordflow">if</font> (i-&gt;enableAction(CItemBase::DeleteEntries)) {
00407         deleteItems.append(i);
00408       }
00409     }
00410   }
00411 
00412   deleteItems.setAutoDelete(<font class="keyword">true</font>);
00413   deleteItems.clear();
00414 }
00415 
00417 <font class="keywordtype">void</font> CMainIndex::searchInModules(){
00418   QPtrList&lt;QListViewItem&gt; items = selectedItems();
00419   ListCSwordModuleInfo <a class="code" href="class_c_display_window.html#a2">modules</a>;
00420   <font class="keywordflow">for</font> (items.first(); items.current(); items.next()) {
00421     <font class="keywordflow">if</font> (CModuleItem* i = dynamic_cast&lt;CModuleItem*&gt;(items.current())) {
00422       <a class="code" href="class_c_display_window.html#a2">modules</a>.append(i-&gt;module());
00423     }
00424   }
00425   <font class="keywordflow">if</font> (<a class="code" href="class_c_display_window.html#a2">modules</a>.count())
00426     openSearchDialog(<a class="code" href="class_c_display_window.html#a2">modules</a>, QString::null);
00427 }
00428 
00430 <font class="keywordtype">void</font> CMainIndex::unlockModule(){
00431   <font class="keywordflow">if</font> (CModuleItem* i = dynamic_cast&lt;CModuleItem*&gt;(currentItem())) {
00432     <font class="keywordtype">bool</font> ok;
00433     QString unlockKey = QInputDialog::getText(i18n(<font class="stringliteral">"BibleTime - Unlock module"</font>),i18n(<font class="stringliteral">"Enter the key to unlock the module!"</font>),QLineEdit::Normal, i-&gt;module()-&gt;config(CSwordModuleInfo::CipherKey), &amp;ok);
00434     <font class="keywordflow">if</font> (ok) {
00435         <a class="code" href="class_c_sword_module_info.html#s29">CSwordModuleInfo::UnlockErrorCode</a> ret = i-&gt;module()-&gt;unlock( unlockKey );
00436         <font class="keywordflow">if</font> ( ret != CSwordModuleInfo::noError) {
00437             <font class="comment">//an error occured</font>
00438             <font class="keywordflow">switch</font> (ret) {
00439                 <font class="keywordflow">case</font> CSwordModuleInfo::noPermission:                
00440                     <font class="keywordflow">break</font>;
00441                 <font class="keywordflow">case</font> CSwordModuleInfo::wrongUnlockKey:              
00442                     <font class="keywordflow">break</font>;
00443                 <font class="keywordflow">case</font> CSwordModuleInfo::notLocked:
00444                     <font class="keywordflow">break</font>;
00445                 <font class="keywordflow">default</font>:
00446                     <font class="keywordflow">break</font>;
00447             }
00448         }
00449     }
00450   }
00451 }
00452 
00454 <font class="keywordtype">void</font> CMainIndex::aboutModule(){
00455   <font class="keywordflow">if</font> (CModuleItem* i = dynamic_cast&lt;CModuleItem*&gt;(currentItem())) {
00456     KMessageBox::about(<font class="keyword">this</font>, i-&gt;aboutInfo(), i-&gt;module()-&gt;config(CSwordModuleInfo::Description), <font class="keyword">false</font>);
00457   }
00458 }
00459 
00461 <font class="keywordtype">void</font> CMainIndex::startDrag(){
00462   QPtrList&lt;QListViewItem&gt; items = selectedItems();
00463   m_itemsMovable = <font class="keyword">true</font>;
00464   <font class="keywordflow">for</font> (items.first(); items.current() &amp;&amp; m_itemsMovable; items.next()) {
00465     <font class="keywordflow">if</font> (CItemBase* i = dynamic_cast&lt;CItemBase*&gt;(items.current())) {
00466       m_itemsMovable = m_itemsMovable &amp;&amp; i-&gt;isMovable();
00467     }
00468     <font class="keywordflow">else</font> {
00469       m_itemsMovable = <font class="keyword">false</font>;
00470     }
00471   }
00472   qWarning(<font class="stringliteral">"movable? %i"</font>, m_itemsMovable);
00473   KListView::startDrag();
00474 }
00475 
00477 <font class="keywordtype">void</font> CMainIndex::contentsDragMoveEvent( QDragMoveEvent* event ){
00478   <font class="keywordflow">if</font> ( CItemBase* i = dynamic_cast&lt;CItemBase*&gt;( itemAt( contentsToViewport(event-&gt;pos())) )) {
00479     <font class="keywordflow">if</font> (i-&gt;acceptDrop(event) &amp;&amp; i-&gt;isFolder() &amp;&amp; !i-&gt;isOpen() &amp;&amp; autoOpen()) {
00480       <font class="keywordflow">if</font> (m_autoOpenFolder != i)
00481         m_autoOpenTimer.stop();
00482       m_autoOpenFolder = i;
00483       m_autoOpenTimer.start( 400, <font class="keyword">true</font> );
00484     }
00485     <font class="keywordflow">else</font>
00486       m_autoOpenFolder = 0;
00487   }
00488   <font class="keywordflow">else</font>
00489     m_autoOpenFolder = 0;
00490 
00491   KListView::contentsDragMoveEvent(event);
00492 }
00493 
00494 <font class="keywordtype">void</font> CMainIndex::autoOpenTimeout(){
00495   m_autoOpenTimer.stop();
00496   <font class="keywordflow">if</font> (m_autoOpenFolder &amp;&amp; !m_autoOpenFolder-&gt;isOpen() &amp;&amp; m_autoOpenFolder-&gt;childCount()) {
00497     m_autoOpenFolder-&gt;setOpen(<font class="keyword">true</font>);
00498   }
00499 }
00500 
00502 <font class="keywordtype">void</font> CMainIndex::contentsDragLeaveEvent( QDragLeaveEvent* e ){
00503   m_autoOpenTimer.stop();
00504 
00505   KListView::contentsDragLeaveEvent(e);
00506 }
00507 
00509 <font class="keyword">const</font> <font class="keywordtype">bool</font> CMainIndex::isMultiAction( <font class="keyword">const</font> CItemBase::MenuAction type )<font class="keyword"> const </font>{
00510   <font class="keywordflow">switch</font> (type) {
00511     <font class="keywordflow">case</font> CItemBase::NewFolder:
00512       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00513     <font class="keywordflow">case</font> CItemBase::ChangeFolder:
00514       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00515 
00516     <font class="keywordflow">case</font> CItemBase::ChangeBookmark:
00517       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00518     <font class="keywordflow">case</font> CItemBase::ImportBookmarks:
00519       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00520     <font class="keywordflow">case</font> CItemBase::ExportBookmarks:
00521       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00522     <font class="keywordflow">case</font> CItemBase::PrintBookmarks:
00523       <font class="keywordflow">return</font> <font class="keyword">true</font>;
00524 
00525     <font class="keywordflow">case</font> CItemBase::DeleteEntries:
00526       <font class="keywordflow">return</font> <font class="keyword">true</font>;
00527 
00528     <font class="keywordflow">case</font> CItemBase::SearchInModules:
00529       <font class="keywordflow">return</font> <font class="keyword">true</font>;
00530     <font class="keywordflow">case</font> CItemBase::UnlockModule:
00531       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00532     <font class="keywordflow">case</font> CItemBase::AboutModule:
00533       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00534   }
00535   <font class="keywordflow">return</font> <font class="keyword">false</font>;
00536 }
00537 
00539 <font class="keywordtype">void</font> CMainIndex::moved( QPtrList&lt;QListViewItem&gt;&amp; items, QPtrList&lt;QListViewItem&gt;&amp; afterFirst, QPtrList&lt;QListViewItem&gt;&amp; afterNow){
00540    qWarning(<font class="stringliteral">"moved( QPtrList&lt;QListViewItem&gt;&amp; items, QPtrList&lt;QListViewItem&gt;&amp; afterFirst, QPtrList&lt;QListViewItem&gt;&amp; afterNow)"</font>);
00541 }
</pre></div><hr><address align="right"><small>Generated on Tue Jul 16 13:53:09 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
