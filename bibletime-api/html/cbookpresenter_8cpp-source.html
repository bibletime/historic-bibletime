<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>cbookpresenter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>cbookpresenter.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                          cbookpresenter.cpp  -  description</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : Thu Jan 24 2002</font>
00005 <font class="comment">    copyright            : (C) 2002 by The BibleTime team</font>
00006 <font class="comment">    email                : info@bibletime.de</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> *                                                                         *</font>
00011 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00012 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00013 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00014 <font class="comment"> *   (at your option) any later version.                                   *</font>
00015 <font class="comment"> *                                                                         *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 
00019 <font class="comment">//BibleTime includes</font>
00020 <font class="preprocessor">#include "cbookpresenter.h"</font>
00021 <font class="preprocessor">#include "../keychooser/ckeychooser.h"</font>
00022 <font class="preprocessor">#include "../keychooser/cbooktreechooser.h"</font>
00023 <font class="preprocessor">#include "cmodulechooserbar.h"</font>
00024 <font class="preprocessor">#include "../ctoolclass.h"</font>
00025 <font class="preprocessor">#include "../chtmlwidget.h"</font>
00026 <font class="preprocessor">#include "../cexportmanager.h"</font>
00027 <font class="preprocessor">#include "../../backend/cswordtreekey.h"</font>
00028 <font class="preprocessor">#include "../../backend/chtmlentrydisplay.h"</font>
00029 <font class="preprocessor">#include "../../backend/cswordbackend.h"</font>
00030 
00031 <font class="preprocessor">#include "cdisplaysettingsbutton.h"</font>
00032 <font class="preprocessor">#include "../../resource.h"</font>
00033 <font class="preprocessor">#include "../../tooltipdef.h"</font>
00034 <font class="preprocessor">#include "../../whatsthisdef.h"</font>
00035 
00036 <font class="comment">//Qt includes</font>
00037 <font class="preprocessor">#include &lt;qsplitter.h&gt;</font>
00038 
00039 <font class="comment">//KDE includes</font>
00040 <font class="preprocessor">#include &lt;kaccel.h&gt;</font>
00041 <font class="preprocessor">#include &lt;klocale.h&gt;</font>
00042 <font class="preprocessor">#include &lt;kaction.h&gt;</font>
00043 
00044 CBookPresenter::CBookPresenter(ListCSwordModuleInfo useModules, QWidget *parent, <font class="keyword">const</font> <font class="keywordtype">char</font> *name )
00045     : <a class="code" href="class_c_sword_presenter.html">CSwordPresenter</a>(useModules,parent,name)
00046 {
00047     m_key = dynamic_cast&lt;CSwordTreeKey*&gt;( <a class="code" href="class_c_sword_key.html#d0">CSwordKey::createInstance</a>(useModules.first()) );
00048     m_key-&gt;root();
00049     
00050     initView();
00051     show();
00052     initConnections();
00053     
00054     setInitialized();
00055 }
00056 
00057 CBookPresenter::~CBookPresenter(){
00058     <font class="keyword">delete</font> m_key;
00059     m_key = 0;
00060 }
00061 
00063 <font class="keywordtype">void</font> CBookPresenter::initView(){
00064     m_mainToolBar = <font class="keyword">new</font> KToolBar(<font class="keyword">this</font>);
00065     m_keyChooser = <a class="code" href="class_c_key_chooser.html#d0">CKeyChooser::createInstance</a>(m_moduleList.first(), m_key, m_mainToolBar); 
00066     m_mainToolBar-&gt;insertWidget(0,m_keyChooser-&gt;sizeHint().width(),m_keyChooser);   
00067     
00068     m_treeAction =  <font class="keyword">new</font> KToggleAction(i18n(<font class="stringliteral">"Toggle tree..."</font>), ICON_VIEW_BOOKTREE,
00069                                                             IDK_PRESENTER_TOGGLE_TREE, <font class="keyword">this</font>,    SLOT(treeToggled()), actionCollection(), <font class="stringliteral">"treeToggle_action"</font>);
00070 <font class="comment">//  m_treeAction-&gt;setWhatsThis( WT_PRESENTER_SYNC );</font>
00071     m_treeAction-&gt;plug(m_mainToolBar);
00072 
00073     addToolBar(m_mainToolBar);          
00074     
00075     m_moduleChooserBar = <font class="keyword">new</font> <a class="code" href="class_c_module_chooser_bar.html">CModuleChooserBar</a>(m_moduleList, CSwordModuleInfo::GenericBook, <font class="keyword">this</font> );
00076     m_moduleChooserBar-&gt;setButtonLimit(1);
00077     addToolBar(m_moduleChooserBar);
00078     
00079 
00080     QSplitter* splitter = <font class="keyword">new</font> QSplitter(<font class="keyword">this</font>);  
00081     m_treeChooser = <font class="keyword">new</font> <a class="code" href="class_c_book_tree_chooser.html">CBookTreeChooser</a>(m_moduleList.first(), m_key, splitter);
00082     m_treeAction-&gt;setChecked(<font class="keyword">false</font>);
00083     m_treeChooser-&gt;hide();
00084     
00085     splitter-&gt;setResizeMode(m_treeChooser, QSplitter::FollowSizeHint);
00086     
00087     m_htmlWidget = <font class="keyword">new</font> <a class="code" href="class_c_h_t_m_l_widget.html">CHTMLWidget</a>(<font class="keyword">true</font>, splitter);     
00088         
00089     m_popup = <font class="keyword">new</font> KPopupMenu(<font class="keyword">this</font>);
00090     m_popup-&gt;insertTitle(i18n(<font class="stringliteral">"Book window"</font>));
00091 
00092     m_copyPopup = <font class="keyword">new</font> KPopupMenu(m_popup);
00093 <font class="comment">//  m_copyPopup-&gt;insertItem(i18n("Verse"), this, SLOT(copyVerse()),0,ID_PRESENTER_COPY_ONLY_KEY);</font>
00094 <font class="comment">//  m_copyPopup-&gt;insertItem(i18n("Text of verse"), this, SLOT(copyVerseText()),0,ID_PRESENTER_COPY_KEY_TEXT);   </font>
00095 <font class="comment">//  m_copyPopup-&gt;insertItem(i18n("Verse with text"), this, SLOT(copyVerseAndText()),0,ID_PRESENTER_COPY_KEY);</font>
00096 <font class="comment">//  m_copyPopup-&gt;insertItem(i18n("Chapter"), m_htmlWidget, SLOT(copyDocument()),0,ID_PRESENTER_COPY_CHAPTER);</font>
00097 <font class="comment">//  m_copyPopup-&gt;insertSeparator();</font>
00098     m_copyPopup-&gt;insertItem(i18n(<font class="stringliteral">"Selected text"</font>), m_htmlWidget, SLOT(copy()),0,ID_PRESENTER_COPY_SELECTED);
00099 
00100     m_printPopup = <font class="keyword">new</font> KPopupMenu(m_popup);
00101     m_printPopup-&gt;insertItem(i18n(<font class="stringliteral">"Entry"</font>), <font class="keyword">this</font>, SLOT(printEntry()),0,ID_PRESENTER_PRINT_KEY);
00102 
00103     m_savePopup = <font class="keyword">new</font> KPopupMenu(m_popup);  
00104 <font class="comment">//  m_savePopup-&gt;insertItem(i18n("Verse with text"), this, SLOT(saveVerseAndText()),0,ID_PRESENTER_SAVE_KEY);</font>
00105 <font class="comment">//  m_savePopup-&gt;insertItem(i18n("Chapter as plain text"), m_htmlWidget, SLOT(slotSaveAsText()),0,ID_PRESENTER_SAVE_CHAPTER);</font>
00106     m_savePopup-&gt;insertItem(i18n(<font class="stringliteral">"Entry as HTML"</font>), m_htmlWidget, SLOT(slotSaveAsHTML()),0,ID_PRESENTER_SAVE_CHAPTER_HTML);  
00107 
00108     m_popup-&gt;insertItem(i18n(<font class="stringliteral">"Select all"</font>), m_htmlWidget, SLOT(slotSelectAll()),0, ID_PRESENTER_SELECT_ALL);
00109   m_popup-&gt;insertItem(i18n(<font class="stringliteral">"Lookup selected text in lexicon"</font>), m_lexiconPopup, ID_PRESENTER_LOOKUP);    
00110     m_popup-&gt;insertSeparator(); 
00111     m_popup-&gt;insertItem(SmallIcon(ICON_EDIT_COPY),i18n(<font class="stringliteral">"Copy..."</font>),  m_copyPopup, ID_PRESENTER_COPY_POPUP);  
00112     m_popup-&gt;insertItem(SmallIcon(ICON_FILE_PRINT), i18n(<font class="stringliteral">"Add to printing queue..."</font>), m_printPopup, ID_PRESENTER_PRINT_POPUP);  
00113     m_popup-&gt;insertItem(SmallIcon(ICON_FILE_SAVE), i18n(<font class="stringliteral">"Save..."</font>),     m_savePopup,ID_PRESENTER_SAVE_POPUP);       
00114 
00115     m_htmlWidget-&gt;installPopup(m_popup);            
00116     m_htmlWidget-&gt;installAnchorMenu(m_popup);
00117     m_htmlWidget-&gt;setModules(m_moduleList);
00118         
00119 
00120     setCentralWidget(splitter);
00121 }
00122 
00124 <font class="keywordtype">void</font> CBookPresenter::initConnections(){
00125     connect(m_htmlWidget, SIGNAL(referenceClicked(<font class="keyword">const</font> QString&amp;, <font class="keyword">const</font> QString&amp;)),
00126         <font class="keyword">this</font>, SLOT(lookup(<font class="keyword">const</font> QString&amp;, <font class="keyword">const</font> QString&amp;)));    
00127     connect(m_htmlWidget, SIGNAL(referenceDropped(<font class="keyword">const</font> QString&amp;)),
00128         <font class="keyword">this</font>, SLOT(referenceDropped(<font class="keyword">const</font> QString&amp;)));
00129 
00130     connect(m_keyChooser, SIGNAL(<a class="code" href="class_c_key_chooser.html#j0">keyChanged</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>*)),
00131         <font class="keyword">this</font>, SLOT(lookup(<a class="code" href="class_c_sword_key.html">CSwordKey</a>*)));
00132     connect(m_keyChooser, SIGNAL(<a class="code" href="class_c_key_chooser.html#j0">keyChanged</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>*)),
00133         m_treeChooser, SLOT(<a class="code" href="class_c_book_key_chooser.html#g0">updateKey</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>*)));
00134     
00135     connect(m_treeChooser, SIGNAL(<a class="code" href="class_c_key_chooser.html#j0">keyChanged</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>*)),
00136         <font class="keyword">this</font>, SLOT(lookup(<a class="code" href="class_c_sword_key.html">CSwordKey</a>*)));
00137     connect(m_treeChooser, SIGNAL(<a class="code" href="class_c_key_chooser.html#j0">keyChanged</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>*)),
00138         m_keyChooser, SLOT(<a class="code" href="class_c_book_key_chooser.html#g0">updateKey</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>*)));
00139         
00140 <font class="comment">//  connect(m_popup, SIGNAL(aboutToShow()),</font>
00141 <font class="comment">//      SLOT(popupAboutToShow()));</font>
00142     connect(m_moduleChooserBar, SIGNAL( sigChanged() ),
00143         SLOT(modulesChanged() ));
00144 <font class="comment">//  connect(m_displaySettingsButton, SIGNAL( sigChanged() ),    </font>
00145 <font class="comment">//      SLOT(optionsChanged() ));</font>
00146 }
00147 
00148 <font class="keywordtype">void</font> CBookPresenter::modulesChanged(){
00149   m_moduleList = m_moduleChooserBar-&gt;getModuleList();
00150   <font class="keywordflow">if</font> (!m_moduleList.count())
00151     close();
00152   <font class="keywordflow">else</font> {
00153       m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a2">module</a>(m_moduleList.first());
00154       m_keyChooser-&gt;setModule(m_moduleList.first());    
00155       m_treeChooser-&gt;setModule(m_moduleList.first());       
00156         m_htmlWidget-&gt;setModules(m_moduleList);
00157         
00158       lookup(m_key);
00159     }
00160 }
00161 
00162 <font class="keywordtype">void</font> CBookPresenter::lookup(<a class="code" href="class_c_sword_key.html">CSwordKey</a>* key) {
00163     qWarning(<font class="stringliteral">"CBookPresenter::lookup(CSwordKey*)"</font>);
00164 
00165     setUpdatesEnabled(<font class="keyword">false</font>);   
00166     <a class="code" href="class_c_sword_tree_key.html">CSwordTreeKey</a>* treeKey = dynamic_cast&lt;CSwordTreeKey*&gt;(key); 
00167     <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* m = m_moduleList.first();
00168     m-&gt;<a class="code" href="class_c_sword_module_info.html#a5">module</a>()-&gt;SetKey(treeKey);
00169     
00170         
00171     <font class="keywordflow">if</font> (m-&gt;<a class="code" href="class_c_sword_module_info.html#a7">getDisplay</a>()) {
00172         m-&gt;<a class="code" href="class_c_sword_module_info.html#a7">getDisplay</a>()-&gt;<a class="code" href="class_c_h_t_m_l_entry_display.html#a1">Display</a>( m );
00173         m_htmlWidget-&gt;setText(m-&gt;<a class="code" href="class_c_sword_module_info.html#a7">getDisplay</a>()-&gt;<a class="code" href="class_c_h_t_m_l_entry_display.html#a3">getHTML</a>());
00174     }   
00175     <font class="keywordflow">if</font> (m_key != treeKey) {
00176         m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>(treeKey-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>());
00177     }
00178     setUpdatesEnabled(<font class="keyword">true</font>);
00179     setCaption( windowCaption() );
00180 }
00181 
00183 <font class="keywordtype">void</font> CBookPresenter::lookup( <font class="keyword">const</font> QString&amp; module, <font class="keyword">const</font> QString&amp; key){
00184     qWarning(<font class="stringliteral">"key is %s"</font>, key.latin1());
00185 
00186     <a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* m = backend()-&gt;findModuleByName(module);
00187     <font class="keywordflow">if</font> (m &amp;&amp; m_moduleList.containsRef(m)) {
00188         <font class="keywordflow">if</font> (!key.isEmpty())
00189             m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>(key);
00190         <font class="keywordflow">else</font>
00191             m_key-&gt;root();
00192         m_keyChooser-&gt;setKey(m_key); <font class="comment">//the key chooser does send an update signal   </font>
00193     }
00194     <font class="keywordflow">else</font>
00195         emit lookupInModule(module, key);
00196 }
00197 
00199 <font class="keywordtype">void</font> CBookPresenter::initAccels(){
00200     CSwordPresenter::initAccels();
00201     m_accel-&gt;setConfigGroup(<font class="stringliteral">"Book window"</font>); 
00202     m_accel-&gt;insertItem(i18n(<font class="stringliteral">"Toggle tree"</font>), <font class="stringliteral">"Toggle tree"</font>, 0);
00203     m_accel-&gt;connectItem(<font class="stringliteral">"Toggle tree"</font>, <font class="keyword">this</font>, SLOT(treeToggled()));
00204         
00205     m_accel-&gt;readSettings();
00206 }
00207 
00208 <font class="keywordtype">void</font> CBookPresenter::insertKeyboardActions(KAccel* a){
00209     a-&gt;setConfigGroup(<font class="stringliteral">"Book window"</font>);   
00210     a-&gt;insertItem(i18n(<font class="stringliteral">"Toggle tree"</font>), <font class="stringliteral">"Toggle tree"</font>, 0);
00211 }
00212 
00214 <font class="keywordtype">void</font> CBookPresenter::printEntry(){
00215     CExportManager::printKey( m_moduleList.first(), m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>() );
00216 }
00217 
00219 <font class="keywordtype">void</font> CBookPresenter::treeToggled(){
00220     <font class="keywordflow">if</font> (m_treeAction-&gt;isChecked())
00221         m_treeChooser-&gt;show();
00222     <font class="keywordflow">else</font>
00223         m_treeChooser-&gt;hide();
00224 }
00225 
00226 <font class="keywordtype">void</font> CBookPresenter::applySettings( <a class="code" href="class_c_profile_window.html">CProfileWindow</a>* settings ){
00227     <a class="code" href="class_c_sword_presenter.html#a6">CSwordPresenter::applySettings</a>(settings);
00228     
00229     <font class="keywordflow">if</font> (settings-&gt;<a class="code" href="class_c_profile_window.html#a13">windowSettings</a>()) {
00230         m_treeAction-&gt;setChecked(<font class="keyword">true</font>);     
00231         m_treeChooser-&gt;show();      
00232     }
00233     <font class="keywordflow">else</font> {
00234         m_treeAction-&gt;setChecked(<font class="keyword">false</font>);
00235         m_treeChooser-&gt;hide();
00236     }
00237 <font class="comment">//  const int count = m_displaySettingsButton-&gt;menuItemCount();</font>
00238 <font class="comment">//  for (int i = count-1; i&gt;=1; i--) {</font>
00239 <font class="comment">//      if (result-(int)pow(2,i-1)&gt;= 0) { //2^i was added before, so item with index i is set</font>
00240 <font class="comment">//          result -= (int)pow(2,i-1);</font>
00241 <font class="comment">//          m_displaySettingsButton-&gt;setItemStatus(i,true);</font>
00242 <font class="comment">//      }</font>
00243 <font class="comment">//      else</font>
00244 <font class="comment">//          m_displaySettingsButton-&gt;setItemStatus(i,false);            </font>
00245 <font class="comment">//  }       </font>
00246 <font class="comment">//  m_displaySettingsButton-&gt;setChanged();</font>
00247 }
00248 
00249 <font class="keywordtype">void</font> CBookPresenter::storeSettings( <a class="code" href="class_c_profile_window.html">CProfileWindow</a>* settings ){
00250     <a class="code" href="class_c_sword_presenter.html#a5">CSwordPresenter::storeSettings</a>(settings);   
00251     settings-&gt;<a class="code" href="class_c_profile_window.html#a12">setWindowSettings</a>( m_treeAction-&gt;isChecked() );
00252 <font class="comment">//  const int count = m_displaySettingsButton-&gt;menuItemCount();</font>
00253 <font class="comment">//  int result = 0;</font>
00254 <font class="comment">//  //now check every item</font>
00255 <font class="comment">//  for (int i = 1; i&lt;count; i++) { //first item is a title</font>
00256 <font class="comment">//      if (m_displaySettingsButton-&gt;itemStatus(i)) //item is checked</font>
00257 <font class="comment">//          result += (int)pow(2,i-1);//add 2^i (the i. digit in binary)</font>
00258 <font class="comment">//  }</font>
00259 <font class="comment">//  settings-&gt;setWindowSettings(result);</font>
00260 }
</pre></div><hr><address><small>Generated on Sun Mar 10 22:12:45 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
