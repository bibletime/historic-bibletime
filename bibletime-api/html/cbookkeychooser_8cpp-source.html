<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>cbookkeychooser.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>cbookkeychooser.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                          cbookkeychooser.cpp  -  description</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : Sat Jan 26 2002</font>
00005 <font class="comment">    copyright            : (C) 2002 by The BibleTime team</font>
00006 <font class="comment">    email                : info@bibletime.de</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> *                                                                         *</font>
00011 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00012 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00013 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00014 <font class="comment"> *   (at your option) any later version.                                   *</font>
00015 <font class="comment"> *                                                                         *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include "cbookkeychooser.h"</font>
00019 <font class="preprocessor">#include "backend/cswordtreekey.h"</font>
00020 <font class="preprocessor">#include "backend/cswordbookmoduleinfo.h"</font>
00021 
00022 <font class="comment">//Qt includes</font>
00023 <font class="preprocessor">#include &lt;qlayout.h&gt;</font>
00024 <font class="preprocessor">#include &lt;qmap.h&gt;</font>
00025 
00026 QMap&lt;QObject*, int&gt; boxes;
00027 
00028 CBookKeyChooser::CBookKeyChooser(ListCSwordModuleInfo modules, <a class="code" href="class_c_sword_key.html">CSwordKey</a> *key, QWidget *parent, <font class="keyword">const</font> <font class="keywordtype">char</font> *name)
00029     : <a class="code" href="class_c_key_chooser.html">CKeyChooser</a>(modules, key, parent,name), m_layout(0) {
00030 
00031   <a class="code" href="class_c_display_window.html#b8">setModules</a>(<a class="code" href="class_c_display_window.html#a2">modules</a>, <font class="keyword">false</font>);
00032     m_key = dynamic_cast&lt;CSwordTreeKey*&gt;(key);
00033   <font class="keywordflow">if</font> (!m_modules.count()) {
00034         m_key = 0;
00035     }
00036   <a class="code" href="class_c_display_window.html#b8">setModules</a>(<a class="code" href="class_c_display_window.html#a2">modules</a>, <font class="keyword">true</font>);
00037 }
00038 
00039 CBookKeyChooser::~CBookKeyChooser(){
00040 }
00041 
<a name="l00042"></a><a class="code" href="class_c_book_key_chooser.html#a5">00042</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#a5">CBookKeyChooser::setKey</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>* newKey){
00043     <a class="code" href="class_c_book_key_chooser.html#a5">setKey</a>(newKey, <font class="keyword">true</font>);
00044 }
00045 
<a name="l00047"></a><a class="code" href="class_c_book_key_chooser.html#a6">00047</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#a5">CBookKeyChooser::setKey</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>* newKey, <font class="keyword">const</font> <font class="keywordtype">bool</font> emitSignal){
00048     <font class="keywordflow">if</font> (m_key != newKey )
00049         m_key = dynamic_cast&lt;CSwordTreeKey*&gt;(newKey);
00050     
00051     <font class="keyword">const</font> QString oldKey = m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>();
00052     QStringList siblings;
00053     <font class="keywordflow">if</font> (m_key &amp;&amp; !oldKey.isEmpty())
00054         siblings = QStringList::split(<font class="stringliteral">"/"</font>,oldKey,<font class="keyword">false</font>);
00055 
00056     <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> depth = 0;
00057     <font class="keywordtype">int</font> index = 0;
00058     
00059     m_key-&gt;root();
00060     <font class="keywordflow">while</font>(m_key-&gt;firstChild() &amp;&amp; (depth &lt;= siblings.count())) {
00061         <font class="keyword">const</font> QString <a class="code" href="class_c_book_key_chooser.html#a4">key</a> = m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>();
00062         index = 0;
00063         <font class="keyword">const</font> QString sibling = siblings[depth];
00064         <font class="keywordflow">if</font> (!sibling.isEmpty()) { <font class="comment">//found it</font>
00065             <font class="keywordtype">bool</font> found = <font class="keyword">false</font>;         
00066             <font class="keywordflow">do</font> {
00067                 ++index;
00068                 found = (m_key-&gt;getLocalName() == sibling);
00069             } <font class="keywordflow">while</font> (!found &amp;&amp; m_key-&gt;nextSibling());           
00070             <font class="keywordflow">if</font> (!found)
00071                 m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>( <a class="code" href="class_c_book_key_chooser.html#a4">key</a> );
00072         }   
00073         <a class="code" href="class_c_book_key_chooser.html#b0">setupCombo</a>(<a class="code" href="class_c_book_key_chooser.html#a4">key</a>, depth++, index);        
00074     }
00075     
00076     <font class="comment">//clear the combos which were not filled</font>
00077     <font class="keywordflow">for</font> (; depth &lt; m_modules.first()-&gt;depth(); ++depth)  {
00078         <a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>* chooser = m_chooserWidgets.at(depth);
00079         <font class="keywordflow">if</font> (chooser)
00080             chooser-&gt;<a class="code" href="class_c_key_chooser_widget.html#a2">reset</a>(0,0,<font class="keyword">false</font>);
00081     }
00082     
00083     <font class="keywordflow">if</font> (oldKey.isEmpty())
00084         m_key-&gt;root();
00085     <font class="keywordflow">else</font>
00086         m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>(oldKey);
00087     
00088     <font class="keywordflow">if</font> (emitSignal)
00089         emit <a class="code" href="class_c_key_chooser.html#j0">keyChanged</a>(m_key);
00090 }
00091 
<a name="l00093"></a><a class="code" href="class_c_book_key_chooser.html#a4">00093</a> <a class="code" href="class_c_sword_key.html">CSwordKey</a>* <font class="keyword">const</font> <a class="code" href="class_c_book_key_chooser.html#a4">CBookKeyChooser::key</a>(){
00094 <font class="comment">//  ASSERT(m_key);</font>
00095     <font class="keywordflow">return</font> m_key;
00096 }
00097 
<a name="l00099"></a><a class="code" href="class_c_book_key_chooser.html#a3">00099</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#a3">CBookKeyChooser::setModules</a>(ListCSwordModuleInfo modules, <font class="keyword">const</font> <font class="keywordtype">bool</font> refresh){
00100   m_modules.clear();
00101   <font class="keywordflow">for</font> (modules.first(); modules.current(); modules.next()) {
00102     <font class="keywordflow">if</font> ( modules.current()-&gt;type() == CSwordModuleInfo::GenericBook ) {
00103       <font class="keywordflow">if</font> (<a class="code" href="class_c_sword_book_module_info.html">CSwordBookModuleInfo</a>* book = dynamic_cast&lt;CSwordBookModuleInfo*&gt;(modules.current())) {
00104         m_modules.append(book);
00105       }
00106     }
00107   }
00108 
00109     <font class="comment">//refresh the number of combos</font>
00110     <font class="keywordflow">if</font> (refresh &amp;&amp; m_modules.count() &amp;&amp; m_key) {
00111         <font class="keywordflow">if</font> (!m_layout)
00112             m_layout = <font class="keyword">new</font> QHBoxLayout(<font class="keyword">this</font>);
00113 
00114         <font class="comment">//delete old widgets</font>
00115         m_chooserWidgets.setAutoDelete(<font class="keyword">true</font>);
00116         m_chooserWidgets.clear();
00117         m_chooserWidgets.setAutoDelete(<font class="keyword">false</font>);
00118         
00119         <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; m_modules.first()-&gt;depth(); ++i) {          
00120             <a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>* w = <font class="keyword">new</font> <a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>(0, <font class="keyword">false</font>, <font class="keyword">this</font>); <font class="comment">//empty keychooser</font>
00121             m_chooserWidgets.append( w );
00122             connect(w, SIGNAL(changed(<font class="keywordtype">int</font>)), SLOT(<a class="code" href="class_c_book_key_chooser.html#h0">keyChooserChanged</a>(<font class="keywordtype">int</font>)));         
00123             m_layout-&gt;addWidget(w);
00124 
00125       boxes[w] = i;
00126 
00127             w-&gt;show();
00128         }
00129         <a class="code" href="class_c_book_key_chooser.html#g0">updateKey</a>(m_key);       
00130     }
00131 }
00132 
<a name="l00134"></a><a class="code" href="class_c_book_key_chooser.html#a2">00134</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#a2">CBookKeyChooser::refreshContent</a>(){
00135     <font class="keywordflow">if</font> (m_key)
00136         <a class="code" href="class_c_book_key_chooser.html#g0">updateKey</a>( m_key ); <font class="comment">//refresh with current key</font>
00137 }
00138 
<a name="l00139"></a><a class="code" href="class_c_book_key_chooser.html#b0">00139</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#b0">CBookKeyChooser::setupCombo</a>(<font class="keyword">const</font> QString key, <font class="keyword">const</font> <font class="keywordtype">int</font> depth, <font class="keyword">const</font> <font class="keywordtype">int</font> currentItem){
00140     <a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>* chooserWidget = m_chooserWidgets.at(depth);
00141     <font class="keywordflow">if</font> (depth == 0 &amp;&amp; chooserWidget &amp;&amp; chooserWidget-&gt;<a class="code" href="class_c_key_chooser_widget.html#a10">comboBox</a>()-&gt;count()) { <font class="comment">//has already items</font>
00142         <font class="comment">//set now the right item        </font>
00143         <font class="keywordflow">if</font> (<a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>* chooserWidget = m_chooserWidgets.at(depth)) {
00144             chooserWidget-&gt;<a class="code" href="class_c_key_chooser_widget.html#a9">setItem</a>( chooserWidget-&gt;<a class="code" href="class_c_key_chooser_widget.html#a10">comboBox</a>()-&gt;text(currentItem) );
00145         }
00146         <font class="keywordflow">return</font>;
00147     }
00148     
00149     <font class="keyword">const</font> QString oldKey = m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>();    
00150     m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>(<a class="code" href="class_c_book_key_chooser.html#a4">key</a>);
00151     
00152     <font class="comment">//insert an empty item at the top</font>
00153     QStringList items;  
00154     items &lt;&lt; QString::null;
00155     <font class="keywordflow">do</font> {
00156         items &lt;&lt; QString::fromLocal8Bit(m_key-&gt;getLocalName());
00157     }
00158     <font class="keywordflow">while</font> (m_key-&gt;nextSibling());
00159         
00160     <font class="keywordflow">if</font> (chooserWidget) {
00161         chooserWidget-&gt;<a class="code" href="class_c_key_chooser_widget.html#a2">reset</a>(items,currentItem,<font class="keyword">false</font>);
00162     }
00163     
00164     <font class="comment">//restore old key</font>
00165     m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>(oldKey); 
00166 }
00167 
<a name="l00169"></a><a class="code" href="class_c_book_key_chooser.html#h0">00169</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#h0">CBookKeyChooser::keyChooserChanged</a>(<font class="keywordtype">int</font> newIndex){
00170   <font class="keyword">const</font> <font class="keywordtype">int</font> activeID = boxes[const_cast&lt;QObject*&gt;(sender())];
00171     
00172   QStringList items;
00173     <a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>* chooser;
00174     <font class="keyword">const</font> <font class="keywordtype">int</font> count = m_chooserWidgets.count();
00175     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; count; ++i) {
00176         chooser = m_chooserWidgets.at(i);
00177         <font class="keyword">const</font> QString currentText = (chooser &amp;&amp; chooser-&gt;<a class="code" href="class_c_key_chooser_widget.html#a10">comboBox</a>()) ? chooser-&gt;<a class="code" href="class_c_key_chooser_widget.html#a10">comboBox</a>()-&gt;currentText() : QString::null;
00178         <font class="keywordflow">if</font> (currentText.isEmpty() || i &gt; activeID)
00179             <font class="keywordflow">break</font>;
00180         items &lt;&lt; currentText;
00181     }
00182 
00183     QString newKey = QString::fromLatin1(<font class="stringliteral">"/"</font>) + items.join(<font class="stringliteral">"/"</font>);
00184     <font class="keywordflow">if</font> (newKey.length() &gt; 1)
00185         newKey.remove(newKey.length(),1); <font class="comment">//remove the traling slash</font>
00186     
00187     m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>(newKey);
00188     <a class="code" href="class_c_book_key_chooser.html#a5">setKey</a>(m_key);
00189 }
00190 
<a name="l00192"></a><a class="code" href="class_c_book_key_chooser.html#g0">00192</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#g0">CBookKeyChooser::updateKey</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>* key){
00193     <a class="code" href="class_c_book_key_chooser.html#a5">setKey</a>(key, <font class="keyword">false</font>);
00194 }
</pre></div><hr><address align="right"><small>Generated on Tue Jul 16 13:53:08 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
