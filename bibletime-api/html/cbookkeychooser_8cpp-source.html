<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>cbookkeychooser.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>cbookkeychooser.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment">                          cbookkeychooser.cpp  -  description</font>
00003 <font class="comment">                             -------------------</font>
00004 <font class="comment">    begin                : Sat Jan 26 2002</font>
00005 <font class="comment">    copyright            : (C) 2002 by The BibleTime team</font>
00006 <font class="comment">    email                : info@bibletime.de</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> *                                                                         *</font>
00011 <font class="comment"> *   This program is free software; you can redistribute it and/or modify  *</font>
00012 <font class="comment"> *   it under the terms of the GNU General Public License as published by  *</font>
00013 <font class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</font>
00014 <font class="comment"> *   (at your option) any later version.                                   *</font>
00015 <font class="comment"> *                                                                         *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include "cbookkeychooser.h"</font>
00019 <font class="preprocessor">#include "../../backend/cswordtreekey.h"</font>
00020 <font class="preprocessor">#include "../../backend/cswordbookmoduleinfo.h"</font>
00021 
00022 <font class="comment">//Qt includes</font>
00023 <font class="preprocessor">#include &lt;qlayout.h&gt;</font>
00024 
00025 CBookKeyChooser::CBookKeyChooser(<a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a> *module, <a class="code" href="class_c_sword_key.html">CSwordKey</a> *key, QWidget *parent, <font class="keyword">const</font> <font class="keywordtype">char</font> *name)
00026     : <a class="code" href="class_c_key_chooser.html">CKeyChooser</a>(module, key, parent,name), m_layout(0) {
00027     <font class="keywordflow">if</font> ( module &amp;&amp; (module-&gt;<a class="code" href="class_c_sword_module_info.html#a15">type</a>() == CSwordModuleInfo::GenericBook) ) {
00028         m_module = dynamic_cast&lt;CSwordBookModuleInfo*&gt;(module);     
00029         m_key = dynamic_cast&lt;CSwordTreeKey*&gt;(key);
00030     }
00031     <font class="keywordflow">else</font> {
00032         m_module = 0;
00033         m_key = 0;
00034     }
00035     setModule(m_module);
00036 }
00037 
00038 CBookKeyChooser::~CBookKeyChooser(){
00039 }
00040 
<a name="l00041"></a><a class="code" href="class_c_book_key_chooser.html#a5">00041</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#a5">CBookKeyChooser::setKey</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>* newKey){
00042     <a class="code" href="class_c_book_key_chooser.html#a5">setKey</a>(newKey, <font class="keyword">true</font>);
00043 }
00044 
<a name="l00046"></a><a class="code" href="class_c_book_key_chooser.html#a6">00046</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#a5">CBookKeyChooser::setKey</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>* newKey, <font class="keyword">const</font> <font class="keywordtype">bool</font> emitSignal){
00047     <font class="keywordflow">if</font> (m_key != newKey )
00048         m_key = dynamic_cast&lt;CSwordTreeKey*&gt;(newKey);
00049     
00050     <font class="keyword">const</font> QString oldKey = m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>();
00051     QStringList siblings;
00052     <font class="keywordflow">if</font> (m_key &amp;&amp; !oldKey.isEmpty())
00053         siblings = QStringList::split(<font class="stringliteral">"/"</font>,oldKey,<font class="keyword">false</font>);
00054 
00055     <font class="keywordtype">int</font> depth = 0;
00056     <font class="keywordtype">int</font> index = 0;
00057     
00058     m_key-&gt;root();
00059     <font class="keywordflow">while</font>(m_key-&gt;firstChild() &amp;&amp; (depth &lt;= siblings.count())) {
00060         <font class="keyword">const</font> QString <a class="code" href="class_c_book_key_chooser.html#a4">key</a> = m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>();
00061         index = 0;
00062         <font class="keyword">const</font> QString sibling = siblings[depth];
00063         <font class="keywordflow">if</font> (!sibling.isEmpty()) { <font class="comment">//found it</font>
00064             <font class="keywordtype">bool</font> found = <font class="keyword">false</font>;         
00065             <font class="keywordflow">do</font> {
00066                 ++index;
00067                 found = (m_key-&gt;getLocalName() == sibling);
00068             } <font class="keywordflow">while</font> (!found &amp;&amp; m_key-&gt;nextSibling());           
00069             <font class="keywordflow">if</font> (!found)
00070                 m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>( <a class="code" href="class_c_book_key_chooser.html#a4">key</a> );
00071         }   
00072         <a class="code" href="class_c_book_key_chooser.html#b0">setupCombo</a>(<a class="code" href="class_c_book_key_chooser.html#a4">key</a>, depth++, index);        
00073     }
00074     
00075     <font class="comment">//clear the combos which were not filled</font>
00076     <font class="keywordflow">for</font> (; depth &lt; m_module-&gt;<a class="code" href="class_c_sword_book_module_info.html#a5">depth</a>(); ++depth)  {
00077         <a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>* chooser = m_chooserWidgets.at(depth);
00078         <font class="keywordflow">if</font> (chooser)
00079             chooser-&gt;<a class="code" href="class_c_key_chooser_widget.html#a2">reset</a>(0,0,<font class="keyword">false</font>);
00080     }
00081     
00082     <font class="keywordflow">if</font> (oldKey.isEmpty())
00083         m_key-&gt;root();
00084     <font class="keywordflow">else</font>
00085         m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>(oldKey);
00086     
00087     <font class="keywordflow">if</font> (emitSignal)
00088         emit <a class="code" href="class_c_key_chooser.html#j0">keyChanged</a>(m_key);
00089 }
00090 
<a name="l00092"></a><a class="code" href="class_c_book_key_chooser.html#a4">00092</a> <a class="code" href="class_c_sword_key.html">CSwordKey</a>* <font class="keyword">const</font> <a class="code" href="class_c_book_key_chooser.html#a4">CBookKeyChooser::key</a>(){
00093 <font class="comment">//  ASSERT(m_key);</font>
00094     <font class="keywordflow">return</font> m_key;
00095 }
00096 
<a name="l00098"></a><a class="code" href="class_c_book_key_chooser.html#a3">00098</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#a3">CBookKeyChooser::setModule</a>(<a class="code" href="class_c_sword_module_info.html">CSwordModuleInfo</a>* module){
00099     m_module = dynamic_cast&lt;CSwordBookModuleInfo*&gt;(module); 
00100     <font class="comment">//refresh the number of combos</font>
00101     <font class="keywordflow">if</font> (m_module &amp;&amp; m_key) {
00102         <font class="keywordflow">if</font> (!m_layout)
00103             m_layout = <font class="keyword">new</font> QHBoxLayout(<font class="keyword">this</font>);
00104 
00105         <font class="comment">//delete old widgets</font>
00106         m_chooserWidgets.setAutoDelete(<font class="keyword">true</font>);
00107         m_chooserWidgets.clear();
00108         m_chooserWidgets.setAutoDelete(<font class="keyword">false</font>);
00109         
00110         <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; m_module-&gt;<a class="code" href="class_c_sword_book_module_info.html#a5">depth</a>(); ++i) {           
00111             <a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>* w = <font class="keyword">new</font> <a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>(0, <font class="keyword">false</font>, <font class="keyword">this</font>); <font class="comment">//empty keychooser</font>
00112             m_chooserWidgets.append( w );
00113             w-&gt;show();          
00114             connect(w, SIGNAL(changed(<font class="keywordtype">int</font>)), SLOT(<a class="code" href="class_c_book_key_chooser.html#h0">keyChooserChanged</a>(<font class="keywordtype">int</font>)));         
00115             m_layout-&gt;addWidget(w);
00116         }
00117         <a class="code" href="class_c_book_key_chooser.html#g0">updateKey</a>(m_key);       
00118     }
00119 }
00120 
<a name="l00122"></a><a class="code" href="class_c_book_key_chooser.html#a2">00122</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#a2">CBookKeyChooser::refreshContent</a>(){
00123     <font class="keywordflow">if</font> (m_key)
00124         <a class="code" href="class_c_book_key_chooser.html#g0">updateKey</a>( m_key ); <font class="comment">//refresh with current key</font>
00125 }
00126 
<a name="l00127"></a><a class="code" href="class_c_book_key_chooser.html#b0">00127</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#b0">CBookKeyChooser::setupCombo</a>(<font class="keyword">const</font> QString key, <font class="keyword">const</font> <font class="keywordtype">int</font> depth, <font class="keyword">const</font> <font class="keywordtype">int</font> currentItem){
00128     <a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>* chooserWidget = m_chooserWidgets.at(depth);
00129     <font class="keywordflow">if</font> (depth == 0 &amp;&amp; chooserWidget &amp;&amp; chooserWidget-&gt;<a class="code" href="class_c_key_chooser_widget.html#a10">comboBox</a>()-&gt;count()) { <font class="comment">//has already items</font>
00130         <font class="comment">//set now the right item        </font>
00131         <a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>* chooserWidget = m_chooserWidgets.at(depth);
00132         ASSERT(chooserWidget);
00133         <font class="keywordflow">if</font> (chooserWidget) {
00134             chooserWidget-&gt;<a class="code" href="class_c_key_chooser_widget.html#a9">setItem</a>( chooserWidget-&gt;<a class="code" href="class_c_key_chooser_widget.html#a10">comboBox</a>()-&gt;text(currentItem) );
00135         }
00136         <font class="keywordflow">return</font>;
00137     }
00138     
00139     <font class="keyword">const</font> QString oldKey = m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>();    
00140     m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>(<a class="code" href="class_c_book_key_chooser.html#a4">key</a>);
00141     
00142     <font class="comment">//insert an empty item at the top</font>
00143     QStringList items;  
00144     items &lt;&lt; QString::null;
00145     <font class="keywordflow">do</font> {
00146         items &lt;&lt; QString::fromLocal8Bit(m_key-&gt;getLocalName());
00147     }
00148     <font class="keywordflow">while</font> (m_key-&gt;nextSibling());
00149         
00150     <font class="keywordflow">if</font> (chooserWidget) {
00151         chooserWidget-&gt;<a class="code" href="class_c_key_chooser_widget.html#a2">reset</a>(items,currentItem,<font class="keyword">false</font>);
00152     }
00153     
00154     <font class="comment">//restore old key</font>
00155     m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>(oldKey); 
00156 }
00157 
<a name="l00159"></a><a class="code" href="class_c_book_key_chooser.html#h0">00159</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#h0">CBookKeyChooser::keyChooserChanged</a>(<font class="keywordtype">int</font> newIndex){
00160     QStringList items;
00161     <a class="code" href="class_c_key_chooser_widget.html">CKeyChooserWidget</a>* chooser;
00162     <font class="keyword">const</font> <font class="keywordtype">int</font> count = m_chooserWidgets.count();
00163     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; count; ++i) {
00164         chooser = m_chooserWidgets.at(i);
00165         <font class="keyword">const</font> QString currentText = (chooser &amp;&amp; chooser-&gt;<a class="code" href="class_c_key_chooser_widget.html#a10">comboBox</a>()) ? chooser-&gt;<a class="code" href="class_c_key_chooser_widget.html#a10">comboBox</a>()-&gt;currentText() : QString::null;
00166         <font class="keywordflow">if</font> (currentText.isEmpty())
00167             <font class="keywordflow">break</font>;
00168         items &lt;&lt; currentText;
00169     }
00170     QString newKey = QString::fromLatin1(<font class="stringliteral">"/"</font>) + items.join(<font class="stringliteral">"/"</font>);
00171     <font class="keywordflow">if</font> (newKey.length() &gt; 1)
00172         newKey.remove(newKey.length(),1); <font class="comment">//remove the traling slash</font>
00173     
00174     m_key-&gt;<a class="code" href="class_c_sword_tree_key.html#a4">key</a>(newKey); 
00175     <a class="code" href="class_c_book_key_chooser.html#a5">setKey</a>(m_key);
00176 }
00177 
<a name="l00179"></a><a class="code" href="class_c_book_key_chooser.html#g0">00179</a> <font class="keywordtype">void</font> <a class="code" href="class_c_book_key_chooser.html#g0">CBookKeyChooser::updateKey</a>(<a class="code" href="class_c_sword_key.html">CSwordKey</a>* key){
00180     <a class="code" href="class_c_book_key_chooser.html#a5">setKey</a>(key, <font class="keyword">false</font>);
00181 }
</pre></div><hr><address><small>Generated on Sun Mar 10 21:52:40 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
