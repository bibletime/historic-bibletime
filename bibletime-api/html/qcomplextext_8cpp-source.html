<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>qcomplextext.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>qcomplextext.cpp</h1><div class="fragment"><pre>00001 <font class="preprocessor">#include "qcomplextext_p.h"</font>
00002 <font class="preprocessor">#include "qrichtext_p.h"</font>
00003 <font class="comment">//#include "qfontdata_p.h"</font>
00004 <font class="preprocessor">#include "qfontmetrics.h"</font>
00005 <font class="preprocessor">#include "qrect.h"</font>
00006 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00007 
00008 <font class="keyword">using</font> <font class="keyword">namespace </font>Qt3;
00009 
00010 <font class="comment">// -----------------------------------------------------</font>
00011 
00012 <font class="comment">/* a small helper class used internally to resolve Bidi embedding levels.</font>
00013 <font class="comment">   Each line of text caches the embedding level at the start of the line for faster</font>
00014 <font class="comment">   relayouting</font>
00015 <font class="comment">*/</font>
00016 QBidiContext::QBidiContext( uchar l, QChar::Direction e, QBidiContext *p, <font class="keywordtype">bool</font> o )
00017     : level(l) , override(o), dir(e)
00018 {
00019     <font class="keywordflow">if</font> ( p )
00020     p-&gt;ref();
00021     parent = p;
00022     count = 0;
00023 }
00024 
00025 QBidiContext::~QBidiContext()
00026 {
00027     <font class="keywordflow">if</font>( parent &amp;&amp; parent-&gt;deref() )
00028     <font class="keyword">delete</font> parent;
00029 }
00030 
00031 <font class="comment">//static QChar *shapeBuffer = 0;</font>
00032 <font class="comment">//static int shapeBufSize = 0;</font>
00033 
00034 <font class="comment">/*</font>
00035 <font class="comment">   Arabic shaping obeys a number of rules according to the joining classes (see Unicode book, section on</font>
00036 <font class="comment">   arabic).</font>
00037 <font class="comment"></font>
00038 <font class="comment">   Each unicode char has a joining class (right, dual (left&amp;right), center (joincausing) or transparent).</font>
00039 <font class="comment">   transparent joining is not encoded in QChar::joining(), but applies to all combining marks and format marks.</font>
00040 <font class="comment"></font>
00041 <font class="comment">   Right join-causing: dual + center</font>
00042 <font class="comment">   Left join-causing: dual + right + center</font>
00043 <font class="comment"></font>
00044 <font class="comment">   Rules are as follows (for a string already in visual order, as we have it here):</font>
00045 <font class="comment"></font>
00046 <font class="comment">   R1 Transparent characters do not affect joining behaviour.</font>
00047 <font class="comment">   R2 A right joining character, that has a right join-causing char on the right will get form XRight</font>
00048 <font class="comment">   (R3 A left joining character, that has a left join-causing char on the left will get form XLeft)</font>
00049 <font class="comment">   Note: the above rule is meaningless, as there are no pure left joining characters defined in Unicode</font>
00050 <font class="comment">   R4 A dual joining character, that has a left join-causing char on the left and a right join-causing char on</font>
00051 <font class="comment">             the right will get form XMedial</font>
00052 <font class="comment">   R5  A dual joining character, that has a right join causing char on the right, and no left join causing char on the left</font>
00053 <font class="comment">         will get form XRight</font>
00054 <font class="comment">   R6 A dual joining character, that has a  left join causing char on the left, and no right join causing char on the right</font>
00055 <font class="comment">         will get form XLeft</font>
00056 <font class="comment">   R7 Otherwise the character will get form XIsolated</font>
00057 <font class="comment"></font>
00058 <font class="comment">   Additionally we have to do the minimal ligature support for lam-alef ligatures:</font>
00059 <font class="comment"></font>
00060 <font class="comment">   L1 Transparent characters do not affect ligature behaviour.</font>
00061 <font class="comment">   L2 Any sequence of Alef(XRight) + Lam(XMedial) will form the ligature Alef.Lam(XLeft)</font>
00062 <font class="comment">   L3 Any sequence of Alef(XRight) + Lam(XLeft) will form the ligature Alef.Lam(XIsolated)</font>
00063 <font class="comment"></font>
00064 <font class="comment">   The two functions defined in this class do shaping in visual and logical order. For logical order just replace right with</font>
00065 <font class="comment">   previous and left with next in the above rules ;-)</font>
00066 <font class="comment">*/</font>
00067 
00068 <font class="comment">/*</font>
00069 <font class="comment">  Two small helper functions for arabic shaping. They get the next shape causing character on either</font>
00070 <font class="comment">  side of the char in question. Implements rule R1.</font>
00071 <font class="comment"></font>
00072 <font class="comment">  leftChar() returns true if the char to the left is a left join-causing char</font>
00073 <font class="comment">  rightChar() returns true if the char to the right is a right join-causing char</font>
00074 <font class="comment">*/</font>
00075 <font class="keyword">static</font> <font class="keyword">inline</font> <font class="keyword">const</font> QChar *prevChar( <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">int</font> pos )
00076 {
00077     <font class="comment">//qDebug("leftChar: pos=%d", pos);</font>
00078     pos--;
00079     <font class="keyword">const</font> QChar *ch = str.unicode() + pos;
00080     <font class="keywordflow">while</font>( pos &gt; -1 ) {
00081         <font class="keywordflow">if</font>( !ch-&gt;isMark() )
00082             <font class="keywordflow">return</font> ch;
00083         pos--;
00084         ch--;
00085     }
00086     <font class="keywordflow">return</font> &amp;QChar::replacement;
00087 }
00088 
00089 <font class="keyword">static</font> <font class="keyword">inline</font> <font class="keyword">const</font> QChar *nextChar( <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">int</font> pos)
00090 {
00091     pos++;
00092     <font class="keywordtype">int</font> len = str.length();
00093     <font class="keyword">const</font> QChar *ch = str.unicode() + pos;
00094     <font class="keywordflow">while</font>( pos &lt; len ) {
00095         <font class="comment">//qDebug("rightChar: %d isLetter=%d, joining=%d", pos, ch.isLetter(), ch.joining());</font>
00096         <font class="keywordflow">if</font>( !ch-&gt;isMark() )
00097             <font class="keywordflow">return</font> ch;
00098         <font class="comment">// assume it's a transparent char, this might not be 100% correct</font>
00099         pos++;
00100         ch++;
00101     }
00102     <font class="keywordflow">return</font> &amp;QChar::replacement;
00103 }
00104 
00105 <font class="keyword">static</font> <font class="keyword">inline</font> <font class="keywordtype">bool</font> prevVisualCharJoins( <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">int</font> pos)
00106 {
00107     <font class="keywordflow">return</font> (     prevChar( str, pos )-&gt;joining() != QChar::OtherJoining );
00108 }
00109 
00110 <font class="keyword">static</font> <font class="keyword">inline</font> <font class="keywordtype">bool</font> nextVisualCharJoins( <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">int</font> pos)
00111 {
00112     QChar::Joining join = nextChar( str, pos )-&gt;joining();
00113     <font class="keywordflow">return</font> ( join == QChar::Dual || join == QChar::Center );
00114 }
00115 
00116 <font class="comment">// QT2HACK</font>
00117 <font class="preprocessor">#if 0</font>
00118 <font class="preprocessor"></font>
00119 QComplexText::Shape QComplexText::glyphVariant( <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">int</font> pos)
00120 {
00121     <font class="comment">// ignores L1 - L3, done in the codec</font>
00122     QChar::Joining joining = str[pos].joining();
00123     <font class="comment">//qDebug("checking %x, joining=%d", str[pos].unicode(), joining);</font>
00124     <font class="keywordflow">switch</font> ( joining ) {
00125         <font class="keywordflow">case</font> QChar::OtherJoining:
00126         <font class="keywordflow">case</font> QChar::Center:
00127             <font class="comment">// these don't change shape</font>
00128             <font class="keywordflow">return</font> XIsolated;
00129         <font class="keywordflow">case</font> QChar::Right:
00130             <font class="comment">// only rule R2 applies</font>
00131             <font class="keywordflow">if</font>( nextVisualCharJoins( str, pos ) )
00132                 <font class="keywordflow">return</font> XFinal;
00133             <font class="keywordflow">return</font> XIsolated;
00134         <font class="keywordflow">case</font> QChar::Dual:
00135             <font class="keywordtype">bool</font> right = nextVisualCharJoins( str, pos );
00136             <font class="keywordtype">bool</font> left = prevVisualCharJoins( str, pos );
00137             <font class="comment">//qDebug("dual: right=%d, left=%d", right, left);</font>
00138             <font class="keywordflow">if</font>( right &amp;&amp; left )
00139                 <font class="keywordflow">return</font> XMedial;
00140             <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( right )
00141                 <font class="keywordflow">return</font> XFinal;
00142             <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( left )
00143                 <font class="keywordflow">return</font> XInitial;
00144             <font class="keywordflow">else</font>
00145                 <font class="keywordflow">return</font> XIsolated;
00146     }
00147     <font class="keywordflow">return</font> XIsolated;
00148 }
00149 
00150 <font class="comment">/* and the same thing for logical ordering :)</font>
00151 <font class="comment"> */</font>
00152 <font class="keyword">static</font> <font class="keyword">inline</font> <font class="keywordtype">bool</font> prevLogicalCharJoins( <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">int</font> pos)
00153 {
00154     <font class="keywordflow">return</font> (     nextChar( str, pos )-&gt;joining() != QChar::OtherJoining );
00155 }
00156 
00157 <font class="keyword">static</font> <font class="keyword">inline</font> <font class="keywordtype">bool</font> nextLogicalCharJoins( <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">int</font> pos)
00158 {
00159     QChar::Joining join = prevChar( str, pos )-&gt;joining();
00160     <font class="keywordflow">return</font> ( join == QChar::Dual || join == QChar::Center );
00161 }
00162 
00163 
00164 QComplexText::Shape QComplexText::glyphVariantLogical( <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">int</font> pos)
00165 {
00166     <font class="comment">// ignores L1 - L3, ligatures are job of the codec</font>
00167     QChar::Joining joining = str[pos].joining();
00168     <font class="comment">//qDebug("checking %x, joining=%d", str[pos].unicode(), joining);</font>
00169     <font class="keywordflow">switch</font> ( joining ) {
00170         <font class="keywordflow">case</font> QChar::OtherJoining:
00171         <font class="keywordflow">case</font> QChar::Center:
00172             <font class="comment">// these don't change shape</font>
00173             <font class="keywordflow">return</font> XIsolated;
00174         <font class="keywordflow">case</font> QChar::Right:
00175             <font class="comment">// only rule R2 applies</font>
00176             <font class="keywordflow">if</font>( nextLogicalCharJoins( str, pos ) )
00177                 <font class="keywordflow">return</font> XFinal;
00178             <font class="keywordflow">return</font> XIsolated;
00179         <font class="keywordflow">case</font> QChar::Dual:
00180             <font class="keywordtype">bool</font> right = nextLogicalCharJoins( str, pos );
00181             <font class="keywordtype">bool</font> left = prevLogicalCharJoins( str, pos );
00182             <font class="comment">//qDebug("dual: right=%d, left=%d", right, left);</font>
00183             <font class="keywordflow">if</font>( right &amp;&amp; left )
00184                 <font class="keywordflow">return</font> XMedial;
00185             <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( right )
00186                 <font class="keywordflow">return</font> XFinal;
00187             <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( left )
00188                 <font class="keywordflow">return</font> XInitial;
00189             <font class="keywordflow">else</font>
00190                 <font class="keywordflow">return</font> XIsolated;
00191     }
00192     <font class="keywordflow">return</font> XIsolated;
00193 }
00194 
00195 <font class="comment">// -------------------------------------------------------------</font>
00196 
00197 <font class="comment">// The unicode to unicode shaping codec.</font>
00198 <font class="comment">// does only presentation forms B at the moment, but that should be enough for</font>
00199 <font class="comment">// simple display</font>
00200 <font class="keyword">static</font> <font class="keyword">const</font> ushort arabicUnicodeMapping[256][4] = {
00201     <font class="comment">// base of shaped forms, and number-1 of them ( 0 for non shaping,</font>
00202     <font class="comment">// 1 for right binding and 3 for dual binding</font>
00203     { 0x0600, 0 }, <font class="comment">// 0x600</font>
00204     { 0x0601, 0 }, <font class="comment">// 0x601</font>
00205     { 0x0602, 0 }, <font class="comment">// 0x602</font>
00206     { 0x0603, 0 }, <font class="comment">// 0x603</font>
00207     { 0x0604, 0 }, <font class="comment">// 0x604</font>
00208     { 0x0605, 0 }, <font class="comment">// 0x605</font>
00209     { 0x0606, 0 }, <font class="comment">// 0x606</font>
00210     { 0x0607, 0 }, <font class="comment">// 0x607</font>
00211     { 0x0608, 0 }, <font class="comment">// 0x608</font>
00212     { 0x0609, 0 }, <font class="comment">// 0x609</font>
00213     { 0x060a, 0 }, <font class="comment">// 0x60a</font>
00214     { 0x060b, 0 }, <font class="comment">// 0x60b</font>
00215     { 0x060c, 0 }, <font class="comment">// 0x60c     Arabic comma</font>
00216     { 0x060d, 0 }, <font class="comment">// 0x60d</font>
00217     { 0x060e, 0 }, <font class="comment">// 0x60e</font>
00218     { 0x060f, 0xfffd, 0xfffd, 0xfffd }, <font class="comment">// 0x60f</font>
00219 
00220     { 0x0610, 0 }, <font class="comment">// 0x610</font>
00221     { 0x0611, 0 }, <font class="comment">// 0x611</font>
00222     { 0x0612, 0 }, <font class="comment">// 0x612</font>
00223     { 0x0613, 0 }, <font class="comment">// 0x613</font>
00224     { 0x0614, 0 }, <font class="comment">// 0x614</font>
00225     { 0x0615, 0 }, <font class="comment">// 0x615</font>
00226     { 0x0616, 0 }, <font class="comment">// 0x616</font>
00227     { 0x0617, 0 }, <font class="comment">// 0x617</font>
00228     { 0x0618, 0 }, <font class="comment">// 0x618</font>
00229     { 0x0619, 0 }, <font class="comment">// 0x619</font>
00230     { 0x061a, 0 }, <font class="comment">// 0x61a</font>
00231     { 0x061b, 0 }, <font class="comment">// 0x61b     Arabic semicolon</font>
00232     { 0x061c, 0 }, <font class="comment">// 0x61c</font>
00233     { 0x061d, 0 }, <font class="comment">// 0x61d</font>
00234     { 0x061e, 0 }, <font class="comment">// 0x61e</font>
00235     { 0x061f, 0 }, <font class="comment">// 0x61f     Arabic question mark</font>
00236 
00237     { 0x0620, 0 }, <font class="comment">// 0x620</font>
00238     { 0xfe80, 0 }, <font class="comment">// 0x621     Hamza</font>
00239     { 0xfe81, 1 }, <font class="comment">// 0x622     R       Alef with Madda above</font>
00240     { 0xfe83, 1 }, <font class="comment">// 0x623     R       Alef with Hamza above</font>
00241     { 0xfe85, 1 }, <font class="comment">// 0x624     R       Waw with Hamza above</font>
00242     { 0xfe87, 1 }, <font class="comment">// 0x625     R       Alef with Hamza below</font>
00243     { 0xfe89, 3 }, <font class="comment">// 0x626     D       Yeh with Hamza above</font>
00244     { 0xfe8d, 1 }, <font class="comment">// 0x627     R       Alef</font>
00245     { 0xfe8f, 3 }, <font class="comment">// 0x628     D       Beh</font>
00246     { 0xfe93, 1 }, <font class="comment">// 0x629     R       Teh Marbuta</font>
00247     { 0xfe95, 3 }, <font class="comment">// 0x62a     D       Teh</font>
00248     { 0xfe99, 3 }, <font class="comment">// 0x62b     D       Theh</font>
00249     { 0xfe9d, 3 }, <font class="comment">// 0x62c     D       Jeem</font>
00250     { 0xfea1, 3 }, <font class="comment">// 0x62d     D       Hah</font>
00251     { 0xfea5, 3 }, <font class="comment">// 0x62e     D       Khah</font>
00252     { 0xfea9, 1 }, <font class="comment">// 0x62f     R       Dal</font>
00253 
00254     { 0xfeab, 1 }, <font class="comment">// 0x630     R       Thal</font>
00255     { 0xfead, 1 }, <font class="comment">// 0x631     R       Reh</font>
00256     { 0xfeaf, 1 }, <font class="comment">// 0x632     R       Zain</font>
00257     { 0xfeb1, 1 }, <font class="comment">// 0x633     D       Seen</font>
00258     { 0xfeb5, 3 }, <font class="comment">// 0x634     D       Sheen</font>
00259     { 0xfeb9, 3 }, <font class="comment">// 0x635     D       Sad</font>
00260     { 0xfebd, 3 }, <font class="comment">// 0x636     D       Dad</font>
00261     { 0xfec1, 3 }, <font class="comment">// 0x637     D       Tah</font>
00262     { 0xfec5, 3 }, <font class="comment">// 0x638     D       Zah</font>
00263     { 0xfec9, 3 }, <font class="comment">// 0x639     D       Ain</font>
00264     { 0xfecd, 3 }, <font class="comment">// 0x63a     D       Ghain</font>
00265     { 0x063b, 0 }, <font class="comment">// 0x63b</font>
00266     { 0x063c, 0 }, <font class="comment">// 0x63c</font>
00267     { 0x063d, 0 }, <font class="comment">// 0x63d</font>
00268     { 0x063e, 0 }, <font class="comment">// 0x63e</font>
00269     { 0x063f, 0 }, <font class="comment">// 0x63f</font>
00270 
00271     { 0x0640, 0 }, <font class="comment">// 0x640     C       Tatweel</font>
00272     { 0xfed1, 3 }, <font class="comment">// 0x641     D       Feh</font>
00273     { 0xfed5, 3 }, <font class="comment">// 0x642     D       Qaf</font>
00274     { 0xfed9, 3 }, <font class="comment">// 0x643     D       Kaf</font>
00275     { 0xfedd, 3 }, <font class="comment">// 0x644     D       Lam</font>
00276     { 0xfee1, 3 }, <font class="comment">// 0x645     D       Meem</font>
00277     { 0xfee5, 3 }, <font class="comment">// 0x646     D       Noon</font>
00278     { 0xfee9, 3 }, <font class="comment">// 0x647     D       Heh</font>
00279     { 0xfeed, 1 }, <font class="comment">// 0x648     R       Waw</font>
00280     { 0xfeef, 1 }, <font class="comment">// 0x649     R       Alef Maksura // ### Dual according to newest arabicshaping.txt</font>
00281     { 0xfef1, 3 }, <font class="comment">// 0x64a     D       Yeh</font>
00282     { 0x064b, 0 }, <font class="comment">// 0x64b     Mark Fathatan</font>
00283     { 0x064c, 0 }, <font class="comment">// 0x64c     Mark Dammatan</font>
00284     { 0x064d, 0 }, <font class="comment">// 0x64d     Mark Kasratan</font>
00285     { 0x064e, 0 }, <font class="comment">// 0x64e     Mark Fatha</font>
00286     { 0x064f, 0 }, <font class="comment">// 0x64f     Mark Damma</font>
00287 
00288     { 0x0650, 0 }, <font class="comment">// 0x650     Mark Kasra</font>
00289     { 0x0651, 0 }, <font class="comment">// 0x651     Mark Shadda</font>
00290     { 0x0652, 0 }, <font class="comment">// 0x652     Mark Sukan</font>
00291     <font class="comment">// these do not exist in latin6 anymore:</font>
00292     { 0x0653, 0 }, <font class="comment">// 0x653     Mark Maddah above</font>
00293     { 0x0654, 0 }, <font class="comment">// 0x654     Mark Hamza above</font>
00294     { 0x0655, 0 }, <font class="comment">// 0x655     Mark Hamza below</font>
00295     { 0x0656, 0 }, <font class="comment">// 0x656</font>
00296     { 0x0657, 0 }, <font class="comment">// 0x657</font>
00297     { 0x0658, 0 }, <font class="comment">// 0x658</font>
00298     { 0x0659, 0 }, <font class="comment">// 0x659</font>
00299     { 0x065a, 0 }, <font class="comment">// 0x65a</font>
00300     { 0x065b, 0 }, <font class="comment">// 0x65b</font>
00301     { 0x065c, 0 }, <font class="comment">// 0x65c</font>
00302     { 0x065d, 0 }, <font class="comment">// 0x65d</font>
00303     { 0x065e, 0 }, <font class="comment">// 0x65e</font>
00304     { 0x065f, 0 }, <font class="comment">// 0x65f</font>
00305 
00306     { 0x0660, 0 }, <font class="comment">// 0x660     Arabic 0</font>
00307     { 0x0661, 0 }, <font class="comment">// 0x661     Arabic 1</font>
00308     { 0x0662, 0 }, <font class="comment">// 0x662     Arabic 2</font>
00309     { 0x0663, 0 }, <font class="comment">// 0x663     Arabic 3</font>
00310     { 0x0664, 0 }, <font class="comment">// 0x664     Arabic 4</font>
00311     { 0x0665, 0 }, <font class="comment">// 0x665     Arabic 5</font>
00312     { 0x0666, 0 }, <font class="comment">// 0x666     Arabic 6</font>
00313     { 0x0667, 0 }, <font class="comment">// 0x667     Arabic 7</font>
00314     { 0x0668, 0 }, <font class="comment">// 0x668     Arabic 8</font>
00315     { 0x0669, 0 }, <font class="comment">// 0x669     Arabic 9</font>
00316     { 0x066a, 0 }, <font class="comment">// 0x66a     Arabic % sign</font>
00317     { 0x066b, 0 }, <font class="comment">// 0x66b     Arabic decimal separator</font>
00318     { 0x066c, 0 }, <font class="comment">// 0x66c     Arabic thousands separator</font>
00319     { 0x066d, 0 }, <font class="comment">// 0x66d     Arabic five pointed star</font>
00320     { 0x066e, 0 }, <font class="comment">// 0x66e</font>
00321     { 0x066f, 0 }, <font class="comment">// 0x66f</font>
00322 
00323         <font class="comment">// ### some glyphs do not have shaped mappings in the presentation forms A.</font>
00324         <font class="comment">// these have the shaping set to 0 for the moment. Will have to find out better mappings for them.</font>
00325     { 0x0670, 0 }, <font class="comment">// 0x670</font>
00326     { 0xfb50, 1 }, <font class="comment">// 0x671 R   Alef Wasla</font>
00327     { 0x0672, 0 }, <font class="comment">// 0x672 R    Alef with wavy Hamza above</font>
00328     { 0x0673, 0 }, <font class="comment">// 0x673 R   Alef with wavy Hamza below</font>
00329     { 0x0674, 0 }, <font class="comment">// 0x674 U   High Hamza</font>
00330     { 0x0675, 0 }, <font class="comment">// 0x675 R   High Hamza Alef</font>
00331     { 0x0676, 0 }, <font class="comment">// 0x676 R   High Hamza Wav</font>
00332     { 0xfbdd, 0 }, <font class="comment">// 0x677 R   U with hamza above // ### only isolated form found...</font>
00333     { 0x0678, 0 }, <font class="comment">// 0x678 D   High hamza yeh</font>
00334     { 0xfb66, 3 }, <font class="comment">// 0x679 D   ttheh</font>
00335     { 0xfb5e, 3 }, <font class="comment">// 0x67a D   theheh</font>
00336     { 0xfb52, 3 }, <font class="comment">// 0x67b D   beeh</font>
00337     { 0x067c, 0 }, <font class="comment">// 0x67cD    teh with ring</font>
00338     { 0x067d, 0 }, <font class="comment">// 0x67d D   teh with three dots above downwards</font>
00339     { 0xfb56, 3 }, <font class="comment">// 0x67e D   peh</font>
00340     { 0xfb62, 3 }, <font class="comment">// 0x67f D   teheh</font>
00341 
00342     { 0xfb5a, 3 }, <font class="comment">// 0x680 D   beheh</font>
00343     { 0x0681, 0 }, <font class="comment">// 0x681 D   hah with hamza above</font>
00344     { 0x0682, 0 }, <font class="comment">// 0x682 D   hah with two dots vertical above</font>
00345     { 0xfb76, 3 }, <font class="comment">// 0x683 D   nyeh</font>
00346     { 0xfb72, 3 }, <font class="comment">// 0x684 D   dyeh</font>
00347     { 0x0685, 0 }, <font class="comment">// 0x685 D   hah with three dots above</font>
00348     { 0xfb7a, 3 }, <font class="comment">// 0x686 D   tcheh</font>
00349     { 0xfb7e, 3 }, <font class="comment">// 0x687 D   tcheheh</font>
00350     { 0xfb88, 1 }, <font class="comment">// 0x688 R   ddal</font>
00351     { 0x0689, 0 }, <font class="comment">// 0x689 R   dal with ring</font>
00352     { 0x068a, 0 }, <font class="comment">// 0x68a R   dal with dot</font>
00353     { 0x068b, 0 }, <font class="comment">// 0x68b R   dal with dot below and small tah</font>
00354     { 0xfb84, 1 }, <font class="comment">// 0x68cR    dahal</font>
00355     { 0xfb82, 1 }, <font class="comment">// 0x68d R   ddahal</font>
00356     { 0xfb86, 1 }, <font class="comment">// 0x68e R   dul</font>
00357     { 0x068f, 0 }, <font class="comment">// 0x68f R   dal with three dots above downwards</font>
00358 
00359     { 0x0690, 0 }, <font class="comment">// 0x690 R   dal with four dots above</font>
00360     { 0xfb8c, 1 }, <font class="comment">// 0x691 R   rreh</font>
00361     { 0x0692, 0 }, <font class="comment">// 0x692 R   reh with small v</font>
00362     { 0x0693, 0 }, <font class="comment">// 0x693 R   reh with ring</font>
00363     { 0x0694, 0 }, <font class="comment">// 0x694 R   reh with dot below</font>
00364     { 0x0695, 0 }, <font class="comment">// 0x695 R   reh with small v below</font>
00365     { 0x0696, 0 }, <font class="comment">// 0x696 R   reh with dot below and dot above</font>
00366     { 0x0697, 0 }, <font class="comment">// 0x697 R   reh with two dots above</font>
00367     { 0xfb8a, 1 }, <font class="comment">// 0x698 R   jeh</font>
00368     { 0x0699, 0 }, <font class="comment">// 0x699 R   reh with four dots above</font>
00369     { 0x069a, 0 }, <font class="comment">// 0x69a D   seen with dot below and dot above</font>
00370     { 0x069b, 0 }, <font class="comment">// 0x69b D   seen with three dots below</font>
00371     { 0x069c, 0 }, <font class="comment">// 0x69cD    seen with three dots below and three dots above</font>
00372     { 0x069d, 0 }, <font class="comment">// 0x69d D   sad with two dots below</font>
00373     { 0x069e, 0 }, <font class="comment">// 0x69e D   sad with three dots above</font>
00374     { 0x069f, 0 }, <font class="comment">// 0x69f D   tah with three dots above</font>
00375 
00376     { 0x06a0, 0 }, <font class="comment">// 0x6a0 D   ain with three dots above</font>
00377     { 0x06a1, 0 }, <font class="comment">// 0x6a1 D   dotless feh</font>
00378     { 0x06a2, 0 }, <font class="comment">// 0x6a2 D   feh with dot moved below</font>
00379     { 0x06a3, 0 }, <font class="comment">// 0x6a3 D   feh with dot below</font>
00380     { 0xfb6a, 3 }, <font class="comment">// 0x6a4 D   veh</font>
00381     { 0x06a5, 0 }, <font class="comment">// 0x6a5 D   feh with three dots below</font>
00382     { 0xfb6e, 3 }, <font class="comment">// 0x6a6 D   peheh</font>
00383     { 0x06a7, 0 }, <font class="comment">// 0x6a7 D   qaf with dot above</font>
00384     { 0x06a8, 0 }, <font class="comment">// 0x6a8 D   qaf woith three dots above</font>
00385     { 0xfb8e, 3 }, <font class="comment">// 0x6a9 D   keheh</font>
00386     { 0x06aa, 0 }, <font class="comment">// 0x6aa D   swash kaf</font>
00387     { 0x06ab, 0 }, <font class="comment">// 0x6ab D   kaf with ring</font>
00388     { 0x06ac, 0 }, <font class="comment">// 0x6acD    kaf with dot above</font>
00389     { 0xfbd3, 3 }, <font class="comment">// 0x6ad D   ng</font>
00390     { 0x06ae, 0 }, <font class="comment">// 0x6ae D   kaf with three dots below</font>
00391     { 0xfb92, 3 }, <font class="comment">// 0x6af D   gaf</font>
00392 
00393     { 0x06b0, 0 }, <font class="comment">// 0x6b0 D   gaf with ring</font>
00394     { 0xfb9a, 3 }, <font class="comment">// 0x6b1 D   ngoeh</font>
00395     { 0x06b2, 0 }, <font class="comment">// 0x6b2 D   gaf with two dots below</font>
00396     { 0xfb96, 3 }, <font class="comment">// 0x6b3 D   gueh</font>
00397     { 0x06b4, 0 }, <font class="comment">// 0x6b4 D   gaf with three dots above</font>
00398     { 0x06b5, 0 }, <font class="comment">// 0x6b5 D   lam with small v</font>
00399     { 0x06b6, 0 }, <font class="comment">// 0x6b6 D   lam with dot above</font>
00400     { 0x06b7, 0 }, <font class="comment">// 0x6b7 D   lam with three dots above</font>
00401     { 0x06b8, 0 }, <font class="comment">// 0x6b8 D   lam with three dots below</font>
00402     { 0x06b9, 0 }, <font class="comment">// 0x6b9 D   noon with dot below</font>
00403     { 0xfb9e, 1 }, <font class="comment">// 0x6ba R   noon ghunna</font>
00404     { 0xfba0, 3 }, <font class="comment">// 0x6bb D   rnoon</font>
00405     { 0x06bc, 0 }, <font class="comment">// 0x6bcD    noon with ring</font>
00406     { 0x06bd, 0 }, <font class="comment">// 0x6bd D   noon with three dots above</font>
00407     { 0xfbaa, 3 }, <font class="comment">// 0x6be D   heh doachashmee</font>
00408     { 0x06bf, 0 }, <font class="comment">// 0x6bf D   tcheh with dot above</font>
00409 
00410     { 0xfba4, 1 }, <font class="comment">// 0x6c0 R   heh with yeh above = ligature hamza on hah (06d5 + 0654)</font>
00411     { 0xfba6, 3 }, <font class="comment">// 0x6c1 D   heh goal</font>
00412     { 0x06c2, 0 }, <font class="comment">// 0x6c2 R   heh goal with hamza above (06c1 + 0654)</font>
00413     { 0x06c3, 0 }, <font class="comment">// 0x6c3 R   teh marbuta goal</font>
00414     { 0x06c4, 0 }, <font class="comment">// 0x6c4 R   waw with ring</font>
00415     { 0xfbe0, 1 }, <font class="comment">// 0x6c5 R   kirghiz oe</font>
00416     { 0xfbd9, 1 }, <font class="comment">// 0x6c6 R   oe</font>
00417     { 0xfbd7, 1 }, <font class="comment">// 0x6c7 R   u</font>
00418     { 0xfbdb, 1 }, <font class="comment">// 0x6c8 R   yu</font>
00419     { 0xfbe2, 1 }, <font class="comment">// 0x6c9 R   kirghiz yu</font>
00420     { 0x06ca, 0 }, <font class="comment">// 0x6ca R   waw with teo dots above</font>
00421     { 0xfbde, 1 }, <font class="comment">// 0x6cb R   ve</font>
00422     { 0x06cc, 0 }, <font class="comment">// 0x6cc D   farsi yeh</font>
00423     { 0x06cd, 0 }, <font class="comment">// 0x6cd R   yeh with tail</font>
00424     { 0x06ce, 0 }, <font class="comment">// 0x6ce D   yeh with small v</font>
00425     { 0x06cf, 0 }, <font class="comment">// 0x6cf R   waw with dot above</font>
00426 
00427     { 0xfbe4, 3 }, <font class="comment">// 0x6d0 D   e</font>
00428     { 0x06d1, 0 }, <font class="comment">// 0x6d1 D   yeh with three dots below</font>
00429     { 0xfbae, 1 }, <font class="comment">// 0x6d2 R   yeh barree</font>
00430     { 0xfbb0, 1 }, <font class="comment">// 0x6d3 R   yeh barree with hamza above</font>
00431     { 0x06d4, 0 }, <font class="comment">// 0x6d4 U   full stop</font>
00432     { 0x06d5, 0 }, <font class="comment">// 0x6d5 D   ae</font>
00433     { 0x06d6, 0 }, <font class="comment">// 0x6d6     koreanic annotaion signs</font>
00434     { 0x06d7, 0 }, <font class="comment">// 0x6d7     ...</font>
00435     { 0x06d8, 0 }, <font class="comment">// 0x6d8</font>
00436     { 0x06d9, 0 }, <font class="comment">// 0x6d9</font>
00437     { 0x06da, 0 }, <font class="comment">// 0x6da</font>
00438     { 0x06db, 0 }, <font class="comment">// 0x6db</font>
00439     { 0x06dc, 0 }, <font class="comment">// 0x6dc</font>
00440     { 0x06dd, 0 }, <font class="comment">// 0x6dd</font>
00441     { 0x06de, 0 }, <font class="comment">// 0x6de</font>
00442     { 0x06df, 0 }, <font class="comment">// 0x6df</font>
00443 
00444     { 0x06e0, 0 }, <font class="comment">// 0x6e0</font>
00445     { 0x06e1, 0 }, <font class="comment">// 0x6e1</font>
00446     { 0x06e2, 0 }, <font class="comment">// 0x6e2</font>
00447     { 0x06e3, 0 }, <font class="comment">// 0x6e3</font>
00448     { 0x06e4, 0 }, <font class="comment">// 0x6e4</font>
00449     { 0x06e5, 0 }, <font class="comment">// 0x6e5</font>
00450     { 0x06e6, 0 }, <font class="comment">// 0x6e6</font>
00451     { 0x06e7, 0 }, <font class="comment">// 0x6e7</font>
00452     { 0x06e8, 0 }, <font class="comment">// 0x6e8</font>
00453     { 0x06e9, 0 }, <font class="comment">// 0x6e9</font>
00454     { 0x06ea, 0 }, <font class="comment">// 0x6ea</font>
00455     { 0x06eb, 0 }, <font class="comment">// 0x6eb</font>
00456     { 0x06ec, 0 }, <font class="comment">// 0x6ec</font>
00457     { 0x06ed, 0 }, <font class="comment">// 0x6ed</font>
00458     { 0x06ee, 0 }, <font class="comment">// 0x6ee</font>
00459     { 0x06ef, 0 }, <font class="comment">// 0x6ef</font>
00460 
00461     { 0x06f0, 0 }, <font class="comment">// 0x6f0     Arabic indic digit 0</font>
00462     { 0x06f1, 0 }, <font class="comment">// 0x6f1</font>
00463     { 0x06f2, 0 }, <font class="comment">// 0x6f2</font>
00464     { 0x06f3, 0 }, <font class="comment">// 0x6f3</font>
00465     { 0x06f4, 0 }, <font class="comment">// 0x6f4</font>
00466     { 0x06f5, 0 }, <font class="comment">// 0x6f5</font>
00467     { 0x06f6, 0 }, <font class="comment">// 0x6f6</font>
00468     { 0x06f7, 0 }, <font class="comment">// 0x6f7</font>
00469     { 0x06f8, 0 }, <font class="comment">// 0x6f8</font>
00470     { 0x06f9, 0 }, <font class="comment">// 0x6f9     Arabic indic digit 9</font>
00471     { 0x06fa, 0 }, <font class="comment">// 0x6fa D   Sheen with dot below</font>
00472     { 0x06fb, 0 }, <font class="comment">// 0x6fb D   dad with dot below</font>
00473     { 0x06fc, 0 }, <font class="comment">// 0x6fc D   ghain with dot below</font>
00474     { 0x06fd, 0 }, <font class="comment">// 0x6fd     Sindhi ampersand</font>
00475     { 0x06fe, 0 }, <font class="comment">// 0x6fe     sindhi postposition</font>
00476     { 0x06ff, 0 }, <font class="comment">// 0x6ff</font>
00477 
00478 };
00479 
00480 <font class="comment">// this is a bit tricky. Alef always binds to the right, so the second parameter descibing the shape</font>
00481 <font class="comment">// of the lam can be either initial of medial. So initial maps to the isolated form of the ligature,</font>
00482 <font class="comment">// medial to the final form</font>
00483 <font class="keyword">static</font> <font class="keyword">const</font> ushort arabicUnicodeLamAlefMapping[6][4] = {
00484     { 0xfffd, 0xfffd, 0xfef5, 0xfef6 }, <font class="comment">// 0x622        R       Alef with Madda above</font>
00485     { 0xfffd, 0xfffd, 0xfef7, 0xfef8 }, <font class="comment">// 0x623        R       Alef with Hamza above</font>
00486     { 0xfffd, 0xfffd, 0xfffd, 0xfffd }, <font class="comment">// 0x624        R       Waw with Hamza above</font>
00487     { 0xfffd, 0xfffd, 0xfef9, 0xfefa }, <font class="comment">// 0x625        R       Alef with Hamza below</font>
00488     { 0xfffd, 0xfffd, 0xfffd, 0xfffd }, <font class="comment">// 0x626        D       Yeh with Hamza above</font>
00489     { 0xfffd, 0xfffd, 0xfefb, 0xfefc } <font class="comment">// 0x627         R       Alef</font>
00490 };
00491 
00492 QString QComplexText::shapedString(<font class="keyword">const</font> QString&amp; uc, <font class="keywordtype">int</font> from, <font class="keywordtype">int</font> len, QPainter::TextDirection dir )
00493 {
00494     <font class="keywordflow">if</font>( len &lt; 0 )
00495         len = uc.length() - from;
00496     <font class="keywordflow">if</font>( len == 0 ) {
00497         <font class="keywordflow">return</font> QString::null;
00498     }
00499 
00500     <font class="comment">// we have to ignore NSMs at the beginning and add at the end.</font>
00501     <font class="keywordtype">int</font> num = uc.length() - from - len;
00502     <font class="keyword">const</font> QChar *ch = uc.unicode() + from + len;
00503     <font class="keywordflow">while</font> ( num &gt; 0 &amp;&amp; ch-&gt;combiningClass() != 0 ) {
00504     ch++;
00505     num--;
00506     len++;
00507     }
00508     ch = uc.unicode() + from;
00509     <font class="keywordflow">while</font> ( len &gt; 0 &amp;&amp; ch-&gt;combiningClass() != 0 ) {
00510     ch++;
00511     len--;
00512     from++;
00513     }
00514     <font class="keywordflow">if</font> ( len == 0 ) <font class="keywordflow">return</font> QString::null;
00515 
00516     <font class="keywordflow">if</font>( !shapeBuffer || len &gt; shapeBufSize ) {
00517       <font class="keywordflow">if</font>( shapeBuffer ) free( (<font class="keywordtype">void</font> *) shapeBuffer );
00518       shapeBuffer = (QChar *) malloc( len*<font class="keyword">sizeof</font>( QChar ) );
00519 <font class="comment">//        delete [] shapeBuffer;</font>
00520 <font class="comment">//        shapeBuffer = new QChar[ len + 1];</font>
00521         shapeBufSize = len;
00522     }
00523 
00524     <font class="keywordtype">int</font> lenOut = 0;
00525     QChar *data = shapeBuffer;
00526     <font class="keywordflow">if</font> ( dir == QPainter::RTL )
00527     ch += len - 1;
00528     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; len; i++ ) {
00529         uchar r = ch-&gt;row();
00530         uchar c = ch-&gt;cell();
00531         <font class="keywordflow">if</font> ( r != 0x06 ) {
00532             *data = *ch;
00533         data++;
00534             lenOut++;
00535         } <font class="keywordflow">else</font> {
00536         <font class="keywordtype">int</font> pos = i + from;
00537         <font class="keywordflow">if</font> ( dir == QPainter::RTL )
00538         pos = from + len - 1 - i;
00539             <font class="keywordtype">int</font> shape = glyphVariantLogical( uc, pos );
00540             <font class="comment">//qDebug("mapping U+%x to shape %d glyph=0x%x", ch-&gt;unicode(), shape, arabicUnicodeMapping[ch-&gt;cell()][shape]);</font>
00541             <font class="comment">// take care of lam-alef ligatures (lam right of alef)</font>
00542             ushort map;
00543             <font class="keywordflow">switch</font> ( c ) {
00544                 <font class="keywordflow">case</font> 0x44: { <font class="comment">// lam</font>
00545                     <font class="keyword">const</font> QChar *pch = nextChar( uc, pos );
00546                     <font class="keywordflow">if</font> ( pch-&gt;row() == 0x06 ) {
00547                         <font class="keywordflow">switch</font> ( pch-&gt;cell() ) {
00548                             <font class="keywordflow">case</font> 0x22:
00549                             <font class="keywordflow">case</font> 0x23:
00550                             <font class="keywordflow">case</font> 0x25:
00551                             <font class="keywordflow">case</font> 0x27:
00552                                 <font class="comment">//qDebug(" lam of lam-alef ligature");</font>
00553                                 map = arabicUnicodeLamAlefMapping[pch-&gt;cell() - 0x22][shape];
00554                                 <font class="keywordflow">goto</font> next;
00555                             <font class="keywordflow">default</font>:
00556                                 <font class="keywordflow">break</font>;
00557                         }
00558                     }
00559                     <font class="keywordflow">break</font>;
00560                 }
00561                 <font class="keywordflow">case</font> 0x22: <font class="comment">// alef with madda</font>
00562                 <font class="keywordflow">case</font> 0x23: <font class="comment">// alef with hamza above</font>
00563                 <font class="keywordflow">case</font> 0x25: <font class="comment">// alef with hamza below</font>
00564                 <font class="keywordflow">case</font> 0x27: <font class="comment">// alef</font>
00565                     <font class="keywordflow">if</font> ( prevChar( uc, pos )-&gt;unicode() == 0x0644 ) {
00566                         <font class="comment">// have a lam alef ligature</font>
00567                         <font class="comment">//qDebug(" alef of lam-alef ligature");</font>
00568                         <font class="keywordflow">goto</font> skip;
00569                     }
00570                 <font class="keywordflow">default</font>:
00571                     <font class="keywordflow">break</font>;
00572             }
00573             map = arabicUnicodeMapping[c][0] + shape;
00574         next:
00575             *data = map;
00576         data++;
00577             lenOut++;
00578         }
00579     skip:
00580     <font class="keywordflow">if</font> ( dir == QPainter::RTL )
00581         ch--;
00582     <font class="keywordflow">else</font>
00583         ch++;
00584     }
00585 
00586     <font class="keywordflow">if</font> ( dir == QPainter::RTL ) {
00587     <font class="comment">// reverses the non spacing marks to be again after the base char</font>
00588     QChar *s = shapeBuffer;
00589     <font class="keywordtype">int</font> i = 0;
00590     <font class="keywordflow">while</font> ( i &lt; lenOut ) {
00591         <font class="keywordflow">if</font> ( s-&gt;combiningClass() != 0 ) {
00592         <font class="comment">// non spacing marks</font>
00593         <font class="keywordtype">int</font> clen = 1;
00594         QChar *ch = s;
00595         <font class="keywordflow">do</font> {
00596             ch++;
00597             clen++;
00598         } <font class="keywordflow">while</font> ( ch-&gt;combiningClass() != 0 );
00599 
00600         <font class="keywordtype">int</font> j = 0;
00601         QChar *cp = s;
00602         <font class="keywordflow">while</font> ( j &lt; clen/2 ) {
00603             QChar tmp = *cp;
00604             *cp = *ch;
00605             *ch = tmp;
00606             cp++;
00607             ch--;
00608             j++;
00609         }
00610         s += clen;
00611         i += clen;
00612         } <font class="keywordflow">else</font> {
00613         s++;
00614         i++;
00615         }
00616     }
00617     }
00618 
00619     <font class="keywordflow">return</font> QConstString( shapeBuffer, lenOut ).string();
00620 }
00621 
00622 QChar QComplexText::shapedCharacter( <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">int</font> pos )
00623 {
00624     <font class="keyword">const</font> QChar *ch = str.unicode() + pos;
00625     <font class="keywordflow">if</font> ( ch-&gt;row() != 0x06 )
00626         <font class="keywordflow">return</font> *ch;
00627     <font class="keywordflow">else</font> {
00628         <font class="keywordtype">int</font> shape = glyphVariantLogical( str, pos );
00629         <font class="comment">//qDebug("mapping U+%x to shape %d glyph=0x%x", ch-&gt;unicode(), shape, arabicUnicodeMapping[ch-&gt;cell()][shape]);</font>
00630         <font class="comment">// lam aleph ligatures</font>
00631         <font class="keywordflow">switch</font> ( ch-&gt;cell() ) {
00632             <font class="keywordflow">case</font> 0x44: { <font class="comment">// lam</font>
00633                 <font class="keyword">const</font> QChar *nch = nextChar( str, pos );
00634                 <font class="keywordflow">if</font> ( nch-&gt;row() == 0x06 ) {
00635                     <font class="keywordflow">switch</font> ( nch-&gt;cell() ) {
00636                         <font class="keywordflow">case</font> 0x22:
00637                         <font class="keywordflow">case</font> 0x23:
00638                         <font class="keywordflow">case</font> 0x25:
00639                         <font class="keywordflow">case</font> 0x27:
00640                             <font class="keywordflow">return</font> QChar(arabicUnicodeLamAlefMapping[nch-&gt;cell() - 0x22][shape]);
00641                         <font class="keywordflow">default</font>:
00642                             <font class="keywordflow">break</font>;
00643                     }
00644                 }
00645                 <font class="keywordflow">break</font>;
00646             }
00647             <font class="keywordflow">case</font> 0x22: <font class="comment">// alef with madda</font>
00648             <font class="keywordflow">case</font> 0x23: <font class="comment">// alef with hamza above</font>
00649             <font class="keywordflow">case</font> 0x25: <font class="comment">// alef with hamza below</font>
00650             <font class="keywordflow">case</font> 0x27: <font class="comment">// alef</font>
00651                 <font class="keywordflow">if</font> ( prevChar( str, pos )-&gt;unicode() == 0x0644 )
00652                     <font class="comment">// have a lam alef ligature</font>
00653                     <font class="keywordflow">return</font> QChar(0);
00654             <font class="keywordflow">default</font>:
00655                 <font class="keywordflow">break</font>;
00656         }
00657         <font class="keywordflow">return</font> QChar(arabicUnicodeMapping[ch-&gt;cell()][0] + shape);
00658     }
00659 }
00660 
00661 QPointArray QComplexText::positionMarks( QFontPrivate *f, <font class="keyword">const</font> QString &amp;str, <font class="keywordtype">int</font> pos, QRect *boundingRect )
00662 {
00663     <font class="keywordtype">int</font> len = str.length();
00664     <font class="keywordtype">int</font> nmarks = 0;
00665     <font class="keywordflow">while</font> ( pos + nmarks &lt; len &amp;&amp; str[pos+nmarks +1].combiningClass() &gt; 0 )
00666         nmarks++;
00667 
00668     <font class="keywordflow">if</font> ( !nmarks )
00669         <font class="keywordflow">return</font> QPointArray();
00670 
00671     QChar baseChar = QComplexText::shapedCharacter( str, pos );
00672     QRect baseRect = f-&gt;boundingRect( baseChar );
00673     <font class="keywordtype">int</font> baseOffset = f-&gt;textWidth( str, pos, 1 );
00674 
00675     <font class="comment">//qDebug( "base char: bounding rect at %d/%d (%d/%d)", baseRect.x(), baseRect.y(), baseRect.width(), baseRect.height() );</font>
00676     <font class="keywordtype">int</font> offset = f-&gt;request.pixelSize / 10 + 1;
00677     QPointArray pa( nmarks );
00678     <font class="keywordtype">int</font> i;
00679     <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> lastCmb = 0;
00680     QRect attachmentRect;
00681     <font class="keywordflow">if</font> ( boundingRect )
00682     *boundingRect = baseRect;
00683     <font class="keywordflow">for</font>( i = 0; i &lt; nmarks; i++ ) {
00684         QChar mark = str[pos+i+1];
00685         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> cmb = mark.combiningClass();
00686         <font class="comment">// combining marks of different class don't interact. Reset the rectangle.</font>
00687         <font class="keywordflow">if</font> ( cmb != lastCmb ) {
00688             <font class="comment">//qDebug( "resetting rect" );</font>
00689             attachmentRect = baseRect;
00690         }
00691 
00692         QPoint p;
00693         QRect markRect = f-&gt;boundingRect( mark );
00694         <font class="keywordflow">switch</font>( cmb ) {
00695         <font class="keywordflow">case</font> QChar::Combining_DoubleBelow:
00696                 <font class="comment">// ### wrong in rtl context!</font>
00697         <font class="keywordflow">case</font> QChar::Combining_BelowLeft:
00698             p += QPoint( 0, offset );
00699         <font class="keywordflow">case</font> QChar::Combining_BelowLeftAttached:
00700             p += attachmentRect.bottomLeft() - markRect.topLeft();
00701             <font class="keywordflow">break</font>;
00702         <font class="keywordflow">case</font> QChar::Combining_Below:
00703             p += QPoint( 0, offset );
00704         <font class="keywordflow">case</font> QChar::Combining_BelowAttached:
00705             p += attachmentRect.bottomLeft() - markRect.topLeft();
00706             p += QPoint( (attachmentRect.width() - markRect.width())/2 , 0 );
00707             <font class="keywordflow">break</font>;
00708             <font class="keywordflow">case</font> QChar::Combining_BelowRight:
00709             p += QPoint( 0, offset );
00710         <font class="keywordflow">case</font> QChar::Combining_BelowRightAttached:
00711             p += attachmentRect.bottomRight() - markRect.topRight();
00712             <font class="keywordflow">break</font>;
00713             <font class="keywordflow">case</font> QChar::Combining_Left:
00714             p += QPoint( -offset, 0 );
00715         <font class="keywordflow">case</font> QChar::Combining_LeftAttached:
00716             <font class="keywordflow">break</font>;
00717             <font class="keywordflow">case</font> QChar::Combining_Right:
00718             p += QPoint( offset, 0 );
00719         <font class="keywordflow">case</font> QChar::Combining_RightAttached:
00720             <font class="keywordflow">break</font>;
00721         <font class="keywordflow">case</font> QChar::Combining_DoubleAbove:
00722             <font class="comment">// ### wrong in RTL context!</font>
00723         <font class="keywordflow">case</font> QChar::Combining_AboveLeft:
00724             p += QPoint( 0, -offset );
00725         <font class="keywordflow">case</font> QChar::Combining_AboveLeftAttached:
00726             p += attachmentRect.topLeft() - markRect.bottomLeft();
00727             <font class="keywordflow">break</font>;
00728             <font class="keywordflow">case</font> QChar::Combining_Above:
00729             p += QPoint( 0, -offset );
00730         <font class="keywordflow">case</font> QChar::Combining_AboveAttached:
00731             p += attachmentRect.topLeft() - markRect.bottomLeft();
00732             p += QPoint( (attachmentRect.width() - markRect.width())/2 , 0 );
00733             <font class="keywordflow">break</font>;
00734             <font class="keywordflow">case</font> QChar::Combining_AboveRight:
00735             p += QPoint( 0, -offset );
00736         <font class="keywordflow">case</font> QChar::Combining_AboveRightAttached:
00737             p += attachmentRect.topRight() - markRect.bottomRight();
00738             <font class="keywordflow">break</font>;
00739 
00740         <font class="keywordflow">case</font> QChar::Combining_IotaSubscript:
00741             <font class="keywordflow">default</font>:
00742                 <font class="keywordflow">break</font>;
00743         }
00744         <font class="comment">//qDebug( "char=%x combiningClass = %d offset=%d/%d", mark.unicode(), cmb, p.x(), p.y() );</font>
00745         markRect.moveBy( p.x(), p.y() );
00746         p += QPoint( -baseOffset, 0 );
00747         attachmentRect |= markRect;
00748     <font class="keywordflow">if</font> ( boundingRect )
00749         *boundingRect |= markRect;
00750         lastCmb = cmb;
00751         pa.setPoint( i, p );
00752     }
00753     <font class="keywordflow">return</font> pa;
00754 }
00755 
00756 <font class="comment">//#define BIDI_DEBUG 2</font>
00757 <font class="preprocessor">#ifdef BIDI_DEBUG</font>
00758 <font class="preprocessor"></font><font class="preprocessor">#include &lt;iostream&gt;</font>
00759 <font class="preprocessor">#endif</font>
00760 <font class="preprocessor"></font>
00761 
00762 <font class="comment">// transforms one line of the paragraph to visual order</font>
00763 <font class="comment">// the caller is responisble to delete the returned list of QTextRuns.</font>
00764 QList&lt;QTextRun&gt; *QComplexText::bidiReorderLine( QBidiControl *control, <font class="keyword">const</font> QString &amp;text, <font class="keywordtype">int</font> start, <font class="keywordtype">int</font> len )
00765 {
00766     <font class="keywordtype">int</font> last = start + len - 1;
00767     <font class="comment">//printf("doing BiDi reordering from %d to %d!\n", start, last);</font>
00768 
00769     QList&lt;QTextRun&gt; *runs = <font class="keyword">new</font> QList&lt;QTextRun&gt;;
00770     runs-&gt;setAutoDelete(TRUE);
00771 
00772     QBidiContext *context = control-&gt;context;
00773     <font class="keywordflow">if</font> ( !context ) {
00774     <font class="comment">// first line</font>
00775     <font class="keywordflow">if</font>( start != 0 )
00776         qDebug( <font class="stringliteral">"bidiReorderLine::internal error"</font>);
00777     <font class="keywordflow">if</font>( text.isRightToLeft() )
00778         context = <font class="keyword">new</font> QBidiContext( 1, QChar::DirR );
00779     <font class="keywordflow">else</font>
00780         context = <font class="keyword">new</font> QBidiContext( 0, QChar::DirL );
00781     }
00782 
00783     QBidiStatus status = control-&gt;status;
00784     QChar::Direction dir = QChar::DirON;
00785 
00786     <font class="keywordtype">int</font> sor = start;
00787     <font class="keywordtype">int</font> eor = start;
00788 
00789     <font class="keywordtype">int</font> current = start;
00790     <font class="keywordflow">while</font>(current &lt; last) {
00791     QChar::Direction dirCurrent;
00792     <font class="keywordflow">if</font>(current == (int)text.length()) {
00793         QBidiContext *c = context;
00794         <font class="keywordflow">while</font> ( c-&gt;parent )
00795         c = c-&gt;parent;
00796         dirCurrent = c-&gt;dir;
00797     } <font class="keywordflow">else</font>
00798         dirCurrent = text.at(current).direction();
00799 
00800 
00801 <font class="preprocessor">#if BIDI_DEBUG &gt; 1</font>
00802 <font class="preprocessor"></font>    cout &lt;&lt; <font class="stringliteral">"directions: dir="</font> &lt;&lt; dir &lt;&lt; <font class="stringliteral">" current="</font> &lt;&lt; dirCurrent &lt;&lt; <font class="stringliteral">" last="</font> &lt;&lt; status.last &lt;&lt; <font class="stringliteral">" eor="</font> &lt;&lt; status.eor &lt;&lt; <font class="stringliteral">" lastStrong="</font> &lt;&lt; status.lastStrong &lt;&lt; <font class="stringliteral">" embedding="</font> &lt;&lt; context-&gt;dir &lt;&lt; <font class="stringliteral">" level ="</font> &lt;&lt; (int)context-&gt;level &lt;&lt; endl;
00803 <font class="preprocessor">#endif</font>
00804 <font class="preprocessor"></font>
00805     <font class="keywordflow">switch</font>(dirCurrent) {
00806 
00807         <font class="comment">// embedding and overrides (X1-X9 in the BiDi specs)</font>
00808     <font class="keywordflow">case</font> QChar::DirRLE:
00809         {
00810         uchar level = context-&gt;level;
00811         <font class="keywordflow">if</font>(level%2) <font class="comment">// we have an odd level</font>
00812             level += 2;
00813         <font class="keywordflow">else</font>
00814             level++;
00815         <font class="keywordflow">if</font>(level &lt; 61) {
00816             runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00817             ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00818             context = <font class="keyword">new</font> QBidiContext(level, QChar::DirR, context);
00819             status.last = QChar::DirR;
00820             status.lastStrong = QChar::DirR;
00821         }
00822         <font class="keywordflow">break</font>;
00823         }
00824     <font class="keywordflow">case</font> QChar::DirLRE:
00825         {
00826         uchar level = context-&gt;level;
00827         <font class="keywordflow">if</font>(level%2) <font class="comment">// we have an odd level</font>
00828             level++;
00829         <font class="keywordflow">else</font>
00830             level += 2;
00831         <font class="keywordflow">if</font>(level &lt; 61) {
00832             runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00833             ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00834             context = <font class="keyword">new</font> QBidiContext(level, QChar::DirL, context);
00835             status.last = QChar::DirL;
00836             status.lastStrong = QChar::DirL;
00837         }
00838         <font class="keywordflow">break</font>;
00839         }
00840     <font class="keywordflow">case</font> QChar::DirRLO:
00841         {
00842         uchar level = context-&gt;level;
00843         <font class="keywordflow">if</font>(level%2) <font class="comment">// we have an odd level</font>
00844             level += 2;
00845         <font class="keywordflow">else</font>
00846             level++;
00847         <font class="keywordflow">if</font>(level &lt; 61) {
00848             runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00849             ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00850             context = <font class="keyword">new</font> QBidiContext(level, QChar::DirR, context, TRUE);
00851             dir = QChar::DirR;
00852             status.last = QChar::DirR;
00853             status.lastStrong = QChar::DirR;
00854         }
00855         <font class="keywordflow">break</font>;
00856         }
00857     <font class="keywordflow">case</font> QChar::DirLRO:
00858         {
00859         uchar level = context-&gt;level;
00860         <font class="keywordflow">if</font>(level%2) <font class="comment">// we have an odd level</font>
00861             level++;
00862         <font class="keywordflow">else</font>
00863             level += 2;
00864         <font class="keywordflow">if</font>(level &lt; 61) {
00865             runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00866             ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00867             context = <font class="keyword">new</font> QBidiContext(level, QChar::DirL, context, TRUE);
00868             dir = QChar::DirL;
00869             status.last = QChar::DirL;
00870             status.lastStrong = QChar::DirL;
00871         }
00872         <font class="keywordflow">break</font>;
00873         }
00874     <font class="keywordflow">case</font> QChar::DirPDF:
00875         {
00876         QBidiContext *c = context-&gt;parent;
00877         <font class="keywordflow">if</font>(c) {
00878             runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00879             ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00880             status.last = context-&gt;dir;
00881             <font class="keywordflow">if</font>( context-&gt;deref() ) <font class="keyword">delete</font> context;
00882             context = c;
00883             <font class="keywordflow">if</font>(context-&gt;override)
00884             dir = context-&gt;dir;
00885             <font class="keywordflow">else</font>
00886             dir = QChar::DirON;
00887             status.lastStrong = context-&gt;dir;
00888         }
00889         <font class="keywordflow">break</font>;
00890         }
00891 
00892         <font class="comment">// strong types</font>
00893     <font class="keywordflow">case</font> QChar::DirL:
00894         <font class="keywordflow">if</font>(dir == QChar::DirON)
00895         dir = QChar::DirL;
00896         <font class="keywordflow">switch</font>(status.last)
00897         {
00898         <font class="keywordflow">case</font> QChar::DirL:
00899             eor = current; status.eor = QChar::DirL; <font class="keywordflow">break</font>;
00900         <font class="keywordflow">case</font> QChar::DirR:
00901         <font class="keywordflow">case</font> QChar::DirAL:
00902         <font class="keywordflow">case</font> QChar::DirEN:
00903         <font class="keywordflow">case</font> QChar::DirAN:
00904             runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00905             ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00906             <font class="keywordflow">break</font>;
00907         <font class="keywordflow">case</font> QChar::DirES:
00908         <font class="keywordflow">case</font> QChar::DirET:
00909         <font class="keywordflow">case</font> QChar::DirCS:
00910         <font class="keywordflow">case</font> QChar::DirBN:
00911         <font class="keywordflow">case</font> QChar::DirB:
00912         <font class="keywordflow">case</font> QChar::DirS:
00913         <font class="keywordflow">case</font> QChar::DirWS:
00914         <font class="keywordflow">case</font> QChar::DirON:
00915             <font class="keywordflow">if</font>(dir != QChar::DirL) {
00916             <font class="comment">//last stuff takes embedding dir</font>
00917             <font class="keywordflow">if</font>( context-&gt;dir == QChar::DirR ) {
00918                 <font class="keywordflow">if</font>(status.eor != QChar::DirR) {
00919                 <font class="comment">// AN or EN</font>
00920                 runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00921                 ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00922                 dir = QChar::DirR;
00923                 }
00924                 <font class="keywordflow">else</font>
00925                 eor = current - 1;
00926                 runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00927                 ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00928             } <font class="keywordflow">else</font> {
00929                 <font class="keywordflow">if</font>(status.eor == QChar::DirR) {
00930                 runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00931                 ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00932                 dir = QChar::DirL;
00933                 } <font class="keywordflow">else</font> {
00934                 eor = current; status.eor = QChar::DirL; <font class="keywordflow">break</font>;
00935                 }
00936             }
00937             } <font class="keywordflow">else</font> {
00938             eor = current; status.eor = QChar::DirL;
00939             }
00940         <font class="keywordflow">default</font>:
00941             <font class="keywordflow">break</font>;
00942         }
00943         status.lastStrong = QChar::DirL;
00944         <font class="keywordflow">break</font>;
00945     <font class="keywordflow">case</font> QChar::DirAL:
00946     <font class="keywordflow">case</font> QChar::DirR:
00947         <font class="keywordflow">if</font>(dir == QChar::DirON) dir = QChar::DirR;
00948         <font class="keywordflow">switch</font>(status.last)
00949         {
00950         <font class="keywordflow">case</font> QChar::DirR:
00951         <font class="keywordflow">case</font> QChar::DirAL:
00952             eor = current; status.eor = QChar::DirR; <font class="keywordflow">break</font>;
00953         <font class="keywordflow">case</font> QChar::DirL:
00954         <font class="keywordflow">case</font> QChar::DirEN:
00955         <font class="keywordflow">case</font> QChar::DirAN:
00956             runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00957             ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00958             <font class="keywordflow">break</font>;
00959         <font class="keywordflow">case</font> QChar::DirES:
00960         <font class="keywordflow">case</font> QChar::DirET:
00961         <font class="keywordflow">case</font> QChar::DirCS:
00962         <font class="keywordflow">case</font> QChar::DirBN:
00963         <font class="keywordflow">case</font> QChar::DirB:
00964         <font class="keywordflow">case</font> QChar::DirS:
00965         <font class="keywordflow">case</font> QChar::DirWS:
00966         <font class="keywordflow">case</font> QChar::DirON:
00967             <font class="keywordflow">if</font>( status.eor != QChar::DirR &amp;&amp; status.eor != QChar::DirAL ) {
00968             <font class="comment">//last stuff takes embedding dir</font>
00969             <font class="keywordflow">if</font>(context-&gt;dir == QChar::DirR || status.lastStrong == QChar::DirR) {
00970                 runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00971                 ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00972                 dir = QChar::DirR;
00973                 eor = current;
00974             } <font class="keywordflow">else</font> {
00975                 eor = current - 1;
00976                 runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
00977                 ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
00978                 dir = QChar::DirR;
00979             }
00980             } <font class="keywordflow">else</font> {
00981             eor = current; status.eor = QChar::DirR;
00982             }
00983         <font class="keywordflow">default</font>:
00984             <font class="keywordflow">break</font>;
00985         }
00986         status.lastStrong = dirCurrent;
00987         <font class="keywordflow">break</font>;
00988 
00989         <font class="comment">// weak types:</font>
00990 
00991     <font class="keywordflow">case</font> QChar::DirNSM:
00992         <font class="comment">// ### if @sor, set dir to dirSor</font>
00993         <font class="keywordflow">break</font>;
00994     <font class="keywordflow">case</font> QChar::DirEN:
00995         <font class="keywordflow">if</font>(status.lastStrong != QChar::DirAL) {
00996         <font class="comment">// if last strong was AL change EN to AL</font>
00997         <font class="keywordflow">if</font>(dir == QChar::DirON) {
00998             <font class="keywordflow">if</font>(status.lastStrong == QChar::DirL)
00999             dir = QChar::DirL;
01000             <font class="keywordflow">else</font>
01001             dir = QChar::DirAN;
01002         }
01003         <font class="keywordflow">switch</font>(status.last)
01004             {
01005             <font class="keywordflow">case</font> QChar::DirET:
01006             <font class="keywordflow">if</font> ( status.lastStrong == QChar::DirR || status.lastStrong == QChar::DirAL ) {
01007                 runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
01008                 ++eor; sor = eor; status.eor = QChar::DirON;
01009                 dir = QChar::DirAN;
01010             }
01011             <font class="comment">// fall through</font>
01012             <font class="keywordflow">case</font> QChar::DirEN:
01013             <font class="keywordflow">case</font> QChar::DirL:
01014             eor = current;
01015             status.eor = dirCurrent;
01016             <font class="keywordflow">break</font>;
01017             <font class="keywordflow">case</font> QChar::DirR:
01018             <font class="keywordflow">case</font> QChar::DirAL:
01019             <font class="keywordflow">case</font> QChar::DirAN:
01020             runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
01021             ++eor; sor = eor; status.eor = QChar::DirEN;
01022             dir = QChar::DirAN; <font class="keywordflow">break</font>;
01023             <font class="keywordflow">case</font> QChar::DirES:
01024             <font class="keywordflow">case</font> QChar::DirCS:
01025             <font class="keywordflow">if</font>(status.eor == QChar::DirEN) {
01026                 eor = current; <font class="keywordflow">break</font>;
01027             }
01028             <font class="keywordflow">case</font> QChar::DirBN:
01029             <font class="keywordflow">case</font> QChar::DirB:
01030             <font class="keywordflow">case</font> QChar::DirS:
01031             <font class="keywordflow">case</font> QChar::DirWS:
01032             <font class="keywordflow">case</font> QChar::DirON:
01033             <font class="keywordflow">if</font>(status.eor == QChar::DirR) {
01034                 <font class="comment">// neutrals go to R</font>
01035                 eor = current - 1;
01036                 runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
01037                 ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirEN;
01038                 dir = QChar::DirAN;
01039             }
01040             <font class="keywordflow">else</font> <font class="keywordflow">if</font>( status.eor == QChar::DirL ||
01041                  (status.eor == QChar::DirEN &amp;&amp; status.lastStrong == QChar::DirL)) {
01042                 eor = current; status.eor = dirCurrent;
01043             } <font class="keywordflow">else</font> {
01044                 <font class="comment">// numbers on both sides, neutrals get right to left direction</font>
01045                 <font class="keywordflow">if</font>(dir != QChar::DirL) {
01046                 runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
01047                 ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
01048                 eor = current - 1;
01049                 dir = QChar::DirR;
01050                 runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
01051                 ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
01052                 dir = QChar::DirAN;
01053                 } <font class="keywordflow">else</font> {
01054                 eor = current; status.eor = dirCurrent;
01055                 }
01056             }
01057             <font class="keywordflow">default</font>:
01058             <font class="keywordflow">break</font>;
01059             }
01060         <font class="keywordflow">break</font>;
01061         }
01062     <font class="keywordflow">case</font> QChar::DirAN:
01063         dirCurrent = QChar::DirAN;
01064         <font class="keywordflow">if</font>(dir == QChar::DirON) dir = QChar::DirAN;
01065         <font class="keywordflow">switch</font>(status.last)
01066         {
01067         <font class="keywordflow">case</font> QChar::DirL:
01068         <font class="keywordflow">case</font> QChar::DirAN:
01069             eor = current; status.eor = QChar::DirAN; <font class="keywordflow">break</font>;
01070         <font class="keywordflow">case</font> QChar::DirR:
01071         <font class="keywordflow">case</font> QChar::DirAL:
01072         <font class="keywordflow">case</font> QChar::DirEN:
01073             runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
01074             ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
01075             <font class="keywordflow">break</font>;
01076         <font class="keywordflow">case</font> QChar::DirCS:
01077             <font class="keywordflow">if</font>(status.eor == QChar::DirAN) {
01078             eor = current; status.eor = QChar::DirR; <font class="keywordflow">break</font>;
01079             }
01080         <font class="keywordflow">case</font> QChar::DirES:
01081         <font class="keywordflow">case</font> QChar::DirET:
01082         <font class="keywordflow">case</font> QChar::DirBN:
01083         <font class="keywordflow">case</font> QChar::DirB:
01084         <font class="keywordflow">case</font> QChar::DirS:
01085         <font class="keywordflow">case</font> QChar::DirWS:
01086         <font class="keywordflow">case</font> QChar::DirON:
01087             <font class="keywordflow">if</font>(status.eor == QChar::DirR) {
01088             <font class="comment">// neutrals go to R</font>
01089             eor = current - 1;
01090             runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
01091             ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
01092             dir = QChar::DirAN;
01093             } <font class="keywordflow">else</font> <font class="keywordflow">if</font>( status.eor == QChar::DirL ||
01094                    (status.eor == QChar::DirEN &amp;&amp; status.lastStrong == QChar::DirL)) {
01095             eor = current; status.eor = dirCurrent;
01096             } <font class="keywordflow">else</font> {
01097             <font class="comment">// numbers on both sides, neutrals get right to left direction</font>
01098             <font class="keywordflow">if</font>(dir != QChar::DirL) {
01099                 runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
01100                 ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
01101                 eor = current - 1;
01102                 dir = QChar::DirR;
01103                 runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
01104                 ++eor; sor = eor; dir = QChar::DirON; status.eor = QChar::DirON;
01105                 dir = QChar::DirAN;
01106             } <font class="keywordflow">else</font> {
01107                 eor = current; status.eor = dirCurrent;
01108             }
01109             }
01110         <font class="keywordflow">default</font>:
01111             <font class="keywordflow">break</font>;
01112         }
01113         <font class="keywordflow">break</font>;
01114     <font class="keywordflow">case</font> QChar::DirES:
01115     <font class="keywordflow">case</font> QChar::DirCS:
01116         <font class="keywordflow">break</font>;
01117     <font class="keywordflow">case</font> QChar::DirET:
01118         <font class="keywordflow">if</font>(status.last == QChar::DirEN) {
01119         dirCurrent = QChar::DirEN;
01120         eor = current; status.eor = dirCurrent;
01121         <font class="keywordflow">break</font>;
01122         }
01123         <font class="keywordflow">break</font>;
01124 
01125         <font class="comment">// boundary neutrals should be ignored</font>
01126     <font class="keywordflow">case</font> QChar::DirBN:
01127         <font class="keywordflow">break</font>;
01128         <font class="comment">// neutrals</font>
01129     <font class="keywordflow">case</font> QChar::DirB:
01130         <font class="comment">// ### what do we do with newline and paragraph separators that come to here?</font>
01131         <font class="keywordflow">break</font>;
01132     <font class="keywordflow">case</font> QChar::DirS:
01133         <font class="comment">// ### implement rule L1</font>
01134         <font class="keywordflow">break</font>;
01135     <font class="keywordflow">case</font> QChar::DirWS:
01136     <font class="keywordflow">case</font> QChar::DirON:
01137         <font class="keywordflow">break</font>;
01138     <font class="keywordflow">default</font>:
01139         <font class="keywordflow">break</font>;
01140     }
01141 
01142     <font class="comment">//cout &lt;&lt; "     after: dir=" &lt;&lt; //        dir &lt;&lt; " current=" &lt;&lt; dirCurrent &lt;&lt; " last=" &lt;&lt; status.last &lt;&lt; " eor=" &lt;&lt; status.eor &lt;&lt; " lastStrong=" &lt;&lt; status.lastStrong &lt;&lt; " embedding=" &lt;&lt; context-&gt;dir &lt;&lt; endl;</font>
01143 
01144     <font class="keywordflow">if</font>(current &gt;= (int)text.length()) <font class="keywordflow">break</font>;
01145 
01146     <font class="comment">// set status.last as needed.</font>
01147     <font class="keywordflow">switch</font>(dirCurrent)
01148         {
01149         <font class="keywordflow">case</font> QChar::DirET:
01150         <font class="keywordflow">case</font> QChar::DirES:
01151         <font class="keywordflow">case</font> QChar::DirCS:
01152         <font class="keywordflow">case</font> QChar::DirS:
01153         <font class="keywordflow">case</font> QChar::DirWS:
01154         <font class="keywordflow">case</font> QChar::DirON:
01155         <font class="keywordflow">switch</font>(status.last)
01156             {
01157             <font class="keywordflow">case</font> QChar::DirL:
01158             <font class="keywordflow">case</font> QChar::DirR:
01159             <font class="keywordflow">case</font> QChar::DirAL:
01160             <font class="keywordflow">case</font> QChar::DirEN:
01161             <font class="keywordflow">case</font> QChar::DirAN:
01162             status.last = dirCurrent;
01163             <font class="keywordflow">break</font>;
01164             <font class="keywordflow">default</font>:
01165             status.last = QChar::DirON;
01166             }
01167         <font class="keywordflow">break</font>;
01168         <font class="keywordflow">case</font> QChar::DirNSM:
01169         <font class="keywordflow">case</font> QChar::DirBN:
01170         <font class="comment">// ignore these</font>
01171         <font class="keywordflow">break</font>;
01172         <font class="keywordflow">default</font>:
01173         status.last = dirCurrent;
01174         }
01175 
01176     ++current;
01177     }
01178 
01179 <font class="preprocessor">#ifdef BIDI_DEBUG</font>
01180 <font class="preprocessor"></font>    cout &lt;&lt; <font class="stringliteral">"reached end of line current="</font> &lt;&lt; current &lt;&lt; <font class="stringliteral">", eor="</font> &lt;&lt; eor &lt;&lt; endl;
01181 <font class="preprocessor">#endif</font>
01182 <font class="preprocessor"></font>    eor = current;
01183 
01184     runs-&gt;append( <font class="keyword">new</font> QTextRun(sor, eor, context, dir) );
01185 
01186     <font class="comment">// reorder line according to run structure...</font>
01187 
01188     <font class="comment">// first find highest and lowest levels</font>
01189     uchar levelLow = 128;
01190     uchar levelHigh = 0;
01191     QTextRun *r = runs-&gt;first();
01192     <font class="keywordflow">while</font> ( r ) {
01193     <font class="comment">//printf("level = %d\n", r-&gt;level);</font>
01194     <font class="keywordflow">if</font> ( r-&gt;level &gt; levelHigh )
01195         levelHigh = r-&gt;level;
01196     <font class="keywordflow">if</font> ( r-&gt;level &lt; levelLow )
01197         levelLow = r-&gt;level;
01198     r = runs-&gt;next();
01199     }
01200 
01201     <font class="comment">// implements reordering of the line (L2 according to BiDi spec):</font>
01202     <font class="comment">// L2. From the highest level found in the text to the lowest odd level on each line,</font>
01203     <font class="comment">// reverse any contiguous sequence of characters that are at that level or higher.</font>
01204 
01205     <font class="comment">// reversing is only done up to the lowest odd level</font>
01206     <font class="keywordflow">if</font>(!(levelLow%2)) levelLow++;
01207 
01208 <font class="preprocessor">#ifdef BIDI_DEBUG</font>
01209 <font class="preprocessor"></font>    cout &lt;&lt; <font class="stringliteral">"reorderLine: lineLow = "</font> &lt;&lt; (uint)levelLow &lt;&lt; <font class="stringliteral">", lineHigh = "</font> &lt;&lt; (uint)levelHigh &lt;&lt; endl;
01210     cout &lt;&lt; <font class="stringliteral">"logical order is:"</font> &lt;&lt; endl;
01211     QListIterator&lt;QTextRun&gt; it2(*runs);
01212     QTextRun *r2;
01213     <font class="keywordflow">for</font> ( ; (r2 = it2.current()); ++it2 )
01214     cout &lt;&lt; <font class="stringliteral">"    "</font> &lt;&lt; r2 &lt;&lt; <font class="stringliteral">"  start="</font> &lt;&lt; r2-&gt;start &lt;&lt; <font class="stringliteral">"  stop="</font> &lt;&lt; r2-&gt;stop &lt;&lt; <font class="stringliteral">"  level="</font> &lt;&lt; (uint)r2-&gt;level &lt;&lt; endl;
01215 <font class="preprocessor">#endif</font>
01216 <font class="preprocessor"></font>
01217     <font class="keywordtype">int</font> count = runs-&gt;count() - 1;
01218 
01219     <font class="keywordflow">while</font>(levelHigh &gt;= levelLow)
01220     {
01221     <font class="keywordtype">int</font> i = 0;
01222     <font class="keywordflow">while</font> ( i &lt; count )
01223     {
01224         <font class="keywordflow">while</font>(i &lt; count &amp;&amp; runs-&gt;at(i)-&gt;level &lt; levelHigh) i++;
01225         <font class="keywordtype">int</font> start = i;
01226         <font class="keywordflow">while</font>(i &lt;= count &amp;&amp; runs-&gt;at(i)-&gt;level &gt;= levelHigh) i++;
01227         <font class="keywordtype">int</font> end = i-1;
01228 
01229         <font class="keywordflow">if</font>(start != end)
01230         {
01231         <font class="comment">//cout &lt;&lt; "reversing from " &lt;&lt; start &lt;&lt; " to " &lt;&lt; end &lt;&lt; endl;</font>
01232         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> j = 0; j &lt; (end-start+1)/2; j++)
01233         {
01234             QTextRun *first = runs-&gt;take(start+j);
01235             QTextRun *last = runs-&gt;take(end-j-1);
01236             runs-&gt;insert(start+j, last);
01237             runs-&gt;insert(end-j, first);
01238         }
01239         }
01240         i++;
01241         <font class="keywordflow">if</font>(i &gt;= count) <font class="keywordflow">break</font>;
01242     }
01243     levelHigh--;
01244     }
01245 
01246 <font class="preprocessor">#ifdef BIDI_DEBUG</font>
01247 <font class="preprocessor"></font>    cout &lt;&lt; <font class="stringliteral">"visual order is:"</font> &lt;&lt; endl;
01248     QListIterator&lt;QTextRun&gt; it3(*runs);
01249     QTextRun *r3;
01250     <font class="keywordflow">for</font> ( ; (r3 = it3.current()); ++it3 )
01251     {
01252     cout &lt;&lt; <font class="stringliteral">"    "</font> &lt;&lt; r3 &lt;&lt; endl;
01253     }
01254 <font class="preprocessor">#endif</font>
01255 <font class="preprocessor"></font>
01256     control-&gt;setContext( context );
01257     control-&gt;status = status;
01258 
01259     <font class="keywordflow">return</font> runs;
01260 }
01261 
01262 
01263 QString QComplexText::bidiReorderString( <font class="keyword">const</font> QString &amp;str, QChar::Direction <font class="comment">/*basicDir*/</font> )
01264 {
01265     <font class="comment">// ### fix basic direction</font>
01266     QBidiControl *control = <font class="keyword">new</font> QBidiControl();
01267     <font class="keywordtype">int</font> lineStart = 0;
01268     <font class="keywordtype">int</font> lineEnd = 0;
01269     <font class="keywordtype">int</font> len = str.length();
01270     QString visual;
01271     visual.setUnicode( 0, len );
01272     QChar *vch = (QChar *)visual.unicode();
01273     <font class="keyword">const</font> QChar *ch = str.unicode();
01274     <font class="keywordflow">while</font>( lineStart &lt; len ) {
01275     lineEnd = lineStart;
01276     <font class="keywordflow">while</font>( *ch != <font class="charliteral">'\n'</font> &amp;&amp; lineEnd &lt; len ) {
01277         ch++;
01278         lineEnd++;
01279     }
01280     QList&lt;QTextRun&gt; *runs = bidiReorderLine( control, str, lineStart, lineEnd - lineStart );
01281 
01282     <font class="comment">// reorder the content of the line, and output to visual</font>
01283     QTextRun *r = runs-&gt;first();
01284     <font class="keywordflow">while</font> ( r ) {
01285         <font class="keywordflow">if</font>(r-&gt;level %2) {
01286         <font class="comment">// odd level, need to reverse the string</font>
01287         <font class="keywordtype">int</font> pos = r-&gt;stop;
01288         <font class="keywordflow">while</font>(pos &gt;= r-&gt;start) {
01289             *vch = str[pos];
01290             vch++;
01291             pos--;
01292         }
01293         } <font class="keywordflow">else</font> {
01294         <font class="keywordtype">int</font> pos = r-&gt;start;
01295         <font class="keywordflow">while</font>(pos &lt;= r-&gt;stop) {
01296             *vch = str[pos];
01297             vch++;
01298             pos++;
01299         }
01300         }
01301         r = runs-&gt;next();
01302     }
01303     <font class="keywordflow">if</font> ( *ch == <font class="charliteral">'\n'</font> ) {
01304         *vch = *ch;
01305         vch++;
01306         ch++;
01307         lineEnd++;
01308     }
01309     lineStart = lineEnd;
01310     }
01311     <font class="keywordflow">return</font> visual;
01312 }
01313 <font class="preprocessor">#endif</font>
</pre></div><hr><address><small>Generated on Sun Mar 10 22:12:47 2002 for BibleTime by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
